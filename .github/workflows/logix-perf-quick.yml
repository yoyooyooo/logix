name: logix-perf (quick)

on:
  pull_request:
  schedule:
    - cron: "0 18 * * *" # daily, UTC
  workflow_dispatch:
    inputs:
      base_ref:
        description: "before 基线（branch/tag/sha；留空=默认分支 tip）"
        required: false
        default: ""
      head_ref:
        description: "after 基线（branch/tag/sha；留空=触发 SHA）"
        required: false
        default: ""
      perf_files:
        description: "采集范围（logix-react browser perf 测试文件/目录；支持逗号分隔多个，相对 packages/logix-react）"
        required: false
        default: "test/browser/perf-boundaries/diagnostics-overhead.test.tsx"
      perf_profile:
        description: "采样 profile（影响 runs/warmup/stability 等配置）"
        required: false
        default: "smoke"
      diff_mode:
        description: "diff 模式（strict=不可比直接失败；triage=允许漂移，仅作线索）"
        required: false
        default: "strict"

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: logix-perf-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  perf-quick:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      PERF_FILES: test/browser/perf-boundaries/diagnostics-overhead.test.tsx
      PERF_PROFILE: smoke
      PERF_DIFF_MODE: strict
      PERF_OUT_DIR: perf/ci
      PERF_ARTIFACT_NAME: logix-perf-quick-${{ github.event.pull_request.number || github.run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute SHAs
        env:
          INPUT_BASE_REF: ${{ github.event.inputs.base_ref }}
          INPUT_HEAD_REF: ${{ github.event.inputs.head_ref }}
          INPUT_PERF_FILES: ${{ github.event.inputs.perf_files }}
          INPUT_PERF_PROFILE: ${{ github.event.inputs.perf_profile }}
          INPUT_DIFF_MODE: ${{ github.event.inputs.diff_mode }}
        run: |
          set -euo pipefail

          echo "PERF_ENV_ID=gh-${RUNNER_OS}-${RUNNER_ARCH}" >> "$GITHUB_ENV"

          normalize_ref() {
            local ref="$1"
            ref="${ref#refs/heads/}"
            ref="${ref#refs/remotes/origin/}"
            ref="${ref#origin/}"
            echo "$ref"
          }

          resolve_ref_to_sha() {
            local ref="$1"
            if git rev-parse --verify "${ref}^{commit}" >/dev/null 2>&1; then
              git rev-parse "${ref}^{commit}"
              return 0
            fi
            git fetch origin "$ref" --depth=1
            git rev-parse FETCH_HEAD
          }

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            # Nightly on default branch: compare current HEAD to its parent (best-effort).
            HEAD_SHA="$GITHUB_SHA"
            BASE_SHA="$(git rev-parse "${HEAD_SHA}^" 2>/dev/null || echo "$HEAD_SHA")"
            echo "PERF_PROFILE=quick" >> "$GITHUB_ENV"
          else
            DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"

            BASE_REF="$(normalize_ref "${INPUT_BASE_REF:-}")"
            HEAD_REF="$(normalize_ref "${INPUT_HEAD_REF:-}")"

            if [ -z "${BASE_REF}" ]; then
              BASE_REF="$DEFAULT_BRANCH"
            fi
            if [ -z "${HEAD_REF}" ]; then
              HEAD_REF="$GITHUB_SHA"
            fi

            echo "BASE_REF=$BASE_REF" >> "$GITHUB_ENV"
            echo "HEAD_REF=$HEAD_REF" >> "$GITHUB_ENV"

            BASE_SHA="$(resolve_ref_to_sha "$BASE_REF")"
            HEAD_SHA="$(resolve_ref_to_sha "$HEAD_REF")"

            if [ -n "${INPUT_PERF_FILES:-}" ]; then
              echo "PERF_FILES=$INPUT_PERF_FILES" >> "$GITHUB_ENV"
            fi
            if [ -n "${INPUT_PERF_PROFILE:-}" ]; then
              echo "PERF_PROFILE=$INPUT_PERF_PROFILE" >> "$GITHUB_ENV"
            fi
            if [ -n "${INPUT_DIFF_MODE:-}" ]; then
              echo "PERF_DIFF_MODE=$INPUT_DIFF_MODE" >> "$GITHUB_ENV"
            fi
          fi

          echo "BASE_SHA=$BASE_SHA" >> "$GITHUB_ENV"
          echo "HEAD_SHA=$HEAD_SHA" >> "$GITHUB_ENV"
          echo "BASE_SHORT=${BASE_SHA::8}" >> "$GITHUB_ENV"
          echo "HEAD_SHORT=${HEAD_SHA::8}" >> "$GITHUB_ENV"

          if git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- pnpm-lock.yaml | grep -q '^pnpm-lock.yaml$'; then
            echo "LOCKFILE_CHANGED=1" >> "$GITHUB_ENV"
          else
            echo "LOCKFILE_CHANGED=0" >> "$GITHUB_ENV"
          fi

      - name: Checkout head (for install)
        run: git checkout --quiet -f "$HEAD_SHA"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Chromium deps
        run: pnpm exec playwright install --with-deps chromium

      - name: Pin perf matrix (for strict comparability)
        run: |
          set -euo pipefail
          PINNED_MATRIX="$RUNNER_TEMP/logix-perf-matrix.json"
          mkdir -p "$(dirname "$PINNED_MATRIX")"
          cp .codex/skills/logix-perf-evidence/assets/matrix.json "$PINNED_MATRIX"
          echo "PERF_PINNED_MATRIX=$PINNED_MATRIX" >> "$GITHUB_ENV"

      - name: Collect (base)
        run: |
          mkdir -p "$PERF_OUT_DIR"
          git update-index --no-assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          git checkout --quiet -f "$BASE_SHA"
          if [ "${LOCKFILE_CHANGED:-0}" = "1" ]; then
            pnpm install --frozen-lockfile
          fi
          # Ensure base run uses the SAME matrix spec as head (tests import it).
          mkdir -p .codex/skills/logix-perf-evidence/assets
          git update-index --assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          cp "$PERF_PINNED_MATRIX" .codex/skills/logix-perf-evidence/assets/matrix.json
          IFS=',' read -r -a PERF_FILES_ARRAY <<< "${PERF_FILES}"
          FILE_ARGS=()
          for f in "${PERF_FILES_ARRAY[@]}"; do
            f="$(echo "$f" | xargs)"
            if [ -n "$f" ]; then
              FILE_ARGS+=(--files "$f")
            fi
          done
          VITE_LOGIX_PERF_HARD_GATES=off pnpm perf collect -- --profile "$PERF_PROFILE" \
            "${FILE_ARGS[@]}" \
            --out "$PERF_OUT_DIR/before.${BASE_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json"
          git update-index --no-assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          git checkout --quiet -f -- .codex/skills/logix-perf-evidence/assets/matrix.json || true

      - name: Collect (head)
        run: |
          git update-index --no-assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          git checkout --quiet -f "$HEAD_SHA"
          if [ "${LOCKFILE_CHANGED:-0}" = "1" ]; then
            pnpm install --frozen-lockfile
          fi
          mkdir -p .codex/skills/logix-perf-evidence/assets
          git update-index --assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          cp "$PERF_PINNED_MATRIX" .codex/skills/logix-perf-evidence/assets/matrix.json
          IFS=',' read -r -a PERF_FILES_ARRAY <<< "${PERF_FILES}"
          FILE_ARGS=()
          for f in "${PERF_FILES_ARRAY[@]}"; do
            f="$(echo "$f" | xargs)"
            if [ -n "$f" ]; then
              FILE_ARGS+=(--files "$f")
            fi
          done
          VITE_LOGIX_PERF_HARD_GATES=off pnpm perf collect -- --profile "$PERF_PROFILE" \
            "${FILE_ARGS[@]}" \
            --out "$PERF_OUT_DIR/after.${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json"
          git update-index --no-assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          git checkout --quiet -f -- .codex/skills/logix-perf-evidence/assets/matrix.json || true

      - name: Normalize reports (pin matrixHash + browser.version)
        run: |
          node .github/scripts/logix-perf-normalize-ci-reports.cjs \
            --before "$PERF_OUT_DIR/before.${BASE_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
            --after "$PERF_OUT_DIR/after.${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
            --matrix "$PERF_PINNED_MATRIX"

      - name: Diff (base..head)
        run: |
          if [ "${PERF_DIFF_MODE:-triage}" = "strict" ]; then
            pnpm perf diff -- \
              --before "$PERF_OUT_DIR/before.${BASE_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
              --after "$PERF_OUT_DIR/after.${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
              --out "$PERF_OUT_DIR/diff.${BASE_SHORT}__${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json"
          else
            pnpm perf diff:triage -- \
              --before "$PERF_OUT_DIR/before.${BASE_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
              --after "$PERF_OUT_DIR/after.${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
              --out "$PERF_OUT_DIR/diff.${BASE_SHORT}__${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json"
          fi

      - name: Write job summary (markdown)
        if: always()
        run: node .github/scripts/logix-perf-quick-summary.cjs

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PERF_ARTIFACT_NAME }}
          path: ${{ env.PERF_OUT_DIR }}
          if-no-files-found: warn

      - name: PR comment (summary)
        if: always() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("node:fs")

            try {
              const marker = "<!-- logix-perf-quick -->"
              const pr = context.payload.pull_request
              let summary = ""
              try {
                summary = fs.readFileSync("perf/ci/summary.md", "utf8")
              } catch {}

              const body =
                summary.trim().length > 0
                  ? `${marker}\n${summary}`
                  : `${marker}\n### logix-perf (quick)\n\n_summary.md not found. Check Actions logs and artifacts._\n`

              const { owner, repo } = context.repo
              const issue_number = pr.number

              const existing = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number,
                per_page: 100,
              })

              const found = existing.find((c) => typeof c.body === "string" && c.body.includes(marker))
              if (found) {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: found.id,
                  body,
                })
              } else {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number,
                  body,
                })
              }
            } catch (err) {
              const status = err?.status ?? err?.response?.status
              const message = String(err?.message ?? err)
              const isIntegration403 =
                status === 403 || message.includes("Resource not accessible by integration")

              if (isIntegration403) {
                console.log(`[logix-perf] PR comment skipped: ${message}`)
                return
              }

              console.log(`[logix-perf] PR comment failed (ignored): ${message}`)
            }
