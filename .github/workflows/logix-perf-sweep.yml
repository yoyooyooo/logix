name: logix-perf (sweep)

on:
  workflow_dispatch:
    inputs:
      base_ref:
        description: "before 基线（branch/tag/sha；留空=默认分支 tip）"
        required: false
        default: ""
      head_ref:
        description: "after 基线（branch/tag/sha；留空=触发 SHA）"
        required: false
        default: ""
      perf_files:
        description: "采集范围（logix-react browser perf 测试文件/目录；支持逗号分隔多个，相对 packages/logix-react）"
        required: false
        default: "test/browser/perf-boundaries/converge-steps.test.tsx"
      perf_profile:
        description: "采样 profile（smoke/quick/default/soak；影响 runs/warmup/timeout）"
        required: false
        default: "quick"
      diff_mode:
        description: "diff 模式（strict=不可比直接失败；triage=允许漂移，仅作线索）"
        required: false
        default: "strict"
  schedule:
    # Nightly (UTC): heavier converge sweep for tracking default parameters over time.
    - cron: "0 19 * * *"
    # Weekly (UTC): broader coverage across perf-boundaries.
    - cron: "0 19 * * 0"

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  # Avoid canceling long-running scheduled sweeps; keep manual/PR-triggered reruns cancelable.
  group: logix-perf-sweep-${{ github.event_name == 'schedule' && github.event.schedule || github.ref }}
  cancel-in-progress: ${{ github.event_name != 'schedule' }}

jobs:
  perf-sweep:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      PERF_FILES: test/browser/perf-boundaries/converge-steps.test.tsx
      PERF_PROFILE: quick
      PERF_DIFF_MODE: strict
      PERF_OUT_DIR: perf/ci
      PERF_ARTIFACT_NAME: logix-perf-sweep-${{ github.run_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute SHAs
        env:
          INPUT_BASE_REF: ${{ github.event.inputs.base_ref }}
          INPUT_HEAD_REF: ${{ github.event.inputs.head_ref }}
          INPUT_PERF_FILES: ${{ github.event.inputs.perf_files }}
          INPUT_PERF_PROFILE: ${{ github.event.inputs.perf_profile }}
          INPUT_DIFF_MODE: ${{ github.event.inputs.diff_mode }}
          GITHUB_EVENT_SCHEDULE: ${{ github.event.schedule }}
        run: |
          set -euo pipefail

          echo "PERF_ENV_ID=gh-${RUNNER_OS}-${RUNNER_ARCH}" >> "$GITHUB_ENV"

          normalize_ref() {
            local ref="$1"
            ref="${ref#refs/heads/}"
            ref="${ref#refs/remotes/origin/}"
            ref="${ref#origin/}"
            echo "$ref"
          }

          resolve_ref_to_sha() {
            local ref="$1"
            if git rev-parse --verify "${ref}^{commit}" >/dev/null 2>&1; then
              git rev-parse "${ref}^{commit}"
              return 0
            fi
            git fetch origin "$ref" --depth=1
            git rev-parse FETCH_HEAD
          }

          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"

	          if [ "${{ github.event_name }}" = "schedule" ]; then
	            # Scheduled run on default branch: compare current HEAD to its parent (best-effort).
	            HEAD_SHA="$GITHUB_SHA"
	            BASE_SHA="$(git rev-parse "${HEAD_SHA}^" 2>/dev/null || echo "$HEAD_SHA")"

            # Use SHAs for clarity in summaries (scheduled runs compare adjacent commits).
            echo "BASE_REF=$BASE_SHA" >> "$GITHUB_ENV"
            echo "HEAD_REF=$HEAD_SHA" >> "$GITHUB_ENV"

	            if [ "${GITHUB_EVENT_SCHEDULE:-}" = "0 19 * * 0" ]; then
	              # Weekly: mirror collect.ts default (perf-boundaries + watcher-browser-perf).
	              echo "PERF_FILES=test/browser/perf-boundaries,test/browser/watcher-browser-perf.test.tsx" >> "$GITHUB_ENV"
	              echo "PERF_PROFILE=default" >> "$GITHUB_ENV"
	              echo "PERF_ARTIFACT_NAME=logix-perf-sweep-weekly-${{ github.run_id }}" >> "$GITHUB_ENV"
	            else
              echo "PERF_FILES=test/browser/perf-boundaries/converge-steps.test.tsx" >> "$GITHUB_ENV"
              echo "PERF_PROFILE=default" >> "$GITHUB_ENV"
              echo "PERF_ARTIFACT_NAME=logix-perf-sweep-nightly-${{ github.run_id }}" >> "$GITHUB_ENV"
            fi
          else
            BASE_REF="$(normalize_ref "${INPUT_BASE_REF:-}")"
            HEAD_REF="$(normalize_ref "${INPUT_HEAD_REF:-}")"

            if [ -z "${BASE_REF}" ]; then
              BASE_REF="$DEFAULT_BRANCH"
            fi
            if [ -z "${HEAD_REF}" ]; then
              HEAD_REF="$GITHUB_SHA"
            fi

            echo "BASE_REF=$BASE_REF" >> "$GITHUB_ENV"
            echo "HEAD_REF=$HEAD_REF" >> "$GITHUB_ENV"

            BASE_SHA="$(resolve_ref_to_sha "$BASE_REF")"
            HEAD_SHA="$(resolve_ref_to_sha "$HEAD_REF")"

            if [ -n "${INPUT_PERF_FILES:-}" ]; then
              echo "PERF_FILES=$INPUT_PERF_FILES" >> "$GITHUB_ENV"
            fi
            if [ -n "${INPUT_PERF_PROFILE:-}" ]; then
              echo "PERF_PROFILE=$INPUT_PERF_PROFILE" >> "$GITHUB_ENV"
            fi
            if [ -n "${INPUT_DIFF_MODE:-}" ]; then
              echo "PERF_DIFF_MODE=$INPUT_DIFF_MODE" >> "$GITHUB_ENV"
            fi

            if [ -n "${INPUT_HEAD_REF:-}" ]; then
              echo "PERF_ARTIFACT_NAME=logix-perf-sweep-${{ github.run_id }}" >> "$GITHUB_ENV"
            fi
          fi

          echo "BASE_SHA=$BASE_SHA" >> "$GITHUB_ENV"
          echo "HEAD_SHA=$HEAD_SHA" >> "$GITHUB_ENV"
          echo "BASE_SHORT=${BASE_SHA::8}" >> "$GITHUB_ENV"
          echo "HEAD_SHORT=${HEAD_SHA::8}" >> "$GITHUB_ENV"

          if git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- pnpm-lock.yaml | grep -q '^pnpm-lock.yaml$'; then
            echo "LOCKFILE_CHANGED=1" >> "$GITHUB_ENV"
          else
            echo "LOCKFILE_CHANGED=0" >> "$GITHUB_ENV"
          fi

      - name: Checkout head (for install)
        run: git checkout --quiet -f "$HEAD_SHA"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Chromium deps
        run: pnpm exec playwright install --with-deps chromium

      - name: Pin perf matrix (for strict comparability)
        run: |
          set -euo pipefail
          PINNED_MATRIX="$RUNNER_TEMP/logix-perf-matrix.json"
          mkdir -p "$(dirname "$PINNED_MATRIX")"
          cp .codex/skills/logix-perf-evidence/assets/matrix.json "$PINNED_MATRIX"
          echo "PERF_PINNED_MATRIX=$PINNED_MATRIX" >> "$GITHUB_ENV"

      - name: Collect (base)
        run: |
          mkdir -p "$PERF_OUT_DIR"
          git update-index --no-assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          git checkout --quiet -f "$BASE_SHA"
          if [ "${LOCKFILE_CHANGED:-0}" = "1" ]; then
            pnpm install --frozen-lockfile
          fi
          # Ensure base run uses the SAME matrix spec as head (tests import it).
          mkdir -p .codex/skills/logix-perf-evidence/assets
          git update-index --assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          cp "$PERF_PINNED_MATRIX" .codex/skills/logix-perf-evidence/assets/matrix.json

          IFS=',' read -r -a PERF_FILES_ARRAY <<< "${PERF_FILES}"
          FILE_ARGS=()
          for f in "${PERF_FILES_ARRAY[@]}"; do
            f="$(echo "$f" | xargs)"
            if [ -n "$f" ]; then
              FILE_ARGS+=(--files "$f")
            fi
          done

          VITE_LOGIX_PERF_HARD_GATES=off pnpm perf collect -- --profile "$PERF_PROFILE" \
            "${FILE_ARGS[@]}" \
            --out "$PERF_OUT_DIR/before.${BASE_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json"
          git update-index --no-assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          git checkout --quiet -f -- .codex/skills/logix-perf-evidence/assets/matrix.json || true

      - name: Collect (head)
        run: |
          git update-index --no-assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          git checkout --quiet -f "$HEAD_SHA"
          if [ "${LOCKFILE_CHANGED:-0}" = "1" ]; then
            pnpm install --frozen-lockfile
          fi
          mkdir -p .codex/skills/logix-perf-evidence/assets
          git update-index --assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          cp "$PERF_PINNED_MATRIX" .codex/skills/logix-perf-evidence/assets/matrix.json

          IFS=',' read -r -a PERF_FILES_ARRAY <<< "${PERF_FILES}"
          FILE_ARGS=()
          for f in "${PERF_FILES_ARRAY[@]}"; do
            f="$(echo "$f" | xargs)"
            if [ -n "$f" ]; then
              FILE_ARGS+=(--files "$f")
            fi
          done

          VITE_LOGIX_PERF_HARD_GATES=off pnpm perf collect -- --profile "$PERF_PROFILE" \
            "${FILE_ARGS[@]}" \
            --out "$PERF_OUT_DIR/after.${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json"
          git update-index --no-assume-unchanged .codex/skills/logix-perf-evidence/assets/matrix.json || true
          git checkout --quiet -f -- .codex/skills/logix-perf-evidence/assets/matrix.json || true

      - name: Normalize reports (pin matrixHash + browser.version)
        run: |
          node .github/scripts/logix-perf-normalize-ci-reports.cjs \
            --before "$PERF_OUT_DIR/before.${BASE_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
            --after "$PERF_OUT_DIR/after.${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
            --matrix "$PERF_PINNED_MATRIX"

      - name: Diff (base..head)
        run: |
          if [ "${PERF_DIFF_MODE:-triage}" = "strict" ]; then
            pnpm perf diff -- \
              --before "$PERF_OUT_DIR/before.${BASE_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
              --after "$PERF_OUT_DIR/after.${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
              --out "$PERF_OUT_DIR/diff.${BASE_SHORT}__${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json"
          else
            pnpm perf diff:triage -- \
              --before "$PERF_OUT_DIR/before.${BASE_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
              --after "$PERF_OUT_DIR/after.${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json" \
              --out "$PERF_OUT_DIR/diff.${BASE_SHORT}__${HEAD_SHORT}.${PERF_ENV_ID}.${PERF_PROFILE}.json"
          fi

      - name: Write job summary (markdown)
        if: always()
        run: node .github/scripts/logix-perf-quick-summary.cjs

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PERF_ARTIFACT_NAME }}
          path: ${{ env.PERF_OUT_DIR }}
