id: service-adapter-query
name: 服务层 + 适配器 + Query Hook
version: v1
status: draft
summary: 适用于基于 HTTP 的业务接口接入场景，统一 service / adapter / TanStack Query Hook 的分层与职责。

problem: >
  在典型的 toB 管理系统中，大量页面需要对接后端接口：列表、详情、创建、更新、删除等。
  如果每个功能随意在组件中直接发请求、拼 URL、操作原始字段，不仅难以复用，也很难在
  错误处理、重试、缓存等方面保持一致。service-adapter-query 模式提供一套明确的分层约定：
  service 只做 IO，adapter 做结构转换，Query Hook 管理缓存与请求策略，组件只消费领域模型。
  该模式与 best-practice 仓库中的 API 集成与适配器规范一一对应，便于模板与生成器直接复用。

applicability:
  goodFor:
    - 基于 HTTP 的标准 CRUD 接口（列表 / 详情 / 创建 / 更新 / 删除）
    - 需要统一错误结构、重试策略与 Query Key 命名的场景
    - 希望服务层可替换、适配器可单测的中大型前端项目
  badFor:
    - WebSocket / 事件流等强实时接口（建议使用专门的异步流模式）
    - 单次调用、完全不会复用的脚本式逻辑
  preconditions:
    - 已有接口契约（OpenAPI 或等价文档），字段语义明确
    - 项目使用 TanStack Query 作为服务端缓存（与 best-practice 一致）

composition:
  roles:
    - id: ServiceModule
      label: 服务层模块（*.service.ts）
      description: >
        封装与后端 HTTP 接口的交互，聚合某个资源的所有操作（list/get/create/update/delete），
        不做数据结构转换，也不做复杂业务决策。返回原始 API 响应或轻度归一化后的数据。
      provides:
        - HttpService
      requires:
        - HttpClient
    - id: AdapterModule
      label: 适配器模块（*.adapter.ts）
      description: >
        在 API 原始结构与前端领域模型之间做纯函数转换，集中处理字段重命名、类型转换、
        默认值与 null/undefined 的归一化。适配器必须保持无副作用，便于单测与复用。
      provides:
        - DomainAdapter
    - id: QueryKeysModule
      label: Query Keys 工厂模块（*.query-keys.ts）
      description: >
        使用统一的 Query Key 工厂（如 @lukemorales/query-key-factory）为当前资源生成稳定的
        queryKey 命名空间，供 Query Hook 与服务层失效策略使用。
      provides:
        - QueryKeysFactory
    - id: QueryHookModule
      label: TanStack Query Hook 模块（*.hook.tsx）
      description: >
        封装具体查询逻辑（如 useOrderList / useOrderDetail），内部调用 ServiceModule，
        并使用 AdapterModule 将原始数据转换为领域模型，对外暴露干净的数据与加载/错误状态。
        Hook 内配置重试策略、staleTime 等缓存行为，不承担 UI 状态管理。
      requires:
        - HttpService
        - DomainAdapter
        - QueryKeysFactory
      provides:
        - QueryHook

dataContract:
  description: >
    本模式不直接规定 API 字段细节，但要求：
    1）为每个资源定义清晰的领域模型类型（例如 Order），并由 AdapterModule 负责转换；
    2）在 Intent 的 domain.apis 中声明接口路径、方法与请求参数，供模板和 Hook 推导。

paramsSchema:
  entity:
    type: string
    required: true
    desc: >
      绑定的领域实体名称，例如 Order、User。用于命名 Service/Adapter/Query Hook 以及推导类型。
  resourceName:
    type: string
    required: true
    desc: >
      服务端资源名或前缀，例如 "orders" 或 "users"，用于组合接口路径与 Query Key 命名空间。
  operations:
    type: array
    required: true
    item:
      type: string
      enum: [list, detail, create, update, delete]
    desc: >
      当前场景需要支持的操作集合。模板会根据该集合决定生成哪些服务方法和 Query Hook。
  hasPagination:
    type: boolean
    required: false
    default: false
    desc: >
      列表接口是否支持分页参数（page/pageSize）。若为 true，Query Hook 会约定分页参数与返回结构。
  queryKeyNamespace:
    type: string
    required: false
    desc: >
      Query Key 命名空间前缀，例如 "order"。缺省时可从 resourceName 推导。

uiSchema:
  entity:
    widget: text-input
    label: 领域实体名称
  resourceName:
    widget: text-input
    label: 资源名（通常为后端路径前缀）
  operations:
    widget: checkbox-group
    label: 支持的操作
    options:
      - value: list
        label: 列表
      - value: detail
        label: 详情
      - value: create
        label: 新建
      - value: update
        label: 更新
      - value: delete
        label: 删除
  hasPagination:
    widget: switch
    label: 列表是否分页
  queryKeyNamespace:
    widget: text-input
    label: Query Key 命名空间（可选）

examples:
  - name: 订单管理接口集成
    intentId: order-management
    description: >
      对应订单列表/详情等接口，将 listOrders/getOrder 等 API 通过 service-adapter-query 模式
      落地为 orderService / orderAdapter / orderKeys / useOrderList 等模块。
    docRefs:
      - /Users/yoyo/projj/git.imile.com/ux/best-practice/docs/03-development-guides/03-api-integration-guide.md
      - /Users/yoyo/projj/git.imile.com/ux/best-practice/docs/03-development-guides/11-adapter-pattern-guide.md
      - /Users/yoyo/projj/git.imile.com/ux/best-practice/llms/03-templates.yaml
