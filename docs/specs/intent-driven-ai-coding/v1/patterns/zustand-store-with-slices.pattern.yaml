id: zustand-store-with-slices
name: Zustand Store + Slice 拆分
version: v1
status: draft
summary: 适用于中大型前端功能模块，统一使用单一 Store + 多 Slice 的状态管理结构，并与 TanStack Query 职责分离。

problem: >
  在没有约束的情况下，Zustand 很容易被用成“随处可写的全局对象”：
  有的功能把服务端数据直接塞进 Store，有的在组件里裸写 useStore() 订阅整个状态，
  还有的把复杂派生逻辑和异步流程塞进 Store 内部，导致性能问题和状态不可预期。
  zustand-store-with-slices 模式整理了一套基础骨架：单一 Store 聚合根、按领域拆分 Slice、
  通过 Selector 计算派生状态、严格区分客户端 UI 状态与服务端缓存，配合 best-practice 中的状态管理规范。

applicability:
  goodFor:
    - 需要在多个组件之间共享 UI 状态的功能模块
    - 拥有多个子领域（列表过滤、表格 UI、弹层开关等）且需要独立演进的场景
    - 使用 TanStack Query 管理服务端数据缓存的项目
  badFor:
    - 只在单个组件内部使用的简单状态（优先 useState）
    - 极简一次性页面，不需要跨组件共享状态
  preconditions:
    - 已采用 Zustand 和 TanStack Query，且愿意遵守“服务端数据不进 Store”的硬约束

composition:
  roles:
    - id: StoreRoot
      label: Store 聚合根（*.store.ts）
      description: >
        定义单一的 Store 实例（如 useAppStore/useOrderStore），聚合多个 Slice，
        暴露统一的类型与 Hook。负责组合 initial state 与 actions，不直接编写业务逻辑。
      provides:
        - StoreHook
    - id: DataSlice
      label: 数据 Slice（*.slice.ts）
      description: >
        管理某一领域的数据型 UI 状态（例如当前选中的行、草稿表单、过滤条件等），
        只操作自身状态，不直接发起网络请求，不存放服务端缓存。
      provides:
        - DataSliceState
        - DataSliceActions
    - id: UISlice
      label: UI Slice（*.slice.ts）
      description: >
        管理纯 UI 状态（例如弹层开关、loading 标志、当前步骤索引等），
        不包含业务决策，保持简单可预测。
      provides:
        - UISliceState
        - UISliceActions
    - id: SelectorsModule
      label: Selector 模块（*.select.ts）
      description: >
        定义可复用的、从 Store 状态派生新信息的选择器，使用 memoization 保证性能，
        避免在组件中重复拼装派生逻辑。
      provides:
        - StoreSelectors

servicesProvided:
  - StoreHook
  - StoreSelectors

dataContract:
  description: >
    本模式不绑定具体实体数据结构，但要求：
    1）服务端数据（列表、详情）由 TanStack Query 管理，Store 仅持有 UI 状态；
    2）Store 的初始状态与 Slice 类型在类型层面明确声明，便于 refactor 与测试。

paramsSchema:
  storeName:
    type: string
    required: true
    desc: >
      Store 名称前缀，例如 "order" 或 "user"，用于生成 useOrderStore 等标识。
  enableImmer:
    type: boolean
    required: false
    default: true
    desc: >
      是否默认启用 immer 中间件。推荐在中大型项目中开启，以减少手写不可变更新的错误。
  slices:
    type: array
    required: true
    item:
      type: object
      fields:
        id:
          type: string
          required: true
          desc: Slice 标识，例如 "data" / "ui" / "filters"。
        kind:
          type: string
          enum: [data, ui]
          required: true
          desc: Slice 类型，用于区分数据型状态与纯 UI 状态。
        hasSelectors:
          type: boolean
          required: false
          default: false
          desc: 是否需要为该 Slice 生成基础 Selector 模板。

uiSchema:
  storeName:
    widget: text-input
    label: Store 名称前缀
  enableImmer:
    widget: switch
    label: 默认启用 immer
  slices:
    widget: table-editor
    label: Slice 列表
    columns:
      - key: id
        label: Slice 标识
        widget: text-input
      - key: kind
        label: Slice 类型
        widget: select
        options:
          - value: data
            label: 数据 Slice
          - value: ui
            label: UI Slice
      - key: hasSelectors
        label: 生成 Selector 模板
        widget: switch

examples:
  - name: 用户管理 Store 骨架
    intentId: user-management
    description: >
      将用户管理功能的客户端状态拆分为 data/ui 等 Slice，生成 basic.store.ts / data.slice.ts /
      ui.slice.ts / selectors 文件，配合 TanStack Query 管理用户列表与详情。
    docRefs:
      - /Users/yoyo/projj/git.imile.com/ux/best-practice/docs/02-principles-and-architecture/06-state-management.md
      - /Users/yoyo/projj/git.imile.com/ux/best-practice/docs/02-principles-and-architecture/08-zustand-guide/02-store-and-slice-setup.md
      - /Users/yoyo/projj/git.imile.com/ux/best-practice/snippets/state-management/basic.store.ts
