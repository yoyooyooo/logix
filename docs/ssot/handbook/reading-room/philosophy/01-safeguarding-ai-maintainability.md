# 为 AI 可维护性护航：Spec 007 的防波堤作用

> "Spec 007 确实是‘保驾护航’，但保的不是‘代码库的地位’，而是‘AI 生成代码的可维护性底线’。"

在 `specs/007-unify-trait-system` 的设计过程中，我们引入了一系列看似“反直觉”甚至“反人性”（对人类开发者而言）的严苛约束：0/1 次提交、显式反向闭包、强制同步状态机等。

这篇文档旨在阐述这些决策背后的核心意图：我们正在构建一个**防波堤**，旨在将 React 生态中那些**不可控、不可解释、不可回放**的混乱因素挡在门外，从而为 Logix 这个以“AI 驱动编程”为愿景的系统创造生存空间。

## 三大护航价值

如果没有这套严苛的 Spec，Trait 系统在面对 AI 生成的复杂业务逻辑时，将无法保证长期的可维护性。Spec 007 主要在以下三个维度提供护航：

### 1. 保“确定性” (Determinism)

- **现状**：传统 React 开发中，组件行为往往隐式依赖渲染时机、网络快慢或各类 Effect 的竞态。今天跑通的代码，明天网络稍慢或并发稍高，`useEffect` 执行顺序微变，Bug 就会随机出现。
- **Spec 007 的防线**：强制 **"0/1 Observable Commit"** 和 **"Synchronous State Machine"**（同步状态机）。
- **目的**：确保 AI 生成的代码，无论运行在何种网络环境（快/慢/丢包）或何种 React 调度模式（Concurrent/Legacy）下，其**逻辑结果在数学上是唯一的**。
  - Logix 的承诺是：“只要测试通过了一次，线上就不会有‘灵异事件’。”
  - 这消除了 AI 生成代码中的“环境耦合”隐患。

### 2. 保“可解释性” (Explainability / SSoT)

- **现状**：当系统出现 Bug，人类开发者往往需要在数十个分散的文件中排查：是哪个 `useEffect` 漏了依赖？是哪个回调闭包过期（stale closure）了？这种排查极其依赖人类直觉和上下文记忆。
- **Spec 007 的防线**：强制 **"Explicit Reverse Closure"**（显式反向闭包）和 **"Diagnostic Signals"**（诊断信号）。
- **目的**：当 AI 编写的逻辑出现 Bug 或冲突时，Runtime 必须能直接输出一张确定的**依赖图谱**和**冲突报告**（例如：“Rule A 与 Rule B 在 Cycle X 发生冲突”）。
  - 绝不让开发者（或 AI）去“猜”。
  - 这是未来 AI Agent 能够进行“自我调试（Self-Healing）”和“自我修复”的绝对前提。

### 3. 保“可回放性” (Replayability)

- **现状**：线上用户反馈“表单填了一半卡死”或“数据错乱”，开发者难以复现，因为无法捕获当时的临时中间态、竞态时序和用户交互序列。
- **Spec 007 的防线**：强制 **"Resource Snapshots"**（资源快照）和 **"Logix-Only I/O"**（通过 Logix 读写一切）。
- **目的**：任何 Bug 只要在生产环境发生过一次，就必须能通过一份简单的 JSON 事件日志在本地**完美复现**。
  - 对于 Logix 这种试图接管 B 端核心复杂逻辑的系统，可回放性是敢于上生产环境的安全底线。
  - 它将“偶发 Bug”降维打击为“必现 Bug”。

## 结论：工程复杂度的黑盒化

Spec 007 并非为了展示某种技术优越感，而是为了**逼迫**上层（无论是人类开发者还是 AI 模型）只能编写**纯粹的业务规则**。

通过将竞态处理、批处理、回放机制等高风险的“工程复杂度”封装在 Logix 内核这个“黑盒”里，我们实际上是在对 AI 说：

> "你只管描述业务意图（What），剩下的确定性执行（How）交给我。"

这就是 Logix 避免成为“AI 屎山生成器”的关键防线。

## 工程推论（把价值变成默认能力）

为了把“确定性 / 可解释性 / 可回放性”从口号变成默认能力，工程上必须接受一些硬约束（细节与清单见 `../reviews/08-philosophy-alignment.md`）：

- 事务窗口禁止 IO（IO 必须显式出现在 `.run*`/Task 路径里）。
- 业务不可写 `SubscriptionRef`，所有写入通过事务队列与 patch/dirty-set 记账。
- 诊断事件必须 Slim 且可序列化：只保留稳定标识、触发原因、输入快照、patch/dirty-set 与必要统计，不保留闭包/Effect 本体。
- 标识去随机化：稳定 instanceId + 单调序号（txnSeq/opSeq/selectorSeq/...）。
- 所有高层语法糖必须可降解到统一最小 IR（Static IR + Dynamic Trace），并支持冲突检测/合并。
