This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
drafts/
  L5/
    dsl-evolution-roadmap.md
    runtime-core-evolution.md
  L9/
    builder-studio-roadmap-alignment.md
    dynamic-list-form-pattern.md
    form-session-draft-pattern-convergence.md
    logic-for-shape-env-first-roadmap.md
    logix-instrumentation-overhaul.md
    logix-reactive-module-integration.md
    logix-reactive-schema.md
    logix-sugar-possibilities.md
    logix-unified-middleware.md
    matrix-acceptance-logix-support.md
    module-runtime-adapter-and-customization.md
    page-level-module-state-retention.md
    platform-patterns-as-flow-templates.md
    poisoned-effect-pattern.md
    react-live-component-host-poc.md
    resource-field-unified-data-plane.md
    runtime-logix-core-gaps-and-production-readiness.md
    runtime-logix-devtools-and-runtime-tree.md
    runtime-logix-fractal-runtime-and-feature-architecture.md
    runtime-logix-spec-adjustments.md
    runtime-logix-tag-collision-detection.md
    runtime-logix-watcher-perf-and-leak-check.md
  topics/
    ai-native-core/
      00-architecture.md
      10-effect-integration.md
      README.md
    ai-native-ui/
      00-architecture-overview.md
      01-philosophy-and-workflow.md
      10-skeleton-protocol.md
      11-ai-slot-protocol.md
      20-live-component-runtime.md
      30-compilation-toolchain.md
      40-storage-strategy.md
    api-evolution/
      next-gen-killer-apis.md
      README.md
      when-ai-api.md
    draft-pattern/
      00-design.md
      01-contract.md
      10-react-integration.md
      20-boundary-analysis.md
      README.md
    platform-patterns/
      generative-pattern-lifecycle.md
      generative-pattern-scenarios.md
      generative-patterns-refined.md
      README.md
    platform-vision/
      00-generative-language-server.md
      01-evolutionary-vision.md
      10-platform-deep-dive.md
      11-gap-analysis.md
      12-competitor-analysis.md
      13-bubblelab-insights.md
      intent-dev-api.md
      json-runtime-separation.md
    query-integration/
      01-unified-api-design.md
      02-integration-strategies.md
      03-module-computed.md
      04-reactive-paradigm.md
      05-implementation-plan.md
      06-unified-data-vision.md
      07-schema-link-deep-dive.md
      README.md
    react-adapter/
      01-hooks-api.md
      02-context-injection.md
      03-concurrent-rendering.md
      04-ssr-and-testing.md
      index.md
      README.md
    spec-studio/
      00-design.md
  index.md
  README.md
intent-driven-ai-coding/
  v1/
    01-overview.md
    02-patterns-and-intents.md
    08-flow-dsl-and-ast.md
    09-llm-collaboration-and-intent-workflow.md
    README.md
  v2/
    00-architecture-decision-records.md
    02-intent-layers.md
    99-history-and-comparison.md
    README.md
  v3/
    design/
      behavior-and-flow.md
      code-structure.md
      constraints-and-quality.md
      data-and-state.md
      interaction.md
      layout.md
      orchestration-and-wizards.md
      pattern-system.md
      playground-and-debug.md
      view-and-component.md
    examples/
      01-smart-search-poc.md
    platform/
      impl/
        app-and-universe-view.md
        code-runner-and-sandbox.md
        intent-rule-and-codegen.md
        logic-middleware-and-aop-ui.md
        README.md
      agent-orchestration.md
      README.md
    00-platform-manifesto.md
    01-overview.md
    02-intent-layers.md
    03-assets-and-schemas.md
    03-module-assets.md
    04-intent-to-code-example.md
    06-codegen-and-parser.md
    06-platform-ui-and-interactions.md
    07-ui-ux-detailed-specs.md
    97-effect-runtime-and-flow-execution.md
    98-time-travel-debugger.md
    99-glossary-and-ssot.md
    implementation-status.md
    roadmap-logix-platform.md
    SCHEMA_EVOLUTION.md
  adr.md
  blueprint.md
  README.md
review/
  runtime-logix-spec-todo.md
runtime-logix/
  builder/
    01-builder-design.md
  core/
    examples/
      01-basic-form.md
      02-complex-list.md
      03-external-integration.md
      04-dynamic-logic.md
      05-matrix-basic.md
      06-matrix-collection.md
      07-matrix-external.md
      08-matrix-flow.md
      09-matrix-advanced-data.md
      10-matrix-concurrency.md
      11-matrix-system.md
      12-pattern-intent-priority.md
      13-pattern-stream-orchestration.md
    00-manifesto.md
    01-architecture.md
    02-module-and-logic-api.md
    03-intent-alignment.md
    03-logic-and-flow.md
    04-logic-middleware.md
    04-pattern.md
    05-runtime-implementation.md
    06-platform-integration.md
    07-react-integration.md
    08-usage-guidelines.md
    09-debugging.md
    10-pattern-multi-instance.md
    integration-guide.md
    README.md
  form/
    poc/
      demo/
        address-form.component.demo.tsx
        global-search.component.demo.tsx
        README.md
        user-profile.component.demo.tsx
      src/
        address-form.ts
        app-runtime.ts
        domain.ts
        global-search.ts
        index.ts
        react-hooks.ts
        user-profile.ts
      package.json
      README.md
      tsconfig.json
    01-domain-model.md
    02-logic-preset.md
    03-react-api.md
    04-real-world-poc.md
    README.md
  impl/
    app-runtime-and-modules.md
    logic-middleware-and-aop.md
    module-lifecycle-and-scope.md
    package-structure.md
    README.md
    test-package.md
    v3-scope-lock.md
  react/
    README.md
  test/
    01-test-kit-design.md
    02-round-trip-testing.md
  README.md
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="drafts/L5/dsl-evolution-roadmap.md">
---
title: Logix DSL ä¸è¯­æ³•ç³–æ¼”è¿›è·¯çº¿ï¼ˆåˆå¹¶è‰ç¨¿ï¼‰
status: draft
version: 0.2.0
supersedes:
  - ../L9/logix-sugar-possibilities.md
  - ../L9/logic-for-shape-env-first-roadmap.md
---

# Logix DSL ä¸è¯­æ³•ç³–æ¼”è¿›è·¯çº¿

**ç›®æ ‡**: æ•´åˆ Sugar å¯èƒ½æ€§æ„¿æ™¯ä¸ Env-First API è®¾è®¡ï¼Œå½¢æˆç»Ÿä¸€çš„ DSL æ¼”è¿›æ–¹å‘ã€‚

---

## ä¸€ã€èƒŒæ™¯ä¸åŠ¨æœº

### 1.1 ä¸¤ä¸ªæ¼”è¿›æ–¹å‘

1. **å…ƒç¼–ç¨‹ä¸è¯­æ³•ç³–** (`logix-sugar-possibilities`)
   - åŸºäº Schema Metadata + Runtime Capabilities çš„å…ƒç¼–ç¨‹æ¨¡å¼
   - è¦†ç›–æŒä¹…åŒ–ã€æ ¡éªŒã€æƒé™ã€åŸ‹ç‚¹ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹
   - ç›®æ ‡ï¼šæè‡´ DXï¼Œé›¶æ ·æ¿ä»£ç 

2. **Env-First API å½¢æ€** (`Logic.forShape`)
   - ä» Runtime-First æ¼”è¿›åˆ° Env-First
   - `Module.logic(($)=>...)` vs `Logic.forShape<Sh,R>()`
   - ç›®æ ‡ï¼šæ›´å¥½çš„æ¨¡å—åŒ–ä¸ä¾èµ–æ³¨å…¥

### 1.2 å…±åŒæ„¿æ™¯

**åœ¨ä¿æŒ Logix æ ¸å¿ƒç®€å•çº¯ç²¹çš„åŒæ—¶ï¼Œä¸ºå¸¸è§æ¨¡å¼æä¾›ä¼˜é›…çš„è¯­æ³•ç³–å’ŒæŠ½è±¡ã€‚**

---

## äºŒã€å…ƒç¼–ç¨‹æ¨¡å¼ä¸ Sugar Roadmap

### 2.1 è®¾è®¡ç†å¿µ

åŸºäº **"Schema Metadata (è“å›¾) + Runtime Capabilities (æ‰§è¡ŒåŠ›)"** çš„å…ƒç¼–ç¨‹æ¨¡å¼ï¼š

- **Data**: Schema Annotations (å®šä¹‰æ•°æ®çš„å½¢çŠ¶ä¸èƒ½åŠ›)
- **Behavior**: Action Decorators (å®šä¹‰è¡Œä¸ºçš„ç­–ç•¥)
- **Flow**: Logic Enhancers (å®šä¹‰æµç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸ä¸Šä¸‹æ–‡)

### 2.2 Schema å±‚è¯­æ³•ç³–

#### æŒä¹…åŒ–ä¸åŒæ­¥

```typescript
// LocalStorage åŒæ­¥
theme: Schema.String.pipe(Schema.LocalStorage('app-theme'))
// è“å›¾ï¼šæ ‡è®°å­—æ®µéœ€è¦åŒæ­¥åˆ° LocalStorage
// è¿è¡Œæ—¶ï¼šInit ä» LS è¯»å–åˆå§‹å€¼ï¼›Watch ç›‘å¬å˜åŒ– â†’ Debounce â†’ å†™å…¥ LS

// URL Sync
search: Schema.String.pipe(Schema.UrlSync('q'))
// è“å›¾ï¼šå­—æ®µä¸ URL Query Param åŒå‘ç»‘å®š
// è¿è¡Œæ—¶ï¼šInit è§£æ URLï¼›Watch å­—æ®µå˜åŒ– â†’ replaceStateï¼›Listen popstate â†’ æ›´æ–°å­—æ®µ
```

#### å†å²è®°å½•

```typescript
canvas: CanvasSchema.pipe(Schema.TrackHistory)
// è“å›¾ï¼šæ ‡è®°è¯¥å­—æ®µæ”¯æŒæ’¤é”€é‡åš
// è¿è¡Œæ—¶ï¼šè‡ªåŠ¨ç»´æŠ¤ HistoryStack (Past/Future)ï¼Œæš´éœ² undo()/redo() Action
```

#### ç½‘ç»œäº¤äº’

```typescript
// ä¹è§‚æ›´æ–°
likeCount: Schema.Number.pipe(Schema.Optimistic(api.like))
// è“å›¾ï¼šæ ‡è®°ä¸º"ä¹è§‚çš„"
// è¿è¡Œæ—¶ï¼š1. ç«‹å³åº”ç”¨å˜æ›´åˆ° UIï¼›2. åå°æ‰§è¡Œ MutationFnï¼›3. å¤±è´¥è‡ªåŠ¨å›æ»š

// è½®è¯¢
status: Schema.Loadable.pipe(Schema.Polling(5000))
// è“å›¾ï¼šæ ‡è®°éœ€è¦è½®è¯¢
// è¿è¡Œæ—¶ï¼šè‡ªåŠ¨æŒ‚è½½å®šæ—¶å™¨ï¼Œå®šæœŸè§¦å‘ reload
```

#### éªŒè¯ä¸çº¦æŸ

```typescript
// å¼‚æ­¥æ ¡éªŒ
username: Schema.String.pipe(
  Schema.AsyncValidate(async (val) => checkUniqueness(val))
)
// è“å›¾ï¼šæ ‡è®°å­—æ®µéœ€è¦å¼‚æ­¥æ ¡éªŒ
// è¿è¡Œæ—¶ï¼šç›‘å¬è¾“å…¥ â†’ Debounce â†’ æ‰§è¡Œæ ¡éªŒ â†’ å†™å…¥ field.error

// è·¨å­—æ®µçº¦æŸ
confirmPassword: Schema.String.pipe(
  Schema.CrossValidate('password', (confirm, pwd) => confirm === pwd)
)
// è“å›¾ï¼šå®šä¹‰è·¨å­—æ®µçº¦æŸ
// è¿è¡Œæ—¶ï¼šç›‘å¬ä¸¤ä¸ªå­—æ®µå˜åŒ–ï¼Œè‡ªåŠ¨è§¦å‘æ ¡éªŒ
```

#### åŸ‹ç‚¹ä¸åˆ†æ

```typescript
tabIndex: Schema.Number.pipe(Schema.TrackChange('tab_switch'))
// è“å›¾ï¼šæ ‡è®°å­—æ®µå˜åŒ–æ—¶ä¸ŠæŠ¥åŸ‹ç‚¹
// è¿è¡Œæ—¶ï¼šç›‘å¬å˜åŒ– â†’ è¿‡æ»¤(å»é‡/é‡‡æ ·) â†’ è°ƒç”¨ Analytics Service
```

#### æƒé™æ§åˆ¶

```typescript
salary: Schema.Number.pipe(Schema.Guard('admin'))
// è“å›¾ï¼šæ ‡è®°è¯¥å­—æ®µéœ€è¦ç‰¹å®šæƒé™
// è¿è¡Œæ—¶ï¼šAction æ‹¦æˆª dispatchï¼›State è¯»å–æ—¶è„±æ•æˆ–è¿”å›ç©º
```

### 2.3 Action å±‚è¯­æ³•ç³–

```typescript
// é˜²æŠ–
searchAction: Action.Debounce(300)
// è“å›¾ï¼šæ ‡è®°è¯¥ Action éœ€è¦é˜²æŠ–
// è¿è¡Œæ—¶ï¼šè‡ªåŠ¨æ‹¦æˆª dispatchï¼Œåº”ç”¨é˜²æŠ–ç­–ç•¥

// é‡è¯•
fetchAction: Action.Retry(3)
// è“å›¾ï¼šæ ‡è®°å¤±è´¥åè‡ªåŠ¨é‡è¯•

// æ—¥å¿—
submitAction: Action.Log({ format: 'verbose' })
// è“å›¾ï¼šè‡ªåŠ¨æ‰“å°æ—¥å¿—
```

### 2.4 Logic å±‚è¯­æ³•ç³–

```typescript
// å•æ¬¡æ‰§è¡Œ
InitLogic: Logic.RunOnce
// è“å›¾ï¼šæ ‡è®°è¯¥ Logic åœ¨ Module ç”Ÿå‘½å‘¨æœŸå†…åªè¿è¡Œä¸€æ¬¡

// åå°æ‰§è¡Œ
HeavyComputeLogic: Logic.OnBackground
// è“å›¾ï¼šæ ‡è®°è¯¥ Logic åœ¨ Web Worker æˆ–åå°çº¿ç¨‹è¿è¡Œ
```

### 2.5 Module å±‚è¯­æ³•ç³–

```typescript
Logix.Module('User', {
  meta: { persist: true, role: 'admin' },
  state: ...
})
// æˆ–
Logix.Module('User', { ... }).pipe(
  Module.annotate({ author: 'Yoyo' })
)

Logic ä¹Ÿæ”¯æŒ Annotationï¼š
UserModule.logic(($) => ...).pipe(
  Logic.annotate({
    runOnce: true,
    debounce: 300
  })
)
```

### 2.6 å®ç°æœºåˆ¶ï¼šAnnotatable æ¥å£

å°† `Module` å’Œ `Logic` è®¾è®¡ä¸ºå®ç°äº† `Annotatable` æ¥å£çš„å¯¹è±¡ï¼ˆç±»ä¼¼ Effectï¼‰ã€‚
Runtime åœ¨åŠ è½½ Module/Logic æ—¶è¯»å– Metadataï¼Œæ®æ­¤è°ƒæ•´æ‰§è¡Œç­–ç•¥ã€‚

### 2.7 åŸåˆ™ä¸è¾¹ç•Œ

**é˜²æ­¢æ»¥ç”¨çš„ä¸‰å¤§åŸåˆ™**ï¼š

1. **é€‚ç”¨èŒƒå›´ (Scope)**
   - âœ… é€‚åˆï¼šæŒä¹…åŒ–ã€æ—¥å¿—ã€æƒé™ã€é˜²æŠ–ã€é‡è¯•ã€Undo/Redoï¼ˆæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼‰
   - âŒ ä¸é€‚åˆï¼šå…·ä½“ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚"è®¢å•é‡‘é¢å¤§äº 100 åˆ™æ‰“æŠ˜"ï¼‰

2. **æ˜¾å¼ä¼˜äºéšå¼ (Explicit over Implicit)**
   - âœ… Good: `Schema.Loadable` (æ˜ç¡®å£°æ˜å¼‚æ­¥å®¹å™¨)
   - âŒ Bad: `Schema.String.pipe(Schema.AutoFetch('/api/user'))` (éšè—ç½‘ç»œè¯·æ±‚)

3. **å¯é€ƒé€¸åŸåˆ™ (Escape Hatch)**
   - è¯­æ³•ç³–æ°¸è¿œåªæ˜¯"æ·å¾„"ï¼Œä¸æ˜¯"å”¯ä¸€è·¯å¾„"
   - ä»»ä½• Annotation å®ç°çš„åŠŸèƒ½éƒ½å¯é€šè¿‡æ‰‹å†™ Logic å®ç°
   - å¤æ‚éœ€æ±‚å¯å¹³æ»‘é€€å›æ˜¾å¼ç¼–ç¨‹æ¨¡å¼

---

## ä¸‰ã€Env-First API æ¼”è¿›

### 3.1 å½“å‰å…±è¯† (v3 PoC)

**ä¸šåŠ¡ä»£ç **ï¼š
- ç»Ÿä¸€å…¥å£ï¼š`SomeModule.logic(($)=>Effect.gen(...))`
- `$` è¯­ä¹‰ç”± `BoundApi` å®šä¹‰ï¼ˆstate/actions/flow/match/use/lifecycle/on*ï¼‰
- `Logic.forShape` è®°å·ä»…ä½œä¸º"é’ˆå¯¹æŸä¸ª Shape/Env çš„ `$` ç¼©å†™"ï¼Œä¸å¯¹åº”å®é™…å®ç°

**Pattern / åº“ä½œè€…**ï¼š
- æ¨èå½¢æ€ï¼š`( $: Logix.BoundApi<Sh,R> ) => Logic.Of<Sh,R,...>`
- è°ƒç”¨æ–¹é€šè¿‡ `Module.logic(($)=>pattern($))` è´Ÿè´£ç»‘å®š Module ä¸ Env
- Pattern ä¸ç›´æ¥ä¾èµ– `Logic.RuntimeTag` / `ModuleRuntime`

**å¹³å° / å›¾è°± / LLM**ï¼š
- ä»¥ `Module.logic(($)=>...)` ä½œä¸ºé™æ€é”šç‚¹ï¼Œåˆ©äºæ„å»º Logic Graph
- `Logic.forShape` åªä½œä¸ºæ¦‚å¿µæ€§è¯­æ³•ç³–ï¼Œä¸å¢åŠ æ–°å›¾è°±èŠ‚ç‚¹ç±»å‹

### 3.2 Env-First æ½œåœ¨å½¢æ€ï¼ˆè®¾æƒ³ï¼‰

è‹¥æœªæ¥éœ€è¦çœŸæ­£å®ç° `Logic.forShape`ï¼š

#### 1. Env è¯­ä¹‰æ”¶ç´§

```typescript
Logic.Env<Sh,R> = Logix.ModuleTag<Sh> | Logic.Platform | R

// Module.live å†…éƒ¨é€šè¿‡ Effect.provideService(Logic.RuntimeTag, runtime)
// å°†å½“å‰æ¨¡å— Runtime æ³¨å…¥ Env
```

#### 2. BoundApi/Flow Env-First å˜ä½“

```typescript
// åŸºäº Logic.RuntimeTag å– Runtime ç‰ˆæœ¬
BoundApi.forShape<Sh,R>()
Flow.forShape<Sh,R>()

// å®ç°ä¸Šä» Logic.Env<Sh,R> ä¸­è§£æ ModuleRuntime<StateOf<Sh>, ActionOf<Sh>>
```

#### 3. Logic.forShape ä½œä¸ºå·¥å‚

```typescript
Logic.forShape<Sh,R>(): BoundApi<Sh,R>

// è¦æ±‚è°ƒç”¨ç‚¹è¿è¡Œåœ¨ Logic.Env<Sh,R> ä¸Šï¼Œå¦åˆ™è¿è¡Œæ—¶ fail/die
// æ–‡æ¡£ä¸­ç°æœ‰ç¤ºä¾‹å¯ä»¥ä»"æ¦‚å¿µç¼©å†™"å‡çº§ä¸ºå¯è¿è¡Œå†™æ³•
```

#### 4. ä¸ Module.logic çš„å…³ç³»

- ä¸šåŠ¡å±‚ç»§ç»­æ¨èä½¿ç”¨ `Module.logic(($)=>...)`
- `Logic.forShape` æœåŠ¡äºï¼š
  - Pattern / Namespace å†…éƒ¨æå‰"ç»‘å½¢çŠ¶ï¼Œä¸ç»‘å…·ä½“ Module"
  - æç«¯æ‹†åˆ†åœºæ™¯ä¸‹ï¼Œå¤šä¸ªæ–‡ä»¶å…±äº«ç›¸åŒ Shape çš„ `$` çº¦æŸ

### 3.3 è¾¹ç•Œå…³ç³»ï¼ˆå¼€æ”¾é—®é¢˜ï¼‰

- [ ] Env-First ä¸ Runtime-First ä¸¤æ¡è·¯å¾„æ˜¯å¦éœ€è¦åœ¨å®ç°ä¸Šåˆå¹¶ï¼Ÿ
  - å¯èƒ½ï¼š`Module.logic(($)=>...)` å†…éƒ¨æœ¬èº«å°±è¿è¡Œåœ¨ `Logic.Env<Sh,R>` ä¸Š
- [ ] Pattern æ˜¯å¦ä»ç„¶é¦–é€‰ `( $: BoundApi<Sh,R> ) => Logic.Of<Sh,R,...>` å½¢æ€ï¼Ÿ
  - å€¾å‘ä¿æŒä¸å˜ï¼šPattern æŒç»­ä¾èµ– `$`ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¾èµ– `Logic.forShape`
- [ ] æ˜¯å¦å­˜åœ¨"**åªæœ‰ Env-First forShape æ‰èƒ½ä¼˜é›…è§£å†³**"çš„çœŸå®åœºæ™¯?
  - éœ€è¦ä»ç°æœ‰ PoC (Form / Matrix / Flow Orchestration) ä¸­åå‘æŒ–æ˜

### 3.4 å‘½åæ¢ç´¢

æ¯” `forShape` æ›´ç›´è§‚çš„å¯èƒ½å‘½åï¼š
- `Logic.env<Sh,R>()`
- `Logic.$<Sh,R>()`
- `Logic.bound<Sh,R>()`

---

## å››ã€Sugar ä¸ Env-First çš„ç»“åˆç‚¹

### 4.1 Annotation + Env-First

å…ƒç¼–ç¨‹çš„ Annotation æœºåˆ¶ä¸ Env-First API æ˜¯æ­£äº¤çš„ï¼š

```typescript
// Env-First + Annotation
const $ = Logic.forShape<Shape, Env>()

const MyLogic = Effect.gen(function*() {
  yield* $.flow.fromState(...)
}).pipe(
  Logic.annotate({ debounce: 300, runOnce: true })
)
```

### 4.2 Schema Sugar + Env-First Runtime

Schema å±‚çš„ Sugar (å¦‚ `Schema.LocalStorage`) æœ¬è´¨ä¸Šæ˜¯ç”Ÿæˆ ModuleLogicï¼š

```typescript
// Schema å®šä¹‰
state: Schema.Struct({
  theme: Schema.String.pipe(Schema.LocalStorage('app-theme'))
})

// Module.live è£…é…æ—¶ï¼š
// 1. æ‰«æ Schema, è¯†åˆ« LocalStorage Annotation
// 2. è‡ªåŠ¨ç”Ÿæˆä¸€æ®µ ModuleLogic: ç›‘å¬ theme å˜åŒ– â†’ å†™å…¥ LS
// 3. Env-First æˆ– Runtime-First éƒ½å¯ä»¥æ”¯æŒè¿™ä¸ª Logic
```

### 4.3 ç»Ÿä¸€æ„¿æ™¯

**Sugar æ˜¯ API è¡¨å±‚ï¼ŒEnv-First æ˜¯åº•å±‚æ¶æ„ã€‚ä¸¤è€…ç›¸è¾…ç›¸æˆï¼š**

- Sugar è®©å¸¸è§æ¨¡å¼æ›´ç®€æ´
- Env-First è®©æ¶æ„æ›´çµæ´»ã€å¯æµ‹è¯•
- æœ€ç»ˆéƒ½æ”¶æ•›åˆ° `ModuleLogic` / `BoundApi`

---

## äº”ã€ç»¼åˆè·¯çº¿å›¾

### é˜¶æ®µ 1: æ ¸å¿ƒ API ç¨³å®š (v3.x Current)

- [x] ä¿æŒ `Module.logic(($)=>...)` ä½œä¸ºä¸»å…¥å£
- [x] `Logic.forShape` ä»…ä½œä¸ºæ–‡æ¡£ä¸­çš„æ¦‚å¿µç¼©å†™
- [ ] è¡¥å…… Pattern å½¢æ€çš„æœ€ä½³å®è·µæ–‡æ¡£

### é˜¶æ®µ 2: åŸºç¡€ Sugar å®ç° (v3.x+)

- [ ] å®ç° `Schema.LocalStorage` / `Schema.UrlSync`
- [ ] å®ç° `Schema.Loadable` + `Query.field` (è§ query-integration topic)
- [ ] è¡¥å…… Annotation æœºåˆ¶çš„åŸºç¡€è®¾æ–½

### é˜¶æ®µ 3: Env-First æ¢ç´¢ (v4.0)

- [ ] ä»çœŸå® PoC åœºæ™¯ä¸­æŒ–æ˜ Env-First å¿…è¦æ€§
- [ ] è‹¥æœ‰å¿…è¦ï¼Œå®ç° `Logic.forShape` å·¥å‚
- [ ] ä¸ Module.logic åŒè½¨å…±å­˜ï¼Œè§‚å¯Ÿä½¿ç”¨åå¥½

### é˜¶æ®µ 4: é«˜çº§ Sugar æ‰©å±• (v4.x+)

- [ ] Action Decorators: Debounce / Retry / Log
- [ ] Logic Enhancers: RunOnce / OnBackground
- [ ] Module Meta: æ•´æ¨¡å—æŒä¹…åŒ– / æƒé™

### é˜¶æ®µ 5: å…ƒç¼–ç¨‹æˆç†Ÿ (v5.0+)

- [ ] å®Œæ•´ Annotatable æ¥å£
- [ ] Runtime è‡ªåŠ¨è¯†åˆ« Metadata å¹¶è°ƒæ•´æ‰§è¡Œç­–ç•¥
- [ ] é…å¥— DevTools å¯è§†åŒ– Annotations

---

## å…­ã€åŸåˆ™ä¸çº¦æŸ

### è®¾è®¡åŸåˆ™

1. **ä¸šåŠ¡å±‚ API ä¼˜å…ˆç¨³å®š**: `Module.logic` ä½œä¸ºé”šç‚¹ä¸è½»æ˜“å˜æ›´
2. **Sugar æ˜¯å¯é€‰å±‚**: æ‰€æœ‰ Sugar éƒ½å¯å¹³æ»‘é€€å›æ‰‹å†™ Logic
3. **Env-First æ˜¯æ¶æ„é€‰é¡¹**: å¯¹ä¸šåŠ¡é€æ˜ï¼Œç”± Pattern ä½œè€…å†³å®šæ˜¯å¦ä½¿ç”¨
4. **æ˜¾å¼ä¼˜äºéšå¼**: å‰¯ä½œç”¨å¿…é¡»å¯è§ï¼Œé¿å…é»‘é­”æ³•

### æŠ€æœ¯çº¦æŸ

1. **ç±»å‹å®‰å…¨**: æ‰€æœ‰ Sugar å¿…é¡»ä¿æŒå¼ºç±»å‹æ¨å¯¼
2. **æ€§èƒ½æ— æŸ**: Annotation åœ¨æœªå¯ç”¨æ—¶é›¶å¼€é”€
3. **å¯æµ‹è¯•æ€§**: Env-First å’Œ Sugar éƒ½å¿…é¡»æ˜“äºæµ‹è¯•
4. **å¹³å°å¯è§£æ**: Sugar ç”Ÿæˆçš„ Logic å¿…é¡»èƒ½è¢«å¹³å°é™æ€åˆ†æ

---

## ä¸ƒã€å¾…å†³é—®é¢˜

### Sugar æ–¹å‘

- [ ] å“ªäº› Sugar å±äº Level 1 (å¿…é¡»å®ç°) / Level 2 (æ¨è) / Level 3 (è“å›¾)ï¼Ÿ
- [ ] Schema Sugar ä¸ Reactive Module (è§ query-integration) å¦‚ä½•èåˆï¼Ÿ
- [ ] Annotation æœºåˆ¶æ˜¯å¦éœ€è¦å®Œæ•´çš„ Type-Level Metadataï¼Ÿ

### Env-First æ–¹å‘

- [ ] æ˜¯å¦çœŸçš„å­˜åœ¨"é Env-First ä¸å¯"çš„åœºæ™¯ï¼Ÿ
- [ ] `Logic.forShape` çš„å‘½åä¸å­¦ä¹ æ›²çº¿å¦‚ä½•ä¼˜åŒ–ï¼Ÿ
- [ ] ä¸å¹³å°é™æ€åˆ†æçš„å…¼å®¹æ€§å¦‚ä½•ä¿è¯ï¼Ÿ

### æ•´åˆæ–¹å‘

- [ ] Sugar + Env-First çš„ç»„åˆæ˜¯å¦ä¼šå¯¼è‡´å¤æ‚åº¦çˆ†ç‚¸ï¼Ÿ
- [ ] å¦‚ä½•åœ¨æ–‡æ¡£ä¸­æ¸…æ™°åŒºåˆ†"åŸºç¡€ API" / "Sugar" / "é«˜çº§æ¶æ„"å±‚æ¬¡ï¼Ÿ

---

## å…«ã€ç›¸å…³æ–‡æ¡£

- [runtime-logix/core/02-module-and-logic-api.md](../../runtime-logix/core/02-module-and-logic-api.md)
- [runtime-logix/core/03-logic-and-flow.md](../../runtime-logix/core/03-logic-and-flow.md)
- [topics/query-integration/](../topics/query-integration/) (Query.field ä¸ Reactive Schema)

---

**ç‰ˆæœ¬å†å²**:

- v0.2.0 (2025-12-02): åˆå¹¶ Sugar å¯èƒ½æ€§ä¸ Env-First è·¯çº¿ï¼Œå½¢æˆç»Ÿä¸€ DSL æ¼”è¿›å›¾
- v0.1.0 (2025-11-30): å„å•ç¯‡è‰ç¨¿ç‹¬ç«‹ç‰ˆæœ¬
</file>

<file path="drafts/L5/runtime-core-evolution.md">
---
title: Logix Runtime æ ¸å¿ƒæ¼”è¿›è·¯çº¿ï¼ˆåˆå¹¶è‰ç¨¿ï¼‰
status: draft
version: 0.2.0
supersedes:
  - ../L9/logix-instrumentation-overhaul.md
  - ../L9/runtime-logix-spec-adjustments.md
  - ../L9/module-runtime-adapter-and-customization.md
---

# Logix Runtime æ ¸å¿ƒæ¼”è¿›è·¯çº¿

**ç›®æ ‡**: æ•´åˆè§‚æµ‹æ€§ã€è§„èŒƒè¾¹ç•Œã€é€‚é…æ‰©å±•ä¸‰ä¸ªç»´åº¦çš„ Runtime æ¼”è¿›æ–¹å‘ï¼Œå½¢æˆç»Ÿä¸€çš„æŠ€æœ¯è·¯çº¿å›¾ã€‚

---

## ä¸€ã€èƒŒæ™¯ä¸é—®é¢˜åŸŸ

### 1.1 ä¸‰ä¸ªæ ¸å¿ƒæŒ‘æˆ˜

å½“å‰ Logix runtime-logix è§„èŒƒä¸å®ç°åœ¨ä»¥ä¸‹ä¸‰ä¸ªæ–¹å‘å­˜åœ¨æ¼”è¿›éœ€æ±‚ï¼š

1. **è§‚æµ‹æ€§æ¶æ„** (`secure` â†’ Supervisor)
   - ç°çŠ¶ï¼š`Logic.secure` æ‰‹åŠ¨åŒ…è£…ï¼Œè¯­ä¹‰æ­§ä¹‰ï¼Œé Effect åŸç”Ÿ
   - ç›®æ ‡ï¼šé›¶ä¾µå…¥ã€Supervisor é©±åŠ¨ã€ä¸ Effect ç”Ÿæ€æ·±åº¦é›†æˆ

2. **è§„èŒƒè¾¹ç•Œä¸çµæ´»æ€§** (ModuleRuntime.make èŒè´£)
   - ç°çŠ¶ï¼šéƒ¨åˆ†è§„èŒƒçº¦æŸè¿‡å¼ºï¼Œå®ç°è·¯å¾„å•ä¸€
   - ç›®æ ‡ï¼šåŒºåˆ†ç¡¬è¾¹ç•Œï¼ˆæ¥å£/è¯­ä¹‰ï¼‰ä¸è½¯å»ºè®®ï¼ˆå®ç°æ–¹å¼ï¼‰

3. **Runtime é€‚é…ä¸æ‰©å±•** (è‡ªå®šä¹‰ Runtime è·¯å¾„)
   - ç°çŠ¶ï¼šé€‚é…ä½œè€…éœ€ä»é›¶å®ç° `ModuleRuntime` æ¥å£
   - ç›®æ ‡ï¼šæä¾› Adapter ä¸­é—´å±‚ï¼Œæ”¯æŒè¿œç¨‹ Store / æµ‹è¯• Runtime

### 1.2 è®¾è®¡åŸåˆ™

- **æ¸è¿›å¼æ¼”è¿›**: ä¼˜å…ˆè§£å†³å®è·µä¸­çš„ç‡ƒçœ‰ä¹‹æ€¥ï¼Œé•¿æœŸèƒ½åŠ›ä¿ç•™åœ¨è“å›¾ä¸­
- **åˆ†å±‚æ¸…æ™°**: åŒºåˆ† Level 1 (å¿…é¡») / Level 2 (æ¨è) / Level 3 (è“å›¾)
- **ä¸šåŠ¡é€æ˜**: Runtime æ¼”è¿›ä¸åº”å½±å“ä¸šåŠ¡ Module/Logic ç¼–å†™ä½“éªŒ

---

## äºŒã€è§‚æµ‹æ€§é‡æ„ï¼šä» `secure` åˆ° Supervisor

### 2.1 ç°çŠ¶ç—›ç‚¹

å½“å‰ `Logic.secure` å­˜åœ¨çš„é—®é¢˜ï¼š

1. **è¯­ä¹‰æ­§ä¹‰**: åç§°æš—ç¤ºå®‰å…¨/é‰´æƒï¼Œå®é™…æ˜¯æ’æ¡©/AOP
2. **æ‰‹åŠ¨ä¸”è„†å¼±**: ä¾èµ– DSL å±‚æ˜¾å¼è°ƒç”¨ï¼Œç»•è¿‡ Builder å°±å¤±å»å¯è§‚æµ‹æ€§
3. **é Effect åŸç”Ÿ**: é€šè¿‡å‡½æ•°å‚æ•°ä¼ é€’å…ƒæ•°æ®ï¼Œå¿½ç•¥ FiberRef/Supervisor/Tracer
4. **ä¸­é—´ä»¶åƒµåŒ–**: ä¸è°ƒç”¨ç‚¹è€¦åˆï¼Œéš¾ä»¥å…¨å±€é…ç½®

### 2.2 ç›®æ ‡æ„¿æ™¯

**é›¶ä¾µå…¥ã€æ— å¤„ä¸åœ¨ã€é›¶å¼€é”€**çš„è§‚æµ‹æ€§ï¼š

- **é›¶ä¾µå…¥**: ä¸šåŠ¡é€»è¾‘ä¸æ„ŸçŸ¥ç›‘æ§ï¼Œæ— éœ€ `secure(...)` åŒ…è£…å™¨
- **Supervisor é©±åŠ¨**: ä½¿ç”¨ `Effect.Supervisor` è‡ªåŠ¨æ•è· Logic æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ
- **Trace ä¼˜å…ˆ**: å…ƒæ•°æ®é€šè¿‡ `FiberRef` ä¼ æ’­ï¼Œä¸ `Effect.Tracer` é›†æˆ
- **ç»“æ„åŒ–æ—¥å¿—**: ä½¿ç”¨ `Effect.annotateLogs` è‡ªåŠ¨é™„åŠ ä¸Šä¸‹æ–‡

### 2.3 è¿ç§»è·¯çº¿å›¾

#### é˜¶æ®µ 1: è¯­ä¹‰å¯¹é½ (v3.1)

```typescript
// ä¹‹å‰
Logic.secure(effect, { name: "flow.run" })

// ä¹‹å
import { LogicContext } from "@logix/core/internal"

const instrument = (effect, meta) =>
  effect.pipe(
    // 1. æ³¨å…¥å…ƒæ•°æ®åˆ° FiberRef
    LogicContext.withMeta(meta),
    // 2. åŸç”Ÿ Tracing é›†æˆ
    Effect.withSpan(`Logix.${meta.name}`, { attributes: meta }),
    // 3. æ—¥å¿—æ³¨è§£
    Effect.annotateLogs({ logic_op: meta.name })
  )
```

- é‡å‘½å `Logic.secure` â†’ `Logic.instrument`
- å‰¥ç¦»é”™è¯¯å¤„ç†ï¼Œç§»å…¥ `Logic.catch` æˆ– Flow å®šä¹‰

#### é˜¶æ®µ 2: FiberRef ä¸Šä¸‹æ–‡ (v3.2)

```typescript
export const CurrentLogicMeta = FiberRef.unsafeMake<LogicMeta | null>(null)

const runFlow = (flow, meta) =>
  flow.pipe(
    Effect.locally(CurrentLogicMeta, meta),
    Effect.catchAllCause(cause => handleLogicError(cause, meta)),
    Effect.fork
  )
```

- åˆ›å»º `LogicContext` æœåŠ¡/FiberRef
- éªŒè¯å¹¶å‘ç®—å­ä¸‹çš„ Context ä¼ æ’­ï¼ˆSnapshot æœºåˆ¶ï¼‰

#### é˜¶æ®µ 3: Supervisor å®ç° (v4.0)

```typescript
const LogixSupervisorLive = Layer.succeed(
  Supervisor.Tag,
  new LogixSupervisor({
    onStart: (context, fiber) => telemetry.trackStart(context),
    onEnd: (value, fiber) => telemetry.trackEnd(value)
  })
)

const runtimeLayer = Layer.mergeAll(
  LogixSupervisorLive,
  LogicContextLive,
  // ...
)
```

- å®ç° `LogixSupervisor` å¹¶é€šè¿‡ Layer æ³¨å…¥
- ç§»é™¤ DSL ä¸­çš„ `Logic.instrument`
- è‡ªåŠ¨æ³¨å…¥ `LogicBoundaryTag` å’Œé”™è¯¯è¾¹ç•Œ

### 2.4 é£é™©ä¸ç¼“è§£

| é£é™© | ç¼“è§£ç­–ç•¥ |
|------|---------|
| **æ€§èƒ½å¼€é”€** | é‡‡æ ·ä¸è¿‡æ»¤ï¼šä»…å¤„ç†å¸¦ `LogicBoundary` æ ‡è®°çš„ Fiberï¼›å¼‚æ­¥å¤„ç† Ring Buffer |
| **è°ƒè¯•ä½“éªŒ** | é…å¥— DevToolsï¼›æä¾› `Logix.debug(true)` å¼€å…³è¾“å‡º Context ä¼ æ’­æ—¥å¿— |
| **å¤šå®ä¾‹/SSR** | å®ä¾‹çº§ Scopeï¼šSupervisor éš `ModuleRuntime` å®ä¾‹åŒ–ï¼›ç¯å¢ƒæ„ŸçŸ¥ï¼ŒSSR ä»…è®°å½•æ—¥å¿— |
| **è¾¹ç•Œç•Œå®š** | DSL å±‚è‡ªåŠ¨æ³¨å…¥ `LogicBoundaryTag`ï¼›æ˜¾å¼é”™è¯¯è¾¹ç•ŒåŒ…è£¹ |
| **è¿ç§»æˆæœ¬** | v3.x åŒæ¨¡å…±å­˜ï¼›æä¾› Codemod å·¥å…· |

---

## ä¸‰ã€è§„èŒƒè¾¹ç•Œä¼˜åŒ–ï¼šç¡¬çº¦æŸ vs è½¯å»ºè®®

### 3.1 ModuleRuntime.make èŒè´£è°ƒæ•´

#### ç°çŠ¶é—®é¢˜

- è§„èŒƒå°† `ModuleRuntime.make` å®šä¹‰ä¸ºæ¥æ”¶å¤šä¸ª Layer çš„ç»Ÿä¸€å…¥å£
- å¯¹å®ç°æ–¹çº¦æŸè¿‡å¼ºï¼Œæ‰©å±•ç©ºé—´æœ‰é™
- ä¸šåŠ¡ä»£ç å®é™…åªå…³å¿ƒ `Module.live(initial, ...logics)`

#### è°ƒæ•´æ–¹å‘

**åŒºåˆ†ä¸¤å±‚è¾¹ç•Œ**ï¼š

1. **ç¡¬è¾¹ç•Œ (Level 1)**: `ModuleRuntime` æ¥å£ä¸è¯­ä¹‰ä¸å˜å¼
   - `getState` / `setState`: å•ä¸€ä¸€è‡´ State æ ‘
   - `dispatch` / `actions$`: é¡ºåºä¿è¯
   - `changes(selector)`: è§†å›¾å˜åŒ–æµè¯­ä¹‰
   - `ref()`: SubscriptionRef è§†å›¾

2. **è½¯å»ºè®® (Level 2)**: å¦‚ä½•åŸºäº Effect Layer ç»„åˆå¾—åˆ°æ ‡å‡†å®ç°
   - ä¿ç•™ä¼ªä»£ç ç”¨äºè§£é‡Š Runtime å·¥ä½œåŸç†
   - å…è®¸å¤šç§å®ç°å˜ä½“ï¼Œä¸è¦æ±‚å”¯ä¸€
   - å®é™…åˆ†å±‚å¯ä»¥æ˜¯ï¼š
     - `ModuleRuntime.make(initialState)` åªè´Ÿè´£æ ¸å¿ƒ
     - `Module.live` è´Ÿè´£ç»‘å®š Shape + Logic + Runtime

### 3.2 è‡ªå®šä¹‰ Runtime æ„é€ è·¯å¾„

#### åˆæ³•è·¯å¾„

- ç›´æ¥æä¾› `Layer<Tag, E, R>`ï¼Œæ„é€ ä»»æ„ç¬¦åˆæ¥å£çš„å®ç°
- é€šè¿‡ Adapter åŒ…è£…è¿œç¨‹ Store / è°ƒè¯• Runtime
- æµ‹è¯•ç¯å¢ƒç”¨ä¸“ç”¨ `TestRuntime`

#### è§„èŒƒè¦æ±‚

- ä¿ç•™è¯­ä¹‰ä¸å˜å¼å’Œ"åˆæ³•/ä¸æ¨èç”¨æ³•"åˆ—è¡¨
- å°†"åº”è¯¥é€šè¿‡ `ModuleRuntime.make` æ„é€ "æ”¹ä¸º"æ¨èå®ç°ä¹‹ä¸€"
- å¢è¡¥"è‡ªå®šä¹‰ Runtime è®¾è®¡æŒ‡å—"
  - è¿œç¨‹ Store åŒ…è£…
  - æµ‹è¯• Runtime
  - åªè¯» Runtime
  - å¦‚ä½•éªŒè¯ä¸å˜å¼

### 3.3 Debug / Inspector çš„åˆ†çº§

#### çŸ­æœŸç¡¬çº¦æŸ (Level 1)

- æ ¸å¿ƒ Runtime / BoundApi ç¦æ­¢ç›´æ¥ `console.log`
- æ‰€æœ‰è°ƒè¯•è¾“å‡ºé€šè¿‡ Effect æ—¥å¿—æˆ–å¯æ’æ‹” Layer
- å®šä¹‰ç®€å• Debug äº‹ä»¶æµï¼ˆAction/State å˜åŒ–ï¼‰

#### é•¿æœŸè“å›¾ (Level 3)

- Inspector / Scope Lock / Replay ä¿æŒåœ¨ `impl` æˆ– Topics è‰ç¨¿
- æ ‡è®°ä¸º"v3.x+ ç›®æ ‡è®¾è®¡"
- è§„èŒƒèšç„¦"è¾¹ç•Œ"ï¼ˆä¸å½±å“ä¸šåŠ¡è¯­ä¹‰ã€ä¸ç ´åæ€§èƒ½ï¼‰

### 3.4 React & Test è§„èŒƒå¼ºåº¦

**å¼•å…¥å±‚çº§æ ‡è®°**ï¼š

- **Level 1**: å¿…é¡»éµå®ˆçš„è¡Œä¸ºè¾¹ç•Œ
  - React: é¿å… tearingï¼ŒRuntime å¼•ç”¨ç¨³å®š
  - Test: ä¸ä¾èµ–å¤–éƒ¨å…¨å±€çŠ¶æ€

- **Level 2**: æ¨è API å½¢çŠ¶ï¼ˆå…è®¸å¾®è°ƒï¼‰
  - `useModule` / `useSelector` / `useDispatch`
  - `TestProgram` + `runTest`

- **Level 3**: é•¿æœŸèƒ½åŠ›
  - å®Œæ•´ trace / å¯è§†åŒ–é›†æˆ

---

## å››ã€Runtime é€‚é…ä¸æ‰©å±•èƒ½åŠ›

### 4.1 è®¾è®¡ç›®æ ‡

- ä¸º"è‡ªå®šä¹‰ ModuleRuntime"æä¾›æ¨èè·¯å¾„
- æ”¯æŒè¿œç¨‹ Store / æµ‹è¯• Runtime / ç‰¹æ®Šå¹³å°æŒä¹…åŒ–
- æä¾›ä¸­é—´å±‚æŠ½è±¡ï¼Œé¿å…ä»é›¶å®ç°å®Œæ•´æ¥å£

### 4.2 Adapter å½¢æ€

```typescript
interface RuntimeAdapter<S, A> {
  getState: Effect.Effect<S>
  setState?: (s: S) => Effect.Effect<void>
  actions$: Stream.Stream<A>
  changes$?: Stream.Stream<S>
}

namespace ModuleRuntime {
  export function fromAdapter<S, A>(
    adapter: RuntimeAdapter<S, A>,
  ): Logix.ModuleRuntime<S, A> {
    // å®ç°åœ¨ runtime-logix/impl
  }
}
```

**è®¾è®¡æ„å›¾**ï¼š

- é€‚é…ä½œè€…å…³æ³¨"å¦‚ä½•ä»å¤–éƒ¨ç³»ç»Ÿè¯»/å†™çŠ¶æ€ã€ç›‘å¬ action/state æµ"
- `fromAdapter` è¡¥é½å…¶ä½™èƒ½åŠ›ï¼š
  - è‹¥åªæä¾› `actions$`ï¼Œå°è£… `dispatch`
  - è‹¥åªæä¾› `changes$`ï¼Œå åŠ  `distinctUntilChanged`ã€selector æŠ•å½±
  - `ref()` ç»Ÿä¸€åŸºäº `SubscriptionRef` å°è£…

### 4.3 ä½¿ç”¨è·¯å¾„

#### æ ‡å‡†æœ¬åœ° Store

```typescript
const MyModule = Logix.Module('MyModule', { state, actions })
const MyLogic = MyModule.logic(($) => ...)
const MyLive = MyModule.live(initial, MyLogic)

Logix.app({
  layer: ServiceLayer,
  modules: [Logix.provide(MyModule, MyLive)]
})
```

#### è‡ªå®šä¹‰ Runtime / è¿œç¨‹ Store

```typescript
const adapter: RuntimeAdapter<State, Action> = {
  getState: Effect.gen(function*() {
    const client = yield* RemoteStoreClient
    return yield* client.getState()
  }),
  actions$: remoteActionsStream,
  // ...
}

const customRuntime = ModuleRuntime.fromAdapter(adapter)

Logix.app({
  layer: ServiceLayer,
  modules: [Logix.provide(MyModule, customRuntime)]
})
```

ä¸šåŠ¡ Logic ä»é€šè¿‡ `Module.logic(($) => ...)` ç¼–æ’ï¼Œä¸æ„ŸçŸ¥åº•å±‚å·®å¼‚ã€‚

### 4.4 ä¸ä¸šåŠ¡å¼€å‘è€…çš„è¾¹ç•Œ

**å¼•æ“/é€‚é…å±‚ APIï¼ˆä¸å‡ºç°åœ¨ä¸šåŠ¡æ–‡æ¡£ï¼‰**:
- `ModuleRuntime`
- `RuntimeAdapter`
- `fromAdapter`

**ä¸šåŠ¡å¼€å‘è€…åªéœ€è¦**:
- å®šä¹‰ Module: `Logix.Module`
- ç¼–å†™ Logic: `Module.logic(($)=>...)`
- ä½¿ç”¨è¿è¡Œæ—¶: `Module.live` / `Logix.app` / React Adapter
- ç‰¹æ®Š Runtime ç”±å¹³å°/é€‚é…å›¢é˜Ÿæä¾›å°è£…ï¼ˆå¯¹ä¸šåŠ¡é€æ˜ï¼‰

---

## äº”ã€ç»¼åˆè·¯çº¿å›¾

### é˜¶æ®µ 1: ç«‹å³æ”¹è¿› (v3.1)

- [ ] é‡å‘½å `Logic.secure` â†’ `Logic.instrument`
- [ ] å‰¥ç¦»é”™è¯¯å¤„ç†é€»è¾‘
- [ ] æ›´æ–°è§„èŒƒï¼šåŒºåˆ† `ModuleRuntime` ç¡¬è¾¹ç•Œä¸è½¯å»ºè®®
- [ ] ç¦æ­¢æ ¸å¿ƒä»£ç ç›´æ¥ `console.log`

### é˜¶æ®µ 2: FiberRef ä¸Šä¸‹æ–‡ (v3.2)

- [ ] å®ç° `LogicContext` FiberRef
- [ ] éªŒè¯å¹¶å‘ç®—å­ä¸‹çš„ Context ä¼ æ’­
- [ ] æä¾›ç®€å• Debug äº‹ä»¶æµ

### é˜¶æ®µ 3: Adapter èƒ½åŠ› (v3.3)

- [ ] å®ç° `ModuleRuntime.fromAdapter`
- [ ] è¡¥å……è¿œç¨‹ Store / æµ‹è¯• Runtime ç¤ºä¾‹
- [ ] æ›´æ–°æ–‡æ¡£ï¼šè‡ªå®šä¹‰ Runtime è®¾è®¡æŒ‡å—

### é˜¶æ®µ 4: Supervisor å®ç° (v4.0)

- [ ] å®ç° `LogixSupervisor` å¹¶é€šè¿‡ Layer æ³¨å…¥
- [ ] ç§»é™¤ DSL ä¸­çš„æ˜¾å¼ `Logic.instrument`
- [ ] é…å¥— DevTools / è°ƒè¯•æ¨¡å¼

### é˜¶æ®µ 5: é•¿æœŸè“å›¾ (v4.x+)

- [ ] Inspector / Scope Lock / Replay
- [ ] å®Œæ•´ OpenTelemetry é›†æˆ
- [ ] å¯è§†åŒ– Trace å·¥å…·

---

## å…­ã€å¾…å†³é—®é¢˜

### è§‚æµ‹æ€§æ–¹å‘

- [ ] Supervisor ä¸ Middleware çš„èŒè´£è¾¹ç•Œå¦‚ä½•åˆ’åˆ†ï¼Ÿ
- [ ] å¦‚ä½•åœ¨å¤šå®ä¾‹åœºæ™¯ä¸‹é¿å… Trace æ··æ·†ï¼Ÿ
- [ ] SSR ç¯å¢ƒä¸‹çš„è§‚æµ‹ç­–ç•¥ï¼Ÿ

### è§„èŒƒè¾¹ç•Œ

- [ ] React / Test è§„èŒƒçš„ Level 1/2/3 å¦‚ä½•åœ¨æ–‡æ¡£ä¸­æ¸…æ™°æ ‡è®°ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦ä¸º"è§„èŒƒåå·®"å»ºç«‹ä¸“é—¨çš„ ADR æµç¨‹ï¼Ÿ

### Adapter æ‰©å±•

- [ ] Adapter æ¥å£çš„æœ€å°å½¢çŠ¶æ˜¯å¦è¶³å¤Ÿï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦ä¸º"åªè¯» Runtime"æä¾›å•ç‹¬æ ‡è®°ï¼Ÿ
- [ ] `ModuleRuntime.fromAdapter` åº”æ”¾åœ¨å“ªä¸ªåŒ…ï¼Ÿ
  - `@logix/core`
  - `@logix/runtime-ext`
- [ ] æ˜¯å¦éœ€è¦åœ¨ Intent/Universe è§†è§’æ ‡è®°"éæ ‡å‡† Runtime"ï¼Ÿ

---

## ä¸ƒã€ç›¸å…³æ–‡æ¡£

- [runtime-logix/core/05-runtime-implementation.md](../../runtime-logix/core/05-runtime-implementation.md)
- [runtime-logix/core/07-react-integration.md](../../runtime-logix/core/07-react-integration.md)
- [runtime-logix/core/09-debugging.md](../../runtime-logix/core/09-debugging.md)

---

**ç‰ˆæœ¬å†å²**:

- v0.2.0 (2025-12-02): åˆå¹¶ä¸‰ç¯‡ L9 è‰ç¨¿ï¼Œå½¢æˆç»Ÿä¸€æ¼”è¿›è·¯çº¿å›¾
- v0.1.0 (2025-11-30): å„å•ç¯‡è‰ç¨¿ç‹¬ç«‹ç‰ˆæœ¬
</file>

<file path="drafts/L9/builder-studio-roadmap-alignment.md">
---
title: Builder & Studio Roadmap Alignment
status: draft
version: 0.1.0
value: vision
priority: 200
related:
  - ../intent-driven-ai-coding/v3/roadmap-logix-platform.md
  - ../runtime-logix/core/README.md
  - ../drafts/topics/platform-vision/00-generative-language-server.md
---

# Builder & Studio Roadmap Alignment

> æ ¸å¿ƒæƒ³æ³•ï¼šåœ¨ `implementation-status.md` ä¸­ç»™ Builder/@logix/builder ä¸€æ®µâ€œå¯æ‰§è¡Œçš„å°è·¯çº¿å›¾â€ï¼ŒæŠŠ Generative Language Server / Spec Studio / Platform Vision ä¸­çš„è¿œæ™¯æ‹†æˆ 2â€“3 ä¸ªè¿‘æœŸå¯è½åœ°çš„èƒ½åŠ›ã€‚

## 1. ç°çŠ¶

- `implementation-status.md` ä¸­å°† Builder æ ‡è®°ä¸º ğŸ›‘ Not Startedï¼›
- `platform-vision` / `spec-studio` Topic ä¸­å·²ç»æœ‰å¤§é‡å…³äºç»ˆå±€å½¢æ€çš„è®¨è®ºï¼Œä½†ç¼ºå°‘ä¸å½“å‰å®ç°çŠ¶æ€çš„å¯¹é½ã€‚

## 2. è‰æ¡ˆå»ºè®®

- åœ¨å®ç°çŠ¶æ€æ–‡æ¡£ä¸­å¢åŠ ä¸€èŠ‚ â€œBuilder & Studio Roadmapâ€ï¼Œå»ºè®®åŒ…å«ï¼š
  - **Rule-level èƒ½åŠ›**ï¼šè§£æå•æ¡ Fluent è§„åˆ™ä¸º IntentRuleï¼Œæ”¯æŒè¯»æ‡‚/æ”¹å†™/å›æ”¾ï¼›
  - **Use-case-level èƒ½åŠ›**ï¼šä» Use Case Blueprint â†’ IntentRule é›† â†’ Logic æ¨¡æ¿çš„æœ€å°é“¾è·¯ï¼›
  - **å¯è§†åŒ–åŸºç¡€è®¾æ–½**ï¼šåŸºäº Execution Trace æˆ– IntentRule æ‹“æ‰‘çš„ç®€å•å›¾è§†å›¾ï¼ˆä¸åšå®Œæ•´ Studioï¼‰ã€‚

## 3. åç»­æ•´åˆ

- å¾…è¿™äº›èƒ½åŠ›ä¸­ä»»ä¸€é¡¹å¼€å§‹å®ç°æ—¶ï¼š
  - åœ¨ç›¸å…³ Topic ä¸­æ ‡æ³¨ `status: active` æˆ– `merged`ï¼›
  - åœ¨ `implementation-status.md` å¯¹åº”æ¡ç›®ä¸‹å¢åŠ é“¾æ¥ï¼Œä½œä¸º SSoT çš„ä¸€éƒ¨åˆ†ã€‚
</file>

<file path="drafts/L9/dynamic-list-form-pattern.md">
---
title: Logix å¯¹å¤æ‚åŠ¨æ€åˆ—è¡¨è¡¨å• (Array List) çš„æ”¯æ’‘æ–¹æ¡ˆ
status: draft
version: 2025-12-02T00:00:00.000Z
priority: 100
---

# Logix å¯¹å¤æ‚åŠ¨æ€åˆ—è¡¨è¡¨å• (Array List) çš„æ”¯æ’‘æ–¹æ¡ˆ

## 1. åœºæ™¯ä¸éœ€æ±‚

é’ˆå¯¹ç”¨æˆ·æå‡ºçš„â€œæ•™è‚²ç»å†â€ã€â€œå…¶ä»–è¯ä¹¦â€ç­‰åœºæ™¯ï¼Œæ ¸å¿ƒéœ€æ±‚åŒ…æ‹¬ï¼š

1.  **åŠ¨æ€åˆ—è¡¨ (Dynamic List)**: ç±»ä¼¼ `useFieldArray`ï¼Œæ”¯æŒå¢åˆ æ”¹æŸ¥ã€‚
2.  **å­—æ®µè”åŠ¨ (Field Linkage)**: åˆ—è¡¨é¡¹å†…éƒ¨å­—æ®µè”åŠ¨ï¼ˆå¦‚ï¼šå­¦å† -> ä¸“ä¸šæ˜¯å¦å¿…å¡«ï¼‰ã€‚
3.  **å¼‚æ­¥æ“ä½œ (Async)**: åˆ—è¡¨é¡¹å†…çš„æ–‡ä»¶ä¸Šä¼ ã€å¼‚æ­¥æ ¡éªŒã€‚
4.  **å¤æ‚æ ¡éªŒ (Validation)**: é’ˆå¯¹åˆ—è¡¨æ•´ä½“æˆ–å•é¡¹çš„æ ¡éªŒè§„åˆ™ã€‚

## 2. æ ¸å¿ƒè®¾è®¡èŒƒå¼

Logix é€šè¿‡ `Schema.Array` é…åˆ `Module.logic` å®Œç¾æ”¯æŒæ­¤ç±»åœºæ™¯ã€‚ä¸ RHF `useFieldArray` ä¸åŒï¼ŒLogix å°†çŠ¶æ€ç®¡ç†ä¸‹æ²‰åˆ° Module å±‚ï¼ŒUI å±‚åªéœ€æ¶ˆè´¹æ•°æ®ã€‚

### 2.1 å®šä¹‰ Schema (State Shape)

ä½¿ç”¨ `Schema.Array` å®šä¹‰åˆ—è¡¨ç»“æ„ã€‚

```typescript
// 1. å®šä¹‰å•é¡¹ Schema
const EducationItemSchema = Schema.Struct({
  id: Schema.String, // å”¯ä¸€æ ‡è¯†ï¼Œç”¨äº Key
  degree: Schema.String, // å­¦å†
  schoolName: Schema.String, // é™¢æ ¡åç§°
  startDate: Schema.String, // å…¥å­¦æ—¶é—´
  endDate: Schema.String, // æ¯•ä¸šæ—¶é—´
  major: Schema.String, // ä¸“ä¸š
  isFullTime: Schema.Boolean, // æ˜¯å¦å…¨æ—¥åˆ¶
  certificate: Schema.optional(Schema.String), // æ¯•ä¸šè¯ (URL æˆ– ID)

  // UI è¾…åŠ©çŠ¶æ€ (å¯é€‰ï¼Œä¹Ÿå¯ä»¥åˆ†ç¦»)
  uploading: Schema.Boolean,
})

// 2. å®šä¹‰æ¨¡å— Stateï¼ˆåªæè¿°æ•°æ®å½¢çŠ¶ï¼Œä¸ç›´æ¥å†…åµŒ Reactive é€»è¾‘ï¼‰
const ResumeStateSchema = Schema.Struct({
  userId: Schema.String,
  educationList: Schema.Array(EducationItemSchema),
  certificateList: Schema.Array(CertificateItemSchema),

  // æ´¾ç”Ÿå­—æ®µï¼šæ˜¯å¦åŒ…å«â€œåšå£«â€å­¦å† (ç”¨äºå¤–éƒ¨è”åŠ¨)
  // è¿™é‡Œä»…å£°æ˜å½¢çŠ¶ï¼Œå…·ä½“è®¡ç®—é€»è¾‘æ”¾åœ¨ Module.reactive ä¸­
  hasPhD: Schema.Boolean,
})

export const ResumeModule = Logix.Module('Resume', {
  state: ResumeStateSchema,
  actions: {
    'edu/add': Schema.Void,
    'edu/remove': Schema.String, // ID
    'edu/update': Schema.Struct({ id: Schema.String, patch: Schema.Partial(EducationItemSchema) }),
    'edu/uploadCert': Schema.Struct({ id: Schema.String, file: Schema.Any }) // è§¦å‘ä¸Šä¼ 
  },

  // 3. åœ¨ Module.reactive ä¸­é›†ä¸­å£°æ˜æ´¾ç”Ÿé€»è¾‘
  reactive: {
    hasPhD: Reactive.computed((s) =>
      s.educationList.some((item) => item.degree === 'PhD'),
    ),
  },
})
```

### 2.2 åˆ—è¡¨æ“ä½œ (List Actions)

é€šè¿‡ Logic å¤„ç†å¢åˆ æ”¹é€»è¾‘ã€‚

```typescript
const EducationListLogic = ResumeModule.logic(($) =>
  Effect.gen(function* () {
    // æ–°å¢
    yield* $.onAction('edu/add').run(() =>
      $.state.update(s => ({
        ...s,
        educationList: [
          ...s.educationList,
          { id: nanoid(), degree: '', schoolName: '', ... } // åˆå§‹å€¼
        ]
      }))
    )

    // åˆ é™¤
    yield* $.onAction('edu/remove').run((id) =>
      $.state.update(s => ({
        ...s,
        educationList: s.educationList.filter(item => item.id !== id)
      }))
    )

    // æ›´æ–° (é€šç”¨ Patch)
    yield* $.onAction('edu/update').run(({ id, patch }) =>
      $.state.update(s => ({
        ...s,
        educationList: s.educationList.map(item =>
          item.id === id ? { ...item, ...patch } : item
        )
      }))
    )
  })
)
```

### 2.3 å¼‚æ­¥ä¸Šä¼ ä¸è”åŠ¨ (Async & Linkage)

åœ¨åˆ—è¡¨é¡¹ä¸­å¤„ç†å¼‚æ­¥ä¸Šä¼ ï¼Œå¹¶å®ç°å­—æ®µè”åŠ¨ã€‚

```typescript
const EducationAsyncLogic = ResumeModule.logic(($) =>
  Effect.gen(function* () {
    // ç›‘å¬ä¸Šä¼ åŠ¨ä½œ
    yield* $.onAction('edu/uploadCert').run(function* ({ id, file }) {
      // 1. æ ‡è®°è¯¥é¡¹ä¸ºä¸Šä¼ ä¸­
      yield* $.state.update(s => ({
        ...s,
        educationList: s.educationList.map(item =>
          item.id === id ? { ...item, uploading: true } : item
        )
      }))

      // 2. æ‰§è¡Œä¸Šä¼  (Effect)
      const result = yield* UploadService.upload(file)

      // 3. å›å¡«ç»“æœ & å–æ¶ˆ Loading
      yield* $.state.update(s => ({
        ...s,
        educationList: s.educationList.map(item =>
          item.id === id ? { ...item, certificate: result.url, uploading: false } : item
        )
      }))
    })
  })
)
```

### 2.5 æ ‡å‡† Dynamic List Patternï¼šListLogic è‰æ¡ˆ

ä¸Šé¢çš„å¢åˆ æ”¹å®ç°æœ¬è´¨ä¸Šæ˜¯ã€Œåˆ—è¡¨æ ·æ¿ä»£ç ã€ï¼Œåœ¨ä¸åŒä¸šåŠ¡ä¸­é«˜åº¦ç›¸ä¼¼ã€‚å¯ä»¥é€šè¿‡ Pattern å½¢å¼æ²‰æ·€ä¸€ä¸ªé€šç”¨çš„ Dynamic List Logicï¼š

```ts
// è‰æ¡ˆ APIï¼šä¸ºæŒ‡å®šåˆ—è¡¨å­—æ®µç”Ÿæˆæ ‡å‡†å¢åˆ æ”¹ Logic
const EducationListLogic = Logix.Pattern.dynamicList({
  module: ResumeModule,
  // æŒ‡å®šåˆ—è¡¨åœ¨ State ä¸­çš„ä½ç½®
  path: (s: Schema.Type<typeof ResumeStateSchema>) => s.educationList,
  // ç”¨äºè¯†åˆ«åˆ—è¡¨é¡¹çš„ä¸»é”®å­—æ®µ
  key: (item: Schema.Type<typeof EducationItemSchema>) => item.id,
  // ç»‘å®šè¦ä½¿ç”¨çš„ Action åç§°ï¼ˆä¹Ÿå¯ç”± Pattern è‡ªåŠ¨ç”Ÿæˆï¼‰
  actions: {
    add: 'edu/add',
    remove: 'edu/remove',
    patch: 'edu/update',
  },
  // åˆ—è¡¨é¡¹çš„åˆå§‹å€¼å·¥å‚ï¼ˆå¯ä»¥ä¾èµ–å½“å‰å…¨å±€ stateï¼‰
  makeInitialItem: (state) => ({
    id: nanoid(),
    degree: '',
    schoolName: '',
    startDate: '',
    endDate: '',
    major: '',
    isFullTime: false,
    uploading: false,
  }),
})
```

å®ç°å±‚é¢ï¼Œ`Logix.Pattern.dynamicList` åªæ˜¯å¯¹ Fluent DSL çš„å°è£…ï¼š

- `add`ï¼šåœ¨å†…éƒ¨å±•å¼€ä¸º `$.onAction('edu/add').update(...)`ï¼›
- `remove`ï¼šå±•å¼€ä¸º `$.onAction('edu/remove').update(...)`ï¼›
- `patch`ï¼šå±•å¼€ä¸º `$.onAction('edu/update').update(...)`ã€‚

è¿™æ · Dynamic List çš„ã€Œå¥—è·¯ã€å°±ä»ä¸šåŠ¡æ¨¡å—ä¸­å‰¥ç¦»å‡ºæ¥ï¼ŒLogix åªéœ€è¦åœ¨ Pattern å±‚æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£ï¼Œåº•å±‚ä»ç„¶å®Œå…¨åŸºäºå½“å‰å·²ç»æ ‡å‡†åŒ–çš„ Fluent DSL å’Œ State Update è¯­ä¹‰ã€‚

### 2.4 å¤æ‚æ ¡éªŒ (Validation)

æ ¡éªŒé€»è¾‘å¯ä»¥éå†æ•°ç»„ï¼Œç”Ÿæˆé’ˆå¯¹æ¯ä¸€é¡¹çš„é”™è¯¯ä¿¡æ¯ã€‚

```typescript
const ValidateEducationLogic = ResumeModule.logic(($) =>
  Effect.gen(function* () {
    const { educationList } = yield* $.state.read
    const errors = []

    educationList.forEach((item, index) => {
      // è§„åˆ™ 1: æ¯•ä¸šæ—¶é—´å¿…é¡»æ™šäºå…¥å­¦æ—¶é—´
      if (dayjs(item.endDate).isBefore(item.startDate)) {
        errors.push({ path: `educationList.${index}.endDate`, message: 'æ¯•ä¸šæ—¶é—´ä¸èƒ½æ—©äºå…¥å­¦æ—¶é—´' })
      }

      // è§„åˆ™ 2: è”åŠ¨æ ¡éªŒ - å¦‚æœæ˜¯å…¨æ—¥åˆ¶ï¼Œå¿…é¡»ä¸Šä¼ è¯ä¹¦
      if (item.isFullTime && !item.certificate) {
        errors.push({ path: `educationList.${index}.certificate`, message: 'å…¨æ—¥åˆ¶å¿…é¡»ä¸Šä¼ è¯ä¹¦' })
      }
    })

    if (errors.length > 0) {
      yield* $.lifecycle.notifyError({ type: 'Validation', errors })
      return false
    }
    return true
  })
)
```

## 3. UI é›†æˆ (React)

åœ¨ React ä¸­æ¸²æŸ“åˆ—è¡¨ï¼Œä½¿ç”¨ `map` éå†ã€‚

```tsx
const EducationSection = () => {
  const { state, actions } = useModule(ResumeImpl)

  return (
    <div>
      {state.educationList.map((item) => (
        <div key={item.id} className="card">
          {/* å­—æ®µç»‘å®š */}
          <Select
            value={item.degree}
            onChange={val => actions['edu/update']({ id: item.id, patch: { degree: val } })}
          />

          {/* è”åŠ¨å±•ç¤ºï¼šå…¨æ—¥åˆ¶æ‰æ˜¾ç¤ºè¯ä¹¦ä¸Šä¼  */}
          {item.isFullTime && (
            <Upload
              loading={item.uploading}
              onFile={file => actions['edu/uploadCert']({ id: item.id, file })}
            />
          )}

          <Button onClick={() => actions['edu/remove'](item.id)}>åˆ é™¤</Button>
        </div>
      ))}

      <Button onClick={() => actions['edu/add']()}>æ·»åŠ æ•™è‚²ç»å†</Button>
    </div>
  )
}
```

## 4. æ€»ç»“

Logix å®Œå…¨èƒ½å¤Ÿæ‰¿è½½ `useFieldArray` åœºæ™¯ï¼Œä¸”å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1.  **é€»è¾‘è§£è€¦**: ä¸Šä¼ ã€æ ¡éªŒã€è”åŠ¨é€»è¾‘éƒ½åœ¨ Module ä¸­ï¼ŒUI æå…¶è½»é‡ã€‚
2.  **ç»†ç²’åº¦æ›´æ–°**: é…åˆ React Compiler æˆ–ç»†ç²’åº¦ Selectorï¼Œåˆ—è¡¨æ›´æ–°æ€§èƒ½ä¼˜å¼‚ã€‚
3.  **å¯æµ‹è¯•æ€§**: å¯ä»¥åœ¨ä¸æŒ‚è½½ React ç»„ä»¶çš„æƒ…å†µä¸‹ï¼Œç›´æ¥æµ‹è¯• `edu/add`ã€`edu/uploadCert` çš„é€»è¾‘ã€‚
</file>

<file path="drafts/L9/form-session-draft-pattern-convergence.md">
---
title: 'Form Session: Draft Pattern ä¸è¡¨å•å¼•æ“çš„äº¤æ±‡ç‚¹'
status: draft
version: 0.1.0
value: extension
priority: 300
related:
  - ../topics/draft-pattern/00-design.md
  - ../topics/draft-pattern/20-boundary-analysis.md
  - ../runtime-logix/form/poc/README.md
---

# Form Session: Draft Pattern ä¸è¡¨å•å¼•æ“çš„äº¤æ±‡ç‚¹

> æ ¸å¿ƒæƒ³æ³•ï¼šä¸æŠŠ Draft Pattern åšæˆå…¨å±€ Runtime èƒ½åŠ›ï¼Œè€Œæ˜¯å…ˆåœ¨ `@logix/form` ä¸­ä»¥ `FormSession` / `WizardSession` å½¢æ€è½åœ° 80% äº‹åŠ¡ç‰¹æ€§ã€‚

## 1. é—®é¢˜é‡è¿°

- Draft Pattern è‰æ¡ˆè¯•å›¾æ„å»ºä¸€ä¸ªé€šç”¨çš„ã€Œäº¤äº’äº‹åŠ¡ã€è¿è¡Œæ—¶ï¼Œè¦†ç›–å„ç§ç¬æ—¶äº¤äº’ï¼›
- å®é™… ToB è½åœ°é‡Œï¼Œæœ€åˆšéœ€çš„åœºæ™¯å‡ ä¹éƒ½é›†ä¸­åœ¨è¡¨å•/å‘å¯¼ï¼ˆåŒ…æ‹¬å¤æ‚åŠ¨æ€åˆ—è¡¨ã€çŸ©é˜µç¼–è¾‘ç­‰ï¼‰ï¼›
- ç›´æ¥å®ç°é€šç”¨ Draft Runtime æˆæœ¬è¾ƒé«˜ä¸”è¾¹ç•Œå¤æ‚ã€‚

## 2. ä¼šåˆç‚¹è®¾è®¡

- åœ¨ `@logix/form` ä¸­å®šä¹‰ï¼š
  - `FormSession`ï¼šé’ˆå¯¹å•è¡¨å•çš„äº¤äº’äº‹åŠ¡å°è£…ï¼Œæ”¯æŒ rollback/commitã€ä¿ç•™ä¸´æ—¶çŠ¶æ€ï¼›
  - `WizardSession`ï¼šé’ˆå¯¹å¤šæ­¥å‘å¯¼çš„é•¿äº‹åŠ¡å°è£…ï¼›
- å†…éƒ¨å¯ä»¥å€Ÿç”¨ Draft Pattern è‰æ¡ˆä¸­çš„äº‹åŠ¡è¯­ä¹‰ï¼ˆAtomicity/Isolationï¼‰ï¼Œä½†å¯¹å¤–åªæš´éœ² Form è¯­ä¹‰ï¼›
- React Adapter å±‚åªæä¾› `useFormSession` ç­‰ Hookï¼Œä¸ç›´æ¥å¼•å…¥ `useDraft`ï¼Œé¿å…é€‚é…å±‚æ‰¿è½½é¢†åŸŸæ¦‚å¿µã€‚

## 3. åç»­åŠ¨ä½œï¼ˆä¾›æœªæ¥æ•´åˆç”¨ï¼‰

- åœ¨ runtime-logix/form è§„èŒƒä¸­åŠ å…¥ä¸€èŠ‚ã€ŒForm Session & Draft Patternã€ï¼Œæ˜ç¡®ï¼š
  - Form Session æ˜¯ Draft Pattern åœ¨è¡¨å•é¢†åŸŸçš„å…·ä½“åŒ–ï¼›
  - Draft Pattern çš„é€šç”¨å½¢æ€æ˜¯å¦éœ€è¦ã€ä½•æ—¶éœ€è¦ç”±åç»­æ¼”è¿›å†³å®šã€‚
</file>

<file path="drafts/L9/logic-for-shape-env-first-roadmap.md">
---
title: Logic.forShape Env-First è·¯çº¿è‰ç¨¿
status: superseded
version: 0.1.0
superseded_by: ../L5/dsl-evolution-roadmap.md
priority: 400
---

# Logic.forShape Â· Env-First å½¢æ€è·¯çº¿è‰ç¨¿

> å±‚çº§ï¼šL9ï¼ˆç”Ÿè‰ç¨¿ï¼Œå°šæœªä¸ç°æœ‰è§„èŒƒå……åˆ†å¯¹é½ï¼‰
> å…³è”è§„èŒƒï¼š
> - `docs/specs/runtime-logix/core/01-architecture.md`
> - `docs/specs/runtime-logix/core/02-module-and-logic-api.md`
> - `docs/specs/runtime-logix/core/03-logic-and-flow.md`

## 1. èƒŒæ™¯ä¸åŠ¨æœº

å½“å‰ v3 PoC ä¸­ï¼ŒBound API `$` çš„**å”¯ä¸€æ­£å¼å…¥å£**æ˜¯ï¼š

- `Logix.Module('Id', { state, actions })` å®šä¹‰æ¨¡å—ï¼›
- `Module.logic(($)=>Effect.gen(...))` ä¸ºæ¨¡å—æŒ‚è½½ Logicï¼Œå¹¶åœ¨å›è°ƒå‚æ•°ä¸­æ³¨å…¥åŸºäº Runtime çš„ Bound API `$`ï¼›
- Pattern / Namespace ç­‰äºŒæ¬¡å°è£…åœºæ™¯é€šè¿‡ `( $: Logix.BoundApi<Sh,R> ) => Logic.Of<Sh,R,...>` å½¢å¼å¤ç”¨é€»è¾‘ã€‚

`Logic.forShape` åœ¨æ–‡æ¡£ä¸­è¢«ä¿ç•™ä¸ºä¸€ç§â€œEnv-First å½¢æ€â€çš„è‰å›¾ï¼š
ç†æƒ³çŠ¶æ€ä¸‹ï¼ŒLogic å¯ä»¥åªä¾èµ– `Logic.Env<Sh,R>` + `Logic.RuntimeTag`ï¼Œä¸ç›´æ¥æ„ŸçŸ¥å…·ä½“ Module å®ä¾‹æˆ– Runtime æ„é€ è·¯å¾„ã€‚

æœ¬è‰ç¨¿åªè®¨è®º **æ˜¯å¦ä»¥åŠå¦‚ä½•åœ¨æœªæ¥å¼•å…¥çœŸæ­£çš„ Env-First `Logic.forShape`**ï¼Œä¸ä¼šå½±å“å½“å‰ PoC çš„æ­£å¼ç”¨æ³•ã€‚

## 2. å½“å‰å…±è¯†ï¼ˆv3 PoC é˜¶æ®µï¼‰

ä»ä»£ç ä¸è§„èŒƒè°ƒæ•´åå¾—åˆ°çš„ä¸´æ—¶å…±è¯†ï¼š

- å¯¹äº**ä¸šåŠ¡ä»£ç **ï¼š
  - è®°ä½ä¸€ä¸ªå…¥å£å³å¯ï¼š`SomeModule.logic(($)=>Effect.gen(...))`ï¼›
  - `$` çš„è¯­ä¹‰ç”± `BoundApi` å®šä¹‰ï¼ŒåŒ…å« `state / actions / flow / match / use / lifecycle / onState / onAction / on` ç­‰å­åŸŸï¼›
  - æ–‡æ¡£ä¸­çš„ `Logic.forShape` è®°å·ä»…ä½œä¸ºâ€œé’ˆå¯¹æŸä¸ª Shape/Env çš„ `$` ç¼©å†™â€ï¼Œä¸å¯¹åº”å®é™…å®ç°ã€‚

- å¯¹äº **Pattern / åº“ä½œè€…**ï¼š
  - æ¨èä½¿ç”¨ `( $: Logix.BoundApi<Sh,R> ) => Logic.Of<Sh,R,...>` ä½œä¸º Pattern å½¢æ€ï¼›
  - è°ƒç”¨æ–¹é€šè¿‡ `Module.logic(($)=>pattern($))` è´Ÿè´£ç»‘å®š Module ä¸ Envï¼›
  - Pattern ä¸ç›´æ¥ä¾èµ– `Logic.RuntimeTag` / `ModuleRuntime`ï¼Œä¿æŒ `(input)=>Effect` å¿ƒæ™ºã€‚

- å¯¹äº **å¹³å° / å›¾è°± / LLM**ï¼š
  - ä»¥ `Module.logic(($)=>...)` ä½œä¸ºâ€œLogic ä¸ Module ç»‘å®šâ€çš„é™æ€é”šç‚¹ï¼Œåˆ©äºæ„å»º Logic Graph ä¸ Intent â†’ Code æ˜ å°„ï¼›
  - ç¤ºä¾‹ä¸­å‡ºç°çš„ `Logic.forShape` åªä½œä¸ºæ¦‚å¿µæ€§è¯­æ³•ç³–ï¼Œä¸å¢åŠ æ–°çš„å›¾è°±èŠ‚ç‚¹ç±»å‹ã€‚

## 3. Env-First `Logic.forShape` çš„æ½œåœ¨å½¢æ€ï¼ˆè®¾æƒ³ï¼‰

è‹¥æœªæ¥éœ€è¦çœŸæ­£å®ç° `Logic.forShape`ï¼Œä¸€ä¸ªå¯èƒ½çš„æ–¹å‘ï¼ˆå°šæœªå®šç¨¿ï¼‰ï¼š

1. **Env è¯­ä¹‰æ”¶ç´§**
   - çº¦å®š `Logic.Env<Sh,R> = Logix.ModuleTag<Sh> | Logic.Platform | R`ï¼›
   - åœ¨ `Module.live(initial, ...logics)` å†…éƒ¨ï¼Œé€šè¿‡ `Effect.provideService(Logic.RuntimeTag, runtime)` æˆ–ç­‰ä»·æ–¹å¼ï¼Œå°†å½“å‰æ¨¡å— Runtime æ³¨å…¥ Envã€‚

2. **BoundApi/Flow Env-First å˜ä½“**
   - åœ¨ `BoundApi` / `Flow` å†…éƒ¨ï¼Œå¼•å…¥â€œåŸºäº `Logic.RuntimeTag` å– Runtimeâ€ç‰ˆæœ¬ï¼š
     - `BoundApi.forShape<Sh,R>()` / `Flow.forShape<Sh,R>()`ï¼ˆå‘½åæœªå®šï¼Œä»…ä½œä¸ºè‰å›¾ï¼‰ï¼›
     - å®ç°ä¸Šä» `Logic.Env<Sh,R>` ä¸­è§£æå½“å‰ `ModuleRuntime<StateOf<Sh>, ActionOf<Sh>>`ã€‚

3. **Logic.forShape ä½œä¸ºå·¥å‚**
   - åœ¨ `Logic` å‘½åç©ºé—´ä¸­æä¾›ï¼š
     - `Logic.forShape<Sh,R>(): BoundApi<Sh,R>`ï¼›
   - è¦æ±‚è°ƒç”¨ç‚¹è¿è¡Œåœ¨ `Logic.Env<Sh,R>` ä¸Šï¼Œå¦åˆ™åœ¨è¿è¡Œæ—¶ fail/dieï¼›
   - æ–‡æ¡£ä¸­ç°æœ‰ç¤ºä¾‹ `const $ = Logic.forShape<Shape, Env>()` å¯ä»¥ä»â€œæ¦‚å¿µç¼©å†™â€å‡çº§ä¸ºå¯è¿è¡Œå†™æ³•ã€‚

4. **ä¸ Module.logic çš„å…³ç³»**
   - ä¸šåŠ¡å±‚ç»§ç»­æ¨èä½¿ç”¨ `Module.logic(($)=>...)` ä½œä¸ºå…¥å£ï¼›
   - `Logic.forShape` æ›´å¤šæœåŠ¡äºï¼š
     - Pattern / Namespace å†…éƒ¨æå‰â€œç»‘å½¢çŠ¶ï¼Œä¸ç»‘å…·ä½“ Moduleâ€ï¼›
     - æç«¯æ‹†åˆ†åœºæ™¯ä¸‹ï¼Œåœ¨å¤šä¸ªæ–‡ä»¶ä¸­å…±äº«ç›¸åŒ `Shape` çš„ `$` çº¦æŸã€‚

## 4. ä¸ç°æœ‰ API çš„è¾¹ç•Œå…³ç³»

éœ€è¦æ˜ç¡®çš„è¾¹ç•Œï¼ˆå¼€æ”¾é—®é¢˜ï¼‰ï¼š

- Env-First ä¸ Runtime-First ä¸¤æ¡è·¯å¾„æ˜¯å¦éœ€è¦åœ¨å®ç°ä¸Šåˆå¹¶ä¸ºä¸€å¥—ï¼Ÿ
  - ä¸€ç§å¯èƒ½ï¼š`Module.logic(($)=>...)` å†…éƒ¨æœ¬èº«å°±è¿è¡Œåœ¨ `Logic.Env<Sh,R>` ä¸Šï¼Œ`$` çš„å®ç°æ—¢å¯ä»¥é—­åŒ… Runtimeï¼Œä¹Ÿå¯ä»¥åœ¨éœ€è¦æ—¶ fallback åˆ° `Logic.RuntimeTag`ã€‚
- Pattern æ˜¯å¦ä»ç„¶é¦–é€‰ `( $: BoundApi<Sh,R> ) => Logic.Of<Sh,R,...>` å½¢æ€ï¼Ÿ
  - å€¾å‘ä¿æŒä¸å˜ï¼šPattern æŒç»­ä¾èµ– `$`ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¾èµ– `Logic.forShape`ã€‚

è¿™äº›é—®é¢˜éœ€è¦åœ¨æœªæ¥çš„ L6/L5 è‰ç¨¿ä¸­ç»“åˆæ›´å¤šä½¿ç”¨åœºæ™¯ï¼ˆFormã€åˆ—è¡¨ã€è·¨ Module åä½œï¼‰å…·ä½“æ¨æ¼”ã€‚

## 5. å¾…å†³é—®é¢˜ / ä¸‹ä¸€æ­¥æ¢³ç†æ–¹å‘

- [ ] æ˜¯å¦å­˜åœ¨â€œ**åªæœ‰ Env-First forShape æ‰èƒ½ä¼˜é›…è§£å†³**â€çš„çœŸå®åœºæ™¯ï¼Ÿéœ€è¦ä»ç°æœ‰ PoCï¼ˆForm / Matrix / Flow Orchestration ç­‰ï¼‰ä¸­åå‘æŒ–æ˜ã€‚
- [ ] è‹¥å®ç° Env-First forShapeï¼Œæ˜¯å¦éœ€è¦å¯¹ `Flow.Api` / `BoundApi` åšç»Ÿä¸€æŠ½è±¡ï¼Œé¿å…åŒè½¨å®ç°ï¼Ÿ
- [ ] ä¸å¹³å°é™æ€åˆ†æã€Intent IR çš„å…³ç³»ï¼šforShape æ˜¯å¦ä¼šå¹²æ‰°â€œä»¥ Module ä¸ºé”šç‚¹æ„å›¾â€çš„æ¨¡å‹ï¼Ÿ
- [ ] å‘½åä¸å­¦ä¹ æˆæœ¬ï¼šæ˜¯å¦æœ‰æ¯” `forShape` æ›´ç›´è§‚çš„åå­—ï¼ˆä¾‹å¦‚ `Logic.env<Sh,R>()` æˆ– `Logic.$<Sh,R>()`ï¼‰ï¼Ÿ

æœ¬è‰ç¨¿å½“å‰åªè´Ÿè´£â€œæŠŠé—®é¢˜æŒ‚èµ·æ¥â€ï¼Œä¸åšç»“è®ºã€‚åç»­è‹¥å½¢æˆæ›´æ¸…æ™°çš„è·¯çº¿ï¼Œåº”åœ¨ L6/L5 å±‚çº§äº§å‡ºæ›´å®Œæ•´çš„è®¾è®¡ç¨¿ï¼Œå¹¶åŒæ­¥è°ƒæ•´ï¼š

- `runtime-logix/core/01-architecture.md`
- `runtime-logix/core/02-module-and-logic-api.md`
- `runtime-logix/core/03-logic-and-flow.md`
</file>

<file path="drafts/L9/logix-instrumentation-overhaul.md">
---
title: Logix è§‚æµ‹æ€§é‡æ„ï¼šä» `secure` åˆ° Effect-Native Supervisor
status: superseded
version: 0.1.0
superseded_by: ../L5/runtime-core-evolution.md
priority: 500
---

# Logix è§‚æµ‹æ€§é‡æ„ (Instrumentation Overhaul)

> **èƒŒæ™¯**ï¼šæœ¬è‰ç¨¿æå‡ºäº†ä¸€é¡¹â€œä¸è®¡æˆæœ¬â€çš„æ¶æ„æ¼”è¿›è§„åˆ’ï¼Œæ—¨åœ¨å°† Logix çš„è¿è¡Œæ—¶è§‚æµ‹æœºåˆ¶ä»å½“å‰ä¸´æ—¶çš„ `Logic.secure` åŒ…è£…å™¨ï¼Œè¿ç§»åˆ°å®Œå…¨åŸºäº Effect-Native çš„ Supervisor ç³»ç»Ÿã€‚

## 1. èƒŒæ™¯ä¸é—®é¢˜é™ˆè¿°

ç›®å‰ï¼Œ`Logic.secure` æ˜¯æˆ‘ä»¬ç”¨æ¥â€œåŒ…è£¹â€ä¸šåŠ¡é€»è¾‘ä»¥å®ç°æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆæ—¥å¿—ã€é”™è¯¯å¤„ç†ã€å…ƒæ•°æ®æ³¨å…¥ï¼‰çš„ä¸»è¦æœºåˆ¶ã€‚è™½ç„¶åœ¨ PoC é˜¶æ®µå®ƒå¾ˆå®ç”¨ï¼Œä½†å­˜åœ¨æ˜¾è‘—çš„æ¶æ„ç¼ºé™·ï¼š

1.  **è¯­ä¹‰æ­§ä¹‰**ï¼š`secure` è¿™ä¸ªåå­—æš—ç¤ºäº†å®‰å…¨/é‰´æƒï¼Œä½†å®é™…ä¸Šå®ƒåšçš„æ˜¯æ’æ¡©/AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ã€‚
2.  **æ‰‹åŠ¨ä¸”è„†å¼±**ï¼šå®ƒä¾èµ– DSL å±‚ï¼ˆ`LogicBuilder`ï¼‰æ˜¾å¼è°ƒç”¨ `secure`ã€‚å¦‚æœå¼€å‘è€…ç»•è¿‡ Builderï¼Œé€»è¾‘å°±ä¼šâ€œè£¸å¥”â€ï¼Œå¤±å»å¯è§‚æµ‹æ€§ã€‚
3.  **é Effect åŸç”Ÿ**ï¼šå®ƒé€šè¿‡å‡½æ•°å‚æ•°ä¼ é€’å…ƒæ•°æ®ï¼ˆ`LogicMeta`ï¼‰ï¼Œå¿½ç•¥äº† Effect å¼ºå¤§çš„åŸç”Ÿèƒ½åŠ›ï¼Œå¦‚ `FiberRef`ã€`Supervisor` å’Œ `Tracer`ã€‚
4.  **ä¸­é—´ä»¶åƒµåŒ–**ï¼šä¸­é—´ä»¶æ³¨å…¥ä¸è°ƒç”¨ç‚¹è€¦åˆï¼Œéš¾ä»¥è¿›è¡Œå…¨å±€é…ç½®æˆ–åŠ¨æ€æ³¨å…¥ã€‚

## 2. æ„¿æ™¯ï¼šâ€œå®Œç¾â€çš„è§‚æµ‹æ€§

åœ¨ä¸€ä¸ªæˆç†Ÿçš„ã€â€œä¸è®¡æˆæœ¬â€çš„æ¶æ„ä¸­ï¼Œè§‚æµ‹æ€§åº”è¯¥æ˜¯ **éšå½¢çš„ã€æ— å¤„ä¸åœ¨çš„ï¼Œä¸”åœ¨æœªå¯ç”¨æ—¶é›¶å¼€é”€çš„**ã€‚

### æ ¸å¿ƒåŸåˆ™

-   **é›¶ä¾µå…¥ (Zero-Touch)**ï¼šä¸šåŠ¡é€»è¾‘ï¼ˆFlowsï¼‰ä¸åº”æ„ŸçŸ¥è‡ªå·±è¢«ç›‘æ§ã€‚ä¸å†éœ€è¦ `secure(...)` åŒ…è£…å™¨ã€‚
-   **Supervisor é©±åŠ¨**ï¼šä½¿ç”¨ `Effect.Supervisor` è‡ªåŠ¨æ•è·å¹¶ç›‘æ§æ‰€æœ‰ Logic çš„æ‰§è¡Œç”Ÿå‘½å‘¨æœŸã€‚
-   **Trace ä¼˜å…ˆ**ï¼šæ‰€æœ‰å…ƒæ•°æ®ï¼ˆLogic Name, Store ID, Tagsï¼‰åº”é€šè¿‡ `FiberRef` ä¼ æ’­ï¼Œå¹¶ä¸ `Effect.Tracer` é›†æˆã€‚
-   **ç»“æ„åŒ–æ—¥å¿—**ï¼šä½¿ç”¨ `Effect.annotateLogs` è‡ªåŠ¨ä¸ºæ¯ä¸€è¡Œæ—¥å¿—é™„åŠ ä¸Šä¸‹æ–‡ã€‚

## 3. æ¶æ„æ–¹æ¡ˆ

### 3.1 é˜¶æ®µ 1ï¼šè¯­ä¹‰å¯¹é½ (The "Instrument" API)

ç«‹å³è¿›è¡Œé‡æ„ä»¥ä¿®æ­£è¯­ä¹‰ï¼Œå¹¶å¼•å…¥åŸºäº FiberRef çš„å…ƒæ•°æ®ä¼ é€’ã€‚

```typescript
// ä¹‹å‰
Logic.secure(effect, { name: "flow.run" })

// ä¹‹å
import { LogicContext } from "@logix/core/internal"

const instrument = (effect, meta) =>
  effect.pipe(
    // 1. æ³¨å…¥å…ƒæ•°æ®åˆ° FiberRef
    LogicContext.withMeta(meta),
    // 2. åŸç”Ÿ Tracing é›†æˆ
    Effect.withSpan(`Logix.${meta.name}`, { attributes: meta }),
    // 3. æ—¥å¿—æ³¨è§£
    Effect.annotateLogs({ logic_op: meta.name })
  )
```

### 3.2 é˜¶æ®µ 2ï¼šå¼•å…¥ `LogixSupervisor`

ç»ˆæç›®æ ‡æ˜¯å®Œå…¨ç§»é™¤åŒ…è£…å™¨ã€‚æˆ‘ä»¬åœ¨ `ModuleRuntime` å±‚é¢å¼•å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„ Supervisorã€‚

> **æ³¨æ„**ï¼šSupervisor ä»…è´Ÿè´£â€œè§‚æµ‹â€ï¼ˆLogging/Tracingï¼‰ã€‚å¯¹äºâ€œå¹²é¢„â€ï¼ˆå¦‚é”™è¯¯å…œåº•ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ DSL å±‚ä¿ç•™æ˜¾å¼çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œæˆ–é€šè¿‡ `Effect.catchAllCause` åœ¨åº•å±‚ç»Ÿä¸€æ‹¦æˆªã€‚

```typescript
// å®šä¹‰ Supervisor Layer
const LogixSupervisorLive = Layer.succeed(
  Supervisor.Tag,
  new LogixSupervisor({
    onStart: (context, fiber) => telemetry.trackStart(context),
    onEnd: (value, fiber) => telemetry.trackEnd(value)
  })
)

// åœ¨æ„å»º Runtime æ—¶æ³¨å…¥
// ModuleRuntime å†…éƒ¨ä¼šä½¿ç”¨è¯¥ Layer æ¥æ„å»º ManagedRuntime
const runtimeLayer = Layer.mergeAll(
  LogixSupervisorLive,
  LogicContextLive,
  // ... å…¶ä»–æœåŠ¡
)
```

### 3.3 é˜¶æ®µ 3ï¼šéšå¼ä¸Šä¸‹æ–‡ä¼ æ’­ä¸é”™è¯¯è¾¹ç•Œ

ä¸å†é€šè¿‡å‡½æ•°å‚æ•°å±‚å±‚ä¼ é€’ `LogicMeta`ï¼Œè€Œæ˜¯ä½¿ç”¨ `FiberRef`ã€‚åŒæ—¶ï¼Œå¿…é¡»è§£å†³ `FiberRef` åœ¨ `fork` æ—¶çš„ä¼ æ’­é—®é¢˜ï¼Œä»¥åŠ Supervisor æ— æ³•æ‹¦æˆªé”™è¯¯çš„å±€é™ã€‚

```typescript
// 1. ä¸Šä¸‹æ–‡å®šä¹‰
export const CurrentLogicMeta = FiberRef.unsafeMake<LogicMeta | null>(null)

// 2. DSL å±‚çš„éšå¼æ³¨å…¥ (LogicBuilder)
const runFlow = (flow, meta) =>
  flow.pipe(
    // å…³é”®ï¼šåœ¨ fork ä¹‹å‰è®¾ç½® Contextï¼Œç¡®ä¿å­ Fiber ç»§æ‰¿
    Effect.locally(CurrentLogicMeta, meta),
    // å…³é”®ï¼šæ˜¾å¼é”™è¯¯è¾¹ç•Œï¼Œå› ä¸º Supervisor æ— æ³•åæ‰é”™è¯¯
    Effect.catchAllCause(cause => handleLogicError(cause, meta)),
    Effect.fork
  )
```

## 4. è¿ç§»è·¯çº¿å›¾

### æ­¥éª¤ 1ï¼šé‡å‘½åä¸èŒè´£åˆ†ç¦» (v3.1)
-   é‡å‘½å `Logic.secure` -> `Logic.instrument`ã€‚
-   **å‰¥ç¦»é”™è¯¯å¤„ç†**ï¼šæ˜ç¡® `instrument` åªè´Ÿè´£è§‚æµ‹ã€‚å¦‚æœåŸ `secure` åŒ…å«é”™è¯¯å¤„ç†é€»è¾‘ï¼Œéœ€æ‹†åˆ†ä¸ºç‹¬ç«‹çš„ `Logic.catch` æˆ–ç§»å…¥ Flow å®šä¹‰ã€‚

### æ­¥éª¤ 2ï¼šå¼•å…¥ FiberRef ä¸Šä¸‹æ–‡ (v3.2)
-   åˆ›å»º `LogicContext` æœåŠ¡/FiberRefã€‚
-   éªŒè¯ `runLatest` / `runExhaust` ç­‰å¹¶å‘ç®—å­ä¸‹çš„ Context ä¼ æ’­æ­£ç¡®æ€§ï¼ˆSnapshot æœºåˆ¶éªŒè¯ï¼‰ã€‚

### æ­¥éª¤ 3ï¼šSupervisor å®ç° (v4.0)
-   å®ç° `LogixSupervisor` å¹¶é€šè¿‡ Layer æ³¨å…¥ã€‚
-   ç§»é™¤ DSL ä¸­çš„ `Logic.instrument`ï¼Œæ”¹ä¸ºè‡ªåŠ¨æ³¨å…¥ `LogicBoundaryTag` å’Œ `Effect.catchAllCause`ã€‚

## 5. æ”¶ç›Š

-   **å¼€å‘è€…ä½“éªŒ**ï¼šä¸å†éœ€è¦æ‹…å¿ƒâ€œæˆ‘è®°å¾—è°ƒç”¨ secure äº†å—ï¼Ÿâ€ã€‚
-   **å¯è§‚æµ‹æ€§**ï¼šä¸ Effect ç”Ÿæ€ç³»ç»Ÿï¼ˆOpenTelemetry, Console ç­‰ï¼‰æ·±åº¦é›†æˆã€‚
-   **ä»£ç æ•´æ´**ï¼šDSL ä»£ç å˜å›çº¯ç²¹çš„é€»è¾‘æ„å»ºï¼Œä¸è¿è¡Œæ—¶å…³æ³¨ç‚¹åˆ†ç¦»ã€‚

## 6. é£é™©ä¸ç¼“è§£ç­–ç•¥ (Risks & Mitigations)

### 6.1 æ€§èƒ½é£é™©ï¼šSupervisor å¼€é”€
*   **é£é™©åˆ†æ**ï¼š`Effect.Supervisor` ä¼šæ‹¦æˆª Fiber çš„ç”Ÿå‘½å‘¨æœŸã€‚
*   **ç¼“è§£ç­–ç•¥**ï¼š
    *   **é‡‡æ ·ä¸è¿‡æ»¤**ï¼šå¼•å…¥ `LogicBoundary` æ ‡è®°ï¼ŒSupervisor ä»…å¤„ç†å¸¦æœ‰è¯¥æ ‡è®°çš„ Fiberã€‚
    *   **å¼‚æ­¥å¤„ç†**ï¼š`onEnd` ä»…æ¨å…¥ Ring Bufferï¼Œåå°å¼‚æ­¥å¤„ç†ã€‚

### 6.2 è°ƒè¯•ä½“éªŒé£é™©ï¼šéšå¼é»‘ç›’
*   **é£é™©åˆ†æ**ï¼šè§‚æµ‹é€»è¾‘â€œéšå½¢â€ï¼Œè°ƒè¯•éš¾åº¦å¢åŠ ã€‚
*   **ç¼“è§£ç­–ç•¥**ï¼š
    *   **DevTools é…å¥—**ï¼š**å¿…é¡»**åœ¨ç§»é™¤æ˜¾å¼ API å‰æä¾›å¯è§†åŒ–å·¥å…·ã€‚
    *   **è°ƒè¯•æ¨¡å¼**ï¼šæä¾› `Logix.debug(true)` å¼€å…³ï¼Œè¾“å‡º Context ä¼ æ’­æ—¥å¿—ã€‚

### 6.3 å¹³å°ä¸åœºæ™¯å…¼å®¹æ€§é£é™© (Multi-Instance & SSR)
*   **é£é™©åˆ†æ**ï¼š
    *   **å¤šå®ä¾‹**ï¼šReact ä¸­å¯èƒ½å­˜åœ¨å¤šä¸ª Module å®ä¾‹ã€‚å…¨å±€ Supervisor å¯èƒ½å¯¼è‡´ Trace æ··æ·†ã€‚
    *   **SSR**ï¼šæœåŠ¡ç«¯æ¸²æŸ“æ—¶ Supervisor ä¼šè¢«è§¦å‘ï¼Œéœ€é¿å…æ•°æ®æ±¡æŸ“ã€‚
*   **ç¼“è§£ç­–ç•¥**ï¼š
    *   **å®ä¾‹çº§ Scope**ï¼šSupervisor ä¸åº”æ˜¯å…¨å±€å•ä¾‹ï¼Œè€Œåº”éš `ModuleRuntime` å®ä¾‹åŒ–ï¼Œæ¯ä¸ª Runtime æ‹¥æœ‰ç‹¬ç«‹çš„ Supervisor å®ä¾‹ã€‚
    *   **ç¯å¢ƒæ„ŸçŸ¥**ï¼šSupervisor å†…éƒ¨æ£€æµ‹ `typeof window`ï¼Œåœ¨ SSR ç¯å¢ƒä¸‹ä»…è®°å½•æ—¥å¿—ä¸ä¸Šä¼  Traceï¼Œæˆ–é™„åŠ  `server: true` æ ‡ç­¾ã€‚

### 6.4 è¾¹ç•Œç•Œå®šä¸é”™è¯¯è¯­ä¹‰é£é™©
*   **é£é™©åˆ†æ**ï¼šSupervisor æ— æ³•æ›¿ä»£ Middleware çš„â€œé”™è¯¯æ‹¦æˆªâ€èƒ½åŠ›ï¼›ä¸”éš¾ä»¥åŒºåˆ†ä¸šåŠ¡é€»è¾‘ä¸å†…éƒ¨å‡½æ•°ã€‚
*   **ç¼“è§£ç­–ç•¥**ï¼š
    *   **LogicBoundary æ ‡è®°**ï¼šDSL å±‚è‡ªåŠ¨æ³¨å…¥ `LogicBoundaryTag`ã€‚
    *   **æ˜¾å¼é”™è¯¯è¾¹ç•Œ**ï¼šåœ¨ DSL ç”Ÿæˆä»£ç æ—¶ï¼Œè‡ªåŠ¨åœ¨æœ€å¤–å±‚åŒ…è£¹ `Effect.catchAllCause`ï¼Œç¡®ä¿é”™è¯¯è¢«æ•è·å¹¶ä¸ŠæŠ¥ï¼Œè€Œä¸æ˜¯ä¾èµ– Supervisor åŠå…¶å‰¯ä½œç”¨ã€‚

### 6.5 è¿ç§»æˆæœ¬é£é™©
*   **é£é™©åˆ†æ**ï¼šæ€ç»´æ¨¡å¼å‰§å˜ï¼Œç”Ÿæ€åˆ†è£‚ã€‚
*   **ç¼“è§£ç­–ç•¥**ï¼š
    *   **åŒæ¨¡å…±å­˜**ï¼šv3.x åŒæ—¶æ”¯æŒæ˜¾å¼/éšå¼æ¨¡å¼ã€‚
    *   **Codemod å·¥å…·**ï¼šè‡ªåŠ¨åŒ–æ›¿æ¢è„šæœ¬ã€‚
</file>

<file path="drafts/L9/logix-reactive-module-integration.md">
---
title: 'Reactive Module: The Unified Data Paradigm'
status: merged
moved_to: ../topics/query-integration/04-reactive-paradigm.md
version: 1
layer: Core Concept
related:
  - logix-reactive-schema.md
  - logix-module-computed-query.md
  - logix-query-unified-api-design.md
priority: 600
---

# Reactive Module: The Unified Data Paradigm

> **æ ¸å¿ƒç›®æ ‡**ï¼šæ•´åˆ "Reactive Schema" çš„å£°æ˜å¼è¡¨è¾¾åŠ›ä¸ "Co-located Definition" çš„ç±»å‹å®‰å…¨æ€§ï¼Œæ„å»ºç»Ÿä¸€çš„å“åº”å¼æ•°æ®èŒƒå¼ã€‚

## 1. æ ¸å¿ƒç†å¿µ (Core Concept)

ç»è¿‡å¯¹ `Reactive Schema` (L9/logix-reactive-schema) å’Œ `Module Computed` (L9/logix-module-computed-query) çš„æ·±åº¦åˆ†æï¼Œæˆ‘ä»¬å¾—å‡ºç»“è®ºï¼š

**Schema åº”å½“çº¯ç²¹æè¿°æ•°æ®çš„"å½¢çŠ¶ (Shape)"ï¼Œè€Œ Module åº”å½“æè¿°æ•°æ®çš„"æ¥æº (Source)"ã€‚**

ä¸ºäº†è§£å†³ TypeScript çš„é€’å½’ç±»å‹éš¾é¢˜ (Recursive Type Hell)ï¼ŒåŒæ—¶ä¿æŒ "Schema-Driven" çš„å¼€å‘ä½“éªŒï¼Œæˆ‘ä»¬é‡‡ç”¨ **"Co-located Reactivity" (åŒä½å“åº”å¼)** æ¶æ„ï¼š

1.  **State Schema**: å®šä¹‰çº¯æ•°æ®ç»“æ„ (DTO)ã€‚
2.  **Reactive Definition**: åœ¨ Module å®šä¹‰ä¸­ï¼Œç´§é‚» State å®šä¹‰æ•°æ®çš„æ¥æºï¼ˆè®¡ç®—ã€å¼‚æ­¥ã€æµï¼‰ã€‚

è¿™ç§æ–¹å¼æ—¢ä¿ç•™äº†å£°æ˜å¼çš„ä¼˜é›…ï¼Œåˆè·å¾—äº†å®Œç¾çš„ç±»å‹æ¨å¯¼ã€‚

## 2. ç»Ÿä¸€ API è®¾è®¡ (Unified API)

æˆ‘ä»¬å°† `reactive` å®šä¹‰ä¸º **"Module å†…éƒ¨çš„è‡ªåŠ¨é©¾é©¶ä»ª"**ã€‚å®ƒä¸ä»…ä»…æ˜¯ Computed Fieldï¼Œè€Œæ˜¯é€šç”¨çš„å“åº”å¼æµå®šä¹‰ã€‚

å®ƒæ”¯æŒä¸¤ç§æ ¸å¿ƒæ¨¡å¼ï¼š
1.  **State => State (Derivation)**: æ´¾ç”Ÿæ•°æ®ï¼Œè‡ªåŠ¨å›å¡«åˆ° State å­—æ®µã€‚
2.  **State => Action (Effect)**: å‰¯ä½œç”¨ï¼Œå½“çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨è§¦å‘ Actionã€‚

```ts
// æ ¸å¿ƒåŒ…æä¾›é€šç”¨åŸè¯­
import { Logix, Schema, Reactive } from '@logix/core'
// æ‰©å±•åŒ…æä¾› TanStack Query é›†æˆ
import { Query } from '@logix/query'

// 1. å®šä¹‰çº¯æ•°æ®å½¢çŠ¶ (The Shape)
const UserState = Schema.Struct({
  userId: Schema.String,
  firstName: Schema.String,
  // å ä½å­—æ®µï¼Œç±»å‹ç”± Schema å†³å®š
  fullName: Schema.String,

  // å¼‚æ­¥æ•°æ®å®¹å™¨
  // ä½¿ç”¨ Schema.Loadable æ˜ç¡®å®ƒæ˜¯ä¸€ä¸ª Schema å®šä¹‰
  profile: Schema.Loadable(UserProfileSchema),

  // å®æ—¶çŠ¶æ€
  status: Schema.String
})

export const UserModule = Logix.Module('User', {
  // 2. ç»‘å®š Schema
  state: UserState,

  actions: {
    setUserId: Schema.String,
    trackUserView: Schema.String, // ç”¨äºåŸ‹ç‚¹çš„ Action
    showToast: Schema.String      // ç”¨äº UI åé¦ˆçš„ Action
  },

  // 3. å®šä¹‰å“åº”å¼æµ (The Reactive Flows)
  // ç»Ÿä¸€å…¥å£ï¼Œè‡ªåŠ¨è½¬åŒ–ä¸ºåº•å±‚çš„ $.flow
  reactive: {

    // [Mode 1] State => State (Derivation)
    // é”®åå¿…é¡»åŒ¹é… State ä¸­çš„å­—æ®µ
    // ------------------------------------------------

    // [Core] Sync Computed
    fullName: Reactive.computed((state) => `${state.firstName} ${state.lastName}`),

    // [Extension] Query (Async State)
    profile: Query.field({
      deps: (state) => [state.userId],
      loader: ([id]) => UserApi.fetchProfile(id)
    }),

    // [Mode 2] State => Action (Effect)
    // é”®åå¯ä»¥æ˜¯ä»»æ„æè¿°æ€§å­—ç¬¦ä¸² (ä¸è¦æ±‚æ˜¯ State å­—æ®µ)
    // ------------------------------------------------

    // [Core] Effect (å‰¯ä½œç”¨)
    // åœºæ™¯ï¼šå½“ userId å˜åŒ–ä¸”ä¸ä¸ºç©ºæ—¶ï¼Œè‡ªåŠ¨è§¦å‘åŸ‹ç‚¹ Action
    trackView: Reactive.effect({
      deps: (state) => [state.userId],
      // è¿™é‡Œçš„ dispatch æ˜¯ç±»å‹å®‰å…¨çš„
      effect: ([id], { actions }) => {
        if (id) return actions.trackUserView(id)
      }
    }),

    // [Core] Effect (å¤æ‚æµç¨‹)
    // åœºæ™¯ï¼šå½“ status å˜ä¸º 'error' æ—¶ï¼Œæ˜¾ç¤º Toast
    errorToast: Reactive.effect({
      deps: (state) => [state.profile.error],
      effect: ([error], { actions }) => {
        if (error) return actions.showToast(`Load failed: ${error}`)
      }
    })
  }
})

### 2.1 æ¶æ„åˆ†å±‚: Core vs Extension

ä¸ºäº†ä¿æŒæ ¸å¿ƒåŒ…çš„è½»é‡ä¸é€šç”¨ï¼Œæˆ‘ä»¬å°†èŒè´£è¿›è¡Œäº†æ˜ç¡®åˆ’åˆ†ï¼š

1.  **@logix/core (Reactive)**:
    *   æä¾› **é€šç”¨åŸºç¡€ç‰¹æ€§**ã€‚
    *   `Reactive.computed`: State => State (Sync)ã€‚
    *   `Reactive.async`: State => State (Async, SwitchMap)ã€‚
    *   `Reactive.stream`: State => State (Observable)ã€‚
    *   `Reactive.effect`: State => Action (Side Effect)ã€‚

2.  **@logix/query (Query)**:
    *   æä¾› **TanStack Query é›†æˆ**ã€‚
    *   `Query.field`: è¿™æ˜¯ä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ªç‰¹æ®Šçš„ `Reactive` é…ç½®ï¼ˆé€šå¸¸æ˜ å°„ä¸º `Reactive.stream`ï¼‰ã€‚
    *   å®ƒè´Ÿè´£åˆ›å»º `QueryObserver`ï¼Œç®¡ç†ç¼“å­˜ã€é‡è¯•ã€å»é‡ç­‰å¤æ‚ç­–ç•¥ã€‚

**å®ç°åŸç†**:

`Query.field` æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª "é…ç½®ç”Ÿæˆå™¨"ï¼š

```ts
// @logix/query å†…éƒ¨å®ç°ç¤ºæ„
export const field = (config) => {
  return Reactive.stream({
    deps: config.deps,
    // å°† QueryObserver å°è£…ä¸º Stream
    subscribe: (deps) => Stream.make((emit) => {
      const observer = new QueryObserver(client, { ...config, queryKey: deps })
      return observer.subscribe(emit)
    })
  })
}
```

è¿™ç§è®¾è®¡ä½¿å¾— Core ä¿æŒçº¯ç²¹ï¼Œè€Œé«˜çº§çš„æŸ¥è¯¢èƒ½åŠ›é€šè¿‡æ‰©å±•åŒ…æ— ç¼æ¥å…¥ã€‚

## 3. è§£å†³ç±»å‹å®‰å…¨éš¾é¢˜ (Solving Type Safety)

è¿™ç§è®¾è®¡çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äºå®ƒå¦‚ä½•ç»•è¿‡ TypeScript çš„é™åˆ¶ï¼š

### 3.1 åˆ†æ­¥æ¨å¯¼ (Two-Pass Inference)

1.  **Pass 1**: TypeScript é¦–å…ˆæ¨å¯¼ `state: UserState` çš„ç±»å‹ `S`ã€‚æ­¤æ—¶ `S` æ˜¯ä¸€ä¸ªçº¯ç²¹çš„ JSON å¯¹è±¡ç»“æ„ã€‚
2.  **Pass 2**: åœ¨ `reactive` å­—æ®µä¸­ï¼Œ`this` ä¸Šä¸‹æ–‡æˆ–æ³›å‹çº¦æŸå·²ç»çŸ¥é“äº† `S`ã€‚
    *   `Reactive.computed` çš„ç­¾åæ˜¯ `(state: S) => S[K]`ã€‚
    *   `Reactive.async` çš„ç­¾åè¦æ±‚ `S[K]` å¿…é¡»å…¼å®¹ `ResourceState<T>`ã€‚

### 3.2 æ¶ˆé™¤é€’å½’ (Eliminating Recursion)

åœ¨ "Reactive Schema" (æ—§æ–¹æ¡ˆ) ä¸­ï¼Œæˆ‘ä»¬åœ¨å®šä¹‰ `Schema` çš„è¿‡ç¨‹ä¸­è¯•å›¾å¼•ç”¨ `Schema` æ¨å¯¼å‡ºçš„ç±»å‹ï¼Œè¿™å¯¼è‡´äº†å¾ªç¯å¼•ç”¨ã€‚
åœ¨ "Reactive Module" (æ–°æ–¹æ¡ˆ) ä¸­ï¼ŒSchema å®šä¹‰å®Œæˆä¹‹åï¼Œæ‰åœ¨ Module Config ä¸­å¼•ç”¨å®ƒã€‚

## 4. å®ç°æ·±åº¦è§£æ (Implementation Deep Dive)

ä¸ºäº†å½»åº•ç†è§£è¿™ä¸€è®¾è®¡çš„ç²¾å¦™ä¹‹å¤„ï¼Œæˆ‘ä»¬éœ€è¦åŒºåˆ† **"èº«ä»½ (Identity)"** ä¸ **"é€»è¾‘ (Logic)"**ã€‚

### 4.1 æ ¸å¿ƒåŒºåˆ«ï¼šå…ƒä¿¡æ¯å­˜åœ¨å“ªé‡Œï¼Ÿ

**1. Schema Annotations (Identity)**
åªæœ‰ **`Schema.Loadable`** (åŸ Reactive.Resource) ä½¿ç”¨äº† Schema Annotationsã€‚

*   **ä½œç”¨**: æ ‡è®°æŸä¸ªå­—æ®µæ˜¯ "Loadable å®¹å™¨"ã€‚
*   **å®ç°**:
    ```ts
    // Schema.Loadable çš„ä¼ªä»£ç 
    // å®ƒæ˜¯ Schema çš„æ‰©å±•ï¼Œæ‰€ä»¥æŒ‚åœ¨ Schema å‘½åç©ºé—´ä¸‹æ›´åˆé€‚
    const Loadable = (InnerSchema) =>
      Schema.Struct({
        data: Schema.NullOr(InnerSchema),
        loading: Schema.Boolean,
        error: Schema.NullOr(Schema.String)
      }).pipe(
        // å…³é”®ç‚¹ï¼šåªæŒ‚è½½é™æ€æ ‡è®°
        Schema.annotations({
          [ReactiveFieldId]: { type: 'loadable' }
        })
      )
    ```
*   **ç›®çš„**: è®© Runtime åœ¨åˆå§‹åŒ– State æ—¶ï¼ŒçŸ¥é“è¿™ä¸ªå­—æ®µéœ€è¦è¢«ç‰¹æ®Šå¤„ç†ï¼ˆæ¯”å¦‚åˆå§‹åŒ–é»˜è®¤ç»“æ„ï¼‰ï¼Œå¹¶å‡†å¤‡å¥½æ¥å—æ¥è‡ª `reactive` é…ç½®çš„å†™å…¥ã€‚

**2. Module Config (Logic)**
`Reactive.computed` / `Reactive.async` / `Reactive.stream` / `Reactive.effect` **éƒ½ä¸ä½¿ç”¨** Schema Annotationsã€‚

*   **ä½œç”¨**: å®šä¹‰å…·ä½“çš„è®¡ç®—å’Œå‰¯ä½œç”¨é€»è¾‘ã€‚
*   **ä½ç½®**: å®ƒä»¬å­˜åœ¨äº `Module` å®šä¹‰çš„ `reactive` å±æ€§ä¸­ã€‚
*   **ç›®çš„**: é¿å¼€é€’å½’ç±»å‹é—®é¢˜ï¼Œæä¾›ç±»å‹å®‰å…¨çš„é€»è¾‘å®šä¹‰ç¯å¢ƒã€‚

### 4.2 è¿è¡Œæ—¶æ˜ å°„æœºåˆ¶ (Runtime Mapping)

è™½ç„¶ç”¨æˆ·ä¾§çš„ API åˆ†ç¦»äº†ï¼Œä½†åœ¨è¿è¡Œæ—¶ï¼Œå®ƒä»¬ä¾ç„¶ä¼šæ±‡èšæˆç»Ÿä¸€çš„ `$.flow`ã€‚

1.  **Schema æ‰«æ**: Runtime é¦–å…ˆæ‰«æ State Schemaï¼Œè¯†åˆ«å‡ºå¸¦æœ‰ `Reactive.Resource` æ ‡è®°çš„å­—æ®µï¼Œåˆå§‹åŒ–å…¶é»˜è®¤ç»“æ„ (data=null, loading=false)ã€‚
2.  **Config åŒ¹é…**: Runtime éå† `reactive` é…ç½®å¯¹è±¡ï¼Œå°†å…¶ä¸ State å­—æ®µåŒ¹é…ã€‚
3.  **Flow ç”Ÿæˆ**:
    *   Runtime å°† Config ä¸­çš„ `deps` å‡½æ•°è½¬æ¢ä¸º `$.flow.fromState(deps)`ã€‚
    *   å°† `loader` å‡½æ•°è½¬æ¢ä¸º `switchMap(loader)`ã€‚
    *   æœ€ç»ˆç”Ÿæˆä¸€ä¸ªæ ‡å‡†çš„ Logic Fiberï¼Œæ³¨å…¥åˆ° Module çš„è¿è¡Œå¾ªç¯ä¸­ã€‚

### 4.3 æ ¸å¿ƒåŸè¯­è§£å‰–: Reactive.computed

**Q1: `Reactive.computed(...)` è¿”å›çš„æ˜¯ä»€ä¹ˆï¼Ÿ**
å®ƒè¿”å›çš„ **ä¸æ˜¯** è®¡ç®—åçš„å€¼ï¼Œä¹Ÿä¸æ˜¯ Streamï¼Œè€Œæ˜¯ä¸€ä¸ª **çº¯é…ç½®å¯¹è±¡ (Configuration Object)**ã€‚
è¿™ä¸ªå¯¹è±¡åªåŒ…å«å…ƒæ•°æ®ï¼Œç”¨äºå‘Šè¯‰ Runtime "è¯¥æ€ä¹ˆåš"ã€‚

```ts
// Reactive.computed çš„è¿”å›å€¼ç»“æ„
{
  _tag: "Reactive/Computed",
  compute: (state) => state.first + state.last
}
```

**Q2: ä»€ä¹ˆæ—¶å€™è¢«æ˜ å°„ï¼Ÿ**
æ˜ å°„å‘ç”Ÿåœ¨ **Module åˆå§‹åŒ–é˜¶æ®µ (`Module.live`)**ã€‚
å½“ `Module.live` è¢«è°ƒç”¨æ—¶ï¼ŒRuntime ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1.  **Init State**: åˆ›å»ºåˆå§‹çŠ¶æ€å¯¹è±¡ (Plain Object)ã€‚
2.  **Scan Config**: éå† `Module.reactive` é…ç½®ã€‚
3.  **Compile**: å°†æ¯ä¸ªé…ç½®é¡¹ç¼–è¯‘ä¸ºå¯¹åº”çš„ Logic Fiber (Stream)ã€‚
4.  **Run**: å¯åŠ¨è¿™äº› Fibersï¼Œå¼€å§‹ç›‘å¬çŠ¶æ€å˜åŒ–ã€‚

**Q3: è¿è¡Œæ—¶ä¼ªä»£ç å®ç°**

```ts
// å‡è®¾é…ç½®: fullName: Reactive.computed((s) => s.first + s.last)

function compileComputed(key: string, config: ComputedConfig, runtime: Runtime) {
  // 1. ä»é…ç½®å¯¹è±¡ä¸­æå–è®¡ç®—å‡½æ•°
  const computeFn = config.compute

  // 2. åˆ›å»ºæµï¼šç›‘å¬æ•´ä¸ª State çš„å˜åŒ– (æˆ–é€šè¿‡ Proxy è‡ªåŠ¨è¿½è¸ªä¾èµ–)
  const stream = runtime.state$.changes.pipe(
    // 3. è®¡ç®—æ–°å€¼
    Stream.map(state => computeFn(state)),

    // 4. å»é‡ï¼šå¦‚æœè®¡ç®—ç»“æœæ²¡å˜ï¼Œä¸è§¦å‘æ›´æ–°
    Stream.changes,

    // 5. åŒæ­¥å›å¡«ï¼šåœ¨åŒä¸€ä¸ªå¾®ä»»åŠ¡/äº‹åŠ¡ä¸­æ›´æ–° State
    // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ç‰¹æ®Šçš„ internalSet æ–¹æ³•ï¼Œç»•è¿‡ Action è°ƒåº¦ï¼Œç›´æ¥æ›´æ–°å†…å­˜
    Stream.runForEach(newValue => {
      runtime.internalSet(key, newValue)
    })
  )

  return stream
}
```

**å…³é”®ç‰¹æ€§**:
*   **Sync Update**: è®¡ç®—æ˜¯åŒæ­¥å‘ç”Ÿçš„ã€‚å½“ `firstName` å˜åŒ–æ—¶ï¼Œ`fullName` ä¼šåœ¨åŒä¸€ä¸ª React æ¸²æŸ“å‘¨æœŸå†…æ›´æ–°ï¼ˆå¦‚æœä½¿ç”¨ React ç»‘å®šï¼‰ã€‚
*   **Dependency Tracking**: å®é™…ä¸Š Runtime ä¼šä¼˜åŒ– `runtime.state$.changes`ï¼Œåˆ©ç”¨ Proxy æˆ– Selector åªç›‘å¬ç›¸å…³å­—æ®µçš„å˜åŒ–ï¼Œé¿å…å…¨é‡é‡ç®—ã€‚

### 4.5 è¿›é˜¶æ¨¡å¼: è‡ªå®šä¹‰ Schema å·¥å‚ (Custom Schema Factories)

**Q: è¿™äº› API æ˜¯å“ªé‡Œæš´éœ²çš„ï¼Ÿ**

1.  **`Schema.Loadable`**: ç”± `@logix/core` ç›´æ¥æš´éœ²ï¼ˆä½œä¸º Schema çš„æ‰©å±•ï¼‰ã€‚
    *   å®ƒæ˜¯å®˜æ–¹æ¨èçš„ã€å¼€ç®±å³ç”¨çš„æ ‡å‡†å®¹å™¨ã€‚

2.  **`ReactiveFieldId`**: ä¹Ÿç”± `@logix/core` æš´éœ²ã€‚
    *   è¿™æ˜¯ç»™**æ¶æ„å¸ˆ**ç”¨çš„åº•å±‚ Symbolã€‚

**å¦‚ä½•å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰å·¥å‚ï¼Ÿ**

å‡è®¾ä½ æƒ³å®šä¹‰ä¸€ä¸ªç®€å•çš„ `Loadable<T>`ï¼Œåªæœ‰ `value` å’Œ `pending`ï¼š

```ts
// 1. å®šä¹‰ Schema ç»“æ„ä¸æ ‡è®°
const Loadable = <T>(item: Schema.Schema<T>) =>
  Schema.Struct({
    value: Schema.NullOr(item),
    pending: Schema.Boolean
  }).pipe(
    // æŒ‚è½½è‡ªå®šä¹‰å…ƒæ•°æ®
    Schema.annotations({
      [ReactiveFieldId]: {
        type: 'custom',
        // å‘Šè¯‰ Runtime å¦‚ä½•æ˜ å°„çŠ¶æ€
        mapping: {
          data: 'value',     // å°†å¼‚æ­¥ç»“æœå†™å…¥ value
          loading: 'pending' // å°†åŠ è½½çŠ¶æ€å†™å…¥ pending
        }
      }
    })
  )

// 2. åœ¨ä¸šåŠ¡ä¸­ä½¿ç”¨
const UserState = Schema.Struct({
  profile: Loadable(UserSchema)
})
```

**Runtime çš„é€šç”¨å¤„ç†é€»è¾‘**:
Runtime ä¸å†ç¡¬ç¼–ç  `Resource` çš„é€»è¾‘ï¼Œè€Œæ˜¯è¯»å– Annotation ä¸­çš„ `mapping` é…ç½®ï¼š
*   å½“å¼‚æ­¥ä»»åŠ¡å¼€å§‹ -> å°† `mapping.loading` å¯¹åº”çš„å­—æ®µè®¾ä¸º trueã€‚
*   å½“å¼‚æ­¥ä»»åŠ¡æˆåŠŸ -> å°†ç»“æœå†™å…¥ `mapping.data` å¯¹åº”çš„å­—æ®µã€‚

è¿™ç§è®¾è®¡å°† `Reactive.Resource` é™çº§ä¸ºä¸€ä¸ª **"ç”¨æˆ·æ€"** çš„å·¥å…·å‡½æ•°ï¼Œèµ‹äºˆäº†æ¶æ„å¸ˆæå¤§çš„çµæ´»æ€§ã€‚ä½ å¯ä»¥å®šä¹‰ `PaginationResource`ã€`InfiniteList` ç­‰å„ç§å¤æ‚çš„å®¹å™¨ç»“æ„ã€‚

## 5. è¿è¡Œæ—¶æ¶æ„ (Runtime Architecture)

`Module.live` è´Ÿè´£å°†è¿™äº›å£°æ˜å¼çš„é…ç½®è½¬æ¢ä¸ºåº•å±‚çš„ Logic Fibersã€‚

### 4.1 éšå¼ Logic ç”Ÿæˆ (Implicit Logic Generation)

Runtime ä¼šéå† `reactive` é…ç½®å¯¹è±¡ï¼Œä¸ºæ¯ä¸ªå­—æ®µç”Ÿæˆä¸€ä¸ªéšå¼çš„ Logicï¼š

*   **Computed**: ç”Ÿæˆä¸€ä¸ª `Effect.sync` ä»»åŠ¡ï¼Œç›‘å¬ä¾èµ–å˜åŒ–ï¼ŒåŒæ­¥æ›´æ–° Stateã€‚
    ```ts
    // Runtime ä¼ªä»£ç 
    $.flow.fromState(deps).map(compute).pipe($.state.set(key))
    ```

*   **Async (Query)**: ç”Ÿæˆä¸€ä¸ªæ ‡å‡†çš„ Query Flowã€‚
    ```ts
    // Runtime ä¼ªä»£ç 
    $.flow.fromState(deps).pipe(
      $.flow.switchMap(loader), // è‡ªåŠ¨å¤„ç†ç«æ€
      $.flow.map(result => wrapResource(result)),
      $.state.set(key)
    )
    ```

*   **Stream**: ç”Ÿæˆä¸€ä¸ªé•¿è¿æ¥ç®¡ç† Flowï¼Œåˆ©ç”¨ Scope è‡ªåŠ¨å¤„ç†è®¢é˜…/å–æ¶ˆè®¢é˜…ã€‚
    ```ts
    // Runtime ä¼ªä»£ç 
    $.flow.fromState(deps).pipe(
      $.flow.flatMap(subscribe), // åˆ‡æ¢æµ
      $.state.set(key)
    )
    ```

### 4.2 æ··åˆæ¨¡å¼ (Hybrid Mode)

è¿™ç§è®¾è®¡å…è®¸ "å£°æ˜å¼" ä¸ "å‘½ä»¤å¼" å…±å­˜ã€‚
å¯¹äº 80% çš„ç®€å•åœºæ™¯ï¼Œä½¿ç”¨ `reactive` é…ç½®ã€‚
å¯¹äº 20% çš„å¤æ‚åœºæ™¯ (å¦‚éœ€è¦ç²¾ç»†æ§åˆ¶æ—¶åºã€å¤šæ­¥éª¤é‡è¯•ã€è·¨æ¨¡å—è”åŠ¨)ï¼Œä¾ç„¶å¯ä»¥ç¼–å†™æ˜¾å¼çš„ `Module.logic`ã€‚

## 6. æ„¿æ™¯ï¼šLogix Schema = Effect Schema + Runtime Metadata

`@logix/core` å¯¼å‡ºçš„ `Schema` æ˜¯ **Effect Schema çš„è¶…é›† (Superset)**ã€‚

### 6.1 ç»§æ‰¿ä¸æ‰©å±• (Inheritance & Extension)
å®ƒå®Œå…¨å…¼å®¹ Effect Schema çš„æ‰€æœ‰ APIï¼ˆå¦‚ `Schema.String`, `Schema.Struct`ï¼‰ï¼Œå› ä¸ºåº•å±‚å°±æ˜¯ç›´æ¥ re-exportã€‚

### 6.2 å¢å¼ºèƒ½åŠ› (Logix-Specific Capabilities)
åœ¨æ­¤åŸºç¡€ä¸Šï¼ŒLogix å¢åŠ äº†ä¸€äº› **ç‰¹å®šäº Logix Runtime çš„é«˜çº§èƒ½åŠ›**ï¼Œä¸»è¦é€šè¿‡ `Schema.annotations` å®ç°ï¼š

*   **`Schema.Loadable(T)`**:
    *   **èƒ½åŠ›**: å‘Šè¯‰ Runtime "è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥å®¹å™¨ï¼Œè¯·è‡ªåŠ¨ç®¡ç† loading/error"ã€‚
    *   **å®ç°**: æ‰©å±•äº†æ ‡å‡† Structï¼Œæ‰“ä¸Šäº† `type: 'loadable'` æ ‡è®°ã€‚

*   **`Schema.Action(Payload)`** (æœªæ¥è§„åˆ’):
    *   **èƒ½åŠ›**: å‘Šè¯‰ Runtime "è¿™æ˜¯ä¸€ä¸ª Action Payloadï¼Œè¯·ä¸ºå…¶ç”Ÿæˆ dispatch æ–¹æ³•"ã€‚
    *   **å®ç°**: æ‰“ä¸Š `type: 'action'` æ ‡è®°ã€‚

è¿™ç§è®¾è®¡è®© Logix çš„ Schema æ—¢ä¿æŒäº†ä¸ Effect ç”Ÿæ€çš„äº’æ“ä½œæ€§ï¼ˆä½ å¯ä»¥ç›´æ¥æŠŠ Logix Schema ä¼ ç»™ Effect çš„è§£æå™¨ï¼‰ï¼Œåˆæ‹¥æœ‰äº†ç‰¹å®šäºä¸šåŠ¡æ¡†æ¶çš„å…ƒç¼–ç¨‹èƒ½åŠ›ã€‚

## 7. ç»ˆæå“²å­¦ï¼šEffect-TS å…ƒç¼–ç¨‹æ¨¡å¼ (The Meta-Programming Pattern)

ä½ è§¦ç¢°åˆ°äº† Effect-TS ç”Ÿæ€æœ€æ ¸å¿ƒçš„æ¶æ„çº¢åˆ©ï¼š**è“å›¾ (Blueprint) ä¸ è¿è¡Œæ—¶ (Runtime) çš„å½»åº•è§£è€¦**ã€‚

è¿™æ­£æ˜¯ Logix v3 èƒ½å¤Ÿåˆ›é€ å‡º `Reactive.computed`ã€`Schema.Loadable` ç­‰é«˜çº§è¯­æ³•ç³–çš„ç†è®ºåŸºç¡€ã€‚

### 7.1 æ ¸å¿ƒå…¬å¼

```
High-Level DSL = Schema Metadata (è“å›¾) + Runtime Capabilities (æ‰§è¡ŒåŠ›)
```

1.  **Schema Metadata (é™æ€è“å›¾)**:
    *   åˆ©ç”¨ `Schema.annotations`ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»»æ„ä¸šåŠ¡æ„å›¾ï¼ˆ"è¿™æ˜¯ä¸€ä¸ªèµ„æº"ã€"è¿™æ˜¯ä¸€ä¸ª Action"ã€"è¿™æ˜¯ä¸€ä¸ªè¡¨å•æ ¡éªŒ"ï¼‰ç¼–ç è¿›é™æ€çš„ç±»å‹ç³»ç»Ÿä¸­ã€‚
    *   è¿™å°±åƒæ˜¯åœ¨ç”»å»ºç­‘å›¾çº¸ï¼Œåªè´Ÿè´£æ ‡è®° "è¿™é‡Œæ˜¯æ‰¿é‡å¢™"ï¼Œè€Œä¸è´Ÿè´£ "æ€ä¹ˆç Œå¢™"ã€‚

2.  **Runtime Capabilities (åŠ¨æ€æ‰§è¡ŒåŠ›)**:
    *   Logix Runtime (åŸºäº Effect) å°±åƒä¸€ä¸ªå¼ºå¤§çš„æ–½å·¥é˜Ÿã€‚
    *   å®ƒæ‹¿ç€å›¾çº¸ï¼ˆSchemaï¼‰ï¼Œåˆ©ç”¨åº•å±‚çš„ Bound API (`$.flow`, `$.state`, `$.actions`)ï¼ŒåŠ¨æ€åœ°æ„å»ºå‡ºå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚

### 7.2 æ— é™çš„æ‰©å±•æ€§

è¿™ç§æ¨¡å¼æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åˆ›é€  **ä»»æ„** çš„é«˜çº§è¯­æ³•ç³–ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹æ ¸å¿ƒç¼–è¯‘å™¨ï¼š

*   **æƒ³è¦ä¸€ä¸ª "è‡ªåŠ¨ä¿å­˜" åŠŸèƒ½ï¼Ÿ**
    *   å®šä¹‰ `Schema.AutoSave(Interval)`ã€‚
    *   Runtime è¯†åˆ«åˆ°æ ‡è®°ï¼Œè‡ªåŠ¨æŒ‚è½½ä¸€ä¸ª `debounce -> save` çš„ Flowã€‚
*   **æƒ³è¦ä¸€ä¸ª "ä¹è§‚æ›´æ–° (Optimistic UI)"ï¼Ÿ**
    *   å®šä¹‰ `Schema.Optimistic(Mutation)`ã€‚
    *   Runtime è¯†åˆ«åˆ°æ ‡è®°ï¼Œè‡ªåŠ¨æ‹¦æˆª Actionï¼Œå…ˆæ›´æ–° UIï¼Œå†å‘è¯·æ±‚ï¼Œå¤±è´¥å›æ»šã€‚

**ç»“è®º**ï¼š
Logix v3 ä¸ä»…ä»…æ˜¯ä¸€ä¸ªçŠ¶æ€åº“ï¼Œå®ƒæ˜¯ä¸€ä¸ª **åŸºäº Effect-TS çš„å…ƒæ¡†æ¶ (Meta-Framework)**ã€‚å®ƒè¯æ˜äº†ï¼šåªè¦åº•å±‚åŸè¯­è¶³å¤Ÿå¼ºå¤§ï¼ˆEffectï¼‰ï¼Œä¸Šå±‚æŠ½è±¡å°±å¯ä»¥æ— é™è‡ªç”±ã€‚

## 8. æ€»ç»“ (Conclusion)

è¿™ä»½æ•´åˆæ–¹æ¡ˆï¼š

1.  **é‡‡çº³äº†** `logix-reactive-schema.md` çš„ **"Schema-Driven" æ„¿æ™¯** â€”â€” å¼€å‘è€…åªéœ€å…³æ³¨æ•°æ®å®šä¹‰ã€‚
2.  **é‡‡çº³äº†** `logix-module-computed-query.md` çš„ **"Co-located" å®ç°** â€”â€” ç¡®ä¿ 100% ç±»å‹å®‰å…¨ã€‚
3.  **é‡‡çº³äº†** `logix-query-unified-api-design.md` çš„ **"Layered" ç­–ç•¥** â€”â€” `reactive` é…ç½®å³ Layer 1ï¼Œæ˜¾å¼ Logic å³ Layer 2/3ã€‚

è¿™æ˜¯ Logix v3 åœ¨æ•°æ®èŒƒå¼ä¸Šçš„æœ€ç»ˆç­”æ¡ˆï¼š**Declarative Source, Co-located with Shape.**
</file>

<file path="drafts/L9/logix-reactive-schema.md">
---
title: 'Reactive Schema: The Logix v3 Data Paradigm'
status: merged
moved_to: ../topics/query-integration/04-reactive-paradigm.md
version: 2
layer: Core Concept
priority: 700
---

# Reactive Schema: The Logix v3 Data Paradigm

> "Schema is not just a validator. It is the Dependency Graph."

## 1. æ ¸å¿ƒç†å¿µ (Core Concept)

åœ¨ Logix v3 ä¸­ï¼Œæˆ‘ä»¬é‡æ–°å®šä¹‰äº† Schema çš„è§’è‰²ã€‚
ä¼ ç»Ÿçš„ Schema (Zod/Effect Schema) æ˜¯**é™æ€çš„ (Static)**ï¼Œä»…æè¿°æ•°æ®çš„å½¢çŠ¶ã€‚
Logix çš„ Schema æ˜¯**å“åº”å¼çš„ (Reactive)**ï¼Œå®ƒåŒæ—¶æè¿°äº†æ•°æ®çš„**æ¥æº (Source)** å’Œ **ä¾èµ– (Dependencies)**ã€‚

è¿™ç§èŒƒå¼è½¬ç§»è®©æˆ‘ä»¬èƒ½å¤Ÿå®ç° **"Schema-Driven Reactivity"**ï¼š
å¼€å‘è€…åªéœ€å®šä¹‰ Schemaï¼ŒRuntime è‡ªåŠ¨æ„å»ºå“åº”å¼é“¾è·¯ã€‚

## 2. ç»Ÿä¸€ API: `Schema.augment`

ä¸ºäº†æ”¯æŒå“åº”å¼å®šä¹‰ï¼Œæˆ‘ä»¬å¼•å…¥äº† `Schema.augment` (å¢å¼º) APIã€‚
å®ƒå…è®¸æˆ‘ä»¬åœ¨å®šä¹‰ Schema çš„åŒæ—¶ï¼Œå£°æ˜å­—æ®µçš„è®¡ç®—é€»è¾‘ã€‚

```ts
import { Logix, Schema, Reactive } from '@logix/core'

const Base = Schema.Struct({
  firstName: Schema.String,
  lastName: Schema.String,
  userId: Schema.String
})

export const UserModule = Logix.Module('User', {
  state: Schema.augment(Base, (base) => ({

    // 1. åŒæ­¥è®¡ç®— (Sync Computed)
    // ç±»ä¼¼äº Vue computed æˆ– MobX view
    fullName: Reactive.computed({
      deps: [base.firstName, base.lastName],
      compute: ([first, last]) => `${first} ${last}`
    }),

    // 2. å¼‚æ­¥è®¡ç®— (Async Computed / Query)
    // ç±»ä¼¼äº React Queryï¼Œä½†å†…èšåœ¨ Schema ä¸­
    profile: Reactive.async({
      deps: [base.userId],
      loader: ([id]) => UserApi.fetchProfile(id),
      staleTime: 5000
    }),

    // 3. å®æ—¶æµ (Stream / Subscription)
    // ç±»ä¼¼äº WebSocket è®¢é˜…
    status: Reactive.stream({
      deps: [base.userId],
      subscribe: ([id]) => UserApi.subscribeStatus(id)
    })
  }))
})
```

## 3. ä½“ç³»æ¶æ„ (Architecture)

åœ¨ Reactive Schema ä½“ç³»ä¸‹ï¼Œ`Query` ä¸å†æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„é¡¶å±‚æ¦‚å¿µï¼Œè€Œæ˜¯ `Reactive.async` çš„ä¸€ç§ç‰¹ä¾‹ã€‚

### 3.1 å“åº”å¼åŸè¯­ (Primitives)

*   **`Reactive.computed`**: çº¯å‡½æ•°è®¡ç®—ã€‚Runtime ä¿è¯å…¶ä¸º Pure & Memoizedã€‚
*   **`Reactive.async`**: å‰¯ä½œç”¨è®¡ç®— (Effect)ã€‚Runtime è´Ÿè´£å¹¶å‘æ§åˆ¶ (TakeLatest/SwitchMap)ã€ç«æ€å¤„ç†ã€Loading çŠ¶æ€ç®¡ç†ã€‚
*   **`Reactive.stream`**: é•¿è¿æ¥æºã€‚Runtime è´Ÿè´£è¿æ¥å»ºç«‹ä¸é”€æ¯ (Scope Management)ã€‚

### 3.2 è¿è¡Œæ—¶æ˜ å°„ (Runtime Mapping)

### 3.2 è¿è¡Œæ—¶æ˜ å°„ (Runtime Mapping)

Logix Runtime (`Module.live`) ä¼šè§£æè¿™äº› Schema Annotationsï¼Œå¹¶å°†å…¶æ˜ å°„ä¸ºåº•å±‚çš„ Logic Fibersï¼š

| Schema Definition | Runtime Implementation | Consistency |
| :--- | :--- | :--- |
| `Reactive.computed` | **Derived State** (Atomic Update). å½“ä¾èµ–å˜åŒ–æ—¶ï¼Œåœ¨åŒä¸€äº‹åŠ¡ä¸­åŒæ­¥è®¡ç®—æ–°å€¼ã€‚ | **Strong (Sync)** |
| `Reactive.async` | `$.flow.fromState(deps).runLatest(loader)` | **Eventual (Async)** |
| `Reactive.stream` | `$.flow.fromState(deps).flatMap(subscribe)` | **Eventual (Async)** |

### 3.3 ä¸ Effect Stream çš„å…³ç³» (The Stream Connection)

ä½ å¯èƒ½ä¼šæ‹…å¿ƒï¼š*è¿™æ˜¯å¦èƒŒç¦»äº† Effect Stream çš„å“²å­¦ï¼Ÿ*
æ°æ°ç›¸åï¼ŒReactive Schema æ˜¯ **Effect Stream çš„å£°æ˜å¼æŠ•å½± (Declarative Projection)**ã€‚

*   **Layer 0 (Effect/Stream)**: å¼ºå¤§çš„åŸè¯­ï¼Œé€‚åˆå¤„ç†å¤æ‚çš„æ—¶åºã€å¹¶å‘å’Œèµ„æºç®¡ç†ã€‚ä½†ç›´æ¥ç”¨æ¥å†™ä¸šåŠ¡çŠ¶æ€å¾€å¾€è¿‡äºåº•å±‚ (Verbose)ã€‚
*   **Layer 1 (Reactive Schema)**: é’ˆå¯¹ "State Derived from Source" è¿™ä¸€ç‰¹å®šæ¨¡å¼çš„ DSLã€‚

**Desugaring (è„±ç³–)**:
å½“æˆ‘ä»¬å†™ `Reactive.async` æ—¶ï¼ŒRuntime å®é™…ä¸Šæ˜¯åœ¨å¸®ä½ å†™è¿™æ ·ä¸€æ®µæ ‡å‡†çš„ Stream ä»£ç ï¼š

```ts
// Schema å®šä¹‰
profile: Reactive.async({ deps: [id], loader: fetchUser })

// Runtime è‡ªåŠ¨ç”Ÿæˆçš„ Stream ä»£ç 
Stream.fromChanges(state.id).pipe(
  Stream.debounce(config.debounce),     // è‡ªåŠ¨å¤„ç†é˜²æŠ–
  Stream.mapEffect(id => fetchUser(id)), // è‡ªåŠ¨å¤„ç† Effect æ‰§è¡Œ
  Stream.runForEach(data => state.profile.set(data)) // è‡ªåŠ¨å›å¡«
)
```

æˆ‘ä»¬æ²¡æœ‰æŠ›å¼ƒ Streamï¼Œè€Œæ˜¯æŠŠ **"Stream çš„æœ€ä½³å®è·µ"** å›ºåŒ–åœ¨äº† Schema å®šä¹‰ä¸­ã€‚å¯¹äº 80% çš„æ ‡å‡†åœºæ™¯ï¼Œä½ ä¸éœ€è¦æ‰‹å†™ Streamï¼›å¯¹äºå‰©ä¸‹ 20% çš„å¤æ‚åœºæ™¯ (Layer 3)ï¼Œä½ ä¾ç„¶å¯ä»¥è·³å‡º Schemaï¼Œç›´æ¥åœ¨ Logic ä¸­å†™åŸç”Ÿçš„ Streamã€‚

## 4. è¿è¡Œæ—¶æ·±åº¦è§£æ (Runtime Deep Dive)

ä½ é—®åˆ°ï¼š**"çœŸçš„èƒ½åœ¨è¿è¡Œæ—¶åšè¿™ç§è½¬æ¢å—ï¼Ÿ"**
ç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚è¿™ä¸æ˜¯é­”æ³•ï¼Œè€Œæ˜¯ **Runtime Metaprogramming (è¿è¡Œæ—¶å…ƒç¼–ç¨‹)**ã€‚

æˆ‘ä»¬ä¸æ˜¯åœ¨ç”Ÿæˆæ–‡æœ¬ä»£ç ï¼Œè€Œæ˜¯åœ¨å†…å­˜ä¸­åŠ¨æ€æ„å»º Stream å¯¹è±¡å›¾ã€‚
ä»¥ä¸‹æ˜¯ `Module.live` å†…éƒ¨çš„æ ¸å¿ƒé€»è¾‘ä¼ªä»£ç ï¼š

```typescript
// è¿™æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ Runtime Compiler
function compileSchemaToLogic(state: State, schema: Schema) {
  // 1. éå† Schema å­—æ®µ
  for (const [key, fieldSchema] of Object.entries(schema.fields)) {

    // 2. æå–å…ƒæ•°æ® (Metadata)
    const meta = getReactiveMetadata(fieldSchema)
    if (!meta) continue

    // 3. æ ¹æ®ç±»å‹æ„å»º Stream (The Transformation)
    if (meta.type === 'async') {

      // åŠ¨æ€æ„å»º Stream Pipeline
      const stream = Stream.fromEffect(
        // 3.1 è§£æä¾èµ– (Resolve Dependencies)
        // meta.deps æ˜¯ä¸€ä¸ªå‡½æ•° (s) => [s.id]ï¼Œè¿™é‡Œä¼ å…¥çœŸå®çš„ state proxy
        resolveDependencies(state, meta.deps)
      ).pipe(
        // 3.2 ç›‘å¬å˜åŒ– (Watch Changes)
        Stream.changes,

        // 3.3 åº”ç”¨ç­–ç•¥ (Apply Strategy: Debounce/SwitchMap)
        Stream.debounce(meta.options.debounce),
        Stream.switchMap(args =>
          // æ‰§è¡Œ Loader
          Effect.tryPromise(() => meta.loader(args))
            .pipe(Effect.mapError(err => wrapError(err)))
        ),

        // 3.4 å›å¡«çŠ¶æ€ (Write Back)
        Stream.runForEach(data =>
          state[key].set(data)
        )
      )

      // 4. æ³¨å…¥åˆ° Runtime Loop
      Runtime.runFork(stream)
    }
  }
}
```

è¿™å°±æ˜¯ Logix Runtime çš„æ ¸å¿ƒèŒè´£ï¼š**å®ƒæ˜¯ä¸€ä¸ªè§£é‡Šå™¨ï¼Œå°†é™æ€çš„ Schema è§£é‡Šä¸ºåŠ¨æ€çš„ Effect/Stream æµç¨‹ã€‚**

## 5. å®ç°è§„æ ¼è¯´æ˜ (Implementation Specs)

ä¸ºäº†è½åœ°è¿™ä¸€è®¾è®¡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `@logix/core` ä¸­è¿›è¡Œä»¥ä¸‹æ”¹é€ ï¼š

### 5.1 æ ¸å¿ƒåŸè¯­ (`packages/logix-core/src/Reactive.ts`)

è¿™æ˜¯ç”¨æˆ·ä¾§çš„ API å®šä¹‰ï¼Œè´Ÿè´£ç”Ÿæˆå¸¦æœ‰å…ƒæ•°æ®çš„ Schemaã€‚

*   **Metadata Definition**:
    ```ts
    export const ReactiveFieldId = Symbol.for("@logix/core/ReactiveField")

    export type ReactiveMetadata =
      | { type: 'computed', deps: Deps, compute: (args) => Ret }
      | { type: 'async',    deps: Deps, loader: (args) => Promise<Ret> }
      | { type: 'stream',   deps: Deps, subscribe: (args) => Stream }
    ```

*   **Factory Implementation**:
    åˆ©ç”¨ `Schema.annotations` å°†å…ƒæ•°æ®æŒ‚è½½åˆ° Schema AST ä¸Šã€‚
    ```ts
    export const computed = (config) =>
      Schema.Any.pipe(
        Schema.annotations({
          [ReactiveFieldId]: { type: 'computed', ...config }
        })
      )
    ```

### 5.2 è¿è¡Œæ—¶ç¼–è¯‘å™¨ (`packages/logix-core/src/Module.ts`)

è¿™æ˜¯å¼•æ“ä¾§çš„å®ç°ï¼Œè´Ÿè´£è§£æ Schema å¹¶å¯åŠ¨ Logic Fiberã€‚

*   **Compiler Logic**:
    åœ¨ `Module.live` (æˆ– `makeLogic`) åˆå§‹åŒ–é˜¶æ®µï¼Œéå† `StateSchema.ast`ã€‚
    1.  æŸ¥æ‰¾å¸¦æœ‰ `ReactiveFieldId` çš„å­—æ®µã€‚
    2.  æ ¹æ® metadata ç±»å‹ï¼Œç”Ÿæˆå¯¹åº”çš„ `Stream` (å¦‚ä¸Šæ–‡ Deep Dive æ‰€ç¤º)ã€‚
    3.  å°†ç”Ÿæˆçš„ Stream æ³¨å…¥åˆ° Runtime Scope ä¸­è¿è¡Œã€‚

## 6. ä¼˜åŠ¿ (Benefits)

1.  **é«˜å†…èš (Cohesion)**: æ•°æ®å®šä¹‰ä¸æ•°æ®æ¥æºåœ¨ä¸€èµ·ï¼Œä¿®æ”¹å­—æ®µæ—¶æ— éœ€åœ¨æ–‡ä»¶é—´è·³è·ƒã€‚
2.  **ç±»å‹å®‰å…¨ (Type Safety)**: `Schema.augment` è§£å†³äº† TypeScript çš„é€’å½’ç±»å‹é—®é¢˜ï¼Œæä¾›å®Œç¾çš„ç±»å‹æ¨å¯¼ã€‚
3.  **ç»Ÿä¸€å¿ƒæ™º (Unified Mental Model)**: æ— è®ºæ˜¯åŒæ­¥è®¡ç®—ã€å¼‚æ­¥è¯·æ±‚è¿˜æ˜¯ WebSocketï¼Œéƒ½æ˜¯ "Computed Field" çš„å˜ä½“ã€‚

## 5. è¿ç§»è·¯å¾„ (Migration Path)

åŸæœ‰çš„ `Query.field` API å°†è¢«è§†ä¸º `Reactive.async` çš„åˆ«å (Alias)ï¼Œä»¥ä¿æŒå‘åå…¼å®¹æˆ–æä¾›æ›´è¯­ä¹‰åŒ–çš„ç¼©å†™ã€‚

```ts
// Query.field is just sugar for Reactive.async
export const Query = {
  field: Reactive.async
}
```
</file>

<file path="drafts/L9/logix-sugar-possibilities.md">
---
title: 'Logix v3: The Sugar Roadmap (Metaprogramming Possibilities)'
status: superseded
layer: Vision
related:
  - logix-reactive-module-integration.md
superseded_by: ../L5/dsl-evolution-roadmap.md
priority: 800
---

# Logix v3: The Sugar Roadmap

åŸºäº **"Schema Metadata (è“å›¾) + Runtime Capabilities (æ‰§è¡ŒåŠ›)"** çš„å…ƒç¼–ç¨‹æ¨¡å¼ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»¥ä¸‹é¢†åŸŸåˆ›é€ å‡ºæå…·è¡¨ç°åŠ›çš„è¯­æ³•ç³–ã€‚

## 1. æŒä¹…åŒ–ä¸åŒæ­¥ (Persistence & Sync)

åˆ©ç”¨ Schema æ ‡è®°å­—æ®µçš„æŒä¹…åŒ–ç­–ç•¥ï¼ŒRuntime è‡ªåŠ¨æŒ‚è½½è¯»å†™é€»è¾‘ã€‚

*   **`Schema.LocalStorage(Key)`**:
    *   **è“å›¾**: æ ‡è®°å­—æ®µéœ€è¦åŒæ­¥åˆ° LocalStorageã€‚
    *   **è¿è¡Œæ—¶**:
        *   Init: ä» LS è¯»å–åˆå§‹å€¼ã€‚
        *   Watch: ç›‘å¬å­—æ®µå˜åŒ– -> Debounce -> å†™å…¥ LSã€‚
    *   **DX**: `theme: Schema.String.pipe(Schema.LocalStorage('app-theme'))`

*   **`Schema.UrlSync(ParamName)`**:
    *   **è“å›¾**: æ ‡è®°å­—æ®µä¸ URL Query Param åŒå‘ç»‘å®šã€‚
    *   **è¿è¡Œæ—¶**:
        *   Init: ä» URL è§£æåˆå§‹å€¼ã€‚
        *   Watch: å­—æ®µå˜ -> `history.replaceState`ã€‚
        *   Listen: `popstate` -> æ›´æ–°å­—æ®µã€‚
    *   **DX**: `search: Schema.String.pipe(Schema.UrlSync('q'))`

## 2. å†å²è®°å½• (History / Undo-Redo)

*   **`Schema.TrackHistory`**:
    *   **è“å›¾**: æ ‡è®°è¯¥å­—æ®µï¼ˆæˆ–æ•´ä¸ª Stateï¼‰éœ€è¦æ”¯æŒæ’¤é”€é‡åšã€‚
    *   **è¿è¡Œæ—¶**: è‡ªåŠ¨ç»´æŠ¤ä¸€ä¸ª `HistoryStack` (Past/Future)ï¼Œå¹¶æš´éœ² `undo()` / `redo()` Actionã€‚
    *   **DX**: `canvas: CanvasSchema.pipe(Schema.TrackHistory)`

## 3. ç½‘ç»œäº¤äº’ (Network & Optimistic UI)

*   **`Schema.Optimistic(MutationFn)`**:
    *   **è“å›¾**: æ ‡è®°ä¸€ä¸ª Action Payload æˆ– State Update ä¸º"ä¹è§‚çš„"ã€‚
    *   **è¿è¡Œæ—¶**:
        1.  ç«‹å³åº”ç”¨å˜æ›´åˆ° UI Stateã€‚
        2.  åå°æ‰§è¡Œ `MutationFn`ã€‚
        3.  å¤±è´¥ -> è‡ªåŠ¨å›æ»š (Rollback) åˆ°å¿«ç…§ã€‚
    *   **DX**: `likeCount: Schema.Number.pipe(Schema.Optimistic(api.like))`

*   **`Schema.Polling(Interval)`**:
    *   **è“å›¾**: æ ‡è®°ä¸€ä¸ª `Schema.Loadable` éœ€è¦è½®è¯¢ã€‚
    *   **è¿è¡Œæ—¶**: è‡ªåŠ¨æŒ‚è½½å®šæ—¶å™¨ï¼Œå®šæœŸè§¦å‘ reloadã€‚

## 4. éªŒè¯ä¸çº¦æŸ (Validation & Constraints)

*   **`Schema.AsyncValidate(ValidatorFn)`**:
    *   **è“å›¾**: æ ‡è®°å­—æ®µéœ€è¦å¼‚æ­¥æ ¡éªŒï¼ˆå¦‚ç”¨æˆ·åå”¯ä¸€æ€§æ£€æŸ¥ï¼‰ã€‚
    *   **è¿è¡Œæ—¶**:
        *   ç›‘å¬è¾“å…¥ -> Debounce -> æ‰§è¡Œæ ¡éªŒã€‚
        *   å°†ç»“æœå†™å…¥ `field.error`ã€‚
        *   æ ¡éªŒä¸­è®¾ç½® `field.validating`ã€‚

*   **`Schema.CrossValidate(OtherField, Rule)`**:
    *   **è“å›¾**: å®šä¹‰è·¨å­—æ®µçº¦æŸï¼ˆå¦‚ `confirmPassword` å¿…é¡»ç­‰äº `password`ï¼‰ã€‚
    *   **è¿è¡Œæ—¶**: ç›‘å¬ä¸¤ä¸ªå­—æ®µçš„å˜åŒ–ï¼Œè‡ªåŠ¨è§¦å‘æ ¡éªŒã€‚

## 5. åŸ‹ç‚¹ä¸åˆ†æ (Analytics)

*   **`Schema.TrackChange(EventName)`**:
    *   **è“å›¾**: æ ‡è®°å½“è¯¥å­—æ®µå˜åŒ–æ—¶ï¼Œéœ€è¦ä¸ŠæŠ¥åŸ‹ç‚¹ã€‚
    *   **è¿è¡Œæ—¶**: ç›‘å¬å˜åŒ– -> è¿‡æ»¤(å»é‡/é‡‡æ ·) -> è°ƒç”¨ Analytics Serviceã€‚
    *   **DX**: `tabIndex: Schema.Number.pipe(Schema.TrackChange('tab_switch'))`

## 6. æƒé™æ§åˆ¶ (Access Control)

*   **`Schema.Guard(Permission)`**:
    *   **è“å›¾**: æ ‡è®°è¯¥å­—æ®µï¼ˆæˆ– Actionï¼‰éœ€è¦ç‰¹å®šæƒé™æ‰èƒ½è®¿é—®/æ‰§è¡Œã€‚
    *   **è¿è¡Œæ—¶**:
        *   Action: æ‹¦æˆª dispatchï¼Œæ— æƒé™åˆ™æŠ›é”™æˆ–å¿½ç•¥ã€‚
        *   State: è¯»å–æ—¶è„±æ• (Masking) æˆ–è¿”å›ç©ºã€‚
    *   **DX**: `salary: Schema.Number.pipe(Schema.Guard('admin'))`

## 7. è¶…è¶Š Schema: å…¨é“¾è·¯å…ƒç¼–ç¨‹ (Beyond Schema)

"å…ƒç¼–ç¨‹æ¨¡å¼" ä¸ä»…ä»…å±€é™äº Schemaã€‚åªè¦èƒ½æŒ‚è½½å…ƒæ•°æ®çš„åœ°æ–¹ï¼Œéƒ½å¯ä»¥åˆ›é€ è¯­æ³•ç³–ã€‚

### 7.1 Action è¯­æ³•ç³– (Action Decorators)

åˆ©ç”¨é«˜é˜¶å‡½æ•°æˆ–é…ç½®å¯¹è±¡ï¼Œä¸º Action é™„åŠ è¡Œä¸ºã€‚

*   **`Action.Debounce(300)`**:
    *   **è“å›¾**: æ ‡è®°è¯¥ Action éœ€è¦é˜²æŠ–ã€‚
    *   **è¿è¡Œæ—¶**: è‡ªåŠ¨æ‹¦æˆª dispatchï¼Œåº”ç”¨é˜²æŠ–ç­–ç•¥ã€‚
*   **`Action.Retry(3)`**:
    *   **è“å›¾**: æ ‡è®°è¯¥ Action å¤±è´¥åè‡ªåŠ¨é‡è¯•ã€‚
*   **`Action.Log(Format)`**:
    *   **è“å›¾**: è‡ªåŠ¨æ‰“å°æ—¥å¿—ã€‚

### 7.2 Logic è¯­æ³•ç³– (Logic Enhancers)

*   **`Logic.RunOnce`**:
    *   **è“å›¾**: æ ‡è®°è¯¥ Logic åœ¨ Module ç”Ÿå‘½å‘¨æœŸå†…åªè¿è¡Œä¸€æ¬¡ï¼ˆå¦‚åˆå§‹åŒ–ï¼‰ã€‚
*   **`Logic.OnBackground`**:
    *   **è“å›¾**: æ ‡è®°è¯¥ Logic åœ¨ Web Worker æˆ–åå°çº¿ç¨‹è¿è¡Œã€‚

### 7.3 Module è¯­æ³•ç³– (Module Config)

*   **`Module.Meta({ persist: true })`**:
    *   **è“å›¾**: æ•´ä¸ª Module çš„çŠ¶æ€è‡ªåŠ¨æŒä¹…åŒ–ã€‚

## 8. æ€»ç»“

Logix v3 çš„å…ƒç¼–ç¨‹æ˜¯å…¨æ–¹ä½çš„ï¼š
*   **Data**: Schema Annotations
*   **Behavior**: Action Decorators
*   **Flow**: Logic Enhancers

å®ƒä»¬å…±åŒæ„æˆäº†ä¸€ä¸ª **"å¯é…ç½®çš„è¿è¡Œæ—¶ (Configurable Runtime)"**ã€‚

### 7.4 å®ç°æœºåˆ¶: Annotatable æ¥å£ (The Mechanism)

ä¸ºäº†æ”¯æŒä¸Šè¿°èƒ½åŠ›ï¼Œæˆ‘ä»¬å°† `Module` å’Œ `Logic` è®¾è®¡ä¸ºå®ç°äº† `Annotatable` æ¥å£çš„å¯¹è±¡ï¼ˆç±»ä¼¼ Effect çš„è®¾è®¡ï¼‰ã€‚

**1. Module Metadata**
```ts
// æ–¹å¼ A: Config å†…ç½® (æ¨è)
Logix.Module('User', {
  meta: { persist: true, role: 'admin' },
  state: ...
})

// æ–¹å¼ B: Pipe æ‰©å±•
Logix.Module('User', { ... }).pipe(
  Module.annotate({ author: 'Yoyo' })
)
```

**2. Logic Metadata**
```ts
UserModule.logic(($) => ...).pipe(
  Logic.annotate({
    runOnce: true,
    debounce: 300
  })
)
```

Runtime åœ¨åŠ è½½ Module/Logic æ—¶ï¼Œä¼šä¼˜å…ˆè¯»å–è¿™äº› Metadataï¼Œå¹¶æ®æ­¤è°ƒæ•´æ‰§è¡Œç­–ç•¥ï¼ˆå¦‚è‡ªåŠ¨åŒ…è£¹ Debounce Middlewareï¼‰ã€‚

## 9. åŸåˆ™ä¸è¾¹ç•Œ: é˜²æ­¢æ»¥ç”¨ (Principles & Boundaries)

"å…ƒç¼–ç¨‹æ¨¡å¼" æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ã€‚ä¸ºäº†é˜²æ­¢ Logix å˜æˆä¸€ä¸ªå……æ–¥ç€"é»‘é­”æ³•"çš„æ¡†æ¶ï¼Œæˆ‘ä»¬å¿…é¡»åšå®ˆä»¥ä¸‹åŸåˆ™ï¼š

### 9.1 é€‚ç”¨èŒƒå›´ (Scope)
åªæœ‰ **"è·¨ä¸šåŠ¡é€šç”¨çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ (Cross-Cutting Concerns)"** æ‰é€‚åˆåšæˆè¯­æ³•ç³–ã€‚
*   âœ… **é€‚åˆ**: æŒä¹…åŒ–ã€æ—¥å¿—ã€æƒé™ã€é˜²æŠ–ã€é‡è¯•ã€Undo/Redoã€‚
*   âŒ **ä¸é€‚åˆ**: å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ "è®¢å•é‡‘é¢å¤§äº 100 åˆ™æ‰“æŠ˜"ï¼‰ã€‚ä¸šåŠ¡é€»è¾‘åº”æ˜¾å¼å†™åœ¨ Logic ä¸­ã€‚

### 9.2 æ˜¾å¼ä¼˜äºéšå¼ (Explicit over Implicit)
å‰¯ä½œç”¨åº”å½“å°½å¯èƒ½æ˜¾å¼åŒ–ï¼Œé¿å…åœ¨çœ‹ä¼¼æ— å®³çš„åœ°æ–¹éšè—é‡å‹é€»è¾‘ã€‚
*   âœ… **Good**: `Schema.Loadable` (æ˜ç¡®å£°æ˜è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥å®¹å™¨)ã€‚
*   âŒ **Bad**: `Schema.String.pipe(Schema.AutoFetch('/api/user'))` (åœ¨ä¸€ä¸ªæ™®é€šå­—ç¬¦ä¸²å®šä¹‰é‡Œéšè—äº†ç½‘ç»œè¯·æ±‚ï¼Œææ˜“è¯¯å¯¼)ã€‚

### 9.3 å¯é€ƒé€¸åŸåˆ™ (Escape Hatch)
è¯­æ³•ç³–æ°¸è¿œåªæ˜¯ **"æ·å¾„"**ï¼Œè€Œä¸æ˜¯ **"å”¯ä¸€è·¯å¾„"**ã€‚
Runtime å¿…é¡»ä¿è¯ï¼šä»»ä½•å¯ä»¥é€šè¿‡ Annotation å®ç°çš„åŠŸèƒ½ï¼Œéƒ½ä¸€å®šå¯ä»¥é€šè¿‡æ‰‹å†™ Logic å®ç°ã€‚å½“è¯­æ³•ç³–æ— æ³•æ»¡è¶³å¤æ‚éœ€æ±‚æ—¶ï¼Œå¼€å‘è€…åº”èƒ½å¹³æ»‘åœ°é€€å›åˆ°æ˜¾å¼ç¼–ç¨‹æ¨¡å¼ã€‚

## 10. æ€»ç»“

Logix v3 çš„å…ƒç¼–ç¨‹æ˜¯å…¨æ–¹ä½çš„ï¼š
*   **Data**: Schema Annotations (å®šä¹‰æ•°æ®çš„å½¢çŠ¶ä¸èƒ½åŠ›)
*   **Behavior**: Action Decorators (å®šä¹‰è¡Œä¸ºçš„ç­–ç•¥)
*   **Flow**: Logic Enhancers (å®šä¹‰æµç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸ä¸Šä¸‹æ–‡)

å®ƒä»¬å…±åŒæ„æˆäº†ä¸€ä¸ª **"å¯é…ç½®çš„è¿è¡Œæ—¶ (Configurable Runtime)"**ã€‚é€šè¿‡åœ¨ **"åŸåˆ™ä¸è¾¹ç•Œ"** å†…åˆç†ä½¿ç”¨è¿™äº›èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¿æŒä»£ç æ¸…æ™°å¯ç»´æŠ¤çš„åŒæ—¶ï¼Œè·å¾—æè‡´çš„å¼€å‘ä½“éªŒ (DX)ã€‚
</file>

<file path="drafts/L9/logix-unified-middleware.md">
---
title: 'Logix v3: Unified Middleware Architecture'
status: draft
layer: Kernel
related:
  - logix-reactive-module-integration.md
priority: 900
---

# Logix v3: Unified Middleware Architecture

ä¸ºäº†æ”¯æ’‘ "å…ƒç¼–ç¨‹æ¨¡å¼" (Metaprogramming Pattern)ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„å†…æ ¸çº§æ‹¦æˆªæœºåˆ¶ã€‚
çµæ„Ÿæ¥æºäº Redux çš„ `applyMiddleware`ï¼Œä½†é’ˆå¯¹ Effect Runtime è¿›è¡Œäº†é€‚é…ã€‚

## 1. æ ¸å¿ƒè®¾è®¡ (Core Design)

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„ `Middleware` æ¥å£ï¼Œå®ƒå¯ä»¥åŒæ—¶æ‹¦æˆª Module ç”Ÿå‘½å‘¨æœŸçš„ä¸‰ä¸ªå…³é”®é˜¶æ®µï¼š

```ts
interface Middleware<S, A> {
  // æ‹¦æˆª State æ›´æ–°
  // ç”¨äº: æŒä¹…åŒ–, Undo/Redo, è°ƒè¯•æ—¥å¿—
  state?: (next: (s: S) => Effect<void>) => (s: S) => Effect<void>

  // æ‹¦æˆª Action åˆ†å‘
  // ç”¨äº: åŸ‹ç‚¹, ä¹è§‚æ›´æ–°, æƒé™æ‹¦æˆª
  action?: (next: (a: A) => Effect<void>) => (a: A) => Effect<void>

  // æ‹¦æˆª Logic åˆå§‹åŒ– (å¯é€‰)
  // ç”¨äº: è‡ªåŠ¨æ³¨å…¥ Context, æ€§èƒ½ç›‘æ§
  logic?: (next: LogicFn) => LogicFn
}
```

## 2. ç»„åˆæœºåˆ¶ (Composition)

ç±»ä¼¼äº Reduxï¼Œæˆ‘ä»¬æä¾›ä¸€ä¸ª `applyMiddleware` å·¥å…·ï¼Œå°†å¤šä¸ªä¸­é—´ä»¶ç»„åˆæˆä¸€ä¸ªå¢å¼ºå™¨ (Enhancer)ã€‚

```ts
// ç»„åˆå™¨
const enhance = applyMiddleware(
  LoggerMiddleware,
  PersistMiddleware,
  UndoRedoMiddleware
)

// åœ¨ Module.live ä¸­ä½¿ç”¨
const runtime = yield* ModuleRuntime.make(initialState, {
  enhancer: enhance
})
```

## 3. è¿è¡Œæ—¶å®ç° (Runtime Implementation)

åœ¨ `ModuleRuntime.make` å†…éƒ¨ï¼Œæˆ‘ä»¬ä¼šåº”ç”¨è¿™ä¸ª Enhancerï¼š

```ts
// ä¼ªä»£ç 
function make(initialState, options) {
  // 1. åŸå§‹çš„åº•å±‚æ“ä½œ
  let setState = (s) => stateRef.set(s)
  let dispatch = (a) => actionHub.publish(a)

  // 2. åº”ç”¨ä¸­é—´ä»¶é“¾
  if (options.enhancer) {
    const enhanced = options.enhancer({ setState, dispatch })
    setState = enhanced.setState
    dispatch = enhanced.dispatch
  }

  // 3. æš´éœ²ç»™å¤–éƒ¨çš„æ˜¯"å¢å¼ºå"çš„ç‰ˆæœ¬
  return {
    setState,
    dispatch,
    ...
  }
}
```

## 4. ç¤ºä¾‹ï¼šæŒä¹…åŒ–ä¸­é—´ä»¶

```ts
const PersistMiddleware = (config) => ({
  state: (next) => (state) => {
    // 1. å…ˆæ‰§è¡Œæ›´æ–°
    return next(state).pipe(
      // 2. åæ‰§è¡ŒæŒä¹…åŒ– (ä¸é˜»å¡ä¸»æµç¨‹)
      Effect.tap(() => Storage.set(config.key, state))
    )
  }
})
```

è¿™ç§è®¾è®¡æ—¢ä¿æŒäº†å†…æ ¸çš„çº¯å‡€ï¼Œåˆæä¾›äº†æ— é™çš„æ‰©å±•èƒ½åŠ›ã€‚
</file>

<file path="drafts/L9/matrix-acceptance-logix-support.md">
---
title: çŸ©é˜µéªŒæ”¶è¯¦æƒ…é¡µå¤æ‚é€»è¾‘çš„ Logix æ”¯æ’‘æ–¹æ¡ˆåˆ†æ
status: draft
version: 2025-12-02 (Refined)
priority: 1000
---

# çŸ©é˜µéªŒæ”¶è¯¦æƒ…é¡µå¤æ‚é€»è¾‘çš„ Logix æ”¯æ’‘æ–¹æ¡ˆåˆ†æ

## 1. èƒŒæ™¯ä¸ç—›ç‚¹åˆ†æ

åŸºäº `FORM_PAINPOINTS.md` çš„æ¢³ç†ï¼Œè¯¥æ¨¡å—ï¼ˆçŸ©é˜µéªŒæ”¶è¯¦æƒ…é¡µï¼‰çš„æ ¸å¿ƒå¤æ‚æ€§åœ¨äº**â€œéšå¼ä¾èµ–â€**ä¸**â€œé€»è¾‘åˆ†æ•£â€**ï¼Œå¯¼è‡´ç»´æŠ¤æˆæœ¬é«˜ã€å¯æµ‹è¯•æ€§å·®ã€‚

### 1.1 æ ¸å¿ƒç—›ç‚¹

1.  **å­—æ®µä¾èµ–å…³ç³»éšå¼åŒ–ã€è·¨å±‚çº§**
    *   **ç°è±¡**ï¼šä¿®æ”¹ä¸€ä¸ªå­—æ®µï¼ˆå¦‚â€œéªŒæ”¶äººâ€ï¼‰ï¼Œé€šè¿‡ Event Handler è§¦å‘ä¸€è¿ä¸²å‰¯ä½œç”¨ï¼ˆæŸ¥å›½å®¶ -> æ”¹ç»„ç»‡ -> æ”¹ä¸»ä½“ -> æ¸…ç©º/å›å¡«çŸ©é˜µæ˜ç»†ï¼‰ã€‚
    *   **é—®é¢˜**ï¼šä¾èµ–å…³ç³»â€œé•¿åœ¨ä»£ç é‡Œâ€ï¼Œæ— æ³•é€šè¿‡ Schema æˆ–é…ç½®ç›´è§‚çœ‹åˆ°ã€‚æ–°å¢å­—æ®µæ—¶å®¹æ˜“æ¼æ‰æ¸…ç©º/å›å¡«é€»è¾‘ã€‚
2.  **æ ¡éªŒè§„åˆ™ç¢ç‰‡åŒ–**
    *   **ç°è±¡**ï¼šæ ¡éªŒé€»è¾‘æ•£è½åœ¨ Form Item å±æ€§ã€Footer æäº¤å‡½æ•°ã€ä»¥åŠè‡ªå®šä¹‰ Hookï¼ˆå¦‚ `useShouldCheckUniqueInvoice`ï¼‰ä¸­ã€‚
    *   **é—®é¢˜**ï¼šæ— æ³•ä¸€çœ¼çœ‹æ¸…â€œæäº¤å‰åˆ°åº•è¦æ»¡è¶³å“ªäº›æ¡ä»¶â€ã€‚è§„åˆ™ä¸é…ç½®å¼ºç»‘å®šï¼Œä½†é…ç½®æ¥æºéšè”½ã€‚
3.  **åŠ¨æ€é€‰é¡¹ä¸ç¯å¢ƒä¾èµ–æ··ä¹±**
    *   **ç°è±¡**ï¼šä¸‹æ‹‰é€‰é¡¹ä¾èµ–å¤šä¸ªç»´åº¦ï¼ˆå›½å®¶ã€ç»„ç»‡ï¼‰ï¼Œè¿™äº›ç»´åº¦åœ¨ä¸åŒç»„ä»¶ä¸­è¢«é‡å¤è®¡ç®—ã€‚é€‰é¡¹åˆ·æ–°æœºåˆ¶ä¸ç»Ÿä¸€ï¼ˆæœ‰çš„æŒ‚è½½æ—¶æŸ¥ï¼Œæœ‰çš„ä¾èµ–å˜åŠ¨æŸ¥ï¼‰ã€‚
    *   **é—®é¢˜**ï¼šé€‰é¡¹æ¥æºä¸æ¸…æ™°ï¼Œç¯å¢ƒä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ä¼ é€’æ··ä¹±ã€‚

### 1.2 ç°çŠ¶ç¼–æ’æ¨¡å¼åˆ†æ

å½“å‰ä»£ç ä¸»è¦é‡‡ç”¨ **â€œUI ç»„ä»¶é©±åŠ¨ + æ•£ä¹± Hooksâ€** çš„ç¼–æ’æ¨¡å¼ï¼Œå…·ä½“è¡¨ç°ä¸ºï¼š

1.  **åŸºäº Event Handler çš„å‘½ä»¤å¼ç¼–æ’**
    *   ä¸šåŠ¡æµç¨‹è¢«æ‹†è§£ä¸ºä¸€ç³»åˆ—åˆ†æ•£çš„ Event Handlerã€‚
    *   **ç¤ºä¾‹**ï¼šâ€œä¿®æ”¹éªŒæ”¶äººâ€è¿™ä¸€åŠ¨ä½œï¼Œå®é™…ä¸Šæ˜¯ç”± `handleChangeReceiptUser` (BasicInfo) -> `handleOrgCountryChange` (BasicInfo) -> `handlePaymentOrgChange` (BasicInfo) -> `APIGetSupplierTaxNo` (Service) è¿™ä¸€æ¡éšå¼çš„è°ƒç”¨é“¾ç»„æˆçš„ã€‚
    *   **åæœ**ï¼šé˜…è¯»ä»£ç æ—¶å¿…é¡»æ‰‹åŠ¨è¿½è¸ªå‡½æ•°è°ƒç”¨æ ˆï¼Œæ— æ³•ç›´è§‚çœ‹åˆ°å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ã€‚

2.  **é€»è¾‘ç¢ç‰‡åŒ–åˆ†å¸ƒ**
    *   åŒä¸€ä¸ªä¸šåŠ¡è§„åˆ™çš„å®ç°å¾€å¾€è·¨è¶Šå¤šä¸ªæ–‡ä»¶å±‚çº§ã€‚
    *   **ç¤ºä¾‹**ï¼šâ€œå‘ç¥¨ä¸‰è¦ç´ å”¯ä¸€æ€§æ ¡éªŒâ€é€»è¾‘ï¼š
        *   **é…ç½®å±‚**ï¼šåœ¨ `hooks/useShouldCheckUniqueInvoice.tsx` ä¸­è·å–â€œéœ€è¦æ ¡éªŒçš„ä¸»ä½“åˆ—è¡¨â€ã€‚
        *   **è§¦å‘å±‚**ï¼šåœ¨ `components/Footer.tsx` çš„æäº¤å‡½æ•°ä¸­åˆ¤æ–­â€œå½“å‰ä¸»ä½“æ˜¯å¦åœ¨åˆ—è¡¨ä¸­â€ã€‚
        *   **æ‰§è¡Œå±‚**ï¼šåœ¨ `components/Footer.tsx` ä¸­éå†çŸ©é˜µæ•°æ®è¿›è¡ŒæŸ¥é‡ã€‚
        *   **è¡¨ç°å±‚**ï¼šåœ¨ `MatrixTable` çš„å•å…ƒæ ¼ä¸­æ§åˆ¶å¿…å¡«æ ·å¼ã€‚
    *   **åæœ**ï¼šä¿®æ”¹ä¸€ä¸ªè§„åˆ™éœ€è¦åŒæ—¶ç»´æŠ¤ 3-4 ä¸ªæ–‡ä»¶ï¼Œææ˜“æ¼æ”¹ã€‚

3.  **æ•°æ®æµä¸å‰¯ä½œç”¨æ··åˆ**
    *   æ•°æ®è·å–ï¼ˆQueryï¼‰ä¸å‰¯ä½œç”¨ï¼ˆSide Effectï¼‰è€¦åˆåœ¨ç»„ä»¶æ¸²æŸ“æˆ– Handler ä¸­ã€‚
    *   **ç¤ºä¾‹**ï¼šä¸‹æ‹‰é€‰é¡¹çš„è·å–é€»è¾‘ï¼ˆ`useQuery`ï¼‰ç›´æ¥å†™åœ¨ç»„ä»¶ä½“å†…ï¼Œä¸”ä¾èµ–é¡¹ï¼ˆå¦‚ `currentCountry`ï¼‰åœ¨å¤šä¸ªç»„ä»¶ä¸­é‡å¤è®¡ç®—ï¼Œå¯¼è‡´â€œé€‰é¡¹åˆ·æ–°â€ä¸â€œå­—æ®µå˜æ›´â€çš„æ—¶åºéš¾ä»¥é¢„æµ‹ã€‚

### 1.3 ä¸ºä»€ä¹ˆéš¾ç»´æŠ¤

*   **ç¼ºä¹ç»Ÿä¸€è§†å›¾**ï¼šæ²¡æœ‰ä¸€ä¸ªåœ°æ–¹èƒ½å®Œæ•´æè¿°â€œè¿™ä¸ªè¡¨å•çš„è¡Œä¸ºâ€ã€‚
*   **å‰¯ä½œç”¨éš¾ä»¥è¿½è¸ª**ï¼šHandler æ¨¡å¼å¯¼è‡´å‰¯ä½œç”¨æ»¡å¤©é£ï¼Œå¾ˆéš¾é¢„æµ‹æ”¹ä¸€ä¸ªå­—æ®µä¼šå½±å“å“ªé‡Œã€‚
*   **æµ‹è¯•å›°éš¾**ï¼šé€»è¾‘ä¸ UI ç»„ä»¶å¼ºè€¦åˆï¼Œéš¾ä»¥è¿›è¡Œçº¯é€»è¾‘å•å…ƒæµ‹è¯•ã€‚

---

## 2. Logix è¯¦ç»†å®ç°èŒƒå¼

æœ¬èŠ‚å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Logix å°†ä¸Šè¿°åˆ†æ•£çš„é€»è¾‘é‡æ„ä¸ºå†…èšçš„æ¨¡å—ã€‚

### 2.1 å®šä¹‰æ¨¡å—ä¸å“åº”å¼çŠ¶æ€ (Module & Reactive Schema)

é¦–å…ˆå®šä¹‰æ¨¡å—ç»“æ„ï¼Œå°†å­—æ®µä¾èµ–å’ŒåŠ¨æ€é€‰é¡¹ä¸‹æ²‰åˆ° Schema å®šä¹‰ä¸­ã€‚åˆ©ç”¨ `Reactive.computed` å’Œ `Reactive.async` æ˜¾å¼å£°æ˜æ•°æ®ä¾èµ–ã€‚

```typescript
// 1. å®šä¹‰ Schema
const MatrixRowSchema = Schema.Struct({
  id: Schema.String,
  stationCode: Schema.String,
  deptId: Schema.String,
  feeType: Schema.String,
  invoiceNo: Schema.String,
  invoiceSerial: Schema.String,
  chaveKey: Schema.String,
  // ...å…¶ä»–å­—æ®µ
})

const MatrixStateSchema = Schema.Struct({
  // åŸºç¡€å­—æ®µ (Source of Truth)
  receiptUserCode: Schema.String,
  applicationOrgId: Schema.String,
  paymentOrgId: Schema.String,
  departmentId: Schema.String, // æ–°å¢ï¼šéƒ¨é—¨ID
  batchReceiptDetailDTOList: Schema.Array(MatrixRowSchema),

  // æ´¾ç”Ÿå­—æ®µ / å¼‚æ­¥èµ„æºåªåœ¨è¿™é‡Œå£°æ˜å½¢çŠ¶ï¼Œä¸ç›´æ¥å†™é€»è¾‘
  // currentCountry / accountingUnit ç­‰å­—æ®µç”± Module.reactive è´Ÿè´£ç»´æŠ¤
  currentCountry: Schema.String,
  accountingUnit: Schema.String,

  // é€‰é¡¹åˆ—è¡¨é€šå¸¸æ˜¯ã€Œå¯åŠ è½½èµ„æºã€ï¼Œè¿™é‡Œç”¨ Any å ä½ï¼Œå®é™…å®ç°å¯ä»¥ç”¨ Schema.Loadable ç­‰å®¹å™¨
  expenseItemOptions: Schema.Any,
  vendorOptions: Schema.Any,
})

// 2. å®šä¹‰ Moduleï¼ˆç”¨ Module.reactive æ‰¿è½½ Reactive / Query é€»è¾‘ï¼‰
export const MatrixAcceptanceModule = Logix.Module('MatrixAcceptance', {
  state: MatrixStateSchema,
  actions: {
    'user/change': Schema.String, // ä¿®æ”¹éªŒæ”¶äºº
    'department/change': Schema.String, // ä¿®æ”¹éƒ¨é—¨
    'submit': Schema.Void
  },

  reactive: {
    // è®¡ç®—å­—æ®µ (Computed Fields) - è§£å†³éšå¼ä¾èµ–
    // ç¤ºä¾‹ï¼šå½“å‰å›½å®¶æ€»æ˜¯ç”±ç”³è¯·ç»„ç»‡å†³å®š
    currentCountry: Reactive.computed((s) => {
      const org = findOrgById(s.applicationOrgId)
      return org?.country || ''
    }),

    // ç¤ºä¾‹ï¼šæ ¸ç®—å•å…ƒä¾èµ–äºéƒ¨é—¨å’Œå›½å®¶
    accountingUnit: Reactive.computed((s) => {
      if (!s.departmentId) return ''
      // å‡è®¾è¿™é‡Œæœ‰å¤æ‚çš„è®¡ç®—é€»è¾‘
      return calculateAccountingUnit(s.departmentId, s.currentCountry) ?? ''
    }),

    // å¼‚æ­¥èµ„æº (Async Resources) - è§£å†³åŠ¨æ€é€‰é¡¹æ··ä¹±
    // ç¤ºä¾‹ï¼šè´¹ç”¨ç±»å‹é€‰é¡¹ä¾èµ–äºå›½å®¶ï¼Œè‡ªåŠ¨å“åº” currentCountry å˜åŒ–
    expenseItemOptions: Reactive.async(async (get) => {
      const country = get('currentCountry')
      if (!country) return []
      return await fetchExpenseItems(country)
    }),

    // ç¤ºä¾‹ï¼šä¾›åº”å•†é€‰é¡¹ä¾èµ–äºç½‘ç‚¹
    vendorOptions: Reactive.async(async (get) => {
      const station = get('stationCode') // å‡è®¾ state ä¸­æœ‰ stationCode
      if (!station) return []
      return await fetchVendors(station)
    }),
  },
})
```

### 2.2 å°è£…ä¸šåŠ¡æµ (Logic Flow)

ä½¿ç”¨ `Module.logic` å®šä¹‰ç‹¬ç«‹çš„ä¸šåŠ¡é€»è¾‘å•å…ƒã€‚

#### åœºæ™¯ A: ä¿®æ”¹éªŒæ”¶äºº (çº§è”æ›´æ–°)

å°†â€œä¿®æ”¹éªŒæ”¶äºº -> æŸ¥å›½å®¶ -> æ”¹ç»„ç»‡ -> æ”¹ä¸»ä½“ -> æ¸…ç©ºæ˜ç»†â€è¿™ä¸€é•¿é“¾æ¡å°è£…ä¸ºä¸€ä¸ªåŸå­ Logicã€‚

```typescript
// å®šä¹‰å†…éƒ¨å¤ç”¨çš„ Effect (é Logicï¼Œä»…ä½œä¸ºåŸå­èƒ½åŠ›)
const clearMatrixFields = ($: any) => Effect.gen(function* () {
  yield* $.state.update(s => {
    const newList = s.batchReceiptDetailDTOList.map(item => ({
      ...item,
      stationCode: '',
      deptId: '',
      feeType: ''
    }))
    return { ...s, batchReceiptDetailDTOList: newList }
  })
})

// å®šä¹‰ä¿®æ”¹éªŒæ”¶äºº Logic
const ChangeReceiptUserLogic = MatrixAcceptanceModule.logic(($) =>
  Effect.gen(function* () {
    // ç›‘å¬ 'user/change' Action
    yield* $.onAction('user/change').run(function* (userCode) {
      // 1. è·å–ç”¨æˆ·å›½å®¶ (API è°ƒç”¨)
      const country = yield* APIGetOptionsUserCountry({ userCode })
      if (!country) return

      // 2. è®¡ç®—å…³è”å­—æ®µ (çº¯é€»è¾‘)
      const org = findOrgByCountry(country)
      const entity = findEntityByCountry(country)

      // 3. åŸå­æ›´æ–°çŠ¶æ€
      yield* $.state.update(s => ({
        ...s,
        receiptUserCode: userCode,
        applicationOrgId: org?.value,
        paymentOrgId: entity?.value
      }))

      // 4. æ‰§è¡Œå‰¯ä½œç”¨ (æ¸…ç©ºæ˜ç»†)
      yield* clearMatrixFields($)
    })
  })
)
```

#### åœºæ™¯ B: ä¿®æ”¹éƒ¨é—¨ (å¤æ‚è”åŠ¨)

å‡è®¾ä¿®æ”¹éƒ¨é—¨ä¼šå½±å“æ ¸ç®—å•å…ƒï¼Œå¹¶ä¸”å¦‚æœéƒ¨é—¨ä¸åœ¨ HRMS æ ‘ä¸Šï¼Œéœ€è¦ç½®ç©ºã€‚

```typescript
const ChangeDepartmentLogic = MatrixAcceptanceModule.logic(($) =>
  Effect.gen(function* () {
    yield* $.onAction('department/change').run(function* (deptId) {
      // 1. æ ¡éªŒéƒ¨é—¨æœ‰æ•ˆæ€§
      const isValid = yield* CheckDepartmentValid(deptId)

      yield* $.state.update(s => {
          const updates: any = { departmentId: deptId }

          // 2. æ ¹æ®è§„åˆ™é‡ç½®æ ¸ç®—å•å…ƒ (è™½ç„¶ Schema ä¸­æœ‰ computedï¼Œä½†æœ‰æ—¶éœ€è¦æ˜¾å¼é‡ç½® override)
          if (!isValid) {
              updates.accountingUnit = null
          }

          return { ...s, ...updates }
      })
    })
  })
)
```

### 2.3 ç»Ÿä¸€æ ¡éªŒ (Unified Validation)

å°†æ ¡éªŒé€»è¾‘å°è£…åœ¨ `SubmitLogic` ä¸­ï¼Œä½œä¸ºæäº¤æµç¨‹çš„ä¸€éƒ¨åˆ†ã€‚

```typescript
// æ ¡éªŒ Effect
const ValidateInvoiceLogic = MatrixAcceptanceModule.logic(($) =>
  Effect.gen(function* () {
    const { paymentOrgId, batchReceiptDetailDTOList } = yield* $.state.read

    // 1. è·å–åŠ¨æ€é…ç½® (æ˜¯å¦éœ€è¦æ ¡éªŒ)
    const config = yield* APIGetOptionsValue(['invoicePaymentOrgIdList'])
    const shouldCheck = config.includes(paymentOrgId)

    if (!shouldCheck) return true

    // 2. æ‰§è¡Œæ ¸å¿ƒæ ¡éªŒé€»è¾‘
    const errors = []
    const map = new Map()

    batchReceiptDetailDTOList.forEach((row, index) => {
      const combo = `${row.invoiceNo}-${row.invoiceSerial}-${row.chaveKey}`
      if (map.has(combo)) {
        errors.push({ index, message: 'å‘ç¥¨ä¸‰è¦ç´ é‡å¤' })
      }
      map.set(combo, true)
    })

    // 3. ç»Ÿä¸€æŠ›å‡ºé”™è¯¯ (UI å±‚é€šè¿‡ lifecycle.onError æ•è·å¹¶å±•ç¤º)
    if (errors.length > 0) {
      yield* $.lifecycle.notifyError({ type: 'Validation', errors })
      return false
    }
    return true
  })
)

// æäº¤ Logic
const SubmitLogic = MatrixAcceptanceModule.logic(($) =>
  Effect.gen(function* () {
    yield* $.onAction('submit').run(function* () {
      // ç¼–æ’æ ¡éªŒä¸æäº¤
      const isValid = yield* ValidateInvoiceLogic($) // æ³¨æ„ï¼šè¿™é‡Œå‡è®¾ ValidateInvoiceLogic æš´éœ²äº† invoke æ–¹æ³•æˆ–ä½œä¸ºæ™®é€š Effect å¤ç”¨
      if (!isValid) return

      // yield* submitData($)
    })
  })
)
```

### 2.4 æ¨¡å—ç»„è£… (Module Implementation)

æœ€åï¼Œåœ¨ `Module.make` ä¸­è£…è½½è¿™äº› Logicã€‚

```typescript
export const MatrixAcceptanceImpl = MatrixAcceptanceModule.make({
  initial: {
    receiptUserCode: '',
    applicationOrgId: '',
    paymentOrgId: '',
    departmentId: '',
    batchReceiptDetailDTOList: [],
    // ...
  },
  logics: [
    ChangeReceiptUserLogic,
    ChangeDepartmentLogic,
    SubmitLogic
  ]
})
```

---

## 3. UI é›†æˆ (UI Integration)

åœ¨ React å±‚ï¼Œæˆ‘ä»¬ä¸å†æ‰‹åŠ¨ç®¡ç† State å’Œ Effectï¼Œè€Œæ˜¯ç›´æ¥æ¶ˆè´¹ Moduleã€‚

### 3.1 æ¥å…¥ Module

```tsx
// pages/MatrixAcceptance/index.tsx
import { useModule } from '@logix/react'
import { MatrixAcceptanceImpl } from './model'

export const MatrixAcceptancePage = () => {
  // 1. åˆå§‹åŒ–æ¨¡å—
  const { state, actions } = useModule(MatrixAcceptanceImpl)

  // 2. æ¶ˆè´¹å“åº”å¼æ•°æ® (è‡ªåŠ¨è§£åŒ… Reactive.async)
  const { expenseItemOptions } = state

  return (
    <Form>
      <BasicInfoSection
        state={state}
        onChangeUser={(val) => actions['user/change'](val)}
      />

      <MatrixTable
        data={state.batchReceiptDetailDTOList}
        expenseOptions={expenseItemOptions.value} // ç›´æ¥ä½¿ç”¨ Async æ•°æ®
        loading={expenseItemOptions.loading}
      />

      <Footer onSave={() => actions['submit']()} />
    </Form>
  )
}
```

### 3.2 ä¼˜åŠ¿

1.  **UI çº¯ç²¹åŒ–**ï¼šç»„ä»¶åªè´Ÿè´£æ¸²æŸ“ `state` å’Œè§¦å‘ `actions`ï¼Œä¸å†åŒ…å« `useEffect` æˆ–å¤æ‚çš„ `handleXxx` é€»è¾‘ã€‚
2.  **ç±»å‹å®‰å…¨**ï¼š`state` å’Œ `actions` å‡ç”± Schema è‡ªåŠ¨æ¨å¯¼ï¼Œé‡æ„æ—¶æœ‰ TS æŠ¥é”™ä¿éšœã€‚
3.  **æ€§èƒ½ä¼˜åŒ–**ï¼šLogix å†…éƒ¨é€šè¿‡ç»†ç²’åº¦è®¢é˜…ç®¡ç†æ¸²æŸ“æ›´æ–°ï¼Œé¿å… Context å¯¼è‡´çš„æ•´æ ‘é‡ç»˜ã€‚

---

## 4. è¿ç§»ç­–ç•¥ (Migration Strategy)

è€ƒè™‘åˆ°è¯¥é¡µé¢é€»è¾‘å¤æ‚ï¼Œå»ºè®®é‡‡ç”¨ **"ç»æ€è€…æ¨¡å¼" (Strangler Fig Pattern)** åˆ†æ­¥è¿ç§»ã€‚

### Phase 1: çŠ¶æ€æ¥ç®¡ (State Takeover)
*   **ç›®æ ‡**ï¼šå¼•å…¥ Logix Module ä½œä¸º State Holderï¼Œä½†ä¿ç•™ç°æœ‰çš„ Event Handlersã€‚
*   **åšæ³•**ï¼š
    1.  åˆ›å»º `MatrixAcceptanceModule`ï¼Œå®šä¹‰å®Œæ•´çš„ State Schemaã€‚
    2.  åœ¨ React ç»„ä»¶ä¸­ `useModule`ã€‚
    3.  å°†åŸæœ‰çš„ `useState` æ›¿æ¢ä¸º `module.state`ã€‚
    4.  åœ¨ç°æœ‰çš„ `handleXxx` ä¸­è°ƒç”¨ `module.state.update` æ›´æ–°æ•°æ®ã€‚
*   **æ”¶ç›Š**ï¼šç»Ÿä¸€äº†çŠ¶æ€æºï¼Œè§£å†³äº† Context ä¼ é€’æ··ä¹±çš„é—®é¢˜ã€‚

### Phase 2: é€»è¾‘ä¸‹æ²‰ (Logic Sinking)
*   **ç›®æ ‡**ï¼šå°† Event Handlers ä¸­çš„ä¸šåŠ¡é€»è¾‘é€æ­¥ç§»åŠ¨åˆ° `Module.logic`ã€‚
*   **åšæ³•**ï¼š
    1.  æŒ‘é€‰ä¸€ä¸ªå¤æ‚çš„ Handlerï¼ˆå¦‚ `handleChangeReceiptUser`ï¼‰ã€‚
    2.  åœ¨ Module ä¸­å®šä¹‰å¯¹åº”çš„ Action (`user/change`) å’Œ Logicã€‚
    3.  å°† Handler å†…å®¹é‡æ„ä¸º Effect ä»£ç ã€‚
    4.  åœ¨ UI ä¸­å°† Handler æ›¿æ¢ä¸º `actions['user/change']`ã€‚
*   **æ”¶ç›Š**ï¼šé€»è¾‘å¼€å§‹å†…èšï¼Œå‰¯ä½œç”¨å¯è¿½è¸ªã€‚

### Phase 3: å“åº”å¼é‡æ„ (Reactive Refactoring)
*   **ç›®æ ‡**ï¼šåˆ©ç”¨ `Module.reactive`ï¼ˆå†…éƒ¨åŸºäº `Reactive.computed` / `Reactive.async` ç­‰ï¼‰æ¶ˆé™¤æ‰‹åŠ¨ç»´æŠ¤çš„å‰¯ä½œç”¨ã€‚
*   **åšæ³•**ï¼š
    1.  è¯†åˆ« `useEffect` ä¸­ç”¨äºåŒæ­¥æ•°æ®çš„ä»£ç ï¼ˆå¦‚ `useEffect(() => fetchOptions(country), [country])`ï¼‰ã€‚
    2.  å°†å…¶è¿ç§»ä¸º Module å®šä¹‰ä¸­çš„ `reactive` é…ç½®ï¼ˆä¾‹å¦‚ `expenseItemOptions: Reactive.async(...)`ï¼‰ã€‚
    3.  åˆ é™¤å¯¹åº”çš„ `useEffect`ã€‚
*   **æ”¶ç›Š**ï¼šä»£ç é‡å¤§å¹…å‡å°‘ï¼Œé€»è¾‘å®Œå…¨å£°æ˜å¼ã€‚

## 5. æ€»ç»“

ä½¿ç”¨ Logix é‡æ„è¯¥æ¨¡å—çš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼š**å°†â€œéšå¼ã€åˆ†æ•£çš„ UI é€»è¾‘â€è½¬åŒ–ä¸ºâ€œæ˜¾å¼ã€é›†ä¸­çš„é¢†åŸŸé€»è¾‘â€**ã€‚

*   **Before**: é€»è¾‘æ•£è½åœ¨ Handlerã€Hookã€Render ä¸­ï¼Œé è„‘è¡¥æ‹¼å‡‘ã€‚
*   **After**: é€»è¾‘æ²‰æ·€åœ¨ Schema (ä¾èµ–å…³ç³»)ã€Flow (ä¸šåŠ¡æµç¨‹)ã€Module (æ•´ä½“å°è£…) ä¸­ï¼Œä»£ç å³æ–‡æ¡£ã€‚
</file>

<file path="drafts/L9/module-runtime-adapter-and-customization.md">
---
title: ModuleRuntime é€‚é…ä¸è‡ªå®šä¹‰æ‰©å±•ç‚¹ï¼ˆè§„åˆ’è‰ç¨¿ï¼‰
status: superseded
version: 2025-11-30T00:00:00.000Z
superseded_by: ../L5/runtime-core-evolution.md
priority: 1100
---

## èƒŒæ™¯ä¸åŠ¨æœº

- å½“å‰ Logix çš„è¿è¡Œæ—¶â€œå¿ƒè„â€æ˜¯ `Logix.ModuleRuntime<S, A>`ï¼Œæ ‡å‡†å®ç°é€šè¿‡ `ModuleRuntime.make` + `Module.live` æä¾›ï¼š
  - æœ¬åœ°çŠ¶æ€ â†’ `SubscriptionRef`ï¼›
  - Action é€šé“ â†’ `PubSub` + `actions$`ï¼›
  - Logic æŒ‚è½½ â†’ åœ¨ Scope å†… `forkScoped` ä¸€ç»„ `Logic.Of`ã€‚
- åœ¨ä¸€äº›æ›´å¤æ‚çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è®© Logix çš„ Logic/Flow è¿è¡Œåœ¨â€œéæœ¬åœ° Storeâ€ä¹‹ä¸Šï¼Œä¾‹å¦‚ï¼š
  - å·²å­˜åœ¨çš„è¿œç¨‹çŠ¶æ€æœº / åç«¯æ¨é€ Storeï¼ˆåªè¯»æˆ–éƒ¨åˆ†å¯å†™ï¼‰ï¼›
  - æ—¢æœ‰å‰ç«¯çŠ¶æ€ç®¡ç†åº“ï¼ˆRedux / Zustand ç­‰ï¼‰ï¼›
  - å¸¦æ—¶é—´æ—…è¡Œ / å½•åˆ¶ / æŒä¹…åŒ–ç­‰èƒ½åŠ›çš„è°ƒè¯• / æµ‹è¯•ç¯å¢ƒã€‚
- ç›®å‰åœ¨å®ç°å±‚å¯ä»¥ç›´æ¥æ‰‹å†™ `ModuleRuntime<S, A>` æˆ–é€šè¿‡ `Layer<ModuleRuntime<S, A>, E, R>` æ³¨å…¥ï¼Œä½†è¿™å¯¹é€‚é…ä½œè€…æ¯”è¾ƒåº•å±‚ï¼Œç¼ºä¹ç»Ÿä¸€çš„å°è£…ä¸çº¦æŸã€‚

æœ¬è‰ç¨¿å°è¯•è§„åˆ’ä¸€å¥—â€œå¯¹é€‚é…ä½œè€…å‹å¥½â€çš„ ModuleRuntime æ‰©å±•å½¢æ€ï¼ŒåŒæ—¶ç¡®ä¿ï¼š

- è§„åˆ’å±‚ï¼ˆspecï¼‰â†’ PoC ç±»å‹è‰æ¡ˆ â†’ å®é™…å®ç°æºç  ä¸‰å±‚å¯¹é½ï¼›
- æ™®é€šä¸šåŠ¡å·¥ç¨‹å¸ˆä»ç„¶åªéœ€è¦ `Module` / `Module.logic` / `Module.live`ï¼Œä¸ä¼šè¢« Runtime ç»†èŠ‚æ‰“æ‰°ã€‚

## ç›®æ ‡ä¸éç›®æ ‡

**ç›®æ ‡**

- åœ¨ runtime-logix ä½“ç³»å†…ï¼Œæ˜ç¡®ä¸€æ¡â€œè‡ªå®šä¹‰ ModuleRuntimeâ€çš„æ¨èè·¯å¾„ï¼Œé€‚ç”¨äºï¼š
  - è¿œç¨‹ Store / æ—¢æœ‰çŠ¶æ€æœºé€‚é…ï¼›
  - æµ‹è¯• / è°ƒè¯•ä¸“ç”¨ Runtimeï¼ˆæ—¶é—´æ—…è¡Œã€å½•åˆ¶ã€å›æ”¾ï¼‰ï¼›
  - ç‰¹æ®Šå¹³å°çš„æŒä¹…åŒ– / æ‡’åŠ è½½ Runtimeã€‚
- ç»™å‡ºä¸€ä¸ªä¸­é—´å±‚æŠ½è±¡ï¼ˆAdapter å½¢æ€ï¼‰ï¼Œé¿å…æ¯ä¸ªé€‚é…ä½œè€…éƒ½ä»é›¶å®ç°å®Œæ•´çš„ `ModuleRuntime` æ¥å£ã€‚
- åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯­ä¹‰ä¸å˜å¼å’Œæ‰©å±•è¾¹ç•Œï¼Œé˜²æ­¢ä¸šåŠ¡æ¨¡å—æ»¥ç”¨ Runtime æ‰©å±•ç‚¹ã€‚

**éç›®æ ‡**

- ä¸æŠŠ Runtime æ‰©å±•ç‚¹æš´éœ²ä¸ºä¸šåŠ¡æ—¥ç”¨ APIï¼›
  ä¸šåŠ¡å±‚ä»ä»¥ `Module.live` / `Logix.app` / React hooks ä¸ºä¸»ï¼Œä¸ç›´æ¥æ“ä½œ `ModuleRuntime`ã€‚
- ä¸åœ¨è¿™ä¸€è½®å¼•å…¥å¤šç§ Runtime å˜ä½“çš„â€œè¿è¡Œæ—¶æ’ä»¶ç³»ç»Ÿâ€ï¼›æœ¬æ¬¡ä»…æä¾›é€‚é…/å°è£…èƒ½åŠ›ã€‚

## æ ¸å¿ƒè®¾è®¡è‰æ¡ˆ

### 1. ModuleRuntime è¯­ä¹‰ä¸å˜å¼ï¼ˆå·²å†™å…¥ core/05ï¼‰

åœ¨ `docs/specs/runtime-logix/core/05-runtime-implementation.md` ä¸­ï¼Œå·²ç»è¡¥å……äº†ï¼š

- `ModuleRuntime<S, A>` å¯ä»¥è¢«æ›¿æ¢/è‡ªå®šä¹‰ï¼Œä½†å¿…é¡»æ»¡è¶³ï¼š
  - `getState` / `setState`ï¼šå•ä¸€ä¸€è‡´ State æ ‘ï¼Œ`setState` ååç»­ `getState` / `changes` å¯è§ï¼›
  - `dispatch` / `actions$`ï¼šæ‰€æœ‰ç» `dispatch` æ´¾å‘çš„ Action ä»¥æ­£ç¡®é¡ºåºå‡ºç°åœ¨ `actions$` ä¸­ï¼›
  - `changes(selector)`ï¼šæ˜¯åŸºäº State çš„è§†å›¾å˜åŒ–æµï¼Œè€Œä¸æ˜¯ä»»æ„äº‹ä»¶æµï¼›
  - `ref()`ï¼šæä¾› `SubscriptionRef` è§†å›¾ï¼Œæ— æ³•æä¾› selector å˜ä½“æ—¶è‡³å°‘è¦ä¿è¯â€œæ•´æ£µ State çš„ Refâ€æ­£ç¡®ã€‚

è¯¥çº¦æŸå·²ç»ä½œä¸º Runtime å±‚çš„â€œå¥‘çº¦è¾¹ç•Œâ€å›ºåŒ–ä¸‹æ¥ï¼Œåç»­æ‰©å±•å¿…é¡»éµå®ˆã€‚

### 2. Adapter å½¢æ€ï¼šRuntimeAdapter â†’ ModuleRuntime

ä¸ºé™ä½é€‚é…é—¨æ§›ï¼Œè§„åˆ’ä¸€ä¸ªä¸­é—´å±‚æŠ½è±¡ï¼ˆç¤ºæ„ï¼‰ï¼š

```ts
interface RuntimeAdapter<S, A> {
  getState: Effect.Effect<S>
  setState?: (s: S) => Effect.Effect<void>
  actions$: Stream.Stream<A>
  changes$?: Stream.Stream<S>
}

namespace ModuleRuntime {
  export function fromAdapter<S, A>(
    adapter: RuntimeAdapter<S, A>,
  ): Logix.ModuleRuntime<S, A> { /* impl in runtime-logix/impl */ }
}
```

è®¾è®¡æ„å›¾ï¼š

- é€‚é…ä½œè€…å…³æ³¨â€œå¦‚ä½•ä»å¤–éƒ¨ç³»ç»Ÿè¯»/å†™çŠ¶æ€ã€ç›‘å¬ action/state æµâ€ï¼Œå…¶ä½™ç”± `fromAdapter` è¡¥é½ï¼š
  - è‹¥åªæä¾› `actions$`ï¼Œ`dispatch` å¯ä»¥ç”±é€‚é…å±‚å°è£…ï¼ˆä¾‹å¦‚å¾€å¤–éƒ¨ EventBus å†™ï¼‰ï¼›
  - è‹¥åªæä¾› `changes$`ï¼Œå¯ä»¥åœ¨å†…éƒ¨å åŠ  `distinctUntilChanged`ã€selector æŠ•å½±ç­‰ï¼›
  - `ref()` å¯ä»¥ç»Ÿä¸€åŸºäº `SubscriptionRef` å°è£…ï¼Œé¿å…å„è‡ªä¸ºæ”¿ã€‚
- `fromAdapter` çš„å…·ä½“å®ç°æ”¾åœ¨ runtime-logix å®ç°å±‚ï¼ˆ`docs/specs/runtime-logix/impl` + `packages/logix-core` æˆ–ä¸“ç”¨å­åŒ…ï¼‰ï¼Œä¾›å¹³å°/é€‚é…ä½œè€…ä½¿ç”¨ã€‚

### 3. æä¾›è·¯å¾„ï¼šModule + Logix.app

è§„åˆ’å¯¹å¤–æ¨èçš„ä½¿ç”¨æ–¹å¼ï¼š

1. å¯¹äºâ€œæ ‡å‡†æœ¬åœ° Storeâ€ï¼š
   - ä½¿ç”¨ `Logix.Module('Id', { state, actions })` + `Module.logic` + `Module.live(initial, ...logics)`ï¼›
   - åœ¨ `Logix.app` ä¸­é€šè¿‡ `Module.live` è¿”å›çš„ Layer æä¾› Runtimeã€‚
2. å¯¹äºâ€œè‡ªå®šä¹‰ Runtime / è¿œç¨‹ Store é€‚é…â€ï¼š
   - ç”±é€‚é…å±‚å®ç° `RuntimeAdapter<S, A>` + `ModuleRuntime.fromAdapter`ï¼Œå¾—åˆ° `ModuleRuntime<S, A>`ï¼›
   - é€šè¿‡ `Logix.provide(Module, runtime)` æˆ–ç»„è£…æˆ Layer åæ³¨å…¥åˆ° `Logix.app`ï¼›
   - ä¸šåŠ¡ Logic ä»é€šè¿‡ `Module.logic(($) => ...)` / Bound API `$` ç¼–æ’ï¼Œä¸æ„ŸçŸ¥åº•å±‚ Runtime å·®å¼‚ã€‚

## åˆ†å±‚è½åœ°è®¡åˆ’

1. **è§„åˆ’å±‚ï¼ˆç°é˜¶æ®µï¼Œæœ¬è‰ç¨¿ï¼‰**
   - å·²åœ¨ `core/05-runtime-implementation.md` ä¸­å¢åŠ ã€Œ1.3 æ‰©å±•ç‚¹ï¼šè‡ªå®šä¹‰ ModuleRuntime çš„è¾¹ç•Œã€ï¼Œæ˜ç¡®å¥‘çº¦ä¸åˆæ³•ç”¨ä¾‹ï¼›
   - æœ¬è‰ç¨¿ä½œä¸ºå¯¹æ­¤æ‰©å±•ç‚¹çš„æ›´å…·ä½“è®¾è®¡è‰ç¨¿ï¼Œæè¿° Adapter å½¢æ€ä¸æä¾›è·¯å¾„ã€‚
2. **PoC ç±»å‹å±‚**
   - åœ¨ `docs/specs/intent-driven-ai-coding/v3/effect-poc/shared/logix-v3-core.ts` ä¸­é¢„ç•™ `ModuleRuntime.fromAdapter` çš„ç±»å‹å ä½ï¼ˆä»…ç±»å‹ï¼Œä¸å®ç°ï¼‰ï¼›
   - æˆ–åœ¨ `runtime-logix/impl` æ–‡æ¡£ä¸­ç»™å‡ºä¼ªä»£ç çº§å®ç°è‰å›¾ï¼›
   - è¡¥ä¸€ä¸ªç®€çŸ­çš„ demoï¼šä¾‹å¦‚â€œåŸºäºå¤–éƒ¨ EventBus çš„åªè¯» ModuleRuntimeâ€æˆ–â€œè®°å½•æ‰€æœ‰ actions çš„ TestRuntimeâ€ã€‚
3. **å®ç°æºç å±‚**
   - åœ¨ `packages/logix-core` æˆ–æœªæ¥çš„ `@logix/runtime-extensions` åŒ…ä¸­ï¼Œå®ç° `ModuleRuntime.fromAdapter`ï¼›
   - è¡¥å……é’ˆå¯¹ Adapter Runtime çš„æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯ï¼š
     - `actions$` é¡ºåºæ€§ï¼›
     - `changes(selector)` çš„ selector è¯­ä¹‰ï¼›
     - ä¸ `BoundApi` / `$.flow` / `Link` ç­‰èƒ½åŠ›çš„åä½œã€‚

## ä¸ä¸šåŠ¡å¼€å‘è€…çš„è¾¹ç•Œ

- æ˜ç¡®ï¼š`ModuleRuntime` / `RuntimeAdapter` / `fromAdapter` å±äºâ€œå¼•æ“/é€‚é…å±‚ APIâ€ï¼Œé»˜è®¤ä¸å‡ºç°åœ¨ä¸šåŠ¡å¼€å‘æ–‡æ¡£ä¸­ï¼›
- ä¸šåŠ¡å¼€å‘è€…åªéœ€è¦ï¼š
  - å®šä¹‰ Moduleï¼š`Logix.Module`ï¼›
  - ç¼–å†™ Logicï¼š`Module.logic(($)=>...)`ï¼›
  - é€šè¿‡ `Module.live` / `Logix.app` / React Adapter ä½¿ç”¨è¿è¡Œæ—¶ï¼›
  - å¦‚éœ€ç‰¹æ®Š Runtimeï¼Œç”±å¹³å°/é€‚é…å›¢é˜Ÿæä¾›å¯¹åº”çš„ Module å°è£…ï¼ˆå¯¹ä¸šåŠ¡é€æ˜ï¼‰ã€‚

## å¾…å†³é—®é¢˜ / TODO

- Adapter æ¥å£çš„æœ€å°å½¢çŠ¶æ˜¯å¦è¶³å¤Ÿï¼š
  - æ˜¯å¦éœ€è¦ä¸ºâ€œåªè¯» Runtimeâ€æä¾›å•ç‹¬çš„æ ‡è®°æˆ–çº¦æŸï¼›
  - æ˜¯å¦éœ€è¦æ”¯æŒâ€œlazy åˆå§‹åŒ–â€/â€œæŒ‰éœ€æŒ‚è½½â€ã€‚
- `ModuleRuntime.fromAdapter` åº”æ”¾åœ¨å“ªä¸ªåŒ…ï¼š
  - ç›´æ¥æ”¾åœ¨ `@logix/core`ï¼›
  - è¿˜æ˜¯æ”¾åœ¨ `@logix/runtime-ext` è¿™ç±»æ‰©å±•åŒ…ï¼Œä»¥ä¿æŒæ ¸å¿ƒåŒ…ç²¾ç®€ã€‚
- æ˜¯å¦éœ€è¦åœ¨ Intent/Universe è§†è§’ä¸­æ ‡è®°â€œéæ ‡å‡† Runtimeâ€çš„ Moduleï¼Œä»¥ä¾¿å¹³å°åšå·®å¼‚åŒ–å¯è§‚æµ‹æ€§ï¼ˆä¾‹å¦‚æç¤ºâ€œè¯¥ Store æ¥è‡ªè¿œç¨‹ç³»ç»Ÿâ€ï¼‰ã€‚
</file>

<file path="drafts/L9/page-level-module-state-retention.md">
---
title: Page Level Module State Retention
status: draft
version: 1.0.0
authors:
  - User
  - Agent
priority: 1200
---

# Page Level Module State Retention (é¡µé¢çº§æ¨¡å—çŠ¶æ€ä¿æŒ)

> **èƒŒæ™¯**ï¼šç”¨æˆ·åé¦ˆåœ¨åå°ç®¡ç†ç³»ç»Ÿï¼ˆAdminï¼‰ç­‰åœºæ™¯ä¸­ï¼Œå­˜åœ¨å¤§é‡ï¼ˆç”šè‡³æ•°ç™¾ä¸ªï¼‰â€œé¡µé¢çº§â€æ¨¡å—ã€‚è¿™äº›æ¨¡å—åœ¨è·¯ç”±åˆ‡æ¢æ—¶ï¼ˆè§†è§‰ä¸Šä¸å¯è§ï¼‰éœ€è¦ä¿ç•™çŠ¶æ€ï¼ˆå¦‚è¡¨å•å¡«å†™å†…å®¹ã€åˆ—è¡¨æ»šåŠ¨ä½ç½®ã€ç­›é€‰æ¡ä»¶ç­‰ï¼‰ï¼Œä½†å¦‚æœå…¨éƒ¨æå‡ä¸º `Logix.app` çº§åˆ«çš„â€œå…¨å±€ Moduleâ€ï¼Œä¼šå¯¼è‡´å…¨å±€çŠ¶æ€çˆ†ç‚¸ã€å†…å­˜å ç”¨è¿‡é«˜ä¸”éš¾ä»¥ç®¡ç†ã€‚

## 1. é—®é¢˜å®šä¹‰

å½“å‰ Logix è¿è¡Œæ—¶çš„æ¨¡å—ç”Ÿå‘½å‘¨æœŸä¸»è¦æœ‰ä¸¤ç§æç«¯ï¼š

1.  **Global Module (App Level)**:
    *   ç”Ÿå‘½å‘¨æœŸï¼šéš App å¯åŠ¨è€Œå¯åŠ¨ï¼Œç›´åˆ° App é”€æ¯ã€‚
    *   ä¼˜ç‚¹ï¼šçŠ¶æ€æŒä¹…ä¿æŒï¼Œè·¨è·¯ç”±å…±äº«ã€‚
    *   ç¼ºç‚¹ï¼šå¯¹äºâ€œéå•ä¾‹â€çš„é¡µé¢ï¼ˆå¦‚ 100 ä¸ªä¸åŒçš„è¯¦æƒ…é¡µï¼‰ï¼Œå…¨éƒ¨æ³¨å†Œä¸ºå…¨å±€æ¨¡å—ä¸åˆç†ï¼›èµ„æºæ— æ³•åŠæ—¶é‡Šæ”¾ï¼›å‘½åç©ºé—´æ±¡æŸ“ã€‚

2.  **Transient Module (Component Level)**:
    *   ç”Ÿå‘½å‘¨æœŸï¼šéš React ç»„ä»¶ Mount åˆ›å»ºï¼ŒUnmount é”€æ¯ã€‚
    *   ä¼˜ç‚¹ï¼šè½»é‡ï¼Œè‡ªåŠ¨å›æ”¶ã€‚
    *   ç¼ºç‚¹ï¼šè·¯ç”±åˆ‡æ¢ï¼ˆA -> B -> Aï¼‰ä¼šå¯¼è‡´ A çš„çŠ¶æ€å®Œå…¨ä¸¢å¤±ï¼Œç”¨æˆ·ä½“éªŒå·®ï¼ˆéœ€é‡æ–°åŠ è½½/é‡æ–°å¡«å†™ï¼‰ã€‚

**ç›®æ ‡**ï¼šå¯»æ‰¾ä¸€ç§â€œä¼˜é›…â€çš„ä¸­é—´æ€åšæ³•ï¼Œæ—¢èƒ½æ»¡è¶³â€œé¡µé¢åˆ‡èµ°åçŠ¶æ€ä¿ç•™â€çš„æœŸæœ›ï¼Œåˆä¸éœ€è¦å°†æ‰€æœ‰é¡µé¢æ¨¡å—éƒ½æå‡ä¸ºå…¨å±€å•ä¾‹ã€‚

## 2. æ ¸å¿ƒè¯‰æ±‚

1.  **æŒ‰éœ€ä¿æŒ (Retainable/Keep-Alive)**ï¼šæ¨¡å—å®ä¾‹åœ¨ UI å¸è½½åä¸ç«‹å³é”€æ¯ï¼Œè€Œæ˜¯è¿›å…¥â€œä¼‘çœ /ç¼“å­˜â€çŠ¶æ€ã€‚
2.  **è‡ªåŠ¨æ¢å¤ (Resume)**ï¼šå½“ UI å†æ¬¡æŒ‚è½½ï¼ˆè·¯ç”±åˆ‡å›ï¼‰æ—¶ï¼Œèƒ½é€šè¿‡æŸç§ Keyï¼ˆå¦‚ Route Pathï¼‰æ‰¾å›ä¹‹å‰çš„å®ä¾‹å¹¶é‡æ–°è¿æ¥ã€‚
3.  **èµ„æºç®¡ç† (Eviction)**ï¼šä¸èƒ½æ— é™åˆ¶ç¼“å­˜ï¼Œéœ€è¦æœ‰ LRU æˆ–æ‰‹åŠ¨é”€æ¯æœºåˆ¶ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚
4.  **API ä¼˜é›…æ€§**ï¼šå°½é‡ä¸å¢åŠ å¤æ‚çš„ boilerplateï¼Œæœ€å¥½èƒ½ç»“åˆè·¯ç”±æˆ–ç®€å•çš„é…ç½®å®ç°ã€‚

## 3. æ ¸å¿ƒæ–¹æ¡ˆï¼šFractal Runtime (åˆ†å½¢è¿è¡Œæ—¶)

è¿™æ˜¯æœ€ç¬¦åˆâ€œåˆ†å½¢â€ç›´è§‰çš„æ–¹æ¡ˆï¼Œä¹Ÿæ˜¯ v3 çš„æ¨èå®ç°è·¯å¾„ã€‚

### 3.1 æ¦‚å¿µå®šä¹‰

*   **LogixRuntime**ï¼šä¸€ä¸ªç‹¬ç«‹çš„é€»è¾‘è¿è¡Œæ—¶å®¹å™¨ï¼ŒæŒæœ‰ Module å®ä¾‹ã€çŠ¶æ€ (State) å’Œåå°è¿›ç¨‹ (Processes)ã€‚
*   **Root Module**ï¼šæ¯ä¸ª Runtime éƒ½æœ‰ä¸€ä¸ªâ€œå…¥å£æ¨¡å—â€ï¼Œå®šä¹‰äº†è¯¥ Runtime çš„æ‰€æœ‰å†…å®¹ï¼ˆåŒ…æ‹¬ä¾èµ–çš„å­æ¨¡å—ï¼‰ã€‚
*   **Fractal (åˆ†å½¢)**ï¼šç³»ç»Ÿä¸å†åŒºåˆ† "App" å’Œ "Page"ï¼Œè€Œæ˜¯ç”± **Root Runtime** (Appçº§) å’Œè‹¥å¹² **Nested Runtime** (Pageçº§) ç»„æˆã€‚

### 3.2 API è®¾è®¡

```typescript
// ä¼ªä»£ç ï¼šRuntime ç‹¬ç«‹ï¼ŒUI åµŒå¥—

// 1. Root Runtime (App çº§åˆ«)
const appRuntime = LogixRuntime.make(AppRootModule);

// 2. Page Runtime (Page çº§åˆ«)
// è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ Runtime å®ä¾‹
// options? å¯ä»¥åŒ…å« parent, config, context ç­‰
const pageRuntime = LogixRuntime.make(PageRootModule, {
  parent: appRuntime, // å¯é€‰ï¼šæ˜¾å¼å…³è”çˆ¶è¿è¡Œæ—¶ï¼ˆç”¨äºé React åœºæ™¯æˆ–æ›´å¼ºçš„ä¾èµ–æŸ¥æ‰¾ï¼‰
  debug: true
});

function App() {
  return (
    // Level 1: App Runtime
    <LogixProvider runtime={appRuntime}>
      <Router>
        <Route path="/users">
          {/* Level 2: Page Runtime åµŒå¥—åœ¨ UI æ ‘ä¸­ */}
          {/* useModule ä¼šå…ˆåœ¨ pageRuntime æ‰¾ï¼Œæ‰¾ä¸åˆ°(å¯é€‰)å» appRuntime æ‰¾ */}
          <LogixProvider runtime={pageRuntime}>
            <UserListPage />
          </LogixProvider>
        </Route>
      </Router>
    </LogixProvider>
  );
}
```

## 4. LogixRuntime çš„æ„æˆè¦ç´  (Composition)

é™¤äº†æ ¸å¿ƒçš„ `RootModule`ï¼Œ`LogixRuntime` å¯èƒ½è¿˜éœ€è¦å…¶ä»–è¦ç´ æ¥å®šä¹‰å…¶è¡Œä¸ºï¼š

1.  **Root Module (å¿…é¡»)**ï¼š
    *   å®šä¹‰äº†è¯¥ Runtime çš„â€œå†…å®¹â€ï¼ˆLogic, State, Processesï¼‰ã€‚
    *   **Processes å½’å±**ï¼š`processes` æ˜¯ Root Module çš„ä¸€éƒ¨åˆ†ã€‚å½“ Runtime å¯åŠ¨æ—¶ï¼Œå®ƒä¼šè´Ÿè´£è¿è¡Œ Root Module ä¸­å®šä¹‰çš„æ‰€æœ‰åå°è¿›ç¨‹ã€‚
    *   æ˜¯ Runtime çš„â€œå›¾çº¸â€ã€‚

2.  **Runtime Config (å¯é€‰)**ï¼š
    *   **Parent Runtime**ï¼šæ˜¾å¼æŒ‡å®šçˆ¶çº§è¿è¡Œæ—¶ï¼Œç”¨äºæ„å»ºâ€œè¿è¡Œæ—¶æ ‘â€ã€‚
        *   **åœºæ™¯ 1ï¼šService æ¡¥æ¥ (Explicit Bridging)**ã€‚
            *   **æœºåˆ¶**ï¼šä¸æ¨èéšå¼å†’æ³¡ã€‚çˆ¶ Runtime å¯ä»¥æ˜¾å¼åœ°å°†æŸäº› Serviceï¼ˆå¦‚ `UserStore`ï¼‰ä½œä¸º `context` ä¼ å…¥å­ Runtimeã€‚
            *   **ä»·å€¼**ï¼šä¿æŒå­ Runtime çš„çº¯å‡€æ€§å’Œå¯æµ‹è¯•æ€§ï¼ŒåŒæ—¶å¤ç”¨çˆ¶çº§èƒ½åŠ›ã€‚
        *   **åœºæ™¯ 2ï¼šç”Ÿå‘½å‘¨æœŸè”åŠ¨**ã€‚å½“çˆ¶ Runtime é”€æ¯æ—¶ï¼Œå¯ä»¥çº§è”é”€æ¯æ‰€æœ‰å­ Runtimeï¼ˆè™½ç„¶åœ¨ React ä¸­é€šå¸¸ç”±ç»„ä»¶å¸è½½è§¦å‘ï¼Œä½†åœ¨çº¯é€»è¾‘åœºæ™¯ä¸‹éœ€è¦æ‰‹åŠ¨ç®¡ç†ï¼‰ã€‚
        *   **åœºæ™¯ 3ï¼šæµ‹è¯•ç¯å¢ƒæ¨¡æ‹Ÿ**ã€‚åœ¨æµ‹è¯•ä¸­ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª Mock çš„ Parent Runtime æä¾›æ‰€æœ‰å…¨å±€ä¾èµ–ï¼Œç„¶åæµ‹è¯•å­ Runtime çš„éš”ç¦»é€»è¾‘ã€‚
    *   **Platform Adapters**ï¼šæ³¨å…¥å¹³å°ç‰¹å®šèƒ½åŠ›ï¼ˆå¦‚ `History` å¯¹è±¡ã€`Fetch` å®ç°ï¼‰ï¼Œæ–¹ä¾¿è·¨ç«¯æˆ–æµ‹è¯•ã€‚
    *   **Instrumentation**ï¼šè‡ªå®šä¹‰æ—¥å¿—ã€ç›‘æ§ã€é”™è¯¯ä¸ŠæŠ¥å¤„ç†å™¨ã€‚

3.  **Initial Context (å¯é€‰)**ï¼š
    *   å…è®¸åœ¨ Runtime å¯åŠ¨æ—¶æ³¨å…¥ä¸€äº›åˆå§‹çš„ `Context.Tag` å®ç°ï¼ˆä¾‹å¦‚ä»æœåŠ¡ç«¯ SSR å¸¦æ¥çš„æ•°æ®ï¼‰ã€‚

å› æ­¤ï¼ŒAPI ç­¾åå»ºè®®ä¸ºï¼š
`LogixRuntime.make(rootModule: ModuleDef, options?: RuntimeOptions)`

## 5. å‘½åä¸æ¦‚å¿µé‡æ„ (Refactoring Concepts)

åŸºäºæ­¤ç†è§£ï¼Œæœ¯è¯­æ›´åŠ ç®€åŒ–ï¼š

| æ¦‚å¿µ | è¯´æ˜ |
| :--- | :--- |
| `LogixRuntime` | ç‹¬ç«‹çš„é€»è¾‘å®¹å™¨ï¼ŒæŒæœ‰ Module å®ä¾‹å’Œ Processesã€‚ |
| `Root Module` | å®šä¹‰è¯¥ Runtime å†…å®¹çš„å…¥å£æ¨¡å—ã€‚ |
| `Provider Nesting` | React å±‚çš„ä¸Šä¸‹æ–‡åµŒå¥—ï¼Œå†³å®šäº† `useModule` çš„æŸ¥æ‰¾é¡ºåºã€‚ |

**è®¾è®¡åŸåˆ™**ï¼š
*   **Isolation (éš”ç¦»)**ï¼šRuntime ä¹‹é—´é»˜è®¤äº’ä¸å¹²æ‰°ã€‚
*   **Composition (ç»„åˆ)**ï¼šé€šè¿‡ React Context ç»„åˆä¸åŒç”Ÿå‘½å‘¨æœŸçš„ Runtimeã€‚
*   **Identity (èº«ä»½)**ï¼šModule çš„â€œå…¨å±€æ€§â€ç”±å®ƒæ‰€åœ¨çš„ Runtime å†³å®šã€‚

## 6. å¾…è®¨è®ºç‚¹

1.  **Effect æ¸…ç†**ï¼šå½“æ¨¡å—â€œä¼‘çœ â€æ—¶ï¼Œå…¶å†…éƒ¨çš„ `processes`ï¼ˆå¦‚ WebSocket è®¢é˜…ã€å®šæ—¶å™¨ï¼‰åº”è¯¥ç»§ç»­è¿è¡Œè¿˜æ˜¯æš‚åœï¼Ÿ
    *   é€šå¸¸å¸Œæœ›æ•°æ®è®¢é˜…ç»§ç»­ï¼ˆä¿æŒæ•°æ®æ–°é²œï¼‰ï¼Œä½† UI ç›¸å…³çš„åŠ¨ç”»/RAF åº”åœæ­¢ã€‚
2.  **å†…å­˜å‹åŠ›**ï¼šå‡ ç™¾ä¸ªé¡µé¢å¦‚æœéƒ½ç¼“å­˜ï¼ŒDOM å¯èƒ½é”€æ¯äº†ï¼Œä½† JS å¯¹è±¡è¿˜åœ¨ã€‚éœ€è¦è¯„ä¼° Effect Runtime çš„å†…å­˜å¼€é”€ã€‚
3.  **éšå¼ä¾èµ– vs æ˜¾å¼å£°æ˜ (Implicit vs Explicit)**ï¼š
    *   **éšå¿§**ï¼šå¦‚æœå­ Runtime è‡ªåŠ¨å‘ä¸ŠæŸ¥æ‰¾çˆ¶ Runtime çš„ Tagï¼Œä¼šå¯¼è‡´ä¾èµ–å…³ç³»å˜å¾—éšå¼ä¸”éš¾ä»¥è¿½è¸ªã€‚è¿™è¿èƒŒäº† Effect "æ˜¾å¼ä¾èµ–" çš„å“²å­¦ã€‚
    *   **æ”¹è¿›æ–¹æ¡ˆ**ï¼š
        *   **Explicit Import**: å­ Runtime çš„ Root Module å¿…é¡»æ˜¾å¼å£°æ˜å®ƒéœ€è¦ä»çˆ¶çº§ç»§æ‰¿å“ªäº› Tagã€‚
        *   **Context Bridge**: åœ¨åˆ›å»ºå­ Runtime æ—¶ï¼Œæ˜¾å¼å°†çˆ¶ Runtime çš„æŸäº› Service æ³¨å…¥åˆ°å­ Runtime çš„ Context ä¸­ã€‚
        *   **ç¦æ­¢è‡ªåŠ¨å†’æ³¡**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒRuntime ä¹‹é—´æ˜¯éš”ç¦»çš„ã€‚å¦‚æœ Page éœ€è¦ UserStoreï¼Œå®ƒåº”è¯¥åœ¨è‡ªå·±çš„ `imports` ä¸­å£°æ˜ `UserStore`ï¼Œæˆ–è€…é€šè¿‡ `LogixRuntime.make(..., { context: parent.pick(UserStore) })` æ˜¾å¼ä¼ é€’ã€‚

    *   **æ¨èç­–ç•¥**ï¼š**æ˜¾å¼ä¼ é€’ä¼˜äºéšå¼å†’æ³¡**ã€‚
        *   React Context çš„åµŒå¥—ä»…ç”¨äº UI ç»„ä»¶æŸ¥æ‰¾ *å½“å‰* Runtimeã€‚
        *   Runtime å†…éƒ¨çš„ä¾èµ–è§£æåº”ä¿æŒå°é—­ï¼Œé™¤éæ˜¾å¼é…ç½®äº†â€œContext Bridgeâ€ã€‚

## 7. ä¸‹ä¸€æ­¥

*   [ ] è°ƒç ” Effect Scope çš„ `fork` ä¸ `extend` æœºåˆ¶ï¼Œçœ‹æ˜¯å¦èƒ½å®ç°â€œScope è½¬ç§»â€ï¼ˆä» Component Scope è½¬ç§»åˆ° Cache Scopeï¼‰ã€‚
*   [ ] è®¾è®¡ `ModuleLifecycle` é…ç½®æ¥å£ã€‚
*   [ ] éªŒè¯ LRU ç¼“å­˜åœ¨ Effect èµ„æºç®¡ç†ä¸‹çš„å¯è¡Œæ€§ã€‚
*   [ ] **åŸå‹éªŒè¯æ–¹æ¡ˆ D**ï¼šå°è¯•ç”¨ `LogixRuntime` åˆ›å»ºä¸¤ä¸ªå®ä¾‹ï¼Œå¹¶æµ‹è¯•åµŒå¥— Provider çš„è¡Œä¸ºã€‚
</file>

<file path="drafts/L9/platform-patterns-as-flow-templates.md">
---
title: Platform Patterns as Flow Templates
status: draft
version: 0.1.0
value: extension
priority: 1300
related:
  - ../topics/platform-patterns/generative-pattern-lifecycle.md
  - ../topics/platform-patterns/generative-pattern-scenarios.md
---

# Platform Patterns as Flow Templates

> æ ¸å¿ƒæƒ³æ³•ï¼šæ”¶ç´§ Platform Pattern çš„èŒè´£ï¼Œå°†å…¶è§†ä¸ºã€ŒBoundApi/Flow æ¨¡æ¿ + å…ƒæ•°æ®ã€ï¼Œè€Œä¸æ˜¯ç¬¬äºŒå¥—è¿è¡Œæ—¶æˆ– DSLã€‚

## 1. å½“å‰é£é™©

- `platform-patterns` Topic å®¹æ˜“æ¼”åŒ–å‡ºä¸€å¥—ç‹¬ç«‹çš„ Pattern DSLï¼Œä¸ Logix Runtime çš„ Flow/Logic å½¢æˆå¹³è¡Œä½“ç³»ï¼›
- Pattern Lifecycle/Scenarios æ–‡æ¡£ä¸­å­˜åœ¨ä¸å°‘â€œè¿è¡Œæ—¶è¡Œä¸ºçº§â€çš„æè¿°ï¼Œå¢åŠ å¹³å°å®ç°å¤æ‚åº¦ã€‚

## 2. æ”¶æ•›æ–¹å‘

- å°† Pattern çš„ Runtime éƒ¨åˆ†é™å®šä¸ºï¼š
  - ä¸€æ®µæ ‡å‡†çš„ Fluent Logic/Flow ç¨‹åºå€¼ï¼ˆä¾‹å¦‚ `$.onState(...).debounce().runLatest(...)`ï¼‰ï¼›
  - ä¸€ä»½æè¿°è¿™æ®µé€»è¾‘çš„å…ƒæ•°æ®ï¼ˆåç§°ã€æè¿°ã€é€‚ç”¨åœºæ™¯ã€å‚æ•° Schema ç­‰ï¼‰ï¼›
- Studio/å¹³å°åªè´Ÿè´£ï¼š
  - åœ¨äº¤äº’é˜¶æ®µå¡«å……/ä¿®æ”¹å…ƒæ•°æ®å’Œé…ç½®ï¼›
  - åœ¨åˆæˆé˜¶æ®µå°†é…ç½®å¥—ç”¨åˆ°æ¨¡æ¿ä»£ç ï¼Œç”Ÿæˆæ™®é€šçš„ Logic æ–‡ä»¶ã€‚

## 3. ä¸ SSoT çš„å…³ç³»

- è‹¥åç»­ç¡®è®¤è¿™ä¸€æ–¹å‘ï¼Œå°†ï¼š
  - åœ¨ `docs/specs/intent-driven-ai-coding/v3` ä¸­å¢åŠ  Pattern ä½œä¸ºèµ„äº§ç±»å‹çš„æ­£å¼å®šä¹‰ï¼›
  - åœ¨ runtime-logix ä¸­æ˜ç¡® Pattern åªæ˜¯ Logic/Flow çš„æ¨¡æ¿ï¼Œä¸å¼•å…¥æ–°çš„è¿è¡Œæ—¶åŸè¯­ã€‚
</file>

<file path="drafts/L9/poisoned-effect-pattern.md">
---
title: æ¶æ„é˜²å¾¡ï¼šæ¯’è¯ Effect æ¨¡å¼ï¼ˆPoisoned Effect Patternï¼‰
status: draft
version: 1
tags:
  - architecture
  - effect-ts
  - governance
  - logix
priority: 1400
---

## 0. æ ¸å¿ƒæƒ³æ³•ï¼ˆCore Insightï¼‰

åœ¨ Effect-TS ä½“ç³»ä¸­ï¼Œâ€œå¯ä»¥è¢« `yield*`â€ æœ¬è´¨ä¸Šæ˜¯ä¸€ç§ç‰¹æƒï¼Œè€Œä¸æ˜¯é»˜è®¤æƒåˆ©ã€‚

æœ¬è‰ç¨¿æå‡ºä¸€ç§é’ˆå¯¹ Logix / Effect-TS æ¶æ„æ²»ç†çš„æ¨¡å¼ï¼š

> ä¸ºæŸäº›æ•æ„Ÿå¯¹è±¡ï¼ˆå¦‚ `Logix.Module`ã€æƒé™ä»¤ç‰Œç­‰ï¼‰åˆ¶é€ ä¸€ç§ **â€œæ¯’è¯ Effectâ€**ï¼š  
> - å¯¹ TypeScript ç±»å‹ç³»ç»Ÿæ¥è¯´ï¼Œå®ƒçœ‹èµ·æ¥æ˜¯ä¸€ä¸ªåˆæ³•çš„ `Effect`ï¼Œå¯ä»¥è¢« `yield*`ï¼›  
> - å¯¹è¿è¡Œæ—¶æ¥è¯´ï¼Œä¸€æ—¦æœ‰äººç›´æ¥ `yield*` å®ƒï¼Œå°±ç«‹å³è§¦å‘ `die`ï¼ˆä¸å¯æ¢å¤é”™è¯¯ï¼‰å¹¶ç»™å‡ºæ˜ç¡®çš„æ¶æ„è¿è§„æç¤ºï¼›  
> - çœŸæ­£å®‰å…¨çš„è®¿é—®è·¯å¾„é€šè¿‡ä¸€ä¸ªâ€œå®‰å…¨åé—¨â€ï¼ˆSymbol æˆ–å†…éƒ¨å­—æ®µï¼‰æš´éœ²ç»™å—ä¿¡ä»»çš„ APIï¼ˆå¦‚ `$.use`ï¼‰ã€‚

è¿™æ ·å¯ä»¥æŠŠåŸæœ¬é  Lint çº¦æŸçš„â€œä¸è¦ç›´æ¥è·‘ Module / Tokenâ€ç­‰è§„åˆ™ï¼Œæ”¶æ•›åˆ° **è¿è¡Œæ—¶ç‰©ç†å®šå¾‹** å±‚é¢ã€‚

---

## 1. èƒŒæ™¯ä¸åŠ¨æœºï¼ˆMotivationï¼‰

### 1.1 Logix v3 ä¸­çš„è§’è‰²åˆ’åˆ†

åœ¨ Logix v3 æ¶æ„ä¸­ï¼Œæˆ‘ä»¬åˆ»æ„åŒºåˆ†ä¸¤ä¸ªå±‚æ¬¡ï¼š

- `Module`ï¼š  
  - é¢†åŸŸèº«ä»½ + ä¾èµ–æ³¨å…¥ Tokenï¼›  
  - è¡¨è¾¾â€œè¿™æ˜¯ä¸€ä¸ªé¢†åŸŸæ¨¡å—ï¼Œå…¶ state/actions å½¢çŠ¶æ˜¯å›ºå®šçš„â€ï¼›  
  - å¯ä»¥ä½œä¸º Tag æ”¾è¿› Layer/Context ä¸­ã€‚
- `Link`ï¼ˆä»¥åŠ Logicï¼‰ï¼š  
  - å®é™…æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘æµå’Œè·¨æ¨¡å—/å¤–éƒ¨ç³»ç»Ÿçš„åä½œï¼›  
  - è¿è¡Œåœ¨ Effect Runtime ä¸Šï¼Œé€šè¿‡ `$.state / $.actions / $.flow` ç­‰è®¿é—® Module çš„èƒ½åŠ›ã€‚

ä»æ¶æ„è§†è§’ï¼Œå¸Œæœ› **è·¨ Module å†™å…¥åªèƒ½é€šè¿‡ Action** å®Œæˆï¼›è·¨ Module è¯»çŠ¶æ€å¯ä»¥é€šè¿‡åªè¯» Handleï¼Œä½†ä¸åº”è¯¥æœ‰â€œç›´æ¥æ‹¿åˆ°åº•å±‚ Runtime å®ä¾‹ç„¶åéšæ„æ”¹â€çš„é€šè·¯ã€‚

### 1.2 Effect-TS å¸¦æ¥çš„â€œæ¼æ´â€

Effect-TS ä¸­çš„ `Context.Tag` æœ¬èº«å°±æ˜¯ä¸€ä¸ª `Effect`ï¼š

```ts
// æœ¬æ„ï¼šä»…å¼•ç”¨èº«ä»½
const UserModule = Logix.Module("User", /* ... */)

// ä½†åœ¨ Effect-TS è¯­ä¹‰ä¸‹ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ª Effectï¼š
const rawRuntime = yield* UserModule  // ç¼–è¯‘å™¨ä¸ä¼šæŠ¥é”™
```

å¦‚æœ `Logix.Module` ç›´æ¥è¿”å›ä¸€ä¸ªç»§æ‰¿è‡ª `Context.Tag` çš„ Tagï¼Œé‚£ä¹ˆï¼š

- å¼€å‘è€…å¯ä»¥ `yield* UserModule` æ‹¿åˆ° **åº•å±‚ ModuleRuntime å®ä¾‹**ï¼›  
- è¿›ä¸€æ­¥å°±èƒ½è°ƒç”¨ `.setState()` / `.ref()` ç­‰åº•å±‚ APIï¼Œç»•è¿‡ `$.use(UserModule)` æä¾›çš„åªè¯»å°è£…ï¼›
- æ¶æ„ä¸Šâ€œè·¨æ¨¡å—åªè¯»ã€å†™å…¥é  Actionâ€çš„çº¦æŸå°±é€€åŒ–ä¸ºâ€œå›å­åå®šâ€ï¼Œè€Œä¸æ˜¯å¼ºçº¦æŸã€‚

### 1.3 ç›®æ ‡

æˆ‘ä»¬å¸Œæœ›åšåˆ°ï¼š

- å¯¹äºä¸šåŠ¡/å¹³å°ä¾§ä»£ç ï¼š
  - `UserModule` **åªèƒ½è¢«å¼•ç”¨ï¼Œä¸èƒ½è¢«ç›´æ¥æ‰§è¡Œ**ï¼›  
  - ä¸€æ—¦æœ‰äººè¯•å›¾ `yield* UserModule`ï¼Œç¨‹åºåº”ç«‹å³ä»¥æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ç»ˆæ­¢ã€‚
- å¯¹äºæ¡†æ¶å†…éƒ¨ï¼ˆLogix Core / BoundApiï¼‰ï¼š
  - ä»ç„¶ä¿ç•™ä¸€æ¡â€œå®‰å…¨åé—¨â€ï¼Œå¯ä»¥æ‹¿åˆ°çœŸæ­£çš„ `Context.Tag` / ModuleRuntimeï¼Œå¹¶åŸºäºå®ƒæ„é€ åªè¯» Handleã€‚

æ¢å¥è¯è¯´ï¼š**æ”¶å›å¯¹â€œæ•æ„Ÿå¯¹è±¡â€çš„ `yield*` æƒé™ï¼Œåªå…è®¸é€šè¿‡å—ç®¡é“çš„ APIï¼ˆå¦‚ `$.use`ï¼‰è·å–èƒ½åŠ›ã€‚**

---

## 2. æ¨¡å¼å®šä¹‰ï¼šæ¯’è¯ Effectï¼ˆPoisoned Effectï¼‰

### 2.1 æ¦‚å¿µ

â€œæ¯’è¯ Effectâ€ æ˜¯ä¸€ä¸ªç‰¹æ®Šå¯¹è±¡ï¼Œå®ƒæ»¡è¶³ï¼š

- åœ¨ TS ç±»å‹ç³»ç»Ÿä¸­ï¼Œç»“æ„/æ ‡è®°è¶³ä»¥è¢«è§†ä¸º `Effect.Effect<_,_,_>` æˆ– `Context.Tag` å¯ yield çš„å€¼ï¼›
- ä½†åœ¨ Effect è¿è¡Œæ—¶è§£é‡Šæ‰§è¡Œæ—¶ï¼Œä¼šè¢«è§£æä¸ºä¸€ä¸ªâ€œç«‹å³ `die` çš„æŒ‡ä»¤â€ï¼Œæºå¸¦è¯¦ç»†çš„æ¶æ„é”™è¯¯ä¿¡æ¯ï¼›
- åŒæ—¶ï¼Œå®ƒè¿˜åŒ…å«ä¸€ä¸ªåªæœ‰æ¡†æ¶å†…éƒ¨çŸ¥é“çš„ Symbol å­—æ®µï¼ŒæŒ‡å‘çœŸå®çš„ Tag æˆ–åº•å±‚å®ç°ã€‚

æŠ½è±¡åœ°çœ‹ï¼Œä¸€ä¸ªæ¯’è¯ Module å¤§è‡´é•¿è¿™æ ·ï¼š

```ts
const kRealTag = Symbol.for("logix/real-tag") // å®‰å…¨åé—¨

const PoisonedModule = {
  // 1. [ç±»å‹ä¼ªè£…] æ»¡è¶³ Effect/Tag çš„ç»“æ„ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
  [Effect.EffectTypeId]: {
    _V: "Effect",
    _Op: "die",
    message: `ğŸ›‘ [Logix Architecture Violation]

ç¦æ­¢ç›´æ¥è¿è¡Œ Module!
âŒ const rt = yield* MyModule;
âœ… const $M = yield* $.use(MyModule);
`
  },

  // 2. [å®‰å…¨åé—¨] åªç»™æ¡†æ¶å†…éƒ¨çš„ API ç”¨
  [kRealTag]: ActualContextTag,

  // 3. [pipe å…¼å®¹æ€§] ä¿è¯åœ¨ pipe é“¾ä¸­è¡Œä¸ºæ­£å¸¸ï¼ˆè§†å®ç°éœ€è¦ï¼‰
  pipe() { /* ... */ }
}
```

ä¸šåŠ¡å¼€å‘è€…åªä¼šæ‹¿åˆ° `PoisonedModule` è¿™ä¸€å±‚ï¼š

- å†™ `yield* UserModule` æ—¶ï¼ŒEffect Runtime ä¼šçœ‹åˆ° `_Op: "die"`ï¼Œç›´æ¥ç†”æ–­ï¼›  
- åªæœ‰æ¡†æ¶å†…éƒ¨çš„ `$.use` / Link å®ç°çŸ¥é“ä» `[kRealTag]` é‡Œæ‹¿å‡ºçœŸæ­£çš„ Tagï¼Œå†åšå®‰å…¨å°è£…ã€‚

---

## 3. æ¶ˆè´¹ä¾§åè®®ï¼šè°èƒ½è§£æ¯’ï¼Œè°ä¼šä¸­æ¯’ï¼Ÿ

### 3.1 å”¯ä¸€çš„è§£æ¯’è€…ï¼š`$.use`

Bound API ä¸­çš„ `$.use` æ˜¯â€œå”¯ä¸€æŒæœ‰è§£è¯çš„æ¶ˆè´¹è€…â€ï¼Œå…¶é€»è¾‘ç±»ä¼¼ï¼š

```ts
const kRealTag = Symbol.for("logix/real-tag")

// ä¼ªä»£ç 
$.use = (dependency: any) =>
  Effect.gen(function* () {
    // 1. Moduleï¼šå¸¦æœ‰åé—¨ Symbol
    if (dependency && dependency[kRealTag]) {
      const tag = dependency[kRealTag] // çœŸæ­£çš„ Context.Tag
      const runtime = yield* tag       // æ­¤å¤„æ‰å…è®¸ç›´æ¥ yield*
      return makeReadonlyHandle(runtime)
    }

    // 2. æ™®é€š Serviceï¼šç›´æ¥ä½œä¸º Tag/Effect ä½¿ç”¨
    //    å³å¯¹ä¸å¸¦æ¯’çš„ Context.Tag / Service Tag ä¿æŒåŸæœ‰è¯­ä¹‰
    return yield* dependency
  })
```

åœ¨è¿™ä¸ªåè®®ä¸‹ï¼š

- **Module Tag**ï¼šå¯¹å¤–æš´éœ²çš„æ˜¯æ¯’è¯ç‰ˆæœ¬ï¼Œåªèƒ½é€šè¿‡ `$.use(Module)` ä½¿ç”¨ï¼›  
- **æ™®é€š Service Tag**ï¼šä»ç„¶å¯ä»¥ç›´æ¥ `yield* SomeServiceTag`ï¼Œä¿æŒ Effect-TS åŸæœ‰ä½“éªŒï¼›
- æ¡†æ¶å†…éƒ¨å¯ä»¥é€šè¿‡ `kRealTag` è®¿é—®çœŸå® Tagï¼Œä½†ä¸šåŠ¡ä»£ç ä¸éœ€è¦ã€ä¹Ÿä¸åº”è¯¥çŸ¥é“è¿™ä¸ªç»†èŠ‚ã€‚

### 3.2 è¿è§„è€…ï¼šç›´æ¥ `yield*`

å½“ä¸šåŠ¡å¼€å‘è€…å†™å‡ºç±»ä¼¼ä»£ç ï¼š

```ts
Effect.gen(function* () {
  // æƒ³ç»•è¿‡ $.useï¼Œç›´æ¥æ‹¿ Runtime
  const rt = yield* UserModule
})
```

è¿è¡Œæ—¶ä¼šï¼š

- è§£æ `UserModule` ä¸Šçš„ Effect æ ‡è®°ï¼›
- å‘ç° `_Op: "die"`ï¼Œå³åˆ»æŠ›å‡ºä¸å¯æ¢å¤é”™è¯¯ï¼›
- é”™è¯¯ä¿¡æ¯å¯ä»¥æ˜ç¡®æç¤ºâ€œè¿™æ˜¯æ¶æ„çº§è¿è§„ï¼Œå¹¶ç»™å‡ºæ­£ç¡®å†™æ³•â€ï¼š

> ç¦æ­¢ç›´æ¥è¿è¡Œ Module!  
> âŒ `const rt = yield* MyModule`  
> âœ… `const h = yield* $.use(MyModule)`

è¿™æ¯”ä¸€ä¸ªæ™¦æ¶©çš„ `TypeError: undefined is not a function` æ›´â€œæœ‰æ•™è‚²æ„ä¹‰â€å’Œæ›´æ˜“äºè¿ç»´å®šä½ã€‚

---

## 4. ä»·å€¼åˆ†æï¼ˆValue Propositionï¼‰

### 4.1 ä» Lint è§„åˆ™åˆ°è¿è¡Œæ—¶ç‰©ç†å®šå¾‹

ä¼ ç»Ÿåšæ³•æ˜¯ï¼š

- å†™ ESLint è§„åˆ™ç¦æ­¢ç‰¹å®šè¯­æ³•ï¼ˆä¾‹å¦‚ no-restricted-syntaxï¼‰ï¼Œä¸å‡†ç›´æ¥ `yield* Module`ï¼›
- ä½† ESLintï¼š
  - å¯ä»¥è¢«å±€éƒ¨ç¦ç”¨ï¼ˆ`// eslint-disable-next-line`ï¼‰ï¼›  
  - å¯¹è¿è¡Œæ—¶è¡Œä¸ºæ— å¼ºçº¦æŸã€‚

æ¯’è¯ Effect æŠŠè¿™ç±»çº¦æŸä¸‹æ²‰ä¸ºâ€œè¿è¡Œæ—¶ç‰©ç†å®šå¾‹â€ï¼š

- ä»£ç å†™é”™äº†ï¼Œç¨‹åºå°±ç›´æ¥å´©ï¼ˆä»¥æ¸…æ™°é”™è¯¯ï¼‰ï¼Œè€Œä¸æ˜¯æ‚„æ‚„ç»•è¿‡æ¶æ„è¾¹ç•Œï¼›
- åœ¨ CI/æµ‹è¯•ç¯å¢ƒä¸­ï¼Œå¯ä»¥ç¡®ä¿ä»»ä½•ç»•è¿‡è§„èŒƒçš„ç”¨æ³•åœ¨å®è·µä¸­ç«‹å³æš´éœ²ï¼›
- å¯¹äºâ€œæ¶æ„ä¸èƒ½å¦¥åâ€çš„è¾¹ç•Œï¼ˆæ¯”å¦‚è·¨æ¨¡å—å†™å…¥è·¯å¾„ï¼‰ï¼Œè¿™æ˜¯æ›´ç¨³çš„é˜²çº¿ã€‚

### 4.2 ä¿æŠ¤å°è£…ä¸æŠ½è±¡è¾¹ç•Œ

å¯¹äº Logix æ¥è¯´ï¼Œè¿™ä¸ªæ¨¡å¼ç›´æ¥ä¿æŠ¤äº†ä¸¤ä¸ªå…³é”®æŠ½è±¡ï¼š

- **ModuleRuntime çš„åº•å±‚èƒ½åŠ›æ°¸ä¸æ³„æ¼åˆ°ä¸šåŠ¡å±‚**ï¼š
  - `setState` / `ref` / å†…éƒ¨ streams ç­‰åªåœ¨ Runtime/BoundApi å†…éƒ¨ä½¿ç”¨ï¼›  
  - ä¸šåŠ¡é€»è¾‘å±‚æ‰€æœ‰å¯¹æ¨¡å—çš„å†™å…¥éƒ½å¿…é¡»é€šè¿‡ Actionï¼ˆ`$.actions.xxx` æˆ– `ModuleHandle.dispatch`ï¼‰å®Œæˆã€‚

- **è·¨æ¨¡å—åä½œç»Ÿä¸€èµ° $.use / Link / Adapter**ï¼š
  - è¯»å…¶ä»–æ¨¡å—çš„ state â†’ `$.use(OtherModule)` è¿”å›çš„åªè¯» Handleï¼›  
  - è·¨ç³»ç»Ÿ/å¤æ‚ wiring â†’ ç”¨ Link/Adapter/æ‰©å±•åŒ…å°è£…ï¼›  
  - ä¸å­˜åœ¨â€œæŸä¸ªé€»è¾‘çªç„¶ç›´æ¥æ‹¿åˆ°å¯¹æ–¹ Runtime ç„¶åä¹±æ”¹â€çš„åé—¨ã€‚

### 4.3 å¼€å‘è€…ä½“éªŒï¼ˆDXï¼‰

æ¯’è¯ Effect å¹¶éç®€å•â€œæé«˜é”™è¯¯ç‡â€ï¼Œåè€Œèƒ½æ”¹å–„ DXï¼š

- ç›¸æ¯”æ¨¡ç³Šçš„è¿è¡Œæ—¶é”™è¯¯ï¼ˆ`Cannot read property setState of undefined`ï¼‰ï¼Œ  
  å®ƒæä¾›äº†**ç»“æ„åŒ–çš„ã€è‡ªè§£é‡Šçš„é”™è¯¯ä¿¡æ¯**ï¼Œå‘Šè¯‰å¼€å‘è€…ï¼š  
  - å“ªç§å†™æ³•æ˜¯è¢«ç¦æ­¢çš„ï¼›  
  - æ¨èæ›¿ä»£æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼ˆä¾‹å¦‚ `$.use`ã€Link å·¥å‚ç­‰ï¼‰ã€‚
- å¯¹æ–°åŒå­¦/æ–°åŠ å…¥å›¢é˜Ÿçš„å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªâ€œè¿è¡Œæ—¶æ•™å­¦å·¥å…·â€ï¼Œä¸€æ­¥æ­¥æŠŠä»–ä»¬ä»â€œEffect å¯ä»¥éšä¾¿ yieldâ€å¼•å¯¼åˆ°â€œæ¶æ„è§„å®šäº†å“ªäº›ä¸œè¥¿å¯ä»¥ yieldï¼Œå“ªäº›ä¸è¡Œâ€ã€‚

---

## 5. æ¨å¹¿æ€§ä¸é€‚ç”¨åœºæ™¯

è™½ç„¶æœ¬æ¨¡å¼é¦–å…ˆæ˜¯ä¸º Logix v3 æ¶æ„è®¾è®¡çš„ï¼Œä½†å¯¹æ‰€æœ‰åŸºäº Effect-TS çš„ç³»ç»Ÿéƒ½æœ‰å€Ÿé‰´æ„ä¹‰ï¼š

- **èµ„æºä¿æŠ¤**ï¼š  
  - å¯¹æ•°æ®åº“è¿æ¥æ± ã€å…¨å±€ç¼“å­˜ã€ä½çº§ IO Handle ç­‰å¯¹è±¡ï¼Œé˜²æ­¢ä¸šåŠ¡å±‚ç›´æ¥ `yield* PoolTag` è·å¾—â€œè£¸èµ„æºâ€ï¼Œå¼ºåˆ¶é€šè¿‡ Repository/Service å±‚è®¿é—®ï¼›
- **æƒé™ä»¤ç‰Œ**ï¼š  
  - å¯¹æŸäº›æ•æ„Ÿ Tokenï¼ˆå¦‚ AdminTokenï¼‰ï¼Œç¦æ­¢ä¸šåŠ¡é€»è¾‘ç›´æ¥ `yield* AdminToken` è·å¾—çœŸå®å€¼ï¼Œå¿…é¡»é€šè¿‡ `Auth.use(AdminToken)` ç­‰ API åšéªŒè¯ä¸æ§åˆ¶ï¼›
- **é…ç½®ä¿¡å·**ï¼š  
  - æœ‰äº›é…ç½®å¯¹è±¡åœ¨ç±»å‹ä¸Šä¹Ÿæ˜¯ `Effect`ï¼Œä½†ä»è¯­ä¹‰ä¸Šä¸åº”è¯¥è¢«å½“æˆâ€œå¯æ‰§è¡Œå‰¯ä½œç”¨â€ï¼Œå¯ä»¥ç”¨æ¯’è¯æ¨¡å¼é˜²æ­¢è¢«è¯¯ç”¨ã€‚

æœ¬è´¨ä¸Šï¼š

> åœ¨ Effect ç³»ç»Ÿä¸­ï¼Œâ€œå¯ä»¥è¢« `yield*`â€æ˜¯ä¸€ç§éœ€è¦è¢«æ¶æ„å¸ˆæ˜¾å¼æˆäºˆçš„æƒåˆ©ï¼Œè€Œä¸æ˜¯é»˜è®¤è½åœ¨æ¯ä¸ªå¯¹è±¡ä¸Šçš„èƒ½åŠ›ã€‚  
> æ¯’è¯ Effect æ¨¡å¼æä¾›äº†ä¸€ç§æ”¶å›è¿™é¡¹æƒåˆ©ã€å¹¶é›†ä¸­äº¤ç»™å°‘æ•°å—ä¿¡ä»» API çš„æœºåˆ¶ã€‚

---

## 6. åç»­å·¥ä½œä¸å¼€æ”¾é—®é¢˜

- å¯¹ Logix v3ï¼š
  - åœ¨ `core/02-module-and-logic-api.md` æˆ–å®ç°å¤‡å¿˜å½•ä¸­ï¼Œæ˜ç¡® `Logix.Module` è¿”å›çš„æ˜¯â€œå—ä¿æŠ¤ Tagâ€ï¼Œåªèƒ½é€šè¿‡ `$.use` ç­‰ API è§£å°ï¼›  
  - ç»™å‡ºç²¾ç®€ç‰ˆå®ç°è‰å›¾ï¼Œçº¦å®šå¥½ `[kRealTag]` è¿™ç±»åé—¨å­—æ®µçš„å‘½åä¸ä½¿ç”¨èŒƒå›´ã€‚
- å¯¹ Effect Runtime å®ç°ï¼š
  - è¯„ä¼°ä¸å½“å‰ `EffectTypeId` / `_Op` ç»“æ„çš„å…¼å®¹æ€§ï¼Œç¡®ä¿â€œdie æŒ‡ä»¤ + è‡ªå®šä¹‰ messageâ€èƒ½ä»¥æ ‡å‡†æ–¹å¼é›†æˆï¼›  
  - ä¸ç°æœ‰é”™è¯¯è¿½è¸ª / Debug å·¥å…·ï¼ˆå¦‚ Scope Inspectorï¼‰æ•´åˆï¼Œåœ¨ UI ä¸­æ›´ç›´è§‚åœ°å±•ç¤ºè¿™ç±»æ¶æ„è¿è§„ã€‚
- å¯¹å›¢é˜Ÿæ²»ç†ï¼š
  - å°†â€œå“ªäº› Tag æ˜¯æ¯’è¯ï¼ˆåªèƒ½é€šè¿‡æŸäº› API ä½¿ç”¨ï¼‰â€åˆ—å…¥æ¶æ„çº¦å®šï¼›  
  - åœ¨ Guide ä¸­ç»™å‡ºå¯¹åº”çš„â€œæ­£ç¡®ç”¨æ³•ç¤ºä¾‹â€ï¼Œé¿å…å¼€å‘è€…åªçœ‹åˆ°é”™è¯¯ä¿¡æ¯å´æ²¡æœ‰æ›¿ä»£æ–¹æ¡ˆã€‚

è¿™ç¯‡è‰ç¨¿èšç„¦äºæ¨¡å¼æœ¬èº«ï¼Œå…·ä½“å®ç°ç»†èŠ‚ä¸ API å½¢çŠ¶å¯åœ¨ Logix Core/Impl æ–‡æ¡£ä¸­ç»§ç»­ç»†åŒ–ã€‚  
å…³é”®æ˜¯å…ˆè¾¾æˆå…±è¯†ï¼š**æŸäº›æŠ½è±¡ä¸åº”è¯¥è¢«éšæ„ `yield*`ï¼Œè€Œæ¯’è¯ Effect æä¾›äº†ä¸€ä¸ªåœ¨ Effect ç”Ÿæ€ä¸­å®ç°è¿™ä¸€ç‚¹çš„é€šç”¨æ‰‹æ®µã€‚**
</file>

<file path="drafts/L9/react-live-component-host-poc.md">
---
title: 'LiveComponent Host: React Adapter ä¸ AI Native UI çš„æ¡¥æ¥ PoC'
status: draft
version: 0.1.0
value: extension
priority: 1500
related:
  - ../topics/ai-native-ui/20-live-component-runtime.md
  - ../topics/react-adapter/02-context-injection.md
---

# LiveComponent Host: React Adapter ä¸ AI Native UI çš„æ¡¥æ¥ PoC

> æ ¸å¿ƒæƒ³æ³•ï¼šåœ¨ç°æœ‰ `@logix/react` èƒ½åŠ›åŸºç¡€ä¸Šï¼Œåšä¸€ä¸ªæœ€å°çš„ `LiveComponent` å®¿ä¸» PoCï¼Œç”¨æ¥éªŒè¯ AI Native UI è‰æ¡ˆé‡Œçš„è¿è¡Œæ—¶æ¥å£å½¢çŠ¶ã€‚

## 1. èƒŒæ™¯

- `ai-native-ui/20-live-component-runtime.md` è®¾è®¡äº†ä¸€å¥— LiveComponent Hostï¼šæ ¹æ® Intent åŠ¨æ€æ„é€  Draft + ç¼–è¯‘ Skeleton TSXï¼Œå†æ³¨å…¥ Runtimeï¼›
- `@logix/react` å·²ç»æä¾› `RuntimeProvider`ã€`useLocalModule`ã€`useSelector`ã€`useDispatch` ç­‰èƒ½åŠ›ï¼Œå¯ä»¥æ‰¿è½½ä¸€ä¸ªç²¾ç®€ç‰ˆ Hostã€‚

## 2. PoC æ€è·¯

- åœ¨ `examples/logix-react` ä¸­æ–°å¢ä¸€ä¸ªåœºæ™¯ï¼š
  - ä½¿ç”¨å›ºå®šçš„ TSX ç»„ä»¶ï¼ˆä¸å¿…çœŸæ­£åŠ¨æ€ç¼–è¯‘ï¼‰æ¨¡æ‹Ÿ Skeletonï¼›
  - ä½¿ç”¨ `useLocalModule` æˆ–æœªæ¥çš„ `FormSession` å¯åŠ¨ä¸€ä¸ªå±€éƒ¨ Runtimeï¼›
  - å°† Skeleton ç»„ä»¶åŒ…åœ¨ä¸€ä¸ªé€šç”¨çš„ `<LiveComponentHost module={...} logic={...} />` å†…ï¼ŒéªŒè¯æ¥å£å½¢çŠ¶å’Œ DXã€‚

## 3. é¢„æœŸæ”¶ç›Š

- ä¸º AI Native UI é‡Œçš„ LiveComponent è®¾è®¡æä¾›â€œè½åœ°æ ·æœ¬â€ï¼Œæ”¶æ•›æ¥å£è€Œä¸æ˜¯ç»§ç»­å‘æ•£ï¼›
- éªŒè¯ React Adapter åœ¨ã€Œç»„ä»¶çº§ Runtime + å¹³å°æ³¨å…¥ã€åœºæ™¯ä¸‹æ˜¯å¦éœ€è¦é¢å¤–èƒ½åŠ›ï¼ˆä¾‹å¦‚é”™è¯¯è¾¹ç•Œã€Fallback ç­–ç•¥ï¼‰ã€‚
</file>

<file path="drafts/L9/resource-field-unified-data-plane.md">
---
title: 'Resource Field: ç»Ÿä¸€æ•°æ®å¹³é¢çš„è‰æ¡ˆ'
status: draft
version: 0.1.0
value: vision
priority: 1600
related:
  - ../topics/query-integration/06-unified-data-vision.md
  - ../topics/query-integration/07-schema-link-deep-dive.md
---

# Resource Field: ç»Ÿä¸€æ•°æ®å¹³é¢çš„è‰æ¡ˆ

> æ ¸å¿ƒæƒ³æ³•ï¼šåœ¨ v3 ä¸­å¼•å…¥æ›´æŠ½è±¡çš„ `ResourceField` æ¦‚å¿µï¼Œå°† Query/Socket/Storage/AI ç­‰æ‰€æœ‰â€œæœ‰æ¥æºçš„å­—æ®µâ€ç»Ÿä¸€å»ºæ¨¡ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªåç«¯æŠ€æœ¯åšä¸€å¥—å¹³è¡Œ APIã€‚

## 1. å‡ºå‘ç‚¹

- `query-integration` Topic ä¸­çš„ `Query.field` / `Socket.field` / `Storage.field` / `Link.to` å®é™…ä¸Šéƒ½æ˜¯â€œå­—æ®µæ¥è‡ªæŸä¸ª Resourceâ€çš„ç‰¹ä¾‹ï¼›
- AI Native Core ä¸­å°† `AiOutput` æ˜ å°„åˆ° State Schemaï¼Œä¹Ÿæ˜¯åŒä¸€ç±»é—®é¢˜ï¼šå­—æ®µç”±å¤–éƒ¨æ¨å¯¼æˆ–æ‹‰å–ï¼›
- å½“å‰è‰æ¡ˆå®¹æ˜“æ¼”åŒ–æˆå¤šä¸ªç‹¬ç«‹ mini-frameworkï¼ˆReactive.*ã€@logix/queryã€AI é›†æˆï¼‰ï¼Œå¢åŠ å®ç°å¤æ‚åº¦ã€‚

## 2. è‰æ¡ˆæ–¹å‘

- åœ¨ Schema å±‚æŠ½è±¡å‡º `ResourceField` çš„å…ƒæ¨¡å‹ï¼Œä¾‹å¦‚ï¼š
  - `kind`: `"query" | "socket" | "storage" | "ai" | "env" | ...`ï¼›
  - `source`: ç”¨äºæè¿°å¦‚ä½•ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’ï¼ˆQueryClientã€WebSocketServiceã€AiService ç­‰ï¼‰ï¼›
  - `relation`: å¯é€‰çš„ Schema Link ä¿¡æ¯ï¼Œç”¨äºå£°æ˜ä¸å…¶ä»– Module State çš„å…³è”ï¼›
- ModuleRuntime å§‹ç»ˆåªæŒæœ‰çº¯ JSON çŠ¶æ€ï¼Œæ‰€æœ‰ Resource è¡Œä¸ºåœ¨è£…é…é˜¶æ®µï¼ˆModule.live / Logic é“¾ï¼‰è¢«ç¼–è¯‘æˆ Flow/Linkï¼›
- å°† Query Integration / AI Native Core / External Integration ç¤ºä¾‹éƒ½è§†ä¸º ResourceField çš„ adapterï¼Œè€Œä¸æ˜¯å¹¶åˆ—çš„æ ¸å¿ƒæŠ½è±¡ã€‚

## 3. é¢„æœŸè½ç‚¹

- è‹¥æ–¹å‘éªŒè¯å¯è¡Œï¼Œé•¿è¿œçœ‹åº”è¿›å…¥ï¼š
  - `docs/specs/runtime-logix/core` çš„ State/Store ç« èŠ‚ï¼Œä½œä¸ºç»Ÿä¸€çš„æ•°æ®èŒƒå¼ï¼›
  - `docs/specs/intent-driven-ai-coding/v3` ä¸­çš„ Data/Domain Intent æè¿°ï¼›
- åœ¨æ­¤ä¹‹å‰ï¼Œæœ¬è‰æ¡ˆä»…ä½œä¸ºã€Œæ¦‚å¿µæ”¶æ•›ç‚¹ã€ï¼Œä¸ä¼šç›´æ¥é©±åŠ¨å®ç°ã€‚
</file>

<file path="drafts/L9/runtime-logix-core-gaps-and-production-readiness.md">
---
title: Runtime Logix Core Â· Gaps & Production Readiness Checklist
status: draft
version: 0.1.0
layer: L9
related:
  - ../L5/runtime-core-evolution.md
  - ../topics/react-adapter
  - ../topics/query-integration
  - ./plan-runtime-logix-v1-readiness.md
priority: 1700
---

# Runtime Logix Core Â· Gaps & Production Readiness Checklist

> è‰ç¨¿ç›®çš„ï¼šæ±‡æ€»å½“å‰ Logix v3 Coreï¼ˆ`@logix/core` + `@logix/react`ï¼‰åœ¨ã€Œæ¥è¿‘ç”Ÿäº§å¯ç”¨ã€å‰ä»ç„¶éœ€è¦è¡¥é½çš„å…³é”®ç¼ºå£ï¼Œä¸ºåç»­ PoC/é›†æˆæµ‹è¯•ä¸è§„èŒƒå‡çº§æä¾›ä¸€ä¸ªé›†ä¸­è§†å›¾ï¼›é…å¥—è·¯çº¿å›¾è§ `plan-runtime-logix-v1-readiness.md`ã€‚

æœ¬è‰ç¨¿å›ç­”â€œ**è¿˜æœ‰å“ªäº›å‘æ²¡å¡«**â€ï¼Œè€Œ `plan-runtime-logix-v1-readiness.md` å›ç­”â€œ**æŒ‰ä»€ä¹ˆé˜¶æ®µå¡«ã€åšåˆ°ä»€ä¹ˆç¨‹åº¦ç®— v1.0 Ready**â€ã€‚ä¸¤è€…åº”ä¿æŒåŒæ­¥æ¼”è¿›ã€‚

## 0. ç”Ÿäº§å°±ç»ªè¯„ä¼°ç»´åº¦ï¼ˆç›®æ ‡å¯¹é½ï¼‰

ç»“åˆ v1.0 è§„åˆ’ï¼ŒRuntime Logix çš„ç”Ÿäº§å°±ç»ªè‡³å°‘è¦åœ¨å››ä¸ªç»´åº¦è¾¾æ ‡ï¼š

- **å®‰å…¨æ€§ (Safety)**ï¼šé¿å…â€œå†™é”™ä½†ä¸æŠ¥é”™â€çš„è·¯å¾„ï¼ˆTag å†²çªã€Link é”™è¯¯è¢«æ‚„æ‚„åæ‰ï¼‰ï¼›
- **ç¡®å®šæ€§ (Determinism)**ï¼šå¹¶å‘ä¸ç”Ÿå‘½å‘¨æœŸè¾¹ç•Œæ¸…æ™°å¯é¢„æœŸï¼ˆStrictModeã€Scope é”€æ¯ã€Link/Watcher é‡å¯ç­–ç•¥ï¼‰ï¼›
- **å¯è§‚æµ‹æ€§ (Observability)**ï¼šè·¨æ¨¡å—é“¾è·¯å¯è¿½è¸ªã€æœ‰ç»Ÿä¸€çš„é”™è¯¯äº‹ä»¶æºï¼ˆDebugSink / Lifecycle / AppRuntime errorsï¼‰ï¼›
- **æ€§èƒ½ (Performance)**ï¼šé«˜é¢‘äº¤äº’ä¸‹æ— æ˜æ˜¾å†…å­˜æ³„æ¼ï¼ŒFiber/Scope/è®¢é˜…æ•°é‡åœ¨åˆç†ä¸Šç•Œå†…ã€‚

## 1. å½“å‰åŸºç¡€å¯ç”¨èŒƒå›´ï¼ˆv0 Candidateï¼‰

åœ¨å°èŒƒå›´ PoC / éå…³é”®è·¯å¾„åœºæ™¯ä¸‹ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨çš„èƒ½åŠ›ï¼ˆå‰ææ˜¯æœ‰é™çº§è·¯å¾„ä¸è§‚å¯Ÿæ‰‹æ®µï¼‰ï¼š

- `@logix/core`
  - Module / Runtimeï¼š
    - `Logix.Module` + `ModuleInstance.live`ï¼›
    - `ModuleRuntime.make` + DebugSink / Lifecycle é›†æˆï¼›
    - `ModuleImpl`ï¼š`Module.make({ initial, logics })` + `withLayer/withLayers` + `Logix.provide(ModuleImpl)`ã€‚
  - Bound API / Fluent DSLï¼š
    - `$.state.read/update/mutate`ï¼›
    - `$.onState / $.onAction / $.on` + `run / runParallel / runLatest / runFork`ï¼›
    - `Logic.Link`ï¼šè·¨æ¨¡å—çš„å‘½ä»¤å¼ Orchestratorã€‚
  - Remote / Appï¼š
    - `$.useRemote(Module)`ï¼šåªè¯»ç‰ˆ Bound APIï¼Œç”¨äºè·¨æ¨¡å—è¯»å–/è®¢é˜…/dispatchï¼›
    - `Logix.app` + `Logix.provide` + `processes` + `onError`ã€‚

- `@logix/react`
  - `RuntimeProvider`ï¼šæ‰¿è½½ ManagedRuntime ä¸ Context.Context çš„é€‚é…å±‚ï¼›
  - Hooksï¼š
    - `useModule(handle)` / `useModule(handle, selector)`ï¼›
    - `useSelector(handle, selector)`ï¼›
    - `useLocalModule` / `useLayerModule`ï¼ˆåœ¨ç®€å•åœºæ™¯ä¸‹å°è¯•å±€éƒ¨ ModuleImplï¼‰ã€‚

## 2. å·²çŸ¥å¿…é¡»è¡¥é½çš„æ ¸å¿ƒç¼ºå£

> è¿™äº›æ˜¯ã€Œåœ¨ç”Ÿäº§çº§ä½¿ç”¨å‰å¿…é¡»æœ‰æ˜ç¡®è¡Œä¸ºä¸æµ‹è¯•å…œåº•ã€çš„ç‚¹ï¼Œç›®å‰è¦ä¹ˆåªæœ‰ PoC å®ç°ï¼Œè¦ä¹ˆç¼ºå°‘è§„èŒƒä¸é›†æˆæµ‹è¯•ã€‚

### 2.1 Tag å†²çªä¸ Env æ‹“æ‰‘æ ¡éªŒ

- ç°çŠ¶ï¼š
  - `AppRuntime.makeApp` åªæ ¡éªŒ `module.id` çš„é‡å¤ï¼›
  - è¿è¡Œæ—¶ç¼ºå°‘ Tag Key çº§åˆ«çš„å†²çªæ£€æµ‹ï¼ˆä¾‹å¦‚ä¸¤ä¸ªæ¨¡å—ä½¿ç”¨åŒä¸€ä¸ª `Context.Tag("FooService")`ï¼‰ã€‚
- é£é™©ï¼š
  - Tag å†²çªä¼šå¯¼è‡´ Service è¢«é™é»˜è¦†ç›–ï¼Œè¡¨ç°ä¸ºâ€œå¶å‘ç°è±¡/çŠ¶æ€é”™ä¹±â€ï¼Œéå¸¸éš¾æ’æŸ¥ï¼›
  - å¯¹äºæœªæ¥ Universe / Studio çš„ Env æ‹“æ‰‘è§†å›¾ï¼Œç¼ºå°‘ Tag çº§åˆ«çš„å‡†ç¡®æ€§ä¿è¯ã€‚
- TODOï¼š
  - åœ¨ flatten Layer è¿‡ç¨‹ä¸­å¼•å…¥ `TagIndex`ï¼š
    - æ”¶é›†æ‰€æœ‰ `Context.Tag` çš„ key ä¸ ownerModuleIdï¼›
    - ä¸€æ—¦å‘ç°åŒ key ä¸åŒ Tag å®ä¾‹ï¼Œæ„é€  `TagCollisionError` å¹¶ failï¼›
    - Phase 1 å¯å…ˆå®ç°â€œåªæ ¡éªŒ Module è‡ªèº« Tag + æ˜¾å¼å£°æ˜çš„ Service Tagâ€ï¼ˆå¯¹åº” v1 Plan ä¸­çš„æ–¹æ¡ˆ Cï¼‰ï¼Œå…·ä½“å®ç°è‰æ¡ˆè§ `runtime-logix-tag-collision-detection.md`ï¼Œåç»­å†è€ƒè™‘å¯¹é€šç”¨ Layer åšæ·±åº¦ inspectã€‚
  - è¡¥å……é›†æˆæµ‹è¯•ï¼š
    - è‡³å°‘éªŒè¯â€œä¸¤ä¸ª Module æä¾›ç›¸åŒ key çš„ Tag æ—¶ï¼ŒLogix.app æ„å»ºå¤±è´¥å¹¶ç»™å‡ºæ¸…æ™°é”™è¯¯ä¿¡æ¯â€ï¼›
    - éªŒè¯æ­£å¸¸è·¯å¾„ä¸‹çš„ Tag æ‹“æ‰‘å¯ä»¥è¢«å·¥å…·å‡†ç¡®æšä¸¾ã€‚

### 2.2 Link / useRemote çš„é”™è¯¯ä¸ç”Ÿå‘½å‘¨æœŸè¯­ä¹‰

- ç°çŠ¶ï¼š
  - `ModuleRuntime` å¯¹ forked logics çš„é”™è¯¯ä¼šé€šè¿‡ Lifecycle/DebugSink æ±‡èšï¼ŒLink ä½¿ç”¨æ—¶ä¾èµ–è¿™ä¸€å±‚è¡Œä¸ºï¼›
  - `Logix.app` çš„ `onError` ä¼šåœ¨ processes fail æ—¶è¢«è°ƒç”¨ï¼›
  - å¯¹äºï¼š
    - Link å†…éƒ¨æŠ›é”™ï¼ˆfail/dieï¼‰ï¼›
    - é€šè¿‡ `$.useRemote(...)` æ„é€ çš„è·¨æ¨¡å— watcher å‡ºç°é”™è¯¯ï¼›
    å½“å‰è§„èŒƒæ²¡æœ‰æ˜ç¡®çº¦å®šï¼š
    - æ˜¯å¦è‡ªåŠ¨é‡å¯ï¼›
    - é”™è¯¯æ˜¯å¦åº”æ‰©æ•£åˆ° App çº§åˆ«ï¼Œè¿˜æ˜¯åœç•™åœ¨æ¨¡å—/Link èŒƒå›´ã€‚
- é£é™©ï¼š
  - å¤æ‚é“¾è·¯ä¸­æŸä¸ª Link æˆ– Remote watcher æŒ‚æ‰åï¼Œå¯èƒ½æ‚„æ‚„åœæ­¢å·¥ä½œè€Œæ²¡æœ‰æ˜æ˜¾å‘Šè­¦ï¼›
  - è‹¥é”™è¯¯è¢«è¯¯å¯¼è‡´æ•´ä¸ª AppRuntime å¤±è´¥ï¼Œç”Ÿäº§å¯ç”¨æ€§ä¼šå—å½±å“ã€‚
- TODOï¼š
  - åœ¨ `runtime-logix` è§„èŒƒä¸­æ˜ç¡®ï¼š
    - Link çš„é”™è¯¯è¯­ä¹‰ï¼ˆæ˜¯å¦è§†ä¸ºâ€œæµç¨‹çº§é”™è¯¯â€ï¼Œæ˜¯å¦éœ€è¦é‡è¯•/é‡å¯ç­–ç•¥ï¼‰ï¼›
    - useRemote watcher çš„é”™è¯¯å½’å±ï¼ˆç®—å½“å‰æ¨¡å—çš„ Flow é”™è¯¯ï¼Œè¿˜æ˜¯ Link ç±»é”™è¯¯ï¼‰ã€‚
  - åœ¨ `@logix/core` ä¸­è¡¥å……é›†æˆæµ‹è¯•ï¼š
    - Link logic ä¸­æŠ›é”™ â†’ ç”Ÿå‘½å‘¨æœŸä¸ DebugSink çš„è¡¨ç°ï¼›
    - RemoteBound (`$.useRemote`) ä¸­æŠ›é”™ â†’ `api.lifecycle.onError` ä¸ App `onError` æ˜¯å¦èƒ½æ•æ‰åˆ°ã€‚
  - ä¸ v1.0 Plan å¯¹é½çš„é»˜è®¤ç­–ç•¥ï¼š
    - Link / Remote watcher å‡ºé”™æ—¶ï¼Œ**ä¼˜å…ˆé€‰æ‹©â€œæŠ¥å‘Šä½†ä¸ä¸­æ–­è°ƒç”¨æ–¹ Flowâ€**ï¼šé”™è¯¯è¿›å…¥ `api.lifecycle.onError` + App `onError`ï¼Œç”±ä¸Šå±‚å†³å®šæ˜¯å¦é‡å¯æˆ–é™çº§ï¼Œè€Œä¸æ˜¯ç›´æ¥ crash æ•´ä¸ª AppRuntimeï¼›
    - å¯¹å…³é”® Link å¯é€‰åŒ…è£… `Effect.retry` æˆ– Supervisorï¼Œå®ç°å¯é…ç½®çš„é‡è¯•/ç†”æ–­è¡Œä¸ºã€‚

### 2.3 ReactPlatform ä¸ Platform Tag çš„é›†æˆ

- ç°çŠ¶ï¼š
  - `@logix/react/src/ReactPlatform.ts` ä»…å¯¼å‡º Provider + hooks + `createRoot`ï¼›
  - `RuntimeProvider` å†…éƒ¨é¢„ç•™äº† `platformBinding` å ä½ï¼Œä½†è¿˜æ²¡æœ‰å‘ `@logix/core` çš„ `Platform` Tag æ³¨å…¥ä»»ä½• React ä¾§èƒ½åŠ›ï¼ˆå¦‚ onSuspend/onResume/onResetï¼‰ã€‚
- é£é™©ï¼š
  - åœ¨ React åº”ç”¨é‡Œï¼Œ`api.lifecycle.onSuspend/onResume/onReset` ç­‰å¹³å°èƒ½åŠ›ä¸ä¼šè¢«è§¦å‘ï¼›
  - æ— æ³•åœ¨â€œå‰ç«¯åº”ç”¨å¯è§æ€§/è·¯ç”±/Tabâ€ç­‰ç»´åº¦ä¸Šå¯¹ watcher/Flow è¿›è¡ŒèŠ‚æµæˆ–æš‚åœã€‚
- TODOï¼š
  - åœ¨ React å±‚è®¾è®¡æœ€å°çš„ `Platform` å®ç°ï¼š
    - onSuspend/onResume ä¸æµè§ˆå™¨å¯è§æ€§/è·¯ç”±å˜æ›´ç­‰äº‹ä»¶çš„æ˜ å°„ç­–ç•¥ï¼›
    - onReset ä¸ç”¨æˆ·ç™»å‡º/è¡¨å•æ¸…ç©ºç­‰ UI æ“ä½œçš„æ˜ å°„ç­–ç•¥ã€‚
  - åœ¨ `RuntimeProvider` ä¸­ï¼š
    - å°† ReactPlatform çš„ Platform å®ä¾‹æ‰“å…¥ `Layer`ï¼›
    - ç”¨ hooks/bridge æŠŠ React ç”Ÿå‘½å‘¨æœŸäº‹ä»¶è½¬åŒ–ä¸º Platform è°ƒç”¨ã€‚
  - è¡¥å…… React å±‚é›†æˆæµ‹è¯•ï¼š
    - æ¨¡æ‹Ÿä¸€ä¸ªä½¿ç”¨ `api.lifecycle.onSuspend` çš„é€»è¾‘ï¼Œåœ¨â€œä¼ªé€ çš„å¯è§æ€§å˜åŒ–â€ä¸‹éªŒè¯è¡Œä¸ºã€‚

### 2.4 é•¿ç”Ÿå‘½å‘¨æœŸ / é«˜å¹¶å‘ watcher çš„å†…å­˜ä¸æ€§èƒ½

- ç°çŠ¶ï¼š
  - `runFork / runParallel / Link / useRemote` ç­‰èƒ½åŠ›ä¼šåœ¨èƒŒå fork watcher Fiberï¼›
  - ç°æœ‰ç”¨ä¾‹åªéªŒè¯äº†å°‘é‡ dispatch çš„è¯­ä¹‰æ­£ç¡®æ€§ï¼Œæ²¡æœ‰éªŒè¯æŒç»­é«˜é¢‘äº‹ä»¶æˆ–é•¿æ—¶é—´è¿è¡Œä¸‹çš„è¡Œä¸ºã€‚
- é£é™©ï¼š
  - è®¢é˜…æ³„æ¼ï¼šé‡å¤ mount/unmount æ¨¡å—ã€é‡å¤æ³¨å†Œ watcher æ—¶ï¼ŒScope ä¸å½“ç®¡ç†å¯èƒ½å¯¼è‡´ Fiber å †ç§¯ï¼›
  - æ€§èƒ½é—®é¢˜ï¼šé«˜é¢‘äº‹ä»¶æµï¼ˆæœç´¢è”æƒ³/æ»šåŠ¨/å¿ƒè·³ï¼‰ä¸‹çš„ CPU/GC å‹åŠ›æœªçŸ¥ã€‚
- TODOï¼š
  - è®¾è®¡ 1â€“2 ç»„å‹åŠ›æµ‹è¯•ï¼ˆå¯å…ˆæ”¾åœ¨å†…éƒ¨ util/benchmarksï¼Œè€Œéæ­£å¼ test suiteï¼‰ï¼š
    - å•æ¨¡å— + é«˜é¢‘ `onAction(...).runFork`ï¼›
    - å¤šæ¨¡å— + Link + useRemote è”åŠ¨ï¼›
  - è§‚æµ‹æŒ‡æ ‡ï¼š
    - Fiber æ•°é‡ / SubscriptionRef æ•°é‡çš„ä¸Šç•Œï¼›
    - é•¿æ—¶é—´è¿è¡Œåçš„å†…å­˜ä½¿ç”¨ï¼›
    - åœ¨æµ‹è¯• Runtime ä¸­æ•…æ„è§¦å‘å¤§é‡ create/destroyï¼Œçœ‹ Scope æ˜¯å¦è¢« correctly closeã€‚
  - æ›´ç»†åŒ–çš„åœºæ™¯è®¾è®¡ä¸æŒ‡æ ‡å®šä¹‰è§ `runtime-logix-watcher-perf-and-leak-check.md`ã€‚

### 2.5 ModuleImpl / withLayer / useLocalModule çš„ç»„åˆè¾¹ç•Œ

- ç°çŠ¶ï¼š
  - `Module.make({ initial, logics })` + `ModuleImpl.withLayer/withLayers` + `Logix.provide(ModuleImpl)` åœ¨ core å±‚å·²ç»æœ‰æˆä½“ç³»çš„å®ç°ä¸å•æµ‹å…œåº•ï¼š
    - `ModuleImpl.test.ts` éªŒè¯äº† withLayer æ³¨å…¥ Service åï¼ŒLogic ä¸­çš„ `yield* ServiceTag` èƒ½æ­£ç¡®æ‹¿åˆ°å®ç°ï¼ŒçŠ¶æ€ä¹Ÿå¦‚é¢„æœŸæ›´æ–°ï¼›
    - `Logix.provide(ModuleImpl)` + `Logix.app` ç»„åˆåï¼ŒåŒæ ·è¡Œä¸ºåœ¨ AppRuntime ç¯å¢ƒä¸‹ä¿æŒä¸€è‡´ï¼›
  - React å±‚ `useLocalModule` / `useModule(impl)` èƒ½åˆ›å»ºå±€éƒ¨ ModuleRuntimeï¼Œå¹¶åœ¨ç»„ä»¶å¸è½½æ—¶å…³é—­ Scopeï¼Œä½†ç¼ºå°‘â€œå¤æ‚ Env ç»„åˆ + å¤šå±‚åµŒå¥—â€çš„ç³»ç»Ÿæµ‹è¯•ï¼š
    - å¤šä¸ª ModuleImpl åœ¨ç»„ä»¶æ ‘ä¸­çš„åµŒå¥—ä¸å…±äº«ï¼›
    - useLocalModule åˆ›å»ºçš„å±€éƒ¨ ModuleRuntime ä¸ä¸Šå±‚ AppRuntime çš„ Env å åŠ é¡ºåºï¼›
    - åŒä¸€ ServiceTag åœ¨ App çº§ä¸å±€éƒ¨ ModuleImpl çº§åŒæ—¶å­˜åœ¨æ—¶çš„è§£æä¼˜å…ˆçº§ã€‚
- é£é™©ï¼š
  - åœ¨å¤æ‚ UI ä¸­å¤§é‡ä½¿ç”¨å±€éƒ¨ ModuleImpl æ—¶ï¼Œå¯èƒ½å‡ºç°ï¼š
    - Env æä¾›é¡ºåºä¸ä¸€è‡´ï¼ˆæŸäº› Service åœ¨å±€éƒ¨è¢«è¦†ç›–æˆ–æ„å¤–æ³„æ¼åˆ°å…¨å±€ï¼‰ï¼›
    - Scope æ³„æ¼æˆ–é‡å¤ disposeï¼›
    - React ä¸ Logix.app å¯¹åŒä¸€ Service çš„æä¾›é¡ºåºä¸ä¸€è‡´ï¼Œå¯¼è‡´è¡Œä¸ºåœ¨ä¸åŒæŒ‚è½½æ–¹å¼ä¸‹å‡ºç°ç»†å¾®å·®å¼‚ã€‚
- TODOï¼š
  - åœ¨ core å±‚ä¿æŒç°æœ‰ ModuleImpl æµ‹è¯•ä¸ºâ€œå›å½’å¿…è·‘â€é›†åˆï¼Œåç»­æ”¹åŠ¨ä¸å¾—ç ´åï¼›
  - åœ¨ React å±‚è¡¥å……è‡³å°‘ä¸€ç»„é›†æˆç”¨ä¾‹ï¼š
    - `useLocalModule(impl)` + `useLayerModule` åœ¨ä¸€ä¸ªç»„ä»¶ä¸‹åˆ›å»º/é”€æ¯å¤šä¸ª ModuleRuntimeï¼Œæ£€æŸ¥ DebugSink/Scope äº‹ä»¶ï¼›
    - ç»„åˆ useLocalModule ä¸ AppRuntime æä¾›çš„ Envï¼ŒéªŒè¯ Service è§£æé¡ºåºä¸é¢„æœŸä¸€è‡´ï¼Œå¿…è¦æ—¶åœ¨æ–‡æ¡£ä¸­å›ºå®šè§£æä¼˜å…ˆçº§ï¼›
    - éªŒè¯åŒä¸€ ModuleImpl åœ¨ä¸åŒ RuntimeProvider æ ‘ä¸‹å¤ç”¨æ—¶ï¼ŒService æ³¨å…¥ä»ç„¶å±€éƒ¨ç”Ÿæ•ˆä¸”ä¸ä¼šäº’ç›¸æ±¡æŸ“ã€‚

### 2.6 React StrictMode / Suspense / é”™è¯¯è¾¹ç•Œè¡Œä¸º

- ç°çŠ¶ï¼š
  - `RuntimeProvider` åœ¨å®ç°ä¸Šè€ƒè™‘äº† StrictMode ä¸‹çš„ â€œåŒè°ƒç”¨â€ é—®é¢˜ï¼ˆé€šè¿‡ useRef ç¼“å­˜ AppRuntimeï¼‰ï¼Œä½†ç¼ºå°‘ç³»ç»Ÿæµ‹è¯•ï¼›
  - Suspense / ErrorBoundary ä¸ Logix error çš„äº¤äº’å°šæœªè®¾è®¡ï¼ˆç›®å‰ error é€šè¿‡ lifecycle.onError/DebugSink å¤„ç†ï¼Œæœªè€ƒè™‘ React error boundaryï¼‰ã€‚
- é£é™©ï¼š
  - åœ¨å¼€å¯ StrictMode çš„å¼€å‘ç¯å¢ƒä¸‹ï¼ŒRuntime åˆ›å»º/é”€æ¯æ¬¡æ•°å¯èƒ½ä¸é¢„æœŸä¸ä¸€è‡´ï¼›
  - åœ¨ç”Ÿäº§ä¸­ï¼Œå½“ Logic die æ—¶ï¼ŒReact UI æ˜¯å¦åº”è¯¥æ„ŸçŸ¥å¹¶å±•ç¤ºé”™è¯¯ä¸æ˜ç¡®ã€‚
- TODOï¼š
  - æ˜ç¡®ç­–ç•¥ï¼š
    - StrictMode ä¸‹æ˜¯å¦å…è®¸æŸäº›èµ„æºâ€œå¤šåˆ›å»ºä¸€æ¬¡ä½†ä¸ disposeâ€ï¼Œä»¥åŠå“ªäº›å¿…é¡»ä¸¥æ ¼æˆå¯¹ï¼›
    - Logic error æ˜¯å¦ã€ä»¥åŠå¦‚ä½• bubble åˆ° React ErrorBoundaryã€‚
  - è¡¥å…… React å±‚æµ‹è¯•æˆ– demoï¼š
    - åœ¨ StrictMode + Suspense ç¯å¢ƒä¸‹ mount/unmount RuntimeProvider å’Œä½¿ç”¨ä¸­çš„æ¨¡å—ç»„ä»¶ï¼›
    - æµ‹è¯• error boundary + lifecycle.onError ç»„åˆè¡Œä¸ºã€‚
  - ç»“åˆ v1 Planï¼Œè€ƒè™‘åœ¨ AppRuntime å±‚æš´éœ²ä¸€ä¸ªåªè¯»çš„ `errors$` / Hubï¼š
    - æ±‡èš processes / Link / Logic çš„é”™è¯¯äº‹ä»¶ï¼›
    - React ä¾§ RuntimeProvider å¯ä»¥åŸºäºè¯¥é€šé“ï¼Œå°†â€œå…¨å±€ä¸å¯æ¢å¤é”™è¯¯â€æ˜ å°„åˆ° ErrorBoundaryï¼ˆä¾‹å¦‚é€šè¿‡å†…éƒ¨ `setState(error)` è§¦å‘ throwï¼‰ã€‚

### 2.7 ç»Ÿä¸€è§‚æµ‹é€šé“ï¼ˆApp çº§äº‹ä»¶ / é”™è¯¯æµï¼‰

- ç°çŠ¶ï¼š
  - ModuleRuntime å·²é€šè¿‡ DebugSink ä¸ lifecycle.onError æš´éœ²æ¨¡å—çº§äº‹ä»¶ï¼›
  - AppRuntime å¯¹ processes æä¾›äº† `onError` å›è°ƒï¼Œä½†ç¼ºå°‘ä¸€ä¸ªç»Ÿä¸€çš„ App çº§äº‹ä»¶/é”™è¯¯é€šé“ï¼›
  - React / CLI / åå°ä»»åŠ¡ç›®å‰åªèƒ½â€œå„è‡ªè®¢é˜…å„è‡ªçš„é”™è¯¯â€ï¼Œä¸åˆ©äºæ­å»ºç»Ÿä¸€çš„ç›‘æ§ä¸å‘Šè­¦ã€‚
- é£é™©ï¼š
  - å¤æ‚åœºæ™¯ä¸‹ï¼ˆå¤šæ¨¡å—ã€å¤š Linkã€å¤š processesï¼‰ï¼Œé—®é¢˜å®šä½éœ€è¦åŒæ—¶æŸ¥çœ‹ DebugSink / lifecycle.onError / App onErrorï¼Œå¤šæºä¿¡æ¯ä¸æ˜“èšåˆï¼›
  - åç»­è¦åšâ€œè¿è¡Œæ—¶ä»ªè¡¨ç›˜ / ç›‘æ§æ’ä»¶â€æ—¶ï¼Œæ²¡æœ‰ä¸€ä¸ªæ ‡å‡†çš„å…¥å£å¯å¤ç”¨ã€‚
- TODOï¼š
  - åœ¨ AppRuntime å±‚è®¾è®¡ä¸€ä¸ªåªè¯»çš„äº‹ä»¶æµï¼ˆä¾‹å¦‚ `AppEvents` / `errors$`ï¼‰ï¼š
    - æ±‡æ€»å…³é”®äº‹ä»¶ï¼šModule lifecycle.errorã€Link/useRemote watcher é”™è¯¯ã€processes é”™è¯¯ç­‰ï¼›
    - æ˜ç¡®äº‹ä»¶æ¨¡å‹ä¸è®¢é˜…æ–¹å¼ï¼ˆEffect.Stream / PubSub ç­‰ï¼‰ï¼Œä¾¿äºä¸Šå±‚ç»‘å®šåˆ°æ—¥å¿—/ç›‘æ§ç³»ç»Ÿã€‚
  - åœ¨ React/CLI å±‚è¡¥å……æœ€å°ç¤ºä¾‹ï¼š
    - Reactï¼šRuntimeProvider å†…éƒ¨è®¢é˜…è¯¥é€šé“ï¼Œå°†â€œå…¨å±€ä¸å¯æ¢å¤é”™è¯¯â€æ˜ å°„åˆ° ErrorBoundary æˆ–å…¨å±€æç¤ºï¼›
    - CLI/è„šæœ¬ï¼šè®¢é˜…äº‹ä»¶æµï¼Œå°†é”™è¯¯æ‰“å°æˆ–ä¸ŠæŠ¥åˆ°é›†ä¸­æ—¥å¿—ã€‚

## 3. å»ºè®®çš„æ¨è¿›é¡ºåºï¼ˆç”Ÿäº§å‰æœ€å°è¡¥é½é›†ï¼‰

1. Tag å†²çªæ£€æµ‹ + AppRuntime.onError é›†æˆæµ‹è¯•  
2. Link / useRemote é”™è¯¯è¯­ä¹‰è§„èŒƒ + ç®€å•é›†æˆæµ‹è¯•ï¼ˆæ ¸å¿ƒé“¾è·¯ä¸€æ¡ï¼‰  
3. ReactPlatform â†’ Platform Tag çš„æœ€å°é›†æˆï¼ˆonSuspend/onResume/onResetï¼‰  
4. å‹åŠ›æµ‹è¯•ï¼ˆé«˜é¢‘ watcher + é•¿ç”Ÿå‘½å‘¨æœŸï¼‰  
5. ModuleImpl / useLocalModule è¾¹ç•Œåœºæ™¯å®éªŒ  
6. React StrictMode/Suspense/ErrorBoundary ç­–ç•¥è®¾è®¡ä¸ PoC

å®Œæˆä¸Šè¿°æœ€å°é›†åï¼Œå¯å°†å½“å‰ v0 èƒ½åŠ›æ ‡è®°ä¸ºâ€œæœ‰é™ç”Ÿäº§å¯ç”¨ï¼ˆåœ¨å·²çŸ¥æ¨¡å¼å’Œè¾¹ç•Œå†…ä½¿ç”¨ï¼‰â€ï¼Œå¹¶åœ¨ `runtime-logix` ä¸ç›¸å…³ Topics ä¸­æ›´æ–°è§„èŒƒï¼›  
æ›´ç»†åŒ–çš„ Phase1/2/3 ä»»åŠ¡æ‹†åˆ†ï¼ˆåŒ…å« Tag æ£€æµ‹å®ç°ç­–ç•¥ã€React ErrorBoundary é›†æˆã€å‹åŠ›æµ‹è¯•è„šæœ¬ä¸è¦†ç›–ç‡ç›®æ ‡ï¼‰è§ `plan-runtime-logix-v1-readiness.md`ã€‚
</file>

<file path="drafts/L9/runtime-logix-devtools-and-runtime-tree.md">
---
title: 'Runtime Logix Â· DevTools, Runtime Tree & TagIndex (Draft)'
status: draft
version: 0.1.0
layer: L9
value: extension
priority: 2100
related:
  - ./runtime-logix-fractal-runtime-and-feature-architecture.md
  - ./runtime-logix-core-gaps-and-production-readiness.md
  - ./runtime-logix-tag-collision-detection.md
---

# Runtime Logix Â· DevTools, Runtime Tree & TagIndex (Draft)

> è‰ç¨¿ç›®çš„ï¼šä¸“é—¨æ‰¿è½½ä¸ Runtime Tree å¯è§†åŒ–ã€DevTools é›†æˆã€TagIndex è§‚æµ‹é¢ç›¸å…³çš„è®¾è®¡æ€è€ƒï¼Œä¸åˆ†å½¢ Runtime æ¶æ„è‰æ¡ˆè§£è€¦ã€‚
> 
> æœ¬è‰æ¡ˆå½“å‰åªå ä½ï¼Œä¸å¯¹å…·ä½“ API åšç»“è®ºã€‚å¾…åˆ†å½¢ Runtime / Tag å†²çªæ£€æµ‹ç­‰åŸºç¡€èƒ½åŠ›ç¨³å®šåï¼Œå†é›†ä¸­è¡¥å……ã€‚

## 1. åˆæ­¥èŒƒå›´

- å®šä¹‰æ¯é¢— Runtime çš„æœ€å°å¯è§‚æµ‹å…ƒä¿¡æ¯ï¼ˆRuntimeMetaï¼‰ï¼›
- åŸºäº TagIndex æ„å»º Env æ‹“æ‰‘è§†å›¾ï¼ˆModule / Service / Tag å…³ç³»ï¼‰ï¼›
- æä¾› Debug API æˆ– DevTools Hookï¼Œä»¥ä¾¿åœ¨æµè§ˆå™¨/CLI ä¸­æŸ¥çœ‹ Runtime Treeï¼›
- ä¸ç›´æ¥å½±å“ Runtime æ ¸å¿ƒè¡Œä¸ºï¼Œä»…ä½œä¸ºè§‚æµ‹ä¸è°ƒè¯•å±‚ã€‚

## 2. æš‚ç¼“äº‹é¡¹

ä»¥ä¸‹è®®é¢˜å°†æš‚ç¼“åˆ°æœ¬è‰æ¡ˆå®Œå–„é˜¶æ®µè®¨è®ºï¼Œä¸åœ¨åˆ†å½¢ Runtime æ¶æ„è‰æ¡ˆä¸­å±•å¼€ï¼š

- Runtime Tree / Module Tree / Link/Process è§†å›¾çš„å…·ä½“ UI å½¢æ€ï¼›
- RuntimeMeta / TagIndex çš„ç²¾ç¡®æ•°æ®ç»“æ„ä¸å¯¼å‡ºæ–¹å¼ï¼›
- ä¸ React DevTools / æµè§ˆå™¨æ‰©å±•çš„é›†æˆæ–¹å¼ï¼›
- å¯¹ DebugSink / Lifecycle / App çº§ events$ çš„ç»Ÿä¸€æ•´åˆã€‚

å½“åˆ†å½¢ Runtime æ¶æ„ä¸ Tag å†²çªæ£€æµ‹æœºåˆ¶è½åœ°åï¼Œå†å›´ç»•æœ¬è‰æ¡ˆè¡¥å…¨ DevTools ç›¸å…³è®¾è®¡ã€‚
</file>

<file path="drafts/L9/runtime-logix-fractal-runtime-and-feature-architecture.md">
---
title: Runtime Logix Â· Fractal Runtime & Feature Architecture
status: draft
version: 0.1.0
layer: L9
value: core
priority: 2200
related:
  - ./runtime-logix-core-gaps-and-production-readiness.md
  - ./plan-runtime-logix-v1-readiness.md
  - ../../runtime-logix/core/02-module-and-logic-api.md
  - ../../runtime-logix/core/05-runtime-implementation.md
---

# Runtime Logix Â· Fractal Runtime & Feature Architecture

> è‰ç¨¿ç›®çš„ï¼šåœ¨ç°æœ‰ Logix v3 ä½“ç³»ä¸Šï¼Œä»¥â€œåˆ†å½¢è¿è¡Œæ—¶ (Fractal Runtime)â€ä¸ºè§†è§’ï¼Œç»Ÿä¸€ Module / ModuleImpl / Link / Logix.app / React RuntimeProvider ç­‰æ¦‚å¿µï¼Œæ”¶æŸå‡ºç®€æ´çš„ä¸€å¯¹åŸè¯­ï¼š
>
> - **Moduleï¼ˆå›¾çº¸ï¼‰**ï¼šæè¿°çŠ¶æ€/è¡Œä¸º/ä¾èµ–/è¿›ç¨‹ï¼›
> - **Runtimeï¼ˆå®¹å™¨ï¼‰**ï¼šåœ¨æŸä¸ª Scope ä¸­è¿è¡Œä¸€ä»½ Root Module çš„å®ç°è“å›¾ã€‚
>
> æœ¬è‰ç¨¿åªåšæ¶æ„ä¸ API å½¢æ€ä¸Šçš„è§„åˆ’ï¼Œå…·ä½“å®ç°ç»†èŠ‚ä¸æ¼”è¿›è·¯çº¿å‚è§ `runtime-logix/core/*` ä¸ `impl/*` åç»­æ›´æ–°ã€‚

---

## 1. èƒŒæ™¯ä¸é—®é¢˜

å½“å‰ Runtime Logix ä½“ç³»ä¸­ï¼Œå­˜åœ¨ä¸€ç»„â€œæ¦‚å¿µç›¸è¿‘ä½†å±‚çº§ç•¥æ˜¾å‰²è£‚â€çš„å…¥å£ï¼š

- å®šä¹‰å±‚ï¼š
  - `Logix.Module`ï¼ˆæ¨¡å—å®šä¹‰ï¼‰ï¼›
  - `Module.logic(($)=>Effect)`ï¼ˆæ¨¡å—å†…é€»è¾‘ï¼‰ï¼›
  - `Module.live(initial, ...logics)`ï¼ˆä¸€æ¬¡æ€§ Live Layerï¼‰ã€‚
- å®ç°å±‚ï¼š
  - `Module.make({ initial, logics, imports? })` â†’ `ModuleImpl`ï¼ˆå®ç°è“å›¾ï¼‰ï¼›
  - `ModuleImpl.withLayer/withLayers`ï¼ˆè£…é…è€…å±€éƒ¨è¦†å†™ Envï¼‰ã€‚
- è¿è¡Œæ—¶å±‚ï¼š
  - `Logix.app({ layer, modules, processes, onError })` + `AppRuntime.makeApp`ï¼›
  - `ManagedRuntime.make(layer)`ã€‚
- è·¨æ¨¡å—åä½œå±‚ï¼š
  - `$.useRemote(Module)` â†’ RemoteBound APIï¼ˆåœ¨æ¨¡å—å†…éƒ¨å†™è·¨æ¨¡å—é€»è¾‘ï¼‰ï¼›
  - `Logix.Link({ a: ModuleA, b: ModuleB }, ($)=>Effect)`ï¼ˆåœ¨ App çº§å†™è·¨æ¨¡å—ç¼–æ’ï¼‰ã€‚

åœ¨â€œåˆ†å½¢è¿è¡Œæ—¶â€çš„è§†è§’ä¸‹ï¼š

- App / Page / Widget / å±€éƒ¨ Feature æœ¬è´¨ä¸Šéƒ½æ˜¯ã€Œä¸€ä»½ Root Module å®ç°è“å›¾ + ä¸€é¢— Runtime å®ä¾‹ã€ï¼›
- æ‰€è°“â€œå…¨å±€æ¨¡å— vs å±€éƒ¨æ¨¡å—â€ï¼Œåªæ˜¯â€œè¿™ä¸ª ModuleRuntime æŒ‚åœ¨å“ªé¢— Runtime ä¹‹ä¸‹â€çš„å·®å¼‚ï¼›
- Link è¿™æ ·çš„ç¼–æ’é€»è¾‘ï¼Œæœ¬è´¨ä¸Šæ˜¯â€œæŸä¸ª Runtime å†…çš„é•¿æœŸè¿›ç¨‹ (process)â€ï¼Œè€Œä¸æ˜¯æŸä¸ªæ¨¡å—å†…éƒ¨çš„ä¸€å—é€»è¾‘ã€‚

æˆ‘ä»¬å¸Œæœ›ï¼š

1. ç”¨ç»Ÿä¸€çš„ `Module`/`ModuleImpl` è¡¨è¾¾ä¸€åˆ‡ä¸šåŠ¡/Feature å›¾çº¸ï¼›
2. ç”¨ç»Ÿä¸€çš„ `LogixRuntime` è¡¨è¾¾ä¸€åˆ‡è¿è¡Œæ—¶å®¹å™¨ï¼ˆæ— è®ºæ˜¯ App çº§è¿˜æ˜¯å±€éƒ¨ Runtimeï¼‰ï¼›
3. è®© Link/è¿›ç¨‹ä»¥â€œRoot Module çš„ processesâ€èº«ä»½å­˜åœ¨ï¼Œè€Œä¸æ˜¯å¤–æŒ‚åœ¨ `Logix.app` æˆ–æŸä¸ªå­æ¨¡å—ä¸Šã€‚

---

## 2. ç›®æ ‡æ¨¡å‹ï¼šModule / ModuleImpl / Runtime / Link

### 2.1 Moduleï¼šå›¾çº¸ï¼ˆBlueprintï¼‰

ç»Ÿä¸€ä½¿ç”¨ `Logix.Module("Id", { state, actions })` å®šä¹‰é¢†åŸŸæ¨¡å—ï¼š

- èŒè´£ï¼š
  - æè¿°é¢†åŸŸçŠ¶æ€ä¸è¡Œä¸ºå½¢çŠ¶ï¼ˆ`state` / `actions` Schemaï¼‰ï¼›
  - æä¾›é€»è¾‘å·¥å‚ï¼š`Module.logic(($)=>Effect)`ï¼›
  - æä¾› Live å·¥å‚ï¼š`Module.live(initial, ...logics)`ï¼›
  - æä¾›å®ç°è“å›¾å·¥å‚ï¼š`Module.make({ initial, logics, imports?, processes? })`ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚
- ç‰¹æ€§ï¼š
  - åŒæ—¶æ˜¯ä¸€ä¸ª `Context.Tag<ModuleRuntime>`ï¼Œå¯ç”¨äº Env/Layer/`$.use`ï¼›
  - è‡ªèº«ä¸æŒæœ‰è¿è¡Œæ—¶å®ä¾‹ï¼Œå…¨å±€/å±€éƒ¨å®ä¾‹ç”± Runtime å†³å®šã€‚

### 2.2 ModuleImplï¼šå®ç°è“å›¾ï¼ˆImplementation Blueprintï¼‰

`Module.make(...)` è¿”å›çš„ `ModuleImpl` æ‰¿è½½ä¸€ä¸ªæ¨¡å—çš„ **å…·ä½“å®ç°**ï¼š

- æˆå‘˜ï¼š
  - `module`: å¯¹åº”çš„ `ModuleInstance`ï¼›
  - `layer`: `Layer<ModuleRuntime<State, Action>, never, any>`ï¼š
    - ç¼–è¯‘æœŸè§†ä¸ºâ€œModuleRuntime + å‰©ä½™ Env çš„æ„é€ é…æ–¹â€ï¼›
    - è¿è¡Œæ—¶é€šè¿‡ `Layer.build` æ„é€ å‡ºå…·ä½“ Context/Runtimeã€‚
  - `withLayer/withLayers`ï¼š
    - ç»™è°ƒç”¨æ–¹ï¼ˆè£…é…è€… / æµ‹è¯•ï¼‰æä¾›å±€éƒ¨è¦†å†™ Env çš„ escape hatchï¼›
    - åœ¨ä¸ç ´ååŸæœ‰ imports çš„å‰æä¸‹ï¼Œå åŠ é¢å¤– Service/å¹³å°èƒ½åŠ›ã€‚
- `make` çš„é…ç½®ï¼š
  - `initial`: åˆå§‹ Stateï¼›
  - `logics`: è¯¥ Module ä¸ŠæŒ‚è½½çš„ Logic åˆ—è¡¨ï¼›
  - `imports`: **é»˜è®¤ä¾èµ–**ï¼š
    - ä»»æ„ `Layer`ï¼ˆService / å¹³å°èƒ½åŠ›ç­‰ï¼‰ï¼›
    - æˆ–å…¶ä»– `ModuleImpl`ï¼ˆFeature å†…çš„å­æ¨¡å—å®ç°ï¼‰ï¼›
    - åœ¨å®ç°å±‚é€šè¿‡ `withLayer` å åŠ ï¼Œä¿è¯ï¼š
      - Logic å†…å¯é€šè¿‡ Tag è®¿é—®è¿™äº› Service/ModuleRuntimeï¼›
      - æœ€ç»ˆ Context ä¸­ä¹Ÿèƒ½ `Context.get(Tag)` å–åˆ°å®ƒä»¬ã€‚
  - `processes`ï¼ˆè§„åˆ’ä¸­ï¼‰ï¼šä¸è¯¥ Module/Feature ç›¸å…³çš„é•¿æœŸé€»è¾‘ï¼ˆå« Linkï¼‰ã€‚

> çº¦å®šï¼š
> - Module ä½œè€…ï¼šä¼˜å…ˆé€šè¿‡ `make({ initial, logics, imports, processes })` å£°æ˜é»˜è®¤ä¾èµ–ä¸è¿›ç¨‹ï¼›
> - è£…é…è€…/æµ‹è¯•ï¼šä¼˜å…ˆé€šè¿‡ `impl.withLayer/withLayers` åšå±€éƒ¨è¦†å†™ï¼Œè€Œä¸æ˜¯æ”¹æ¨¡å—æºç ã€‚

### 2.3 LogixRuntimeï¼šè¿è¡Œæ—¶å®¹å™¨ï¼ˆRuntime Containerï¼‰

**ç»Ÿä¸€ Runtime APIï¼ˆç›®æ ‡å½¢æ€ï¼‰ï¼š**

```ts
const runtime = LogixRuntime.make(AppRootImpl, {
  layer?: Layer.Layer<any, never, never>,  // é¡¶å±‚é¢å¤– Envï¼ˆå¦‚ Configã€å¹³å°æœåŠ¡ï¼‰
  onError?: (cause: Cause.Cause<unknown>) => Effect.Effect<void, never, never>
})
```

å¯¹å¤–ç»Ÿä¸€ä»¥ `LogixRuntime.make` å½¢å¼å¯¼å‡ºè¿è¡Œæ—¶æ„é€ å‡½æ•°ï¼›`AppRuntime` / `AppDefinition` ç­‰æ—§å…¥å£ä»…ä½œä¸ºå†…éƒ¨å®ç°ç»†èŠ‚å­˜åœ¨ã€‚

èŒè´£ï¼š

1. **build**ï¼šåŸºäº RootModuleImpl çš„ `layer`ã€`imports` ä»¥åŠå¤–éƒ¨ `layer`ï¼Œç»„åˆå‡ºä¸€æ£µå®Œæ•´çš„ Layerï¼š
   - æä¾›æ‰€æœ‰ ModuleRuntimeï¼›
   - æä¾›æ‰€æœ‰ Service/å¹³å° Tagï¼›
   - ä¿è¯ Tag å†²çªï¼ˆè§ TagIndex è‰æ¡ˆï¼‰åœ¨æ„å»ºé˜¶æ®µè¢«æ£€æµ‹å‡ºæ¥ã€‚
2. **run**ï¼šåœ¨ build å¾—åˆ°çš„ Context/Scope å†…ï¼Œå¯åŠ¨ Root çš„ `processes`ï¼š
   - åŒ…æ‹¬ Link åœ¨å†…çš„é•¿æœŸ Effectï¼›
   - æŒ‰éœ€å°†é”™è¯¯è·¯ç”±åˆ° `onError` æˆ– DebugSink/Lifecycleã€‚

**åˆ†å½¢ç‰¹æ€§ï¼š**

- App / Page / Widget / å±€éƒ¨ Feature éƒ½æ˜¯ â€œRootModuleImpl + LogixRuntime.make(rootImpl)â€ è¿™ä¸€ç»„åˆï¼›
- æ¯ä¸ª `<RuntimeProvider>` å¯¹åº”ä¸€é¢— Runtimeï¼›
- å¤š Provider åµŒå¥— = å¤š Runtime åµŒå¥— = åˆ†å½¢ Runtime Treeã€‚

### 2.4 Linkï¼šRuntime å†…çš„åä½œè¿›ç¨‹ï¼ˆProcessï¼‰

`Logix.Link({ a: ModuleA, b: ModuleB }, ($)=>Effect)` çš„å®šä½ï¼š

- ä¸å±äºä»»ä½•ä¸šåŠ¡æ¨¡å—ï¼Œè€Œæ˜¯å±äº **å½“å‰ Runtime çš„ Root é…ç½®**ï¼›
- æ›´æ¥è¿‘ â€œé¢å‘å¤šä¸ª ModuleRuntime çš„ç¼–æ’è¿›ç¨‹â€ï¼Œè€Œä¸æ˜¯å•æ¨¡å—å†…éƒ¨é€»è¾‘ï¼›
- å…¸å‹å†™æ³•ï¼š

```ts
const AuthLink = Logix.Link({ auth: Auth, profile: Profile, audit: Audit }, ($) =>
  Effect.gen(function* () {
    // ä½¿ç”¨ $.auth / $.profile / $.audit çš„ ModuleHandle åšè·¨æ¨¡å—ç¼–æ’
  })
)

const AppRoot = Logix.Module("AppRoot", { state: Schema.Void, actions: {} })

const AppRootImpl = AppRoot.make({
  initial: undefined,
  imports: [AuthImpl, ProfileImpl, AuditImpl],
  processes: [AuthLink],
})
```

Link æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª `Effect<void, E, R>`ï¼Œä½† **å½’å±** æ˜¯ `RootModuleImpl.processes`ï¼Œç”± Runtime åœ¨è¯¥ Root çš„ Scope å†…å¯åŠ¨ã€‚

---

## 3. ç°çŠ¶ä¸æ¼”è¿›è·¯å¾„

### 3.1 ç°çŠ¶å¿«ç…§ï¼ˆv0ï¼‰

- `@logix/core`
  - Module / Runtimeï¼š
    - `Logix.Module` + `Module.logic` + `Module.live`ï¼›
    - `ModuleRuntime.make` + DebugSink / Lifecycle é›†æˆï¼›
    - `ModuleImpl`ï¼š`Module.make({ initial, logics, imports })` + `withLayer/withLayers` + `Logix.provide(ModuleImpl)`ã€‚
  - Bound API / Fluent DSLï¼š
    - `$.state.read/update/mutate`ï¼›
    - `$.onState / $.onAction / $.on` + `run / runParallel / runLatest / runFork`ï¼›
    - `Logic.Link`ï¼šè·¨æ¨¡å—çš„å‘½ä»¤å¼ Orchestratorï¼ˆç›®å‰æŒ‚åœ¨ `Logix.app({ processes })`ï¼‰ã€‚
  - App / Runtimeï¼š
    - `Logix.app({ layer, modules, processes, onError })` â†’ `AppRuntime.makeApp`ï¼›
    - `AppDefinition.layer` + `makeRuntime()`ã€‚

- `@logix/react`
  - `RuntimeProvider`ï¼šæ‰¿è½½ ManagedRuntime ä¸ Context çš„é€‚é…ï¼›
  - Hooksï¼š`useModule` / `useSelector` / `useDispatch` / `useLocalModule` ç­‰ï¼Œä½œä¸ºå…¬å¼€ API æš´éœ²ï¼›
  - å·²æœ‰ç®€å•å¤šæ¨¡å—/è·¨æ¨¡å— + useRemote é›†æˆæµ‹è¯•ã€‚

### 3.2 åˆ†å½¢ Runtime çš„è½åœ°æ­¥éª¤ï¼ˆä¸€æ¬¡æ€§åˆ‡æ¢ï¼‰

1. **å¼•å…¥å¹¶å¯¹å¤–æš´éœ²ç»Ÿä¸€ Runtime API**
   - åœ¨ `@logix/core` ä¸­å¯¼å‡º `LogixRuntime` å‘½åç©ºé—´ï¼Œæä¾› `LogixRuntime.make(rootImpl, options)`ï¼›
   - å†…éƒ¨å¯ä»¥å¤ç”¨ç°æœ‰ `AppRuntime.makeApp` + `ManagedRuntime.make`ï¼Œä½†è¿™äº›å®ç°ç»†èŠ‚å¯¹å¤–ä¸å†æš´éœ²ã€‚

2. **ç§»é™¤å¯¹å¤–çš„ `Logix.app` API**
   - ä» public API å’Œæ–‡æ¡£ä¸­åˆ é™¤ `Logix.app`ã€`AppDefinition` ç­‰å…¥å£ï¼Œåªä¿ç•™ `LogixRuntime.make`ï¼›
   - åŸæœ‰ä¾èµ– `Logix.app` çš„æµ‹è¯•ä¸ç¤ºä¾‹ï¼Œå…¨éƒ¨æ”¹å†™ä¸º â€œRootModuleImpl + LogixRuntime.make(rootImpl)â€ å½¢å¼ã€‚

3. **ä¸‹æ²‰ processes åˆ° RootModuleImpl**
   - æ‰©å±• `Module.make` æ”¯æŒ `processes?: ReadonlyArray<Effect.Effect<void, any, any>>`ï¼›
   - å°† Link ä¸å…¶ä»–é•¿æœŸè¿›ç¨‹ç»Ÿä¸€å»ºæ¨¡ä¸º RootModuleImpl.processesï¼›
   - Runtime å¯åŠ¨æ—¶ï¼Œæ ¹æ® RootModuleImpl.processes åœ¨è¯¥ Runtime Scope å†…ç»Ÿä¸€ forkã€‚

4. **è°ƒæ•´ React å…¥å£ä¸ºâ€œä¸€ Provider ä¸€ Runtimeâ€**
   - åœ¨ `@logix/react` ä¸­ï¼Œæ˜ç¡®ï¼š
     - æ¯ä¸ª `RuntimeProvider` æ¥æ”¶ä¸€ä¸ª `LogixRuntime.make(...)` å¾—åˆ°çš„ runtime å®ä¾‹ï¼›
     - `useModule` / `useLocalModule` å§‹ç»ˆç»‘å®šåˆ°æœ€è¿‘çš„ RuntimeProvider æ‰€ä»£è¡¨çš„é‚£é¢— Runtimeï¼›
   - æ”¯æŒåµŒå¥— RuntimeProviderï¼Œå½¢æˆåˆ†å½¢ Runtime Treeã€‚

5. **å›å†™è§„èŒƒå¹¶æ¸…ç†æ—§æ–‡æ¡£**
   - å°†æœ¬è‰æ¡ˆä¸­çš„ç¨³å®šç»“è®ºå›å†™åˆ°ï¼š
     - `runtime-logix/core/02-module-and-logic-api.md`ï¼ˆå¢åŠ  RootModule/Feature + imports/processesï¼‰ï¼›  
     - `runtime-logix/core/05-runtime-implementation.md`ï¼ˆè®°å½•åˆ†å½¢ Runtime æ¨¡å‹ä¸åµŒå¥—è§„åˆ™ï¼‰ï¼›  
     - `runtime-logix/impl/README.md`ï¼ˆå¢åŠ  Fractal Runtime Implementation Notesï¼‰ã€‚  
   - æ—§çš„ fractal è‰æ¡ˆå·²åˆ é™¤ï¼Œæœ¬è‰æ¡ˆæˆä¸ºåˆ†å½¢ Runtime çš„å”¯ä¸€ä¸Šä½è‰æ¡ˆã€‚

---

## 4. ä¸å…¶ä»–è‰æ¡ˆ / ç¼ºå£çš„å…³ç³»

æœ¬è‰æ¡ˆä¸ `runtime-logix-core-gaps-and-production-readiness.md` ä¸­çš„å¤šä¸ªç¼ºå£é«˜åº¦ç›¸å…³ï¼š

- 2.1 Tag å†²çªæ£€æµ‹ä¸ Env æ‹“æ‰‘æ ¡éªŒï¼š
  - åˆ†å½¢ Runtime ä¸‹ï¼ŒTagIndex ä»ç„¶åœ¨æ¯é¢— Runtime çš„ build é˜¶æ®µæ„å»ºï¼›
  - åŒä¸€é¢— Runtime å†… Tag å†²çªå¿…é¡» failï¼Œä¸åŒ Runtime ä¹‹é—´åˆ™å…è®¸å¤ç”¨ã€‚
- 2.2 Link / useRemote é”™è¯¯è¯­ä¹‰ï¼š
  - Link ä½œä¸º RootModuleImpl.processes çš„ä¸€éƒ¨åˆ†ï¼Œå…¶é”™è¯¯è¯­ä¹‰éœ€è¦ç»Ÿä¸€è§„èŒƒï¼ˆæŠ¥å‘Šä½†ä¸ä¸­æ–­ Runtime / æ˜¯å¦è‡ªåŠ¨é‡å¯ï¼‰ã€‚
- 2.3 ReactPlatform / Platform Tagï¼š
  - åˆ†å½¢ Runtime éœ€è¦åœ¨ React å±‚é€šè¿‡ RuntimeProvider æ³¨å…¥ Platform Tagï¼Œå¹¶åœ¨å„çº§ Runtime ä¸­ä¸€è‡´ä½¿ç”¨ã€‚
- 2.4 é•¿ç”Ÿå‘½å‘¨æœŸ / é«˜é¢‘ watcher çš„æ€§èƒ½ï¼š
  - processesï¼ˆå« Linkï¼‰æ˜¯é•¿æœŸè¿è¡Œé€»è¾‘ï¼Œå‹æµ‹ä¸æ³„æ¼æ£€æµ‹éœ€è¦ä»¥ Runtime ä¸ºå•ä½è¿›è¡Œã€‚
- 2.5 ModuleImpl / useLocalModule è¾¹ç•Œï¼š
  - å±€éƒ¨ Runtimeï¼ˆé€šè¿‡ useLocalModule / å±€éƒ¨ RuntimeProvider å½¢æˆçš„åˆ†å½¢èŠ‚ç‚¹ï¼‰æ˜¯ ModuleImpl + Runtime çš„ç»„åˆï¼Œéœ€è¦éªŒè¯ processes ç”Ÿå‘½å‘¨æœŸä¸ Scope è¡Œä¸ºã€‚
- 2.6 StrictMode / Suspense / é”™è¯¯è¾¹ç•Œï¼š
  - å¤š Runtime åµŒå¥—çš„ React Tree ä¸‹ï¼Œè¦æ˜ç¡®æ¯é¢— Runtime çš„åˆ›å»º/é”€æ¯ç­–ç•¥ï¼Œé¿å… StrictMode ä¸‹é‡å¤åˆ›å»º/æ³„æ¼ã€‚

æœ¬è‰æ¡ˆæä¾›çš„æ˜¯â€œ**å½¢çŠ¶ä¸èŒè´£åˆ’åˆ†**â€ï¼Œå…·ä½“ç¼ºå£çš„è¡¥é½ä»æŒ‰ `runtime-logix-core-gaps-and-production-readiness.md` ä¸­çš„åˆ†é¡¹æ¨è¿›ã€‚
</file>

<file path="drafts/L9/runtime-logix-spec-adjustments.md">
---
title: runtime-logix è§„èŒƒå¯è°ƒæ•´ç‚¹ä¸ä¿®è®¢å»ºè®®ï¼ˆè‰ç¨¿ï¼‰
status: superseded
version: 2025-11-30T00:00:00.000Z
superseded_by: ../L5/runtime-core-evolution.md
priority: 1800
---

## èƒŒæ™¯

- å½“å‰ `docs/specs/runtime-logix` ä¸­çš„ä¸€äº›è§„èŒƒæ¡ç›®ï¼Œæ˜¯åœ¨ç¼ºå°‘å®Œæ•´å®ç°åé¦ˆçš„æƒ…å†µä¸‹å…ˆè¡Œæ‹æ¿çš„ï¼›éšç€ `@logix/core` / `@logix/react` / `@logix/test` PoC æ¨è¿›ï¼Œéƒ¨åˆ†ç»†èŠ‚æš´éœ²å‡ºâ€œå®ç°è´Ÿæ‹…åå¤§â€æˆ–â€œä¸å·¥ç¨‹ä¹ æƒ¯ç•¥è„±èŠ‚â€çš„é—®é¢˜ã€‚
- æœ¬è‰ç¨¿é’ˆå¯¹è¿™äº›â€œå€¼å¾—ä¼˜åŒ–/é‡å†™â€çš„è§„èŒƒç‚¹åšä¸€æ¬¡é›†ä¸­æ•´ç†ï¼Œç›®çš„æ˜¯ï¼š
  - åŒºåˆ†å“ªäº›å±äºâ€œè®¾è®¡æ–¹å‘æ­£ç¡®ï¼Œç»†èŠ‚å¯æ”¾æ¾â€çš„éƒ¨åˆ†ï¼›
  - å“ªäº›åº”å½“åœ¨æ–‡æ¡£å±‚é¢æ”¶ç´§æˆ–æ”¹æˆâ€œç¤ºä¾‹â€ï¼Œé¿å…çº¦æŸè¿‡æ­»ï¼›
  - ä¸ºåç»­ v3.x è§„èŒƒä¿®è®¢æä¾›å¾…å†³åˆ—è¡¨ã€‚

> æ³¨ï¼šè¿™é‡Œåªåˆ—â€œæˆ‘è®¤ä¸ºè§„èŒƒæœ¬èº«å¯ä»¥è°ƒæ•´/éœ€è¦å¤ç›˜â€çš„ç‚¹ï¼Œé‚£äº›â€œå®ç°åç¦»ã€ä½†è§„èŒƒæ–¹å‘æ˜ç¡®æ­£ç¡®â€çš„å†…å®¹å·²ç»åœ¨ `docs/specs/review/runtime-logix-impl-review.md` / `runtime-logix-spec-todo.md` é‡Œè¦†ç›–ã€‚

## 1. `ModuleRuntime.make` çš„ç­¾åä¸èŒè´£è¾¹ç•Œ

### 1.1 ç°æœ‰è§„èŒƒå½¢æ€

- `core/05-runtime-implementation.md` ä¸­çš„è‰å›¾å°† `ModuleRuntime.make` å®šä¹‰ä¸ºï¼š
  - æ¥æ”¶ `stateLayer` / `actionLayer` / `logicLayers` ç­‰å¤šä¸ª Layerï¼›
  - åœ¨å†…éƒ¨å®Œæˆ State åˆå§‹åŒ–ã€Action é€šé“å»ºç«‹ã€Runtime æ„é€ å’Œ Logic å¯åŠ¨ã€‚
- è¿™ç§å½¢æ€åœ¨â€œæ¦‚å¿µè§£é‡Šâ€ä¸Šéå¸¸æ¸…æ™°ï¼šState/Actions/Logic ä¸‰è€…å¦‚ä½•è¢«ç»„è£…åˆ°ä¸€èµ·ä¸€ç›®äº†ç„¶ã€‚

### 1.2 é—®é¢˜ä¸é£é™©

- å¯¹å®ç°æ–¹è€Œè¨€ï¼Œè¿™ä¸ªç­¾åæœ‰æ¯”è¾ƒå¼ºçš„â€œä¾µå…¥æ€§çº¦æŸâ€ï¼š
  - æ‰€æœ‰å›´ç»• `ModuleRuntime` çš„æ„é€ éƒ½è¢«ç»‘åˆ°ä¸€ä¸ªç»Ÿä¸€çš„ `make` ä¸Šï¼Œæ‰©å±•ç©ºé—´æœ‰é™ï¼›
  - å°† Logic å¯åŠ¨å¼ºè¡Œå¡å…¥ `ModuleRuntime.make`ï¼Œä¼šè®© `Module.live` / ä¸Šå±‚å®¹å™¨çš„èŒè´£å˜å¾—æ¨¡ç³Šã€‚
- å¯¹ä½¿ç”¨è€…è€Œè¨€ï¼Œè¿™ä¸ªç­¾åå¹¶ä¸æ˜¯æ—¥å¸¸éœ€è¦ç†è§£çš„æ¥å£ï¼š
  - ä¸šåŠ¡ä»£ç åªå…³å¿ƒ `Module.live(initial, ...logics)`ï¼›
  - é€‚é…ä½œè€…å¯ä»¥ç›´æ¥æ„é€  `ModuleRuntime<S, A>` æˆ–é€šè¿‡ Adapter å·¥å…·ï¼Œä¸ä¸€å®šè¦èµ°â€œLayer + makeâ€è¿™æ¡è·¯ã€‚

### 1.3 å»ºè®®è°ƒæ•´æ–¹å‘

- æŠŠ `ModuleRuntime.make` çš„â€œLayer ç»„åˆ + Logic å¯åŠ¨â€éƒ¨åˆ†ï¼Œä»è§„èŒƒç¡¬çº¦æŸé™çº§ä¸ºâ€œæ¨èå®ç°è‰å›¾â€ï¼š
  - æ–‡æ¡£ä¿ç•™è¿™æ®µä¼ªä»£ç ï¼Œç”¨æ¥è§£é‡Š Runtime å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼›
  - ä½†åœ¨â€œå¥‘çº¦â€å±‚ï¼Œåªè¦æ±‚ `ModuleRuntime<S, A>` æ»¡è¶³æ¥å£ä¸è¯­ä¹‰ä¸å˜å¼ã€‚
- åœ¨è§„èŒƒä¸­æ˜ç¡®ä¸¤å±‚è¾¹ç•Œï¼š
  1. **ç¡¬è¾¹ç•Œ**ï¼š`ModuleRuntime` æ¥å£ä¸è¯­ä¹‰ï¼ˆ`getState` / `setState` / `dispatch` / `actions$` / `changes` / `ref`ï¼‰ï¼›
  2. **è½¯å»ºè®®**ï¼šå¦‚ä½•åŸºäº Effect Layer ç»„åˆå¾—åˆ°æ ‡å‡†å®ç°ï¼ˆå¯ä»¥æœ‰å¤šç§å˜ä½“ï¼Œä¸è¦æ±‚å”¯ä¸€ï¼‰ã€‚
- åœ¨ `impl` æ–‡æ¡£ä¸­ç»™å‡ºä¸€ä¸ªæ›´ç°å®çš„åˆ†å±‚ï¼š
  - å¯ä»¥æ˜¯å½“å‰ PoC çš„å½¢æ€ï¼š`ModuleRuntime.make(initialState)` åªè´Ÿè´£å¿ƒè„ï¼Œ`Module.live` è´Ÿè´£â€œç»‘å®š Shape + Logic + Runtime.makeâ€ï¼›
  - æˆ–è€…æœªæ¥åˆå¹¶æˆâ€œLayer çº§ makeâ€ï¼Œä½†éƒ½ä¸åº”åœ¨è§„èŒƒé‡Œè¢«å½“ä½œå”¯ä¸€æ­£ç¡®å§¿åŠ¿ã€‚

## 2. è‡ªå®šä¹‰ `ModuleRuntime` çš„æ„é€ è·¯å¾„

### 2.1 ç°æœ‰è§„èŒƒå½¢æ€

- å½“å‰è§„èŒƒå¼ºè°ƒï¼š
  - `ModuleRuntime` å¯ä»¥è¢«æ›¿æ¢/è‡ªå®šä¹‰ï¼Œä½†å¿…é¡»æ»¡è¶³ä¸€ç»„è¯­ä¹‰ä¸å˜å¼ï¼›
  - åŒæ—¶ç¤ºæ„å›¾æš—ç¤ºâ€œæœ€å¥½é€šè¿‡ç»Ÿä¸€çš„ `ModuleRuntime.make`â€æ¥æ„é€ ã€‚

### 2.2 é—®é¢˜ä¸é£é™©

- å®é™…ä¸Šï¼Œè‡ªå®šä¹‰ Runtime æœ‰å¤šç§åˆæ³•è·¯å¾„ï¼š
  - ç›´æ¥æä¾› `Layer<Tag, E, R>`ï¼Œåœ¨å…¶ä¸­æ„é€ ä»»æ„ç¬¦åˆæ¥å£çš„ä¸å˜å®ç°ï¼›
  - é€šè¿‡ä¸­é—´ Adapterï¼ˆä¾‹å¦‚ `RuntimeAdapter`ï¼‰åŒ…è£…è¿œç¨‹ Store / è°ƒè¯• Runtimeï¼›
  - åœ¨æµ‹è¯•ç¯å¢ƒç”¨ä¸“ç”¨ `TestRuntime` å°è£…ã€‚
- å¦‚æœè§„èŒƒæŠŠâ€œæ„é€ æ–¹å¼â€ä¹Ÿå½“æˆç¡¬çº¦æŸï¼Œä¼šè®©é€‚é…ä½œè€…èƒŒè´Ÿé¢å¤–å¿ƒæ™ºè´Ÿæ‹…ï¼Œä¸”é™åˆ¶ PoC é˜¶æ®µçš„å¿«é€Ÿè¯•é”™ã€‚

### 2.3 å»ºè®®è°ƒæ•´æ–¹å‘

- åœ¨è§„èŒƒï¼ˆç‰¹åˆ«æ˜¯ `core/05-runtime-implementation.md`ï¼‰ä¸­ï¼š
  - ä¿ç•™è¯­ä¹‰ä¸å˜å¼å’Œâ€œåˆæ³•/ä¸æ¨èç”¨æ³•â€åˆ—è¡¨ï¼Œä½œä¸ºè‡ªå®šä¹‰ Runtime çš„å”¯ä¸€ç¡¬çº¦æŸï¼›
  - å°†â€œåº”è¯¥é€šè¿‡ `ModuleRuntime.make` æ„é€ â€çš„è¯­æ°”æ”¹ä¸ºâ€œæ¨èå®ç°ä¹‹ä¸€â€ï¼Œå¹¶æ˜ç¡®å…è®¸ï¼š
    - é€‚é…ä½œè€…è‡ªè¡Œåœ¨ Layer ä¸­æ„å»º `ModuleRuntime` å®ä¾‹ï¼›
    - ä½¿ç”¨ `ModuleRuntime.fromAdapter` ä¹‹ç±»çš„å·¥å…·å‡½æ•°ï¼ˆè¯¦è§ `docs/specs/drafts/L9/module-runtime-adapter-and-customization.md` è‰ç¨¿ï¼‰ã€‚
- å¢è¡¥ä¸€èŠ‚â€œè‡ªå®šä¹‰ Runtime è®¾è®¡æŒ‡å—â€ï¼š
  - åŒ…å«è¿œç¨‹ Store åŒ…è£…ã€æµ‹è¯• Runtimeã€åªè¯» Runtime ç­‰ç¤ºä¾‹ï¼›
  - å¼ºè°ƒå¦‚ä½•éªŒè¯ä¸å˜å¼ï¼Œè€Œä¸æ˜¯è§„å®šå¿…é¡»åœ¨å“ªä¸ªå‡½æ•°é‡Œæ„é€ ã€‚

## 3. Debug / Inspector çš„ä½ç½®ä¸ç²’åº¦

### 3.1 ç°æœ‰è§„èŒƒå½¢æ€

- `core/09-debugging.md` + `impl/v3-scope-lock.md` æè¿°äº†ç›¸å¯¹å®Œæ•´çš„è°ƒè¯•ä½“ç³»ï¼š
  - Debug äº‹ä»¶æµã€Inspectorã€Scope Lockã€Replay ç­‰ï¼›
  - è¾ƒå¤šèƒ½åŠ›æ˜¯åç»ˆå±€å½¢æ€çš„è®¾è®¡ã€‚

### 3.2 é—®é¢˜ä¸é£é™©

- å¯¹å½“å‰ä»“åº“çŠ¶æ€è€Œè¨€ï¼š
  - Runtime æ ¸å¿ƒå¥‘çº¦è¿˜åœ¨æ¼”è¿›ä¸­ï¼Œè¿‡æ—©åœ¨è§„èŒƒé‡Œé”æ­» Debug åè®®ä¼šå¢åŠ é‡æ„æˆæœ¬ï¼›
  - ç°æœ‰å®ç°å·²ç»å€¾å‘äºåœ¨æ ¸å¿ƒè·¯å¾„é‡Œå†™ä¸´æ—¶ `console.log`ï¼Œè¯´æ˜â€œæ­£å¼ Debug æ¥å£â€å°šæœªå½¢æˆå¿ƒæ™ºå…±è¯†ã€‚

### 3.3 å»ºè®®è°ƒæ•´æ–¹å‘

- å°† Debug ç›¸å…³è§„èŒƒæ‹†ä¸ºä¸¤å±‚ï¼š
  1. **çŸ­æœŸç¡¬çº¦æŸ**ï¼š
     - æ ¸å¿ƒ Runtime / BoundApi / React Adapter ä¸­ç¦æ­¢ç›´æ¥ `console.log`ï¼›
     - æ‰€æœ‰è°ƒè¯•è¾“å‡ºéƒ½åº”é€šè¿‡ Effect æ—¥å¿—æˆ–å¯æ’æ‹” Layer æä¾›ï¼›
     - å¯ä»¥åªå®šä¹‰ä¸€æ¡ç®€å• Debug äº‹ä»¶æµï¼ˆå¦‚ Action/State å˜åŒ–ï¼‰ï¼Œå…¶ä½™èƒ½åŠ›ç•™å¾…åç»­è¿­ä»£ã€‚
  2. **é•¿æœŸè“å›¾**ï¼š
     - Inspector / Scope Lock / Replay ç­‰ä¿æŒåœ¨ `impl` æˆ– Topics è‰ç¨¿ä¸­ï¼›
     - æ˜ç¡®æ ‡è®°ä¸ºâ€œv3.x+ ç›®æ ‡è®¾è®¡â€ï¼Œé¿å…è¢«è¯¯è§£ä¸ºå½“ä¸‹å¿…é¡»å®ç°çš„å¥‘çº¦ã€‚
- è§„èŒƒæ–‡æœ¬ä¸­å¯¹ Debug API çš„æè¿°å°½é‡èšç„¦â€œè¾¹ç•Œâ€ï¼ˆä¾‹å¦‚ä¸å½±å“ä¸šåŠ¡è¯­ä¹‰ã€ä¸ç ´åæ€§èƒ½ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§è§„å®šå®Œæ•´åè®®ã€‚

## 4. React & Test è§„èŒƒçš„â€œå¼ºåº¦â€

### 4.1 React Hook å¥‘çº¦

- `core/07-react-integration.md` ä¸­ä¸º `useModule` / `useSelector` / `useDispatch` è®¾è®¡äº†ä¸€å¥—æ¯”è¾ƒç†æƒ³çš„ APIï¼š
  - `useModule(handle)` è¿”å› Runtimeï¼›
  - `useModule(handle, selector, equalityFn?)` åšè®¢é˜…ï¼›
  - `useSelector(runtime, selector, equalityFn?)` åŸºäº `useSyncExternalStore` å®ç°ã€‚
- è¿™å¥—å½¢çŠ¶æˆ‘è®¤ä¸ºæ–¹å‘æ˜¯æ­£ç¡®çš„ï¼Œä½†å¯ä»¥åœ¨è§„èŒƒä¸­æ˜ç¡®åŒºåˆ†ï¼š
  - å“ªäº›æ˜¯â€œå¿…é¡»æ»¡è¶³çš„è¡Œä¸ºçº¦æŸâ€ï¼ˆä¾‹å¦‚é¿å… tearingï¼Œä¿è¯ Runtime å¼•ç”¨ç¨³å®šï¼‰ï¼›
  - å“ªäº›æ˜¯â€œå½“å‰æ¨èçš„ API å½¢çŠ¶â€ï¼ˆå…è®¸å°†æ¥æ ¹æ® React ç”Ÿæ€æ¼”è¿›å¾®è°ƒï¼‰ã€‚

### 4.2 Test Kit å¥‘çº¦

- `runtime-logix/test/01-test-kit-design.md` æ—©æœŸä»¥ `defineTest` / `Scenario` ä¸ºå…¥å£æè¿°äº†ä¸€å¥—èƒ½åŠ›è“å›¾ï¼ŒåŒ…æ‹¬ï¼š
  - TestClockã€traceã€æœåŠ¡ mockã€ExecutionResult ç»“æ„ç­‰ã€‚
- å½“å‰å®ç°å·²åˆ‡æ¢åˆ° `TestProgram` + `runTest` ä¸ºä¸»å…¥å£ï¼Œæ—§ç¨¿ä»å¯ä½œä¸ºèƒ½åŠ›æ¸…å•å‚è€ƒï¼Œä½†å…·ä½“ API å½¢çŠ¶ä»¥ `impl/test-package.md` ä¸ºå‡†ã€‚

### 4.3 å»ºè®®è°ƒæ•´æ–¹å‘

- åœ¨ React / Test ç›¸å…³è§„èŒƒé‡Œå¼•å…¥â€œå±‚çº§â€æ ‡è®°ï¼š
  - Level 1ï¼šå¿…é¡»éµå®ˆçš„è¡Œä¸ºè¾¹ç•Œï¼ˆä¾‹å¦‚ hook ä¸å¾—é€ æˆçŠ¶æ€æ’•è£‚ã€æµ‹è¯•ä¸å¾—ä¾èµ–å¤–éƒ¨å…¨å±€çŠ¶æ€ç­‰ï¼‰ï¼›
  - Level 2ï¼šæ¨è API å½¢çŠ¶ï¼ˆå…è®¸æœªæ¥å°æ”¹ï¼‰ï¼›
  - Level 3ï¼šé•¿æœŸèƒ½åŠ›ï¼ˆä¾‹å¦‚å®Œæ•´ trace / å¯è§†åŒ–é›†æˆï¼‰ï¼›
- å¯¹å½“å‰å®ç°ï¼Œä¼˜å…ˆå¯¹é½ Level 1/2ï¼Œå°† Level 3 ä¿æŒåœ¨ drafts/topics ä¸­é€æ­¥æ¼”è¿›ã€‚

## 5. åç»­åŠ¨ä½œå»ºè®®

- å°†æœ¬è‰ç¨¿ä½œä¸º L9 èµ·ç‚¹ï¼Œåç»­åœ¨æ¢³ç† runtime-logix è§„èŒƒæ—¶ï¼š
  - è‹¥æœ‰æ–°çš„å®ç°ç»éªŒï¼Œä¼˜å…ˆåœ¨æ­¤æ–‡ä»¶ä¸­è¿½åŠ â€œåˆ©å¼Šåˆ†æâ€å’Œâ€œæ›¿ä»£æ–¹æ¡ˆâ€ï¼›
  - æˆç†Ÿåï¼ˆL6-L4ï¼‰å†å°†å…¶ä¸­ç¨³å®šç»“è®ºè¿ç§»åˆ°ï¼š
    - `core/05-runtime-implementation.md`ï¼ˆRuntime è¾¹ç•Œä¸æ„é€ ï¼‰ï¼›
    - `core/07-react-integration.md`ï¼ˆReact Hook è¡Œä¸ºè¾¹ç•Œä¸ APIï¼‰ï¼›
    - `runtime-logix/test/*`ï¼ˆæµ‹è¯•å·¥å…·åŒ…ï¼‰ã€‚
- å¯¹å·²ç»å®ç°çš„ PoCï¼Œå¦‚æœå‘ç°ä¸è§„èŒƒå­˜åœ¨å¼ åŠ›ï¼Œå¯ä»¥å…ˆåœ¨æ­¤è‰ç¨¿ä¸­è®°å½•â€œåå·®åŸå› â€å’Œâ€œå¯èƒ½çš„è§„èŒƒä¿®è®¢æ–¹å‘â€ï¼Œé¿å…ç›´æ¥æŠŠå®ç°ç¡¬æ‹—å‘æ—§è§„èŒƒã€‚
</file>

<file path="drafts/L9/runtime-logix-tag-collision-detection.md">
---
priority: 1900
---
  ---
title: "Runtime Logix Â· Tag å†²çªæ£€æµ‹ä¸ Env æ‹“æ‰‘æ ¡éªŒè®¾è®¡è‰æ¡ˆ"
status: draft
version: 0.1.0
layer: L9
related:
  - ./runtime-logix-core-gaps-and-production-readiness.md
  - ./plan-runtime-logix-v1-readiness.md
  - ../../runtime-logix/impl/app-runtime-and-modules.md
---

# Runtime Logix Â· Tag å†²çªæ£€æµ‹ä¸ Env æ‹“æ‰‘æ ¡éªŒè®¾è®¡è‰æ¡ˆ

> ç›®æ ‡ï¼šä¸º v1.0 è½åœ°ä¸€å¥—ã€Œåœ¨ App æ„å»ºé˜¶æ®µæ£€æµ‹ Tag å†²çªã€çš„æœºåˆ¶ï¼Œé¿å… Service è¢«é™é»˜è¦†ç›–ï¼Œä¸ºåç»­ Universe/Studio çš„ Env æ‹“æ‰‘å›¾æ‰“åŸºç¡€ã€‚
>
> æœ¬è‰æ¡ˆèšç„¦ä¸€ä»¶äº‹ï¼š**å¦‚ä½•åœ¨ `Logix.app` / `AppRuntime.makeApp` ä¸­æ„å»º `TagIndex`ï¼Œå¹¶åœ¨å‘ç°å†²çªæ—¶ç»™å‡ºå¯è°ƒè¯•çš„é”™è¯¯**ã€‚

## 1. èƒŒæ™¯ä¸é—®é¢˜å®šä¹‰

åœ¨ Runtime Logix ä¸­ï¼Œå‡ ä¹æ‰€æœ‰è·¨æ¨¡å—ä¾èµ–éƒ½åŸºäº `Context.Tag` + Layer DIï¼š

- æ¨¡å—è‡ªèº«æ˜¯ä¸€ä¸ª Tagï¼ˆ`ModuleInstance` ç»§æ‰¿è‡ª `Context.Tag`ï¼‰ï¼›
- æœåŠ¡é€šè¿‡ `Context.GenericTag("ServiceName")` å®šä¹‰ï¼Œå†ç”¨ `Layer.succeed(ServiceTag, impl)` æˆ– `Layer.scoped` æä¾›ï¼›
- `Logix.app` ä¼šæŠŠæ‰€æœ‰æ¨¡å—çš„ Layer æ‰å¹³åˆå¹¶åˆ°ä¸€ä¸ªå¤§ Env ä¸­ã€‚

å±é™©ä¹‹å¤„åœ¨äºï¼š

- å¦‚ä¸¤ä¸ªæ¨¡å—ä¸çº¦è€ŒåŒåœ°ä½¿ç”¨äº†ç›¸åŒçš„ Tag keyï¼ˆä¾‹å¦‚éƒ½å†™äº† `Context.GenericTag("ToggleService")`ï¼‰ï¼Œé‚£ä¹ˆåœ¨ Layer åˆå¹¶æ—¶ï¼Œåè€…ä¼šé™é»˜è¦†ç›–å‰è€…ï¼›
- è¿™ç±»è¦†ç›–ä¸ä¼šåœ¨ç±»å‹å±‚é¢æŠ¥é”™ï¼Œåªä¼šåœ¨è¿è¡Œæ—¶è¡¨ç°ä¸ºâ€œæŸäº›æ¨¡å—è«åä½¿ç”¨äº†é”™è¯¯çš„ Service å®ç°â€ï¼Œæéš¾æ’æŸ¥ï¼›
- å¯¹æœªæ¥çš„ Env å¯è§†åŒ–ï¼ˆUniverse/Studioï¼‰æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬è¿ Tag å†²çªéƒ½ä¸æ‹¦ï¼Œæ‹“æ‰‘å›¾æœ¬èº«ä¹Ÿä¼šå¤±çœŸã€‚

æˆ‘ä»¬éœ€è¦ä¸€å¥—**æ„å»ºæ—¶çš„ TagIndex**ï¼š

- åœ¨ `Logix.app` å¯åŠ¨/æ„å»º Env ä¹‹å‰ï¼Œå°±èƒ½å‘ç° Tag Key å†²çªï¼›
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼ŒæŒ‡å‡ºå†²çª Tag çš„ keyã€ownerModuleIds å’Œæ¥æºï¼ˆmodule/serviceï¼‰ã€‚

## 2. è®¾è®¡ç›®æ ‡ä¸éç›®æ ‡

### 2.1 è®¾è®¡ç›®æ ‡

1. **å®‰å…¨å…œåº•**ï¼šä¸¤ä»½ä¸åŒå®ç°è‹¥å£°æ˜ä¸ºåŒä¸€ Tag keyï¼Œæ„å»º App æ—¶å¿…é¡» failï¼Œè€Œä¸æ˜¯é™é»˜è¦†ç›–ï¼›
2. **æœ€å°ä¾µå…¥**ï¼šä¼˜å…ˆä¸æ”¹ç°æœ‰ä¸šåŠ¡ä»£ç çš„å†™æ³•ï¼Œé€šè¿‡è¾…åŠ© API + å…ƒæ•°æ®è¡¥å…… Tag ä¿¡æ¯ï¼›
3. **æ¸è¿›å¢å¼º**ï¼šPhase 1 å…è®¸åªè¦†ç›–ã€ŒModule Tag + æ˜¾å¼å£°æ˜çš„ Service Tagã€ï¼Œåç»­å†è€ƒè™‘è‡ªåŠ¨ä»é€šç”¨ Layer ä¸­æŠ½å– Tag åˆ—è¡¨ï¼›
4. **æ˜“è§‚æµ‹**ï¼šå†²çªé”™è¯¯ç±»å‹ç»“æ„åŒ–ï¼Œæ–¹ä¾¿è¢«æ—¥å¿—ç³»ç»Ÿ / DevTools é‡‡é›†ã€‚

### 2.2 éç›®æ ‡

- ä¸åœ¨ v1.0 é˜¶æ®µå®ç°â€œä»»æ„ Layer æ·±åº¦é™æ€åˆ†æï¼ˆä¾‹å¦‚é€šè¿‡ AST æˆ– runtime introspection å®Œå…¨é‡å»º Tag æ‹“æ‰‘ï¼‰â€ï¼›
- ä¸æ”¹å˜ç°æœ‰ `Context.Tag` / `Context.GenericTag` çš„ä½¿ç”¨æ–¹å¼ï¼›
- ä¸åœ¨ v1.0 é˜¶æ®µå¼•å…¥å¼ºåˆ¶çš„ Tag key å‘½åè§„èŒƒï¼ˆä¾‹å¦‚å¼ºåˆ¶ `ModuleId/ServiceName` å‰ç¼€ï¼‰ï¼Œä½†å¯ä»¥åœ¨é”™è¯¯ä¿¡æ¯ä¸­å»ºè®®ã€‚

## 3. æ ¸å¿ƒæ•°æ®ç»“æ„ä¸é”™è¯¯ç±»å‹

```ts
// å†…éƒ¨ç”¨ï¼šTag çš„ç»Ÿä¸€æè¿°
type TagKey = string

interface TagInfo {
  readonly key: TagKey
  readonly ownerModuleId: string
  readonly source: "module" | "service"
}

interface TagCollisionError {
  readonly _tag: "TagCollisionError"
  readonly key: TagKey
  readonly conflicts: ReadonlyArray<TagInfo>
}
```

TagIndex ä½¿ç”¨ä¸€ä¸ª `Map<TagKey, TagInfo[]>`ï¼š

- `key`ï¼šTag çš„å”¯ä¸€æ ‡è¯†ï¼ˆå¯¹äº `Context.GenericTag("X")`ï¼Œå°±æ˜¯ `"X"`ï¼‰ï¼›
- `ownerModuleId`ï¼šå‘ç”Ÿæä¾›çš„æ¨¡å— IDï¼ˆæ¥è‡ª `ModuleInstance.id`ï¼‰ï¼›
- `source`ï¼š
  - `"module"`ï¼šæ¨¡å—è‡ªèº«çš„ Tagï¼›
  - `"service"`ï¼šæ¨¡å— Layer ä¸­æä¾›çš„ Service Tagã€‚

å½“åŒä¸€ `key` å¯¹åº”å¤šä¸ªä¸åŒ Tag å®ä¾‹æ—¶ï¼Œæ„é€  `TagCollisionError` å¹¶ fail æ‰ `makeApp`ã€‚

## 4. Phase 1ï¼šåŸºäº Module + æ˜¾å¼ Service Tag çš„ TagIndex

### 4.1 å…¥å£ç‚¹ï¼šAppRuntime.makeApp

å½“å‰ `packages/logix-core/src/runtime/AppRuntime.ts` ä¸­ï¼š

- `Logix.app` æœ€ç»ˆè°ƒç”¨çš„æ˜¯ `makeApp(config)`ï¼›
- `config.modules: AppModuleEntry[]`ï¼Œæ¯ä¸ª entry æ‹¥æœ‰ï¼š
  - `module: ModuleInstance<any, AnyModuleShape>`ï¼ˆæ¨¡å—è‡ªèº« Tagï¼‰ï¼›
  - `layer: Layer.Layer<any, any, any>`ï¼ˆæ¨¡å—çš„ Runtime Layerï¼‰ã€‚

åœ¨ `makeApp(config)` ä¸­ï¼Œç°æœ‰é€»è¾‘æ˜¯ï¼š

1. æ£€æŸ¥ `module.id` æ˜¯å¦é‡å¤ï¼›
2. åˆå¹¶ `config.layer` ä¸å„æ¨¡å—çš„ `layer` ä¸ºä¸€ä¸ªå¤§ `envLayer`ï¼›
3. é€šè¿‡ `Layer.buildWithScope` æ„å»º Envï¼Œå† fork `processes`ã€‚

æˆ‘ä»¬è¦åšçš„æ˜¯åœ¨ **æ­¥éª¤ 1 ä¸ 2 ä¹‹é—´** æ’å…¥ TagIndex æ„å»ºï¼š

```ts
const validateTags = (entries: ReadonlyArray<AppModuleEntry>) =>
  Effect.gen(function* () {
    // æ„å»º TagIndexï¼ŒæŠ›å‡º TagCollisionError æˆ–è¿”å› void
  })

export const makeApp = <R>(config: LogixAppConfig<R>): AppDefinition<R> => {
  // 1. module.id å»é‡æ ¡éªŒï¼ˆå·²å­˜åœ¨ï¼‰
  // ...

  // 1.5 Tag å†²çªæ ¡éªŒï¼ˆæ–°å¢ï¼‰
  validateTags(config.modules)

  // 2. merge Layer & build envLayer
  // ...
}
```

### 4.2 Tag æ¥æºï¼šModule ä¸ Serviceï¼ˆPhase 1 ç­–ç•¥ï¼‰

Phase 1 ä¸è¯•å›¾ä»ä»»æ„ Layer ä¸­è‡ªåŠ¨åˆ†ææ‰€æœ‰ Tagï¼Œåªè¦†ç›–ä¸¤ä¸ªæ¥æºï¼š

1. **Module è‡ªèº« Tag**ï¼š
   - `module` æœ¬èº«æ˜¯ `Context.Tag<any, ModuleRuntime<State, Action>>`ï¼›
   - key å¯ä»¥ä»å†…éƒ¨ `_id` æˆ–å­—ç¬¦ä¸²æè¿°ä¸­è·å–ï¼ˆå¯¹äº `Context.GenericTag("@logix/Module/<id>")`ï¼Œkey å°±æ˜¯ `"@logix/Module/<id>"`ï¼‰ã€‚
   - ç†è®ºä¸Š Module Tag å†²çªåº”è¯¥æ°¸è¿œä¸ä¼šå‘ç”Ÿï¼ˆ`Module("User")` vs `Module("User")` ä¼šèµ° module.id é‡å¤åˆ†æ”¯ï¼‰ï¼Œä½†ä»å¯åŠ å…¥ TagIndex ä¾›å·¥å…·ä½¿ç”¨ã€‚

2. **æ˜¾å¼å£°æ˜çš„ Service Tag**ï¼š
   - æ–°å¢ä¸€ä¸ªå¯é€‰å­—æ®µæŒ‚åœ¨ `AppModuleEntry` ä¸Šï¼Œä¾‹å¦‚ï¼š

     ```ts
     export interface AppModuleEntry {
       readonly module: ModuleInstance<any, AnyModuleShape>
       readonly layer: Layer.Layer<any, any, any>
       readonly serviceTags?: ReadonlyArray<Context.Tag<any, any>>
     }
     ```

   - ä¸ºäº†ä¸è¦æ±‚ä¸šåŠ¡æ–¹æ‰‹åŠ¨æ„é€  `AppModuleEntry`ï¼Œåœ¨ `Logix.provide` ä¸Šæä¾›ä¸€ä¸ªå˜ä½“ï¼š

     ```ts
     // ç°æœ‰
     export const provide = <Sh, R, E>(
       module: ModuleInstance<any, Sh>,
       resource: Layer<ModuleRuntime<StateOf<Sh>, ActionOf<Sh>>, E, R> | ModuleRuntime<StateOf<Sh>, ActionOf<Sh>>,
     ): AppModuleEntry

     // æ–°å¢ï¼ˆPhase 1ï¼‰
     export const provideWithTags = <Sh, R, E>(
       module: ModuleInstance<any, Sh>,
       resource: Layer<ModuleRuntime<StateOf<Sh>, ActionOf<Sh>>, E, R> | ModuleRuntime<StateOf<Sh>, ActionOf<Sh>>,
       serviceTags: ReadonlyArray<Context.Tag<any, any>>,
     ): AppModuleEntry
     ```

   - å¯¹äºä½¿ç”¨ `Logix.provideWithTags` çš„æ¨¡å—ï¼Œå°† `serviceTags` ä¸€å¹¶æ”¾å…¥ TagIndex æ£€æŸ¥ã€‚

### 4.3 validateTags ç®—æ³•ï¼ˆPhase 1ï¼‰

ä¼ªä»£ç ï¼š

```ts
const getTagKey = (tag: Context.Tag<any, any>): string =>
  // Phase 1 å…ˆä½¿ç”¨ `tag.key` æˆ– toString() ä¹‹ç±»çš„ç¨³å®šå­—æ®µï¼›
  // è‹¥æ— å…¬å…± APIï¼Œå¯æš‚ç”¨å†…éƒ¨æ ‡è¯†ï¼Œå¹¶åœ¨é”™è¯¯ä¿¡æ¯ä¸­å»ºè®®æ‰‹åŠ¨å‘½åã€‚

const validateTags = (modules: ReadonlyArray<AppModuleEntry>): void => {
  const index = new Map<string, TagInfo[]>()

  for (const entry of modules) {
    const ownerId = String(entry.module.id)

    // 1. è®°å½• Module è‡ªèº« Tag
    const moduleKey = getTagKey(entry.module)
    const moduleInfo: TagInfo = {
      key: moduleKey,
      ownerModuleId: ownerId,
      source: "module",
    }
    index.set(moduleKey, [...(index.get(moduleKey) ?? []), moduleInfo])

    // 2. è®°å½•æ˜¾å¼å£°æ˜çš„ Service Tagï¼ˆå¦‚æœ‰ï¼‰
    for (const tag of entry.serviceTags ?? []) {
      const key = getTagKey(tag)
      const info: TagInfo = {
        key,
        ownerModuleId: ownerId,
        source: "service",
      }
      index.set(key, [...(index.get(key) ?? []), info])
    }
  }

  // 3. æ£€æŸ¥å†²çªï¼šåŒä¸€ key å‡ºç°å¤šä¸ª owner æˆ– Tag å®ä¾‹
  const collisions: TagCollisionError[] = []

  for (const [key, infos] of index) {
    if (infos.length <= 1) continue
    // åç»­å¯ä»¥æ‰©å±•ä¸ºâ€œåŒä¸€ key ä¸åŒ Tag å®ä¾‹æ‰ç®—å†²çªâ€ï¼ŒPhase 1 ç®€åŒ–ä¸º"å¤š owner å³å†²çª"
    collisions.push({ _tag: "TagCollisionError", key, conflicts: infos })
  }

  if (collisions.length > 0) {
    // æš‚å®šç›´æ¥ throwï¼Œåç»­å¯è€ƒè™‘åœ¨ DebugSink ä¸­è®°å½•è¯¦ç»†ä¿¡æ¯
    throw new Error(
      `[Logix] Tag collision detected:\n` +
      collisions
        .map((c) =>
          `- key: ${c.key}\n` +
          c.conflicts
            .map((i) => `  - owner: ${i.ownerModuleId}, source: ${i.source}`)
            .join("\n"),
        )
        .join("\n"),
    )
  }
}
```

> æ³¨ï¼šPhase 1 å°†â€œå¤š owner å³å†²çªâ€è§†ä¸ºè¶³å¤Ÿä¸¥æ ¼çš„çº¦æŸï¼Œåç»­å¦‚æœ‰â€œæ•…æ„å¤ç”¨ Service Tagâ€çš„è®¾è®¡å†æ”¾å®½æ¡ä»¶ã€‚

### 4.4 ä½¿ç”¨ç¤ºä¾‹ï¼ˆä¸šåŠ¡ä»£ç è§†è§’ï¼‰

```ts
// service.ts
export const ToggleServiceTag = Context.GenericTag<ToggleService>("ToggleService")

// app.ts
const ToggleModule = Logix.Module("ToggleModule", { ... })

const ToggleLive = ToggleModule.live(initial, logic).pipe(
  Layer.provide(Layer.succeed(ToggleServiceTag, impl)),
)

const app = Logix.app({
  layer: Layer.empty,
  modules: [
    Logix.provideWithTags(ToggleModule, ToggleLive, [ToggleServiceTag]),
    // å…¶ä»–æ¨¡å—...
  ],
  processes: [],
})
```

å¦‚å¦ä¸€ä¸ªæ¨¡å—ä¹Ÿå£°æ˜äº†åŒå `ToggleServiceTag`ï¼Œåˆ™ `Logix.app` æ„å»ºæ—¶ä¼šæŠ¥å‡º Tag å†²çªé”™è¯¯ã€‚

## 5. Phase 2 å±•æœ›ï¼šè‡ªåŠ¨ Service Tag æ¢æµ‹

åœ¨ Phase 1 ç¨³å®šåï¼Œå¯ä»¥è€ƒè™‘è¿›ä¸€æ­¥å‡å°‘â€œæ‰‹åŠ¨å£°æ˜ serviceTagsâ€çš„è´Ÿæ‹…ï¼š

- é€šè¿‡çº¦å®šå¼ API ç»Ÿä¸€ Service æä¾›æ–¹å¼ï¼Œä¾‹å¦‚ï¼š

  ```ts
  const ToggleLive = Layer.service(ToggleServiceTag, impl)
    .pipe(Layer.provide(to ModuleImpl / ModuleRuntime))
  ```

- æˆ–åœ¨å†…éƒ¨å¯¹ Layer çš„æ„é€ åšè½»é‡çº¦æŸï¼Œåœ¨ `Logix.provide` æ—¶èƒ½éå†å‡ºæ‰€æœ‰ `Layer.succeed(tag, _)` patternï¼›
- å¯¹äºå¤æ‚ Layer ç»„åˆï¼ˆ`Layer.mergeAll` / `Layer.provide`ï¼‰ï¼Œå¯ä»¥å…ˆä¸åšæ·±å±‚é™æ€åˆ†æï¼Œåªåœ¨æ¨èè·¯å¾„ï¼ˆå¦‚ ModuleImpl.live/withLayerï¼‰ä¸Šåšè‡ªåŠ¨ Tag æå–ã€‚

Phase 2 çš„ç›®æ ‡æ˜¯è®©â€œä¸šåŠ¡æ–¹åªè¦ç”¨æ¨èå†™æ³•æä¾› Serviceï¼Œå°±ä¸éœ€è¦æ˜¾å¼ä¼  `serviceTags`â€ï¼Œä½†ä¸åœ¨ v1.0 é˜¶æ®µå¼ºè¡Œå®ç°ã€‚

## 6. æµ‹è¯•ä¸éªŒæ”¶å»ºè®®

### 6.1 Unit / Integration Tests

- `LogixApp.test.ts` æ–°å¢ï¼š
  - `should fail when two modules provide same service Tag key via provideWithTags`ï¼›
  - `should pass when modules use distinct service Tag keys`ã€‚
- å¯é€‰å†åŠ ä¸€ä¸ªâ€œTagIndex è¯Šæ–­ä¿¡æ¯â€æµ‹è¯•ï¼š
  - æ„é€  3 ä¸ªæ¨¡å—ï¼Œå…¶ä¸­ 2 ä¸ªå†²çªï¼Œæ£€æŸ¥é”™è¯¯ä¿¡æ¯ä¸­åˆ—å‡ºæ‰€æœ‰ ownerModuleIdã€‚

### 6.2 è¿ç§»ä¸å‘åå…¼å®¹

- å¯¹ç°æœ‰ä»…ä½¿ç”¨ `Logix.provide` çš„ä»£ç ï¼š
  - Phase 1 ä¸é˜»å¡ï¼ŒTagIndex åªæ£€æŸ¥ Module Tagï¼ˆç†è®ºä¸Šä¸ä¼šå†²çªï¼‰ï¼›
  - æ–°å¢çš„ `provideWithTags` ä»…åœ¨ä¸šåŠ¡æ„¿æ„å£°æ˜ Service Tag æ—¶æ‰ä½¿ç”¨ã€‚
- åœ¨å†…éƒ¨ best practice ä¸æ–‡æ¡£ä¸­ï¼Œé¼“åŠ±ï¼š
  - æ‰€æœ‰æ ¸å¿ƒ Service Tagï¼ˆå¦‚ Domain Serviceã€å¤–éƒ¨ API Clientï¼‰åœ¨æä¾›æ—¶ä½¿ç”¨ `provideWithTags` æ˜¾å¼å£°æ˜ï¼Œä¼˜å…ˆä¿éšœå…³é”®è·¯å¾„å®‰å…¨ï¼›
  - åç»­å¯é€šè¿‡ lint/è„šæœ¬è¾…åŠ©æ‰«æâ€œæœªå£°æ˜çš„å…³é”® Service Tagâ€ï¼Œé€æ­¥æ”¶ç´§ã€‚

## 7. ä¸ v1.0 Plan çš„å…³ç³»

- æœ¬è‰æ¡ˆå¯¹åº” `plan-runtime-logix-v1-readiness.md` ä¸­ Phase 1 çš„ `Tag å†²çªæ£€æµ‹ (AppRuntime)` é¡¹ï¼›
- åç»­åœ¨å®ç°ä¸æµ‹è¯•è½åœ°åï¼Œåº”å°†æœ¬è‰æ¡ˆä¸­çš„ TODO è°ƒæ•´ä¸ºå·²å®Œæˆï¼Œå¹¶åœ¨ï¼š
  - `runtime-logix-core-gaps-and-production-readiness.md` ä¸­å°† Tag å†²çªæ¡ç›®æ ‡è®°ä¸º Resolvedï¼›
  - `runtime-logix` è§„èŒƒä¸­è¡¥å…… TagIndex ç›¸å…³çš„æ­£å¼çº¦æŸï¼ˆå°¤å…¶æ˜¯æ¨¡å—/Service Tag çš„æ¨èå‘½åä¸å£°æ˜æ–¹å¼ï¼‰ã€‚
</file>

<file path="drafts/L9/runtime-logix-watcher-perf-and-leak-check.md">
---
title: Runtime Logix Â· Watcher å¹¶å‘ä¸å†…å­˜æ³„æ¼æ£€æŸ¥è®¾è®¡è‰æ¡ˆ
status: draft
version: 0.1.0
layer: L9
related:
  - ./runtime-logix-core-gaps-and-production-readiness.md
  - ./plan-runtime-logix-v1-readiness.md
  - ../../runtime-logix/impl/app-runtime-and-modules.md
priority: 2000
---

# Runtime Logix Â· Watcher å¹¶å‘ä¸å†…å­˜æ³„æ¼æ£€æŸ¥è®¾è®¡è‰æ¡ˆ

> ç›®æ ‡ï¼šä¸º v1.0 è®¾è®¡ä¸€å¥—å¯æ‰§è¡Œçš„ã€Œé•¿ç”Ÿå‘½å‘¨æœŸ / é«˜å¹¶å‘ watcherã€éªŒè¯æ–¹æ¡ˆï¼Œè¦†ç›– `run/runLatest/runFork/runParallel`ã€Linkã€`$.useRemote` ç­‰ä¸»è·¯å¾„ï¼Œå°½å¯èƒ½æå‰æš´éœ²å†…å­˜æ³„æ¼å’Œæ€§èƒ½é€€åŒ–é—®é¢˜ã€‚

## 1. èƒŒæ™¯ä¸é—®é¢˜å®šä¹‰

å½“å‰ Runtime Logix çš„å¹¶å‘/é•¿ç”Ÿå‘½å‘¨æœŸèƒ½åŠ›ä¸»è¦é€šè¿‡ä»¥ä¸‹å…¥å£æš´éœ²ï¼š

- Bound API / Flowï¼š
  - `$.onState / $.onAction / $.on`ï¼›
  - `$.flow.run / runParallel / runLatest / runExhaust / runFork / runParallelFork`ã€‚
- Linkï¼š
  - `Logix.Link` ä¸­é•¿é©»çš„è·¨æ¨¡å— Orchestrator é€»è¾‘ï¼›
  - `Link` é€šå¸¸ä¼šè®¢é˜…å¤šä¸ªæ¨¡å—çš„ `actions$` / `changes`ã€‚
- Remoteï¼š
  - `$.useRemote(Module).onState` / `.onAction` ç»„åˆå‡ºçš„è·¨æ¨¡å— watcherã€‚

è¿™äº› watcher å¤šæ•°æ˜¯é•¿ç”Ÿå‘½å‘¨æœŸã€æŒç»­è®¢é˜…å¼çš„ Effectï¼š

- ä¸€æ—¦ Scope / SubscriptionRef / Fiber ç®¡ç†ä¸å½“ï¼Œææ˜“å‡ºç°ï¼š
  - Fiber æ± å¢é•¿ä¸å›æ”¶ï¼›
  - SubscriptionRef/Stream è®¢é˜…ä¸è§£é™¤ï¼›
  - ModuleRuntime å¤šæ¬¡åˆ›å»º/é”€æ¯ä½†è€çš„ watcher ä»åœ¨è·‘ã€‚

æœ¬è‰æ¡ˆè¦è§£å†³çš„é—®é¢˜æ˜¯ï¼š

- å®šä¹‰ä¸€ç»„ **å¯é‡å¤æ‰§è¡Œçš„ benchmark / test åœºæ™¯**ï¼Œä¸“é—¨é’ˆå¯¹ watcher å¹¶å‘ä¸å†…å­˜æ³„æ¼ï¼›
- ä¸ºæ—¥å¸¸å¼€å‘å’Œ v1.0 å‘å¸ƒå‰æä¾›ä¸€å¥—â€œæ˜¯å¦æœ‰æ˜æ˜¾å†…å­˜/èµ„æºæ³„æ¼â€çš„æ£€æŸ¥æ‰‹æ®µã€‚

## 2. è®¾è®¡ç›®æ ‡ä¸èŒƒå›´

### 2.1 è®¾è®¡ç›®æ ‡

1. **å…·å¤‡å¯æ‰§è¡Œè„šæœ¬**ï¼šæä¾›ä¸€å¥—å¯ä»¥é€šè¿‡ `pnpm bench:watchers` æˆ– `pnpm test:watchers` è¿è¡Œçš„è„šæœ¬ï¼Œè§‚å¯Ÿèµ„æºä½¿ç”¨æ›²çº¿ï¼›
2. **è¦†ç›–æ ¸å¿ƒæ¨¡å¼**ï¼šè‡³å°‘è¦†ç›–ï¼š
   - å•æ¨¡å—é«˜é¢‘ `onAction().runFork` / `runParallel`ï¼›
   - å¤šæ¨¡å— + Link + `$.useRemote` è”åŠ¨ï¼›
   - React åœºæ™¯ä¸‹åå¤ mount/unmount hooksï¼ˆ`useModule` / `useLocalModule`ï¼‰ï¼›
3. **å¯æ¯”è¾ƒ**ï¼šèƒ½å¤Ÿåœ¨ä¸åŒæäº¤ä¹‹é—´å¯¹æ¯”â€œæ³„æ¼/èµ„æºä¸Šç•Œæ˜¯å¦å˜å·®â€ï¼Œè€Œä¸è¦æ±‚éå¸¸ç²¾ç¡®çš„æ•°å€¼ï¼›
4. **éä¾µå…¥**ï¼šå°½é‡é€šè¿‡ç°æœ‰ APIï¼ˆDebugSink / Lifecycle / å†…éƒ¨è®¡æ•°å™¨ï¼‰è§‚æµ‹ï¼Œè€Œä¸åœ¨æ ¸å¿ƒè·¯å¾„å¼•å…¥é‡å‹ profilingã€‚

### 2.2 èŒƒå›´è¾¹ç•Œ

æœ¬è‰æ¡ˆ focus çš„æ˜¯ï¼š

- `@logix/core` å†…éƒ¨ watcher çš„ Fiber/Scope/SubscriptionRef ç®¡ç†ï¼›
- `@logix/react` åœ¨å…¸å‹ React æŒ‚è½½/å¸è½½åœºæ™¯ä¸­çš„ ModuleRuntime é‡Šæ”¾æƒ…å†µã€‚

ä¸åŒ…æ‹¬ï¼š

- æµè§ˆå™¨çº§åˆ«çš„ FPS/æ¸²æŸ“æ—¶é—´ï¼ˆè¿™æ›´å UI/äº¤äº’å±‚ benchmarkï¼‰ï¼›
- å¤æ‚ä¸šåŠ¡æµç¨‹ï¼ˆåªæŠ½è±¡æœ€å…¸å‹çš„æµæ§æ¨¡å¼ï¼‰ã€‚

## 3. è§‚æµ‹æŒ‡æ ‡ä¸å·¥å…·ç­–ç•¥

ä¸ºäº†ä¸æŠŠæ ¸å¿ƒä»£ç å¼„å¾—å¤ªå¤æ‚ï¼Œå»ºè®®é‡‡ç”¨â€œè½»é‡å†…éƒ¨è®¡æ•° + DebugSinkâ€ç»„åˆï¼š

- åœ¨ `ModuleRuntime.make` å†…éƒ¨ç»´æŠ¤ä¸€äº› debug-only è®¡æ•°å™¨ï¼ˆé€šè¿‡ `DebugSink` æˆ–ä¸“ç”¨ tag æš´éœ²ï¼‰ï¼š
  - å½“å‰ active watcher Fiber æ•°é‡ï¼ˆæˆ– rough ä¼°ç®—ï¼‰ï¼›
  - æ¯ä¸ª ModuleRuntime çš„ `subscriptionCount`ï¼ˆç”± `changes` / `actions$` æ´¾ç”Ÿï¼‰ï¼›
  - ModuleRuntime åˆ›å»º/é”€æ¯æ¬¡æ•°ï¼ˆå·²æœ‰ `module:init` / `module:destroy` äº‹ä»¶ï¼Œå¯ç”¨ï¼‰ã€‚
- åœ¨ benchmark/test è„šæœ¬ä¸­ï¼š
  - é€šè¿‡æ³¨å…¥ç‰¹å®šçš„ DebugSink å®ç°ï¼Œæ”¶é›†ä¸Šè¿°äº‹ä»¶ï¼›
  - åœ¨è·‘å®Œåœºæ™¯åï¼Œå¯¹è¿™äº›è®¡æ•°å™¨åšç®€å• sanity checkï¼š
    - Fiber/è®¢é˜…æ•°é‡åœ¨æµ‹è¯•ç»“æŸåä¸å†å¢é•¿ï¼›
    - destroy æ•°é‡ä¸ create æ•°é‡åŒ¹é…ï¼ˆåœ¨é¢„æœŸèŒƒå›´å†…ï¼‰ã€‚

> è¯´æ˜ï¼šè¿™äº›è®¡æ•°å™¨å¯ä»¥é€šè¿‡â€œä»…åœ¨å¼€å‘/æµ‹è¯•ç¯å¢ƒå¯ç”¨â€çš„æ–¹å¼å®ç°ï¼Œä¾‹å¦‚å— `NODE_ENV !== "production"` æ§åˆ¶ï¼Œé¿å…ç”Ÿäº§ç¯å¢ƒæ€§èƒ½å½±å“ã€‚

## 4. åœºæ™¯ä¸€ï¼šå•æ¨¡å—é«˜é¢‘ `runFork` / `runParallel`

### 4.1 åœºæ™¯æè¿°

- æ¨¡å— `Counter`ï¼š
  - state: `{ value: number }`ï¼›
  - actions: `{ tick: void }`ã€‚
- Logic Aï¼ˆrunForkï¼‰ï¼š

```ts
const CounterRunForkLogic = Counter.logic(($) =>
  Effect.gen(function* () {
    yield* $.onAction("tick").runFork(
      $.state.update((s) => ({ ...s, value: s.value + 1 })),
    )
  }),
)
```

- benchmark è¡Œä¸ºï¼š
  - åœ¨ä¸€ä¸ª ModuleRuntime å®ä¾‹ä¸Šï¼Œè¿ç»­ dispatch `tick` N æ¬¡ï¼ˆä¾‹å¦‚ 10k æ¬¡ï¼‰ï¼Œé—´éš”å°½é‡çŸ­ï¼›
  - ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆä¾‹å¦‚ 1sï¼‰ï¼Œè®©æ‰€æœ‰ watcher æœ‰æœºä¼šæ‰§è¡Œå®Œï¼›
  - è®°å½•ï¼š
    - æœ€ç»ˆ state.value æ˜¯å¦ä¸º Nï¼›
    - DebugSink å†…è®°å½•çš„ watcher Fiber æ•°é‡æ˜¯å¦åœ¨åˆç†ä¸Šç•Œå†…ï¼ˆä¸ä¼šéš N æŒç»­çº¿æ€§å¢é•¿ï¼‰ã€‚

### 4.2 å®ç°è¦ç‚¹

- entryï¼š`packages/logix-core/test/watcherPatterns.test.ts` æˆ–å•ç‹¬çš„ `benchmarks/watcher-fork-bench.ts`ï¼›
- å¯ç”¨ `TestClock` / `Schedule` æ§åˆ¶æ—¶é—´ï¼Œå‡å°‘çœŸå®æ—¶é—´ç­‰å¾…ï¼›
- ç¡®ä¿æ‰€æœ‰ watcher è¢«ç»‘å®šåˆ° ModuleRuntime çš„ Scope ä¸Šï¼ˆå·²æœ‰ `Effect.forkScoped`ï¼‰ï¼Œåœ¨ Scope close æ—¶è‡ªåŠ¨æ¸…ç†ã€‚

### 4.3 éªŒæ”¶æ ‡å‡†ï¼ˆç¤ºä¾‹ï¼‰

- åœ¨ N = 10k æ—¶ï¼Œæµ‹è¯•å¯ä»¥åœ¨é™å®šæ—¶é—´å†…å®Œæˆï¼ˆä¾‹å¦‚ <5sï¼‰ï¼Œstate.value == Nï¼›
- æ¨¡å—é”€æ¯åï¼ˆScope closeï¼‰ä¸ä¼šå†æœ‰æ–°çš„ DebugSink äº‹ä»¶ï¼ˆå¦‚ action dispatch / state updateï¼‰ï¼›
- watcher Fiber çš„æœ€å¤§æ•°é‡åœ¨ N çš„æ•°é‡çº§é™„è¿‘ï¼Œä½†åœ¨æµ‹è¯•ç»“æŸåä¸å†å¢é•¿ã€‚

## 5. åœºæ™¯äºŒï¼šå¤šæ¨¡å— + Link + `$.useRemote`

### 5.1 åœºæ™¯æè¿°

- æ¨¡å—ï¼š
  - `Source`ï¼šè§¦å‘ action æµï¼›
  - `Target`ï¼šå®é™…åšä¸€äº›è½»é‡ state æ›´æ–°ï¼›
  - `Badge`ï¼šé€šè¿‡ `$.useRemote(Target)` ç›‘å¬ Target çŠ¶æ€ï¼Œæ›´æ–°è‡ªå·±çš„å±•ç¤ºå­—æ®µï¼›
  - Linkï¼šåœ¨ Source å’Œ Target ä¹‹é—´åšé¢å¤– Orchestratorï¼ˆä¾‹å¦‚è¿‡æ»¤ã€èšåˆï¼‰ã€‚
- ç›®æ ‡ï¼š
  - åœ¨æœ‰ Link + useRemote çš„çŠ¶æ€ä¸‹ï¼Œé¢‘ç¹è§¦å‘ Source/Target çš„ actionï¼ŒéªŒè¯ï¼š
    - æ‰€æœ‰è”åŠ¨é“¾è·¯åœ¨é«˜é¢‘ä¸‹ä¿æŒæ­£ç¡®ï¼›
    - Link / Remote watcher çš„ Fiber/è®¢é˜…åœ¨ç»“æŸæ—¶è¢«å›æ”¶ã€‚

### 5.2 è¡Œä¸ºè„šæœ¬ï¼ˆç®€è¦ï¼‰

```ts
// ä¼ªä»£ç ç»“æ„

const app = Logix.app({
  layer: Layer.empty,
  modules: [
    Logix.provide(Source, Source.live(...)),
    Logix.provide(Target, Target.live(...)),
    Logix.provide(Badge, Badge.live(...)), // å†…éƒ¨ç”¨ $.useRemote(Target)
  ],
  processes: [LinkLogic], // Logix.Link(...)
})

const program = Effect.gen(function* () {
  const source = yield* Effect.provide(Source, app.layer)
  const badge = yield* Effect.provide(Badge, app.layer)

  for (let i = 0; i < N; i++) {
    yield* source.dispatch({ _tag: "trigger", payload: ... })
  }

  yield* Effect.sleep("1 second")

  const badgeState = yield* badge.getState
  // æ–­è¨€ badgeState åæ˜ äº†æ‰€æœ‰æœ‰æ•ˆè§¦å‘
})
```

### 5.3 è§‚æµ‹ç‚¹

- DebugSink ä¸­ï¼š
  - Link ç›¸å…³çš„ error/event æ˜¯å¦å¯è§ï¼›
  - åœ¨ app Scope å…³é—­åï¼Œä¸å†æœ‰ Link æˆ– Remote watcher å‘å‡ºçš„äº‹ä»¶ã€‚
- Fiber/è®¢é˜…ï¼š
  - æ¯ä¸ª ModuleRuntime çš„ watcher æ•°é‡æ˜¯å¦ç¨³å®šåœ¨é¢„æœŸä¸Šç•Œï¼›
  - å¤šæ¬¡é‡å¤è¿è¡Œ benchmarkï¼ˆä¾‹å¦‚ 10 æ¬¡ï¼‰åï¼Œèµ„æºå ç”¨ä¸å‘ˆçº¿æ€§å¢é•¿ã€‚

## 6. åœºæ™¯ä¸‰ï¼šReact ä¸‹çš„ mount/unmount å‹åŠ›

### 6.1 åœºæ™¯æè¿°

- ä½¿ç”¨ `@logix/react` çš„ hooksï¼š
  - `RuntimeProvider` æä¾›ä¸€ä¸ªåŒ…å«è‹¥å¹²æ¨¡å—çš„ AppRuntimeï¼›
  - å­ç»„ä»¶ A ä½¿ç”¨ `useModule(Module)` æˆ– `useModule(Module, selector)`ï¼›
  - å­ç»„ä»¶ B ä½¿ç”¨ `useLocalModule(ModuleImpl)`ã€‚
- æµ‹è¯•è¡Œä¸ºï¼š
  - å¾ªç¯ mount/unmount A/B ç»„ä»¶ N æ¬¡ï¼ˆä¾‹å¦‚ 1000 æ¬¡ï¼‰ï¼›
  - åœ¨æ¯æ¬¡ mount æœŸé—´ dispatch è‹¥å¹² actionï¼Œè§‚å¯Ÿ state æ­£å¸¸æ›´æ–°ï¼›
  - åœ¨å…¨éƒ¨ unmount åï¼ŒéªŒè¯ï¼š
    - DebugSink ä¸­ `module:destroy` äº‹ä»¶æ•°é‡ä¸ `module:init` å¤§è‡´åŒ¹é…ï¼›
    - Runtime å†…éƒ¨ Scope/Fiber æ²¡æœ‰æŒç»­å¢é•¿ã€‚

### 6.2 å®ç°å»ºè®®

- ä½¿ç”¨ `vitest` çš„ jsdom/happy-dom ç¯å¢ƒï¼Œåœ¨ `packages/logix-react/test` ä¸­æ·»åŠ  `useLocalModule.leak.test.tsx`ï¼š
  - ç”¨ä¸€ä¸ªç®€å•çš„ `TestComponent` åŒ…ä¸€å±‚ `RuntimeProvider`ï¼›
  - åœ¨æµ‹è¯•ä¸­æ‰‹åŠ¨æ§åˆ¶ mount/unmountï¼ˆ`render` / `unmount`ï¼‰ï¼›
  - é€šè¿‡è‡ªå®šä¹‰ DebugSink æ”¶é›† module init/destroy äº‹ä»¶ã€‚

## 7. ä»»åŠ¡æ‹†åˆ†ä¸è½åœ°é¡ºåº

å‚è€ƒ `runtime-logix-core-gaps-and-production-readiness.md` å’Œ v1 Planï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºå®æ–½ï¼š

1. **æ ¸å¿ƒè®¡æ•°ä¸ DebugSink æ‰©å±•**  
   - åœ¨ `ModuleRuntime.make` å†…å¢åŠ  debug-only çš„è®¡æ•°å™¨ï¼ˆFiber/è®¢é˜…æ•°é‡ï¼‰å’Œ DebugSink äº‹ä»¶ï¼›
   - ç¡®ä¿è¿™äº›è®¡æ•°åœ¨ç”Ÿäº§æ„å»ºä¸‹å¯ä»¥å…³é—­æˆ–é™çº§ã€‚

2. **æ ¸å¿ƒ watcher åœºæ™¯çš„å•å…ƒ/é›†æˆæµ‹è¯•ï¼ˆcore åŒ…ï¼‰**  
   - åœ¨ `watcherPatterns.test.ts` æˆ–æ–°å¢æ–‡ä»¶ä¸­å®ç°â€œå•æ¨¡å—é«˜é¢‘ runFork/runParallelâ€åœºæ™¯ï¼›
   - å¢åŠ  Link + useRemote è”åŠ¨åœºæ™¯çš„é«˜é¢‘æµ‹è¯•ã€‚

3. **React æŒ‚è½½/å¸è½½åœºæ™¯æµ‹è¯•ï¼ˆreact åŒ…ï¼‰**  
   - æ–°å¢ hook å±‚é¢çš„ leak/pressure æµ‹è¯•ï¼Œè¦†ç›– `useModule` / `useLocalModule` / `useLayerModule`ï¼›
   - ä¸ core çš„ DebugSink è®¡æ•°ç»“åˆï¼ŒéªŒè¯æ²¡æœ‰æ˜æ˜¾æ³„æ¼ã€‚

4. **å¯é€‰ï¼šç®€å•çš„ bench è„šæœ¬**  
   - åœ¨ `benchmarks/` ç›®å½•ä¸‹è¡¥å……è„šæœ¬ï¼Œæ–¹ä¾¿æœ¬åœ°æˆ– CI ä¸Šåšç²—ç²’åº¦çš„æ€§èƒ½/å†…å­˜å›å½’æ£€æŸ¥ï¼›
   - ä¸å¼ºåˆ¶é›†æˆåˆ°å¸¸è§„ test suiteï¼Œä½†åœ¨ release å‰åšä¸€æ¬¡äººå·¥/è‡ªåŠ¨è·‘é€šã€‚

## 8. ä¸ v1.0 Plan çš„å…³ç³»

- æœ¬è‰æ¡ˆå¯¹åº” `plan-runtime-logix-v1-readiness.md` ä¸­ Phase 3 çš„â€œå‹åŠ›æµ‹è¯•ä¸å†…å­˜åŸºå‡†â€éƒ¨åˆ†ï¼›
- å½“ä¸Šè¿°åœºæ™¯ä¸æŒ‡æ ‡è½åœ°åï¼Œåº”åœ¨ï¼š
  - `runtime-logix-core-gaps-and-production-readiness.md` ä¸­å°† 2.4 æ¡ç›®æ ‡è®°ä¸º Resolvedï¼›
  - `runtime-logix` è§„èŒƒæˆ– impl/README ä¸­è¡¥å……ä¸€èŠ‚â€œWatcher èµ„æºç®¡ç†ä¸å‹åŠ›æµ‹è¯•ç­–ç•¥â€ï¼Œä¾›æœªæ¥è´¡çŒ®è€…å‚è€ƒã€‚
</file>

<file path="drafts/topics/ai-native-core/00-architecture.md">
---
title: Logix AI Native Architecture (Effect AI Integration)
status: draft
version: 2025-11-28
---

# Logix AI Native æ¶æ„è®¾è®¡ (åŸºäº Effect AI)

æœ¬æ–‡æ¡£å°† `@effect/ai` çš„èƒ½åŠ›æ·±åº¦èåˆè¿› Logix v3 çš„ Intent/Runtime ä½“ç³»ä¸­ï¼Œå®šä¹‰ Logix çš„ AI åŸç”Ÿå½¢æ€ã€‚

## 1. æ ¸å¿ƒæ˜ å°„å…³ç³» (Core Mapping)

æˆ‘ä»¬å°† Effect AI çš„åŸè¯­æ˜ å°„åˆ° Logix çš„èµ„äº§ä½“ç³»ä¸­ï¼š

| Effect AI åŸè¯­ | Logix èµ„äº§ä½“ç³» (v3) | å¹³å°ä¾§å½¢æ€ (L1/L2) |
| :--- | :--- | :--- |
| `AiInput` (Schema) | **Prompt Intent** | Prompt æ¨¡æ¿ç¼–è¾‘å™¨ (æ”¯æŒå˜é‡æ’æ§½) |
| `Completions` (Service) | **AiServiceTag** | å†…ç½®æ ‡å‡†æœåŠ¡ (æ— éœ€æ‰‹å†™) |
| `Function Call` | **Tool Registry** | Tool Registry / æ’ä»¶å¸‚åœº |
| `AiOutput` (Schema) | **State Schema** | ç»“æ„åŒ–è¾“å‡ºç›´æ¥ç»‘å®šåˆ° Store State |

> **Note**: Logix å¼•å…¥ `LogixAiRuntime` ä½œä¸ºæŠ½è±¡å±‚ï¼Œä¸ç›´æ¥æš´éœ² Effect AI çš„ `AiInput`/`Completions` ç±»å‹ï¼Œä»¥ä¿æŒæ¶æ„ç‹¬ç«‹æ€§ã€‚

## 2. è¯¦ç»†è®¾è®¡

### 2.1 Prompt Intent (L2 Asset)

åœ¨ Logix ä¸­ï¼ŒPrompt ä¸å†æ˜¯æ•£è½åœ¨ä»£ç é‡Œçš„å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯ **Schema å®šä¹‰çš„èµ„äº§**ã€‚

```typescript
// defined in packages/effect-runtime-poc/src/prompts/Summarize.ts

// 1. å®šä¹‰è¾“å…¥ Schema (Prompt å˜é‡)
const SummarizeInput = Schema.Struct({
  text: Schema.String,
  style: Schema.Literal("concise", "detailed")
});

// 2. å®šä¹‰ Prompt Intent (åŒ…å«æ¨¡æ¿ä¸å…ƒæ•°æ®)
export const SummarizePrompt = Prompt.define({
  id: "prompts/summarize",
  inputSchema: SummarizeInput,
  outputSchema: Schema.String, // å¯é€‰ï¼Œç”¨äºç»“æ„åŒ–è¾“å‡ºæ ¡éªŒ
  template: `
    Please summarize the following text in a {{style}} style:
    ---
    {{text}}
    ---
  `,
  meta: {
    description: "Summarize text with style control",
    tags: ["nlp", "summary"]
  }
});
```

**Logix å¹³å°ä»·å€¼**ï¼š
*   **å¯è§†åŒ–ç¼–è¾‘**ï¼šå¹³å°è¯»å– `SummarizeInput` Schemaï¼Œè‡ªåŠ¨ç”Ÿæˆ Prompt ç¼–è¾‘å™¨çš„å˜é‡è¡¨å•ã€‚
*   **ç‰ˆæœ¬ç®¡ç†**ï¼šPrompt èµ„äº§å¯ä»¥åƒä»£ç ä¸€æ ·è¿›è¡Œ Git ç‰ˆæœ¬æ§åˆ¶ã€‚

### 2.2 AI Flow (L3 Runtime)

åœ¨ Logix Flow ä¸­è°ƒç”¨ AI èƒ½åŠ›ï¼Œå°±åƒè°ƒç”¨æ™®é€š Service ä¸€æ ·ï¼Œä½†æ›´å¼ºç±»å‹ã€‚

```typescript
// defined in packages/effect-runtime-poc/src/flows/analyzeDocument.ts

export const analyzeDocumentFlow = Flow.make<DocShape>(
  Effect.gen(function* ($) {
    // 1. è·å–è¾“å…¥ (ä» Store State)
    const docContent = yield* $.state.read(s => s.content);

    // 2. æ„é€  AI Input (ä½¿ç”¨ Prompt Intent)
    const input = yield* Prompt.render(SummarizePrompt, {
      text: docContent,
      style: "concise"
    });

    // 3. è°ƒç”¨ AI Service (Effect AI åº•å±‚)
    // è‡ªåŠ¨æ³¨å…¥ Trace Spanï¼Œå¹¶åœ¨ DevTools ä¸­æ˜¾ç¤º "AI Request"
    const summary = yield* AiService.complete(input);

    // 4. æ›´æ–° State (ç»“æ„åŒ–è¾“å‡º)
    yield* $.state.update(s => ({ ...s, summary }));
  })
);
```

### 2.3 Agent Pattern (L2 Asset)

Agent æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ **Logix Pattern**ï¼Œå®ƒå°è£…äº† "ReAct Loop"ã€‚

```typescript
// defined in packages/effect-runtime-poc/src/patterns/ResearchAgent.ts

export const ResearchAgent = Agent.define({
  id: "agents/researcher",
  role: "You are a senior researcher.",
  // è‡ªåŠ¨å°† Logix Service Tag è½¬æ¢ä¸º LLM Tools
  tools: [
    Tool.fromService(GoogleSearchTag),
    Tool.fromService(WebScraperTag)
  ],
  // å®šä¹‰è®°å¿†ç­–ç•¥
  memory: Memory.Window({ k: 10 })
});

// åœ¨ Flow ä¸­ä½¿ç”¨
yield* Agent.run(ResearchAgent, { goal: "Analyze Logix v3 architecture" });
```

## 3. è¿è¡Œæ—¶å¢å¼º (Runtime Enhancements)

ä¸ºäº†æ”¯æ’‘ä¸Šè¿°è®¾è®¡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `effect-runtime-poc` ä¸­å¼•å…¥ä»¥ä¸‹ Layerï¼š

### 3.1 `AiRuntimeLayer`

è¿™æ˜¯ Logix Runtime çš„æ ‡å‡†ç»„ä»¶ï¼Œè´Ÿè´£æä¾› `AiService`ã€‚

```typescript
// runtime/layers.ts
import { OpenAi } from "@effect/ai-openai";

// å¼€å‘è€…åœ¨ logix.config.ts ä¸­é…ç½®
export const AiRuntimeLayer = Layer.mergeAll(
  // é»˜è®¤ä½¿ç”¨ OpenAIï¼Œä¹Ÿå¯ä»¥åˆ‡æ¢ä¸º Ollama æˆ– Anthropic
  OpenAi.Live({ apiKey: Config.secret("OPENAI_API_KEY") }),
  // æ³¨å…¥ Token è®¡é‡å™¨
  TokenCostTracker.Live
);
```

### 3.2 `TokenCostTracker` (Observability)

åˆ©ç”¨ Effect çš„ `FiberRef` æˆ– `Context`ï¼Œåœ¨ AI è°ƒç”¨é“¾è·¯ä¸­è‡ªåŠ¨ç»Ÿè®¡ Token æ¶ˆè€—ã€‚

*   **Logix DevTools**: å¯ä»¥åœ¨ Timeline ä¸Šçœ‹åˆ°æ¯ä¸ª Flow æ¶ˆè€—äº†å¤šå°‘ Tokenï¼ŒæŠ˜åˆå¤šå°‘è´¹ç”¨ã€‚
*   **Quota Control**: å¯ä»¥è®¾ç½® "Max Cost per Flow"ï¼Œé˜²æ­¢ AI è·‘é£ã€‚

## 4. æ€»ç»“

é€šè¿‡é›†æˆ `@effect/ai`ï¼ŒLogix è·å¾—äº†ä»¥ä¸‹ **AI Native** èƒ½åŠ›ï¼š

1.  **Prompt as Asset**: Prompt å˜æˆå¼ºç±»å‹çš„ã€å¯ç®¡ç†çš„èµ„äº§ã€‚
2.  **Service as Tool**: ç°æœ‰çš„ Logix Service ç”Ÿæ€ç›´æ¥è½¬åŒ–ä¸º Agent Toolsã€‚
3.  **Flow as Orchestrator**: Logix Flow æˆä¸º AI Agent çš„ç¼–æ’å¼•æ“ï¼Œæä¾›å¹¶å‘æ§åˆ¶å’ŒçŠ¶æ€ç®¡ç†ã€‚

è¿™ä½¿å¾— Logix ä¸ä»…èƒ½å¼€å‘æ™®é€š Web Appï¼Œä¹Ÿèƒ½å¼€å‘å¤æ‚çš„ **AI Agentic Applications** (å¦‚ Dify åŠå…¶è¶…è¶Šè€…)ã€‚
</file>

<file path="drafts/topics/ai-native-core/10-effect-integration.md">
---
title: Effect AI Integration Strategy
status: draft
version: 2025-11-28
---

# Effect AI é›†æˆç­–ç•¥ (Integration Strategy)

æœ¬æ–‡æ¡£åˆ†æ `@effect/ai` (Effect å®˜æ–¹ AI åº“) çš„æ ¸å¿ƒç‰¹æ€§ï¼Œå¹¶åˆ¶å®šå…¶åœ¨ Logix å¹³å°ä¸­çš„é›†æˆç­–ç•¥ã€‚

## 1. Effect AI æ ¸å¿ƒç‰¹æ€§åˆ†æ

æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œ`@effect/ai` æä¾›äº†ä»¥ä¸‹å…³é”®èƒ½åŠ›ï¼Œä¸ Logix çš„ "AI Native" æ„¿æ™¯é«˜åº¦å¥‘åˆï¼š

1.  **Provider-Agnostic (ä¾›åº”å•†æ— å…³)**
    *   **ç‰¹æ€§**: ä¸šåŠ¡é€»è¾‘åªéœ€ä¾èµ– `AiInput` / `Completions` æŠ½è±¡æ¥å£ï¼Œè¿è¡Œæ—¶é€šè¿‡ Layer æ³¨å…¥å…·ä½“å®ç° (OpenAI, Anthropic, Ollama)ã€‚
    *   **Logix ä»·å€¼**: å®Œç¾å¥‘åˆ Logix çš„ `Service Tag` æ¶æ„ã€‚Logix ä¸å†éœ€è¦æ‰‹å†™ `OpenAIService`ï¼Œè€Œæ˜¯ç›´æ¥æš´éœ² Effect AI çš„æ ‡å‡†æ¥å£ã€‚

2.  **Schema-Driven Inputs (Schema é©±åŠ¨è¾“å…¥)**
    *   **ç‰¹æ€§**: ä½¿ç”¨ `Effect.Schema` å®šä¹‰ AI è¾“å…¥/è¾“å‡ºç»“æ„ï¼Œç¡®ä¿ç±»å‹å®‰å…¨ã€‚
    *   **Logix ä»·å€¼**: è§£å†³äº† "Prompt as Schema" çš„å®ç°é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ç”¨ `Schema` å®šä¹‰ Prompt æ¨¡æ¿çš„å˜é‡æ’æ§½ã€‚

3.  **Structured Concurrency & Observability**
    *   **ç‰¹æ€§**: å†…ç½®æµå¼å¤„ç† (Streaming)ã€é‡è¯• (Retries)ã€è¶…æ—¶ (Timeouts) å’Œè¿½è¸ª (Tracing)ã€‚
    *   **Logix ä»·å€¼**: æä¾›äº†ç°æˆçš„ Agent Runtime åº•åº§ã€‚ReAct å¾ªç¯ä¸­çš„æ¯ä¸€æ­¥éƒ½å¯ä»¥æ˜¯å—æ§çš„ Effectã€‚

## 2. é›†æˆæ–¹æ¡ˆ (The "How")

### 2.1 æ›¿æ¢åº•å±‚ AI Service

ç›®å‰ Logix PoC ä¸­çš„ `OrderService` ç­‰æ˜¯æ‰‹å†™çš„ã€‚æœªæ¥åº”å¼•å…¥ `@effect/ai` ä½œä¸ºæ ‡å‡†åº“ã€‚

```typescript
// Before: æ‰‹å†™ Service
interface MyAIService {
  chat(msg: string): Effect<string>;
}

// After: ä½¿ç”¨ Logix AI Abstraction
import { AiServiceTag, Prompt } from "@logix/ai";

const program = Effect.gen(function* () {
  // 1. Render Prompt Intent to abstract Input
  const input = yield* Prompt.render(MyPrompt, { role: "user", content: "Hello" });

  // 2. Call Abstract Service
  const response = yield* AiServiceTag.complete(input);
  return response;
});

// è¿è¡Œæ—¶æ³¨å…¥ Provider (åº•å±‚ä½¿ç”¨ Effect AI)
program.pipe(Effect.provide(LogixAiRuntime.Live));
```

### 2.2 å®šä¹‰ "AI Intent" åŸè¯­

åŸºäº Effect AIï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰æ›´é«˜å±‚çš„ Logix AI Intentï¼š

1.  **Prompt Intent**:
    ```typescript
    const SummarizePrompt = Schema.Struct({ text: Schema.String }).pipe(
      Schema.annotations({
        ai: { template: "Summarize: {{text}}" } // æ‰©å±• Schema Annotation
      })
    );
    ```

2.  **Agent Intent**:
    åˆ©ç”¨ Effect AI çš„ `Function Call` æ”¯æŒï¼Œå°† Logix çš„ `Service Tag` æ˜ å°„ä¸º **Tool**ï¼Œç”± Agent Pattern è¿›è¡Œè°ƒåº¦ã€‚

### 2.3 è§£å†³ Gap Analysis ä¸­çš„ç¼ºå¤±

å›é¡¾ `logix-platform-gap-analysis.md`ï¼ŒEffect AI å¡«è¡¥äº†ä»¥ä¸‹ç©ºç™½ï¼š

*   **AI Native Runtime**: âœ… ç›´æ¥å¤ç”¨ `@effect/ai`ï¼Œæ— éœ€è‡ªç ”ã€‚
*   **Observability**: âœ… Effect AI è‡ªå¸¦ Traceï¼Œåªéœ€æ¥å…¥ Logix DevToolsã€‚
*   **Provider Switching**: âœ… å¤©ç„¶æ”¯æŒ Layer åˆ‡æ¢ï¼Œå®ç° "Model Routing" (ä¾‹å¦‚ï¼šç®€å•ä»»åŠ¡ç”¨ GPT-3.5ï¼Œå¤æ‚ä»»åŠ¡ç”¨ GPT-4)ã€‚

## 3. ç»“è®º

**`@effect/ai` æ˜¯ Logix å®ç° "AI Native" çš„æ·å¾„ã€‚**

æˆ‘ä»¬ä¸éœ€è¦ä»å¤´æ„å»º AI Runtimeï¼Œè€Œæ˜¯åº”è¯¥æˆä¸º **Effect AI çš„ç¼–æ’å±‚ (Orchestrator)**ã€‚Logix çš„ä»·å€¼åœ¨äºç®¡ç† Prompt èµ„äº§ã€ç¼–æ’ Agent æµç¨‹ (Flow) ä»¥åŠæä¾›å¯è§†åŒ–å·¥å…·ï¼Œè€Œåº•å±‚çš„ LLM äº¤äº’å®Œå…¨äº¤ç»™ Effect AIã€‚
</file>

<file path="drafts/topics/ai-native-core/README.md">
---
title: AI Native Core Â· Topic Overview
status: draft
version: 2025-12-03
---

# AI Native Core Â· Topic Overview

æœ¬ Topic èšç„¦ã€ŒAI èƒ½åŠ›å¦‚ä½•èå…¥ Logix v3 å†…æ ¸ã€ï¼Œä»¥ `@effect/ai` ä¸ºä¸»è¦ä¾æ‰˜ï¼Œè®¨è®º Prompt/Tool/Service åœ¨ Intent & Runtime ä½“ç³»ä¸­çš„è½ç‚¹ã€‚

æ ¸å¿ƒå…³æ³¨ç‚¹ï¼š

- å°† Effect AI çš„åŸè¯­æ˜ å°„åˆ° v3 çš„èµ„äº§ä½“ç³»ï¼ˆPrompt Intentã€AiServiceTagã€Tool Registryã€State Schema ç­‰ï¼‰ï¼›
- æŠ½è±¡å‡º `LogixAiRuntime` / Ai Service Tag å±‚ï¼Œé¿å…ç›´æ¥æ³„æ¼åº•å±‚ Provider ç»†èŠ‚ï¼›
- è§„åˆ’ AI é›†æˆåœ¨ Logix/å¹³å°ä¸­çš„é•¿æœŸæ¼”è¿›è·¯å¾„ï¼ˆé”™è¯¯è¯­ä¹‰ã€è§‚æµ‹æ€§ã€æµå¼å¤„ç†ç­‰ï¼‰ã€‚

## æ–‡æ¡£ç´¢å¼•

- [00-architecture.md](./00-architecture.md) Â· Logix AI Native æ¶æ„è®¾è®¡ï¼ˆEffect AI ä¸ v3 Intent/Runtime çš„æ•´ä½“æ˜ å°„å…³ç³»ï¼‰  
- [10-effect-integration.md](./10-effect-integration.md) Â· Effect AI é›†æˆç­–ç•¥ï¼ˆProvider æŠ½è±¡ã€Schema é©±åŠ¨è¾“å…¥ã€å¹¶å‘ä¸è§‚æµ‹æ€§ç­‰ï¼‰
</file>

<file path="drafts/topics/ai-native-ui/00-architecture-overview.md">
---
title: The Grand Bidirectional Architecture
status: draft
version: 1.0
---

# The Grand Bidirectional Architecture: Intent <-> Code

> **Status**: Consolidated (Architecture Overview)
> **Context**: `v3/ai-native`
> **Previous**: `L7/grand-bidirectional-architecture.md`

æœ¬æ–‡æ¡£å®šä¹‰ Logix çš„å®è§‚æ¶æ„å›¾æ™¯ï¼š**ä»æ¨¡ç³Šéœ€æ±‚åˆ°ç²¾ç¡®ä»£ç ï¼Œå†å›å½’æ„å›¾çš„å…¨åŒå·¥é“¾è·¯**ã€‚

## 1. The Four States of Matter

è½¯ä»¶åœ¨ Logix ä½“ç³»ä¸­å­˜åœ¨å››ç§å½¢æ€ï¼š

1.  **Vapor (Requirements)**: è‡ªç„¶è¯­è¨€ï¼Œæ¨¡ç³Šï¼Œé«˜ç†µã€‚
2.  **Liquid (Intent)**: Skeleton/Schemaï¼Œç»“æ„åŒ–ï¼Œé«˜å‹ç¼©æ¯”ï¼Œè¯­ä¹‰ä¸°å¯Œã€‚
3.  **Solid (Code)**: Flesh/Soulï¼Œå…·ä½“å®ç°ï¼Œä½å‹ç¼©æ¯”ï¼Œç»†èŠ‚ç¹æ‚ã€‚
4.  **Plasma (Runtime)**: Live Componentï¼ŒåŠ¨æ€ï¼Œç¬æ—¶ï¼Œäº¤äº’æ€ã€‚

## 2. The Grand Map of Transitions

æˆ‘ä»¬å®šä¹‰äº† 6 ç§æ ¸å¿ƒæµè½¬ï¼ˆTransitionsï¼‰ï¼š

| ID | Transition | Direction | Nature | Protocol / Artifact | AI Role |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **T1** | **De-fuzzing** | Vapor -> Liquid | **Lossless** (Creative) | `S.AISlot` (Prompt) | **Creator** (ç”Ÿæˆéª¨æ¶) |
| **T2** | **Locking** | Liquid -> Liquid | **Validation** | `Schema Freeze` (Contract) | **Assistant** (Review/Refine) |
| **T3** | **Expansion** | Liquid -> Solid | **Deterministic** | `Compiler Config` (Build) | **None** (Strictly Forbidden) |
| **T4** | **Activation** | Solid -> Plasma | **Runtime** | `Logix Runtime` (Memory) | **None** |
| **T5** | **Reverse Eng** | Solid -> Liquid | **Lossy** | `AST Analysis` | **Repairman** (è¡¥å…¨ä¸¢å¤±çš„è¯­ä¹‰) |
| **T6** | **Extraction** | Plasma -> Liquid | **Lossy** | `Session Replay` | **Observer** (ä»äº¤äº’ä¸­æå–æ„å›¾) |
| **T7** | **Evolution** | Config -> Solid | **Deterministic** | `Design System Update` | **None** (Re-compile) |

## 3. Detailed Protocol Analysis

### T1: De-fuzzing (Requirement -> Intent)
*   **Artifact**: `S.AISlot`
*   **Protocol**: AI Slot Protocol
*   **AI Action**: "Contextual Filling". AI æ ¹æ®ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰å’Œçº¦æŸï¼ˆConstraintsï¼‰ï¼Œå°†è‡ªç„¶è¯­è¨€å¡«å……ä¸º TSX Skeletonã€‚
*   **Lossiness**: æ— æŸï¼ˆå› ä¸ºæ˜¯ä»æ— åˆ°æœ‰ï¼‰ã€‚

### T3: Expansion (Intent -> Code)
*   **Artifact**: `Build Bundle`
*   **Protocol**: Universal AI Toolchain (Build Pass)
*   **AI Action**: **Strictly Forbidden**. å¿…é¡»æ˜¯çº¯ç¡®å®šæ€§çš„è§„åˆ™æ˜ å°„ã€‚
*   **Lossiness**: æ— æŸã€‚

### T3.5: AI Flesh Pass (Optional Dev Tool)
*   **Artifact**: `Preview Code` / `Live Component`
*   **Context**: ä»…åœ¨å¼€å‘é˜¶æ®µ (Local/IDE) æˆ–è¿è¡Œæ—¶åŠ¨æ€é¢„è§ˆ (Runtime) è§¦å‘ã€‚
*   **AI Action**: å…è®¸ AI ä»‹å…¥ç”Ÿæˆ Fleshï¼Œä½†**ä¸è¿›å…¥ CI/CD æ„å»ºæµ**ã€‚

### T5: Reverse Engineering (Code -> Intent)
*   **Artifact**: `Refactored Skeleton`
*   **Protocol**: **"Semantic Repair Protocol"**
*   **The Problem**: ä» `<div class="p-4 bg-white">` è¿˜åŸå› `<S.Card>` æ˜¯æœ‰æŸçš„ã€‚
*   **AI Repair**:
    1.  **Analysis**: AI åˆ†æ DOM ç»“æ„å’Œç±»åã€‚
    2.  **Context**: AI è¯»å–å‘¨å›´çš„ä¸šåŠ¡ä»£ç ï¼ˆå˜é‡åã€æ³¨é‡Šï¼‰ã€‚
    3.  **Inference**: AI æ¨æ–­ "è¿™æ˜¯ä¸€ä¸ªç”¨æˆ·ä¿¡æ¯å¡ç‰‡"ã€‚
    4.  **Reconstruction**: ç”Ÿæˆ `<S.Card intent="user-info">`ã€‚
*   **Verdict**: **AI å¯ä»¥æŠ¹å¹³ 80% çš„æŸå¤±**ï¼Œä½†ä»éœ€äººå·¥ç¡®è®¤ã€‚

### T6: Extraction (Runtime -> Intent)
*   **Artifact**: `User Session Intent`
*   **Protocol**: **"Interaction Mining Protocol"** (Future)
*   **Scenario**: ç”¨æˆ·åœ¨ç•Œé¢ä¸Šæ“ä½œäº†ä¸€é€šï¼ˆPlasmaï¼‰ï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª "è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨ä¾‹" (Liquid)ã€‚
*   **AI Role**: è§‚å¯Ÿè€…ã€‚ä»ç‚¹å‡»æµä¸­æå–ä¸šåŠ¡æ„å›¾ã€‚

## 4. The "Silk Road" (ä¸æ»‘é“¾è·¯)

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰“é€ ä¸€æ¡ **"Silk Road"**ï¼š

*   **Forward (T1 -> T2 -> T3)**: å¿…é¡»æ˜¯ **100% ä¸æ»‘** çš„ã€‚è¿™æ˜¯æ—¥å¸¸å¼€å‘çš„ä¸»å¹²é“ã€‚
*   **Backward (T5)**: å…è®¸ **"Bumpy but Safe"** (é¢ ç°¸ä½†å®‰å…¨)ã€‚
    *   ä¸è¿½æ±‚è‡ªåŠ¨åŒæ­¥ã€‚
    *   å®šä¹‰ä¸º **"AI Migration Task"**ï¼šå¼€å‘è€…æ˜¾å¼è§¦å‘ "Refactor to Skeleton"ï¼ŒAI è¿›è¡Œæœ‰æŸä¿®å¤ï¼Œäººæ¥å…œåº•ã€‚

## 5. Summary

Logix ä¸ä»…ä»…æ˜¯ä¸€ä¸ª UI åº“ï¼Œå®ƒæ˜¯ä¸€ä¸ª **"State Transformation Engine"**ã€‚
æˆ‘ä»¬é€šè¿‡å®šä¹‰æ¸…æ™°çš„ **Artifacts (Vapor/Liquid/Solid)** å’Œ **Protocols (T1-T6)**ï¼Œè®© AI åœ¨åˆé€‚çš„åœ°æ–¹å‘æŒ¥åˆ›é€ åŠ›ï¼ˆT1ï¼‰ï¼Œåœ¨åˆé€‚çš„åœ°æ–¹è¿›è¡Œä¿®å¤ï¼ˆT5ï¼‰ï¼Œè€Œåœ¨å·¥ç¨‹åŒ–ç¯èŠ‚ï¼ˆT3ï¼‰ä¿æŒç»å¯¹çš„ä¸¥è°¨ã€‚
</file>

<file path="drafts/topics/ai-native-ui/01-philosophy-and-workflow.md">
---
title: Philosophy & Workflow
status: draft
version: 1.0
---

# Philosophy & Workflow: The "Intent-Driven" Way

> **Status**: Consolidated (Philosophy)
> **Context**: `v3/ai-native`
> **Previous**: `L6/value-proposition-and-workflow.md`, `L6/bidirectional-flow-analysis.md`

æœ¬æ–‡æ¡£é˜è¿° Logix AI-Native UI çš„æ ¸å¿ƒå“²å­¦ä¸å·¥ä½œæµã€‚

## 1. The "Compression" Philosophy

**"Skeleton å°±æ˜¯å¯¹ UI ä¿¡æ¯çš„æè‡´å‹ç¼©ã€‚"**

*   **Compression (å‹ç¼©)**: åœ¨æºç  (`src`) ä¸­ï¼Œæˆ‘ä»¬åªä¿ç•™æœ€æ ¸å¿ƒçš„ä¸šåŠ¡æ„å›¾ã€‚
    *   `<S.Input>` = "è¿™é‡Œéœ€è¦ç”¨æˆ·è¾“å…¥" (100% Signal, 0% Noise)
*   **Decompression (è§£å‹)**: åœ¨æ„å»º/è¿è¡Œæ—¶ï¼ŒCompiler å°†å…¶å±•å¼€ä¸ºå¤æ‚çš„å®ç°ç»†èŠ‚ã€‚
    *   `<AntdInput className="w-full border-gray-300..." />` (10% Signal, 90% Noise)

### 1.1 The "No-Eject" Guarantee
ä¼ ç»Ÿè„šæ‰‹æ¶ (CRA) çš„ "Eject" æ˜¯ä¸å¯é€†çš„ç†µå¢ã€‚Logix çš„ç›®æ ‡æ˜¯ **"Zero Eject"**ï¼š
*   åªè¦ä¸šåŠ¡æ„å›¾ä¸å˜ï¼Œä½ å°±æ°¸è¿œä¸éœ€è¦ç¦»å¼€ Skeleton å±‚ã€‚
*   å¦‚æœéœ€è¦å®šåˆ¶ UI ç»†èŠ‚ï¼Œé€šè¿‡ **Theme Config** æˆ– **Custom Flesh Component** æ¥è§£å†³ã€‚

## 2. The Grand Flow: Fuzzy to Precise

æˆ‘ä»¬å°†æ•´ä¸ªè½¯ä»¶å·¥ç¨‹çœ‹ä½œä¸€ä¸ª **"ä»æ¨¡ç³Šåˆ°ç²¾ç¡®ï¼Œä»å‹ç¼©åˆ°è§£å‹"** çš„æµï¼š

| Stage | State | Nature | Action |
| :--- | :--- | :--- | :--- |
| **1. Requirement** | **Fuzzy** (Natural Language) | High Entropy | **AI Analysis** (De-fuzzing) |
| **2. Intent** | **Compressed** (Skeleton / Schema) | **High Signal / Low Noise** | **Human Review** (Locking) |
| **3. Code** | **Decompressed** (Flesh / Soul) | Low Signal / High Noise | **Compiler/Runtime** (Expansion) |

**Logix çš„æ ¸å¿ƒä½¿å‘½ï¼Œå°±æ˜¯å®ˆä½ "Intent" è¿™ä¸€å±‚ï¼Œä¸è®©å®ƒè¿‡æ—©åœ°åç¼©ä¸º "Code"ã€‚**

## 3. Bidirectional Flow Analysis

æˆ‘ä»¬èƒ½å¦ä»ä¸‹æ¸¸ï¼ˆCode/Fleshï¼‰åå‘æ¨å¯¼å›ä¸Šæ¸¸ï¼ˆIntent/Skeletonï¼‰ï¼Ÿ

### 3.1 The Three Layers of Reversibility

| Layer Transition | Direction | Nature | Feasibility |
| :--- | :--- | :--- | :--- |
| **Requirement <-> Intent** | Fuzzy <-> Compressed | Semantic | **High (AI)** |
| **Intent <-> Code (Build)** | Compressed <-> Decompressed | Deterministic | **High (Rule)** |
| **Code -> Intent** | Decompressed -> Compressed | **Lossy** | **Low (Reverse Eng)** |

### 3.2 The "Zero Eject" Strategy

ä¸ºäº†ä¿æŒæ¶æ„çš„çº¯æ´æ€§ï¼Œæˆ‘ä»¬**ä¸è¿½æ±‚å®Œå…¨çš„ Code -> Intent è‡ªåŠ¨åŒ–åŒæ­¥**ã€‚
ç›¸åï¼Œæˆ‘ä»¬æä¾› **"Escape Hatches" (é€ƒç”Ÿèˆ±)** æ¥å¤„ç† Skeleton æ— æ³•è¦†ç›–çš„åœºæ™¯ï¼Œè€Œä¸æ˜¯é¼“åŠ± Ejectã€‚

#### Escape Hatch 1: `S.Raw`
å…è®¸åœ¨ Skeleton ä¸­åµŒå…¥åŸç”Ÿä»£ç ã€‚
```tsx
<S.Container>
  <S.Input bind="model:name" />
  <S.Raw>
    <div className="my-hacky-div">...</div>
  </S.Raw>
</S.Container>
```

#### Escape Hatch 2: Custom Primitives
å…è®¸å¼€å‘è€…æ‰©å±• `S` å‘½åç©ºé—´ã€‚
```tsx
<S.Custom component={MyComplexWidget} ... />
```

## 4. The Developer Workflow

### Phase 1: Prototyping (AI å”±ä¸»è§’)
1.  **Prompt**: "å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªç”¨æˆ·è¯¦æƒ…é¡µ..."
2.  **AI Action**: ç”Ÿæˆ Skeleton + Draft Schema + Flesh Previewã€‚
3.  **Dev Action**: ç¡®è®¤ä¸šåŠ¡å­—æ®µå’Œäº¤äº’æµç¨‹ã€‚

### Phase 2: Refinement (Human é”å®šä¹‰)
1.  **Dev Action**: æ‰‹åŠ¨è°ƒæ•´ **Skeleton ä»£ç ** (TSX)ã€‚
2.  **AI Action**: å®æ—¶é‡æ–°ç¼–è¯‘ Fleshã€‚

### Phase 3: Implementation (Runtime æ³¨å…¥çµé­‚)
1.  **Dev Action**: åœ¨ Logic å±‚å®šä¹‰ `UserDraft`ï¼Œç»‘å®š APIã€‚
2.  **Dev Action**: åœ¨ Skeleton ä¸Šç»‘å®š `bind="model:user"`ã€‚
3.  **Result**: é¡µé¢ç¬é—´å…·å¤‡äº†åŠ è½½ã€æ ¡éªŒã€æäº¤èƒ½åŠ›ã€‚

### Phase 4: Evolution (Design System å‡çº§)
1.  **Scenario**: ä» AntD è¿ç§»åˆ° MUIã€‚
2.  **Action**: æ›´æ–° Logix Compiler é…ç½®ã€‚
3.  **Result**: **Skeleton ä»£ç é›¶ä¿®æ”¹**ï¼Œå…¨ç«™ UI è‡ªåŠ¨ç„•ç„¶ä¸€æ–°ã€‚
</file>

<file path="drafts/topics/ai-native-ui/10-skeleton-protocol.md">
---
title: Skeleton Protocol & Integration
status: draft
version: 1.0
---

# Skeleton Protocol: The "S" Namespace

> **Status**: Consolidated (Protocol & Integration)
> **Context**: `v3/ai-native`
> **Previous**: `L5/ui-intent-skeleton-protocol.md`, `L5/logix-ui-integration.md`

æœ¬æ–‡æ¡£å®šä¹‰ **Skeleton-First Protocol** åŠ **`S` å‘½åç©ºé—´**ã€‚

## 1. The Philosophy: Skeleton vs Flesh vs Soul

ä¸€ä¸ªå®Œæ•´çš„ UI ç»„ä»¶ç”±ä¸‰ä¸ªå±‚æ¬¡æ„æˆï¼š

| Layer | Metaphor | Responsibility | Owner | Example |
| :--- | :--- | :--- | :--- | :--- |
| **L0: Skeleton** | **éª¨æ¶** | **Abstract Intent**: ç»“æ„ã€è¯­ä¹‰ã€æ’æ§½ | **Human / Logic** | `<S.Input bind="user.name" />` |
| **L1: Flesh** | **è¡€è‚‰** | **Concrete Implementation**: æ ·å¼ã€ç»„ä»¶åº“ | **AI / Designer** | `<AntdInput />` |
| **L2: Soul** | **çµé­‚** | **Runtime Behavior**: çŠ¶æ€ã€æ ¡éªŒã€äº¤äº’ | **Runtime** | `useModule(UserModule)` |

**æ ¸å¿ƒåŸåˆ™**:
*   **Code is Truth**: UI Intent æ˜¯ **TSX ä»£ç **ã€‚
*   **Type Safety**: ä½¿ç”¨ TypeScript æ¥å£å®šä¹‰ Skeleton ç»„ä»¶çš„ Propsã€‚
*   **Runtime Injection**: è¿è¡Œæ—¶é€šè¿‡ `Context` å°† `<S.Input>` æ›¿æ¢ä¸ºå…·ä½“çš„ `<AntdInput>`ã€‚

## 2. The `S` Namespace Definition

`S` æ˜¯ **Logix UI Runtime** æä¾›çš„ä¸€å¥— **Abstract Component Primitives**ã€‚

### 2.1 Import Path
```typescript
import { S } from '@logix/ui';
```

### 2.2 The Primitives (Core Set)
`S` çš„è®¾è®¡åŸåˆ™æ˜¯ **"Semantic over Visual"**ã€‚

*   **`S.Container`**: å¸ƒå±€ä¸åˆ†ç»„æ„å›¾ (Card, Modal, Section, Row, Col)ã€‚
*   **`S.Input`**: æ•°æ®å½•å…¥æ„å›¾ (Text, Number, Date, Select)ã€‚
*   **`S.Action`**: äº¤äº’è§¦å‘æ„å›¾ (Button, Link, IconClick)ã€‚
*   **`S.Display`**: æ•°æ®å±•ç¤ºæ„å›¾ (Text, Tag, Image, List)ã€‚
*   **`S.Slot`**: åŠ¨æ€æ’æ§½æ„å›¾ã€‚
*   **`S.AISlot`**: AI ç”Ÿæˆæ’æ§½ (è¯¦è§ `11-ai-slot-protocol.md`)ã€‚

## 3. Integration with Logix (The `bind` Protocol)

`S` ç»„ä»¶é€šè¿‡ `bind` å±æ€§ä¸ Logix çš„ Logic/State å±‚è¿æ¥ã€‚

### 3.1 Binding Syntax
*   **`model:path`**: ç»‘å®šåˆ°å½“å‰ä¸Šä¸‹æ–‡çš„æ•°æ®æ¨¡å‹ (Draft or Store)ã€‚
*   **`action:name`**: ç»‘å®šåˆ°å½“å‰ä¸Šä¸‹æ–‡çš„ Actionã€‚
*   **`signal:name`**: ç»‘å®šåˆ°å…¨å±€ Signalã€‚

### 3.2 Usage Example

```tsx
import { S } from '@logix/ui';
import { UserDraft } from './logic/user-draft';

export const UserEditor = () => {
  // 1. Runtime Injection (Soul)
  const { model, actions } = useDraft(UserDraft);

  // 2. Skeleton Definition (Body)
  return (
    <Logix.Provider model={model} actions={actions}>
      <S.Container intent="form">
        {/* Auto-binds to model.username */}
        <S.Input label="Username" bind="model:username" />

        {/* Auto-binds to actions.submit */}
        <S.Action intent="primary" bind="action:submit">Save</S.Action>
      </S.Container>
    </Logix.Provider>
  );
};
```

## 4. Component Intent (The Contract)

æ¯ä¸ª Skeleton Node éœ€è¦ä¸€ä¸ª **Component Intent** å®šä¹‰ï¼Œä»¥ä¾¿ AI çŸ¥é“å¦‚ä½•å¡«å……è¡€è‚‰ã€‚

```typescript
interface InputIntent {
  capabilities: ['text', 'number', 'password'];
  mappings: {
    value: string;
    onChange: (val: any) => void;
    disabled: boolean;
  };
  description: "ç”¨äºæ”¶é›†ç”¨æˆ·è¾“å…¥çš„åŸå­ç»„ä»¶";
}
```

## 5. Runtime Implementation

`S` ç»„ä»¶æœ¬è´¨ä¸Šæ˜¯ **Context Consumers**ã€‚

```tsx
const Input = (props: SkeletonProps) => {
  const runtime = useLogixRuntime();
  const theme = useLogixTheme();

  // 1. Resolve Data Binding
  const value = runtime.resolveValue(props.bind);
  const onChange = runtime.resolveUpdater(props.bind);

  // 2. Resolve Concrete Component (Flesh)
  const ConcreteComponent = theme.components.Input;

  // 3. Render
  return <ConcreteComponent value={value} onChange={onChange} {...props} />;
};
```
</file>

<file path="drafts/topics/ai-native-ui/11-ai-slot-protocol.md">
---
title: AI Slot Protocol (S.AISlot)
status: draft
version: 1.0
---

# AI Slot Protocol: The "Prompt-in-Code"

> **Status**: Consolidated (Protocol)
> **Context**: `v3/ai-native`
> **Previous**: `L5/ai-slot-protocol.md`

æœ¬æ–‡æ¡£å®šä¹‰ **`S.AISlot`** åè®®ã€‚è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Skeleton èŠ‚ç‚¹ï¼Œç”¨äºåœ¨ä»£ç ä¸­æ˜¾å¼å£°æ˜â€œæ­¤å¤„åº”ç”± AI å¡«å……â€ã€‚

## 1. The `S.AISlot` Definition

`S.AISlot` æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **Structured Prompt**ã€‚å®ƒä¸æ¸²æŸ“ä»»ä½•å…·ä½“ UIï¼Œè€Œæ˜¯æºå¸¦å…ƒæ•°æ®ï¼Œç­‰å¾…è¢«â€œæ¶ˆè´¹â€å¹¶æ›¿æ¢ä¸ºçœŸå®ä»£ç ã€‚

### 1.1 Signature

```typescript
namespace S {
  export const AISlot: React.FC<{
    /**
     * æ„å›¾æè¿°ï¼šå‘Šè¯‰ AI è¿™é‡Œåº”è¯¥æ”¾ä»€ä¹ˆ
     * @example "ä¸€ä¸ªç”¨äºå±•ç¤ºç”¨æˆ·å¤´åƒå’Œæ˜µç§°çš„å¡ç‰‡"
     */
    intent: string;

    /**
     * ä¸Šä¸‹æ–‡æ•°æ®ï¼šæä¾›ç»™ AI çš„è¾“å…¥å˜é‡
     * @example { user: model.user }
     */
    context?: Record<string, any>;

    /**
     * çº¦æŸæ¡ä»¶ï¼šé™åˆ¶ AI ç”Ÿæˆçš„è¾¹ç•Œ
     * @example "å¿…é¡»ä½¿ç”¨ AntD ç»„ä»¶ï¼Œé«˜åº¦ä¸è¶…è¿‡ 100px"
     */
    constraints?: string[];

    /**
     * æœŸæœ›è¾“å‡ºç±»å‹ï¼š
     * - "ui": é™æ€ UI ä»£ç  (Flesh)
     * - "live-component": åŒ…å«çŠ¶æ€ä¸é€»è¾‘çš„å®Œæ•´ç»„ä»¶ (Triad)
     * - "logic": çº¯é€»è¾‘ä»£ç 
     */
    output?: 'ui' | 'live-component' | 'logic' | 'text';
  }>;
}
```

### 1.2 Usage Example

```tsx
export const UserProfile = () => (
  <S.Container>
    <S.Header title="Profile" />

    {/* æ˜¾å¼ç•™ç™½ï¼Œç­‰å¾… AI å¡«å…… */}
    <S.AISlot
      intent="å±•ç¤ºç”¨æˆ·è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…å«å¤´åƒã€ç§¯åˆ†å’Œæœ€è¿‘åŠ¨æ€"
      context={{ user: model.user, activities: model.recentActivities }}
      constraints={['ä½¿ç”¨å¡ç‰‡å¸ƒå±€', 'å¤´åƒåœ†å½¢æ˜¾ç¤º']}
    />

    <S.Action intent="logout">Logout</S.Action>
  </S.Container>
);
```

## 2. Consumption Models

`S.AISlot` æ˜¯ä¸€æ®µâ€œä¼‘çœ â€çš„ä»£ç ï¼Œå®ƒæœ‰ä¸¤ç§â€œå”¤é†’â€æ–¹å¼ï¼š

### 2.1 Mode A: Local Dev (Copilot Expansion)

å¼€å‘è€…åœ¨ IDE ä¸­ç¼–å†™ä»£ç æ—¶ä½¿ç”¨ã€‚

*   **Trigger**: å¼€å‘è€…å†™ä¸‹ `<S.AISlot ... />`ï¼Œç„¶åè§¦å‘ IDE æ’ä»¶ï¼ˆæˆ– Cursor/Copilotï¼‰ã€‚
*   **Process**:
    1.  IDE è¯»å– `intent`, `context`, `constraints`ã€‚
    2.  IDE æŠ“å–å½“å‰æ–‡ä»¶ä¸Šä¸‹æ–‡ + Design System æ–‡æ¡£ã€‚
    3.  LLM ç”Ÿæˆå…·ä½“çš„ React ä»£ç ã€‚
*   **Result**: `<S.AISlot>` è¢«**æ°¸ä¹…æ›¿æ¢**ä¸ºç”Ÿæˆçš„ä»£ç ï¼ˆFleshï¼‰ã€‚
    ```diff
    - <S.AISlot intent="å±•ç¤ºç”¨æˆ·..." />
    + <div className="user-card">
    +   <Avatar src={user.avatar} />
    +   ...
    + </div>
    ```

### 2.2 Mode B: Platform Runtime (Just-in-Time Generation)

åœ¨ä½ä»£ç å¹³å°æˆ–åŠ¨æ€è¿è¡Œç¯å¢ƒä¸­ï¼Œ`S.AISlot` ä¿ç•™åœ¨ä»£ç ä¸­ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€è§£æã€‚

*   **Trigger**: é¡µé¢åŠ è½½æˆ–ç»„ä»¶æ¸²æŸ“æ—¶ã€‚
*   **Process**:
    1.  **Runtime Engine** é‡åˆ° `S.AISlot`ã€‚
    2.  è°ƒç”¨åç«¯ **LLM Service** (Logix AI Gateway)ã€‚
    3.  LLM å®æ—¶ç”Ÿæˆ UI ç»“æ„ (JSON or Component)ã€‚
    4.  Runtime åŠ¨æ€æŒ‚è½½ç”Ÿæˆçš„ç»„ä»¶ã€‚
*   **Value**: å®ç° **"åƒäººåƒé¢"** æˆ– **"åŠ¨æ€ç”Ÿæˆçš„ UI"**ã€‚

## 3. Advanced: The "LLM Tool" Wrapper

æˆ‘ä»¬å¯ä»¥å°† `S.AISlot` åŒ…è£…ä¸º LLM å¯è°ƒç”¨çš„ Toolã€‚

### 3.1 Scenario
å½“æˆ‘ä»¬åœ¨ä¸€ä¸ª Chat Interface ä¸­ï¼Œç”¨æˆ·é—®ï¼šâ€œå¸®æˆ‘åˆ†æä¸€ä¸‹è¿™ä¸ªç”¨æˆ·çš„æ¶ˆè´¹ä¹ æƒ¯ã€‚â€

### 3.2 Implementation
ç³»ç»Ÿä¸ä»…è¿”å›æ–‡æœ¬åˆ†æï¼Œè¿˜è¿”å›ä¸€ä¸ªåŒ…å« `S.AISlot` çš„ UI æè¿°ï¼š

```json
{
  "message": "æ ¹æ®åˆ†æï¼Œè¯¥ç”¨æˆ·åå¥½...",
  "ui_attachment": {
    "type": "S.AISlot",
    "props": {
      "intent": "ç”Ÿæˆä¸€ä¸ªæ¶ˆè´¹è¶‹åŠ¿å›¾è¡¨ï¼Œæ”¯æŒæŒ‰æœˆåˆ‡æ¢",
      "context": { "data": [...] },
      "output": "live-component" // è¯·æ±‚ç”Ÿæˆ Live Component Triad
    }
  }
}
```

å‰ç«¯ Runtime æ¥æ”¶åˆ°è¿™ä¸ª Tool Outputï¼Œè‡ªåŠ¨è°ƒç”¨ Mode B æµç¨‹ï¼Œç”Ÿæˆå¹¶æŒ‚è½½ä¸€ä¸ª **Live Component** (UI + Draft State + Logic)ï¼Œä»è€Œåœ¨å¯¹è¯æ¡†ä¸­æ¸²æŸ“å‡ºä¸€ä¸ªåŠ¨æ€ç”Ÿæˆçš„ã€å¯äº¤äº’çš„å›¾è¡¨ã€‚

**ç»“è®º**:
`S.AISlot` æ˜¯è¿æ¥ **Static Code** ä¸ **Generative AI** çš„è™«æ´ã€‚
*   åœ¨å¼€å‘æ—¶ï¼Œå®ƒæ˜¯ **Prompt Template**ã€‚
*   åœ¨è¿è¡Œæ—¶ï¼Œå®ƒæ˜¯ **Dynamic UI Placeholder**ã€‚
</file>

<file path="drafts/topics/ai-native-ui/20-live-component-runtime.md">
---
title: Live Component Triad (UI + Data + Behavior)
status: draft
version: 1.0
---

# Live Component Triad: The "Soul" of AI-Generated UI

> **Status**: Consolidated (Runtime Implementation)
> **Context**: `v3/ai-native`
> **Previous**: `L5/live-component-triad.md`

æœ¬æ–‡æ¡£è¯¦ç»†é˜è¿° **Live Component Triad (æ´»ä½“ç»„ä»¶ä¸‰å…ƒç»„)** æ¨¡å¼ã€‚
å®ƒæ˜¯ `S.AISlot` åœ¨ **output="live-component"** æ¨¡å¼ä¸‹çš„å…·ä½“å®ç°è½½ä½“ã€‚

## 1. The Concept

å½“ `S.AISlot` éœ€è¦å¡«å……çš„ä¸ä»…ä»…æ˜¯é™æ€ UIï¼Œè€Œæ˜¯åŒ…å«å¤æ‚äº¤äº’é€»è¾‘çš„å®Œæ•´åŠŸèƒ½æ¨¡å—æ—¶ï¼ŒAI ä¼šç”Ÿæˆä¸€ä¸ª **Live Component**ã€‚

å®ƒç”±ä¸‰ä¸ªç»´åº¦çš„ Intent å…±åŒæ”¯æ’‘ï¼š

```mermaid
graph TD
    Slot[S.AISlot] -->|Expands To| Triad

    subgraph Live Component
        UI[UI Intent (Skeleton)] -->|Body| Triad
        Data[Data Intent (Schema)] -->|Memory| Triad
        Behavior[Behavior Intent (Logic)] -->|Reflex| Triad
    end

    Triad -->|Runtime Injection| Runtime[Draft Runtime]
```

### 1.1 UI Intent (The Body) -> `S` Code
*   **Definition**: ä½¿ç”¨ `S` å‘½åç©ºé—´æè¿°çš„éª¨æ¶ä»£ç ã€‚
*   **Format**: TSX (Code-First).
*   **Example**:
    ```tsx
    (props) => (
      <S.Container>
        <S.Input bind="model:username" />
      </S.Container>
    )
    ```

### 1.2 Data Intent (The Memory)
*   **Definition**: ç»„ä»¶è¿è¡Œæ‰€éœ€çš„ä¸´æ—¶çŠ¶æ€æ¨¡å‹ã€‚
*   **Mapping**: ç›´æ¥æ˜ å°„ä¸º **Draft Schema**ã€‚
*   **Example**:
    ```json
    {
      "step": "number",
      "formData": {
        "username": "string",
        "agreed": "boolean"
      }
    }
    ```

### 1.3 Behavior Intent (The Reflex)
*   **Definition**: ç»„ä»¶çš„äº¤äº’é€»è¾‘ä¸çŠ¶æ€æµè½¬è§„åˆ™ã€‚
*   **Mapping**: ç›´æ¥æ˜ å°„ä¸º **Draft Logic**ã€‚
*   **Example**:
    ```json
    {
      "onNext": "if (step < 3) step++",
      "onSubmit": "validate(formData) && commit()"
    }
    ```

## 2. Runtime Implementation

åœ¨è¿è¡Œæ—¶ï¼Œå¹³å°é€šè¿‡ **Runtime Injection** æŠ€æœ¯ï¼Œå°†è¿™ä¸‰è€…ç¼åˆä¸ºä¸€ä¸ª React ç»„ä»¶ã€‚

### 2.1 The `LiveComponent` Host

```tsx
// ä¼ªä»£ç ï¼šå¹³å°æä¾›çš„é€šç”¨å®¿ä¸»ç»„ä»¶
const LiveComponent = ({ intent }) => {
  // 1. åŠ¨æ€æ„é€  Draft
  const draftDef = useMemo(() => createDraftFromIntent(intent.data, intent.behavior), [intent]);

  // 2. å¯åŠ¨ Draft Runtime
  const { state, actions } = useDraft(draftDef);

  // 3. æ¸²æŸ“ UI (Skeleton -> Flesh) å¹¶æ³¨å…¥ Soul
  const Skeleton = compileSkeleton(intent.ui); // Compile TSX string to Component

  return (
    <Logix.Provider model={state} actions={actions}>
      <Skeleton />
    </Logix.Provider>
  );
};
```

### 2.2 AI Workflow

1.  **User Prompt**: "å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªè¯·å‡ç”³è¯·å•ï¼Œéœ€è¦å¡«å§“åã€æ—¶é—´ï¼Œæäº¤æ—¶æ ¡éªŒæ—¶é—´ä¸èƒ½åœ¨è¿‡å»ã€‚"
2.  **AI Generation**: ç”ŸæˆåŒ…å« `ui`, `data`, `behavior` çš„å®Œæ•´ JSONã€‚
3.  **Preview**: å¹³å°å‰ç«¯ç›´æ¥å°† JSON å–‚ç»™ `LiveComponent`ï¼Œç”¨æˆ·ç«‹å³å¯ä»¥æ“ä½œï¼ˆå¡«å†™ã€æ ¡éªŒã€æäº¤ï¼‰ã€‚
4.  **Refine**: ç”¨æˆ·è¯´â€œåŠ ä¸€ä¸ªå¤‡æ³¨å­—æ®µâ€ï¼ŒAI æ›´æ–° `ui` å’Œ `data` éƒ¨åˆ†ï¼Œç•Œé¢å®æ—¶åˆ·æ–°ä¸”çŠ¶æ€ä¿ç•™ï¼ˆå¦‚æœæ”¯æŒ HMRï¼‰ã€‚

## 3. Why This Matters?

*   **Zero Boilerplate**: ç”¨æˆ·ï¼ˆå’Œ AIï¼‰ä¸éœ€è¦å†™ `Draft.make`, `useDraft`, `type Schema` ç­‰æ ·æ¿ä»£ç ã€‚
*   **Atomic Delivery**: AI äº¤ä»˜çš„æ˜¯ä¸€ä¸ªâ€œæ´»ç‰©â€ï¼Œè€Œä¸æ˜¯ä¸€å †éœ€è¦å¼€å‘è€…æ‰‹åŠ¨ç»„è£…çš„é›¶ä»¶ã€‚
*   **Sandboxed**: æ¯ä¸ª Live Component éƒ½æœ‰ç‹¬ç«‹çš„ Draft Scopeï¼Œäº’ä¸å¹²æ‰°ï¼Œéå¸¸é€‚åˆ AI è¯•é”™ä¸é¢„è§ˆã€‚

**ç»“è®º**: Live Component Triad æ˜¯ Draft Pattern åœ¨ AI Native æ—¶ä»£çš„**ç»ˆæå½¢æ€**ã€‚
</file>

<file path="drafts/topics/ai-native-ui/30-compilation-toolchain.md">
---
title: Universal AI Compilation Toolchain
status: draft
version: 1.0
---

# Universal AI Compilation Toolchain: The "Fleshing" Engine

> **Status**: Consolidated (Toolchain Architecture)
> **Context**: `v3/ai-native`
> **Previous**: `L6/ai-compilation-toolchain.md`

æœ¬æ–‡æ¡£å®šä¹‰ **Logix AI Toolchain**ã€‚è¿™æ˜¯ä¸€ä¸ªç¯å¢ƒæ— å…³çš„ï¼ˆUniversalï¼‰ç¼–è¯‘å™¨æ¶æ„ï¼Œè´Ÿè´£è§£æä»£ç ä¸­çš„ `S.AISlot` å¹¶å°†å…¶â€œè¡€è‚‰åŒ–â€ (Fleshing)ã€‚

## 1. The Core Philosophy: "Deconstruct, Reconstruct, Combine"

æˆ‘ä»¬çš„æ ¸å¿ƒæµç¨‹ä¸æ˜¯ç®€å•çš„â€œç”Ÿæˆä»£ç â€ï¼Œè€Œæ˜¯ï¼š
1.  **Deconstruct (è§£æ„)**: è§£ææºç ï¼Œæå– `S.AISlot` åŠå…¶ä¸Šä¸‹æ–‡ (Context)ã€‚
2.  **Reconstruct (é‡æ„)**: å°† Slot è½¬æ¢ä¸º LLM Promptï¼Œè°ƒç”¨ AI ç”Ÿæˆå®ç°ã€‚
3.  **Combine (ç»„åˆ)**: å°†ç”Ÿæˆçš„ä»£ç  (Flesh/Soul) å›å¡«åˆ°æºç æˆ–è¿è¡Œæ—¶ä¸­ã€‚

## 2. Architecture: The "Two-Pass" Compiler

è¿™ä¸ª Compiler åŒ…å«ä¸¤ä¸ªç‹¬ç«‹çš„ Passï¼Œåˆ†åˆ«å¯¹åº”å¼€å‘æœŸå’Œæ„å»ºæœŸï¼š

```mermaid
graph TD
    Source[Source Code / Intent] --> Parser

    subgraph Universal Compiler
        Parser[AST Parser] -->|Extract Slots| Analyzer
        Analyzer[Context Analyzer] -->|Build Prompt| LLM[Logix AI Gateway]
        LLM -->|Generate Code| Patcher
    end

    Patcher[Code Patcher] -->|Dev Mode| FileSystem[Local File System]
    Patcher -->|Runtime Mode| VirtualFS[Virtual Runtime FS]

    subgraph Build Pass [Deterministic Build Pass]
        Config[Theme Config] -->|Map| Mapper[Rule Mapper]
        Mapper -->|Expand| Bundle[Production Bundle]
    end
```

### 2.1 The Modules

1.  **Parser (AST-based)**:
    *   åŸºäº `ts-morph` æˆ– `babel`ã€‚
    *   ä»»åŠ¡ï¼šè¯†åˆ« `<S.AISlot>` èŠ‚ç‚¹ï¼Œæå– `intent`, `context`, `constraints` å±æ€§å€¼ã€‚

2.  **Analyzer (Context Awareness)**:
    *   ä»»åŠ¡ï¼šæ”¶é›† Slot å‘¨å›´çš„ä¸Šä¸‹æ–‡ã€‚
    *   *Scope*: å½“å‰æ–‡ä»¶ Importsã€å®šä¹‰çš„å˜é‡ã€Logix Store å®šä¹‰ã€‚
    *   *RAG*: æ£€ç´¢é¡¹ç›®ä¸­çš„ Design System æ–‡æ¡£ã€ç±»ä¼¼ç»„ä»¶ã€‚

3.  **Patcher (The "Combiner")**:
    *   **Static Mode (CLI/IDE)**: ä½¿ç”¨ AST å˜æ¢ï¼Œå°† `<S.AISlot>` æ›¿æ¢ä¸ºç”Ÿæˆçš„ JSX ä»£ç ã€‚
    *   **Runtime Mode (Browser/Server)**: è¿”å›ä¸€ä¸ª `React.lazy` æˆ– `DynamicComponent` å®šä¹‰ã€‚

## 3. Consumption Scenarios

### 3.1 Scenario A: Local CLI / IDE (Build-Time Fleshing)
*   **User**: å¼€å‘è€…åœ¨ VSCode ä¸­å†™äº† Slotã€‚
*   **Tool**: `logix flesh src/components/UserCard.tsx`
*   **Result**: æºç è¢«æ°¸ä¹…æ›´æ–°ã€‚

### 3.2 Scenario B: Platform Backend (Server-Side Fleshing)
*   **User**: ä¸šåŠ¡äººå‘˜åœ¨ä½ä»£ç å¹³å°æ‹–æ‹½äº†ä¸€ä¸ª "AI Slot"ã€‚
*   **Tool**: Logix Server (Node.js Environment).
*   **Result**: ç”Ÿæˆä¸´æ—¶çš„ã€å¯æ‰§è¡Œçš„é¡µé¢ä»£ç ã€‚

### 3.3 Scenario C: Browser Runtime (Just-in-Time Fleshing)
*   **User**: æœ€ç»ˆç”¨æˆ·åœ¨ App ä¸­ç‚¹å‡»â€œç”ŸæˆæŠ¥è¡¨â€ã€‚
*   **Tool**: Logix Runtime (Browser Environment).
*   **Result**: ä¸´æ—¶çš„ã€å†…å­˜ä¸­çš„ç»„ä»¶å®ä¾‹ã€‚

## 4. The "LLM Tool" Integration

ä¸ºäº†æ”¯æŒé«˜çº§ Agent èƒ½åŠ›ï¼Œæˆ‘ä»¬å°† Compiler å°è£…ä¸ºä¸€ä¸ª **Standard Tool**ï¼š

```typescript
interface FleshToolInput {
  intent: string;
  context: Record<string, any>;
  outputType: 'ui' | 'live-component';
}

// Agent è°ƒç”¨ç¤ºä¾‹
await tools.logix.flesh({
  intent: "ä¸€ä¸ªå¸¦æœç´¢åŠŸèƒ½çš„è¡¨æ ¼",
  context: { columns: ["id", "name"] },
  outputType: "live-component"
});
```

**ç»“è®º**:
Logix AI Toolchain æ˜¯ä¸€ä¸ª**è¿æ¥å™¨**ã€‚å®ƒè®© "AI ç”Ÿæˆ" ä¸å†æ˜¯ä¸€ä¸ªé»‘ç›’é­”æ³•ï¼Œè€Œæ˜¯ä¸€ä¸ª**å¯æ§çš„ã€æ ‡å‡†åŒ–çš„ç¼–è¯‘è¿‡ç¨‹**ã€‚
</file>

<file path="drafts/topics/ai-native-ui/40-storage-strategy.md">
---
title: Skeleton Storage Strategy
status: draft
version: 1.0
---

# Skeleton Storage Strategy: Source vs Artifact

> **Status**: Consolidated (Storage Spec)
> **Context**: `v3/ai-native`
> **Previous**: `L6/skeleton-storage-strategy.md`

æœ¬æ–‡æ¡£å›ç­”ï¼š**Skeleton ä»£ç åˆ°åº•å­˜åœ¨å“ªé‡Œï¼Ÿ**

## 1. The Core Decision: Skeleton IS Source Code

æˆ‘ä»¬æ˜ç¡®åŒºåˆ† **Source Code (æºç )** å’Œ **Build Artifact (äº§ç‰©)**ã€‚

| Layer | Storage Location | Format | Persistence |
| :--- | :--- | :--- | :--- |
| **Skeleton** | `src/**/*.tsx` | **TSX** (Abstract) | **Persistent (Git)** |
| **Flesh** | `.logix/cache/**` or Memory | **JS/CSS** (Concrete) | **Ephemeral (Build/Runtime)** |
| **Soul** | `src/logic/**/*.ts` | **TS** (Logic) | **Persistent (Git)** |

**ç»“è®º**: å¼€å‘è€…åœ¨ IDE é‡Œçœ‹åˆ°ã€ç¼–è¾‘ã€æäº¤åˆ° Git çš„ï¼Œæ°¸è¿œæ˜¯ **Skeleton ä»£ç **ã€‚

## 2. Why Not Store Flesh?

1.  **Noise**: å…·ä½“çš„ UI å®ç°åŒ…å«å¤§é‡å™ªéŸ³ï¼ˆç±»åã€å¸ƒå±€åµŒå¥—ï¼‰ï¼Œæ©ç›–äº†ä¸šåŠ¡æ„å›¾ã€‚
2.  **Lock-in**: ä¸€æ—¦å­˜ä¸ºå…·ä½“çš„ AntD ä»£ç ï¼Œå°±å¾ˆéš¾è¿ç§»åˆ° MUI äº†ã€‚
3.  **Drift**: å¦‚æœå…è®¸å¼€å‘è€…ç›´æ¥ä¿®æ”¹ Fleshï¼Œé‚£ä¹ˆ Skeleton å’Œ Flesh å°±ä¼šä¸åŒæ­¥ï¼Œå¯¼è‡´â€œæ„å›¾æ¼‚ç§»â€ã€‚

## 3. The Compilation Process

Logix Compiler (Webpack/Vite Plugin) è´Ÿè´£åœ¨æ„å»ºæ—¶å°† Skeleton è½¬æ¢ä¸º Fleshã€‚

### 3.1 Input (Source)
```tsx
// src/pages/User.tsx
export default () => (
  <S.Container>
    <S.Input bind="model:name" />
  </S.Container>
);
```

### 3.2 Transformation (Deterministic & Rule-Based)
**Critical**: è¿™ä¸ªè¿‡ç¨‹æ˜¯**ç»å¯¹ç¡®å®šæ€§**çš„ï¼Œ**å®Œå…¨ä¸ä¾èµ– AI**ã€‚
Compiler è¯»å–é¡¹ç›®é…ç½® (Design System Config)ï¼ŒåŸºäºé¢„å®šä¹‰çš„æ˜ å°„è§„åˆ™ï¼Œå°† `<S.Input>` æ›¿æ¢ä¸º `<AntdInput>`ã€‚

### 3.3 Output (Bundle)
```js
// dist/assets/index.js
createElement(AntdInput, { value: model.name, ... });
```

## 4. The AI Boundary

æˆ‘ä»¬å¿…é¡»ä¸¥æ ¼åˆ’æ¸… **AI Generation** ä¸ **Engineering Compilation** çš„ç•Œé™ã€‚

| Stage | Action | Actor | Determinism |
| :--- | :--- | :--- | :--- |
| **Coding** | ç”Ÿæˆ Skeleton ä»£ç  | **AI (Copilot)** | Probabilistic (æ¦‚ç‡æ€§) |
| **Build** | Skeleton -> Flesh | **Compiler (Webpack)** | **Deterministic (ç¡®å®šæ€§)** |
| **Runtime** | åŠ¨æ€ç”Ÿæˆ Live Component | **AI (Runtime)** | Probabilistic (æ¦‚ç‡æ€§) |

**åŸåˆ™**:
*   **CI/CD æµæ°´çº¿ä¸­ä¸¥ç¦è°ƒç”¨ LLM**ã€‚æ„å»ºè¿‡ç¨‹å¿…é¡»æ˜¯ç¨³å®šã€å¿«é€Ÿã€å¯å¤ç°çš„ã€‚
*   AI çš„ä½œç”¨æ˜¯è¾…åŠ©äººå†™å‡ºæ­£ç¡®çš„ Skeleton æºç ã€‚ä¸€æ—¦æºç è½ç›˜ï¼ˆè¿› Gitï¼‰ï¼Œåç»­çš„æ„å»ºæµç¨‹å°±æ˜¯ä¼ ç»Ÿçš„å·¥ç¨‹åŒ–é€»è¾‘ã€‚

## 5. Handling `S.AISlot`

### 5.1 Mode A (One-off Generation)
å¦‚æœç”¨äº **Copilot** æ¨¡å¼ï¼ŒAI ç”Ÿæˆçš„ä»£ç ä¼š**æ›¿æ¢**æ‰ Slotã€‚
æ­¤æ—¶ï¼Œç”Ÿæˆçš„ä»£ç **å¿…é¡»æ˜¯ Skeleton ä»£ç **ï¼Œè€Œä¸æ˜¯ Flesh ä»£ç ã€‚

### 5.2 Mode B (Dynamic Generation)
å¦‚æœç”¨äº **Runtime** æ¨¡å¼ï¼ŒSlot ä¿ç•™åœ¨æºç ä¸­ï¼ŒFlesh åœ¨è¿è¡Œæ—¶ç”Ÿæˆå¹¶æŒ‚è½½åˆ° DOMã€‚

## 6. Summary

*   **Skeleton å­˜åœ¨ `src` ç›®å½•ï¼Œè¿› Gitã€‚**
*   **Flesh å­˜åœ¨ `.logix` ç¼“å­˜æˆ–å†…å­˜ï¼Œä¸è¿› Gitã€‚**
*   **AI ç”Ÿæˆçš„ä»£ç ï¼Œå¦‚æœæ˜¯ä¸ºäº†å†™å…¥æºç ï¼Œå¿…é¡»ç”Ÿæˆ Skeleton æ ¼å¼ã€‚**

è¿™æ ·ï¼Œæˆ‘ä»¬ä¿è¯äº†ä»£ç åº“æ°¸è¿œå¤„äº **"High Intent"** çš„çŠ¶æ€ã€‚
</file>

<file path="drafts/topics/api-evolution/next-gen-killer-apis.md">
---
title: Next-Gen Killer APIs (Agent.gen, Durable Flow, Invariants)
status: draft
version: 2025-11-28
---

# Next-Gen Killer APIs: å»¶ç»­ Bound API çš„è¾‰ç…Œ

å›é¡¾ `Bound API ($)` çš„æˆåŠŸï¼Œå…¶æ ¸å¿ƒåœ¨äº**â€œä¸Šä¸‹æ–‡çš„æè‡´å‹ç¼©â€**â€”â€”åœ¨ä¸€ä¸ªé—­åŒ…å†…éšå¼è·å¾—äº† Storeã€Env å’Œ Effect çš„æ‰€æœ‰èƒ½åŠ›ã€‚

åŸºäº Logix v3 çš„æ¼”è¿›æ„¿æ™¯ï¼ˆAI Native, Organic Systemï¼‰ï¼Œæˆ‘ä»¬æå‡ºä¸‰ä¸ªå…·å¤‡åŒç­‰æ½œåŠ›çš„ "Killer Features"ï¼š

## 1. `Agent.gen` â€”â€” è®¤çŸ¥æµç”Ÿæˆå™¨ (The Cognitive Generator)

**ç—›ç‚¹**ï¼šç›®å‰çš„ ReAct Loopã€Tool Callingã€Memory Management éœ€è¦å¤§é‡æ ·æ¿ä»£ç ï¼Œä¸”éš¾ä»¥é˜…è¯»ã€‚

**Killer Feature**: å°† "Agent æ€è€ƒè¿‡ç¨‹" é™ç»´ä¸ºç±»ä¼¼ `Effect.gen` çš„åŒæ­¥ä»£ç ä½“éªŒã€‚

```typescript
const ResearchAgent = Agent.gen(function* ($) {
  // 1. æ„ŸçŸ¥ï¼šè‡ªåŠ¨è·å–ä¸Šä¸‹æ–‡ (History, Goal)
  const goal = yield* $.goal;

  // 2. æ€è€ƒï¼šæ˜¾å¼äº§ç”Ÿ "Thought" (ä¼šè¢« Trace è®°å½•ï¼Œä½†ä¸è¾“å‡ºç»™ç”¨æˆ·)
  yield* $.think(`I need to decompose ${goal} into sub-tasks`);

  // 3. è¡ŒåŠ¨ï¼šç›´æ¥è°ƒç”¨ Tool (è‡ªåŠ¨å¤„ç† Schema æ ¡éªŒä¸é‡è¯•)
  // è¿è¡Œæ—¶ä¼šè‡ªåŠ¨å¤„ç† LLM çš„ "Function Call" -> "Tool Execution" -> "Submit Result" å¾ªç¯
  const searchResults = yield* $.tool(GoogleSearch, { query: goal });

  // 4. å†³ç­–ï¼šåŸºäºç»“æœè¿›è¡Œåˆ†æ”¯
  if (searchResults.isEmpty) {
    // 5. äº¤äº’ï¼šå‘ç”¨æˆ·åé—® (Human-in-the-loop)
    const clarification = yield* $.ask("Search failed. Can you provide more details?");
    return yield* $.retry(clarification);
  }

  // 6. è¡¨è¾¾ï¼šç”Ÿæˆæœ€ç»ˆå›å¤
  return yield* $.reply(searchResults);
});
```

**ä»·å€¼**ï¼šå¼€å‘è€…åƒå†™æ™®é€šä¸šåŠ¡é€»è¾‘ä¸€æ ·å†™ AI Agentï¼Œå®Œå…¨å±è”½äº†åº•å±‚çš„ LLM å¯¹è¯è½®æ¬¡å’ŒçŠ¶æ€ç»´æŠ¤ã€‚

## 2. `$.suspend` / `$.ask` â€”â€” æŒä¹…åŒ–äººæœºååŒ (Durable Human-in-the-Loop)

**ç—›ç‚¹**ï¼šå®¡æ‰¹æµã€é•¿ä»»åŠ¡é€šå¸¸éœ€è¦å¼•å…¥ Temporal ç­‰é‡å‹å·¥ä½œæµå¼•æ“ï¼Œæˆ–è€…æŠŠé€»è¾‘æ‹†ç¢æˆå¤šä¸ª Event Handlerã€‚

**Killer Feature**: åœ¨ Logix Flow ä¸­ç›´æ¥â€œæš‚åœâ€ç¨‹åºï¼Œç­‰å¾…ï¼ˆå¯èƒ½æ˜¯å‡ å¤©åçš„ï¼‰å¤–éƒ¨è¾“å…¥ï¼Œç„¶å**åŸåœ°æ¢å¤**ã€‚

```typescript
const ExpenseApprovalFlow = Flow.make(
  Effect.gen(function* ($) {
    const expense = yield* $.input;

    // è‡ªåŠ¨æ ¡éªŒé€»è¾‘
    if (expense.amount > 1000) {
      // KILLER: ç¨‹åºåœ¨æ­¤å¤„â€œæŒ‚èµ·â€ï¼ŒçŠ¶æ€è¢«æŒä¹…åŒ–åˆ°æ•°æ®åº“
      // ç›´åˆ° Manager åœ¨ UI ä¸Šç‚¹å‡»â€œæ‰¹å‡†â€ï¼Œç¨‹åºæ‰ä»ä¸‹ä¸€è¡Œç»§ç»­æ‰§è¡Œ
      const decision = yield* $.ask(ManagerApproval, {
        context: expense,
        timeout: "3 days"
      });

      if (decision === 'reject') {
        return yield* $.fail("Expense Rejected");
      }
    }

    yield* $.service(Finance).transfer(expense.amount);
  })
);
```

**ä»·å€¼**ï¼šå°†å¤æ‚çš„â€œå¼‚æ­¥å·¥ä½œæµâ€æ‰å¹³åŒ–ä¸ºâ€œåŒæ­¥ä»£ç â€ã€‚åˆ©ç”¨ Effect çš„ Fiber åºåˆ—åŒ–èƒ½åŠ›ï¼ˆéœ€ Runtime æ”¯æŒï¼‰ï¼Œå®ç°è½»é‡çº§çš„ Durable Executionã€‚

## 3. `Store.invariant` â€”â€” ä¸šåŠ¡ç‰©ç†å­¦ (Business Physics)

**ç—›ç‚¹**ï¼šä¸šåŠ¡è§„åˆ™ï¼ˆå¦‚â€œä½™é¢ä¸èƒ½ä¸ºè´Ÿâ€ï¼‰æ•£è½åœ¨å„ä¸ª Action å’Œ Logic ä¸­ï¼Œå®¹æ˜“è¢«é—æ¼æˆ–ç ´åï¼ˆç†µå¢ï¼‰ã€‚

**Killer Feature**: å£°æ˜å¼åœ°å®šä¹‰â€œç»å¯¹çœŸç†â€ï¼Œä»»ä½•è¯•å›¾è¿åè¿™äº›è§„åˆ™çš„ State Update éƒ½ä¼šè¢« Runtime è‡ªåŠ¨æ‹¦æˆªå¹¶å›æ»šã€‚

```typescript
const BankModule = Logix.Module("BankAccount", {
  state: StateSchema,
  actions: ActionSchema
})
  // å®šä¹‰ä¸å˜é‡ (Invariants)
  .invariant(s => s.balance >= 0, "Insufficient funds")
  .invariant(s => s.dailyTransferTotal <= 10000, "Daily limit exceeded")
  // å®šä¹‰å…³è”çº¦æŸ
  .invariant(
    s => s.status === 'active' || s.balance === 0,
    "Cannot deactivate account with remaining balance"
  );

// æ— è®ºåœ¨å“ªä¸ª Logicã€å“ªä¸ª Button ç‚¹å‡»äº‹ä»¶ä¸­ï¼Œ
// åªè¦å¯¼è‡´ balance < 0ï¼Œæ•´ä¸ªäº‹åŠ¡è‡ªåŠ¨å¤±è´¥ï¼Œæ— éœ€æ‰‹åŠ¨ checkã€‚
```

**ä»·å€¼**ï¼šå°†â€œé˜²å¾¡æ€§ç¼–ç¨‹â€ä¸‹æ²‰åˆ°æ¨¡å‹å±‚ã€‚è¿™æ˜¯å¯¹æŠ—â€œé€»è¾‘ç†µå¢â€çš„æœ€å¼ºæ­¦å™¨â€”â€”å®ƒç¡®ä¿äº†ç³»ç»Ÿçš„æ ¸å¿ƒçŠ¶æ€æ°¸è¿œå¤„äºåˆæ³•èŒƒå›´å†…ï¼Œæ— è®ºå¤–å›´é€»è¾‘å†™å¾—å¤šä¹ˆçƒ‚ã€‚

## æ€»ç»“

| Feature | è§£å†³çš„é—®é¢˜ | æ ¸å¿ƒéšå–» |
| :--- | :--- | :--- |
| **`Agent.gen`** | AI é€»è¾‘çš„å¤æ‚æ€§ | **"Thinking as Coding"** (åƒå†™ä»£ç ä¸€æ ·å†™æ€è€ƒ) |
| **`$.ask`** | é•¿æµç¨‹çš„ç¢ç‰‡åŒ– | **"Pause & Resume"** (æ—¶é—´æš‚åœæœ¯) |
| **`Store.invariant`** | ä¸šåŠ¡é€»è¾‘çš„ç†µå¢ | **"Laws of Physics"** (ä¸å¯è¿èƒŒçš„ç‰©ç†å®šå¾‹) |

è¿™ä¸‰ä¸ª API åˆ†åˆ«åœ¨ **AI ç¼–æ’**ã€**é•¿æµç¨‹** å’Œ **ç³»ç»Ÿç¨³å®šæ€§** ä¸‰ä¸ªç»´åº¦ï¼Œæä¾›äº†ç±»ä¼¼ `Bound API` çš„æè‡´ DX æå‡ã€‚
</file>

<file path="drafts/topics/api-evolution/README.md">
---
title: API Evolution Â· Topic Overview
status: draft
version: 2025-12-03
---

# API Evolution Â· Topic Overview

æœ¬ Topic ä¸“æ³¨äºã€Œä¸‹ä¸€ä»£å…³é”® API å½¢æ€ã€çš„æ¢ç´¢ï¼Œå°¤å…¶æ˜¯å›´ç»• Bound API (`$`) æ¼”è¿›å‡ºçš„ Agent / AI / Flow ç›¸å…³èƒ½åŠ›ã€‚

æ ¸å¿ƒå…³æ³¨ç‚¹ï¼š

- ä»¥ `Agent.gen`ã€`$.whenAI` ç­‰ä¸ºä»£è¡¨çš„æ–° API å½¢æ€ï¼Œå¦‚ä½•åœ¨ä¿æŒå¯è§£ææ€§çš„å‰æä¸‹æå‡ DXï¼›  
- å°† AI è°ƒç”¨ä»å‘½ä»¤å¼ Effect æå‡ä¸ºå£°æ˜å¼ã€ä¸€ç­‰å…¬æ°‘çš„æµå¼åŸè¯­ï¼›  
- ä¸º v3/v4 ä»¥åçš„ Logix/å¹³å° API æ¼”è¿›æä¾›å€™é€‰è·¯å¾„ã€‚

## æ–‡æ¡£ç´¢å¼•

- [next-gen-killer-apis.md](./next-gen-killer-apis.md) Â· Next-Gen Killer APIsï¼ˆAgent.genã€Durable Flowã€Invariants ç­‰å€™é€‰èƒ½åŠ›ï¼‰  
- [when-ai-api.md](./when-ai-api.md) Â· `$.whenAI` ææ¡ˆï¼ˆå°† AI è°ƒç”¨èå…¥å“åº”å¼ä½“ç³»çš„å£°æ˜å¼ APIï¼‰
</file>

<file path="drafts/topics/api-evolution/when-ai-api.md">
---
title: 'Killer Feature Proposal: $.whenAI API'
status: proposal
version: 1
---

# Killer Feature ææ¡ˆ: `$.whenAI`

æœ¬æ–‡æ¡£æå‡ºä¸€ä¸ªå…¨æ–°çš„ Bound API æˆå‘˜ `$.whenAI`ï¼Œæ—¨åœ¨å°† AI è°ƒç”¨ä»ä¸€ä¸ªå‘½ä»¤å¼çš„ `Effect` æå‡ä¸ºä¸€ä¸ªå£°æ˜å¼çš„ã€æµå¼çš„ä¸€ç­‰å…¬æ°‘ï¼Œæ·±åº¦èå…¥ Logix çš„å“åº”å¼ä½“ç³»ã€‚

## 1. é—®é¢˜ï¼šå‘½ä»¤å¼çš„ AI è°ƒç”¨

å½“å‰ï¼Œåœ¨ Logix ä¸­è°ƒç”¨ AI æœåŠ¡ï¼ˆå³ä½¿åŸºäº `@effect/ai`ï¼‰ä»ç„¶æ˜¯ä¸€ä¸ªå‘½ä»¤å¼çš„è¿‡ç¨‹ï¼š

```typescript
yield* $.onState(s => s.userInput)
  .debounce(500)
  .then(Effect.gen(function* () {
    // æ‰‹åŠ¨ç®¡ç† loading çŠ¶æ€
    yield* $.state.mutate(draft => draft.isLoading = true);
    const input = yield* Prompt.render(...);
    const result = yield* AiService.complete(input);
    // æ‰‹åŠ¨å¤„ç†æˆåŠŸ/å¤±è´¥
    yield* $.state.mutate(draft => {
      draft.isLoading = false;
      draft.summary = result;
    });
  }));
```

è¿™ä¸ªè¿‡ç¨‹å……æ»¡äº†æ ·æ¿ä»£ç ï¼šæ‰‹åŠ¨çŠ¶æ€ç®¡ç†ã€ç«æ€å¤„ç†ï¼ˆé€šè¿‡ `.then` çš„ `mode`ï¼‰ã€æµå¼å“åº”å¤„ç†ç­‰ï¼Œæœªèƒ½å……åˆ†å‘æŒ¥ Logix å“åº”å¼æ¨¡å‹çš„å¨åŠ›ã€‚

## 2. æ–¹æ¡ˆ: `$.whenAI`

`$.whenAI` æ˜¯ä¸€ä¸ªé«˜çº§çš„æµæ“ä½œç¬¦ï¼Œå®ƒå°† AI äº¤äº’çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸå°è£…æˆä¸€ä¸ªå£°æ˜å¼çš„ APIã€‚

### 2.1 API è®¾è®¡

```typescript
// logic.ts
const $ = Logic.forShape<MyShape>();

export const MyLogic: Logic.Of<MyShape> = ($) =>
  Effect.gen(function* () {

    // å½“ç”¨æˆ·è¾“å…¥å˜åŒ–æ—¶ï¼Œæµå¼è°ƒç”¨ AI
    yield* $.onState(s => s.userInput)
      .debounce(500)
      .whenAI(
        // 1. Prompt Intent ä½œä¸ºè¾“å…¥
        SummarizePrompt,

        // 2. åŠ¨æ€æ„é€  Prompt çš„å˜é‡
        (userInput) => ({ text: userInput, style: 'concise' }),

        // 3. å®šä¹‰å¦‚ä½•å¤„ç† AI çš„è¾“å‡ºæµ
        {
          onData: (chunk) => $.state.mutate(draft => draft.summaryStream += chunk),
          onSuccess: (fullText) => $.actions.dispatch({ _tag: 'summary/done' }),
          onError: (error) => $.state.mutate(draft => draft.error = error.message),
          // å¯é€‰ï¼šè‡ªåŠ¨ç®¡ç† loading çŠ¶æ€
          setLoading: (isLoading) => $.state.mutate(draft => draft.isLoading = isLoading)
        },
        { mode: 'latest' } // è‡ªåŠ¨å¤„ç†ç«æ€
      );
  })
);
```

### 2.2 æ ¸å¿ƒç‰¹æ€§

1.  **AI æˆä¸ºå“åº”å¼å…¬æ°‘**ï¼šAI ä¸å†æ˜¯ä¸€ä¸ªè¢«åŠ¨è°ƒç”¨çš„å‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªå“åº”æµå˜åŒ–çš„ã€è‡ªèº«ä¹Ÿæ˜¯æµçš„ã€å¯è¢«å¹¶å‘ç®¡ç†çš„é€»è¾‘èŠ‚ç‚¹ã€‚
2.  **å£°æ˜å¼å°è£…**ï¼šå®ƒå°†é˜²æŠ–ã€ç«æ€å¤„ç† (`mode: 'latest'` è‡ªåŠ¨æ˜ å°„ä¸º `switchMap`)ã€æµå¼å“åº” (`onData`)ã€æˆåŠŸ/å¤±è´¥å›è°ƒ (`onSuccess`/`onError`) ä»¥åŠåŠ è½½çŠ¶æ€ç®¡ç† (`setLoading`) ç­‰æ‰€æœ‰ä¸ AI äº¤äº’ç›¸å…³çš„å¤æ‚æ ·æ¿ä»£ç ï¼Œå…¨éƒ¨å°è£…åœ¨ä¸€ä¸ªé«˜åº¦å£°æ˜å¼çš„ API ä¸­ã€‚
3.  **å¹³å°å‹å¥½**ï¼šParser å¯ä»¥è½»æ˜“è¯†åˆ« `$.whenAI`ï¼Œå¹¶åœ¨ç”»å¸ƒä¸Šå°†å…¶æ¸²æŸ“ä¸ºä¸€ä¸ªç‰¹æ®Šçš„â€œAI èŠ‚ç‚¹â€ã€‚è¿™ä¸ªèŠ‚ç‚¹å¯ä»¥æ¸…æ™°åœ°å±•ç¤ºå…¶è¾“å…¥ï¼ˆ`SummarizePrompt` èµ„äº§ï¼‰ã€è¾“å‡ºï¼ˆçŠ¶æ€æ›´æ–°/Actionæ´¾å‘ï¼‰å’Œå¹¶å‘ç­–ç•¥ï¼Œæå¤§åœ°å¢å¼ºäº† AI é€»è¾‘çš„å¯è§†åŒ–å’Œå¯ç»´æŠ¤æ€§ã€‚

## 3. ä»·å€¼ï¼šç®€åŒ– AI åº”ç”¨å¼€å‘

`$.whenAI` å°†ä¼šæˆä¸ºå¼€å‘ AI Agentic åº”ç”¨çš„æ ¸å¿ƒ API ä¹‹ä¸€ã€‚

### 3.1 æ¶æ„å®šä½ (Architecture Positioning)

è™½ç„¶ `$.whenAI` åœ¨äº§å“å±‚é¢è¢«å®£ä¼ ä¸ºæ ¸å¿ƒèƒ½åŠ›ï¼Œä½†åœ¨æ¶æ„å®ç°ä¸Šï¼Œå»ºè®®å°†å…¶ä½œä¸º **Bound API çš„æ‰©å±• (Extension)**ã€‚

*   **Core Bound**: æä¾›é€šç”¨çš„ `$.whenStream` / `$.whenEffect` èƒ½åŠ›ã€‚
*   **AI Extension**: åŸºäº Core å®ç° `$.whenAI`ï¼Œæ³¨å…¥ AI Provider å’Œ Prompt èµ„äº§è§£æèƒ½åŠ›ã€‚

è¿™ç§è®¾è®¡æ—¢ä¿è¯äº†æ ¸å¿ƒæ¡†æ¶çš„è½»é‡ä¸ç¨³å®šï¼Œåˆå…è®¸ AI èƒ½åŠ›éšç€æ¨¡å‹å’Œåè®®çš„å¿«é€Ÿæ¼”è¿›è€Œç‹¬ç«‹è¿­ä»£ã€‚
</file>

<file path="drafts/topics/draft-pattern/00-design.md">
---
title: Draft Pattern Design (Ephemeral Interaction)
status: draft
version: 2.0
---

# Draft Pattern: Ephemeral Interaction & Transaction

> **Status**: RFC (Request for Comments)
> **Version**: 2.0 (Deep Dive)
> **Author**: Logix Architecture Team
> **Context**: `v3/effect-runtime`

## 1. Executive Summary

**Draft (è‰ç¨¿)** æ˜¯ Logix v3 æ¶æ„ä¸­ç”¨äºå¤„ç† **Ephemeral Interaction (ç¬æ—¶äº¤äº’)** çš„æ ¸å¿ƒåŸè¯­ã€‚å®ƒæ—¨åœ¨è§£å†³å¤æ‚å‰ç«¯åº”ç”¨ä¸­â€œäº¤äº’çŠ¶æ€â€ä¸â€œä¸šåŠ¡çŠ¶æ€â€æ··æ‚å¯¼è‡´çš„ç†µå¢é—®é¢˜ã€‚

ä»è®¡ç®—æœºç§‘å­¦è§†è§’ï¼ŒDraft æ˜¯ **Software Transactional Memory (STM)** æ€æƒ³åœ¨ UI äº¤äº’é¢†åŸŸçš„å·¥ç¨‹åŒ–æŠ•å½±ã€‚å®ƒæä¾›äº†ä¸€ä¸ª **Long-Lived Interactive Transaction (é•¿æ´»äº¤äº’å¼äº‹åŠ¡)** ç¯å¢ƒï¼Œå…·å¤‡ä»¥ä¸‹ ACID ç‰¹æ€§ï¼š

*   **Atomicity (åŸå­æ€§)**: äº¤äº’è¿‡ç¨‹ä¸­çš„æ‰€æœ‰å˜æ›´è¦ä¹ˆå…¨éƒ¨æäº¤ (Commit)ï¼Œè¦ä¹ˆå…¨éƒ¨é”€æ¯ (Rollback)ã€‚
*   **Consistency (ä¸€è‡´æ€§)**: Draft å†…éƒ¨é€šè¿‡ Schema ä¿è¯æ•°æ®çš„ç»“æ„å®Œæ•´æ€§ï¼ŒCommit æ—¶è¿›è¡Œæœ€ç»ˆä¸€è‡´æ€§æ ¡éªŒã€‚
*   **Isolation (éš”ç¦»æ€§)**: Draft è¿è¡Œåœ¨ç‹¬ç«‹çš„ `Effect.Scope` ä¸­ï¼Œå…¶å†…éƒ¨çŠ¶æ€å¯¹å¤–éƒ¨ Module ä¸å¯è§ï¼Œæœç»â€œè„è¯»â€ã€‚
*   **Durability (æŒä¹…æ€§)**: *æ³¨ï¼šUI äº‹åŠ¡é€šå¸¸ä¸è¿½æ±‚æŒä¹…æ€§ï¼Œä½† Draft æ”¯æŒåºåˆ—åŒ– (Serialization) ä»¥å®ç°â€œä¸­æ–­æ¢å¤â€ã€‚*

> **Scope Clarification (è´£ä»»è¾¹ç•Œ)**:
> Draft ä¸“æ³¨äº **UI/Interaction Transaction (äº¤äº’å±‚äº‹åŠ¡)**ï¼Œå³â€œç”¨æˆ·åœ¨å±å¹•å‰çš„ä¸´æ—¶æ“ä½œåºåˆ—â€ã€‚
> å®ƒä¸åº”è¢«è¯¯è§£ä¸ºè·¨å¾®æœåŠ¡çš„åˆ†å¸ƒå¼ä¸šåŠ¡äº‹åŠ¡ (Saga/TCC)ã€‚Draft çš„äº§ç‰©é€šå¸¸æ˜¯ä¸€ä¸ª Atomic Commandï¼Œæœ€ç»ˆç”± Domain/Flow å±‚è´Ÿè´£æŒä¹…åŒ–ã€‚

## 2. Problem Space & Motivation

åœ¨æ„å»ºå¤æ‚ ToB åº”ç”¨ï¼ˆå¦‚ IDEã€ä½ä»£ç å¹³å°ã€æ•°æ®åˆ†æå·¥å…·ï¼‰æ—¶ï¼Œæˆ‘ä»¬é¢ä¸´ä¸‰å¤§æŒ‘æˆ˜ï¼š

### 2.1 The "State Pollution" Problem (çŠ¶æ€æ±¡æŸ“)
*   **ç°è±¡**: ä¸ºäº†å®ç°â€œæ‹–æ‹½æ’åºâ€ï¼Œæˆ‘ä»¬åœ¨ Domain Store ä¸­å¼•å…¥äº† `draggingId`, `currentX`, `currentY`ã€‚
*   **åæœ**:
    *   **æ€§èƒ½æ¶åŒ–**: 60fps çš„åæ ‡æ›´æ–°å¯¼è‡´è®¢é˜…äº† Domain Store çš„æ— å…³ç»„ä»¶ï¼ˆå¦‚ä¾§è¾¹æ ã€Headerï¼‰é¢‘ç¹ Re-renderã€‚
    *   **é€»è¾‘è€¦åˆ**: ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚â€œä¿å­˜æ•°æ®â€ï¼‰è¢«è¿«å¤„ç†è¿™äº›ä¸´æ—¶å­—æ®µï¼ˆéœ€æ‰‹åŠ¨å‰”é™¤ï¼‰ã€‚

### 2.2 The "Lifecycle Mismatch" Problem (ç”Ÿå‘½å‘¨æœŸé”™ä½)
*   **ç°è±¡**: ä¸€ä¸ªâ€œä¸‰æ­¥å‘å¯¼â€çš„ `currentStep` çŠ¶æ€è¢«ä¿å­˜åœ¨éšé¡µé¢ç”Ÿå‘½å‘¨æœŸçš„ Store ä¸­ã€‚
*   **åæœ**: ç”¨æˆ·å…³é—­å‘å¯¼åï¼Œå¼€å‘è€…å¿˜è®°æ‰‹åŠ¨ `resetState`ã€‚ç”¨æˆ·ä¸‹æ¬¡æ‰“å¼€ï¼Œçœ‹åˆ°çš„ä¾ç„¶æ˜¯â€œç¬¬ 3 æ­¥â€çš„æ®‹å½±ã€‚
*   **æœ¬è´¨**: äº¤äº’çš„ç”Ÿå‘½å‘¨æœŸ < é¡µé¢çš„ç”Ÿå‘½å‘¨æœŸã€‚

### 2.3 The "Transaction" Problem (äº‹åŠ¡è¯­ä¹‰ç¼ºå¤±)
*   **ç°è±¡**: ç”¨æˆ·åœ¨â€œæ‰¹é‡ç¼–è¾‘â€æ¨¡å¼ä¸‹ä¿®æ”¹äº† 10 æ¡æ•°æ®ï¼Œç„¶åç‚¹å‡»â€œå–æ¶ˆâ€ã€‚
*   **åæœ**: å¼€å‘è€…éœ€è¦ç¼–å†™å¤æ‚çš„ `undo` é€»è¾‘æ¥å›æ»šè¿™ 10 æ¡æ•°æ®çš„å˜æ›´ã€‚
*   **æœ¬è´¨**: ç¼ºä¹ä¸€ç§æœºåˆ¶æ¥â€œåŸå­æ€§åœ°ä¸¢å¼ƒâ€ä¸€ç»„å˜æ›´ã€‚

## 3. Conceptual Model: The Draft Lifecycle

Draft æ˜¯ä¸€ä¸ªæœ‰é™çŠ¶æ€æœº (FSM)ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸä¸¥æ ¼å—æ§äº `Effect.Scope`ã€‚

```mermaid
stateDiagram-v2
    [*] --> Idle
    Idle --> Active: $.draft.start()

    state Active {
        [*] --> Interaction
        Interaction --> Validating: State Change
        Validating --> Interaction: Valid/Invalid
    }

    Active --> Committing: $.draft.commit()
    Active --> Destroyed: $.draft.destroy()

    Committing --> Destroyed: Success (Result Action)
    Committing --> Active: Failure (Error Handling)

    Destroyed --> [*]: Scope Closed (GC)
```

1.  **Idle**: å®šä¹‰é˜¶æ®µï¼Œä»…å­˜åœ¨ Schema å’Œ Logic æè¿°ï¼Œä¸å ç”¨å†…å­˜ã€‚
2.  **Active**: å®ä¾‹åŒ–é˜¶æ®µã€‚`Scope` åˆ›å»ºï¼Œ`Ref` åˆå§‹åŒ–ã€‚æ­¤æ—¶ Draft æ¥ç®¡äº¤äº’ã€‚
3.  **Committing**: äº‹åŠ¡æäº¤é˜¶æ®µã€‚æ‰§è¡Œæœ€ç»ˆæ ¡éªŒï¼Œäº§å‡º Resultã€‚
4.  **Destroyed**: ç»ˆæ€ã€‚`Scope` å…³é—­ï¼Œæ‰€æœ‰ Fiber åœæ­¢ï¼Œå†…å­˜é‡Šæ”¾ã€‚

## 4. Detailed API Specification

### 4.1 Type Definition (`Draft.make`)

æˆ‘ä»¬é‡‡ç”¨ **Schema-First** çš„å®šä¹‰æ–¹å¼ï¼Œåˆ©ç”¨ TypeScript çš„æ¨å¯¼èƒ½åŠ›å®ç°æè‡´çš„ç±»å‹å®‰å…¨ã€‚

```typescript
import { Draft, Schema, Effect } from "@logix/core";

// 1. Define Schema
const WizardState = Schema.Struct({
  step: Schema.Number,
  formData: Schema.Record(Schema.String, Schema.Unknown)
});

const WizardContext = Schema.Struct({
  mode: Schema.Literal("create", "edit"),
  targetId: Schema.optional(Schema.String)
});

export interface DraftDefinition<S, C, Comp, E, A = {}> {
  readonly id: string;
  readonly schema: Schema.Schema<S>;
  readonly initial: (context: C) => S | Effect.Effect<S, E>;

  // Logic: å®šä¹‰çŠ¶æ€æµè½¬è§„åˆ™
  readonly logic: (
    $: DraftRuntime<S, C, Comp, E>
  ) => Effect.Effect<void, E, Scope | DraftEnv>; // å…è®¸æ‰©å±•ç¯å¢ƒ

  // Actions: å®šä¹‰å¯¹å¤–æš´éœ²çš„æ“ä½œ
  readonly actions?: (
    $: DraftRuntime<S, C, Comp, E>
  ) => A;

  // Optional
  readonly computed?: (state: S) => Comp;
  readonly invariants?: ReadonlyArray<(state: S) => boolean | Effect.Effect<void, InvariantError>>; // æ”¯æŒå¼‚æ­¥æ ¡éªŒ
}

export declare const make: <S, C, Comp, E, A>(
  def: DraftDefinition<S, C, Comp, E, A>
) => Draft<S, C, Comp, E, A>;

// 2. Define Draft
export const WizardDraft = Draft.make({
  id: "wizard-interaction",

  schema: {
    state: WizardState,   // Mutable Ref<State>
    context: WizardContext // Readonly Context
  },

  // 3. Define Logic (Effect-Native)
  // $ ç±»å‹è¢«è‡ªåŠ¨æ¨å¯¼ä¸º: DraftRuntime<WizardState, WizardContext>
  logic: ($) => Effect.gen(function* () {

    // Lifecycle Hook: onStart
    yield* $.lifecycle.onStart(() =>
      Effect.log("Wizard Started", $.context.get())
    );

    // Reactive Logic: å½“ step å˜åŒ–æ—¶è‡ªåŠ¨æ ¡éªŒ
    yield* $.onState(s => s.step).then((step) =>
      step > 1 ? validateForm($.state.get().formData) : Effect.void
    );

    // Internal Action: å¤„ç†å†…éƒ¨äº¤äº’
    yield* $.onAction('nextStep').then(() =>
      $.state.update(s => ({ ...s, step: s.step + 1 }))
    );
  })
});
```

### 4.2 Runtime Consumption (`$.draft`)

åœ¨ä¸» Module ä¸­ï¼ŒDraft è¢«è§†ä¸ºä¸€ä¸ªå¯ç»„åˆçš„ Effect å•å…ƒã€‚

```typescript
// MainModule.ts
Module.logic(($) => Effect.gen(function* () {

  // Start: å¯åŠ¨ Draftï¼Œè¿”å› Handle
  // Handle åŒ…å«: { id, state$, actions, commit, destroy }
  const draftHandle = yield* $.onAction('openWizard').then((payload) =>
    $.draft.start(WizardDraft, {
      mode: 'edit',
      targetId: payload.id
    })
  );

  // Interaction: å¤–éƒ¨ä¹Ÿå¯ä»¥é€šè¿‡ Handle é©±åŠ¨ Draft (å¯é€‰)
  // é€šå¸¸ Draft å†…éƒ¨é€»è¾‘è‡ªæ´½ï¼Œå¤–éƒ¨åªéœ€å…³æ³¨ Start/Commit

  // Commit: æäº¤äº‹åŠ¡
  yield* $.onAction('submitWizard').then(() =>
    $.draft.commit(WizardDraft).pipe(
      // é”™è¯¯å¤„ç† (Error Boundary)
      Effect.catchTag("ValidationError", (err) =>
        $.actions.toast("è¡¨å•æ ¡éªŒå¤±è´¥: " + err.message)
      ),
      // æˆåŠŸå¤„ç† (Result Handling)
      Effect.andThen((result) =>
        $.actions.updateRecord(result)
      )
    )
  );
}));
```

## 5. Advanced Capabilities

### 5.1 Validation & Invariants (æ ¡éªŒä¸ä¸å˜é‡)
Draft æ”¯æŒå®šä¹‰ **Invariants (ä¸å˜é‡)**ã€‚åœ¨ `commit` é˜¶æ®µï¼ŒRuntime ä¼šè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰ Invariants æ£€æŸ¥ã€‚

```typescript
Draft.make({
  // ...
  invariants: [
    (state) => state.step < 3 || state.hasAgreedToTerms, // å¿…é¡»åŒæ„æ¡æ¬¾æ‰èƒ½è¿‡ç¬¬3æ­¥
    (state) => state.items.length > 0 // åˆ—è¡¨ä¸èƒ½ä¸ºç©º
  ]
});
```

### 5.2 Computed State (è®¡ç®—çŠ¶æ€)
Draft å†…éƒ¨æ”¯æŒæ´¾ç”ŸçŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€æ˜¯åªè¯»çš„ï¼Œä¸”éš State å˜åŒ–è‡ªåŠ¨æ›´æ–°ï¼ˆLazy Evaluationï¼‰ã€‚

```typescript
Draft.make({
  // ...
  computed: {
    canSubmit: (state) => state.isValid && !state.isSubmitting,
    progress: (state) => (state.step / state.totalSteps) * 100
  }
});
```

### 5.3 Serialization & Hydration (åºåˆ—åŒ–ä¸æ¢å¤)
ä¸ºäº†æ”¯æŒâ€œä¿å­˜è‰ç¨¿â€åŠŸèƒ½ï¼ŒDraft Runtime æä¾›äº†åºåˆ—åŒ–æ¥å£ã€‚

```typescript
// Save
const snapshot = yield* $.draft.snapshot(WizardDraft);
localStorage.setItem('draft_backup', JSON.stringify(snapshot));

// Restore
yield* $.draft.start(WizardDraft, {
  initialState: JSON.parse(localStorage.getItem('draft_backup'))
});
```

## 6. Integration Strategy (React)

ä¸ºäº†è®© React ç»„ä»¶èƒ½ä¾¿æ·åœ°æ¶ˆè´¹ Draftï¼Œæˆ‘ä»¬æä¾› `useDraft` Hookã€‚

```tsx
// WizardComponent.tsx
import { useDraft } from "@logix/react";
import { WizardDraft } from "./logic";

export const WizardComponent = () => {
  // è‡ªåŠ¨è®¢é˜… Draft çŠ¶æ€
  // å¦‚æœ Draft æœªå¯åŠ¨ï¼Œè¿”å› null æˆ– fallback
  const { state, actions, commit } = useDraft(WizardDraft);

  if (!state) return null;

  return (
    <Modal>
      <StepIndicator step={state.step} />
      <Button onClick={() => actions.nextStep()}>Next</Button>
      <Button onClick={() => commit()}>Submit</Button>
    </Modal>
  );
};
```

## 7. Performance & Engineering

### 7.1 Memory Management
*   **Scope-based GC**: Draft çš„æ‰€æœ‰èµ„æºï¼ˆState Ref, Subscriptions, Forked Fibersï¼‰éƒ½ç»‘å®šåœ¨ä¸€ä¸ª `Scope` ä¸Šã€‚
*   **Automatic Cleanup**: å½“ `$.draft.destroy()` è¢«è°ƒç”¨ï¼ˆæˆ–ä¸» Module å¸è½½ï¼‰ï¼ŒScope å…³é—­ï¼ŒEffect Runtime ä¿è¯æ‰€æœ‰èµ„æºè¢«é‡Šæ”¾ï¼Œæ— å†…å­˜æ³„æ¼é£é™©ã€‚

### 7.2 Concurrency Control
*   **Singleton by ID**: é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒä¸€ä¸ª Draft ID åœ¨åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹ã€‚é‡å¤ `start` ä¼šè‡ªåŠ¨é”€æ¯å‰ä¸€ä¸ªå®ä¾‹ï¼ˆæˆ–æŠ›é”™ï¼Œå¯é…ç½®ï¼‰ã€‚
*   **Locking**: `commit` è¿‡ç¨‹ä¼šè‡ªåŠ¨åŠ é”ï¼Œé˜²æ­¢åœ¨æäº¤è¿‡ç¨‹ä¸­çŠ¶æ€è¢«ä¿®æ”¹ã€‚

## 8. Conclusion

Draft Pattern ä¸ä»…ä»…æ˜¯ä¸€ä¸ªçŠ¶æ€ç®¡ç†å·¥å…·ï¼Œå®ƒæ˜¯ä¸€ç§ **æ¶æ„èŒƒå¼**ã€‚å®ƒå¼ºè¿«å¼€å‘è€…æ˜¾å¼åœ°æ€è€ƒäº¤äº’çš„è¾¹ç•Œã€ç”Ÿå‘½å‘¨æœŸå’Œäº‹åŠ¡æ€§ã€‚

åœ¨ Logix v3 ä¸­ï¼ŒDraft å°†æˆä¸ºæ„å»º **High-Fidelity Interaction (é«˜ä¿çœŸäº¤äº’)** çš„åŸºçŸ³ï¼Œè®©å‰ç«¯ä»£ç åœ¨å¤æ‚åº¦çˆ†ç‚¸çš„è¾¹ç¼˜ä¾ç„¶ä¿æŒä¼˜é›…ä¸å¯æ§ã€‚

## 9. Industry Landscape & Decision Matrix (ç«å“åˆ†æä¸å†³ç­–)

ä¸ºäº†éªŒè¯ Draft æ¨¡å¼çš„æ¶æ„ä¼˜è¶Šæ€§ï¼Œæˆ‘ä»¬å¯¹ä¸šç•Œä¸»æµçš„çŠ¶æ€ç®¡ç†æ–¹æ¡ˆè¿›è¡Œäº†æ·±åº¦è°ƒç ”ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„å¯¹æ¯”åˆ†æä¸æœ€ç»ˆå†³ç­–ä¾æ®ã€‚

### 9.1 XState (Actor Model)

*   **æ ¸å¿ƒç†å¿µ**: "Everything is an Actor". é€šè¿‡ `spawn` åˆ›å»ºå­çŠ¶æ€æœºï¼Œé€šè¿‡ `send` è¿›è¡Œæ¶ˆæ¯ä¼ é€’ã€‚
*   **Logix å€Ÿé‰´ç‚¹**:
    *   **éš”ç¦»æ€§**: Actor æ‹¥æœ‰ç§æœ‰çŠ¶æ€ï¼Œå¤–éƒ¨æ— æ³•ç›´æ¥ä¿®æ”¹ï¼Œåªèƒ½é€šè¿‡æ¶ˆæ¯äº¤äº’ã€‚
    *   **ç”Ÿå‘½å‘¨æœŸ**: Actor å¯ä»¥è¢«åŠ¨æ€åˆ›å»ºå’Œåœæ­¢ã€‚
*   **Gap Analysis (ä¸è¶³)**:
    *   **æ‰‹åŠ¨ç®¡ç†æˆæœ¬é«˜**: å¼€å‘è€…å¿…é¡»æ‰‹åŠ¨ç®¡ç† `spawn` å’Œ `stop`ã€‚å¦‚æœå¿˜è®° `stop`ï¼ŒActor ä¼šä¸€ç›´å ç”¨å†…å­˜ï¼ˆè™½ç„¶ XState v5 æœ‰æ‰€æ”¹è¿›ï¼Œä½†ä»éœ€æ˜¾å¼ç®¡ç†ï¼‰ã€‚
    *   **å®šä¹‰ç¹ç**: å®šä¹‰ä¸€ä¸ªç®€å•çš„â€œè®¡æ•°å™¨ Actorâ€éœ€è¦å¤§é‡çš„æ ·æ¿ä»£ç ï¼ˆMachine Definition, Events, Contextï¼‰ã€‚
    *   **éäº‹åŠ¡æ€§**: Actor æ¨¡å‹æœ¬è´¨ä¸Šæ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œç¼ºä¹â€œäº‹åŠ¡æäº¤/å›æ»šâ€çš„å†…å»ºè¯­ä¹‰ã€‚
*   **Logix Draft ä¼˜åŠ¿**: åˆ©ç”¨ `Effect.Scope` å®ç°äº† **å…¨è‡ªåŠ¨çš„ Actor ç”Ÿå‘½å‘¨æœŸç®¡ç†**ã€‚å¼€å‘è€…åªéœ€ `start`ï¼Œæ— éœ€å…³å¿ƒ `stop`ï¼ˆScope è‡ªåŠ¨å¤„ç†ï¼‰ã€‚åŒæ—¶æä¾›äº† `commit` è¯­ä¹‰ï¼Œè¡¥å…¨äº†äº‹åŠ¡èƒ½åŠ›ã€‚

### 9.2 Redux Toolkit (Undo/Redo)

*   **æ ¸å¿ƒç†å¿µ**: "Global Store + History Stack". é€šè¿‡è®°å½• State çš„å¿«ç…§ï¼ˆæˆ– Patchï¼‰æ¥å®ç°æ—¶é—´æ—…è¡Œã€‚
*   **Logix å€Ÿé‰´ç‚¹**:
    *   **ä¸å¯å˜æ€§**: åŸºäº Immer çš„ Patch æœºåˆ¶æ˜¯å®ç° Undo çš„åŸºç¡€ã€‚
*   **Gap Analysis (ä¸è¶³)**:
    *   **å…¨å±€ vs å±€éƒ¨**: Redux çš„ Undo é€šå¸¸æ˜¯å…¨å±€çš„ï¼ˆæˆ– Slice çº§åˆ«çš„ï¼‰ã€‚å¾ˆéš¾å®ç°â€œåªæ’¤é”€è¿™ä¸ªå¼¹çª—é‡Œçš„æ“ä½œï¼Œè€Œä¸å½±å“é¡µé¢å…¶ä»–éƒ¨åˆ†â€ã€‚
    *   **çŠ¶æ€æ±¡æŸ“**: æ‰€æœ‰çš„ä¸´æ—¶çŠ¶æ€ï¼ˆDraftï¼‰éƒ½å¿…é¡»æŒ‚è½½åˆ° Global Store æ ‘ä¸Šï¼Œå¯¼è‡´ Store ç»“æ„è‡ƒè‚¿ã€‚
*   **Logix Draft ä¼˜åŠ¿**: Draft æ˜¯ **Micro Store**ï¼Œå¤©ç„¶æ”¯æŒ **å±€éƒ¨äº‹åŠ¡ (Local Transaction)**ã€‚Draft çš„ Undo åªå›æ»š Draft å†…éƒ¨çš„çŠ¶æ€ï¼Œç»ä¸å½±å“å…¨å±€ã€‚

### 9.3 React Hook Form (Form State)

*   **æ ¸å¿ƒç†å¿µ**: "Uncontrolled Inputs + Subscription". ä¸“æ³¨äºè¡¨å•çŠ¶æ€çš„æ€§èƒ½ä¼˜åŒ–ï¼ŒåŒºåˆ† `defaultValues` (Committed) å’Œ `currentValues` (Draft)ã€‚
*   **Logix å€Ÿé‰´ç‚¹**:
    *   **è„æ£€æŸ¥ (Dirty Check)**: `isDirty` æ˜¯åˆ¤æ–­æ˜¯å¦éœ€è¦æäº¤çš„å…³é”®ä¿¡å·ã€‚
    *   **æäº¤ç”Ÿå‘½å‘¨æœŸ**: `isSubmitting` -> `isSubmitted` çš„çŠ¶æ€æµè½¬éå¸¸ç»å…¸ã€‚
*   **Gap Analysis (ä¸è¶³)**:
    *   **åœºæ™¯å—é™**: RHF æ·±åº¦ç»‘å®š DOM è¡¨å•å…ƒç´ ï¼Œéš¾ä»¥ç”¨äºéè¡¨å•åœºæ™¯ï¼ˆå¦‚ï¼šç”»å¸ƒæ‹–æ‹½ã€å¤æ‚çš„æ­¥éª¤æ¡æ§åˆ¶å™¨ã€çº¯é€»è¾‘çš„å€’è®¡æ—¶ä»»åŠ¡ï¼‰ã€‚
*   **Logix Draft ä¼˜åŠ¿**: Draft å¯ä»¥è¢«è§†ä¸º **"General Purpose React Hook Form"**ã€‚å®ƒæå–äº† RHF çš„çŠ¶æ€æ¨¡å‹ï¼ˆDraft vs Committedï¼‰ï¼Œä½†è§£è€¦äº† DOMï¼Œä½¿å…¶é€‚ç”¨äºä»»ä½• UI äº¤äº’åœºæ™¯ã€‚

### 9.4 MobX (Volatile State)

*   **æ ¸å¿ƒç†å¿µ**: "Observable Graph". å…è®¸åœ¨ Model ä¸Šå®šä¹‰ `volatile` å±æ€§ï¼Œè¿™äº›å±æ€§ä¸å‚ä¸åºåˆ—åŒ–ã€‚
*   **Logix å€Ÿé‰´ç‚¹**:
    *   **ç¬æ—¶æ€§**: æ˜ç¡®åŒºåˆ†äº†â€œæŒä¹…åŒ–çŠ¶æ€â€å’Œâ€œç¬æ—¶çŠ¶æ€â€ã€‚
*   **Gap Analysis (ä¸è¶³)**:
    *   **ç”Ÿå‘½å‘¨æœŸç»‘å®šå¯¹è±¡**: MobX çš„ Volatile State é€šå¸¸ç»‘å®šåœ¨ Model å®ä¾‹ä¸Šã€‚åªè¦ Model è¿˜åœ¨ï¼ŒVolatile State å°±è¿˜åœ¨ã€‚è¿™å¯¼è‡´äº†â€œä¸Šæ¬¡çš„äº¤äº’çŠ¶æ€æ®‹ç•™â€é—®é¢˜ï¼ˆLifecycle Mismatchï¼‰ã€‚
*   **Logix Draft ä¼˜åŠ¿**: Draft å°†çŠ¶æ€ç»‘å®šåœ¨ **â€œäº¤äº’ (Interaction)â€** ä¸Šï¼Œè€Œä¸æ˜¯â€œå¯¹è±¡â€ä¸Šã€‚äº¤äº’ç»“æŸï¼ŒScope å…³é—­ï¼ŒçŠ¶æ€å³ç„šã€‚

### 9.5 Final Verdict (æœ€ç»ˆå†³ç­–)

åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘ä»¬ç¡®è®¤ **Draft Pattern** æ˜¯ Logix v3 çš„æœ€ä½³é€‰æ‹©ã€‚å®ƒä¸æ˜¯å¯¹ç°æœ‰åº“çš„ç®€å•æ¨¡ä»¿ï¼Œè€Œæ˜¯ **Effect-Native æ¶æ„ä¸‹çš„æœ€ä¼˜è§£**ï¼š

1.  **æ¶æ„å®šä½**: å®ƒæ˜¯ **STM (è½¯ä»¶äº‹åŠ¡å†…å­˜)** åœ¨å‰ç«¯äº¤äº’é¢†åŸŸçš„å·¥ç¨‹åŒ–æŠ•å½±ã€‚
2.  **æ ¸å¿ƒåˆ›æ–°**:
    *   ç”¨ **Scope** è§£å†³ç”Ÿå‘½å‘¨æœŸé—®é¢˜ (vs MobX/XState)ã€‚
    *   ç”¨ **Ref** è§£å†³éš”ç¦»æ€§é—®é¢˜ (vs Redux)ã€‚
    *   ç”¨ **Transaction** è§£å†³åŸå­æ€§é—®é¢˜ (vs React State)ã€‚
3.  **DX æ‰¿è¯º**: ä¿æŒ API çš„å£°æ˜å¼ä¸ç®€æ´æ€§ï¼Œè®©å¼€å‘è€…ç”¨å†™æ™®é€š Logic çš„æ–¹å¼å†™äº‹åŠ¡ã€‚

**ç»“è®º**: Draft Pattern å°†ä½œä¸º Logix v3 å¤„ç† Ephemeral Interaction çš„æ ‡å‡†åŸè¯­ï¼Œä¸å†å¼•å…¥ç¬¬ä¸‰æ–¹çŠ¶æ€åº“ã€‚

## 10. Open Questions & Future Work (å¾…å®šäº‹é¡¹)

ä»¥ä¸‹é—®é¢˜å°šæœªåœ¨æœ¬è§„èŒƒä¸­â€œé’‰æ­»â€ï¼Œç•™å¾…åç»­ L3/L2 è‰ç¨¿è¿›ä¸€æ­¥æ¢è®¨ï¼š

1.  **Commit Return Type**: `commit()` æˆåŠŸååº”è¯¥è¿”å›ä»€ä¹ˆï¼Ÿæ˜¯ `void`ï¼Œè¿˜æ˜¯ `Result`ï¼Œè¿˜æ˜¯ `Effect<Result>`ï¼Ÿé”™è¯¯é€šé“å¦‚ä½•å®šä¹‰ï¼Ÿ
2.  **Concurrency**: é‡å¤è°ƒç”¨ `start()` æ—¶çš„è¡Œä¸ºæ˜¯â€œè‡ªåŠ¨é”€æ¯å‰ä¸€ä¸ªâ€è¿˜æ˜¯â€œæŠ›é”™â€ï¼Ÿå¤šç»„ä»¶å…±äº«åŒä¸€ Draft æ—¶çš„å¹¶å‘çº¦æŸå¦‚ä½•è®¾è®¡ï¼Ÿ
3.  **Invariants**: `invariants` æ ¡éªŒæ˜¯å¦æ”¯æŒå¼‚æ­¥ Effectï¼ˆä¾‹å¦‚æœåŠ¡ç«¯å”¯ä¸€æ€§æ ¡éªŒï¼‰ï¼Ÿ
4.  **Composition**: Draft æ˜¯å¦å…è®¸åµŒå¥—ï¼ˆDraft in Draftï¼‰ï¼Ÿæ˜¯å¦å…è®¸ç»„åˆï¼ˆDraft A + Draft Bï¼‰ï¼Ÿ
5.  **Snapshot Compatibility**: åºåˆ—åŒ–åçš„ Snapshot å¦‚æœé‡åˆ°ä»£ç ç‰ˆæœ¬å‡çº§ï¼ˆSchema å˜æ›´ï¼‰ï¼Œå¦‚ä½•åšå…¼å®¹æˆ–è¿ç§»ï¼Ÿ
</file>

<file path="drafts/topics/draft-pattern/01-contract.md">
---
title: Draft Pattern Contract (Type Definitions & Runtime)
status: draft
version: 1.0
---

# Draft Pattern Contract

> **Status**: L3 (Proposed Contract)
> **Context**: `v3/effect-runtime`

æœ¬è‰ç¨¿æ—¨åœ¨â€œé’‰æ­»â€ Draft Pattern çš„æ ¸å¿ƒç±»å‹å®šä¹‰ä¸è¿è¡Œæ—¶è¡Œä¸ºå¥‘çº¦ï¼Œä¸ºåç»­è¿›å…¥ `runtime-logix` å®ç°å±‚åšå‡†å¤‡ã€‚

## 1. Core Type Definitions

### 1.1 `Draft.make` Signature

```typescript
export interface DraftDefinition<
  State,
  Context,
  Computed = {},
  Events = unknown
> {
  readonly id: string;
  readonly schema: {
    readonly state: Schema.Schema<State>;
    readonly context: Schema.Schema<Context>;
  };
  readonly initial: (ctx: Context) => State;
  readonly logic: (
    $: DraftRuntime<State, Context, Computed, Events>
  ) => Effect.Effect<void, never, Scope>;

  // Optional
  readonly computed?: (state: State) => Computed;
  readonly invariants?: ReadonlyArray<(state: State) => boolean>;
}

export declare const make: <S, C, Comp, E>(
  def: DraftDefinition<S, C, Comp, E>
) => Draft<S, C, Comp, E>;
```

### 1.2 Runtime Interface (`$.draft`)

```typescript
export interface DraftRuntime<S, C, Comp, E> {
  // State Access
  readonly state: SubscriptionRef<S>;
  readonly context: C;
  readonly computed: SubscriptionRef<Comp>;

  // Lifecycle Hooks
  readonly lifecycle: {
    readonly onStart: (cb: () => Effect.Effect<void>) => Effect.Effect<void>;
    readonly onCommit: (cb: (s: S) => Effect.Effect<void>) => Effect.Effect<void>;
    readonly onDestroy: (cb: () => Effect.Effect<void>) => Effect.Effect<void>;
  };
}
```

## 2. Runtime Behavior Contract

### 2.1 `start(Draft, Context)`

*   **Signature**: `start<S, C>(draft: Draft<S, C>, ctx: C): Effect.Effect<DraftHandle<S>, DraftAlreadyStartedError>`
*   **Concurrency**:
    *   **Singleton Mode (Default)**: åŒä¸€ä¸ª Draft ID å…¨å±€åªèƒ½å­˜åœ¨ä¸€ä¸ªå®ä¾‹ã€‚
    *   **Behavior**: å¦‚æœå°è¯•å¯åŠ¨å·²å­˜åœ¨çš„ Draftï¼Œé»˜è®¤æŠ›å‡º `DraftAlreadyStartedError`ã€‚
    *   *Option*: æ”¯æŒ `{ behavior: 'replace' }` é€‰é¡¹ï¼Œè‡ªåŠ¨é”€æ¯æ—§å®ä¾‹å¹¶å¯åŠ¨æ–°å®ä¾‹ã€‚
*   **Lifecycle**: åˆ›å»ºæ–°çš„ `Effect.Scope`ï¼Œåˆå§‹åŒ– State Refï¼ŒæŒ‚è½½ Logic Fiberã€‚

### 2.2 `commit(Draft)`

*   **Signature**: `commit<S>(draft: Draft<S>): Effect.Effect<S, ValidationError | InvariantError>`
*   **Locking**: Commit è¿‡ç¨‹å¿…é¡»åŠ é”ï¼ŒæœŸé—´æ‹’ç»ä»»ä½• State Updateã€‚
*   **Validation**:
    1.  Schema Validation (Type Check)
    2.  Invariant Validation (Logic Check)
*   **Result**: æˆåŠŸåˆ™è¿”å›æœ€ç»ˆ State Snapshotï¼Œå¤±è´¥åˆ™é€šè¿‡ Error Channel è¿”å›é”™è¯¯ã€‚
*   **Side Effects**: è§¦å‘ `onCommit` é’©å­ã€‚

### 2.3 `destroy(Draft)`

*   **Signature**: `destroy(draft: Draft): Effect.Effect<void>`
*   **Behavior**: å…³é—­ Draft å…³è”çš„ `Scope`ã€‚
*   **Cleanup**: è‡ªåŠ¨å–æ¶ˆæ‰€æœ‰ fork çš„ Fiberï¼Œé‡Šæ”¾èµ„æºã€‚

## 3. Error Boundaries

| Error Type | Source | Handling |
| :--- | :--- | :--- |
| **SchemaError** | `state` ä¸ç¬¦åˆ Schema å®šä¹‰ | è§†ä¸º Defect (å¼€å‘æ—¶é”™è¯¯)ï¼Œé€šå¸¸ä¼šå¯¼è‡´ Crash |
| **ValidationError** | ç”¨æˆ·è¾“å…¥ä¸åˆæ³• (e.g. å¿…å¡«é¡¹ä¸ºç©º) | è§†ä¸º Expected Errorï¼ŒUI åº”æ•è·å¹¶æç¤º |
| **InvariantError** | è¿åä¸šåŠ¡ä¸å˜é‡ (e.g. ä½™é¢ä¸è¶³) | è§†ä¸º Expected Errorï¼ŒUI åº”æ•è·å¹¶æç¤º |
| **DraftAlreadyStarted** | é‡å¤å¯åŠ¨ Draft | è§†ä¸º Logic Errorï¼Œå¼€å‘è€…éœ€æ£€æŸ¥æµç¨‹ |

## 4. Implementation Notes

*   **Computed State**: ä½¿ç”¨ `Effect.map(state$, computeFn)` å®ç°ï¼Œå¹¶ç”¨ `SubscriptionRef` åŒ…è£…ä»¥æ”¯æŒè®¢é˜…ã€‚
*   **Scope Management**: ä½¿ç”¨ `Effect.scope` æˆ– `Scope.make` æ‰‹åŠ¨ç®¡ç† Scope çš„å¼€å¯ä¸å…³é—­ã€‚
</file>

<file path="drafts/topics/draft-pattern/10-react-integration.md">
---
title: Draft Pattern React Integration & DX
status: draft
version: 1.0
---

# Draft Pattern React Integration & DX

> **Status**: L4 (Practice & Cookbook)
> **Context**: `v3/react-integration`

æœ¬è‰ç¨¿å…³æ³¨ Draft Pattern åœ¨ React ç¯å¢ƒä¸‹çš„å·¥ç¨‹å®è·µï¼Œé‡ç‚¹è§£å†³â€œæ€ä¹ˆç”¨å¾—çˆ½â€çš„é—®é¢˜ã€‚

## 1. The `useDraft` Hook

### 1.1 Signature

```typescript
function useDraft<S, C, Comp, A>(draft: Draft<S, C, Comp, any, A>): {
  state: S | null;        // null if not started
  computed: Comp | null;
  actions: A;             // Strongly typed actions
  status: 'idle' | 'starting' | 'ready' | 'committing' | 'destroyed';
  error: Error | null;    // Runtime/Validation errors
  commit: () => Promise<S | Command>;
  destroy: () => void;
}
```

### 1.2 Key Implementation Details

*   **Automatic Subscription**: å†…éƒ¨ä½¿ç”¨ `useSubscription` (or `useSyncExternalStore`) è®¢é˜… `DraftRuntime.state`ã€‚
*   **Concurrency Safety**: åœ¨ React 18 Concurrent Mode ä¸‹ï¼Œç¡®ä¿ Subscription ä¸ä¼šå› ä¸º Tearing å¯¼è‡´ UI ä¸ä¸€è‡´ã€‚
*   **Null Handling**: å½“ Draft æœªå¯åŠ¨æ—¶ï¼Œ`state` è¿”å› `null`ã€‚ç»„ä»¶å±‚é€šå¸¸éœ€è¦å¤„ç†è¿™ä¸ªç©ºçŠ¶æ€ï¼ˆæˆ–å°è£… `<DraftGuard>` ç»„ä»¶ï¼‰ã€‚

## 2. UI Cookbook (å…¸å‹åœºæ™¯)

### 2.1 The "Wizard" (åˆ†æ­¥å‘å¯¼)

**åœºæ™¯**: ç”¨æˆ·ç‚¹å‡»â€œåˆ›å»ºé¡¹ç›®â€ï¼Œå¼¹å‡ºä¸€ä¸ª 3 æ­¥å‘å¯¼ã€‚

```tsx
const CreateProjectWizard = () => {
  const { state, actions, commit } = useDraft(CreateProjectDraft);

  if (!state) return null; // Or <Loading />

  return (
    <Modal open={true}>
      <Steps current={state.step} />

      {state.step === 1 && <BasicInfoForm />}
      {state.step === 2 && <MemberSelectForm />}

      <Footer>
        <Button onClick={actions.prev}>Back</Button>
        {state.step < 3 ? (
          <Button onClick={actions.next}>Next</Button>
        ) : (
          <Button onClick={commit}>Create</Button>
        )}
      </Footer>
    </Modal>
  );
};
```

### 2.2 The "Bulk Edit" (æ‰¹é‡ç¼–è¾‘)

**åœºæ™¯**: åœ¨åˆ—è¡¨ä¸­å‹¾é€‰ 10 è¡Œï¼Œç‚¹å‡»â€œæ‰¹é‡ä¿®æ”¹çŠ¶æ€â€ã€‚

**Pattern**:
1.  `start(BulkEditDraft, { ids: selectedIds })`
2.  Draft å†…éƒ¨åˆå§‹åŒ– Stateï¼Œæ‹‰å–è¿™ 10 è¡Œçš„å½“å‰çŠ¶æ€ã€‚
3.  ç”¨æˆ·ä¿®æ”¹ï¼ŒDraft State æ›´æ–°ã€‚
4.  `commit()` -> äº§ç”Ÿ `BatchUpdateCommand` -> å‘é€ç»™åç«¯ã€‚

### 2.3 The "Canvas Drag" (ç”»å¸ƒæ‹–æ‹½)

**åœºæ™¯**: æ‹–æ‹½èŠ‚ç‚¹ç§»åŠ¨ã€‚

**Optimization**:
*   ä¸è¦æŠŠ `x, y` å­˜å…¥ Domain Storeã€‚
*   ä½¿ç”¨ Draft å­˜å‚¨ `draggingNodeId` å’Œ `currentPosition`ã€‚
*   åªæœ‰ç”»å¸ƒå±‚è®¢é˜… Draftï¼Œå…¶ä»–ç»„ä»¶ä¸å—å½±å“ï¼ˆé¿å… Re-renderï¼‰ã€‚
*   æ‹–æ‹½ç»“æŸ -> `commit()` -> æ›´æ–° Domain Storeã€‚

## 3. Router Integration

**é—®é¢˜**: ç”¨æˆ·ç‚¹å‡»æµè§ˆå™¨â€œåé€€â€æŒ‰é’®ï¼ŒDraft åº”è¯¥é”€æ¯å—ï¼Ÿ

**ç­–ç•¥**:
1.  **Bind to Route**: å°† Draft çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåˆ°æŸä¸ª Routeï¼ˆä¾‹å¦‚ `/projects/new`ï¼‰ã€‚Route é€€å‡º -> Draft Destroyã€‚
2.  **Manual Control**: åœ¨ Modal åœºæ™¯ä¸‹ï¼ŒDraft ç‹¬ç«‹äº Routeã€‚éœ€è¦ç›‘å¬ `LocationChange` äº‹ä»¶æ‰‹åŠ¨é”€æ¯ï¼Œæˆ–ä¾é  Modal çš„ `onClose`ã€‚
</file>

<file path="drafts/topics/draft-pattern/20-boundary-analysis.md">
---
title: Draft Pattern vs Flow/Domain Boundary
status: draft
version: 1.0
---

# Draft Pattern vs Flow/Domain Boundary

> **Status**: L5 (Architecture Exploration)
> **Context**: `v3/architecture`

æœ¬è‰ç¨¿æ¢è®¨ Draft Pattern åœ¨ Logix æ•´ä½“æ¶æ„ä¸­çš„å®šä½ï¼Œç‰¹åˆ«æ˜¯å®ƒä¸ Flow DSL å’Œ Domain Service çš„è¾¹ç•Œã€‚

## 1. The "Interaction" vs "Domain" Split

æˆ‘ä»¬æ˜ç¡®åŒºåˆ†ä¸¤ç§çŠ¶æ€ï¼š

| ç‰¹æ€§ | Interaction State (Draft) | Domain State (Store) |
| :--- | :--- | :--- |
| **ç”Ÿå‘½å‘¨æœŸ** | çŸ­æ´» (Ephemeral)ï¼Œéšäº¤äº’ç»“æŸè€Œé”€æ¯ | é•¿æ´» (Long-lived)ï¼Œéšåº”ç”¨/é¡µé¢å­˜åœ¨ |
| **æ•°æ®æº** | ç”¨æˆ·è¾“å…¥ (User Input) | æœåŠ¡ç«¯æ•°æ® (Server Data) |
| **ä¸€è‡´æ€§** | æœ€ç»ˆä¸€è‡´ (Eventually Consistent) | å¼ºä¸€è‡´ (Strongly Consistent) |
| **æ¶ˆè´¹è€…** | UI ç»„ä»¶ (View) | ä¸šåŠ¡é€»è¾‘ (Logic/Flow) |

**è¾¹ç•ŒåŸåˆ™**:
*   Draft **åª** è´Ÿè´£æ”¶é›†å’Œæ ¡éªŒç”¨æˆ·çš„æ„å›¾ã€‚
*   Draft **ä¸** ç›´æ¥ä¿®æ”¹ Domain Storeã€‚
*   Draft é€šè¿‡ `commit()` äº§å‡ºä¸€ä¸ª **Command** (æˆ– Action Payload)ã€‚
*   Flow/Domain æ¶ˆè´¹è¿™ä¸ª Commandï¼Œæ‰§è¡ŒçœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼ˆAPI è°ƒç”¨ã€Store æ›´æ–°ï¼‰ã€‚

## 2. Relationship with Flow DSL

Draft æ˜¯ Flow çš„ä¸€éƒ¨åˆ†ï¼Œè¿˜æ˜¯ç‹¬ç«‹äº Flowï¼Ÿ

### 2.1 Draft as a "Micro-Flow" Container?

Draft å†…éƒ¨çš„ Logic (`$.onState(...)` / `$.onAction(...)`) å®é™…ä¸Šæ˜¯åœ¨è¿è¡Œä¸€ä¸ªå¾®å‹çš„ã€äº¤äº’å¼çš„ Flowã€‚
*   **ç›¸ä¼¼ç‚¹**: éƒ½ä½¿ç”¨ `Effect`ï¼Œéƒ½å“åº” Eventã€‚
*   **ä¸åŒç‚¹**: Draft Logic æ˜¯ **Stateful** çš„ (ç»´æŠ¤ `ref`)ï¼Œè€Œæ ‡å‡† Flow é€šå¸¸æ˜¯ **Stateless** çš„ (å¤„ç† Input -> Output)ã€‚

### 2.2 Integration Pattern

å»ºè®®å°† Draft è§†ä¸º Flow ä¸­çš„ä¸€ä¸ª **Step**ã€‚

```typescript
// Main Flow
const MainFlow = Flow.make(function* ($) {
  // Step 1: Start Interaction
  const result = yield* $.draft.run(WizardDraft);
  // run() = start() + wait for commit() + destroy()

  // Step 2: Process Result (Domain Logic)
  yield* $.domain.createProject(result);
});
```

è¿™ç§æ¨¡å¼ä¸‹ï¼ŒDraft å°è£…äº†æ‰€æœ‰å¤æ‚çš„äº¤äº’ç»†èŠ‚ï¼Œå¯¹ä¸Šå±‚ Flow æš´éœ²ä¸ºä¸€ä¸ªç®€å•çš„ã€è¿”å› Result çš„ Effectã€‚

## 3. Future Exploration

*   **Unified Replay**: å¦‚æœ Draft å†…éƒ¨ä¹Ÿæ˜¯ Event Sourcing çš„ï¼Œæ˜¯å¦å¯ä»¥å°† Draft çš„æ“ä½œæ—¥å¿—åˆå¹¶åˆ°ä¸» Flow çš„æ—¥å¿—ä¸­ï¼Œå®ç°å®Œæ•´çš„â€œäº¤äº’å›æ”¾â€ï¼Ÿ
*   **Server-Side Draft**: æ˜¯å¦å­˜åœ¨éœ€è¦æœåŠ¡ç«¯å‚ä¸çš„ Draftï¼ˆä¾‹å¦‚ï¼šå¤šäººååŒç¼–è¾‘ä¸€ä¸ª Draftï¼‰ï¼Ÿè¿™å¯èƒ½éœ€è¦å°† Draft State åŒæ­¥åˆ° Redisã€‚
</file>

<file path="drafts/topics/draft-pattern/README.md">
---
title: Draft Pattern Â· Topic Overview
status: draft
version: 2025-12-03
value: extension
priority: next
---

# Draft Pattern Â· Topic Overview

æœ¬ Topic è®¨è®ºçš„ **Draft** æ˜¯ Logix v3 ä¸­ç”¨äºå¤„ç†ã€Œç¬æ—¶äº¤äº’ (Ephemeral Interaction)ã€çš„æ¶æ„æ¨¡å¼ï¼Œä¸ `docs/specs/drafts` ç›®å½•ä¸­çš„â€œè‰ç¨¿åˆ†å±‚ä½“ç³»â€æ— ç›´æ¥å…³ç³»ã€‚

æ ¸å¿ƒå…³æ³¨ç‚¹ï¼š

- å°†å¤æ‚äº¤äº’è¿‡ç¨‹å»ºæ¨¡ä¸ºé•¿æ´»äº‹åŠ¡ï¼ˆç±»ä¼¼ STMï¼‰çš„ Draft ä¼šè¯ï¼Œéš”ç¦»äº¤äº’çŠ¶æ€ä¸é¢†åŸŸçŠ¶æ€ï¼›  
- é€šè¿‡æ˜ç¡®çš„ Contract å®šä¹‰ Draft çš„ç±»å‹ç­¾åä¸è¿è¡Œæ—¶è¡Œä¸ºï¼›  
- åœ¨ React ç¯å¢ƒä¸‹æä¾›èˆ’é€‚çš„ `useDraft` / äº‹åŠ¡è¾¹ç•Œ DXï¼Œå¹¶å˜æ¸…ä¸ Flow/Domain çš„è¾¹ç•Œã€‚

## æ–‡æ¡£ç´¢å¼•

- [00-design.md](./00-design.md) Â· Draft Pattern è®¾è®¡ï¼ˆEphemeral Interaction & Transaction çš„æ€»ä½“æ€è·¯ï¼‰  
- [01-contract.md](./01-contract.md) Â· Draft Pattern Contractï¼ˆæ ¸å¿ƒç±»å‹å®šä¹‰ä¸è¿è¡Œæ—¶å¥‘çº¦ï¼‰  
- [10-react-integration.md](./10-react-integration.md) Â· React é›†æˆä¸ DXï¼ˆ`useDraft` Hook ç­‰å®è·µæ–¹æ¡ˆï¼‰  
- [20-boundary-analysis.md](./20-boundary-analysis.md) Â· Draft Pattern vs Flow/Domain è¾¹ç•Œåˆ†æ
</file>

<file path="drafts/topics/platform-patterns/generative-pattern-lifecycle.md">
---
title: Generative Pattern Lifecycle (Refined)
status: draft
version: 2025-11-28
---

# Generative Pattern Lifecycle: ä»å®šä¹‰åˆ°è¿è¡Œçš„å…¨ç”Ÿå‘½å‘¨æœŸ

ä¸ºäº†é€‚åº”å¹³å°ä¾§å¤šæ ·åŒ–çš„äº¤äº’è§¦å‘ï¼ˆå¦‚ï¼šæ‹–æ‹½åˆå§‹åŒ–ã€ç‚¹å‡»é…ç½®ã€å³é”®ç”Ÿæˆã€ä»£ç è¡¥å…¨ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€å¥—æ›´é€šç”¨çš„ API å’Œç”Ÿå‘½å‘¨æœŸæ¨¡å‹ã€‚

å•çº¯çš„â€œå®šä¹‰æ—¶â€å’Œâ€œå‡ºç æ—¶â€äºŒåˆ†æ³•å·²ç»ä¸å¤Ÿç”¨äº†ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ **"äº¤äº’æ—¶ (Interaction Time)"** çš„æ¦‚å¿µã€‚

## 1. ç”Ÿå‘½å‘¨æœŸæ¨¡å‹ (The Lifecycle Model)

æˆ‘ä»¬å°† Pattern çš„ç”Ÿå‘½å‘¨æœŸç»†åˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼š

1.  **Definition (å®šä¹‰)**: æ¶æ„å¸ˆå£°æ˜ Pattern çš„å…ƒæ•°æ®ï¼ˆSlots, Config Schema, AI Promptsï¼‰ã€‚
2.  **Interaction (äº¤äº’)**: å¹³å°æ ¹æ®å…ƒæ•°æ®æ¸²æŸ“ UIï¼Œç”¨æˆ·é€šè¿‡ä¸åŒæ–¹å¼ï¼ˆæ‹–æ‹½ã€å¯¹è¯ã€è¡¨å•ï¼‰æ³¨å…¥æ„å›¾ã€‚
3.  **Synthesis (åˆæˆ)**: å¹³å°/Agent å°†ç”¨æˆ·æ„å›¾è½¬æ¢ä¸ºå…·ä½“çš„ä»£ç ç‰‡æ®µ (AST/Text)ã€‚
4.  **Runtime (è¿è¡Œ)**: å¼•æ“æ‰§è¡Œåˆæˆåçš„ä»£ç ã€‚

## 2. API æ¼”è¿›ï¼š`Pattern.make` çš„é€šç”¨åŒ–

ä¸ºäº†æ”¯æŒå¤šæ ·åŒ–çš„äº¤äº’ï¼Œ`Pattern.make` éœ€è¦æš´éœ²æ›´å¤šçš„ **"äº¤äº’é’©å­ (Interaction Hooks)"**ã€‚

```typescript
// patterns/JobProcessor.ts
export const JobProcessor = Pattern.make("std/job-processor", {
  // 1. åŸºç¡€å…ƒæ•°æ®
  meta: {
    name: "Job Processor",
    description: "é€šç”¨ä»»åŠ¡å¤„ç†ç®¡é“",
    icon: "cpu"
  },

  // 2. æ’æ§½å®šä¹‰ (AI å¡«å……ä½)
  slots: {
    processor: Slot.make({
      input: Schema.Struct({ item: Schema.Any }),
      // äº¤äº’æç¤ºï¼šå‘Šè¯‰å¹³å°è¿™ä¸ª Slot åœ¨ UI ä¸Šæ€ä¹ˆå±•ç¤º
      ui: {
        label: "å¤„ç†é€»è¾‘",
        placeholder: "æè¿°å¦‚ä½•å¤„ç†å•ä¸ªä»»åŠ¡...",
        // è§¦å‘æ¨¡å¼ï¼šç‚¹å‡»æ—¶å¼¹å‡º AI å¯¹è¯æ¡†
        trigger: "ai-dialog"
      },
      ai: { instruction: "..." }
    })
  },

  // 3. é…ç½®å®šä¹‰ (é™æ€è¡¨å•)
  config: Schema.Struct({
    concurrency: Schema.Number
  }),

  // 4. (æ–°å¢) é¢„è®¾/æ¨¡æ¿ (Presets)
  // å…è®¸ Pattern æºå¸¦ä¸€äº›â€œé»˜è®¤å¡«æ³•â€ï¼Œæ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿå¼€å§‹
  presets: [
    {
      name: "S3 Upload",
      description: "ä¸Šä¼ æ•°æ®åˆ° S3",
      config: { concurrency: 5 },
      // é¢„å¡«çš„ Slot æ„å›¾ (Intent)ï¼Œè€Œéä»£ç 
      intent: {
        processor: "å°† item è½¬æ¢ä¸º JSON å¹¶ä¸Šä¼ åˆ° S3 Bucket 'my-bucket'"
      }
    }
  ]
}, ...);
```

## 3. å¹³å°ä¾§çš„é€šç”¨æ¶ˆè´¹é€»è¾‘

å¹³å°ä¸å†ç¡¬ç¼–ç â€œç‚¹å‡» Slot å¼¹å‡º AIâ€ï¼Œè€Œæ˜¯æ ¹æ® `Slot.ui.trigger` åŠ¨æ€å†³å®šäº¤äº’æ–¹å¼ã€‚

### åœºæ™¯ Aï¼šæ‹–æ‹½åˆå§‹åŒ– (Drag & Drop)
*   ç”¨æˆ·æ‹–æ‹½ Pattern åˆ°ç”»å¸ƒã€‚
*   å¹³å°æ£€æŸ¥ `presets`ã€‚å¦‚æœæœ‰ï¼Œå¼¹çª—è®©ç”¨æˆ·é€‰æ‹©é¢„è®¾ã€‚
*   ç”¨æˆ·é€‰æ‹© "S3 Upload"ã€‚
*   å¹³å°è‡ªåŠ¨å°†é¢„è®¾çš„ `intent` å¡«å…¥ Slotï¼Œå¹¶è§¦å‘åå°é™é»˜ç”Ÿæˆä»£ç ã€‚

### åœºæ™¯ Bï¼šä»£ç è¡¥å…¨ (IntelliSense)
*   ç”¨æˆ·åœ¨ VSCode/Monaco ä¸­æ‰‹åŠ¨è¾“å…¥ `JobProcessor.use({ ... })`ã€‚
*   å½“å…‰æ ‡åœåœ¨ `processor:` åé¢æ—¶ã€‚
*   LSP (Language Server) è¯»å– `Slot.ai.instruction`ã€‚
*   Copilot/Agent è‡ªåŠ¨æç¤ºï¼š"æ˜¯å¦æ ¹æ®å½“å‰ä¸Šä¸‹æ–‡ç”Ÿæˆå¤„ç†é€»è¾‘ï¼Ÿ"

### åœºæ™¯ Cï¼šå³é”®èœå• (Context Menu)
*   ç”¨æˆ·å³é”®ç‚¹å‡»ç”»å¸ƒä¸Šçš„èŠ‚ç‚¹ã€‚
*   èœå•æ˜¾ç¤º "Regenerate Logic (AI)"ã€‚
*   ç‚¹å‡»åï¼Œè¯»å–å½“å‰ Slot å·²æœ‰çš„ä»£ç ä½œä¸º Contextï¼Œé‡æ–°è§¦å‘ç”Ÿæˆã€‚

## 4. æ€»ç»“

é€šè¿‡å¼•å…¥ **`ui` (äº¤äº’æç¤º)** å’Œ **`presets` (é¢„è®¾æ„å›¾)**ï¼Œæˆ‘ä»¬å°† Pattern ä»ä¸€ä¸ªé™æ€çš„ä»£ç æ¨¡æ¿ï¼Œå˜æˆäº†ä¸€ä¸ª **"å¯äº¤äº’çš„æ™ºèƒ½ç»„ä»¶"**ã€‚

è¿™ä½¿å¾—å¹³å°å¯ä»¥çµæ´»åœ°é€‚é…å„ç§æ“ä½œæµï¼ˆæ‹–æ‹½ã€ç¼–ç ã€å¯¹è¯ï¼‰ï¼Œè€Œæ— éœ€ä¿®æ”¹ Pattern å®šä¹‰æœ¬èº«ã€‚
</file>

<file path="drafts/topics/platform-patterns/generative-pattern-scenarios.md">
---
title: Generative Pattern Scenarios (ToB Analysis)
status: draft
version: 2025-11-28
---

# Generative Pattern å®æˆ˜åœºæ™¯åˆ†æ (ToB)

æœ¬æ–‡æ¡£é€šè¿‡ä¸‰ä¸ªå…¸å‹çš„ ToB ä¸šåŠ¡åœºæ™¯ï¼Œæ·±å…¥åˆ†æ **Generative Pattern (AI Slots)** åœ¨å…¨é“¾è·¯ä¸­çš„å®é™…ä»·å€¼ä¸è¿ä½œæ–¹å¼ï¼ŒéªŒè¯å…¶å¿…è¦æ€§ã€‚

## åœºæ™¯ä¸€ï¼šå¤æ‚å®¡æ‰¹æµ (Approval Workflow)

è¿™æ˜¯ ToB ç³»ç»Ÿä¸­æœ€å¸¸è§çš„â€œéª¨æ¶ + å·®å¼‚â€åœºæ™¯ã€‚

### 1. ç—›ç‚¹
*   **éª¨æ¶é€šç”¨**: ä¸²è¡Œ/å¹¶è¡Œå®¡æ‰¹ã€è¶…æ—¶æé†’ã€é©³å›å›é€€ã€æ—¥å¿—è®°å½•ã€‚è¿™äº›é€»è¾‘éå¸¸å¤æ‚ä¸”æ¯ç‡¥ï¼Œæ¯ä¸ªä¸šåŠ¡éƒ½è¦å†™ä¸€éã€‚
*   **å·®å¼‚å·¨å¤§**: æ¯ä¸ªèŠ‚ç‚¹çš„â€œå®¡æ‰¹äººè®¡ç®—è§„åˆ™â€ã€â€œè‡ªåŠ¨é€šè¿‡è§„åˆ™â€åƒå·®ä¸‡åˆ«ï¼ˆå¦‚ï¼šé‡‘é¢>500ä¸”ç§‘ç›®æ˜¯å·®æ—…ï¼‰ã€‚

### 2. Pattern å®šä¹‰ (Architect)
```typescript
// patterns/ApprovalFlow.ts
export const ApprovalFlow = Pattern.make("std/approval", {
  config: Schema.Struct({
    nodes: Schema.Array(Schema.String), // èŠ‚ç‚¹åç§°åˆ—è¡¨
    timeout: Schema.Number // è¶…æ—¶æ—¶é—´
  }),
  slots: {
    // å·®å¼‚ç‚¹ï¼šå¦‚ä½•è®¡ç®—æŸä¸ªèŠ‚ç‚¹çš„å®¡æ‰¹äººï¼Ÿ
    approverResolver: Slot.make({
      input: Schema.Struct({ node: Schema.String, context: Schema.Any }),
      output: Schema.Array(Schema.String), // è¿”å› UserID åˆ—è¡¨
      ai: { instruction: "æ ¹æ®èŠ‚ç‚¹åç§°å’Œä¸Šä¸‹æ–‡ï¼Œè®¡ç®—å®¡æ‰¹äººåˆ—è¡¨ã€‚" }
    }),
    // å·®å¼‚ç‚¹ï¼šæ˜¯å¦è‡ªåŠ¨é€šè¿‡ï¼Ÿ
    autoPassRule: Slot.make({
      input: Schema.Struct({ node: Schema.String, context: Schema.Any }),
      output: Schema.Boolean,
      ai: { instruction: "åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³è‡ªåŠ¨é€šè¿‡æ¡ä»¶ã€‚" }
    })
  }
}, ...);
```

### 3. ä¸šåŠ¡è½åœ° (Developer + AI)
*   **User Intent**: "å·®æ—…è´¹æŠ¥é”€å®¡æ‰¹ã€‚å¦‚æœé‡‘é¢å°äº 200ï¼Œç›´æ¥é€šè¿‡ï¼›å¦åˆ™éœ€è¦éƒ¨é—¨ç»ç†å®¡æ‰¹ã€‚"
*   **AI ç”Ÿæˆ (Slot Implementation)**:
    *   `autoPassRule`: ç”Ÿæˆä»£ç æ£€æŸ¥ `context.amount < 200`ã€‚
    *   `approverResolver`: ç”Ÿæˆä»£ç è°ƒç”¨ `DeptService.getManager(context.applicantId)`ã€‚
*   **ä»·å€¼**: å¼€å‘è€…åªéœ€å…³æ³¨ä¸šåŠ¡è§„åˆ™ï¼Œå®Œå…¨ä¸ç”¨ç®¡â€œè¶…æ—¶æ€ä¹ˆå¤„ç†â€ã€â€œé©³å›æ€ä¹ˆå›æ»šâ€è¿™äº›å¤æ‚çš„æµç¨‹æ§åˆ¶ã€‚

---

## åœºæ™¯äºŒï¼šæ•°æ®å¯¼å…¥ä¸æ¸…æ´— (Data Import & ETL)

### 1. ç—›ç‚¹
*   **éª¨æ¶é€šç”¨**: æ–‡ä»¶è¯»å– (Excel/CSV)ã€åˆ†æ‰¹å¤„ç†ã€è¿›åº¦æ¡æ›´æ–°ã€é”™è¯¯æ”¶é›†ã€äº‹åŠ¡æäº¤ã€‚
*   **å·®å¼‚å·¨å¤§**: æ¯ä¸€åˆ—çš„æ ¡éªŒè§„åˆ™ã€æ¸…æ´—é€»è¾‘ï¼ˆå¦‚ï¼šæ‰‹æœºå·æ ¼å¼åŒ–ã€å­—å…¸å€¼æ˜ å°„ï¼‰ã€‚

### 2. Pattern å®šä¹‰ (Architect)
```typescript
// patterns/BatchImporter.ts
export const BatchImporter = Pattern.make("std/importer", {
  slots: {
    // å·®å¼‚ç‚¹ï¼šå•è¡Œæ•°æ®æ¸…æ´—ä¸æ ¡éªŒ
    processRow: Slot.make({
      input: Schema.Struct({ row: Schema.Record(Schema.String, Schema.Any) }),
      output: Schema.Option(Schema.Any), // è¿”å›æ¸…æ´—åçš„æ•°æ®ï¼ŒNone ä»£è¡¨ä¸¢å¼ƒ
      ai: { instruction: "æ¸…æ´—å•è¡Œæ•°æ®ã€‚å¦‚æœæ•°æ®æ— æ•ˆè¿”å› Noneï¼Œå¦åˆ™è¿”å›æ¸…æ´—åçš„å¯¹è±¡ã€‚" }
    })
  }
}, ($, { slots }) => Effect.gen(function*() {
  // éª¨æ¶ï¼šè´Ÿè´£æµå¼è¯»å– Excelï¼Œæ§åˆ¶å¹¶å‘ä¸º 10ï¼Œæ¯ 100 æ¡é€šè¿‡ SSE æ¨é€è¿›åº¦
  // éª¨æ¶ï¼šè´Ÿè´£æ”¶é›† processRow è¿”å›çš„ Errorï¼Œæœ€åç”Ÿæˆé”™è¯¯æŠ¥å‘Š Excel
  // ...
}));
```

### 3. ä¸šåŠ¡è½åœ° (Developer + AI)
*   **User Intent**: "å¯¼å…¥å‘˜å·¥åå•ã€‚æŠŠ 'å…¥èŒæ—¥æœŸ' è½¬æˆ ISO æ ¼å¼ï¼Œ'éƒ¨é—¨' æ˜ å°„æˆ IDã€‚å¦‚æœ 'æ‰‹æœºå·' ä¸ºç©ºåˆ™è·³è¿‡ã€‚"
*   **AI ç”Ÿæˆ**:
    *   `processRow`: ç”Ÿæˆä»£ç è§£ææ—¥æœŸã€æŸ¥è¯¢å­—å…¸æ˜ å°„éƒ¨é—¨ã€æ£€æŸ¥æ‰‹æœºå·ã€‚
*   **ä»·å€¼**: æå¤§åœ°é™ä½äº† ETL ä»»åŠ¡çš„å¼€å‘é—¨æ§›ã€‚å¼€å‘è€…ä»¥å‰è¦å†™å‡ ç™¾è¡Œä»£ç å¤„ç† Excel æµå’Œå¹¶å‘ï¼Œç°åœ¨åªéœ€è¦å†™ï¼ˆæˆ–è®© AI å†™ï¼‰ä¸€ä¸ªçº¯å‡½æ•°ã€‚

---

## åœºæ™¯ä¸‰ï¼šå¤–éƒ¨ API é›†æˆ (Third-party Integration)

### 1. ç—›ç‚¹
*   **éª¨æ¶é€šç”¨**: OAuth2 Token åˆ·æ–°ä¸ç¼“å­˜ã€é™æµé‡è¯• (Rate Limiting)ã€ç†”æ–­é™çº§ã€ç»Ÿä¸€æ—¥å¿—å®¡è®¡ã€‚
*   **å·®å¼‚å·¨å¤§**: å…·ä½“ API çš„è¯·æ±‚å‚æ•°æ„é€ ã€å“åº”ç»“æœé€‚é…ã€‚

### 2. Pattern å®šä¹‰ (Architect)
```typescript
// patterns/ApiClient.ts
export const ApiClient = Pattern.make("std/api-client", {
  slots: {
    // å·®å¼‚ç‚¹ï¼šæ„é€ è¯·æ±‚
    buildRequest: Slot.make({
      input: Schema.Struct({ params: Schema.Any }),
      output: Schema.Struct({ url: Schema.String, method: Schema.String, body: Schema.Any }),
      ai: { instruction: "æ ¹æ®ä¸šåŠ¡å‚æ•°æ„é€  HTTP è¯·æ±‚å¯¹è±¡ã€‚" }
    }),
    // å·®å¼‚ç‚¹ï¼šé€‚é…å“åº”
    adaptResponse: Slot.make({
      input: Schema.Any, // åŸå§‹ JSON
      output: Schema.Any, // ä¸šåŠ¡æ¨¡å‹
      ai: { instruction: "å°† API å“åº”è½¬æ¢ä¸ºä¸šåŠ¡æ‰€éœ€çš„æ ¼å¼ã€‚" }
    })
  }
}, ($, { slots }) => Effect.gen(function*() {
  // éª¨æ¶ï¼šè´Ÿè´£æ£€æŸ¥ Tokenï¼Œå¦‚æœè¿‡æœŸè‡ªåŠ¨åˆ·æ–°
  // éª¨æ¶ï¼šè´Ÿè´£è°ƒç”¨ fetchï¼Œå¦‚æœ 429 åˆ™è‡ªåŠ¨é€€é¿é‡è¯•
  // ...
}));
```

### 3. ä¸šåŠ¡è½åœ° (Developer + AI)
*   **User Intent**: "å¯¹æ¥é£ä¹¦å‘æ¶ˆæ¯æ¥å£ã€‚"
*   **AI ç”Ÿæˆ**:
    *   `buildRequest`: ç”Ÿæˆä»£ç æ„é€ é£ä¹¦çš„ JSON Bodyã€‚
    *   `adaptResponse`: æå– `message_id`ã€‚
*   **ä»·å€¼**: ä¿è¯äº†æ‰€æœ‰å¤–éƒ¨è°ƒç”¨éƒ½è‡ªåŠ¨å…·å¤‡äº†â€œä¼ä¸šçº§â€çš„å¥å£®æ€§ï¼ˆé‡è¯•ã€ç†”æ–­ã€å®¡è®¡ï¼‰ï¼Œè€Œä¸ä¼šå› ä¸ºå¼€å‘è€…æ°´å¹³å‚å·®ä¸é½è€Œç•™ä¸‹éšæ‚£ã€‚

---

## æ€»ç»“ï¼šå…¨é“¾è·¯åˆ†æç»“è®º

é€šè¿‡è¿™ä¸‰ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ° **Generative Pattern** çš„æ ¸å¿ƒä»·å€¼ï¼š

1.  **å±è”½å¤æ‚æ€§ (Encapsulation)**: éª¨æ¶å°è£…äº†å¹¶å‘ã€äº‹åŠ¡ã€é‡è¯•ç­‰â€œé«˜éš¾åº¦â€æŠ€æœ¯ç»†èŠ‚ã€‚
2.  **èšç„¦ä¸šåŠ¡ (Focus)**: Slot å¼ºè¿«å¼€å‘è€…ï¼ˆå’Œ AIï¼‰åªå…³æ³¨â€œä¸šåŠ¡è§„åˆ™â€æœ¬èº«ã€‚
3.  **æ ‡å‡†åŒ– (Standardization)**: å¼ºç±»å‹çš„ Slot æ¥å£ä¿è¯äº† AI ç”Ÿæˆçš„ä»£ç å¿…é¡»ç¬¦åˆå¥‘çº¦ï¼Œæå¤§åœ°æé«˜äº†ç”Ÿæˆä»£ç çš„å¯ç”¨æ€§ã€‚

**ç»“è®º**: åœ¨ ToB è¿™ç§é€»è¾‘å¤æ‚åº¦é«˜ã€ç¨³å®šæ€§è¦æ±‚ä¸¥çš„åœºæ™¯ä¸‹ï¼Œå¼•å…¥ `Pattern` å’Œ `Slot` æ˜¯å®ç° **"AI è¾…åŠ©çš„é«˜è´¨é‡å¼€å‘"** çš„å¿…ç»ä¹‹è·¯ã€‚
</file>

<file path="drafts/topics/platform-patterns/generative-patterns-refined.md">
---
title: Generative Patterns & AI Slots (Refined)
status: draft
version: 2025-11-28
---

# Generative Patterns & AI Slots (Refined)

æœ¬æ–‡æ¡£åŸºäº `L3/api-evolution/generative-patterns.md` çš„åˆç¨¿ï¼Œç»“åˆæœ€æ–°çš„æ¶æ„æ€è€ƒï¼Œè¿›ä¸€æ­¥ç»†åŒ– **"æ¶æ„å¸ˆå®šä¹‰éª¨æ¶ï¼ŒAI æ™ºèƒ½å¡«å……è¡€è‚‰"** çš„å®ç°æœºåˆ¶ã€‚

## 1. æ ¸å¿ƒç†å¿µ (Core Concept)

æˆ‘ä»¬å°† Pattern ä»å•çº¯çš„ Effect å‡½æ•°ï¼Œå‡çº§ä¸ºä¸€ä¸ª **åŒ…å«â€œå¾…å¡«å……åŒºåŸŸâ€æè¿°çš„å¯Œèµ„äº§åŒ…**ã€‚

*   **Pattern = Flow Skeleton + AI Slots**
*   **Slot = Interface Contract + AI Prompt**

è¿™ä½¿å¾— Logix å¹³å°ä¸ä»…æ˜¯ä¸€ä¸ªä»£ç åº“ï¼Œæ›´æ˜¯ä¸€ä¸ª **â€œæ™ºèƒ½é€»è¾‘è£…é…å·¥å‚â€**ã€‚

## 2. API è®¾è®¡ (API Design)

æˆ‘ä»¬å¼•å…¥ `Pattern.make` å’Œ `Slot.make` (éµå¾ª `*.make` å‘½åè§„èŒƒ)ã€‚

### 2.1 å®šä¹‰æ—¶ (Definition Time) â€”â€” æ¶æ„å¸ˆè§†è§’

æ¶æ„å¸ˆåœ¨å®šä¹‰ Pattern æ—¶ï¼Œæ˜¾å¼å£°æ˜å“ªäº›éƒ¨åˆ†æ˜¯ç•™ç»™ AI å¡«å……çš„ã€‚

```typescript
// patterns/JobProcessor.ts
import { Pattern, Slot } from '@logix/core';
import { Schema } from 'effect';

// 1. å®šä¹‰ Slot (ç©ºæ´)
const ProcessItemSlot = Slot.make({
  id: "process-item",
  description: "å¤„ç†å•ä¸ªä»»åŠ¡é¡¹çš„å…·ä½“é€»è¾‘",
  // å¼ºç±»å‹å¥‘çº¦
  input: Schema.Struct({ item: Schema.Any, context: Schema.Record(Schema.String, Schema.Any) }),
  output: Schema.Void,
  // é€‰é¡¹é…ç½®
  optional: false, // æ˜¯å¦å¯é€‰
  default?: (ctx) => Effect.void, // é»˜è®¤å®ç°
  // AI æç¤ºè¯é…ç½® (å…³é”®ï¼)
  ai: {
    instruction: "ç¼–å†™å¤„ç†å•ä¸ªä»»åŠ¡é¡¹çš„é€»è¾‘ã€‚é€šå¸¸åŒ…æ‹¬è°ƒç”¨å¤–éƒ¨ API æˆ–è½¬æ¢æ•°æ®ã€‚",
    contextKeys: ["availableServices", "currentStoreSchema"] // å‘Šè¯‰ Agent éœ€è¦å“ªäº›ä¸Šä¸‹æ–‡
  }
});

// 2. å®šä¹‰ Pattern (éª¨æ¶)
export const JobProcessor = Pattern.make("std/job-processor", {
  version: "1.0.0", // æ˜¾å¼ç‰ˆæœ¬å·
  slots: {
    processor: ProcessItemSlot // æ³¨å†Œæ’æ§½
  },
  config: Schema.Struct({
    concurrency: Schema.Number.pipe(Schema.default(5))
  })
}, ($, { slots, config }) =>
  Effect.gen(function* () {
    // æ¶æ„å¸ˆç¼–å†™é€šç”¨çš„è°ƒåº¦ã€é‡è¯•ã€é”™è¯¯å¤„ç†é€»è¾‘
    const queue = yield* $.use(JobQueueService);

    yield* queue.poll().pipe(
      Effect.flatMap(item =>
        // åœ¨è¿™é‡Œè°ƒç”¨æ’æ§½
        slots.processor({ item, context: {} }).pipe(
            Effect.retry({ times: 3 }) // æ¶æ„å¸ˆèµ‹äºˆçš„èƒ½åŠ›ï¼šè‡ªåŠ¨é‡è¯•
        )
      )
    );
  })
);
```

### 2.2 å‡ºç æ—¶ (Codegen Time) â€”â€” å¹³å°ä¸ Agent è§†è§’

å½“ä¸šåŠ¡å¼€å‘è€…ä½¿ç”¨æ­¤ Pattern æ—¶ï¼Œå¹³å°è¯†åˆ«å‡º `processor` Slot éœ€è¦å¡«å……ã€‚

1.  **Intent æ³¨å…¥**: å¼€å‘è€…è¾“å…¥ "æŠŠæ•°æ®è½¬æ¢æˆ XML æ ¼å¼å¹¶ä¸Šä¼ åˆ° S3"ã€‚
2.  **Agent ç”Ÿæˆ**: Agent æ ¹æ® Slot çš„ Prompt å’Œ Schemaï¼Œç”Ÿæˆä¸€æ®µå†…è”çš„ Effect ä»£ç ã€‚
3.  **ä»£ç åˆæˆ**:

```typescript
// features/import/logic.ts
import { JobProcessor } from "@/patterns/JobProcessor";

export const ImportLogic = SomeImportDomain.logic(($) =>
  Effect.gen(function*() {
    // è°ƒç”¨ Pattern
    yield* JobProcessor.use({
      // 1. Config (é™æ€é…ç½®)
      config: { concurrency: 10 },

      // 2. Slots (AI ç”Ÿæˆçš„å·®å¼‚åŒ–é€»è¾‘)
      slots: {
        processor: (ctx) => Effect.gen(function*() {
           // --- Agent Generated Start ---
           const s3 = yield* $.use(S3Service);
           const xml = yield* convertToXml(ctx.item);
           yield* s3.upload({ body: xml });
           // --- Agent Generated End ---
        })
      }
    });
  })
);
```

## 3. å¹³å°ä¸è¿è¡Œæ—¶çš„é…åˆ (The Handshake)

| é˜¶æ®µ | è¡Œä¸º | è´Ÿè´£è§’è‰² | äº§ç‰© |
| :--- | :--- | :--- | :--- |
| **å®šä¹‰æ—¶** | ä½¿ç”¨ `Slot.make` å£°æ˜æ¥å£å¥‘çº¦ä¸ AI æç¤ºè¯ã€‚ | **æ¶æ„å¸ˆ** | Pattern Asset (å« Metadata) |
| **ç¼–æ’æ—¶** | åœ¨ç”»å¸ƒä¸Šå®ä¾‹åŒ– Patternï¼Œå¡«å†™è‡ªç„¶è¯­è¨€æ„å›¾ã€‚ | **ä¸šåŠ¡å¼€å‘** | Intent Description |
| **å‡ºç æ—¶** | è¯»å– Slot Metadata + ç”¨æˆ·æ„å›¾ -> ç”Ÿæˆ TS ä»£ç ã€‚ | **AI Agent** | Slot Implementation (Code) |
| **è¿è¡Œæ—¶** | æ‰§è¡Œ Pattern éª¨æ¶ + æ³¨å…¥çš„ Slot ä»£ç ã€‚ | **Logix Engine** | Running Fiber |

## 4. ä»·å€¼æ€»ç»“

1.  **Pattern as Prompt Template**: æ¶æ„å¸ˆåœ¨å†™ Pattern æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨ä¸ºæœªæ¥çš„ AI ç¼–å†™ "System Prompt"ã€‚
2.  **Slot as Micro-Sandbox**: æ¯ä¸ª Slot éƒ½å®šä¹‰äº†æ˜ç¡®çš„è¾“å…¥è¾“å‡º Schemaï¼Œæå¤§é™ä½äº† AI å¹»è§‰æ¦‚ç‡ã€‚
3.  **Zero Runtime Overhead**: è¿è¡Œæ—¶åªæ˜¯æ™®é€šçš„å‡½æ•°è°ƒç”¨ï¼Œäº«æœ‰å®Œæ•´çš„ TS ç±»å‹å®‰å…¨å’Œ Effect å¹¶å‘ç‰¹æ€§ã€‚
</file>

<file path="drafts/topics/platform-patterns/README.md">
---
title: Platform Patterns Â· Topic Overview
status: draft
version: 2025-12-03
value: extension
priority: later
---

# Platform Patterns Â· Topic Overview

æœ¬ Topic æ”¶æ‹¢å¹³å°ä¾§çš„ **ç”Ÿæˆå¼ Pattern ä½“ç³»**ï¼Œå…³æ³¨ Pattern ä»å®šä¹‰åˆ°è¿è¡Œçš„å…¨ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠå…¸å‹åœºæ™¯ä¸‹çš„å¤ç”¨æ–¹å¼ã€‚

æ ¸å¿ƒå…³æ³¨ç‚¹ï¼š

- Pattern çš„ç”Ÿå‘½å‘¨æœŸåˆ†æ®µï¼ˆDefinition / Interaction / Synthesis / Runtimeï¼‰ä¸å¹³å°äº¤äº’é’©å­è®¾è®¡ï¼›  
- å…¸å‹å¹³å°åœºæ™¯ä¸­çš„ Pattern ç»„åˆï¼ˆå¦‚ Job Processorã€è¡¨å•/åˆ—è¡¨ç”Ÿæˆç­‰ï¼‰ï¼›  
- å¦‚ä½•å°† Pattern è§„èŒƒåŒ–ä¸ºå¯è¿è¥èµ„äº§ï¼Œä¸ IntentRule / Studio / Runtime å½¢æˆé—­ç¯ã€‚

## æ–‡æ¡£ç´¢å¼•

- [generative-pattern-lifecycle.md](./generative-pattern-lifecycle.md) Â· Generative Pattern ç”Ÿå‘½å‘¨æœŸä¸ `Pattern.make` æ‰©å±•ç‚¹  
- [generative-pattern-scenarios.md](./generative-pattern-scenarios.md) Â· å…¸å‹åœºæ™¯ä¸‹çš„ Pattern ä½¿ç”¨æ¸…å•ä¸ç¤ºä¾‹  
- [generative-patterns-refined.md](./generative-patterns-refined.md) Â· å¯¹ç°æœ‰ Pattern è®¾è®¡çš„è¿›ä¸€æ­¥æ”¶æŸä¸ç²¾ç‚¼
</file>

<file path="drafts/topics/platform-vision/00-generative-language-server.md">
---
title: Generative Language Server Â· Agent & Logix v3 Long-Term Vision
status: draft
version: 0
value: vision
priority: later
---

> æœ¬æ–‡ä½œä¸ºè‰ç¨¿ï¼Œç”¨äºæ²‰æ·€ã€ŒAgent + Parser + AST + åç«¯æ‰§è¡Œã€åœ¨ Logix v3 å¹³å°ä¸­çš„**ç»ˆå±€å½¢æ€**è®¾æƒ³ã€‚
> ç›®æ ‡æ˜¯ç»™åç»­çš„æ¶æ„è®¾è®¡ã€äº§å“è§„åˆ’å’Œå®ç°è·¯çº¿æä¾›ä¸€ä»½â€œæœ€é•¿è¿œã€æœ€å®Œç¾â€çš„å‚è€ƒè“æœ¬ï¼Œå†ä»ä¸­åˆ‡å‡ºé˜¶æ®µæ€§ç‰ˆæœ¬è½åœ°ã€‚

## 1. æ€»ä½“æ„¿æ™¯ï¼šä» Chatbot åˆ° Generative Language Server

åœ¨ v3 æ¶æ„ä¸‹ï¼Œæˆ‘ä»¬ä¸å†æŠŠ Agent è§†ä¸ºâ€œä¼šå†™ä»£ç çš„ Chatbotâ€ï¼Œè€Œæ˜¯æŠŠæ•´ä¸ªå¹³å°æœç€ **Generative Language Serverï¼ˆç”Ÿæˆå¼è¯­è¨€æœåŠ¡å™¨ï¼‰** çš„æ–¹å‘æ¼”è¿›ï¼š

- å‰ç«¯ï¼ˆIDE æ’ä»¶ / Web ç”»å¸ƒï¼‰å˜è–„ï¼Œåªè´Ÿè´£**è¡¨è¾¾æ„å›¾**å’Œ**å±•ç¤ºç»“æœ**ï¼›
- åç«¯æˆä¸ºçœŸæ­£çš„â€œè„‘ + æ‰‹â€ï¼š
  - è„‘ï¼ˆBrainï¼‰ï¼šAgent Orchestrator + LLM + RAGï¼ˆä»£ç /æ–‡æ¡£/Pattern çŸ¥è¯†åº“ï¼‰ï¼›
  - æ‰‹ï¼ˆHandsï¼‰ï¼šLogix Compiler Serviceï¼ˆParser / Validator / AST Patcher / Emitterï¼‰ã€‚

é•¿è¿œç›®æ ‡ï¼š

> ä¸ç®¡å…¥å£æ˜¯è‡ªç„¶è¯­è¨€ã€ç”»å¸ƒæ‹–æ‹½è¿˜æ˜¯æ‰‹å†™ä»£ç ï¼Œ
> æœ€ç»ˆéƒ½æ”¶æ•›ä¸ºç¨³å®šçš„ IntentRule / Fluent è§„åˆ™ / Logix ä»£ç ï¼Œ
> ä¸”æ‰€æœ‰æ”¹åŠ¨éƒ½å¯ç†è§£ã€å¯éªŒè¯ã€å¯å›æ”¾ã€å¯å›æ»šã€‚

## 2. ä¸‰ä¸ªå°ºåº¦çš„èƒ½åŠ›è§„åˆ’

ä»ç»ˆå±€è§†è§’ï¼Œå¹³å°å›´ç»• Intent & Logix å¯ä»¥åœ¨ä¸‰ä¸ªå°ºåº¦ä¸Šæä¾›èƒ½åŠ›ï¼š

1. **å•æ¡è§„åˆ™ï¼ˆRule-Levelï¼‰**ï¼šä»»ä½•ä¸€æ¡ Fluent è§„åˆ™éƒ½å¯ä»¥è¢«ç²¾ç¡®ç†è§£ã€è§£é‡Šã€æ”¹å†™å’Œå›æ»šï¼›
2. **ä¸šåŠ¡åœºæ™¯ï¼ˆUse-Case-Levelï¼‰**ï¼šä» PRD æ–‡æœ¬ â†’ Use Case Blueprint â†’ IntentRule é›†åˆ â†’ Logix ä»£ç  â†’ æµçº§æµ‹è¯•çš„é—­ç¯ï¼›
3. **ç»„ç»‡/ä»“åº“ï¼ˆOrg-Levelï¼‰**ï¼šå…¨å±€ Intent å›¾è°±ã€æ¶æ„æ²»ç†ã€æ‰¹é‡è¿ç§»ã€Pattern æç‚¼ä¸æŒç»­å­¦ä¹ ã€‚

### 2.1 Rule-Levelï¼šå•æ¡è§„åˆ™çš„è¯»æ‡‚ / æ”¹å†™ / å›æ”¾

å…¸å‹å¯¹è±¡ï¼šå½¢å¦‚ `yield* $.onState(...).op().then(Effect.gen(...), opts?)` / `yield* $.onAction(...).op().then(...)` / `yield* $.on(...).op().then(...)` çš„ Fluent è§„åˆ™ã€‚

ç›®æ ‡èƒ½åŠ›ï¼š

1. **å®Œæ•´è¯­ä¹‰è§£æ„**
   - åç«¯é€šè¿‡ Parser + AST èƒ½ç¨³å®šåœ°æŠ½å‡ºæ¯æ¡è§„åˆ™çš„ç»“æ„ï¼š
     - Sourceï¼šç›‘å¬å¯¹è±¡ï¼ˆState è§†å›¾ / Action / ä»»æ„ Streamï¼‰ï¼›
     - Pipelineï¼šé˜²æŠ–ã€èŠ‚æµã€è¿‡æ»¤ç­‰ç­–ç•¥é“¾ï¼›
     - Sinkï¼šæœ€ç»ˆä½œç”¨ï¼ˆæœ¬ Store çŠ¶æ€å†™å…¥ã€æœ¬/ä»– Store Action æ´¾å‘ã€Service è°ƒç”¨ã€Control ç»“æ„ï¼‰ï¼›
     - å¹¶å‘è¯­ä¹‰ï¼š`run` / `latest` / `exhaust` / `sequence`ã€‚
   - å¯¹ä»»æ„ä¸€æ¡è§„åˆ™ï¼Œå¹³å°å¯ä»¥ç”Ÿæˆè‡ªç„¶è¯­è¨€è§£é‡Šï¼šâ€œä»€ä¹ˆæ—¶å€™è§¦å‘ï¼Ÿå¯¹è°æœ‰å½±å“ï¼Ÿé”™è¯¯æ€ä¹ˆå¤„ç†ï¼Ÿâ€

2. **å®‰å…¨å±€éƒ¨æ”¹å†™ï¼ˆå¤–ç§‘æ‰‹æœ¯å¼ï¼‰**
   - ç”¨æˆ·æˆ– Agent æƒ³è¦ä¿®æ”¹è§„åˆ™ï¼ˆä¾‹å¦‚æŠŠ debounce ä» 500 æ”¹æˆ 800ï¼ŒæŠŠ mode ä» `latest` æ”¹æˆ `exhaust`ï¼‰ï¼š
     - åç«¯ç”¨ Parser ç²¾ç¡®å®šä½å¯¹åº”çš„ Fluent é“¾ AST èŠ‚ç‚¹ï¼›
     - åªä¿®æ”¹éœ€è¦çš„ AST å­èŠ‚ç‚¹ï¼ˆå‚æ•°ã€optionsã€éƒ¨åˆ† handlerï¼‰ï¼Œä¿æŒå‘¨å›´æ³¨é‡Šå’Œæ ¼å¼ï¼›
     - ç”¨ TS printer + Prettier/ESLint é‡æ–°ç”Ÿæˆæºç ï¼Œä¿è¯é£æ ¼ç»Ÿä¸€ã€‚

3. **å¤šç‰ˆæœ¬å®¡è®¡ä¸å›æ»š**
   - æ¯æ¬¡è§„åˆ™æ”¹åŠ¨éƒ½è®°å½•ä¸ºï¼š
     - IntentRule diffï¼ˆIR è§†è§’ï¼šsource/pipeline/sink å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–ï¼‰ï¼›
     - AST diff / Git diffï¼ˆæºç è§†è§’ï¼šå…·ä½“æ”¹äº†å“ªå‡ è¡Œï¼‰ã€‚
   - æ”¯æŒï¼š
     - æŒ‰æ—¶é—´çº¿æŸ¥çœ‹å•æ¡è§„åˆ™çš„æ¼”åŒ–å†å²ï¼ˆè°åœ¨ä½•æ—¶æ”¹è¿‡ä»€ä¹ˆã€ä¸ºä»€ä¹ˆï¼‰ï¼›
     - ä¸€é”®æŠŠæŸæ¡è§„åˆ™å›æ»šåˆ°å†å²ä»»æ„ç‰ˆæœ¬ï¼Œä¸å½±å“å‘¨å›´ä»£ç ã€‚

4. **æ™ºèƒ½è‡ªæ„ˆä¸å®ˆé—¨**
   - Parser ä½œä¸ºâ€œå®ˆé—¨äººâ€ï¼Œå¯¹ä¸åˆè§„å†™æ³•ç»™å‡ºç»“æ„åŒ–é”™è¯¯ç ï¼š
     - `ERR_ASYNC_HANDLER`ï¼š`then` handler æ˜¯ async å‡½æ•°ï¼›
     - `ERR_SPLIT_CHAIN`ï¼šFluent é“¾è¢«æ‹†åˆ°å˜é‡å† `flow.then(...)`ï¼›
     - `ERR_UNSUPPORTED_OP`ï¼šä¸åœ¨ Fluent ç™½ç›’å­é›† / é `$.onState / $.onAction / $.on` å¼€å¤´ã€‚
   - Agent ä½¿ç”¨è¿™äº›é”™è¯¯ç ä½œä¸ºåé¦ˆï¼Œè‡ªè¡Œé‡å†™è§„åˆ™ç›´åˆ°æ»¡è¶³ Fluent + Effect çº¦æŸï¼š
     - ä¸ç”¨ async/awaitï¼Œåªç”¨ `Effect.gen + yield*`ï¼›
     - ä¸æ‹†é“¾ï¼Œå§‹ç»ˆå†™æˆå•æ¡ `yield* $.onState(...).op().then(...)` / `yield* $.onAction(...).op().then(...)` / `yield* $.on(...).op().then(...)`ï¼›
     - è¶Šç•Œå†™ä»–åº“ state ç­‰è¿è§„è¡Œä¸ºåœ¨é™æ€å±‚å°±è¢«æ‹¦æˆªã€‚

### 2.2 Use-Case-Levelï¼šåœºæ™¯çº§é—­ç¯ï¼ˆä» PRD åˆ°æµ‹è¯•ï¼‰

å…¸å‹å¯¹è±¡ï¼šæœç´¢ + è¯¦æƒ…ã€å®¡æ‰¹æµã€æ³¨å†Œè¡¨å•ã€å¯¼å…¥/å¯¼å‡ºã€æ‰¹å¤„ç†ç­‰ä¸šåŠ¡åœºæ™¯ã€‚

ç›®æ ‡èƒ½åŠ›ï¼š

1. **ä»éœ€æ±‚æ–‡æœ¬ç”Ÿæˆ Use Case Blueprint**
   - PM åœ¨å¹³å°ä¸­ç”¨ç»“æ„åŒ–æ¨¡ç‰ˆä¹¦å†™ Level 0/1 éœ€æ±‚ï¼ˆâ€œå½“ X æ—¶ï¼Œå¦‚æœ Yï¼Œåˆ™ç³»ç»Ÿåº” Zâ€ï¼‰ï¼›
   - Agent åŸºäº v3 æ¨¡å‹ç”Ÿæˆ Use Case Blueprintï¼š
     - æ¶‰åŠå“ªäº›é¡µé¢ã€Storeã€å­—æ®µã€Serviceï¼›
     - å“ªäº›è”åŠ¨å±äº L1/L2/L3ï¼›
     - åˆæ­¥ IntentRule è‰ç¨¿é›†åˆ + æ¨è Pattern ç»„åˆã€‚

2. **åŠè‡ªåŠ¨è½åˆ°ä»£ç ä¸å›¾**
   - Blueprint ç¡®è®¤åï¼Œå¹³å°å¯ä»¥è‡ªåŠ¨ç”Ÿæˆï¼š
    - Logix.Module å®šä¹‰å’Œ State/Action Schema è‰ç¨¿ï¼›
     - Logic æ–‡ä»¶ä¸­çš„ Fluent è§„åˆ™éª¨æ¶ï¼ˆ`$.onState/onAction/on` + `$.state/$.match/$.use`ï¼‰ï¼›
     - Galaxy ç”»å¸ƒä¸Šçš„èŠ‚ç‚¹å’Œè¿çº¿ï¼ˆStore / Pattern / Service / Rule Cardï¼‰ã€‚
   - å¼€å‘è€…ä¸»è¦å·¥ä½œå˜æˆï¼š
     - å®ç°å¤æ‚ Service å’Œé¢†åŸŸç®—æ³•ï¼›
     - å¯¹ Agent ç”Ÿæˆçš„è§„åˆ™åšå®¡æ ¸ä¸å°‘é‡ä¿®æ”¹ã€‚

3. **è‡ªåŠ¨ç”Ÿæˆä¸ç»´æŠ¤åœºæ™¯çº§ç”¨ä¾‹**
   - é’ˆå¯¹æ¯ä¸ª Use Caseï¼Œå¹³å°ç»´æŒä¸€ç»„â€œæ„å›¾å›æ”¾ç”¨ä¾‹â€ï¼š
     - è¾“å…¥ï¼šæŒ‰æ—¶é—´åºåˆ—å®šä¹‰çš„ç”¨æˆ·æ“ä½œ / Action / State å˜åŒ–ï¼›
     - è¾“å‡ºï¼šæœŸæœ›çš„ State / Action / å¤–éƒ¨è°ƒç”¨è®°å½•ã€‚
   - å½“è§„åˆ™å˜åŒ–æ—¶ï¼Œåç«¯åœ¨ headless Runtime ä¸­æ‰§è¡Œè¿™äº›ç”¨ä¾‹ï¼š
     - ç¡®è®¤å¯è§‚æµ‹è¡Œä¸ºä¸å‘ç”Ÿä¸æœŸæœ›çš„å˜åŒ–ï¼›
     - æä¾›â€œè¡Œä¸ºå·®å¼‚æŠ¥å‘Šâ€ï¼ˆæ–°å¢/åˆ é™¤/å˜æ›´çš„çŠ¶æ€å’Œäº‹ä»¶ï¼‰ï¼Œè¾…åŠ©äººå·¥å†³ç­–ã€‚

4. **è·¨åœºæ™¯ååŒä¸ Pattern æç‚¼**
   - å¹³å°åŸºäº IR è¯†åˆ«â€œé‡å¤æ¨¡å¼â€å’Œâ€œè·¨åœºæ™¯å…±æ€§â€ï¼š
     - æœç´¢ + è¯¦æƒ…ã€å®¡æ‰¹è´¯ç©¿ã€å¯¼å…¥/æ ¡éªŒ/å…¥åº“ã€ä¹è§‚æ›´æ–°ç­‰é«˜é¢‘æ¨¡å¼ï¼›
   - æä¾›â€œæç‚¼ä¸º Patternâ€çš„å‘å¯¼ï¼š
     - æ”¶é›†è‹¥å¹²ç›¸ä¼¼è§„åˆ™ â†’ æŠ½è±¡å‡º `(input) => Effect` + Config Schema çš„ Pattern æºç ï¼›
     - è‡ªåŠ¨ç”Ÿæˆ Pattern æ–‡æ¡£ä¸æ ·ä¾‹ï¼›
     - ç”¨ AST æ‰¹é‡æ”¹å†™åŸè§„åˆ™ä¸º Pattern è°ƒç”¨ï¼Œå‡å°‘é‡å¤ä»£ç ã€‚

### 2.3 Org-Levelï¼šå…¨å±€ Intent å›¾è°±ä¸æŒç»­æ¼”è¿›

æ”¾å¤§åˆ°æ•´ä»“åº“ç”šè‡³ç»„ç»‡çº§ï¼š

1. **Intent-aware å…¨å±€å›¾è°±ä¸æ²»ç†**
   - Parser/Compiler æŒç»­ç»´æŠ¤ä¸€ä¸ªä»“åº“çº§ IntentRule å›¾è°±ï¼š
     - Store ä¹‹é—´çš„åä½œå…³ç³»ï¼ˆL2ï¼‰ï¼›
     - å“ªäº›å­—æ®µ/Action é©±åŠ¨äº†å¤šå°‘è§„åˆ™ï¼›
     - å“ªäº› Service æˆä¸ºé«˜è€¦åˆç‚¹ / æ½œåœ¨ç“¶é¢ˆã€‚
   - å¹³å°å¯ä»¥æä¾›ï¼š
     - Intent ç»´åº¦çš„æœç´¢ä¸åˆ†æï¼ˆæŒ‰å­—æ®µ/Action/Service æ‰¾è§„åˆ™ï¼‰ï¼›
     - æ¶æ„é£é™©æç¤ºï¼ˆè·¨åŸŸè”åŠ¨è¿‡å¤šã€æ½œåœ¨å¾ªç¯ä¾èµ–ã€è¿‡åº¦ä¾èµ–æŸä¸ª Store ç­‰ï¼‰ã€‚

2. **æ¶æ„æ¼”è¿›ä¸ç‰ˆæœ¬è¿ç§»åŠ©æ‰‹**
   - å½“ Logix APIã€Pattern å¥‘çº¦æˆ– effect ç‰ˆæœ¬å‡çº§æ—¶ï¼š
     - åˆ†æå…¨ä»“è§„åˆ™/Pattern çš„ä½¿ç”¨æƒ…å†µï¼›
     - ç”Ÿæˆè¿ç§»ç­–ç•¥ï¼ˆå“ªäº›è§„åˆ™å¯ä»¥è‡ªåŠ¨è¿ï¼Œå“ªäº›éœ€è¦äººå·¥ä»‹å…¥ï¼‰ï¼›
     - ç”± Agent äº§å‡ºè¿ç§»æ–¹æ¡ˆã€Compiler Service é€šè¿‡ AST æ‰¹é‡æ‰§è¡Œè¿ç§»ï¼›
     - ç»“åˆåœºæ™¯çº§å›æ”¾ç”¨ä¾‹åšè¿ç§»åçš„è¡Œä¸ºç¡®è®¤ã€‚

3. **Pattern ä¸ Flow èµ„äº§åº“**
   - å¹³å°æŒç»­ä»é¡¹ç›®ä¸­æç‚¼ Pattern å’Œ Flow èµ„äº§ï¼Œå¹¶æ²‰æ·€ä¸ºå¯ç‰ˆæœ¬åŒ–çš„åº“ï¼š
     - æ¯ä¸ª Pattern å¸¦æœ‰ Config Schemaã€å®ç°ã€ç¤ºä¾‹ã€æµ‹è¯•ï¼›
     - æ–°é¡¹ç›®å¯ç›´æ¥ä»èµ„äº§åº“æ‹–æ‹½ä½¿ç”¨ï¼ŒLogix ä»£ç ä¸æµ‹è¯•è‡ªåŠ¨ç”Ÿæˆã€‚
   - Agent åœ¨ç”Ÿæˆæ—¶ä¼˜å…ˆå¤ç”¨è¿™äº›èµ„äº§ï¼Œè€Œä¸æ˜¯ä»é›¶å¼€å§‹å†™ Effectï¼š
     - æé«˜è´¨é‡å’Œä¸€è‡´æ€§ï¼›
     - è®©ç»„ç»‡ç»éªŒé€šè¿‡èµ„äº§åº“è€Œéå£å£ç›¸ä¼ å¾—ä»¥å»¶ç»­ã€‚

4. **æŒç»­å­¦ä¹ ä¸ç­–ç•¥ä¼˜åŒ–**
   - å¹³å°å¯ä»¥æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µï¼Œç»Ÿè®¡ï¼š
     - å“ªäº› Agent ç”Ÿæˆçš„è§„åˆ™è¢«é¢‘ç¹å›æ»šæˆ–é‡å†™ï¼›
     - å“ªäº› Pattern åœ¨å®é™…ä¸šåŠ¡ä¸­è¡¨ç°ç¨³å®šï¼›
     - å“ªäº›å†™æ³•æ›´å®¹æ˜“è§¦å‘ç±»å‹/è¿è¡Œæ—¶é”™è¯¯ã€‚
   - åŸºäºè¿™äº›æ•°æ®ï¼š
     - è°ƒæ•´ Agent Prompt / æ¨¡æ¿ï¼ˆä¾‹å¦‚ç¦ç”¨æŸäº›å®¹æ˜“å‡ºé”™çš„å†™æ³•ï¼‰ï¼›
     - å½¢æˆç»„ç»‡çº§ â€œLogix å†™æ³•é£æ ¼æŒ‡å—â€ï¼Œç”± Agent è‡ªåŠ¨æ‰§è¡Œï¼›
     - ä¸æ–­æé«˜é»˜è®¤ç”Ÿæˆè´¨é‡ä¸â€œä¸€æ¬¡é€šè¿‡ç‡â€ã€‚

## 3. åç«¯å¼•æ“å½¢æ€ï¼šGenerative Language Server / Compiler Service

æ•´ä½“åç«¯å½¢æ€å¯ä»¥æŠ½è±¡ä¸ºä¸€ä¸ª **Generative Language Server + Logix Compiler Service**ï¼š

- Generative Language Serverï¼ˆBrainï¼‰
  - Agent Orchestratorï¼šç®¡ç†å¤šè½®å¯¹è¯ã€å¤š Agent åä½œï¼›
  - Context Engineï¼šç»“åˆ RAGï¼Œä»ä»“åº“/æ–‡æ¡£/Pattern åº“ä¸­æ£€ç´¢ä¸Šä¸‹æ–‡ï¼›
  - Model Serviceï¼šå¯¹æ¥ LLMï¼Œæ‰§è¡Œ Prompt + Few-shot + Tool è°ƒç”¨ã€‚

- Logix Compiler Serviceï¼ˆHandsï¼‰
  - Parserï¼šåŸºäº TypeScript ASTï¼ˆts-morphï¼‰ï¼Œè¯†åˆ« Fluent å­é›†ã€Domain å®šä¹‰ã€Bound API `$` ç­‰ï¼›
  - Validatorï¼šç±»å‹æ£€æŸ¥ï¼ˆtscï¼‰ã€Fluent çº¦æŸï¼ˆERR_*ï¼‰ã€ä»“åº“çº§çº¦æŸï¼ˆç¦æ­¢è¶Šç•Œç­‰ï¼‰ï¼›
  - AST Patcherï¼šæ ¹æ® IR diffã€Agent diff å¯¹æºç åšç²¾ç¡®æ”¹å†™ï¼›
  - Emitterï¼šç»Ÿä¸€ç”¨ TypeScript printer + Prettier/ESLint è¾“å‡ºæœ€ç»ˆæºç ï¼›
  - Runtime Harnessï¼šæä¾› headless Runtime æ‰§è¡Œ Flow/Storeï¼Œæ”¯æŒä»¿çœŸå’Œæµ‹è¯•ã€‚

è¿™ä¸€åˆ†å±‚å¸¦æ¥çš„é•¿æœŸå¥½å¤„ï¼š

- å‰ç«¯åªæ‰¿è½½ UI & Intent è¡¨è¾¾ï¼Œä¸æ‰¿æ‹…å¤æ‚é€»è¾‘ï¼›
- LLM ä¸ç›´æ¥ç¢°æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯é€šè¿‡ Compiler Service ä¸­ä»‹ï¼Œå¯¹è§„åˆ™åšç»“æ„åŒ–æ“ä½œï¼›
- æ‰€æœ‰è½åˆ° Git çš„å˜æ›´éƒ½å¯è§£é‡Šã€å¯éªŒè¯ã€å¯å›æ”¾ã€‚

## 4. Agent çš„ç»ˆå±€è§’è‰²ï¼šéµæ³•çš„â€œè™šæ‹Ÿå·¥ç¨‹å¸ˆâ€

åœ¨è¿™ä¸ªç»ˆå±€é‡Œï¼ŒAgent çš„è§’è‰²ä¸å†æ¨¡ç³Šï¼š

- å®ƒä¸æ˜¯â€œå¯ä»¥éšæ„æ”¹ä»£ç çš„ AIâ€ï¼Œè€Œæ˜¯ä¸€ä¸ªå®Œå…¨éµå®ˆï¼š
  - Fluent ç™½ç›’å­é›†åˆçº¦ï¼›
  - Effect çº¯åº¦çº¦æŸï¼ˆæ—  async/awaitï¼‰ï¼›
  - `@agent-generated` æ‰€æœ‰æƒ / Eject åè®®ï¼›
  - å¾®è§‚æ²™ç®±æœ€å°ç‰¹æƒåŸåˆ™ï¼›
  çš„â€œè™šæ‹Ÿå·¥ç¨‹å¸ˆâ€ã€‚

- å®ƒçš„è¾“å‡ºå¯¹è±¡ä¸æ˜¯â€œæ•´æ–‡ä»¶æºç â€ï¼Œè€Œæ˜¯ï¼š
  - å¯¹æŸæ¡ IntentRule/è§„åˆ™çš„ç»“æ„åŒ–ä¿®æ”¹å»ºè®®ï¼ˆIR diffï¼‰ï¼›
  - å¯¹æŸä¸ª handler çš„å±€éƒ¨ä»£ç ç‰‡æ®µï¼ˆåœ¨ä¸¥æ ¼è¾¹ç•Œå†…ï¼‰ï¼›
  - æˆ–å¯¹ Pattern/Use Case Blueprint çš„è®¾è®¡ç¨¿ã€‚
  æœ€ç»ˆè½ç ä¸€å¾‹ç”± Compiler Service è´Ÿè´£ï¼Œé€šè¿‡ AST + æ¨¡æ¿æ‰§è¡Œã€‚

è¿™ä¹Ÿæ˜¯ v3 æ–‡æ¡£ä¸­â€œå…ˆç«‹æ³•ï¼ˆç±»å‹ä¸æ–‡æ¡£ï¼‰ï¼Œåæ‰§æ³•ï¼ˆParserï¼‰ï¼Œæœ€åä¸Šå²—ï¼ˆAgentï¼‰â€åœ¨å¹³å°å±‚çš„æœ€ç»ˆè½ç‚¹ã€‚

## 5. åç»­æ¼”è¿›ä¸æ‹†åˆ†å»ºè®®

ä½œä¸ºè‰ç¨¿ï¼Œæœ¬æ–‡åªç»™å‡ºäº†â€œæœ€é•¿è¿œã€æœ€å®Œç¾â€çš„çŠ¶æ€è®¾æƒ³ã€‚å…·ä½“è½åœ°æ—¶å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å‘æ‹†åˆ†ï¼š

1. ä» Rule-Level èƒ½åŠ›å¼€å§‹ï¼š
   - å®Œå–„ Parser / Compiler Serviceï¼Œå¯¹ Fluent è§„åˆ™åšå¯é çš„æŠ½å–ä¸æ ¡éªŒï¼›
   - åœ¨ IDE / ç”»å¸ƒä¸­æä¾›è§„åˆ™çº§è§£é‡Šä¸ç®€å•å‚æ•°ä¿®æ”¹ï¼›
   - å¼•å¯¼ Agent ä»…åœ¨ Fluent å­é›†ä¸­å·¥ä½œï¼Œå¹¶é€šè¿‡ Parser åšè‡ªæ„ˆã€‚

2. æ¸è¿›å¼•å…¥ Use-Case-Level èƒ½åŠ›ï¼š
   - ä¸ºå…¸å‹åœºæ™¯è®¾è®¡ Use Case Blueprint æ¨¡å‹ä¸ä¸€ç»„ PoCï¼›
   - ä¸ºè¿™äº›åœºæ™¯è‡ªåŠ¨ç”Ÿæˆ Logic éª¨æ¶å’Œå°‘é‡å›æ”¾ç”¨ä¾‹ï¼›
   - æŠŠ Logix Compiler Service ç”¨äºåœºæ™¯çº§é‡æ„ä¸è¿ç§»ã€‚

3. æœ€åé“ºå‘ Org-Level æ²»ç†ä¸èµ„äº§åŒ–ï¼š
   - å»ºç«‹ä»“åº“çº§ Intent å›¾è°±ä¸ Pattern èµ„äº§åº“ï¼›
   - å°†æ¶æ„æ²»ç†è§„åˆ™å’Œè¿ç§»èƒ½åŠ›çº³å…¥ CI/CD æµç¨‹ï¼›
   - ç”¨çœŸå®é¡¹ç›®ä¸­çš„æ•°æ®åé¦ˆæŒç»­è°ƒæ•´ Agent ç­–ç•¥ä¸ Pattern è®¾è®¡ã€‚

åç»­å¯ä»¥æ ¹æ®é¡¹ç›®èŠ‚å¥ï¼Œä»æœ¬æ–‡ä¸­æŒ‘é€‰ä¸€ä¸¤æ¡â€œèƒ½åŠ›çº¿â€ï¼ˆä¾‹å¦‚ Rule-Level è‡ªæ„ˆ / Use-Case Blueprintï¼‰å•ç‹¬æ‹‰å‡º specs ä¸ PoCï¼Œå®ç°â€œä»ç»ˆå±€æ„¿æ™¯å‘ç°å®é€æ­¥é æ‹¢â€ã€‚

## 6. å¤–éƒ¨å®ç°å‚è€ƒï¼šBubbleLab æ˜ å°„ä¸å¯å¤ç”¨æ¨¡å¼ï¼ˆè‰ç¨¿ï¼‰

> æœ¬èŠ‚ç”¨äºå¯¹é½ BubbleLab è¿™ç±»â€œé…ç½®é©±åŠ¨å·¥ä½œæµå¼•æ“â€çš„æˆç†Ÿå®è·µï¼Œå¹¶æ ‡è®°å“ªäº›æ¨¡å¼å¯ä»¥ç›´æ¥è¿ç§»åˆ° Logix v3 çš„å®ç°ä¸å·¥å…·é“¾ä¸­ã€‚
> æš‚ä¸åšè¯¦ç»† API è®¾è®¡ï¼Œåªè®°å½•â€œå€¼å¾—æŠ„â€çš„æ¨¡å¼ä¸åœ¨æœ¬ä»“çš„è½ç‚¹ã€‚

### 6.1 Bubble ç±»å‹ç³»ç»Ÿä¸å·¥å‚ â†’ Logix.Module / Pattern Registry / Boilerplate

- BubbleLab çš„ `IBubble / IServiceBubble / IToolBubble / IWorkflowBubble` + `BubbleFactory` æä¾›äº†ä¸‰å±‚èƒ½åŠ›ï¼š
  - ç»Ÿä¸€çš„ Bubble æ¥å£ï¼šåŒ…å« schemaã€resultSchemaã€æ‰§è¡Œé€»è¾‘ `action()` ä¸æ‰§è¡Œä¸Šä¸‹æ–‡ `BubbleContext`ï¼›
  - å·¥å‚ä¸æ³¨å†Œä¸­å¿ƒï¼š`register / get / createBubble / list`ï¼Œé™„å¸¦ä¾èµ–ä¸ credential æ˜ å°„ï¼›
  - é¢å‘ AI çš„æ¨¡æ¿è¾“å‡ºï¼š`generateBubbleFlowBoilerplate()` ç›´æ¥äº§å‡ºåŒ…å«æ‰€æœ‰ Bubble imports çš„ TS æ¨¡æ¿ã€‚
- å¯¹ Logix v3 çš„æ˜ å°„ï¼š
  - `Logix.Module` + Pattern/Flow å®šä¹‰å¯ä»¥è§†ä¸º Bubble çš„ç­‰ä»·ç‰©ï¼Œæ‰¿æ‹…â€œèº«ä»½ + Schema + Logic å…¥å£â€çš„èŒè´£ï¼›
  - æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç±»ä¼¼ `BubbleFactory` çš„ **Pattern / Module Registry**ï¼Œç»Ÿä¸€æ”¶é›† Module ä¸ Pattern å…ƒä¿¡æ¯ï¼›
  - **å»ºè®®æ–°å¢èƒ½åŠ›**ï¼š
    - åœ¨å·¥å…·é“¾ä¸­æä¾› `generateLogicBoilerplate`ï¼šä¸º Agent/LSP è¾“å‡ºåŒ…å« `Logix.Module`ã€`BoundApi ($)` ä¸å¸¸ç”¨ Pattern imports çš„ TS æ¨¡æ¿ï¼ˆä¸“ä¾›ç”Ÿæˆ/è¡¥å…¨ä½¿ç”¨ï¼‰ï¼›
    - ä¸º Pattern/Spec æä¾›ç»Ÿä¸€çš„æ³¨å†Œ/å‘ç°æœºåˆ¶ï¼Œåç»­ç”± Pattern metadata bundlerï¼ˆè§ä¸‹èŠ‚ï¼‰æ¶ˆè´¹ã€‚

### 6.2 æºç çº§ä¾èµ–è§£æ â†’ Fluent è§„åˆ™çš„ detailedDeps ä¸ä½ç½®ä¿¡æ¯

- BubbleLab åœ¨ `bubble-factory.ts` ä¸­ä½¿ç”¨ `source-bubble-parser`ï¼š
  - ä» TS æºç è§£æå‡º Bubble å®ä¾‹çš„åˆ†å¸ƒä¸ä¾èµ–å…³ç³»ï¼Œè®°å½•æ¯ä¸ª Bubble åœ¨ Flow ä¸­çš„ä½¿ç”¨ä½ç½®ï¼ˆå˜é‡åã€æ˜¯å¦åŒ¿åã€èµ·æ­¢è¡Œå·ï¼‰ï¼›
  - å°†è¿™äº›ä¿¡æ¯ç¼“å­˜ä¸º `detailedDeps`ï¼Œä¾›è¿è¡Œæ—¶ä¸å·¥å…·ä½¿ç”¨ã€‚
- å¯¹ Logix v3 çš„ç›´æ¥å¯ç¤ºï¼š
  - æˆ‘ä»¬å½“å‰çš„ Fluent Parser å·²ç»èƒ½æŠ½å‡º `source/pipeline/sink`ï¼Œä½†è¿˜æ²¡æœ‰ç³»ç»Ÿç®¡ç†â€œè§„åˆ™åœ¨æºç ä¸­çš„ä½ç½®ä¿¡æ¯ä¸ä¾èµ–è¯¦æƒ…â€ï¼›
  - **å»ºè®®æ‰©å±• Fluent Parser è¾“å‡º**ï¼š
    - é™¤åŸºç¡€ç»“æ„å¤–ï¼Œä¸ºæ¯æ¡è§„åˆ™é™„åŠ ï¼šæ‰€åœ¨æ–‡ä»¶è·¯å¾„ã€èµ·æ­¢è¡Œå·ï¼ˆæˆ–æ›´ç²¾ç»†çš„èŒƒå›´ï¼‰ã€æ¶‰åŠçš„ Store/Pattern/Service æ ‡è¯†ï¼›
    - å°†è¿™äº› `detailedDeps` æŒä¹…åŒ–åˆ° Compiler Service æˆ–ç¼“å­˜ä¸­ï¼Œä¾› Galaxy/è°ƒè¯•/Trace ä½¿ç”¨ï¼›
    - ä¸ºåç»­çš„è·¨æ–‡ä»¶ä¾èµ–æ‹“æ‰‘å’Œå½±å“åˆ†ææä¾›æ•°æ®åŸºç¡€ã€‚

### 6.3 è¿è¡Œæ—¶æ³¨å…¥æ¨¡å‹ â†’ Logic.Env / $.use / Execution Metadata

- BubbleLab çš„ `BubbleContext` + `BubbleInjector`ï¼š
  - åœ¨æ¯ä¸ª Bubble æ‰§è¡Œæ—¶æ³¨å…¥ loggerã€å˜é‡ IDã€ä¾èµ–å›¾èŠ‚ç‚¹ã€uniqueId è®¡æ•°å™¨ç­‰æ‰§è¡Œå…ƒæ•°æ®ï¼›
  - é€šè¿‡æ³¨å…¥å™¨ç»Ÿä¸€æ„å»ºæ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œé¿å…ä¸šåŠ¡ä»£ç ç›´æ¥æ“ä½œåº•å±‚èµ„æºã€‚
- å¯¹ Logix v3 çš„å¯¹é½ï¼š
  - `Logic.Env<Sh,R>` ä¸åº”ä»…åŒ…å« Logix.ModuleRuntime + æœåŠ¡ Envï¼Œè¿˜åº”åŒ…å«ï¼š
    - æ‰§è¡Œçº§ metadataï¼šexecutionId / nodeId / traceId / è°ƒç”¨æ ˆç‰‡æ®µç­‰ï¼›
    - è§„åˆ™/Pattern çº§ metadataï¼šæ‰€å± Spec Idã€è§„åˆ™ Idï¼ˆå¯¹åº” Fluent é“¾/IntentRuleï¼‰ï¼›
  - `$.use` èƒŒåå¯ä»¥é‡‡ç”¨ç±»ä¼¼ BubbleInjector çš„ DI æ¨¡å‹ï¼š
    - åªå…è®¸è®¿é—® Env ä¸­æ˜¾å¼æ³¨å†Œçš„ Tag/Specï¼›
    - å°†æœåŠ¡å®ä¾‹ä¸æ‰§è¡Œ metadata ä¸€å¹¶æ³¨å…¥ï¼ˆä¾¿äºæ—¥å¿—å’Œ Traceï¼‰ã€‚
- **å»ºè®®åŠ¨ä½œ**ï¼š
  - åœ¨ `runtime-logix/impl` ä¸‹è¡¥å……ä¸€ä»½ â€œEnv/Scope/DI/Sandboxâ€ çš„å®ç°è§„èŒƒï¼ˆexecution metadata çš„å­—æ®µçº¦å®š + `$.use` çš„è¡Œä¸ºè¾¹ç•Œï¼‰ï¼›
  - åœ¨ `packages/effect-runtime-poc` ä¸­åšä¸€ä¸ªå° PoCï¼šæ‰“å° Env ä¸­çš„ execution metadata ä¸ `$.use` è·å–çš„æœåŠ¡ï¼ŒéªŒè¯ Env å½¢çŠ¶ä¸çº¦å®šä¸€è‡´ã€‚

### 6.4 ç±»å‹æ³¨å…¥ä¸ç¼–è¾‘å™¨é›†æˆ â†’ Bound API / Spec / Schema çš„ d.ts ç”Ÿæˆ

- BubbleLab é€šè¿‡ `monacoTypeLoader` + é¢„ç”Ÿæˆçš„ `*.d.ts`ï¼Œå°†æ ¸å¿ƒç±»å‹æ³¨å…¥å‰ç«¯ Monacoï¼Œç»™ç”¨æˆ·æä¾›å®Œæ•´çš„è¡¥å…¨ä¸ç±»å‹æ£€æŸ¥ã€‚
- å¯¹ Logix v3 è€Œè¨€ï¼Œè¿™æ˜¯ **Code-First + Agent-First** ä½“éªŒçš„å…³é”®åŸºç¡€è®¾æ–½ï¼š
  - ç¼–è¾‘ Fluent è§„åˆ™æ—¶ï¼Œç¼–è¾‘å™¨/Agent å¿…é¡»çŸ¥é“ `$` çš„ç²¾ç¡®ç±»å‹ï¼ˆ`state/actions/flow/control/use/services/when*`ï¼‰ï¼›
  - å¿…é¡»çŸ¥é“å½“å‰ Store çš„ State/Action ç»“æ„ï¼Œä»¥åŠå½“å‰å¯ç”¨çš„ Spec/Service/Pattern ç±»å‹ã€‚
- **å»ºè®®è®¾è®¡ä¸€ä¸ªç‹¬ç«‹çš„ d.ts ç”Ÿæˆå™¨**ï¼š
- è¾“å…¥ï¼š`logix-v3-core.ts` ä¸­ Bound API ç±»å‹ + é¡¹ç›®å†…æ‰€æœ‰ Domain / Pattern / Service Tagï¼›
  - è¾“å‡ºï¼š
    - `logix-bound-api.d.ts`ï¼šBound API æ ¸å¿ƒç­¾åï¼›
    - `project-logix-context.d.ts`ï¼šå½“å‰é¡¹ç›®/åœºæ™¯ç›¸å…³ Spec/Pattern/Service çš„ç±»å‹å£°æ˜å­é›†ï¼›
  - ç”± Language Server / Studio æ³¨å…¥åˆ° Monaco æˆ– TS è¯­è¨€æœåŠ¡ä¸­ï¼Œç»Ÿä¸€ä¸ºäººç±»ä¸ Agent æä¾›æ™ºèƒ½æ„ŸçŸ¥ã€‚

### 6.5 Pattern Registry ä¸ Metadata Bundler

- BubbleLab ä½¿ç”¨ Bubble ç±» +å·¥å‚ + å…ƒæ•°æ®è„šæœ¬æ„å»ºäº†å®Œæ•´çš„ Bubble èµ„äº§ä½“ç³»ï¼Œå¹¶ç”Ÿæˆæ–‡æ¡£ä¸ä»£ç ç”Ÿæˆå‹å¥½çš„æ¸…å•ã€‚
- å¯¹ Logix v3 çš„å¯¹åº”åŠ¨ä½œï¼ˆä¸å‰æ–‡ Pattern èµ„äº§åº“å‘¼åº”ï¼‰ï¼š
  - è§„èŒƒ Pattern å®šä¹‰æ–¹å¼ï¼ˆå¯¼å‡ºç­¾å + Config Schema + JSDocï¼‰ï¼›
  - ç¼–å†™ `scripts/pattern-metadata-bundler.ts`ï¼š
    - æ‰«æä»“åº“ä¸­çš„ Pattern å®šä¹‰ï¼›
    - æŠ½å–åç§°ã€Config Schema ç±»å‹ä¿¡æ¯ã€JSDoc æè¿°ç­‰ï¼›
    - ç”Ÿæˆ `patterns.json` / `patterns/*.json` ä½œä¸º Pattern Registryã€‚
  - Studio/Galaxy ç›´æ¥æ¶ˆè´¹è¯¥ Registry æ¸²æŸ“ Pattern palette ä¸ Config Panelï¼ŒAgent ä¹Ÿèƒ½ä»ä¸­è·çŸ¥â€œå¯ç”¨ç§¯æœ¨â€çš„å…¨é›†ã€‚

ä»¥ä¸Šå†…å®¹æš‚ä½œä¸ºå¯¹ BubbleLab çš„â€œå¯¹ç…§å¯å‘â€è‰ç¨¿ï¼Œåç»­å¯ä»¥æŒ‰ä¼˜å…ˆçº§å°†å…¶ä¸­çš„ 1â€“2 æ¡æ¼”è¿›ä¸ºæ­£å¼çš„ v3/impl è§„èŒƒä¸ PoCï¼ˆä¾‹å¦‚å…ˆå®ç° d.ts ç”Ÿæˆå™¨æˆ– Pattern metadata bundlerï¼‰ï¼Œå†é€æ­¥å¹¶å…¥ä¸»çº¿è®¾è®¡ã€‚
</file>

<file path="drafts/topics/platform-vision/01-evolutionary-vision.md">
---
title: Logix Evolutionary Vision (Entropy, Adaptive, Economics)
status: draft
version: 2025-11-28
---

# Logix æ¼”è¿›æ„¿æ™¯ï¼šä»å·¥å…·åˆ°æœ‰æœºç”Ÿå‘½ä½“

æœ¬æ–‡æ¡£åŸºäº "Intent-Driven" ä¸ "AI Native" æ¶æ„ï¼Œæå‡ºä¸‰ä¸ªé¢ è¦†æ€§çš„æ¼”è¿›æ–¹å‘ï¼Œæ—¨åœ¨å°† Logix å¹³å°ä»ä¸€ä¸ªé™æ€çš„å¼€å‘ç³»ç»Ÿæ¨å‘ä¸€ä¸ª**å…·å¤‡è‡ªæˆ‘æ„è¯†ã€è‡ªä¸»æ¼”è¿›çš„æœ‰æœºç”Ÿæ€ç³»ç»Ÿ**ã€‚

## 1. é€»è¾‘ç†µçš„é‡åŒ–ä¸ä¸»åŠ¨ç®¡ç† (Logic Entropy Management)

**æ ¸å¿ƒç†å¿µ**ï¼šå°†è½¯ä»¶ç»´æŠ¤æˆæœ¬ï¼ˆç†µå¢ï¼‰è½¬åŒ–ä¸ºå¯åº¦é‡ã€å¯é¢„æµ‹ã€å¯ç”± AI ä¸»åŠ¨ç®¡ç†çš„æŒ‡æ ‡ã€‚

### 1.1 å®šä¹‰â€œé€»è¾‘ç†µâ€ (Logic Entropy)
ä¸€ä¸ªæ¨¡å—çš„ç†µå€¼ $E$ ç”±å…¶å†…éƒ¨â€œé»‘ç›’ä»£ç â€ä¸â€œç™½ç›’æ„å›¾â€çš„æ¯”ç‡å†³å®šï¼š
$$ E = \frac{\text{BlackBox Complexity}}{\text{WhiteBox IntentRules}} \times \text{Dependency Weight} $$

*   **ç™½ç›’ (Low Entropy)**: `IntentRule`, `Fluent DSL`, `Pattern Reference`ã€‚
*   **é»‘ç›’ (High Entropy)**: æ‰‹å†™çš„å¤æ‚ `Effect` ç»„åˆã€æœªå°è£…çš„ç¬¬ä¸‰æ–¹è°ƒç”¨ã€ç¡¬ç¼–ç çš„ä¸šåŠ¡é€»è¾‘ã€‚

### 1.2 æ¶æ„å¥åº·åº¦ä»ªè¡¨ç›˜ (Health Dashboard)
*   **çƒ­åŠ›å›¾è§†å›¾**: ç”¨é¢œè‰²æ·±æµ…å±•ç¤ºå…¨ç³»ç»Ÿçš„ç†µå€¼åˆ†å¸ƒã€‚
*   **è…åŒ–é¢„è­¦**: å®æ—¶ç›‘æ§é«˜ç†µæ¨¡å—çš„å¢é•¿è¶‹åŠ¿ï¼Œè¯†åˆ«â€œç ´çª—æ•ˆåº”â€çš„æºå¤´ã€‚

### 1.3 AI å…ç–«ç³»ç»Ÿ (AI Immune System)
AI Agent ä¸ä»…ç”Ÿæˆä»£ç ï¼Œæ›´è´Ÿè´£**é™ç†µ**ï¼š
*   **ä¸»åŠ¨é‡æ„**: æ‰«æé«˜ç†µæ¨¡å—ï¼Œè¯†åˆ«é‡å¤æ¨¡å¼ï¼Œæè®®å°è£…ä¸º `Pattern`ã€‚
*   **ç¤ºä¾‹**: "æ£€æµ‹åˆ°æ¨¡å— A/B/C å­˜åœ¨ç›¸ä¼¼çš„æ•°æ®æ¸…æ´—é€»è¾‘ï¼ˆé»‘ç›’ï¼‰ï¼Œå»ºè®®é‡æ„ä¸º `DataNormalizationPattern`ï¼Œé¢„è®¡é™ä½ç³»ç»Ÿæ€»ç†µ 5%ã€‚"

---

## 2. åŠ¨æ€ Spec ä¸è‡ªé€‚åº”è¿è¡Œæ—¶ (Dynamic Spec & Adaptive Runtime)

**æ ¸å¿ƒç†å¿µ**ï¼š`Logix.Module` ä¸å†æ˜¯é™æ€å¥‘çº¦ï¼Œè€Œæ˜¯æ ¹æ®è¿è¡Œæ—¶è§‚æµ‹æ•°æ®è‡ªä¸»æ¼”è¿›çš„åŠ¨æ€å¯¹è±¡ã€‚

### 2.1 è¿è¡Œæ—¶æ¨¡å¼è¯†åˆ« (Runtime Pattern Recognition)
Logix Runtime æŒç»­åˆ†æ Trace æ•°æ®ï¼š
*   **å…³è”æŒ–æ˜**: "Action A è§¦å‘åï¼Œ95% æ¦‚ç‡ç´§æ¥ç€è§¦å‘ Action Bã€‚"
*   **æ­»ä»£ç æ£€æµ‹**: "State ä¸­çš„ `optionalField` åœ¨è¿‡å» 30 å¤©ä»æœªè¢«è¯»å–æˆ–å†™å…¥ã€‚"

### 2.2 Schema è¿›åŒ–ææ¡ˆ (Evolution Proposals)
AI Agent åŸºäºè§‚æµ‹å‘èµ· Spec å˜æ›´ PRï¼š
*   **Action èšåˆ**: å»ºè®®åˆå¹¶é«˜é¢‘å…³è”çš„ Action ä»¥å‡å°‘é€šä¿¡å¼€é”€ã€‚
*   **Schema å‰ªæ**: å»ºè®®ç§»é™¤åºŸå¼ƒå­—æ®µä»¥å‡è½» Payloadã€‚

### 2.3 è‡ªé€‚åº”é€»è¾‘è·¯ç”± (Adaptive Logic Routing)
*   **å¤šç‰ˆæœ¬å…±å­˜**: å…è®¸åŒä¸€ `IntentRule` å­˜åœ¨å¤šä¸ª `Logic` å®ç°ï¼ˆå¦‚ï¼šä¿å®ˆç‰ˆ vs æ¿€è¿›ç‰ˆï¼‰ã€‚
*   **åŠ¨æ€è·¯ç”±**: è¿è¡Œæ—¶æ ¹æ®æˆåŠŸç‡ã€å»¶è¿Ÿã€Token æ¶ˆè€—ï¼ŒåŠ¨æ€è°ƒæ•´æµé‡åˆ†é…ï¼ˆå¤šè‡‚è€è™æœºç®—æ³•ï¼‰ã€‚
*   **ä¼˜èƒœåŠ£æ±°**: è‡ªåŠ¨å›ºåŒ–è¡¨ç°æœ€ä¼˜çš„å®ç°ä¸ºé»˜è®¤ç‰ˆæœ¬ã€‚

---

## 3. é€»è¾‘çš„ç»æµå­¦æ¨¡å‹ (The Economic Model of Logic)

**æ ¸å¿ƒç†å¿µ**ï¼šä¸ºæ¯ä¸€æ¡ `IntentRule` å»ºç«‹æŠ•å…¥äº§å‡ºæ¯” (ROI) æ¨¡å‹ï¼Œå°†æŠ€æœ¯å†³ç­–ä¸å•†ä¸šä»·å€¼æŒ‚é’©ã€‚

### 3.1 å…¨æˆæœ¬æ ¸ç®— (Full Cost Accounting)
*   **AI æˆæœ¬**: Token æ¶ˆè€—ï¼ˆå·²æ”¯æŒï¼‰ã€‚
*   **è®¡ç®—æˆæœ¬**: CPU/Memory/IO å¼€é”€ã€‚
*   **ç»´æŠ¤æˆæœ¬**: åŸºäºâ€œé€»è¾‘ç†µâ€ä¼°ç®—çš„æœªæ¥ç»´æŠ¤ä»£ä»·ã€‚

### 3.2 ä»·å€¼å½’å›  (Value Attribution)
*   **ä¸šåŠ¡ä»·å€¼æ ‡æ³¨**: å…è®¸ä¸ºå…³é”® `IntentRule` æ ‡æ³¨ä»·å€¼æƒé‡ï¼ˆå¦‚â€œæ”¯ä»˜é€»è¾‘â€æƒé‡ 100ï¼Œâ€œå¤´åƒé¢„è§ˆâ€æƒé‡ 1ï¼‰ã€‚
*   **æ•ˆæœå½’å› **: å°è¯•å°†ä¸šåŠ¡æŒ‡æ ‡ï¼ˆè½¬åŒ–ç‡ã€ç•™å­˜ç‡ï¼‰çš„å˜åŒ–å½’å› åˆ°ç‰¹å®š Logic çš„æ‰§è¡Œä¸Šã€‚

### 3.3 æˆæœ¬é©±åŠ¨çš„æ™ºèƒ½å†³ç­– (Cost-Aware Intelligence)
*   **ç»æµå‹ Agent**: åœ¨ç”Ÿæˆä»£ç æ—¶ï¼Œæƒè¡¡å®ç°æˆæœ¬ä¸è¿è¡Œæˆæœ¬ã€‚
    *   "æ–¹æ¡ˆ A ä»£ç ç®€æ´ä½†è¿è¡Œè´µï¼ˆGPT-4ï¼‰ï¼›æ–¹æ¡ˆ B å¤æ‚ä½†è¿è¡Œä¾¿å®œï¼ˆLocal LLMï¼‰ã€‚é‰´äºæ­¤åŠŸèƒ½ä»·å€¼è¾ƒä½ï¼Œæ¨èæ–¹æ¡ˆ Bã€‚"
*   **åŠ¨æ€é™çº§**: è¿è¡Œæ—¶åœ¨é¢„ç®—ç´§å¼ æˆ–è´Ÿè½½é«˜æ—¶ï¼Œè‡ªåŠ¨å¯¹ä½ä»·å€¼ Logic è¿›è¡Œé™çº§ï¼ˆåˆ‡æ¢å»‰ä»·æ¨¡å‹ï¼‰æˆ–ç†”æ–­ã€‚
*   **é‡æ„çš„å•†ä¸šç†ç”±**: "å»ºè®®é‡æ„æ­¤é«˜ç†µæ¨¡å—ï¼Œé¢„è®¡æ¯å¹´èŠ‚çœ $5000 API è´¹ç”¨ï¼Œå¼€å‘æˆæœ¬ä»… $200ã€‚"

---

## 4. æ€»ç»“

è¿™ä¸‰ä¸ªæ–¹å‘å…±åŒæ„æˆäº†ä¸€ä¸ª**æœ‰æœºç”Ÿå‘½ä½“**çš„ç‰¹å¾ï¼š

1.  **æ–°é™ˆä»£è°¢ (Metabolism)**: é€šè¿‡é™ç†µç»´æŒç³»ç»Ÿæœ‰åºã€‚
2.  **è¿›åŒ– (Evolution)**: é€šè¿‡åŠ¨æ€ Spec é€‚åº”ç¯å¢ƒå˜åŒ–ã€‚
3.  **ç†æ€§ (Rationality)**: é€šè¿‡ç»æµæ¨¡å‹ä¼˜åŒ–èµ„æºé…ç½®ã€‚

Logix v4 å°†ä¸å†ä»…ä»…æ˜¯ IDEï¼Œè€Œæ˜¯ä¼ä¸šçš„**æ•°å­—ç¥ç»ç³»ç»Ÿ**ã€‚
</file>

<file path="drafts/topics/platform-vision/10-platform-deep-dive.md">
---
title: Logix Platform Deep Dive Analysis (10 Rounds)
status: draft
version: 2025-11-28
---

# Logix å¹³å°åŒ–æ·±åº¦æ¨æ¼” (10 Rounds Deep Dive)

åŸºäº `competitor-analysis` ä¸ `gap-analysis`ï¼Œæœ¬æ–‡æ¡£è¿›è¡Œ 10 è½®æ·±åº¦é€’å½’æ¨æ¼”ï¼Œæ—¨åœ¨å°† Logix v3 ä»â€œå†…æ ¸å°±ç»ªâ€æ¨å‘â€œå¹³å°å°±ç»ªâ€ã€‚

---

## Round 1: AI Intent åŸè¯­å®šä¹‰ (The "What")

**æ ¸å¿ƒé—®é¢˜**ï¼šæ—¢ç„¶ Logix ç¼º AI Intentï¼Œé‚£ä¹ˆ Agentã€RAGã€Prompt åœ¨ Logix ç±»å‹ç³»ç»Ÿä¸­ç©¶ç«Ÿé•¿ä»€ä¹ˆæ ·ï¼Ÿ

**æ¨æ¼”åˆ†æ**ï¼š
Dify å°† Prompt å’Œ Model Config è§†ä¸ºæ ¸å¿ƒèµ„äº§ã€‚åœ¨ Logix ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½åªæŠŠå®ƒä»¬å½“ä½œ JSON é…ç½®ï¼Œè€Œåº”è¯¥æ˜ å°„ä¸º **Schema** å’Œ **Effect Service**ã€‚

**ç»“è®º/è®¾è®¡**ï¼š
1.  **Prompt as Schema**: Prompt ä¸åªæ˜¯å­—ç¬¦ä¸²æ¨¡æ¿ï¼Œè€Œæ˜¯ `Schema<Input, string>`ã€‚
    ```typescript
    const SummarizePrompt = Prompt.define({
      input: Schema.Struct({ text: Schema.String }),
      template: "Summarize this: {{text}}",
      modelConfig: { temperature: 0.7 }
    });
    ```
2.  **Agent as Pattern**: Agent æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Logix Patternï¼Œæ‹¥æœ‰ç‰¹å®šçš„ Input (Goal) å’Œ Output (Result)ï¼Œå†…éƒ¨å°è£…äº† Loopã€‚
    ```typescript
    const ResearchAgent = Agent.define({
      role: "Researcher",
      tools: [GoogleSearch, WebScraper],
      memory: ShortTermMemory
    });
    ```
3.  **RAG as Service**: RAG ä¸åº”æ˜¯é»‘ç›’ï¼Œè€Œæ˜¯æ ‡å‡†çš„ `RetrieverService` Tagï¼Œå…è®¸é€šè¿‡ Layer æ›¿æ¢å®ç°ï¼ˆæœ¬åœ°å‘é‡åº“ vs äº‘ç«¯æœåŠ¡ï¼‰ã€‚

---

## Round 2: AI Runtime æœºåˆ¶ (The "How")

**æ ¸å¿ƒé—®é¢˜**ï¼šEffect-TS å¦‚ä½•æ”¯æ’‘ Agent çš„ ReAct å¾ªç¯ï¼Ÿå¦‚ä½•å¤„ç†æµå¼è¾“å‡ºä¸ä¸­æ–­ï¼Ÿ

**æ¨æ¼”åˆ†æ**ï¼š
ä¼ ç»Ÿçš„ `while(true)` å¾ªç¯éš¾ä»¥ç›‘æ§å’Œæš‚åœã€‚Effect çš„ `Schedule` å’Œ `Stream` æ˜¯å¤©ç„¶çš„ Agent è¿è¡Œæ—¶ã€‚

**ç»“è®º/è®¾è®¡**ï¼š
1.  **Agent Loop = Recursive Effect**: ä½¿ç”¨ `Effect.iterate` æˆ–é€’å½’å‡½æ•°å®ç° ReAct å¾ªç¯ï¼Œæ¯ä¸€æ­¥ï¼ˆThought, Action, Observationï¼‰éƒ½æ˜¯ä¸€ä¸ªå¯è¿½è¸ªçš„ Spanã€‚
2.  **Interruptibility**: åˆ©ç”¨ Effect çš„ä¸­æ–­æœºåˆ¶ï¼Œå®ç°â€œç”¨æˆ·ç‚¹å‡»åœæ­¢ï¼ŒAgent ç«‹å³ç»ˆæ­¢ä¸”å›æ»šå‰¯ä½œç”¨ï¼ˆå¦‚æœªå®Œæˆçš„å†™æ“ä½œï¼‰â€ã€‚
3.  **Streaming**: Agent çš„æ€è€ƒè¿‡ç¨‹ï¼ˆThoughtï¼‰é€šè¿‡ `Stream<String>` å®æ—¶æ¨é€åˆ°å‰ç«¯ï¼Œè€Œä¸æ˜¯ç­‰æ•´ä¸ª Loop ç»“æŸã€‚

---

## Round 3: ç”Ÿæ€æ„å»ºä¸é€‚é…å™¨ (The "Ecosystem")

**æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•ä½æˆæœ¬å¼•å…¥ n8n/OpenAPI ç”Ÿæ€ï¼Ÿæ‰‹å†™ 400+ é›†æˆæ˜¯ä¸å¯èƒ½çš„ã€‚

**æ¨æ¼”åˆ†æ**ï¼š
n8n çš„èŠ‚ç‚¹æœ¬è´¨ä¸Šæ˜¯ JSON æè¿°çš„ API è°ƒç”¨ã€‚OpenAPI (Swagger) ä¹Ÿæ˜¯ã€‚æˆ‘ä»¬å¯ä»¥ç¼–å†™ç¼–è¯‘å™¨ã€‚

**ç»“è®º/è®¾è®¡**ï¼š
1.  **OpenAPI to Logix Tag**: å¼€å‘ `openapi-to-logix` å·¥å…·ï¼Œè¯»å– `swagger.json`ï¼Œè‡ªåŠ¨ç”Ÿæˆï¼š
    *   `Service Tag` å®šä¹‰ï¼›
    *   `Schema` (Zod/Effect) å®šä¹‰ï¼›
    *   åŸºäº `fetch` çš„é»˜è®¤ `Layer` å®ç°ã€‚
2.  **n8n Adapter**: é•¿æœŸç›®æ ‡ã€‚ç¼–å†™ä¸€ä¸ª Adapter è¯»å– n8n çš„ JSON èŠ‚ç‚¹å®šä¹‰ï¼ŒåŠ¨æ€ç”Ÿæˆ Logix Flowã€‚

---

## Round 4: å…¨åŒå·¥ Parser ç­–ç•¥ (The "Bridge")

**æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•å®ç° BubbleLab çº§åˆ«çš„ Code-First ä½“éªŒï¼ŸParser æ€ä¹ˆä» Effect ä»£ç è¿˜åŸ Intentï¼Ÿ

**æ¨æ¼”åˆ†æ**ï¼š
å®Œå…¨è§£æä»»æ„ TypeScript ä»£ç æ˜¯ä¸å¯èƒ½çš„ã€‚å¿…é¡»å®šä¹‰ä¸€ä¸ª **"Parsable Subset" (å¯è§£æå­é›†)**ã€‚

**ç»“è®º/è®¾è®¡**ï¼š
1.  **Strict Subset**: åªæœ‰ä½¿ç”¨ `Logix.flow`, `$.onState / $.onAction / $.on`, `Agent.define` ç­‰ç‰¹å®š API çš„ä»£ç æ‰ä¼šè¢« Parser è¯†åˆ«ä¸ºå›¾èŠ‚ç‚¹ã€‚
2.  **Gray Box**: è¶…å‡ºå­é›†çš„ä»£ç ï¼ˆä»»æ„ Effect é€»è¾‘ï¼‰åœ¨ç”»å¸ƒä¸Šæ˜¾ç¤ºä¸ºâ€œé»‘ç›’èŠ‚ç‚¹â€ï¼Œåªè¯»ä¸å¯ç¼–è¾‘ï¼Œä½†èƒ½æ­£å¸¸è¿è¡Œã€‚
3.  **AST Mapping**: å»ºç«‹ `IntentRule <-> TS AST` çš„åŒå‘æ˜ å°„è¡¨ï¼Œç¡®ä¿ä¿®æ”¹ç”»å¸ƒèƒ½ç²¾ç¡®æ›´æ–°ä»£ç ï¼Œä¿®æ”¹ä»£ç èƒ½åˆ·æ–°ç”»å¸ƒã€‚

---

## Round 5: å¼€å‘è€…ä½“éªŒä¸å·¥å…·é“¾ (The "DX")

**æ ¸å¿ƒé—®é¢˜**ï¼šå¼€å‘è€…æ€ä¹ˆç”¨ï¼ŸCLI æ€ä¹ˆè®¾è®¡ï¼Ÿ

**æ¨æ¼”åˆ†æ**ï¼š
Effect çš„é—¨æ§›è¾ƒé«˜ï¼Œéœ€è¦è„šæ‰‹æ¶å±è”½é…ç½®å¤æ‚åº¦ã€‚

**ç»“è®º/è®¾è®¡**ï¼š
1.  **`logix` CLI**:
    *   `logix new`: åŸºäºæ¨¡æ¿åˆ›å»ºé¡¹ç›®ã€‚
    *   `logix dev`: å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨ + Studio UIã€‚
    *   `logix generate`: æ ¹æ® OpenAPI ç”Ÿæˆ Service Tagã€‚
2.  **Local Studio**: æä¾›ä¸€ä¸ªæœ¬åœ°è¿è¡Œçš„ Web UI (Next.js)ï¼Œè¿æ¥åˆ°å½“å‰é¡¹ç›®çš„ `logix-server`ï¼Œå¯è§†åŒ–ç¼–è¾‘ Intentã€‚

---

## Round 6: å¯è§‚æµ‹æ€§ä¸ AI è°ƒè¯• (The "Observability")

**æ ¸å¿ƒé—®é¢˜**ï¼šAI ä¸å¯æ§ï¼Œæ€ä¹ˆè°ƒè¯•ï¼ŸEffect Trace å¤Ÿç”¨å—ï¼Ÿ

**æ¨æ¼”åˆ†æ**ï¼š
Effect Trace å¾ˆå¥½ï¼Œä½†å¤ªåº•å±‚ã€‚AI å¼€å‘è€…å…³å¿ƒçš„æ˜¯ Token æ¶ˆè€—ã€Prompt å®é™…å†…å®¹ã€å·¥å…·è°ƒç”¨å‚æ•°ã€‚

**ç»“è®º/è®¾è®¡**ï¼š
1.  **Semantic Spans**: åœ¨ Agent Runtime ä¸­é¢„åŸ‹è¯­ä¹‰åŒ– Span (`Agent.Thought`, `Tool.Call`, `LLM.Request`)ã€‚
2.  **Token Cost Tracking**: åœ¨ Layer å±‚æ‹¦æˆª LLM è°ƒç”¨ï¼Œç»Ÿè®¡ Token Usage å¹¶å†™å…¥ Contextï¼Œæœ€ç»ˆæ±‡æ€»ä¸º Cost æŠ¥å‘Šã€‚
3.  **Replay**: è®°å½• Agent è¿è¡Œçš„æ‰€æœ‰éç¡®å®šæ€§è¾“å…¥ï¼ˆLLM å“åº”ï¼‰ï¼Œæ”¯æŒâ€œç¡®å®šæ€§å›æ”¾â€ä»¥å¤ç° Bugã€‚

---

## Round 7: è®°å¿†ä¸ä¸Šä¸‹æ–‡ç®¡ç† (Memory & Context)

**æ ¸å¿ƒé—®é¢˜**ï¼šAgent çš„è®°å¿†ï¼ˆçŸ­æœŸ/é•¿æœŸï¼‰åœ¨ Logix ä¸­å¦‚ä½•æŠ½è±¡ï¼Ÿ

**æ¨æ¼”åˆ†æ**ï¼š
Memory æœ¬è´¨ä¸Šæ˜¯ Stateã€‚çŸ­æœŸè®°å¿†æ˜¯ `Ref`ï¼Œé•¿æœŸè®°å¿†æ˜¯ `VectorStore`ã€‚

**ç»“è®º/è®¾è®¡**ï¼š
1.  **Context as Layer**: `AgentContext` åº”ä½œä¸º Layer æ³¨å…¥ï¼ŒåŒ…å« `History`, `Variables`ã€‚
2.  **Memory Interface**: å®šä¹‰æ ‡å‡†çš„ `Memory` Tagï¼š
    *   `add(message)`
    *   `search(query)`
    *   `summary()`
3.  **Store Integration**: é•¿æœŸè®°å¿†å¯ä»¥ç”± Logix Module ç®¡ç†ï¼Œé€šè¿‡ `Logix.Module` å®šä¹‰ Schemaï¼ŒæŒä¹…åŒ–åˆ°æ•°æ®åº“ã€‚

---

## Round 8: éƒ¨ç½²ä¸éš”ç¦»æ¶æ„ (Deployment & Isolation)

**æ ¸å¿ƒé—®é¢˜**ï¼šç”Ÿæˆçš„ä»£ç æ€ä¹ˆéƒ¨ç½²ï¼Ÿå¤šç§Ÿæˆ·éš”ç¦»æ€ä¹ˆåšï¼Ÿ

**æ¨æ¼”åˆ†æ**ï¼š
ç”Ÿæˆçš„ä»£ç æ˜¯çº¯ TS/JSï¼Œå¯ä»¥è¿è¡Œåœ¨ä»»ä½• Node/Bun ç¯å¢ƒã€‚

**ç»“è®º/è®¾è®¡**ï¼š
1.  **Serverless First**: é»˜è®¤ç¼–è¯‘ä¸º Serverless Function (AWS Lambda / Cloudflare Workers)ï¼Œåˆ©ç”¨å…¶å¤©ç„¶éš”ç¦»æ€§ã€‚
2.  **Long-Running Process**: å¯¹äº Stateful Agentï¼ˆéœ€è¦é•¿è¿æ¥/WebSocketï¼‰ï¼Œéƒ¨ç½²ä¸ºå®¹å™¨æœåŠ¡ (Docker)ï¼Œæ¯ä¸ªç§Ÿæˆ·/Session ç‹¬ç«‹æ²™ç®±ã€‚
3.  **Edge Runtime**: å°½å¯èƒ½å…¼å®¹ Edge Runtimeï¼Œå‡å°‘å†·å¯åŠ¨æ—¶é—´ã€‚

---

## Round 9: æµ‹è¯•ä¸è¯„ä¼° (Evals)

**æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•æµ‹è¯•æ¦‚ç‡æ€§çš„ AI Flowï¼Ÿ

**æ¨æ¼”åˆ†æ**ï¼š
ä¼ ç»Ÿçš„å•å…ƒæµ‹è¯•ï¼ˆAssert Equalï¼‰å¯¹ AI æ— æ•ˆã€‚éœ€è¦å¼•å…¥ "Evals" (åŸºäº LLM çš„æ–­è¨€)ã€‚

**ç»“è®º/è®¾è®¡**ï¼š
1.  **Logix Evals**: å¼•å…¥ `Eval` åŸè¯­ã€‚
    ```typescript
    test("Summarization", async () => {
      const result = await runFlow(input);
      await expect(result).toBeRelevantTo(input); // ä½¿ç”¨ LLM åˆ¤æ–­ç›¸å…³æ€§
    });
    ```
2.  **Dataset Management**: å¹³å°éœ€æ”¯æŒç®¡ç†â€œé»„é‡‘æ•°æ®é›†â€ (Golden Datasets)ï¼Œç”¨äºæ‰¹é‡å›å½’æµ‹è¯•ã€‚

---

## Round 10: ç»ˆå±€æ„¿æ™¯ä¸è·¯çº¿å›¾ (Synthesis)

**æ ¸å¿ƒé—®é¢˜**ï¼šè¿™ä¸€åˆ‡æœ€ç»ˆæ±‡èšæˆä»€ä¹ˆï¼Ÿ

**æ¨æ¼”åˆ†æ**ï¼š
Logix v4 å°†æ˜¯ä¸€ä¸ª **"AI-Native DevOps Platform"**ã€‚å®ƒä¸ä»…æ˜¯å¼€å‘å·¥å…·ï¼Œä¹Ÿæ˜¯è¿è¡Œæ—¶åº•åº§ã€‚

**è·¯çº¿å›¾ (Phasing)**ï¼š
1.  **Phase 1 (Kernel)**: å®Œå–„ `effect-runtime-poc`ï¼Œæ‰“é€š Agent Loop å’Œ AI Intent åŸè¯­ã€‚ (Current)
2.  **Phase 2 (Tooling)**: å‘å¸ƒ CLI å’Œ Parserï¼Œå®ç°åŸºæœ¬çš„ Code <-> Graph åŒå‘åŒæ­¥ã€‚
3.  **Phase 3 (Ecosystem)**: å‘å¸ƒ OpenAPI Importerï¼Œæ„å»º Pattern Registryã€‚
4.  **Phase 4 (Platform)**: ä¸Šçº¿ Cloud å¹³å°ï¼Œæä¾› Hosting å’Œ Evals èƒ½åŠ›ã€‚
</file>

<file path="drafts/topics/platform-vision/11-gap-analysis.md">
---
title: Logix Platform Readiness Gap Analysis
status: draft
version: 2025-11-28
---

# Logix å¹³å°åŒ–èƒ½åŠ›å·®è·åˆ†æ (Gap Analysis)

æœ¬æ–‡æ¡£åŸºäº Logix v3 ç°çŠ¶ï¼Œå®¢è§‚è¯„ä¼°å…¶æ”¯æ’‘ BubbleLab / n8n / Dify çº§åˆ«å¹³å°èƒ½åŠ›çš„å·®è·ä¸æŒ‘æˆ˜ã€‚

## 1. æ ¸å¿ƒç»“è®º (Verdict)

**Logix Core (Runtime) å·²å°±ç»ªï¼Œä½†ç”Ÿæ€ (Ecosystem) ä¸å·¥å…·é“¾ (Tooling) ä¸¥é‡ç¼ºå¤±ã€‚**

*   **Runtime (Effect-TS)**: âœ… **å¼ºäºç«å“**ã€‚ç±»å‹å®‰å…¨ã€å¹¶å‘æ§åˆ¶ã€é”™è¯¯å¤„ç†èƒ½åŠ›å‡ä¼˜äº n8n (JSON) å’Œ Dify (Python/LangChain)ã€‚
*   **Intent Model**: âš ï¸ **éƒ¨åˆ†å°±ç»ª**ã€‚Logic/Flow å®šä¹‰æ¸…æ™°ï¼Œä½† UI Intent å°šåœ¨æ¢ç´¢ï¼ŒAI Intent å‡ ä¹ç©ºç™½ã€‚
*   **Tooling**: âŒ **æœªå°±ç»ª**ã€‚ç¼ºä¹ Parserã€Codegen å’Œå¯è§†åŒ–ç¼–è¾‘å™¨ï¼Œç›®å‰ä»…åœç•™åœ¨â€œæ‰‹å†™ä»£ç â€é˜¶æ®µã€‚

## 2. è¯¦ç»†å·®è·åˆ†æ

### 2.1 å¯¹æ ‡ BubbleLab (Code Gen)

*   **ç°çŠ¶**: Logix ç¡®ç«‹äº† "Intent â†’ Code" å“²å­¦ï¼Œä¸” Effect ä»£ç å…·å¤‡ç”Ÿäº§çº§è´¨é‡ã€‚
*   **å·®è·**:
    *   **ç¼º Parser**: æ— æ³•ä»ä»£ç åå‘è¿˜åŸ IntentRuleï¼ˆå…¨åŒå·¥æ–­è£‚ï¼‰ã€‚
    *   **ç¼º CLI**: æ²¡æœ‰ `create-logix-app`ï¼Œå¼€å‘è€…æ— æ³•ä¸€é”®åˆå§‹åŒ–ç¯å¢ƒã€‚
    *   **ç¼º Project Structure**: å°šæœªå®šä¹‰æ ‡å‡†åŒ–çš„â€œLogix é¡¹ç›®ç»“æ„â€ï¼ˆç±»ä¼¼ Next.js çš„ç›®å½•è§„èŒƒï¼‰ã€‚

### 2.2 å¯¹æ ‡ n8n (Integrations)

*   **ç°çŠ¶**: æœ‰ `Service Tag` å’Œ `Layer` æœºåˆ¶ï¼Œç†è®ºä¸Šå¯å°è£…ä»»ä½• APIã€‚
*   **å·®è·**:
    *   **ç¼ºæ ‡å‡†åº“ (StdLib)**: n8n æœ‰ 400+ èŠ‚ç‚¹ï¼ŒLogix ç›®å‰åªæœ‰ Demo çº§çš„ OrderServiceã€‚
    *   **ç¼º Registry**: æ²¡æœ‰ç»Ÿä¸€çš„ Pattern åˆ†å‘ä¸å®‰è£…æœºåˆ¶ã€‚
    *   **ç¼º Adapter**: æ— æ³•å¤ç”¨ç°æœ‰çš„ OpenAPI / n8n èŠ‚ç‚¹å®šä¹‰ï¼Œæ¯ä¸ªé›†æˆéƒ½éœ€è¦æ‰‹å†™ Effect å°è£…ã€‚

### 2.3 å¯¹æ ‡ Dify (AI Native)

*   **ç°çŠ¶**: ä»…èƒ½é€šè¿‡ `callService` è°ƒç”¨ LLM APIã€‚
*   **å·®è·**:
    *   **ç¼º AI Intent**: æ²¡æœ‰ `Agent`, `RAG`, `Prompt` çš„ä¸€ç­‰å…¬æ°‘å®šä¹‰ã€‚
    *   **ç¼º Memory/Context**: ç¼ºä¹å¯¹ Agent è®°å¿†ï¼ˆçŸ­æœŸ/é•¿æœŸï¼‰çš„æ ‡å‡†æŠ½è±¡ã€‚
    *   **ç¼º Observability**: è™½ç„¶æœ‰ Effect Traceï¼Œä½†ç¼ºä¹é’ˆå¯¹ Token Usageã€Prompt Latency çš„ AI ä¸“ç”¨ç›‘æ§è§†å›¾ã€‚

## 3. å…³é”®ç¼ºå¤±æ¨¡å— (Missing Building Blocks)

ä¸ºäº†æ”¯æ’‘å¹³å°åŒ–ï¼ŒLogix å¿…é¡»è¡¥é½ä»¥ä¸‹æ¨¡å—ï¼š

1.  **AI Pattern Kit**:
    *   `AgentPattern`: å°è£… ReAct å¾ªç¯ã€‚
    *   `PromptTemplate`: æ”¯æŒç‰ˆæœ¬ç®¡ç†çš„ Prompt èµ„äº§ã€‚
    *   `VectorStore`: RAG æ ‡å‡†æ¥å£ã€‚

2.  **Logix CLI & Scaffolding**:
    *   æä¾›å¼€ç®±å³ç”¨çš„é¡¹ç›®æ¨¡æ¿ï¼Œå±è”½ Effect é…ç½®å¤æ‚åº¦ã€‚

3.  **Universal Adapter**:
    *   ä¸€ä¸ªèƒ½å°† OpenAPI / Swagger è‡ªåŠ¨è½¬æ¢ä¸º Logix Service Tag çš„å·¥å…·ï¼Œå¿«é€Ÿå¡«å……ç”Ÿæ€ã€‚

## 4. ç»“è®ºä¸å»ºè®®

Logix **æ”¯æ’‘å¾—äº†** åšå¹³å°ï¼Œå…¶åº•åº§ç”šè‡³æ›´å…ˆè¿›ã€‚ä½†è¦è¾¾åˆ°ç«å“çš„å¯ç”¨æ€§ï¼Œ**ä¸èƒ½åªåš Runtime**ã€‚

**å»ºè®®ä¼˜å…ˆçº§**ï¼š
1.  **AI Native (P0)**: è¡¥é½ AI Intentï¼Œå¦åˆ™æ— æ³•å¯¹æ ‡ Difyã€‚
2.  **Codegen/Parser (P1)**: æ‰“é€šå…¨åŒå·¥ï¼Œå¦åˆ™æ— æ³•å¯¹æ ‡ BubbleLabã€‚
3.  **Integrations (P2)**: é€šè¿‡ OpenAPI Adapter è§£å†³ï¼Œè€Œä¸æ˜¯æ‰‹å†™ã€‚
</file>

<file path="drafts/topics/platform-vision/12-competitor-analysis.md">
---
title: Competitor Analysis & Inspirations (BubbleLab, n8n, Dify)
status: draft
version: 2025-11-28
---

# ç«å“åˆ†æä¸å¯ç¤ºï¼šBubbleLab / n8n / Dify

æœ¬æ–‡æ¡£åˆ†æ BubbleLabã€n8n å’Œ Dify ä¸‰ä¸ªå¹³å°çš„æ ¸å¿ƒç‰¹æ€§ä¸æ¶æ„å“²å­¦ï¼Œå¹¶æ¢è®¨å®ƒä»¬å¯¹ `intent-flow` (Logix v3) å¹³å°çš„å¯ç¤ºã€‚

## 1. å¹³å°æ¦‚è§ˆ

| å¹³å° | æ ¸å¿ƒå®šä½ | å…³é”®ç‰¹æ€§ | æ¶æ„æ¨¡å¼ | å¯¹æ ‡ Logix ç»´åº¦ |
| :--- | :--- | :--- | :--- | :--- |
| **BubbleLab** | AI-Native Workflow Automation | Prompt-to-Workflow, **Export to TypeScript**, Full Observability | Compiler + Runtime (Monorepo) | **Codegen & DX** (Intent â†’ Code) |
| **n8n** | Workflow Automation | Visual Node Editor, 400+ Integrations, Self-hostable | JSON Interpreter Runtime | **Service Ecosystem** (Pattern/Layer) |
| **Dify** | LLM App Development | RAG Engine, Prompt IDE, Agent Orchestration, BaaS | LLM Ops Platform | **AI Domain Intent** (Agent/RAG) |

## 2. æ·±åº¦åˆ†æä¸å¯ç¤º

### 2.1 BubbleLabï¼šä»£ç ç”Ÿæˆçš„åŒè·¯äºº

BubbleLab ä¸ `intent-flow` çš„æ„¿æ™¯æœ€ä¸ºæ¥è¿‘ï¼Œå®ƒæ‰“ç ´äº†ä¼ ç»Ÿä½ä»£ç å¹³å°â€œé”æ­»åœ¨ JSON è¿è¡Œæ—¶â€çš„è¯…å’’ã€‚

*   **æ ¸å¿ƒå¯ç¤ºï¼šCode as Artifact (ä»£ç å³äº§ç‰©)**
    *   BubbleLab çš„æ€æ‰‹é”æ˜¯å°†å¯è§†åŒ–æµç¨‹ç¼–è¯‘ä¸º **Clean TypeScript**ã€‚è¿™éªŒè¯äº†æˆ‘ä»¬åšæŒ "Intent â†’ Code" è€Œé "Intent â†’ JSON Engine" çš„æ­£ç¡®æ€§ã€‚
    *   **Logix ç­–ç•¥**ï¼šå¿…é¡»ç¡®ä¿ç”Ÿæˆçš„ä»£ç æ˜¯ **Human-Readable** ä¸” **Production-Ready** çš„ã€‚Logix çš„ `Effect.gen` + `Flow` DSL é£æ ¼æ­£æ˜¯ä¸ºäº†è¾¾æˆè¿™ä¸€ç›®æ ‡ã€‚
    *   **DX**ï¼šBubbleLab æä¾›äº† CLI (`create-bubblelab-app`) å’Œæœ¬åœ°å¼€å‘æ”¯æŒã€‚Logix ä¹Ÿåº”æä¾›ç±»ä¼¼è„šæ‰‹æ¶ï¼Œè®©ç”Ÿæˆçš„é¡¹ç›®èƒ½è„±ç¦»å¹³å°ç‹¬ç«‹è¿è¡Œã€‚

*   **Prompt to Workflow**
    *   å…¶ "Pearl" åŠ©æ‰‹èƒ½ç›´æ¥ä»è‡ªç„¶è¯­è¨€ç”Ÿæˆæµã€‚
    *   **Logix ç­–ç•¥**ï¼šè¿™å¯¹åº”æˆ‘ä»¬çš„ **L0 (Requirement) â†’ L1 (Blueprint)** è½¬åŒ–å±‚ã€‚æˆ‘ä»¬éœ€è¦æ„å»ºä¸“é—¨çš„ Agent (Generator) æ¥æ¶ˆè´¹ L0 è¾“å…¥å¹¶è¾“å‡º IntentRule/DSLã€‚

### 2.2 n8nï¼šé›†æˆç”Ÿæ€çš„æ ‡æ†

n8n è¯æ˜äº†â€œèŠ‚ç‚¹åŒ–â€å’Œâ€œä¸°å¯Œé›†æˆâ€çš„ä»·å€¼ã€‚

*   **æ ¸å¿ƒå¯ç¤ºï¼šService/Pattern çš„æ ‡å‡†åŒ–**
    *   n8n çš„å¼ºå¤§åœ¨äºå…¶åºå¤§çš„èŠ‚ç‚¹åº“ã€‚
    *   **Logix ç­–ç•¥**ï¼šLogix çš„ `Logix.Module` å’Œ `Service Tag` ä½“ç³»å¿…é¡»è¶³å¤Ÿç®€å•ï¼Œä»¥ä¾¿å¿«é€Ÿå°è£…ç¬¬ä¸‰æ–¹ APIã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ª **Registry** æœºåˆ¶ï¼Œå…è®¸å¼€å‘è€…åƒå†™ n8n èŠ‚ç‚¹ä¸€æ ·å®šä¹‰ Logix Pattern (Interface + Implementation)ã€‚
    *   **äº’æ“ä½œæ€§**ï¼šå°† "åå™¬ n8n ç”Ÿæ€" å®šä½ä¸º **è¿ç§»è¾…åŠ© (Migration Tool)** è€Œéè¿è¡Œæ—¶å…¼å®¹ã€‚
        *   æä¾› CLI å·¥å…·å°† n8n JSON è½¬æ¢ä¸º Logix Flow DSL (Skeleton)ã€‚
        *   æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·ï¼šè¯­ä¹‰å¯èƒ½ä¸å®Œå…¨ç­‰ä»·ï¼Œéœ€äººå·¥ Reviewã€‚
        *   é¿å…ä¸ºäº†å…¼å®¹ JSON Runtime è€Œç‰ºç‰² Effect çš„ç±»å‹å®‰å…¨ä¼˜åŠ¿ã€‚

### 2.3 Difyï¼šAI æ„å›¾çš„é¢†åŸŸæ¨¡å‹

Dify å±•ç¤ºäº†å¦‚ä½•ä¸º "AI Agent" è¿™ä¸€ç‰¹å®šé¢†åŸŸå»ºæ¨¡ã€‚

*   **æ ¸å¿ƒå¯ç¤ºï¼šAI Domain Intent**
    *   Dify å°† RAGã€Promptã€Tools è§†ä¸ºä¸€ç­‰å…¬æ°‘ã€‚
    *   **Logix ç­–ç•¥**ï¼šç›®å‰çš„ Logix ä¾§é‡äºé€šç”¨ä¸šåŠ¡é€»è¾‘ (UI/State/Flow)ã€‚ä¸ºäº†æ”¯æ’‘ AI ç¼–ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ **AI Pattern**ï¼š
        *   `AgentPattern`: å°è£… ReAct / Function Calling å¾ªç¯ã€‚
        *   `RAGPattern`: å°è£…å‘é‡æ£€ç´¢ä¸ä¸Šä¸‹æ–‡æ³¨å…¥ã€‚
        *   `PromptIntent`: å°† Prompt æ¨¡æ¿åŒ–å¹¶ä½œä¸ºèµ„äº§ç®¡ç†ã€‚
    *   **Orchestration**ï¼šDify çš„ç¼–æ’èƒ½åŠ›ï¼ˆWorkflowï¼‰å¯¹åº” Logix çš„ `Flow`ã€‚Logix çš„ `Effect` è¿è¡Œæ—¶åœ¨å¹¶å‘æ§åˆ¶å’Œé”™è¯¯å¤„ç†ä¸Šæ¯” Dify çš„ Python åç«¯æ›´å…·ä¼˜åŠ¿ï¼ˆç±»å‹å®‰å…¨ã€è½»é‡çº§ï¼‰ã€‚

### 2.4 è¡¥å……ç»´åº¦ï¼šLogix çš„ç‹¬ç‰¹ä¼˜åŠ¿

é™¤äº†ä¸Šè¿°å¯¹æ ‡ï¼ŒLogix è¿˜åº”åœ¨ä»¥ä¸‹ç»´åº¦å»ºç«‹æŠ¤åŸæ²³ï¼š

*   **Lifecycle & Versioning**: åŸºäº Git çš„ Flow ç‰ˆæœ¬ç®¡ç†ä¸å›æ»šç­–ç•¥ (vs Dify/n8n çš„æ•°æ®åº“ç‰ˆæœ¬)ã€‚
*   **Testing & Observability**: å°† "Flow-level Test" è§†ä¸ºä¸€ç­‰å…¬æ°‘ï¼›åˆ©ç”¨ Effect Trace å®ç°æ—¶å…‰å€’æµè°ƒè¯• (Time-travel Debug)ã€‚
*   **Security**: åŸºäº Effect Context çš„ä¸¥æ ¼æ²™ç®±ä¸æƒé™è¾¹ç•Œã€‚

## 3. å¯¹ Logix v3 çš„å…·ä½“å»ºè®®

åŸºäºä¸Šè¿°åˆ†æï¼Œå¯¹ Logix v3 æ¶æ„æå‡ºä»¥ä¸‹æ¼”è¿›å»ºè®®ï¼š

1.  **å¼ºåŒ– "Eject" èƒ½åŠ› (from BubbleLab)**
    *   å¹³å°ä¸åº”æ˜¯å”¯ä¸€çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚ç”Ÿæˆçš„ `packages/effect-runtime-poc` ä»£ç å¿…é¡»èƒ½ç‹¬ç«‹éƒ¨ç½²ã€ç‹¬ç«‹æµ‹è¯•ã€‚
    *   å®Œå–„ `06-codegen-and-parser.md`ï¼Œç¡®ä¿åŒå‘åŒæ­¥çš„ç¨³å®šæ€§ã€‚

2.  **æ„å»º "Pattern Registry" (from n8n)**
    *   åœ¨ `docs/specs/intent-driven-ai-coding/v3/03-assets-and-schemas.md` ä¸­ï¼Œç»†åŒ– Pattern çš„åˆ†å‘ä¸å®‰è£…æœºåˆ¶ã€‚
    *   é¼“åŠ±ç¤¾åŒºè´¡çŒ® "Tag-only Pattern" (æ¥å£) å’Œ "Implementation Pattern" (å®ç°)ã€‚

3.  **å¼•å…¥ "AI Native Artifacts" (from Dify)**
    *   åœ¨ Domain Intent ä¸­å¢åŠ  `AgentSpec` å’Œ `PromptSpec`ã€‚
    *   åœ¨ Logix Runtime ä¸­æä¾›å¼€ç®±å³ç”¨çš„ AI SDK å°è£… (åŸºäº Effect AI æˆ–ç±»ä¼¼åº“)ã€‚

## 4. æ€»ç»“

*   **BubbleLab** æ˜¯æˆ‘ä»¬çš„**æ¶æ„é•œåƒ**ï¼ˆCode-First, TypeScriptï¼‰ã€‚
*   **n8n** æ˜¯æˆ‘ä»¬çš„**ç”Ÿæ€ç›®æ ‡**ï¼ˆRich Integrationsï¼‰ã€‚
*   **Dify** æ˜¯æˆ‘ä»¬çš„**é¢†åŸŸå‚è€ƒ**ï¼ˆAI Agent Modelingï¼‰ã€‚

`intent-flow` çš„ç‹¬ç‰¹ä»·å€¼åœ¨äºï¼š**ç”¨ Effect-TS çš„å¼ºå¤§è¿è¡Œæ—¶èƒ½åŠ›ï¼Œç»Ÿä¸€äº† UI äº¤äº’ã€åç«¯é€»è¾‘ä¸ AI Agent ç¼–æ’ï¼Œå¹¶ä»¥â€œå¯ç”Ÿæˆçš„ä»£ç â€ä½œä¸ºæœ€ç»ˆäº¤ä»˜ç‰©ã€‚**
</file>

<file path="drafts/topics/platform-vision/13-bubblelab-insights.md">
---
title: BubbleLab Engineering Insights (Architecture Mapping)
status: draft
version: 2025-11-28
---

# BubbleLab å·¥ç¨‹å®ç°å¯ç¤ºå½• (Architecture Mapping)

åŸºäºå¯¹ BubbleLab ä»£ç åº“çš„æ·±åº¦åˆ†æï¼Œæœ¬æ–‡æ¡£æç‚¼äº†å…¶åœ¨ **è¿è¡Œæ—¶æ³¨å…¥**ã€**èµ„äº§æ„å»º** å’Œ **ç¼–è¾‘å™¨ä½“éªŒ** æ–¹é¢çš„å·¥ç¨‹å®è·µï¼Œå¹¶å°†å…¶æ˜ å°„åˆ° Logix v3 çš„æ¶æ„è®¾è®¡ä¸­ã€‚

## 1. è¿è¡Œæ—¶å¯ç¤ºï¼šä¾èµ–æ³¨å…¥ä¸æ²™ç®± (Runtime Injection & Sandbox)

BubbleLab è§£å†³çš„æ ¸å¿ƒé—®é¢˜æ˜¯ï¼š**å¦‚ä½•åœ¨è¿è¡Œæ—¶åŠ¨æ€ç»„è£…èƒ½åŠ›ï¼Œå¹¶å®‰å…¨æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚**

### A. ä¾èµ–æ³¨å…¥ (Dependency Injection)
*   **BubbleLab**: `BubbleInjector` ç»´æŠ¤ `services` Mapï¼ŒåŠ¨æ€æ³¨å…¥ API Client å’Œ Loggerã€‚
*   **Logix v3 æ˜ å°„**: éªŒè¯äº† `$.use(Spec/Tag)` è®¾è®¡ã€‚
*   **è¡ŒåŠ¨ç‚¹**:
    *   åœ¨ `Bound API ($)` å®ä¾‹åŒ–æ—¶ï¼Œå‚è€ƒ `BubbleInjector` æ„å»º **Scoped Context**ã€‚
    *   ä¸ä»…æ³¨å…¥ Serviceï¼Œè¿˜éœ€æ³¨å…¥ **Execution Metadata** (`executionId`, `nodeId`) ä»¥æ”¯æŒ Effect Traceã€‚

### B. ä»£ç æ‰§è¡Œæ²™ç®± (Code Sandbox)
*   **BubbleLab**: ä½¿ç”¨ `vm2` æ‰§è¡Œä¸å¯ä¿¡ JS ä»£ç ï¼Œé€šè¿‡ `ctx` é™åˆ¶è®¿é—®ã€‚
*   **Logix v3 æ˜ å°„**:
    *   **Managed Logic (ç™½ç›’)**: åˆ©ç”¨ Effect çš„ Scope å’Œ Context å¤©ç„¶éš”ç¦»å‰¯ä½œç”¨ã€‚
    *   **Raw Code (é»‘ç›’)**: è‹¥åœ¨æœåŠ¡ç«¯è¿è¡Œç”¨æˆ·æ‰‹å†™çš„ Effect ä»£ç ï¼Œéœ€ä½¿ç”¨ `node:vm` æˆ– WASM å®¹å™¨è¿›è¡Œç‰©ç†éš”ç¦»ã€‚

## 2. èµ„äº§ä½“ç³»å¯ç¤ºï¼šManifest é©±åŠ¨ (Manifest-Driven Assets)

BubbleLab çš„ "Bubble" å®šä¹‰æ–¹å¼éå¸¸ä¸¥è°¨ã€‚

### A. èµ„äº§å®šä¹‰ä¸æ„å»º
*   **BubbleLab**: æ¯ä¸ª Bubble æ˜¯ä¸€ä¸ª Classï¼Œè„šæœ¬ `bubble-metadata-bundler.ts` è‡ªåŠ¨æ‰«æä»£ç ç”Ÿæˆ JSON æ¸…å•ã€‚
*   **Logix v3 æ˜ å°„**: å¯¹åº” **Pattern Asset**ã€‚
*   **è¡ŒåŠ¨ç‚¹**:
    *   ç¼–å†™ **Metadata Bundler** è„šæœ¬ã€‚
    *   è‡ªåŠ¨æ‰«æ `Pattern Function`ï¼Œæå– TS ç±»å‹ã€JSDoc å’Œ Config Schemaï¼Œç”Ÿæˆ `patterns.json` ä¾›å¹³å°å‰ç«¯ä½¿ç”¨ã€‚**æ‹’ç»æ‰‹åŠ¨ç»´æŠ¤ JSON é…ç½®ã€‚**

### B. åŠ¨æ€ç±»å‹ç”Ÿæˆ (Dynamic Type Gen) â€”â€” **Must Have**
*   **BubbleLab**: `monacoTypeLoader.ts` å°†æ ¸å¿ƒç±»å‹çš„ `d.ts` æ³¨å…¥å‰ç«¯ Monaco Editorã€‚
*   **Logix v3 æ˜ å°„**: è¿™æ˜¯ **Code-First** ä½“éªŒçš„åŸºçŸ³ã€‚
*   **è¡ŒåŠ¨ç‚¹**: å»ºè®®åˆ†ä¸‰é˜¶æ®µå®æ–½ï¼š
    1.  **Phase 1 (Basic)**: ä»…ä¸º Monaco Editor æ³¨å…¥ `Bound API ($)` å’Œ `Store Schema` çš„é™æ€ `d.ts`ã€‚
    2.  **Phase 2 (Service)**: åŠ¨æ€ç”Ÿæˆå·² `$.use` çš„ Service ç±»å‹ã€‚
    3.  **Phase 3 (LSP)**: å®ç°å®Œæ•´åç«¯ LSPï¼Œæ”¯æŒè·¨æ–‡ä»¶è·³è½¬ä¸é‡æ„ã€‚

## 3. å¹³å° UX å¯ç¤º (Platform UX)

### A. Schema é©±åŠ¨ UI
*   **BubbleLab**: `inputSchemaParser.ts` è§£æ JSON Schema è‡ªåŠ¨ç”Ÿæˆè¡¨å•ã€‚
*   **Logix v3 æ˜ å°„**: Pattern Config Panel åº”ç›´æ¥å¤ç”¨æ­¤é€»è¾‘ã€‚åŸºäº Zod/Effect Schema è‡ªåŠ¨æ¸²æŸ“é…ç½®è¡¨å•ã€‚

### B. æ··åˆè§†å›¾ä¸ Trace
*   **BubbleLab**: `BubbleExecutionBadge` æ˜¾ç¤ºçŠ¶æ€ï¼ŒConsole æ˜¾ç¤ºæ—¥å¿—ã€‚
*   **Logix v3 æ˜ å°„**:
    *   åˆ©ç”¨ Effect çš„æµå¼ç‰¹æ€§ï¼Œåœ¨è¿çº¿ä¸Šå¢åŠ  **Signal Flow åŠ¨æ•ˆ**ã€‚
    *   æä¾› **"Sync with code"** æŒ‰é’®ï¼Œæ˜ç¡®è§¦å‘ Parser åŒæ­¥ï¼Œè€Œéè¿½æ±‚ä¸ç¨³å®šçš„æ¯«ç§’çº§å®æ—¶åŒæ­¥ã€‚

## 4. æ€»ç»“ï¼šä¸‰å¤§å·¥ç¨‹åŠ æŒ

1.  **Type Injection (Killer Feature)**: å¿…é¡»å®ç°åŠ¨æ€ `d.ts` æ³¨å…¥ï¼Œå¦åˆ™ Code-First åªæ˜¯ç©ºè°ˆã€‚
2.  **Automated Bundling**: èµ„äº§æ³¨å†Œå¿…é¡»è„šæœ¬åŒ–ã€è‡ªåŠ¨åŒ–ï¼Œä»ä»£ç ç”Ÿæˆå…ƒæ•°æ®ã€‚
3.  **Strict Context**: è¿è¡Œæ—¶çš„ Logic æ„é€ å¿…é¡»å»ºç«‹ä¸¥æ ¼çš„ä¸Šä¸‹æ–‡éš”ç¦»ï¼Œé˜²æ­¢é€»è¾‘æ±¡æŸ“ã€‚
</file>

<file path="drafts/topics/platform-vision/intent-dev-api.md">
---
title: Intent Dev API (`$$`) ä¸ LLM æ³¨è§£å±‚è‰æ¡ˆ
status: draft
version: 2025-12-02
---

# Intent Dev API (`$$`) ä¸ LLM æ³¨è§£å±‚è‰æ¡ˆ

## èƒŒæ™¯

ç°çŠ¶ï¼š

- è¿è¡Œæ—¶ä¸» DSL å·²æ”¶æ•›ä¸ºï¼š
  - æºï¼š`$.onState` / `$.onAction` / `$.on`ï¼›
  - ç­–ç•¥ï¼š`$.flow.fromState/fromAction` + `debounce` / `throttle` / `filter` / `run*`ï¼ˆä¸»è¦ç»™åº“ä¸ Pattern ä½¿ç”¨ï¼‰ï¼›
  - è¡ŒåŠ¨ï¼š`$.state.update/mutate` / `$.actions.dispatch`ï¼›
  - DX ç³–ï¼š`andThen(handler)`ï¼Œåœ¨ Fluent Builder ä¸Šåšæ™ºèƒ½è·¯ç”±ï¼ˆupdate/mutate vs å‰¯ä½œç”¨ï¼‰ã€‚
- Parser/å¹³å°ä½¿ç”¨çš„ç™½ç›’å­é›†ä»…åŒ…å« Fluent è§„èŒƒå½¢æ€ï¼š
  - `yield* $.onState(selector).op().update/mutate/run*(...)`
  - `yield* $.onAction(predicate).op().update/mutate/run*(...)`
  - `yield* $.on(streamExpr).op().run*(...)`

é—®é¢˜ï¼š

- Fluent ä»£ç æœ¬èº«å·²ç»å¯ä»¥è§£æå‡ºä¸€éƒ¨åˆ† IntentRuleï¼Œä½†åœ¨â€œè§„åˆ’/ç”»å¸ƒ/LLM Prompt/è§„èŒƒå¯¹é½â€åœºæ™¯ä¸‹ï¼Œè¿˜ç¼ºå°‘ä¸€ä¸ª**åªæ‰¿è½½ IR/æ³¨è§£ã€ä¸ç›´æ¥å‚ä¸è¿è¡Œæ—¶æ‰§è¡Œ**çš„å±‚ï¼›
- ç›´è§‰ä¸Šä¼šäº§ç”Ÿç±»ä¼¼ `$$.rule(...)` / `$$.prompt(...)` çš„å†™æ³•ï¼Œä¾›äººå’Œ LLM å†™â€œæ„å›¾å£°æ˜â€ï¼Œä½†éœ€è¦æ˜ç¡®ï¼š
  - å®ƒçš„å®šä½ **ä¸æ˜¯** ç¬¬äºŒå¥—å¯æ‰§è¡Œ DSLï¼›
  - å®ƒå¦‚ä½•è¢«å¹³å°/å·¥å…·æ¶ˆè´¹ï¼›
  - å®ƒå¦‚ä½•åœ¨æ‰“åŒ…é˜¶æ®µè¢«å‰”é™¤ï¼Œé¿å…æ±¡æŸ“ç”Ÿäº§ bundleã€‚

## è®¾è®¡ç›®æ ‡

1. æä¾›ä¸€ä¸ª **â€œIntent æ³¨è§£å±‚â€**ï¼Œä¸“é—¨ç»™äººç±»/LLM/å·¥å…·ä¹¦å†™ï¼š
   - IntentRule çº§è§„åˆ™å£°æ˜ï¼ˆ`source/pipeline/sink`ï¼‰ï¼›
   - Prompt/æ³¨é‡Š/è®¾è®¡æ„å›¾ç­‰é«˜è¯­ä¹‰ä¿¡æ¯ã€‚
2. æ˜ç¡®ï¼šè¿™ä¸€å±‚**ä¸ç›´æ¥å‚ä¸è¿è¡Œæ—¶æ‰§è¡Œ**ï¼Œæœ€ç»ˆèƒ½è·‘çš„ä»æ˜¯ Fluent/Pattern/Flow ç»„åˆã€‚
3. å·¥ç¨‹ä¸Šå¯æ§ï¼š
   - dev/åˆ†æé˜¶æ®µå¯ä»¥å®Œæ•´è¯»å– `$$.*` æ³¨è§£ï¼›
   - prod æ„å»ºæ—¶å¯ä»¥é€šè¿‡å¸¸é‡ + Tree-Shaking æˆ– AST æ’ä»¶ï¼Œå°† `$$.*` è°ƒç”¨ä» bundle ä¸­å‰”é™¤ã€‚

## æ ¸å¿ƒææ¡ˆï¼šIntent Dev API (`$$`)

æš‚å®šåœ¨ Module é€»è¾‘ä¸Šä¸‹æ–‡ä¸­å¼•å…¥ä¸€ä¸ªâ€œå¼€å‘æœŸ Intent APIâ€ï¼Œå½¢å¦‚ï¼š

```ts
AppCounterModule.logic(($, $$) =>
  Effect.gen(function* () {
    // 1. è¿è¡Œæ—¶ä»£ç ï¼ˆFluent + andThenï¼‰
    yield* $.onAction("increment").andThen((prev) => ({ ...prev, count: prev.count + 1 }))
    yield* $.onAction("decrement").andThen((prev) => ({ ...prev, count: prev.count - 1 }))

    // 2. å¼€å‘æœŸ Intent æ³¨è§£ï¼ˆIR + Promptï¼‰
    if (__LOGIX_INTENT_DEV__) {
      $$.rule("counter/inc", {
        source: { type: "action", match: "increment" },
        sink: {
          type: "state",
          kind: "update",
          handler: (prev) => ({ ...prev, count: prev.count + 1 }),
        },
      })

      $$.rule("counter/dec", {
        source: { type: "action", match: "decrement" },
        sink: {
          type: "state",
          kind: "update",
          handler: (prev) => ({ ...prev, count: prev.count - 1 }),
        },
      })

      $$.prompt("counter/summary", {
        kind: "llm-note",
        text: "Counter æ¨¡å—ï¼šinc/dec ä¸¤æ¡è§„åˆ™ï¼Œä¿æŒ count âˆˆ â„¤ã€‚",
      })
    }
  }),
)
```

### 2.1 `$$.rule`ï¼šIntentRule çº§å£°æ˜ï¼ˆIR Onlyï¼‰

è¯­ä¹‰å®šä½ï¼š

- åªç”¨äºå£°æ˜ **ç»“æ„åŒ– IntentRule IR**ï¼š
  - `id`: è§„åˆ™æ ‡è¯†ï¼›
  - `source`: `{ context, type, selector/match }`ï¼›
  - `pipeline`: Flow ç®—å­é“¾ï¼ˆå¯é€‰ï¼‰ï¼›
  - `sink`: `{ type: "state" | "dispatch" | "effect" | ...; handler?: Expr }`ã€‚
- å¯ä»¥ç”±å¹³å°/å·¥å…·ç›´æ¥æ¶ˆè´¹ï¼Œæ— éœ€æ‰§è¡Œä»£ç å³å¯æ„å»º Intent å›¾ã€‚

æ¶ˆè´¹æ–¹å¼ï¼ˆæ¦‚å¿µè‰æ¡ˆï¼‰ï¼š

1. **å¹³å°/Parser**ï¼šåœ¨æ‰«æ Logic æ–‡ä»¶æ—¶ï¼ŒåŒæ—¶è¯»å–ï¼š
   - ç™½ç›’ Fluent è§„åˆ™ â†’ è¿˜åŸä¸º IntentRuleï¼›
   - `$$.rule(...)` â†’ ç›´æ¥è¯»å– IR ç»“æ„ï¼›
   æœ€ç»ˆåœ¨ Universe/Galaxy è§†å›¾ä¸­åˆå¹¶ä¸ºä¸€å¥—è§„åˆ™é›†åˆï¼Œæ ‡è®°â€œæ¥è‡ªä»£ç â€æˆ–â€œæ¥è‡ªæ³¨è§£â€ã€‚
2. **ä»£ç ç”Ÿæˆ/å›å†™**ï¼š
   - å·¥å…·å¯ä»¥æ ¹æ® `$$.rule` åå‘ç”Ÿæˆæˆ–æ ¡å‡† Fluent ä»£ç éª¨æ¶ï¼š
     - e.g. è¯†åˆ« `source/sink`ï¼Œç”Ÿæˆ `yield* $.onAction(...).update(...)` ä»£ç ï¼›
   - è¿™æ ·å¯ä»¥æ”¯æŒâ€œå…ˆæ”¹ IRï¼Œå†åŒæ­¥æ”¹ä»£ç â€çš„åŠè‡ªåŠ¨æµç¨‹ã€‚

è¿è¡Œæ—¶ï¼š

- prod æ„å»ºä¸­ï¼Œè¿™äº› IR æ³¨è§£ä¸ä¼šç›´æ¥å‚ä¸æ‰§è¡Œï¼›
- å¦‚éœ€æ‰§è¡Œï¼Œå¿…é¡»é€šè¿‡å•ç‹¬çš„ç¼–è¯‘è¿‡ç¨‹ç”Ÿæˆ Fluent/Patternï¼Œå†ç”± Logic æ‰¿è½½ã€‚

### 2.2 `$$.prompt`ï¼šLLM/å·¥å…·æ¶ˆè´¹çš„é«˜è¯­ä¹‰æ³¨é‡Š

è¯­ä¹‰å®šä½ï¼š

- ç”¨äºå­˜æ”¾ç»™ LLM / å·¥å…·é˜…è¯»çš„â€œé«˜è¯­ä¹‰æ³¨é‡Šâ€ï¼šPrompt ç‰‡æ®µã€éç»“æ„åŒ–è§£é‡Šã€çº¦æŸè¯´æ˜ç­‰ï¼›
- ä¸è¦æ±‚æœ‰å›ºå®šç»“æ„ï¼Œåªè¦æ±‚æœ‰åŸºæœ¬å­—æ®µï¼š
  - `id` / `scope`ï¼šå…³è”åˆ° Module / è§„åˆ™ / è§†å›¾èŠ‚ç‚¹ï¼›
  - `kind`: `"llm-note" | "doc-snippet" | ...`ï¼›
  - `text`: æ–‡æœ¬å†…å®¹ã€‚

æ¶ˆè´¹æ–¹å¼ï¼š

- LLM/å·¥å…·åœ¨æ„é€  Prompt æˆ–ç”Ÿæˆå˜æ›´å»ºè®®æ—¶ï¼Œå¯ä»¥ä¼˜å…ˆè¯»å– `$$.prompt`ï¼š
  - ä¸ºæŸä¸ªè§„åˆ™æä¾›é¢å¤–ä¸Šä¸‹æ–‡ï¼›
  - è§£é‡Šè®¾è®¡çº¦æŸï¼Œè€Œä¸æ˜¯ä»ä»£ç  AST ä¸­ç¡¬çŒœã€‚

æ„å»ºæ—¶åŒæ ·é€šè¿‡å·¥ç¨‹åŒ–æ‰‹æ®µå‰”é™¤ï¼Œä¸è¿›å…¥ç”Ÿäº§ bundleã€‚

## 3. å·¥ç¨‹çº¦æŸï¼šé¿å…å¢å¤§ bundle ä½“ç§¯

æœ¬è‰æ¡ˆå»ºè®®ä»ä¸€å¼€å§‹å°±æŠŠ Intent Dev API è®¾è®¡ä¸º **â€œdev-only æ³¨è§£å±‚â€**ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼é¿å…æ±¡æŸ“ç”Ÿäº§æ„å»ºã€‚

### 3.1 ç¼–è¯‘æœŸå¸¸é‡ + Tree-Shakingï¼ˆé¦–é€‰ï¼‰

çº¦å®šä¸€ä¸ªç¼–è¯‘æœŸå¸¸é‡ï¼Œä¾‹å¦‚ï¼š

```ts
declare const __LOGIX_INTENT_DEV__: boolean
```

æ‰€æœ‰ `$$` è°ƒç”¨éƒ½å¿…é¡»åŒ…è£¹åœ¨è¯¥å¸¸é‡åˆ†æ”¯å†…ï¼š

```ts
if (__LOGIX_INTENT_DEV__) {
  $$.rule(...)
  $$.prompt(...)
}
```

åœ¨æ„å»ºé…ç½®ä¸­ï¼š

```js
// ä¼ªä»£ç ï¼ˆVite/Rollup/esbuildï¼‰
define: {
  __LOGIX_INTENT_DEV__: 'false',
}
```

åœ¨ç”Ÿäº§æ„å»ºä¸­ï¼Œæ‰“åŒ…å™¨ä¼šå°†æ•´ä¸ª `if (false) { ... }` åˆ†æ”¯å’Œ `$$.*` è°ƒç”¨ä¸€å¹¶è£å‰ªæ‰ï¼š

- dev/åˆ†æåœºæ™¯ï¼šå·¥å…·ç›´æ¥ä»æºç  AST è¯»å–å®Œæ•´çš„ `$$.rule/$$.prompt`ï¼›
- prodï¼šbundle ä¸­ä¸åŒ…å«è¿™äº›æ³¨è§£é€»è¾‘ã€‚

### 3.2 dev/prod åŒå®ç°ï¼ˆå¯é€‰è¡¥å……ï¼‰

å¯é€‰åœ°ï¼Œå°† Intent Dev API æ‹†æˆç±»å‹ + dev/prod å®ç°ï¼š

```ts
export interface IntentDevApi {
  rule(...): void
  prompt(...): void
}

// dev ç‰ˆæœ¬ï¼šçœŸå®è®°å½•å…ƒæ•°æ®
export const DevIntent: IntentDevApi = { ... }

// prod ç‰ˆæœ¬ï¼šç©ºå®ç°
export const NoopIntent: IntentDevApi = {
  rule() {},
  prompt() {},
}
```

æ„å»ºæ—¶é€šè¿‡ alias åˆ‡æ¢ï¼š

- devï¼š`import { DevIntent as $$ } from "@logix/core/intent-dev"`ï¼›
- prodï¼šalias åˆ° `NoopIntent`ï¼Œé…åˆ `__LOGIX_INTENT_DEV__` å¸¸é‡åŠ Tree-Shakingï¼Œæœ€ç»ˆä¸ä¼šä¿ç•™ä»»ä½•å®é™…è°ƒç”¨ã€‚

### 3.3 AST æ’ä»¶/Codemodï¼ˆé«˜çº§é€‰é¡¹ï¼‰

å¦‚æœåç»­éœ€è¦æ›´ç»†ç²’åº¦æ§åˆ¶ï¼Œå¯ä»¥è¡¥å……ä¸€ä¸ªè½»é‡ AST æ’ä»¶ï¼ˆBabel/TSï¼‰æˆ– Codemodï¼š

- åœ¨ç”Ÿäº§æ„å»ºå‰ç»Ÿä¸€ç§»é™¤æ‰€æœ‰ `$$.rule/$$.prompt/...` è°ƒç”¨ï¼›
- æˆ–å°†å®ƒä»¬æ›¿æ¢ä¸ºæ³¨é‡Š/å…ƒä¿¡æ¯ç‰‡æ®µï¼Œä¾›åç»­å®¡è®¡ä½¿ç”¨ã€‚

æœ¬è‰æ¡ˆæš‚ä¸å¼ºåˆ¶è¿™ä¸€é¡¹ï¼Œä»…è®°å½•ä¸ºåç»­å·¥ç¨‹æ–¹æ¡ˆçš„é€‰é¡¹ã€‚

## 4. è¾¹ç•Œä¸åç»­å·¥ä½œ

1. **è¿è¡Œæ—¶èŒè´£è¾¹ç•Œ**  
   - èƒ½è·‘çš„é€»è¾‘ä»ç„¶äº¤ç»™ Fluent DSL / Flow / Patternï¼›  
   - `$$` ä¸ç›´æ¥æ‰§è¡Œï¼Œæœ€å¤šä½œä¸ºâ€œIR â†’ Fluentâ€ç¼–è¯‘è¿‡ç¨‹çš„è¾“å…¥ã€‚
2. **ç™½ç›’/é»‘ç›’è¾¹ç•Œ**  
   - Parser çš„ç™½ç›’å­é›†ä»å®šä¹‰åœ¨ `$` ä¸Šï¼Œä¸ä¼šå› ä¸ºå¼•å…¥ `$$` è€Œæ‰©å±•ï¼›  
   - æ‰€æœ‰ `$$.*` è°ƒç”¨åœ¨ IR å±‚ç›´æ¥è§†ä¸º IR/æ³¨è§£æ¥æºï¼Œæ— éœ€æ‰§è¡Œä»£ç ã€‚
3. **åç»­è§„èŒƒåŒ–å·¥ä½œ**  
   - åœ¨ `runtime-logix/core/06-platform-integration.md` ä¸­è¡¥å……â€œIntent Dev API/æ³¨è§£å±‚â€çš„è§’è‰²æè¿°ï¼›  
   - åœ¨ `v3/platform/impl/intent-rule-and-codegen.md` ä¸­å®šä¹‰ `$$.rule` äº§ç”Ÿçš„ IR å½¢çŠ¶åŠä¸ Fluent è§£æç»“æœçš„åˆå¹¶ç­–ç•¥ï¼›  
   - æŒ‰æœ¬è‰æ¡ˆè®¾è®¡ä¸€ä¸ªæœ€å°å¯ç”¨çš„ `IntentDevApi` ç±»å‹ä¸ dev-only å®ç°ï¼Œåç»­è§†çœŸå®åœºæ™¯æ¼”è¿›ã€‚
</file>

<file path="drafts/topics/platform-vision/json-runtime-separation.md">
---
title: "Logix v3: Platform Vision - JSON Definition & Runtime Separation"
status: draft
layer: Platform
related:
  - logix-reactive-module-integration.md
  - logix-unified-middleware.md
---

# Logix v3: Platform Vision - JSON Definition & Runtime Separation

ä½ çš„æ€è·¯éå¸¸æœ‰æå¤´ï¼è¿™å®é™…ä¸Šæ˜¯ Logix å¹³å°åŒ–æ„¿æ™¯çš„ **æ ¸å¿ƒæ¶æ„ (The Holy Grail)**ã€‚

é€šè¿‡å°† **å®šä¹‰ (Definition)** ä¸ **å®ç° (Implementation)** å½»åº•è§£è€¦ï¼Œæˆ‘ä»¬èƒ½å¤ŸåŒæ—¶è·å¾— "ä½ä»£ç çš„å¯è§†åŒ–èƒ½åŠ›" å’Œ "Pro Code çš„çµæ´»æ€§"ã€‚

## 1. æ ¸å¿ƒæ¶æ„ï¼šåŒæ€åˆ†ç¦» (Dual-State Architecture)

æˆ‘ä»¬éœ€è¦æ˜ç¡®åŒºåˆ†ä¸¤ç§çŠ¶æ€ï¼š

### 1.1 è®¾è®¡æ€ (Design-Time): JSON Blueprint
è¿™æ˜¯å¹³å°ï¼ˆStudio/Editorï¼‰æ“ä½œçš„æ•°æ®ç»“æ„ã€‚å®ƒæ˜¯çº¯ JSONï¼Œæ˜“äºå­˜å‚¨ã€ä¼ è¾“å’Œå¯è§†åŒ–ç¼–è¾‘ã€‚

```json
// module.def.json
{
  "id": "UserModule",
  "state": {
    "profile": {
      "type": "schema.loadable",
      "schema": "UserProfile"
    }
  },
  "intents": [
    {
      "id": "fetchProfile",
      "type": "action",
      "trigger": "onInit",
      "logic": {
        "type": "ai.generate", // æ ‡è®°è¿™æ®µé€»è¾‘ç”± LLM ç”Ÿæˆ
        "prompt": "Fetch user profile from /api/me"
      }
    },
    {
      "id": "autoSave",
      "type": "middleware", // æ ‡è®°è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†ä¸­é—´ä»¶
      "name": "Persist",
      "config": { "key": "user_profile" }
    }
  ]
}
```

### 1.2 è¿è¡Œæ€ (Run-Time): Effect Program
è¿™æ˜¯æµè§ˆå™¨/æœåŠ¡å™¨å®é™…æ‰§è¡Œçš„ä»£ç ã€‚å®ƒæ˜¯å¼ºç±»å‹çš„ TypeScript + Effectã€‚

## 2. æ¡¥æ¥æœºåˆ¶ï¼šHydration (æ³¨æ°´)

ä» JSON åˆ° Effect çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º **"æ³¨æ°´"**ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥å‘ç”Ÿåœ¨ **ç¼–è¯‘æ—¶ (Build-Time)** æˆ– **è¿è¡Œæ—¶ (Run-Time)**ã€‚

### 2.1 é™æ€æ¨¡æ¿ (Standard Templates)
å¯¹äºæ ‡å‡†çš„æ¨¡å¼ï¼ˆå¦‚ CRUDã€è¡¨å•ã€åˆ—è¡¨ï¼‰ï¼Œæˆ‘ä»¬é¢„è®¾å¥½ **"Logic Templates"**ã€‚
*   **è¾“å…¥**: JSON Config (`{ type: "middleware", name: "Persist" }`)
*   **è¾“å‡º**: `PersistMiddleware(config)`

### 2.2 LLM è¡¥å…¨ (AI Completion)
å¯¹äºéæ ‡çš„ä¸šåŠ¡é€»è¾‘ï¼Œæˆ‘ä»¬ç•™å‡º **"AI æ’æ§½"**ã€‚
*   **è¾“å…¥**: JSON Intent (`{ prompt: "Fetch user profile..." }`)
*   **è¾“å‡º**: LLM ç”Ÿæˆä¸€æ®µ `Effect` ä»£ç ï¼Œå¡«å…¥æ’æ§½ã€‚

## 3. ä¸ºä»€ä¹ˆè¿™ä¸ªæ€è·¯ "æœ‰æå¤´"ï¼Ÿ

1.  **å¯è§†åŒ–ç¼–æ’ (Visual Orchestration)**:
    *   å› ä¸ºå®šä¹‰æ˜¯ JSONï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾æ„å»ºæ‹–æ‹½å¼çš„ UI ç¼–è¾‘å™¨ (Studio)ã€‚
    *   äº§å“ç»ç†/è®¾è®¡å¸ˆå¯ä»¥ç›´æ¥ä¿®æ”¹ JSONï¼ˆé€šè¿‡ UIï¼‰ï¼Œè°ƒæ•´ä¸šåŠ¡æµç¨‹ã€‚

2.  **æ¸è¿›å¼å¢å¼º (Progressive Enhancement)**:
    *   **L0 (No Code)**: å…¨é é¢„è®¾æ¨¡æ¿ï¼Œæ‹–æ‹½ç”Ÿæˆã€‚
    *   **L1 (Low Code)**: ç®€å•çš„é€»è¾‘ç”± LLM è‡ªåŠ¨è¡¥å…¨ã€‚
    *   **L2 (Pro Code)**: å¤æ‚çš„é€»è¾‘ç”±å·¥ç¨‹å¸ˆæ‰‹å†™ Effect ä»£ç ï¼ŒæŒ‚è½½åˆ° JSON å®šä¹‰çš„æ’æ§½ä¸Šã€‚

3.  **å¯ç»´æŠ¤æ€§ (Maintainability)**:
    *   ä¸šåŠ¡æ„å›¾ (Intent) è¢«å›ºåŒ–åœ¨ JSON ä¸­ï¼Œæ°¸è¿œä¸ä¼šè¿‡æ—¶ã€‚
    *   å®ç°ç»†èŠ‚ (Effect Code) å¯ä»¥éšç€æŠ€æœ¯æ ˆå‡çº§è€Œé‡æ–°ç”Ÿæˆï¼ˆRe-hydrationï¼‰ã€‚

## 4. æ€»ç»“

è¿™ä¸ªæ¶æ„å°† Logix å˜æˆäº†ä¸€ä¸ª **"æ„å›¾ç¼–è¯‘å™¨" (Intent Compiler)**ï¼š

*   **Source**: JSON Definition (Visual / Intent)
*   **Compiler**: Logix CLI + LLM
*   **Target**: Effect Runtime Code

è¿™æ­£æ˜¯ "Intent-Driven AI Coding" çš„ç»ˆæå½¢æ€ã€‚

## 5. å…¨é“¾è·¯å¯è¡Œæ€§æ¨æ¼” (Feasibility Deep Dive)

æˆ‘ä»¬ä¸éœ€è¦å†™ä»£ç ï¼Œé€šè¿‡ **"æ€æƒ³å®éªŒ (Thought Experiment)"** å°±å¯ä»¥éªŒè¯è¿™æ¡è·¯æ˜¯å¦é€šç•…ã€‚

### 5.1 ç¯èŠ‚ä¸€ï¼šå®šä¹‰ä¸ç¼–æ’ (Definition & Orchestration) - æœ€éš¾çš„å…³å¡

ä½ æŒ‡å‡ºçš„éå¸¸ç²¾å‡†ã€‚ç®€å•çš„ "Prompt å¡«ç©º" æ— æ³•æ»¡è¶³å¤æ‚çš„ä¸šåŠ¡ç¼–æ’ã€‚
**éæ ‡é€»è¾‘çš„ç¼–æ’** æ‰æ˜¯å¹³å°ä¾§çš„æ ¸å¿ƒæŒ‘æˆ˜ã€‚

*   **æŒ‘æˆ˜**: å¦‚ä½•åœ¨ JSON ä¸­æè¿°å¤æ‚çš„æ§åˆ¶æµï¼ˆåˆ†æ”¯ã€å¾ªç¯ã€å¹¶å‘ï¼‰ï¼ŒåŒæ—¶ä¿æŒ UI å¯ç¼–è¾‘æ€§ï¼Ÿ
*   **è§£æ³•**: **å›¾ç¼–æ’ (Graph Orchestration)**ã€‚
    *   **æ•°æ®ç»“æ„**: JSON ä¸å†æ˜¯æ‰å¹³çš„åˆ—è¡¨ï¼Œè€Œæ˜¯ **Nodes + Edges** çš„å›¾ç»“æ„ã€‚
    *   **äº¤äº’å½¢å¼**:
        *   **L0 (Macro)**: æ¨¡å—çº§ä¾èµ–å›¾ (Module A -> Module B)ã€‚
        *   **L1 (Micro)**: é€»è¾‘æµç¨‹å›¾ (Flowchart)ã€‚
            *   èŠ‚ç‚¹ç±»å‹: `Action`, `Condition`, `Loop`, `AI.Gen` (é»‘ç›’èŠ‚ç‚¹)ã€‚
            *   è¿çº¿: ä»£è¡¨æ•°æ®æµæˆ–æ§åˆ¶æµã€‚
    *   **AI çš„è§’è‰²**: AI ä¸ä»…ç”Ÿæˆä»£ç ï¼Œè¿˜è´Ÿè´£ **"ç”Ÿæˆå›¾"**ã€‚ç”¨æˆ·è¾“å…¥ä¸€å¥è¯ï¼ŒAI ç”Ÿæˆä¸€ä¸ªåŒ…å« 5 ä¸ªèŠ‚ç‚¹çš„æµç¨‹å›¾ï¼Œç”¨æˆ·å†å¾®è°ƒã€‚
*   **æ¨æ¼”**:
    *   è¿™ç§æ–¹å¼å°† "å†™ä»£ç " å˜æˆäº† "ç”»å›¾"ã€‚
    *   JSON ç»“æ„å¿…é¡»è¶³å¤Ÿå¥å£®ï¼Œèƒ½å¤Ÿè¡¨è¾¾ `Effect.all` (å¹¶å‘), `Effect.race` (ç«æ€), `Effect.match` (åˆ†æ”¯)ã€‚
    *   **ç»“è®º**: è¿™æ˜¯å¹³å°å»ºè®¾çš„é‡ä¸­ä¹‹é‡ã€‚æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€å¥— **"Visual Logic Protocol"**ã€‚

### 5.2 ç¯èŠ‚äºŒï¼šç¼–è¯‘ (Compiler / Hydration)
*   **è¾“å…¥**: JSON + Templates + LLMã€‚
*   **æŒ‘æˆ˜**: LLM ç”Ÿæˆçš„ä»£ç æ˜¯å¦å¯é ï¼Ÿæ¨¡æ¿æ˜¯å¦å¤Ÿç”¨ï¼Ÿ
*   **æ¨æ¼”**:
    *   **æ¨¡æ¿ (80%)**: æ ‡å‡†åœºæ™¯ï¼ˆè¡¨å•ã€åˆ—è¡¨ï¼‰å®Œå…¨é ç¡®å®šæ€§çš„æ¨¡æ¿ç”Ÿæˆï¼Œ**é›¶é£é™©**ã€‚
    *   **LLM (20%)**: å¤æ‚é€»è¾‘ç”± LLM ç”Ÿæˆã€‚
        *   **é£é™©**: LLM å¯èƒ½ç”Ÿæˆé”™è¯¯ä»£ç ã€‚
        *   **å¯¹ç­–**: ç”Ÿæˆçš„ä»£ç æ˜¯ TypeScriptã€‚æˆ‘ä»¬æœ‰ **Type Check** å’Œ **Lint** ä½œä¸ºç¬¬ä¸€é“é˜²çº¿ï¼Œ**Unit Test** ä½œä¸ºç¬¬äºŒé“é˜²çº¿ã€‚
    *   **ç»“è®º**: âœ… å¯è¡Œã€‚é€šè¿‡ "Type-Safe Generation" é™ä½ LLM å¹»è§‰é£é™©ã€‚

### 5.3 ç¯èŠ‚ä¸‰ï¼šè¿è¡Œ (Runtime Execution)
*   **è¾“å…¥**: ç”Ÿæˆçš„ TS/Effect ä»£ç ã€‚
*   **æŒ‘æˆ˜**: è¿è¡Œæ—¶æ€§èƒ½ï¼Ÿè°ƒè¯•ä½“éªŒï¼Ÿ
*   **æ¨æ¼”**:
    *   **æ€§èƒ½**: ç”Ÿæˆçš„æ˜¯åŸç”Ÿ Effect ä»£ç ï¼Œæ€§èƒ½ä¸æ‰‹å†™æ— å¼‚ã€‚
    *   **è°ƒè¯•**: å¼€å‘è€…å¯ä»¥ç›´æ¥è°ƒè¯•ç”Ÿæˆçš„ TS ä»£ç ï¼ˆSource Map æ”¯æŒï¼‰ã€‚
    *   **ä»·å€¼**: å½»åº•æ¶ˆé™¤äº† "è¿è¡Œæ—¶é»‘ç›’"ã€‚ç”Ÿæˆçš„ä»£ç æ˜¯å¯è¯»ã€å¯å®¡è®¡çš„ã€‚
    *   **ç»“è®º**: âœ… å¯è¡Œã€‚

### 5.4 çœŸå®åœºæ™¯ä»·å€¼ (Value Proposition)
*   **åœºæ™¯**: ä¸€ä¸ªå¤æ‚çš„ CRM è¡¨å•ï¼ŒåŒ…å« 50 ä¸ªå­—æ®µï¼Œéƒ¨åˆ†å­—æ®µæœ‰è”åŠ¨æ ¡éªŒï¼Œæäº¤åéœ€è¦ä¹è§‚æ›´æ–° UIã€‚
*   **ä¼ ç»Ÿå¼€å‘**: æ‰‹å†™ 500 è¡Œ React Hook + Zod + React Query ä»£ç ã€‚
*   **Intent Compiler**:
    1.  JSON å®šä¹‰å­—æ®µå’Œæ ¡éªŒè§„åˆ™ (Schema)ã€‚
    2.  JSON æ ‡è®° "Optimistic" (Middleware)ã€‚
    3.  Compiler è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰æ ·æ¿ä»£ç ã€‚
    4.  å¼€å‘è€…åªå…³æ³¨ 2-3 ä¸ªç‰¹æ®Šçš„è”åŠ¨é€»è¾‘ (LLM è¾…åŠ©ç”Ÿæˆ)ã€‚
*   **ä»·å€¼**: **10x æ•ˆç‡æå‡**ï¼Œä¸”ä»£ç è´¨é‡æ ‡å‡†åŒ–ã€‚

## 6. æ€»ç»“ (Conclusion)
</file>

<file path="drafts/topics/query-integration/01-unified-api-design.md">
---
title: "@logix/query ç»Ÿä¸€ API è®¾è®¡ï¼šä¸‰å±‚æ¶æ„ (Unified API Design)"
status: draft
version: 1.1
layer: Extension Library
value: extension
priority: later
related:
  - logix-query-integration-strategies.md
  - logix-query-elegant-api-design.md (artifact)
  - logix-query-perfect-design.md
---

# @logix/query ç»Ÿä¸€ API è®¾è®¡ï¼šä¸‰å±‚æ¶æ„

**æ ¸å¿ƒç›®æ ‡**ï¼šå®ç°æ•°æ®è·å–çš„ **æè‡´ DX** â€”â€” é›¶é…ç½®ã€å¼ºç±»å‹ã€å¹³å°å¯è§£æã€‚é€šè¿‡ä¸‰å±‚ API æ¸è¿›å¼åœ°æ»¡è¶³ä»ç®€å•åˆ°å¤æ‚çš„å„ç±»éœ€æ±‚ã€‚

---

## 0. è®¾è®¡ç†å¿µ

- **Module-Native**: Query ä¸æ˜¯å¤–æŒ‚ï¼Œè€Œæ˜¯ State çš„ä¸€éƒ¨åˆ†ã€‚
- **Schema-Driven**: åˆ©ç”¨ Schema å…ƒæ•°æ®è‡ªåŠ¨ç”Ÿæˆæ ‡å‡† Logicã€‚
- **Progressive**: 80% åœºæ™¯ç”¨ Layer 1ï¼Œ20% å¤æ‚åœºæ™¯ä¸‹æ²‰åˆ° Layer 2/3ã€‚

---

## Layer 1: Declarative Query Field (å£°æ˜å¼æŸ¥è¯¢å­—æ®µ)

**å®šä½**ï¼šè¦†ç›– 80% çš„æ ‡å‡†"è¯»"åœºæ™¯ï¼ˆGETï¼‰ã€‚å°† Query å®šä¹‰å†…èšåœ¨ State Schema ä¸­ã€‚

### 1.1 API å¥‘çº¦

```ts
import { Logix, Query } from '@logix/core'
import { Schema } from 'effect'

export const UserModule = Logix.Module('User', {
  state: Schema.Struct({
    userId: Schema.String,

    // ğŸŒŸ Query.field: å£°æ˜è¿™æ˜¯ä¸€ä¸ª"æ´»"çš„å­—æ®µ
    // æ³›å‹è‡ªåŠ¨æ¨å¯¼ï¼š
    // - State ç±»å‹ (S)
    // - QueryKey ç±»å‹ (K)
    // - Data ç±»å‹ (D)
    profile: Query.field({
      // ä¾èµ–è¿½è¸ªï¼šstate å³ä¸ºå½“å‰ Module çš„çŠ¶æ€å¿«ç…§
      queryKey: (state) => ['user', state.userId] as const,

      // æ‰§è¡Œå‡½æ•°ï¼šè§£æ„ ctx è·å–å¼ºç±»å‹ key
      queryFn: ({ queryKey: [_, id] }) => UserApi.fetchProfile(id),

      // å¯ç”¨æ¡ä»¶
      enabled: (state) => !!state.userId,

      // ç­–ç•¥é…ç½®
      staleTime: 5_000,
    }),
  }),
  actions: {
    setUserId: Schema.String,
  }
})
```

### 1.2 è¿è¡Œæ—¶è¡Œä¸º (Module.live è‡ªåŠ¨è£…é…)

å½“è°ƒç”¨ `UserModule.live(...)` æ—¶ï¼Œåº•å±‚ Runtime ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. **Schema æ‰«æ**ï¼šéå† `stateSchema`ï¼Œè¯†åˆ«å¸¦æœ‰ `[QueryFieldSymbol]` æ ‡è®°çš„å­—æ®µã€‚
2. **Logic ç”Ÿæˆ**ï¼šä¸ºæ¯ä¸ª Query Field è‡ªåŠ¨ç”Ÿæˆä¸€æ®µéšå¼çš„ `RxQueryLogic`ã€‚
   - `deps = config.queryKey` (ä¾èµ– State å˜åŒ–)
   - `sink = state.profile` (è‡ªåŠ¨å›å¡« data/isLoading/error)
3. **æ³¨å…¥**ï¼šå°†ç”Ÿæˆçš„ Logic åˆå¹¶åˆ° Module çš„ Logic åˆ—è¡¨ä¸­ã€‚

### 1.3 ç±»å‹æ¨å¯¼ä½“éªŒ

åœ¨ React ç»„ä»¶ä¸­ï¼š

```ts
const { state } = useModule(UserModule)

// state.profile è‡ªåŠ¨å±•å¼€ä¸ºï¼š
// {
//   data: User | null,
//   isLoading: boolean,
//   error: Error | null,
//   refetch: () => void
// }
```

---

## Layer 2: Explicit Query Logic (æ˜¾å¼æŸ¥è¯¢é€»è¾‘)

**å®šä½**ï¼šè¦†ç›–éœ€è¦è‡ªå®šä¹‰å‰¯ä½œç”¨ã€è·¨ Module ä¾èµ–æˆ–å¤æ‚è§¦å‘æ¡ä»¶çš„åœºæ™¯ã€‚

### 2.1 API å¥‘çº¦

```ts
import { createQueryLogic } from '@logix/query'

export const UserProfileQueryLogic = createQueryLogic(UserModule, {
  // 1. æ˜¾å¼å®šä¹‰è§¦å‘æº (Source)
  params: (state) => state.userId,

  // 2. Query é…ç½®
  query: {
    queryKey: (userId) => ['user', userId] as const,
    queryFn: (ctx) => UserApi.fetchProfile(ctx.queryKey[1]),
    enabled: (userId) => !!userId,
  },

  // 3. å†™å…¥ç›®æ ‡ (Sink)
  target: 'profile',

  // 4. ç”Ÿå‘½å‘¨æœŸé’©å­ (Side Effects)
  onSuccess: ($) => (data) => Effect.gen(function*() {
    yield* Effect.log(`User loaded: ${data.name}`)
    yield* $.actions.someAction(data)
  }),

  onError: ($) => (error) => Effect.gen(function*() {
    yield* $.actions.showToast(error.message)
  })
})
```

---

## Layer 3: Manual Integration (æ‰‹åŠ¨é›†æˆ)

**å®šä½**ï¼šå…œåº•æ–¹æ¡ˆã€‚ç”¨äºå¤„ç† Infinite Queryã€Suspense é›†æˆã€æˆ–æç«¯å¤æ‚çš„ç«æ€æ§åˆ¶ã€‚

### 3.1 API å¥‘çº¦ (Effect Native)

```ts
export const CustomQueryLogic = UserModule.logic(($) =>
  Effect.gen(function* () {
    const queryClient = yield* QueryClientTag

    // æ‰‹åŠ¨ç¼–æ’æµ
    yield* $.flow.fromState(s => s.userId).pipe(
      $.flow.debounce(300),
      $.flow.runLatest((id) => Effect.gen(function*() {
        // æ‰‹åŠ¨ç®¡ç† Loading
        yield* $.state.update(s => ({ ...s, loading: true }))

        // ç›´æ¥è°ƒç”¨ RQ Core
        const result = yield* Effect.tryPromise(() =>
          queryClient.fetchQuery({ queryKey: ['user', id], ... })
        )

        // æ‰‹åŠ¨å›å¡«
        yield* $.state.update(s => ({ ...s, data: result, loading: false }))
      }))
    )
  })
)
```

---

## 4. æ¶æ„è¯„ä¼°ä¸å…³é”®å†³ç­– (Evaluation)

### 4.1 Schema é€’å½’ç±»å‹é—®é¢˜ (Recursive Type Issue)

**æŒ‘æˆ˜**ï¼šåœ¨å®šä¹‰ state Schema æ—¶ï¼Œ`queryKey: (state) => ...` å‡½æ•°éœ€è¦å¼•ç”¨å°šæœªå®šä¹‰å®Œæˆçš„ State ç±»å‹ã€‚

**è§£æ³•**ï¼šä½¿ç”¨ **Getter æ¨¡å¼** æˆ– **Builder æ¨¡å¼** å»¶è¿Ÿæ¨å¯¼ï¼Œæˆ–è€…å…è®¸ state å‚æ•°ä¸º `Partial<State>` æˆ– `any` (ç”±è¿è¡Œæ—¶ä¿è¯)ï¼Œåœ¨ Module å®šä¹‰å®Œæˆåå†é€šè¿‡ `Module.State` è¿›è¡Œç±»å‹æ”¶çª„ã€‚

åœ¨ Logix v3 ä¸­ï¼Œæ¨èä½¿ç”¨ **Two-Pass Definition** æˆ– **Proxy Type** æ¥è§£å†³ï¼š

```ts
// 1. å…ˆå®šä¹‰çº¯æ•°æ®ç»“æ„ (DTO)
const UserData = Schema.Struct({ userId: Schema.String });

// 2. å†å®šä¹‰åŒ…å« Query çš„ State
const UserState = Schema.extend(UserData, Schema.Struct({
  profile: Query.field<typeof UserData, ...>({ ... })
}));
```

æˆ–è€…ï¼Œæ¥å—åœ¨ `Logix.Module` å®šä¹‰å†…éƒ¨ `queryKey` å‚æ•°çš„ç±»å‹æ¨å¯¼å¯èƒ½éœ€è¦ä¸€äº› TypeScript é­”æ³•ï¼ˆå¦‚ `ThisType`ï¼‰ã€‚

### 4.2 å¹³å°è§£æç­–ç•¥

- **Layer 1**: Parser æ‰«æ Module Schema ASTï¼Œè¯†åˆ« `Query.field` è°ƒç”¨ã€‚åœ¨å¯è§†åŒ–å›¾ä¸­ï¼Œå°†å…¶æ¸²æŸ“ä¸º **"State å†…åµŒæ•°æ®æº" (State-Embedded Datasource)**ï¼Œç”¨ç‰¹æ®Šå›¾æ ‡æ ‡è®° State èŠ‚ç‚¹ä¸Šçš„è¯¥å­—æ®µã€‚
- **Layer 2**: Parser è¯†åˆ« `createQueryLogic` è°ƒç”¨ã€‚æ¸²æŸ“ä¸ºç‹¬ç«‹çš„ **Logic èŠ‚ç‚¹**ï¼Œè¿çº¿æŒ‡å‘ State å­—æ®µã€‚
- **Layer 3**: æ¸²æŸ“ä¸ºæ™®é€š **Code Block**ã€‚

### 4.3 æ¨èå®æ–½è·¯å¾„

- **Phase 1**: å®ç° `QueryClientTag` å’Œ Layer 3 (Manual)ï¼Œæ‰“é€šåº•å±‚ã€‚
- **Phase 2**: å®ç° `createQueryLogic` (Layer 2) å·¥å‚å‡½æ•°ï¼Œè¦†ç›–å¤§éƒ¨åˆ†æ‰‹å†™åœºæ™¯ã€‚
- **Phase 3**: æ”»å…‹ TypeScript ç±»å‹æ¨å¯¼éš¾ç‚¹ï¼Œå®ç° `Query.field` (Layer 1) çš„ Schema æ‰©å±•ä¸è‡ªåŠ¨ Logic æ³¨å…¥ã€‚

### 4.4 æ¶æ„æ·±åº¦è¾¨æï¼šLive State vs Pure State

**æ ¸å¿ƒé—®é¢˜**ï¼š`Query.field` åœ¨ State Schema ä¸­å®šä¹‰äº† `queryFn`ï¼ˆè¡Œä¸ºï¼‰ï¼Œè¿™æ˜¯å¦ç ´åäº† Logix "State is Pure Data" çš„åŸåˆ™ï¼Ÿ

**æ¶æ„å†³ç­–**ï¼šä¸ºäº†ä¿æŒ Logix æ ¸å¿ƒçš„çº¯ç²¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®åŒºåˆ† **Schema å®šä¹‰** ä¸ **Runtime å®ä¾‹**ã€‚

#### 1. State å®ä¾‹æ°¸è¿œæ˜¯çº¯çš„ (Runtime Purity)

æ— è®º Schema å®šä¹‰å¤šä¹ˆèŠ±å“¨ï¼Œ`ModuleRuntime` ä¸­æŒæœ‰çš„ `state` å¿…é¡»æ°¸è¿œæ˜¯ **Plain JSON Object**ã€‚

- âœ… **å¯åºåˆ—åŒ–**ï¼š`state.profile` åœ¨è¿è¡Œæ—¶åªåŒ…å« `{ data: ..., isLoading: ..., error: ... }` æ•°æ®å¿«ç…§ã€‚
- âœ… **Time Travel**ï¼šè°ƒè¯•å™¨å¯ä»¥éšæ„å¿«ç…§å’Œå›æ”¾ï¼Œå› ä¸ºå®ƒåªæ˜¯ä¸€å †æ•°æ®ã€‚
- âœ… **ç¦æ­¢é—­åŒ…**ï¼š`queryFn` å’Œ `queryKey` å‡½æ•°ç»ä¸ä¼šè¢«å­˜å‚¨åœ¨ State å®ä¾‹ä¸­ã€‚

#### 2. Schema æ˜¯"å¯Œ"çš„ (Rich Schema)

æˆ‘ä»¬æ‰©å±•äº† Logix å¯¹ Schema çš„å®šä¹‰ã€‚**Schema ä¸ä»…æè¿°æ•°æ®çš„"å½¢çŠ¶ (Shape)"ï¼Œä¹Ÿå¯ä»¥æè¿°æ•°æ®çš„"æ¥æº (Source)"**ã€‚

- `Query.field` æœ¬è´¨ä¸Šæ˜¯åˆ©ç”¨ `Schema.annotations` æŒ‚è½½äº† **å…ƒæ•°æ® (Metadata)**ã€‚
- è¿™äº›å…ƒæ•°æ®æ˜¯**é™æ€çš„**ï¼Œåªå­˜åœ¨äºå®šä¹‰å±‚ã€‚

#### 3. "è™šå®åˆ†ç¦»" çš„è£…é…è¿‡ç¨‹ (The Assembly Process)

`Module.live` æ‰¿æ‹…äº†"ç¼–è¯‘å™¨"çš„è§’è‰²ï¼š

```
Schema (å« Query å…ƒæ•°æ®)
    â†“ 1. æå–å…ƒæ•°æ®
Module.live è£…é…å™¨
    â†“ 2. ç”Ÿæˆçº¯å‡€çš„ Initial State
    â†“ 3. ç”Ÿæˆéšå¼çš„ Query Logic (Effect)
    â†“
Module Runtime (çº¯å‡€ State + Logic Fibers)
```

**ç»“è®º**ï¼šLayer 1 çš„"ä¼˜é›…"å¹¶éé€šè¿‡ç‰ºç‰²çº¯ç²¹æ€§è·å¾—çš„ï¼Œè€Œæ˜¯é€šè¿‡**å°†è¡Œä¸ºå®šä¹‰ä¸Šç§»åˆ°å…ƒæ•°æ®å±‚**å®ç°çš„ã€‚è¿™å®é™…ä¸Šå¼ºåŒ–äº† Logix æ ¸å¿ƒä½“ç³»ï¼šå®ƒå®šä¹‰äº†ä¸€ç§æ ‡å‡†çš„ **"Resource State" (èµ„æºå‹çŠ¶æ€)** èŒƒå¼ã€‚

---

## 5. å¾…å†³é—®é¢˜ä¸åç»­å·¥ä½œ

### 5.1 ç±»å‹ç³»ç»ŸæŒ‘æˆ˜

- [ ] è§£å†³ `Query.field` ä¸­ `queryKey: (state) => ...` çš„é€’å½’ç±»å‹æ¨å¯¼
- [ ] éªŒè¯ Layer 1 åœ¨å¤æ‚åµŒå¥— Schema åœºæ™¯ä¸‹çš„ç±»å‹è¡¨ç°
- [ ] ç¡®ä¿ `refetch/invalidate` æ–¹æ³•çš„ç±»å‹å®‰å…¨æ³¨å…¥

### 5.2 è¿è¡Œæ—¶å®ç°

- [ ] å®ç° `Module.live` çš„ Schema æ‰«æä¸ Logic è‡ªåŠ¨æ³¨å…¥æœºåˆ¶
- [ ] è®¾è®¡ `QueryObserver` çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ç­–ç•¥ï¼ˆåŸºäº `$.lifecycle`ï¼‰
- [ ] å¤„ç†å¤šä¸ª Query Field ä¹‹é—´çš„èµ„æºå…±äº«ä¸éš”ç¦»

### 5.3 å¹³å°é›†æˆ

- [ ] å®šä¹‰ `Query.field` çš„ AST è§£æè§„åˆ™
- [ ] è®¾è®¡ Studio ä¸­ Query Field çš„å¯è§†åŒ–å›¾æ ‡ä¸äº¤äº’
- [ ] æ”¯æŒ Query Field çš„"æ— ä»£ç é‡é…"èƒ½åŠ›

### 5.4 æ–‡æ¡£ä¸ç¤ºä¾‹

- [ ] ç¼–å†™ Layer 1/2/3 çš„å®Œæ•´ä½¿ç”¨æŒ‡å—
- [ ] æä¾›çœŸå®åœºæ™¯çš„è¿ç§»æ¡ˆä¾‹ï¼ˆä» `useQuery` åˆ° `Query.field`ï¼‰
- [ ] è¡¥å…… Mutation / Infinite Query çš„è®¾è®¡æ–¹æ¡ˆ

---

## 6. ç›¸å…³æ–‡æ¡£

- [Logix Query é›†æˆç­–ç•¥ï¼ˆé›¶å°è£…æ–¹æ¡ˆï¼‰](./logix-query-integration-strategies.md)
- [Logix Query æè‡´ä¼˜é›… API è®¾è®¡](../../.gemini/antigravity/brain/.../logix-query-elegant-api-design.md) (artifact)
- [runtime-logix/core/02-module-and-logic-api.md](../../runtime-logix/core/02-module-and-logic-api.md)
- [runtime-logix/core/03-logic-and-flow.md](../../runtime-logix/core/03-logic-and-flow.md)

---

**ç‰ˆæœ¬å†å²**ï¼š

- v1.1 (2025-11-30): åŸºäºä¸ Claude çš„æ·±åº¦è®¨è®ºï¼Œæ•´åˆä¸‰å±‚ API è®¾è®¡ï¼Œæ–°å¢"è™šå®åˆ†ç¦»"æ¶æ„è¾¨æã€‚
- v1.0 (2025-11-30): åˆå§‹ç‰ˆæœ¬ï¼Œæ¢³ç† Layer 1/2/3 å¥‘çº¦ä¸è®¾è®¡ç†å¿µã€‚
</file>

<file path="drafts/topics/query-integration/02-integration-strategies.md">
---
title: Logix æ¥å…¥ TanStack Query çš„ä¸¤çº§é›†æˆç­–ç•¥ï¼ˆè‰ç¨¿ï¼‰
status: draft
version: 2025-11-30
value: extension
priority: next
---

## 0. èƒŒæ™¯ä¸é—®é¢˜é™ˆè¿°

åœ¨å…¸å‹çš„å‰ç«¯é¡¹ç›®é‡Œï¼ŒTanStack Queryï¼ˆä¸‹ç§° RQï¼ŒåŸ react-queryï¼‰å·²ç»æˆä¸ºäº‹å®ä¸Šçš„â€œæœåŠ¡ç«¯çŠ¶æ€ï¼ˆServer Stateï¼‰â€æ ‡å‡†ç»„ä»¶ï¼š

- è´Ÿè´£ç¼“å­˜ã€å¤±æ•ˆç­–ç•¥ã€è¯·æ±‚å»é‡ã€é‡è¯•ç­‰ï¼›
- é€šå¸¸ä»¥ `useQuery` / `useInfiniteQuery` ç­‰ Hook çš„å½¢å¼ç›´æ¥åœ¨ç»„ä»¶é‡Œä½¿ç”¨ã€‚

å½“å‰ intent-flow / runtime-logix çš„ç›®æ ‡ä¹‹ä¸€ï¼Œæ˜¯è®©ï¼š

- ä¸šåŠ¡å¼€å‘è€…åœ¨ UI å±‚åªå†™ `useModule` / `useSelector` ç­‰ Logix Hookï¼Œä¸å†å†™ `useEffect` å’Œâ€œQuery + dispatchâ€çš„èƒ¶æ°´ï¼›
- Logix æˆä¸º UI å†³ç­–ï¼ˆloading / error / å±•ç¤ºï¼‰çš„å”¯ä¸€äº‹å®æºï¼›
- æ¶æ„å¸ˆå¯ä»¥åœ¨ Logix ä¹‹ä¸Šæä¾› `@logix/query` ä¹‹ç±»çš„æ‰©å±•åŒ…ï¼Œå¯¹æ¥ RQï¼Œä½†å¯¹ä¸šåŠ¡å±‚æš´éœ²çš„ API ä»ç„¶ä¿æŒç»Ÿä¸€å½¢çŠ¶ï¼ˆModule / Logic / Linkï¼‰ï¼Œä¸”ç±»å‹å®‰å…¨ã€‚
- ä»å¼€å‘è€…è§†è§’ï¼Œå¸Œæœ›ä»–å§‹ç»ˆåªéœ€è¦ç†è§£ `Module / Logic / Link` è¿™ä¸‰ä¸ªä¸€ç­‰æ¦‚å¿µï¼š  
  RQ çš„é›†æˆç»†èŠ‚ï¼ˆQueryClient / Observer / Adapter ç­‰ï¼‰å°½é‡è—åœ¨æ‰©å±•åŒ…ä¸ platform ä»£ç ä¸­ã€‚

æœ¬è‰ç¨¿å°è¯•ä»â€œæœ€ä½å°è£…æˆæœ¬â€å‡ºå‘ï¼Œå…ˆç†æ¸…ï¼š**å¦‚æœæˆ‘ä»¬å®Œå…¨ä¸åš Adapter / Link Factoryï¼Œåªç”¨ Effect API åœ¨ Logic é‡Œç›´æ¥ç© TanStack Query æ ¸å¿ƒèƒ½åŠ›ï¼Œèƒ½åšåˆ°ä»€ä¹ˆï¼Ÿæœ‰ä½•åˆ©å¼Šï¼Ÿ** ç„¶åå†å¯¹æ¯”éœ€è¦é¢å¤–å°è£…æ—¶å¯ä»¥å¼•å…¥å“ªäº›æ¨¡å¼ã€‚

> çº¦æŸå‰æï¼š
> - ä¸€å¾‹ä½¿ç”¨ TanStack Query Coreï¼ˆ`QueryClient` / `QueryObserver`ï¼‰ï¼Œè€Œä¸æ˜¯ React Hook APIï¼›
> - æ‰€æœ‰å‰¯ä½œç”¨éƒ½è¿è¡Œåœ¨ Logix Logic / Link ä¸­ï¼Œä¸åœ¨ React ç»„ä»¶é‡Œä½¿ç”¨ `useEffect` æˆ– `useQuery`ï¼›
> - UI ä¾§åªé€šè¿‡ Logix state/selector è¯»å–æ•°æ®ä¸ loading/error çŠ¶æ€ã€‚

---

## 1. é›¶å°è£…æ–¹æ¡ˆï¼šåœ¨ Logic å†…ç›´æ¥ä½¿ç”¨ Effect API è°ƒ TanStack Query Core

### 1.1 ç¯å¢ƒä¸æœåŠ¡å®šä¹‰ï¼ˆEnv Integrationï¼‰

ç¬¬ä¸€æ­¥ï¼Œå°† `QueryClient` ä½œä¸ºä¸€ä¸ªæ™®é€šçš„ Effect Service æ³¨å…¥ Logix Runtime ç¯å¢ƒï¼š

```ts
// infra/QueryClientEnv.ts
import { Context, Effect } from "effect"
import { QueryClient } from "@tanstack/query-core"

export class QueryClientTag extends Context.Tag("QueryClient")<
  QueryClientTag,
  QueryClient
>() {}

// åœ¨ AppRuntime ç»„åˆå±‚ï¼šæ„é€ å¹¶æ³¨å…¥ä¸€ä¸ªå…±äº«çš„ QueryClient å®ä¾‹
const queryClientLayer = Effect.gen(function* () {
  const client = new QueryClient({
    // é»˜è®¤é…ç½®ï¼šstaleTime / retry ç­‰
  })
  return client
}).pipe(Effect.map((client) => Context.make(QueryClientTag, client)))
```

åœ¨ `Logix.app` æˆ–è¿è¡Œæ—¶è£…é…å±‚ï¼Œå°† `queryClientLayer` ä¸å…¶ä»– Infra Layer åˆå¹¶ï¼Œä¿è¯æ‰€æœ‰ Logic éƒ½èƒ½é€šè¿‡ `yield* QueryClientTag` è·å–åŒä¸€ä¸ªå®¢æˆ·ç«¯å®ä¾‹ã€‚

### 1.2 åŒæ­¥å¼åœºæ™¯ï¼šç›´æ¥ `fetchQuery` + çŠ¶æ€å›å¡«

å¯¹äºâ€œæŒ‰éœ€åŠ è½½ä¸€æ¬¡â€çš„åœºæ™¯ï¼ˆä¾‹å¦‚è¯¦æƒ…é¡µè¿›å…¥æ—¶åŠ è½½ä¸€æ¬¡ç”¨æˆ·ä¿¡æ¯ï¼‰ï¼Œä¸ç”¨ä»»ä½• Adapter/Linkï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨ Logic å†…è°ƒç”¨ RQ çš„ `fetchQuery` å¹¶å›å¡«çŠ¶æ€ï¼š

```ts
// features/user/UserModule.ts
export const UserModule = Logix.Module("User", {
  state: UserStateSchema,
  actions: {
    load: Schema.Struct({ id: Schema.String }),
    setData: UserDataSchema,
    setLoading: Schema.Boolean,
    setError: Schema.optional(Schema.String)
  }
})

// features/user/User.logic.ts
export const LoadUserLogic = UserModule.logic(($) =>
  Effect.gen(function* () {
    // ç›‘å¬ load åŠ¨ä½œ
    const load$ = $.flow.fromAction(
      (a): a is { _tag: "load"; payload: { id: string } } => a._tag === "load"
    )

    // è·å– QueryClient Service
    const queryClient = yield* QueryClientTag

    yield* load$.pipe(
      $.flow.runLatest(({ payload }) =>
        Effect.gen(function* () {
          // 1) å†™å…¥ loading çŠ¶æ€
          yield* $.actions.setLoading(true)

          // 2) è°ƒç”¨ RQ fetchQueryï¼ˆåŒ…å«ç¼“å­˜ï¼‰
          const data = yield* Effect.tryPromise({
            try: () =>
              queryClient.fetchQuery({
                queryKey: ["user", payload.id],
                queryFn: () => UserApi.fetchUser(payload.id)
              }),
            catch: (e) => e as Error
          })

          // 3) å›å¡«æ•°æ®/é”™è¯¯
          if (data instanceof Error) {
            yield* $.actions.setError(data.message)
          } else {
            yield* $.actions.setData(data)
            yield* $.actions.setError(undefined)
          }

          yield* $.actions.setLoading(false)
        })
      )
    )
  })
)
```

ç‰¹ç‚¹ï¼š

- **ç¼“å­˜ç”± QueryClient è´Ÿè´£**ï¼š`fetchQuery` ä¼šå‘½ä¸­å·²æœ‰ç¼“å­˜ï¼Œä¸ä¼šæ€»æ˜¯å‘ç½‘ç»œè¯·æ±‚ï¼›
- **çŠ¶æ€ç”± Logix æ‰¿æ‹…**ï¼šåªè¦ UI åªçœ‹ `UserModule` çš„ `state`ï¼ˆdata/loading/errorï¼‰ï¼Œç»„ä»¶æœ¬èº«å®Œå…¨ä¸ç”¨å…³å¿ƒ RQã€‚

é€‚ç”¨åœºæ™¯ï¼š

- è¯¦æƒ…é¡µ â€œè¿›å…¥æ—¶åŠ è½½ä¸€æ¬¡â€ï¼›  
- ç‚¹å‡»æŸä¸ªæŒ‰é’®è§¦å‘â€œæ‹‰å–æœ€æ–°é…ç½®ä¸€æ¬¡â€ç­‰ã€‚

### 1.3 å“åº”å¼åœºæ™¯ï¼šæ‰‹å†™çŠ¶æ€é©±åŠ¨ + ç¼“å­˜ + å¤±æ•ˆ

å¯¹äºâ€œç”± Logix state å˜åŒ–é©±åŠ¨è¯·æ±‚ï¼Œå¹¶å¸Œæœ›å¤ç”¨ RQ ç¼“å­˜â€çš„åœºæ™¯ï¼ˆåˆ—è¡¨ç­›é€‰ã€åˆ†é¡µç­‰ï¼‰ï¼ŒåŒæ ·å¯ä»¥åœ¨ Logic é‡Œç›´æ¥ç”¨ RQ Core å®ç°ï¼š

```ts
// features/list/ListModule.ts
export const ListModule = Logix.Module("List", {
  state: ListStateSchema, // åŒ…å« filters/pagination/list/meta ç­‰
  actions: {
    setFilters: FiltersSchema,
    setPage: Schema.Number,
    setData: ListDataSchema,
    setLoading: Schema.Boolean,
    setError: Schema.optional(Schema.String)
  }
})

export const LoadListLogic = ListModule.logic(($) =>
  Effect.gen(function* () {
    const queryClient = yield* QueryClientTag

    // å½“ filters æˆ– pagination å˜åŒ–æ—¶é‡æ–°åŠ è½½
    const params$ = $.flow.fromState((s) => ({
      filters: s.filters,
      page: s.pagination.page,
      pageSize: s.pagination.pageSize
    }))

    yield* params$.pipe(
      $.flow.debounce(200),
      $.flow.runLatest(({ filters, page, pageSize }) =>
        Effect.gen(function* () {
          yield* $.actions.setLoading(true)

          const queryKey = ["list", { filters, page, pageSize }] as const

          const data = yield* Effect.tryPromise({
            try: () =>
              queryClient.fetchQuery({
                queryKey,
                queryFn: () =>
                  ListApi.search({
                    filters,
                    page,
                    pageSize
                  })
              }),
            catch: (e) => e as Error
          })

          if (data instanceof Error) {
            yield* $.actions.setError(data.message)
          } else {
            yield* $.actions.setData(data)
            yield* $.actions.setError(undefined)
          }

          yield* $.actions.setLoading(false)
        })
      )
    )
  })
)
```

ç‰¹ç‚¹ï¼š

- ä¸šåŠ¡é€»è¾‘ï¼ˆä½•æ—¶åŠ è½½ï¼Œfilters/page å¦‚ä½•ç»„åˆï¼‰å®Œå…¨ç”± Logix æ§åˆ¶ï¼›
- RQ åªè´Ÿè´£ç¼“å­˜ + è¯·æ±‚æ§åˆ¶ï¼›
- UI ä»ç„¶åªå…³å¿ƒä¸€ä¸ª Module çš„ stateï¼Œç»„ä»¶å†…é›¶ `useEffect`ã€‚

ä¸è¶³ï¼š

- æ¯ä¸ª Feature éƒ½è¦æ‰‹å†™â€œç›‘å¬ state â†’ è°ƒ Query â†’ å›å¡«â€çš„å¥—è·¯ï¼›
- æ²¡æœ‰ç»Ÿä¸€çš„é”™è¯¯å¤„ç†/åŸ‹ç‚¹/é‡è¯•ç­–ç•¥ï¼Œéš¾ä»¥å¹³å°åŒ–ï¼›
- å³ä½¿ä½¿ç”¨ `runLatest` ç­‰ Flow å·¥å…·ï¼Œå¯¹äºé˜²æŠ–/å¹‚ç­‰ç­‰ç­–ç•¥ï¼Œä»ç„¶éœ€è¦æ¯æ¬¡æ˜¾å¼ç¼–å†™ã€‚

### 1.4 æ‰‹åŠ¨è®¢é˜… Query çŠ¶æ€æµï¼ˆé€šè¿‡ Observerï¼‰

ä¸Šé¢çš„ä¾‹å­ä½¿ç”¨ `fetchQuery` æ˜¯â€œæ‹‰â€çš„æ¨¡å¼ã€‚å¦‚æœå¸Œæœ›æ›´è´´è¿‘ â€œReact Query çš„è§‚å¯Ÿè€…æ¨¡å¼â€ï¼Œå¯ä»¥åœ¨ Logic ä¸­ç›´æ¥ä½¿ç”¨ `QueryObserver`ï¼Œå¹¶å°†å…¶äº‹ä»¶æ¡¥æ¥ä¸º Streamï¼š

```ts
import { QueryObserver } from "@tanstack/query-core"
import { Stream, Effect } from "effect"

const observer = new QueryObserver(queryClient, {
  queryKey,
  queryFn,
  // ...
})

// å°† RQ çš„è®¢é˜…å›è°ƒåŒ…è£…æˆ Effect Stream
const result$ = Stream.async<ObserverResult<any>>((emit) =>
  Effect.sync(() => {
    const unsubscribe = observer.subscribe((result) => {
      emit(Effect.succeed(result))
    })
    return Effect.sync(unsubscribe)
  })
)
```

ç„¶ååœ¨ Logic ä¸­è®¢é˜… `result$`ï¼Œå¹¶å›å¡« Logix stateã€‚  
è¿™ç§æ¨¡å¼æ›´æ¥è¿‘â€œRuntime Adapterâ€ï¼Œä½†çº¯ä» API çœ‹ï¼Œä»ç„¶åªæ˜¯ Effect + Stream çš„ç»„åˆï¼Œå¹¶æœªå¼•å…¥ Adapter æ¦‚å¿µã€‚

### 1.5 ç»“åˆ `$.lifecycle` ç®¡ç† RQ èµ„æºçš„å¯ç¤º

åœ¨ä¸Šè¿°å‡ ç§â€œé›¶å°è£…â€å†™æ³•ä¸­ï¼Œå°¤å…¶æ˜¯åŸºäº `QueryObserver` çš„æ–¹æ¡ˆï¼Œæœ¬è´¨ä¸Šéƒ½ä¼šåœ¨æ¨¡å—ç”Ÿå‘½å‘¨æœŸå†…æŒæœ‰ä¸€å¨é•¿æœŸå­˜åœ¨çš„å¤–éƒ¨èµ„æºï¼ˆObserver / è®¢é˜…å‡½æ•°ç­‰ï¼‰ã€‚è¿™ç±»â€œæ´»æœŸèµ„æºâ€æ›´é€‚åˆæŒ‚åœ¨ `$.lifecycle` ä¸Šï¼Œè€Œä¸æ˜¯ç›´æ¥å†™åœ¨ Logic é¡¶å±‚ï¼š

```ts
export const UserQueryLifecycleLogic = UserModule.logic(($) =>
  Effect.gen(function* () {
    const queryClient = yield* QueryClientTag

    // é€šè¿‡ lifecycle ç¡®ä¿ Observer çš„åˆ›å»ºä¸é”€æ¯å’Œ Module Scope ç»‘å®š
    yield* $.lifecycle.onInit(
      Effect.gen(function* () {
        const observer = new QueryObserver(queryClient, {
          queryKey: ["user", /* ... */],
          queryFn: ({ queryKey }) => UserApi.fetchUser(queryKey[1] as string)
        })

        const result$ = Stream.async<ObserverResult<any>>((emit) =>
          Effect.sync(() => {
            const unsubscribe = observer.subscribe((result) => {
              emit(Effect.succeed(result))
            })
            return Effect.sync(unsubscribe)
          })
        )

        // åœ¨ Scope å†…æ¶ˆè´¹ç»“æœæµå¹¶å›å¡« state
        return Stream.runForEach(result$, (res) =>
          Effect.gen(function* () {
            if (res.status === "success") {
              yield* $.actions.setData(res.data)
            } else if (res.status === "error") {
              yield* $.actions.setError(String(res.error))
            }
            // æ ¹æ®éœ€è¦æ›´æ–° loading ç­‰
          })
        )
      })
    )
  })
)
```

è¿™ç§æ¨¡å¼å¸¦æ¥çš„å¯ç¤ºæ˜¯ï¼š

- **é•¿æœŸå­˜åœ¨çš„å¤–éƒ¨èµ„æº**ï¼ˆå¦‚ RQ Observerã€WebSocket è¿æ¥ï¼‰ï¼Œå°½é‡é€šè¿‡ `$.lifecycle.onInit / onDestroy` ç®¡ç†ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨ Logic é¡¶å±‚åˆ›å»ºï¼›
- **äº‹ä»¶é©±åŠ¨çš„ä¸šåŠ¡é€»è¾‘**ï¼ˆå¦‚ filters/page å˜åŒ–è§¦å‘åŠ è½½ï¼‰ä»é€šè¿‡ `$.flow` / `$.onState` / `$.onAction` å®ç°ï¼›
- å°†æ¥åœ¨ `@logix/query` ç­‰æ‰©å±•åŒ…ä¸­ï¼Œå¯ä»¥ä»¥ `$.lifecycle` ä½œä¸ºä¸»è¦æŒ‚è½½ç‚¹ï¼š  
  ç”±æ‰©å±•åŒ…åœ¨ lifecycle å†…åˆ›å»ºå¹¶ç®¡ç† RQ Observerï¼Œä¸šåŠ¡ä»£ç åªéœ€é…ç½®â€œKey / Params / Result â†’ State/Action çš„æ˜ å°„â€ï¼Œä¿æŒ Module/Logic çš„ç»Ÿä¸€å½¢çŠ¶ã€‚

### 1.6 Logic æ‹†åˆ†å»ºè®®ï¼šç”¨ç‹¬ç«‹ Logic æ”¶ç¼–åŸæ¥çš„ `useQuery`

ä»â€œæŠŠæ—§ä»£ç è¿åˆ° Logixâ€è§’åº¦ï¼Œæ¨èçš„å¿ƒæ™ºæ˜¯ï¼š

> åŸæ¥ç»„ä»¶é‡Œæ¯ä¸€ä¸ª `useQuery(...)`ï¼Œåœ¨ Logix æ—¶ä»£å¯¹åº”ä¸€æ®µä¸“é—¨è´Ÿè´£â€œè¯·æ±‚ + ç¼“å­˜ + å›å¡«â€çš„ Logicã€‚

ä¸€ä¸ªå…¸å‹çš„è¿ç§»å¯¹æ¯”ï¼š

**æ—§å†™æ³•ï¼ˆç»„ä»¶å†… useQuery + æ‰‹åŠ¨å¤„ç†ï¼‰**

```tsx
// UserProfile.tsx (æ—§)
const { data, isLoading, error } = useQuery({
  queryKey: ["user", userId],
  queryFn: () => UserApi.fetchUser(userId),
})

if (isLoading) return <Skeleton />
if (error) return <ErrorBox msg={String(error)} />

return <UserView user={data} />
```

**æ–°å†™æ³•ï¼ˆModule + UserRQLogic + useModuleï¼‰**

```ts
// UserModule.ts
export const UserModule = Logix.Module("User", {
  state: Schema.Struct({
    userId: Schema.String,
    data: UserSchema,
    isLoading: Schema.Boolean,
    error: Schema.optional(Schema.String)
  }),
  actions: {
    setUserId: Schema.String,
    setData: UserSchema,
    setLoading: Schema.Boolean,
    setError: Schema.optional(Schema.String)
  }
})

// UserRQ.logic.ts â€”â€” ä¸“é—¨çš„ RQ æŸ¥è¯¢é€»è¾‘
export const UserRQLogic = UserModule.logic(($) =>
  Effect.gen(function* () {
    const queryClient = yield* QueryClientTag

    // å½“ userId å˜åŒ–æ—¶é‡æ–°æ‹‰å–
    const id$ = $.flow.fromState((s) => s.userId)

    yield* id$.pipe(
      $.flow.filter((id) => !!id),
      $.flow.runLatest((id) =>
        Effect.gen(function* () {
          yield* $.actions.setLoading(true)
          const data = yield* Effect.tryPromise({
            try: () =>
              queryClient.fetchQuery({
                queryKey: ["user", id],
                queryFn: () => UserApi.fetchUser(id)
              }),
            catch: (e) => e as Error
          })
          if (data instanceof Error) {
            yield* $.actions.setError(data.message)
          } else {
            yield* $.actions.setData(data)
            yield* $.actions.setError(undefined)
          }
          yield* $.actions.setLoading(false)
        })
      )
    )
  })
)

// runtime.ts â€”â€” è£…é…
export const UserLive = UserModule.live(initialState, UserRQLogic /*, å…¶å®ƒä¸šåŠ¡ Logic */)
```

```tsx
// UserProfile.tsx (æ–°)
export const UserProfile = () => {
  const { state, actions } = useModule(UserModule)

  // ç»„ä»¶åªå…³å¿ƒ stateï¼Œä¸å†ç›´æ¥è§¦ç¢° Query
  if (state.isLoading) return <Skeleton />
  if (state.error) return <ErrorBox msg={state.error} />

  return (
    <div>
      <UserView user={state.data} />
      <button onClick={() => actions.setUserId("next-id")}>Next User</button>
    </div>
  )
}
```

å®è·µå»ºè®®ï¼š

- å¯¹äºå¤§å¤šæ•°åœºæ™¯ï¼Œå¯ä»¥æŒ‰â€œä¸€ä¸ª useQuery â†’ ä¸€æ®µ RQ Logicâ€çš„ç²’åº¦æ¥æ‹†åˆ†ï¼›  
- å…¶ä»–çº¯æœ¬åœ° Logicï¼ˆæ¯”å¦‚å­—æ®µè”åŠ¨ã€UI çŠ¶æ€ï¼‰ä»å†™åœ¨è‡ªå·±çš„ Logic æ–‡ä»¶é‡Œï¼Œé€šè¿‡ state/action ä¸è¿™æ®µ RQ Logic äº¤äº’ï¼›  
- å¦‚æœå‘ç°å¤šæ®µæŸ¥è¯¢é€»è¾‘å¤©ç„¶ç»‘åœ¨ä¸€èµ·ï¼Œå†è€ƒè™‘åˆå¹¶æˆä¸€ä¸ªâ€œåœºæ™¯çº§ RQ Logicâ€ï¼Œè€Œä¸æ˜¯ä¸€å¼€å§‹å°±å†™æˆä¸€å¨â€œå¤§ Logicâ€ã€‚ 

---

## 2. é›¶å°è£…æ–¹æ¡ˆçš„ä¼˜ç‚¹ä¸å±€é™

### 2.1 ä¼˜ç‚¹ï¼šæç®€å¿ƒæ™º + ç«‹å³å¯ç”¨

- å¯¹ä¸šåŠ¡å·¥ç¨‹å¸ˆï¼š
  - ä¸éœ€è¦ç†è§£ Adapter æˆ– Linkï¼Œåªéœ€è¦åœ¨ Logic ä¸­å†™ Effect ä»£ç ï¼›
  - â€œæˆ‘å°±æ˜¯åœ¨è‡ªå·±çš„æ¨¡å—é‡Œè°ƒç”¨ä¸€ä¸ª Serviceï¼ˆQueryClientï¼‰å†å›å¡«çŠ¶æ€â€ï¼Œç¬¦åˆç›´è§‰ã€‚
- å¯¹æ¶æ„å¸ˆï¼š
  - ä¸éœ€è¦ä¸€å¼€å§‹å°±è®¾è®¡ `@logix/query` çš„å®Œæ•´ APIï¼›
  - å¯ä»¥å…ˆåœ¨å‡ ä¸ªæ ¸å¿ƒ Feature é‡Œè¯•æ°´ï¼Œæ¢ç´¢æœ€åˆé€‚çš„ç¼“å­˜/å¹¶å‘/é”™è¯¯å¤„ç†æ¨¡å¼ï¼Œå†è€ƒè™‘æŠ½è±¡ã€‚

### 2.2 å±€é™ï¼šæ¨¡å¼é‡å¤ & éš¾ä»¥å¹³å°çº§ç»Ÿä¸€

1. **é‡å¤çš„ glue é€»è¾‘**  
   - æ¯ä¸ªæ¨¡å—éƒ½è¦åå¤å†™ï¼š
     - â€œç›‘å¬ filters/page å˜åŒ– â†’ è°ƒ RQ â†’ å›å¡« data/loading/errorâ€çš„å¥—è·¯ï¼›
     - é˜²æŠ–ã€å»æŠ–ã€æœ€æ–°ä¼˜å…ˆç­‰æ¨¡å¼é å·¥ç¨‹å¸ˆè‡ªè§‰ï¼›
   - å¾ˆå®¹æ˜“å‡ºç° N ç§ç•¥æœ‰å·®å¼‚çš„å†™æ³•ï¼Œå¢åŠ ç»´æŠ¤æˆæœ¬ã€‚

2. **ç­–ç•¥åˆ†æ•£ï¼Œéš¾ä»¥ç»Ÿä¸€å‡çº§**  
   - å¦‚æœæƒ³ç»Ÿä¸€è°ƒæ•´â€œæ‰€æœ‰åˆ—è¡¨æŸ¥è¯¢çš„é‡è¯•ç­–ç•¥/é”™è¯¯æç¤º/åŸ‹ç‚¹è¡Œä¸ºâ€ï¼Œå¿…é¡»å»æ”¹æ•£è½åœ¨å„ä¸ª Logic é‡Œçš„ä»£ç ï¼›
   - éš¾ä»¥åœ¨å¹³å°å±‚å®ç°â€œå…¨å±€å¼€å…³â€æˆ–â€œæŒ‰åœºæ™¯æ’æ‹”ç­–ç•¥â€ã€‚

3. **å¯¹ TypeScript å‹å¥½ä½†å¯¹ DX ç¨æœ‰é—¨æ§›**  
   - è™½ç„¶æ‰€æœ‰è°ƒç”¨éƒ½åœ¨å•ä¸€è¯­è¨€ï¼ˆEffect + Schemaï¼‰ä¸­è¿›è¡Œï¼Œä½†ï¼š
     - QueryKey / Params / Result ç±»å‹éœ€è¦åœ¨æ¯ä¸ª Logic ä¸­æ˜¾å¼ä¹¦å†™ï¼›
     - `fetchQuery` vs `QueryObserver` çš„é€‰æ‹©ç•™ç»™ä¸šåŠ¡å·¥ç¨‹å¸ˆï¼Œå¯¼è‡´ä½¿ç”¨é£æ ¼ä¸ç»Ÿä¸€ã€‚

4. **å¤–éƒ¨å¼•æ“è¢«å½“ä½œæ™®é€š Serviceï¼Œéâ€œç¬¬ä¸€ç±» Moduleâ€**  
   - ä» runtime-logix çš„â€œEverything is a Moduleâ€ è§†è§’çœ‹ï¼ŒRQ è¢«è§†ä¸ºä¸€ä¸ª Serviceï¼Œè€Œä¸æ˜¯å¯è§†åŒ–æ‹“æ‰‘ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼›
   - å¯¹åç»­ Studio/Universe è§†å›¾è€Œè¨€ï¼Œå¾ˆéš¾å¯¹è¿™äº›â€œéšæ€§é›†æˆâ€åšè§£æå’Œå±•ç¤ºã€‚

---

## 3. ä¸ Adapter/Link æ¨¡å¼çš„å…³ç³»

æœ¬è‰ç¨¿æ•…æ„ä¸å¼•å…¥ Adapter/Link Factoryï¼Œåªå…³æ³¨â€œæœ€ä½å°è£…æˆæœ¬â€çš„é›†æˆæ–¹å¼ã€‚  
ç„¶è€Œï¼Œä»é•¿æœŸå¹³å°è§†è§’çœ‹ï¼ŒAdapter/Link æ¨¡å¼ä»ç„¶æœ‰æ˜æ˜¾ä¼˜åŠ¿ï¼š

- **ç»Ÿä¸€ API å½¢çŠ¶**ï¼š  
  - å°† RQ æŠ•å½±ä¸º `AdapterShape<I, O>`ï¼ˆè¾“å…¥/è¾“å‡ºï¼‰æˆ–â€œè™šæ‹Ÿæ¨¡å—â€ï¼Œä½¿ Link å†™æ³•ä¸æ¨¡å—é—´åä½œåŒæ„ï¼›
  - æ¶æ„å¸ˆå¯ä»¥åœ¨ `@logix/query` ä¸­å°è£…ä¸€å¥— createQueryLink å·¥å‚ï¼Œä¸šåŠ¡åªå¡« `mapParams` / `mapData` ç­‰ã€‚

- **å¹³å°å¯è§‚æµ‹æ€§**ï¼š  
  - Link/Adapter å¯ä»¥ä½œä¸ºæ‹“æ‰‘ä¸­çš„ä¸€ç­‰èŠ‚ç‚¹è¢«è®°å½•å’Œå¯è§†åŒ–ï¼›
  - Studio å¯ä»¥åŸºäºè¿™äº› Link è¿›è¡Œâ€œæ— ä»£ç é‡é…â€ï¼Œè€Œæ— éœ€ä¿®æ”¹ä¸šåŠ¡ Logicã€‚

> é‡è¦çš„æ˜¯ï¼šå³ä¾¿æœªæ¥å¼•å…¥ Adapter/Link å·¥å‚ï¼Œå¯¹ä¸šåŠ¡å¼€å‘è€…æš´éœ²çš„ä»ç„¶æ˜¯ `Module / Logic / Link` è¿™å¥— API è½®å»“ï¼š  
> - ä»–çœ‹åˆ°çš„æ˜¯â€œæŸä¸ª Module é€šè¿‡ Link ä¸ RQ äº§ç”Ÿæ•°æ®å…³ç³»â€ï¼›  
> - Adapter/Observer åªä½œä¸ºæ‰©å±•åŒ…å†…éƒ¨å®ç°å­˜åœ¨ï¼Œä¸éœ€è¦æˆä¸ºä¸šåŠ¡å¿ƒæ™ºä¸­çš„ç¬¬å››ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚

å› æ­¤ï¼Œæ›´åˆç†çš„è·¯çº¿æ˜¯ï¼š

1. çŸ­æœŸï¼šå…è®¸å¹¶é¼“åŠ±åœ¨ Logic ä¸­ç›´æ¥ä½¿ç”¨ Effect API + RQ Core é›†æˆ Queryï¼Œå°¤å…¶æ˜¯åœ¨ï¼š
   - åœºæ™¯è¾ƒç®€å•ï¼›
   - æš‚æ—¶æ²¡æœ‰ç»Ÿä¸€å¹³å°è¦æ±‚ï¼›
   - å›¢é˜Ÿæ›´ç†Ÿæ‚‰ RQ çš„æƒ…å†µä¸‹ã€‚
2. ä¸­æœŸï¼šåœ¨å®è·µä¸­æ²‰æ·€å‡ºç¨³å®šæ¨¡å¼åï¼Œå°†â€œç›‘å¬ state â†’ è°ƒ Query â†’ å›å¡«â€çš„å¥—è·¯æŠ½è±¡ä¸ºï¼š
   - Adapterï¼ˆRQâ†’Stream/Effect å½¢çŠ¶ï¼‰ï¼›
   - Link å·¥å‚ï¼ˆæ ‡å‡†åŒ–é˜²æŠ–/å¹¶å‘/é”™è¯¯å¤„ç†ï¼‰ï¼Œå°è£…åˆ°ç‹¬ç«‹åŒ…ï¼ˆå¦‚ `@logix/query`ï¼‰ä¸­ï¼›
   - å¹¶åœ¨ core è§„èŒƒä¸­ä¸ºè¿™ç±»æ‰©å±•åŒ…æä¾›æ¸…æ™°çš„ç±»å‹ä¸è¡Œä¸ºçº¦æŸã€‚

---

## 4. å¾…å†³é—®é¢˜ / ä¸‹ä¸€æ­¥å·¥ä½œ

- åœ¨ `core/03-logic-and-flow.md` æˆ– `core/06-platform-integration.md` ä¸­ï¼š
  - æ˜¯å¦éœ€è¦æ˜ç¡®å†™å…¥â€œTanStack Query ç­‰å¤–éƒ¨å¼•æ“æ¨èå…ˆä»¥ Service å½¢æ€æ¥å…¥â€çš„æŒ‡å¯¼ï¼›
  - ä½•æ—¶å»ºè®®å‡çº§ä¸º Adapter/Link æ¨¡å¼ï¼ˆä¾‹å¦‚å¤šæ¨¡å—åä½œã€å¹³å°å¯è§†åŒ–éœ€æ±‚å‡ºç°æ—¶ï¼‰ã€‚
- åœ¨ lifecycle ç›¸å…³è§„èŒƒä¸­ï¼ˆ`core/02-module-and-logic-api.md` / `core/03-logic-and-flow.md`ï¼‰ï¼š
  - è¡¥å……ç¤ºä¾‹ä¸å»ºè®®ï¼šåƒ RQ è¿™æ ·çš„é•¿æœŸå¤–éƒ¨èµ„æºï¼Œæ¨èé€šè¿‡ `$.lifecycle.onInit / onDestroy` ç®¡ç†å…¶åˆ›å»ºä¸æ¸…ç†ï¼›
  - å°†â€œé•¿æœŸèµ„æºç”¨ lifecycle ç®¡ã€äº‹ä»¶é©±åŠ¨é€»è¾‘ç”¨ Flow/Logic å†™â€çš„è¾¹ç•Œå†™å…¥è§„èŒƒï¼Œæ–¹ä¾¿æ‰©å±•åŒ…æ²¿ç”¨è¿™ä¸€çº¦å®šã€‚
- åœ¨ PoC å±‚ï¼š
  - å¯ä»¥å…ˆåœ¨ä¸€ä¸ªçœŸå®åˆ—è¡¨åœºæ™¯ä¸­é‡‡ç”¨â€œLogic + RQ.fetchQueryâ€æ–¹å¼å®Œæ•´è·‘é€šï¼›
  - å¯¹æ¯”â€œç›´æ¥ç”¨ useQuery + useEffectâ€çš„ DX ä¸ç»´æŠ¤ä½“éªŒï¼Œå†å†³å®šå“ªéƒ¨åˆ†å€¼å¾—æŠ½è±¡ã€‚
- åœ¨è§„èŒƒå±‚ï¼š
  - åç»­è‹¥å¼•å…¥ Adapter æ¨¡å¼ï¼Œéœ€è¦ä¸æœ¬è‰ç¨¿ä¿æŒå…¼å®¹ï¼šä¿ç•™â€œé›¶å°è£…é›†æˆâ€ä½œä¸ºåˆæ³•è·¯å¾„ï¼Œè€Œä¸æ˜¯å¼ºåˆ¶æ‰€æœ‰ Query è®¿é—®éƒ½èµ° Adapterã€‚

### 4.1 å›¢é˜Ÿå†…æ‰©å±•åŒ… `@logix/query` çš„è§„åˆ’å®šä½ï¼ˆæœ¬ä»“å†…ä¼˜å…ˆå®ç°ï¼‰

åœ¨ intent-flow / runtime-logix å½“å‰çš„å‘å±•é˜¶æ®µï¼ŒLogix é¦–å…ˆæ˜¯ä¸ºå†…éƒ¨å›¢é˜ŸæœåŠ¡çš„è¿è¡Œæ—¶ä¸è§„èŒƒé›†ã€‚åŸºäºæœ¬è‰ç¨¿çš„åˆ†æï¼Œå¯ä»¥ç»™ `@logix/query` åœ¨è§„åˆ’ä¸Šä¸€ä¸ªæ¸…æ™°å®šä½ï¼š

- **ç›®æ ‡**ï¼š
  - ä¸ºä¸šåŠ¡é¡¹ç›®æä¾›ä¸€å¥—â€œæŠŠåŸæœ‰ `useQuery` è¡Œä¸ºæ”¶ç¼–åˆ° Logix Logic ä¸­â€çš„æ ‡å‡†æ¨¡å¼ï¼›
  - å°† RQ Core çš„ç»†èŠ‚ï¼ˆQueryClient / Observer / ç¼“å­˜ç­–ç•¥ï¼‰å°è£…åœ¨æ‰©å±•åŒ…å†…éƒ¨ï¼Œå¯¹ä¸šåŠ¡åªæš´éœ²ç±»å‹å®‰å…¨ã€å½¢çŠ¶ç»Ÿä¸€çš„ Logic/Link å·¥å‚ï¼›
  - é»˜è®¤ä½¿ç”¨é¡¹ç›®ä¸­å·²æœ‰çš„ `QueryClient` å•ä¾‹ï¼Œé€šè¿‡ `QueryClientTag` + Layer æ³¨å…¥ Logix Runtimeã€‚
- **èŒè´£è¾¹ç•Œ**ï¼š
  - `@logix/query` ä½œä¸ºå›¢é˜Ÿå†…æ‰©å±•åŒ…å­˜åœ¨ï¼Œä¸è¿›å…¥ `@logix/core`ï¼›  
  - å‘ä¸šåŠ¡æš´éœ²çš„åªæ˜¯ä¸€å°æ’®å·¥å‚å‡½æ•°ï¼š
    - `rqLogic<Sh>(config): ModuleLogic<Sh>` â€”â€” ä¸€ç±»æŸ¥è¯¢ â†’ ä¸€æ®µ Logicï¼Œå¯ç›´æ¥æŒ‚åˆ° `Module.live`ï¼›
    - `rqLink(config): Effect.Effect<void, E, R>` â€”â€” é€‚åˆè·¨æ¨¡å— / è·¨ç³»ç»Ÿåä½œçš„æŸ¥è¯¢åœºæ™¯ï¼ŒæŒ‚åˆ° `Logix.app` çš„ processesï¼›
  - æ‰€æœ‰å¯¹ `QueryClientTag`ã€`$.lifecycle`ã€`QueryObserver` çš„æ“ä½œï¼Œéƒ½ç•™åœ¨æ‰©å±•å®ç°å†…éƒ¨ï¼Œä¸è¦æ±‚ä¸šåŠ¡å·¥ç¨‹å¸ˆæŒæ¡ã€‚
- **å®ç°é¡ºåºå»ºè®®**ï¼š
  1. å…ˆåœ¨ä¸€ä¸¤ä¸ªå…¸å‹é¡µé¢ï¼ˆè¯¦æƒ… + åˆ—è¡¨ï¼‰é‡Œç”¨â€œæ‰‹å†™ Logic + RQ Coreâ€çš„æ–¹å¼è·‘é€šï¼Œç¡®è®¤çŠ¶æ€è®¾è®¡ä¸è§¦å‘æ¨¡å¼åˆç†ï¼›
  2. åœ¨æœ¬ä»“å®ç°æœ€å°ç‰ˆ `@logix/query`ï¼š
     - æä¾› `QueryClientTag` ä¸åŸºç¡€ Layerï¼›
     - æä¾› `rqLogic` å·¥å‚ï¼ˆä¼˜å…ˆè¦†ç›– 80% çš„ç®€å•æŸ¥è¯¢åœºæ™¯ï¼‰ï¼›
  3. åç»­æŒ‰éœ€è¦æ‰©å±• `rqLink`ã€æ›´ä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼Œä»¥åŠä¸ Link/Adapter æ¨¡å¼çš„å¯¹é½ã€‚

### 4.2 å¤šæŸ¥è¯¢éš”ç¦»ä¸ Module ç»„ç»‡çš„æœ€ä½³å®è·µï¼ˆper-query Logic / å­æ¨¡å—ï¼‰

åœ¨çœŸå®ä¸šåŠ¡ä¸­ï¼Œä¸€ä¸ª Module å†…å¾€å¾€ä¼šæœ‰å¤šæ¡æŸ¥è¯¢ï¼ˆåŸæ¥æ˜¯å¤šä¸ª `useQuery`ï¼‰ï¼Œéœ€è¦åœ¨ Logix çŠ¶æ€å±‚é¢å¯¹ loading/error ç­‰è¿›è¡Œéš”ç¦»ã€‚æœ¬è‰ç¨¿å»ºè®®ï¼š

- **é»˜è®¤æ¨¡å¼ï¼ˆæ¨èï¼‰ï¼šåŒä¸€ Module å†…ä¸ºæ¯ä¸ªæŸ¥è¯¢è®¾è®¡ç‹¬ç«‹çš„ QuerySlice + rqLogic**  
  - å¦‚ `UserModule` ä¸­åŒæ—¶æœ‰ `detail` å’Œ `orders` ä¸¤å—çŠ¶æ€ï¼Œå„è‡ªåŒ…å« `data/isLoading/error` å­—æ®µï¼›  
  - å¯¹åº”æœ‰ `UserDetailRQLogic` / `UserOrdersRQLogic` ä¸¤æ®µç‹¬ç«‹ Logicï¼Œåªä¿®æ”¹å„è‡ªçš„ sliceï¼›  
  - UI è‡ªç„¶é€šè¿‡ `state.detail.isLoading` / `state.orders.isLoading` ç­‰å­—æ®µåšç»†ç²’åº¦å±•ç¤ºã€‚
- **è¿›é˜¶æ¨¡å¼ï¼šæå‡ä¸ºå­æ¨¡å—ï¼ˆåˆ©ç”¨ Logix è‡ªç”±åº¦ï¼Œä¸å¼•å…¥æ–°æŠ½è±¡ï¼‰**  
  - å½“æŸä¸ªæŸ¥è¯¢é€»è¾‘è¶³å¤Ÿå¤æ‚æˆ–éœ€è¦è·¨åœºæ™¯å¤ç”¨æ—¶ï¼Œå¯ä»¥æå‡ä¸ºå•ç‹¬çš„ Query Moduleï¼ˆä¾‹å¦‚ `UserDetailQueryModule`ï¼‰ï¼›  
  - Domain Module é€šè¿‡ `$.use(å­æ¨¡å—)` èšåˆå¤šä¸ªå­æ¨¡å—çš„çŠ¶æ€ï¼Œæ— éœ€æ–° APIï¼š  
    - è¿™ç§åšæ³•åˆ©ç”¨äº† Logix Module çš„ç»„åˆèƒ½åŠ›ï¼Œæœ¬è´¨ä¸Šæ˜¯ Layer çš„ç»„åˆï¼›
    - é¡µé¢æ˜¯å¦â€œä¸€é¡µä¸€ Moduleâ€æ˜¯çº¦å®šè€Œéå¼ºåˆ¶ï¼Œä¸šåŠ¡å¯ä»¥ä»å• Module èµ·æ­¥ï¼Œéšç€éœ€æ±‚éš”ç¦»æ€§æå‡å†æ¸è¿›å¼•å…¥å­æ¨¡å—ã€‚

æ€»ä½“ä¸Šï¼Œç°æœ‰ Logix APIï¼ˆModule / Logic / Link + lifecycle + useLocalModuleï¼‰å·²ç»è¶³å¤Ÿæ”¯æ’‘ RQ é›†æˆå’Œå¤šæŸ¥è¯¢éš”ç¦»ï¼›  
åç»­æ›´é‡è¦çš„æ˜¯åœ¨æœ¬ä»“å†…å›ºåŒ–ä¸Šè¿°æœ€ä½³å®è·µï¼Œå¹¶é€šè¿‡ `@logix/query` ç­‰æ‰©å±•åŒ…æŠŠå¸¸è§æ¨¡å¼â€œä»£å†™â€å¥½ï¼Œé™ä½ä¸šåŠ¡å¼€å‘ä¸Šæ‰‹æˆæœ¬ã€‚
</file>

<file path="drafts/topics/query-integration/03-module-computed.md">
---
title: "Module-Level Computed & Query: The Perfect Compromise"
status: draft
version: 1.0
layer: Core Concept
related:
  - logix-reactive-schema.md (superseded)
  - logix-query-unified-api-design.md
---

# Module-Level Computed & Query

> **Decision**: Abandoning "Reactive Schema" (Logic inside Schema) in favor of "Co-located Definition" (Logic beside Schema).

## 1. The Problem with Reactive Schema

We attempted to embed logic directly into Schema definitions (`Schema.augment`), but hit the theoretical limits of TypeScript:
1.  **Recursive Type Hell**: Defining a field that depends on the state being defined creates a circular dependency that TS cannot resolve without `any` or complex Two-Pass definitions.
2.  **Runtime/Type Mismatch**: A field defined as `Reactive.async<User>` needs to be typed as `QueryState<User>` in the state, requiring opaque type magic.
3.  **Parser Complexity**: Extracting dependencies from a closure `(s) => [s.id]` is hard for static analysis tools.

## 2. The Solution: Co-located Definition

We move the "Source" definition **out of the Schema** but keep it **inside the Module definition**.

This achieves the "Holy Grail":
- âœ… **Perfect Type Safety**: State is defined *before* Logic, so Logic has full type access to State.
- âœ… **Zero Config**: No `any`, no `ThisType` magic, no generic gymnastics.
- âœ… **Platform Parsability**: `resources` and `computed` are static configuration objects.
- âœ… **High Cohesion**: Logic is still right next to the data it populates.

## 3. API Design & Strict Type Constraints

We leverage TypeScript's mapped types to enforce strict correctness:
1.  **Computed**: Key `K` must exist in State, and return type must match `State[K]`.
2.  **Resources**: Key `K` must be a field defined via `Resource.State<T>`, and the loader must return `T`.

```ts
import { Logix, Schema, Resource } from '@logix/core'

// 1. Define Pure Data Shapes (The "What")
const UserState = Schema.Struct({
  userId: Schema.String,
  firstName: Schema.String,
  lastName: Schema.String,
  // Explicitly mark this as a Resource State container
  profile: Resource.State(UserSchema),
  // Explicitly mark this as a Computed field
  fullName: Schema.String
})

export const UserModule = Logix.Module('User', {
  // 1. Attach Schema
  state: UserState,

  actions: {
    setUserId: Schema.String
  },

  // 2. Define Computed Values (The "Sync How")
  // Type Constraint: { [K in keyof State]?: (state: State) => State[K] }
  computed: {
    // âœ… TS checks: return type string matches Schema.String
    fullName: (state) => `${state.firstName} ${state.lastName}`
  },

  // 3. Define Resources (Async Data Sources)
  // Type Constraint: Only fields where State[K] extends Resource.State<T> are allowed
  resources: {
    profile: {
      // Dependency tracking (Static or Dynamic)
      deps: (state) => [state.userId],

      // Loader function
      // TS infers args from deps, enforces return type Promise<User>
      loader: ([id]) => UserApi.fetchProfile(id),

      // Options
      enabled: (state) => !!state.userId,
      staleTime: 5000
    }
  }
})
```

### Type Definition Strategy

```ts
// Helper to extract keys that are Resource States
type ResourceKeys<S> = {
  [K in keyof S]: S[K] extends Resource.State<any> ? K : never
}[keyof S]

// Helper to extract the Data type T from Resource.State<T>
type ExtractResourceData<T> = T extends Resource.State<infer D> ? D : never

export interface ModuleDef<S, A> {
  state: Schema<S>
  actions: A

  // Strict Computed Config
  computed?: {
    [K in keyof S]?: (state: S) => S[K]
  }

  // Strict Resource Config
  resources?: {
    [K in ResourceKeys<S>]?: {
      deps: (state: S) => any[]
      loader: (deps: any[]) => Promise<ExtractResourceData<S[K]>>
      // ... other options
    }
  }
}
```

## 4. Runtime Integration (Implicit Logic)

`computed` and `resources` are treated as **Metadata** on the Module definition. They do not alter the `ModuleShape`.

When `Module.live` is called:
1.  **Pure State**: The runtime state remains a plain JSON object. No closures or functions are stored in the state tree.
2.  **Implicit Logic Generation**:
    - **Computed**: Converted to a `Stream` watcher: `runtime.changes(selector).map(compute).pipe(updateState)`.
    - **Resources**: Converted to a `Stream` effect: `runtime.changes(deps).pipe(switchMap(loader), updateState)`.
3.  **Co-existence**: These implicit logics run alongside any manual `logics` passed to `Module.live`.

## 5. Trade-offs & Constraints

1.  **Dependency Cycles**:
    - *Issue*: Computed A depends on B, B depends on A.
    - *Solution*: Runtime detection (stack overflow or infinite loop) or linter rules. The spec advises against complex chains in `computed`.
2.  **Manual Overwrites**:
    - *Issue*: User manually dispatches an action to update `state.profile`.
    - *Solution*: This is allowed but discouraged. The `resources` logic will likely overwrite it on the next fetch. We treat these fields as "Runtime Managed".

## 6. Comparison

| Feature | Reactive Schema (Old) | Module Config (New) |
| :--- | :--- | :--- |
| **Type Inference** | ğŸ”´ Broken / Hard | ğŸŸ¢ Perfect |
| **Definition Style** | Nested (`Schema.augment`) | Flat (`computed: {}`) |
| **State Definition** | Implicit / Magic | Explicit (`Query.State`) |
| **Parser Friendly** | ğŸŸ¡ Medium | ğŸŸ¢ High |

## 6. Next Steps

1.  Implement `Query.State` helper in `@logix/core`.
2.  Update `Module` type definition to accept `computed` and `queries` generics.
3.  Implement the runtime logic injection in `ModuleRuntime`.
</file>

<file path="drafts/topics/query-integration/04-reactive-paradigm.md">
#  Reactive æ•°æ®èŒƒå¼ä¸ç»Ÿä¸€æ•°æ®æµ

**åˆå¹¶æ–‡æ¡£**ï¼šæ•´åˆ `logix-reactive-schema.md` å’Œ `logix-reactive-module-integration.md` çš„æ ¸å¿ƒè§‚ç‚¹ã€‚

---

## ä¸€ã€æ ¸å¿ƒç†å¿µ

### 1.1 Reactive Schema: The Logix v3 Data Paradigm

Reactive Schema æ˜¯å¯¹ State Schema çš„è¯­ä¹‰æ‰©å±•ï¼Œå°†"æ•°æ®æ¥æº"å’Œ"å“åº”å¼è§„åˆ™"å†…åµŒåˆ° Schema å®šä¹‰ä¸­ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š
- State ä¸å†æ˜¯"é™æ­¢çš„å¿«ç…§"ï¼Œè€Œæ˜¯"æ´»è·ƒçš„æ•°æ®æµæºå¤´"
- ä» Schema å…ƒæ•°æ®è‡ªåŠ¨æ´¾ç”Ÿ Logicï¼Œè€Œéæ‰‹å†™ç›‘å¬é€»è¾‘

### 1.2 ä¸ Query çš„å…³ç³»

Reactive Schema æ˜¯ Query Integration çš„åº•å±‚æ”¯æ’‘ï¼š
- `Query.field` æœ¬è´¨ä¸Šæ˜¯ Reactive Schema çš„ä¸€ç§ç‰¹åŒ–å½¢å¼
- `Schema.Loadable` / `Schema.Computed` ç­‰éƒ½æ˜¯ Reactive èƒ½åŠ›çš„ä½“ç°

---

## äºŒã€Reactive Module è®¾è®¡

### 2.1 Reactive DSL å½¢æ€

```typescript
const UserModule = Logix.Module('User', {
  state: Schema.Struct({
    firstName: Schema.String,
    lastName: Schema.String,

    // Computed: æ´¾ç”Ÿå­—æ®µ
    fullName: Reactive.computed({
      deps: (state) => [state.firstName, state.lastName],
      derive: ([first, last]) => `${first} ${last}`
    }),

    // Query Field: å¼‚æ­¥æ•°æ®
    profile: Query.field({
      queryKey: (state) => ['user', state.userId],
      queryFn: ({ queryKey: [_, id] }) => UserApi.fetchProfile(id),
      enabled: (state) => !!state.userId
    }),

    // Effect: å‰¯ä½œç”¨
    _trackView: Reactive.effect({
      trigger: (state) => state.currentPage,
      run: (page) => analytics.track('page_view', { page })
    })
  }),
  actions: { ... }
})
```

### 2.2 ç¼–è¯‘ä¸è¿è¡Œæ—¶

**ç¼–è¯‘æ—¶**ï¼ˆ`Module.live` é˜¶æ®µï¼‰ï¼š
1. æ‰«æ Schemaï¼Œè¯†åˆ« Reactive Annotation
2. è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ `ModuleLogic[]`
3. æ³¨å…¥åˆ° Module Runtime

**è¿è¡Œæ—¶**ï¼š
- Computed: ç›‘å¬ deps å˜åŒ– â†’ é‡æ–°è®¡ç®— â†’ æ›´æ–° State
- Query Field: ç›‘å¬ queryKey deps å˜åŒ– â†’ è§¦å‘ fetch â†’ æ›´æ–° data/isLoading/error
- Effect: ç›‘å¬ trigger å˜åŒ– â†’ æ‰§è¡Œå‰¯ä½œç”¨ï¼ˆä¸æ›´æ–° Stateï¼‰

---

## ä¸‰ã€ç»Ÿä¸€æ•°æ®èŒƒå¼

### 3.1 æ•°æ®æµåˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Reactive Schema (è“å›¾å±‚)             â”‚
â”‚ - Computed / Query / Effect         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ ç¼–è¯‘ (Module.live)
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ModuleLogic[] (é€»è¾‘å±‚)              â”‚
â”‚ - è‡ªåŠ¨ç”Ÿæˆçš„ Logic Effect            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ æ‰§è¡Œ (Runtime)
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ModuleRuntime (çŠ¶æ€å±‚)              â”‚
â”‚ - SubscriptionRef + PubSub          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ä¸æ‰‹å†™ Logic çš„å…³ç³»

**Reactive DSL æ˜¯è¯­æ³•ç³–ï¼Œä¸æ˜¯æ›¿ä»£å“**ï¼š

- Reactive DSL â†’ è‡ªåŠ¨ç”Ÿæˆ `ModuleLogic[]`
- æ‰‹å†™ Logic: `Module.logic(($) => ...)`
- ä¸¤è€…æœ€ç»ˆéƒ½ä»¥ `ModuleLogic` å½¢å¼æ³¨å…¥ Runtime

**é€ƒé€¸é€šé“**ï¼š
- ç®€å•åœºæ™¯ï¼šä½¿ç”¨ Reactive DSL
- å¤æ‚åœºæ™¯ï¼šé€€å›æ‰‹å†™ Logic + Fluent DSL

---

## å››ã€ä¸ Query Integration çš„èåˆ

### 4.1 Query.field æ˜¯ Reactive Schema çš„ç‰¹åŒ–

```typescript
// Layer 1: Query.field (å£°æ˜å¼)
profile: Query.field({ ... })

// ç­‰ä»·äº Reactive DSL:
profile: Reactive.computed({
  deps: (state) => state.userId,
  derive: async (userId) => {
    const data = await fetchProfile(userId)
    return { data, isLoading: false, error: null }
  }
})
```

### 4.2 ä¸‰å±‚ API ä¸ Reactive çš„å¯¹åº”

| Layer | API | Reactive å…³ç³» |
|-------|-----|---------------|
| Layer 1 | `Query.field` | Reactive DSL ç‰¹åŒ– |
| Layer 2 | `createQueryLogic` | æ˜¾å¼ Logic å·¥å‚ï¼ˆä¸ä¾èµ– Schemaï¼‰ |
| Layer 3 | Manual | æ‰‹å†™ `Module.logic`ï¼ˆå®Œå…¨ç»•è¿‡ Reactiveï¼‰ |

---

## äº”ã€è®¾è®¡æƒè¡¡

### 5.1 ä¼˜åŠ¿

- **DX æå‡**: é›¶æ ·æ¿ä»£ç ï¼Œå£°æ˜å¼è¡¨è¾¾
- **ç±»å‹å®‰å…¨**: Schema å…ƒæ•°æ®æä¾›ç±»å‹æ¨å¯¼
- **å¹³å°å‹å¥½**: æ˜“äºé™æ€åˆ†æå’Œå¯è§†åŒ–

### 5.2 æŒ‘æˆ˜

- **ç±»å‹æ¨å¯¼å¤æ‚**: é€’å½’ç±»å‹ã€Proxy Type
- **è°ƒè¯•ä½“éªŒ**: éšå¼ç”Ÿæˆçš„ Logic å¯èƒ½éš¾ä»¥è¿½è¸ª
- **å­¦ä¹ æ›²çº¿**: éœ€è¦ç†è§£"Schema â†’ Logic"çš„ç¼–è¯‘è¿‡ç¨‹

### 5.3 ç¼“è§£ç­–ç•¥

- **æ¸è¿›å¼å¼•å…¥**: å…ˆæ”¯æŒç®€å•åœºæ™¯ï¼ˆComputed/Queryï¼‰ï¼Œå†æ‰©å±•å¤æ‚èƒ½åŠ›
- **DevTools æ”¯æŒ**: å¯è§†åŒ–æ˜¾ç¤º"å“ªäº› Logic æ˜¯ä» Schema è‡ªåŠ¨ç”Ÿæˆçš„"
- **æ–‡æ¡£åˆ†å±‚**: å…¥é—¨åªè®² `Query.field`ï¼Œé«˜çº§éƒ¨åˆ†æ‰è®²å®Œæ•´ Reactive DSL

---

## å…­ã€è·¯çº¿å›¾

### çŸ­æœŸ (v3.x)

- [ ] å®ç° `Schema.Loadable` åŸºç¡€èƒ½åŠ›
- [ ] å®ç° `Query.field` (Layer 1)
- [ ] éªŒè¯ Schema æ‰«æä¸ Logic æ³¨å…¥æœºåˆ¶

### ä¸­æœŸ (v3.x+)

- [ ] å®ç° `Reactive.computed`
- [ ] å®ç° `Reactive.effect`
- [ ] è¡¥å……å®Œæ•´ TypeScript ç±»å‹æ¨å¯¼

### é•¿æœŸ (v4.0+)

- [ ] å®Œæ•´ Reactive DSL ç”Ÿæ€
- [ ] ä¸ RxJS / Signal ç­‰å“åº”å¼åº“äº’æ“ä½œ
- [ ] Schema-First Studio å¯è§†åŒ–ç¼–è¾‘

---

## ä¸ƒã€ç›¸å…³æ–‡æ¡£

- [01-unified-api-design.md](./01-unified-api-design.md)
- [runtime-logix/core/02-module-and-logic-api.md](../../../runtime-logix/core/02-module-and-logic-api.md)

---

**åˆå¹¶æ¥æº**:
- `logix-reactive-schema.md` (Reactive Schema æ•°æ®èŒƒå¼)
- `logix-reactive-module-integration.md` (Reactive Module ç»Ÿä¸€æ•°æ®èŒƒå¼)

**æœ€åæ›´æ–°**: 2025-12-02
</file>

<file path="drafts/topics/query-integration/05-implementation-plan.md">
---
title: "Logix Query é›†æˆï¼šå®æ–½è®¡åˆ’"
status: draft
version: 1.0
layer: Implementation
related:
  - 01-unified-api-design.md
---

# Logix Query é›†æˆå®æ–½è®¡åˆ’

åŸºäº [ç»Ÿä¸€ API è®¾è®¡](./01-unified-api-design.md) ä»¥åŠå¯¹å½“å‰ `runtime-logix` ä»£ç åº“çš„åˆ†æï¼Œæœ¬æ–‡æ¡£æ¦‚è¿°äº†å®ç° TanStack Query é›†æˆçš„å…·ä½“æ­¥éª¤ã€‚

## 1. ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å»ºè®¾ (Layer 3 - æ‰‹åŠ¨é›†æˆ)

**ç›®æ ‡**ï¼šåœ¨ä¸ä¿®æ”¹ Core çš„å‰æä¸‹ï¼Œç«‹å³å¯ç”¨ "æ‰‹åŠ¨é›†æˆ" èƒ½åŠ›ã€‚

### 1.1 `QueryClientTag` & `QueryClientLayer`
- **ä½ç½®**: `packages/logix-query/src/QueryClient.ts` (æ–°åŒ…)
- **å®ç°**:
  - å®šä¹‰ `QueryClientTag`ã€‚
  - æä¾› `makeQueryClientLayer` è¾…åŠ©å‡½æ•°ã€‚

### 1.2 `rqLogic` å·¥å‚ (Layer 2 - æ˜¾å¼ Logic)
- **ä½ç½®**: `packages/logix-query/src/logic.ts`
- **å®ç°**:
  - åˆ›å»º `createQueryLogic` (æˆ– `rqLogic`) å·¥å‚å‡½æ•°ã€‚
  - æ¥æ”¶å‚æ•°:
    - `module`: æ¨¡å—å®ä¾‹ã€‚
    - `config`: `{ queryKey, queryFn, mapData, mapError, ... }`ã€‚
  - è¿”å›ä¸€ä¸ª `ModuleLogic`ã€‚
  - **å†…éƒ¨é€»è¾‘**:
    - ä½¿ç”¨ `$.lifecycle.onInit` åˆ›å»º `QueryObserver`ã€‚
    - ä½¿ç”¨ `Stream.async` å°† Observer äº‹ä»¶æ¡¥æ¥åˆ° Effect Streamã€‚
    - ä½¿ç”¨ `$.flow` æ ¹æ® Stream äº‹ä»¶æ›´æ–° Stateã€‚

### 1.3 `rqLink` å·¥å‚
- **ä½ç½®**: `packages/logix-query/src/link.ts`
- **å®ç°**:
  - ä¸ `rqLogic` ç±»ä¼¼ï¼Œä½†è¿”å›ç”¨äºè·¨æ¨¡å—åœºæ™¯çš„ `Link` effectã€‚

## 2. ç¬¬äºŒé˜¶æ®µï¼šCore æ”¯æŒ Schema æ‰«æ (Layer 1 å‡†å¤‡)

**ç›®æ ‡**ï¼šä½¿ `Module.live` èƒ½å¤Ÿæ£€æµ‹å¹¶å¤„ç† Schema æ³¨è§£ã€‚

### 2.1 Query çš„ `Schema.annotations`
- **ä½ç½®**: `packages/logix-core/src/api/SchemaExtensions.ts` (æˆ–ç±»ä¼¼ä½ç½®)
- **å®ç°**:
  - å®šä¹‰ä¸€ä¸ª Symbol `QueryFieldSymbol`ã€‚
  - åˆ›å»º `Query.field` è¾…åŠ©å‡½æ•°ï¼Œè¿”å›å¸¦æœ‰æ­¤æ³¨è§£çš„ Schemaã€‚
  - æ³¨è§£ä¸­åº”æºå¸¦ `QueryConfig` (queryKey, queryFn ç­‰)ã€‚

### 2.2 æ›´æ–° `ModuleFactory`
- **ä½ç½®**: `packages/logix-core/src/runtime/ModuleFactory.ts`
- **å˜æ›´**:
  - åœ¨ `Module.live` (åŠ `make`) ä¸­:
    1. éå† `shape.stateSchema` å­—æ®µã€‚
    2. æ£€æŸ¥ `QueryFieldSymbol`ã€‚
    3. å¦‚æœå‘ç°ï¼Œä½¿ç”¨æ³¨è§£ä¸­çš„é…ç½®ç”Ÿæˆéšå¼çš„ `ModuleLogic`ã€‚
    4. å°†æ­¤ logic é¢„ç½®åˆ°ä¼ é€’ç»™ `ModuleRuntime.make` çš„ `logics` æ•°ç»„ä¸­ã€‚

## 3. ç¬¬ä¸‰é˜¶æ®µï¼šLayer 1 å®ç° (å£°æ˜å¼ Query Field)

**ç›®æ ‡**ï¼šå®Œæ•´çš„ "é›¶é…ç½®" ä½“éªŒã€‚

### 3.1 é€’å½’ç±»å‹æ¨å¯¼
- **æŒ‘æˆ˜**: `queryKey: (state) => ...` éœ€è¦ `State` ç±»å‹ï¼Œä½† `State` æ­£åœ¨å®šä¹‰ä¸­ã€‚
- **æ–¹æ¡ˆ**:
  - **é€‰é¡¹ A (ä¸¤æ­¥æ³•)**: å…ˆå®šä¹‰ DTOï¼Œå†æ‰©å±• Queryã€‚(v1 æ¨è)
  - **é€‰é¡¹ B (ThisType)**: åœ¨ `Query.field` ä¸­ä½¿ç”¨ `ThisType<Partial<State>>`ã€‚

### 3.2 è¿è¡Œæ—¶æ³¨å…¥
- å¦‚é˜¶æ®µ 2.2 æ‰€è¿°ï¼Œåœ¨ `ModuleFactory` ä¸­å®ç° logic ç”Ÿæˆã€‚
- ç¡®ä¿ç”Ÿæˆçš„ logic è¡Œä¸ºä¸ `rqLogic` å®Œå…¨ä¸€è‡´ã€‚

## 4. ä»»åŠ¡æ‹†è§£

### æ­¥éª¤ 1: åˆ›å»º `@logix/query` åŒ…
- [ ] åˆå§‹åŒ– `packages/logix-query`ã€‚
- [ ] å®ç° `QueryClientTag`ã€‚
- [ ] å®ç° `rqLogic` å·¥å‚ (Layer 2)ã€‚
- [ ] æ·»åŠ  `logix-test` æµ‹è¯•ã€‚

### æ­¥éª¤ 2: Core å¢å¼º
- [ ] åœ¨ `@logix/core` ä¸­æ·»åŠ  `Query.field` å®šä¹‰ã€‚
- [ ] ä¿®æ”¹ `ModuleFactory.ts` ä»¥æ‰«æå¹¶æ³¨å…¥ logicsã€‚

### æ­¥éª¤ 3: æ–‡æ¡£ä¸ç¤ºä¾‹
- [ ] æ·»åŠ  `examples/logix-query-demo`ã€‚
- [ ] æ›´æ–° `apps/docs` ä¸­çš„ Query é›†æˆæŒ‡å—ã€‚

## 5. API é¢„è§ˆ

```ts
// Layer 1
const UserModule = Logix.Module('User', {
  state: Schema.Struct({
    id: Schema.String,
    profile: Query.field({
      queryKey: (s) => ['user', s.id],
      queryFn: (...)
    })
  }),
  actions: {}
})

// Layer 2
const UserLogic = rqLogic(UserModule, {
  target: 'profile',
  queryKey: (s) => ['user', s.id],
  ...
})
```
</file>

<file path="drafts/topics/query-integration/06-unified-data-vision.md">
---
title: "Unified Data Vision: Schema-First, Relations & External Sources"
status: draft
version: 1.0
layer: Vision
value: vision
priority: later
related:
  - 01-unified-api-design.md
  - 04-reactive-paradigm.md
---

# Unified Data Vision: The "State Graph" Paradigm

> **å‘æ•£æ€è€ƒ (Brainstorming)**: è¶…è¶Šå•çº¯çš„ "Query Integration"ï¼Œæ¢ç´¢ **Schema-First** çš„ç»ˆæå½¢æ€ â€”â€” å°† Logix Module è§†ä¸º **"State ORM"** æˆ– **"Data Graph"** èŠ‚ç‚¹ã€‚

## 1. æ ¸å¿ƒæ´å¯Ÿï¼šSchema as the Single Source of Truth

å¦‚æœæˆ‘ä»¬è´¯å½» "Schema-First"ï¼Œé‚£ä¹ˆ Schema ä¸åº”ä»…ä»…æè¿° **"æ•°æ®é•¿ä»€ä¹ˆæ ·" (Shape)**ï¼Œè¿˜åº”æè¿° **"æ•°æ®ä»å“ªæ¥" (Source)** å’Œ **"æ•°æ®å’Œè°æœ‰å…³" (Relation)**ã€‚

å½“å‰çš„ `Query.field` åªæ˜¯è¿™ä¸ªæ„¿æ™¯çš„ä¸€ä¸ªç‰¹ä¾‹ï¼ˆSource = HTTP GETï¼‰ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶æ³›åŒ–ä¸º **"Resource Field"** æ¨¡å¼ã€‚

### 1.1 æ³›åŒ–å…¬å¼

$$
\text{Field} = \text{Shape} + \text{Source Metadata}
$$

åœ¨è¿è¡Œæ—¶ï¼Œ`Module.live` å……å½“ "Compiler"ï¼Œè¯»å– Metadata å¹¶è‡ªåŠ¨æŒ‚è½½å¯¹åº”çš„ "Data Pump" (Logic)ã€‚

## 2. ä¸‰å¤§ç»´åº¦çš„ç»Ÿä¸€ (The Trinity of Data)

æˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰å­—æ®µåˆ†ä¸ºä¸‰ç±»ï¼Œå¹¶åœ¨ Schema ä¸­ç»Ÿä¸€è¡¨è¾¾ï¼š

### 2.1 å†…éƒ¨è®¡ç®— (Computed / Derived)
*   **å®šä¹‰**: ä¾èµ–å½“å‰ Module çš„å…¶ä»–å­—æ®µè®¡ç®—å¾—å‡ºã€‚
*   **API**: `Computed.field(deps, calculator)`
*   **æœ¬è´¨**: åŒæ­¥æˆ–å¼‚æ­¥çš„çº¯å‡½æ•°æ˜ å°„ã€‚

### 2.2 å¤–éƒ¨æ•°æ®æº (External Sources)
*   **å®šä¹‰**: æ•°æ®æ¥è‡ª Module å¤–éƒ¨ï¼ˆæœåŠ¡ç«¯ã€è®¾å¤‡ã€æµè§ˆå™¨ç¯å¢ƒï¼‰ã€‚
*   **API**: `Source.field(adapter)`
*   **å˜ä½“**:
    *   **Pull (Query)**: `Query.field(...)` -> HTTP/DB
    *   **Push (Stream)**: `Socket.field(...)` -> WebSocket/SSE
    *   **Sync (Storage)**: `Storage.field(...)` -> LocalStorage/IndexedDB
    *   **Environment**: `Env.field(...)` -> Window Size, Geolocation

### 2.3 å…³è”å…³ç³» (Relations / Links)
*   **å®šä¹‰**: æ•°æ®æ¥è‡ª *å¦ä¸€ä¸ª Module* çš„ Stateã€‚
*   **API**: `Link.to(TargetModule, selector)`
*   **æœ¬è´¨**: è·¨ Module çš„å“åº”å¼ä¾èµ–ï¼ˆForeign Key Resolutionï¼‰ã€‚

## 3. è®¾æƒ³ï¼šSchema DSL 2.0

```typescript
import { Schema } from 'effect'
import { Logix, Query, Link, Computed, Socket } from '@logix/core'

const UserState = Schema.Struct({
  // 1. åŸºç¡€å­—æ®µ (Raw Data)
  id: Schema.String,
  groupId: Schema.String,

  // 2. å¤–éƒ¨æ•°æ®æº (Pull - Query)
  // "æˆ‘æ˜¯ä» HTTP æ‹¿å›æ¥çš„ Profile"
  profile: Query.field({
    deps: (s) => [s.id],
    loader: ([id]) => api.getUser(id)
  }),

  // 3. å¤–éƒ¨æ•°æ®æº (Push - Socket)
  // "æˆ‘æ˜¯å®æ—¶æ›´æ–°çš„åœ¨çº¿çŠ¶æ€"
  status: Socket.field({
    topic: (s) => `user:${s.id}:status`,
    initial: 'offline'
  }),

  // 4. å…³è”å­—æ®µ (Relation - Link)
  // "æˆ‘çš„ Group ä¿¡æ¯æ¥è‡ª GroupModule"
  // è¿è¡Œæ—¶è‡ªåŠ¨è®¢é˜… GroupModule.state å¹¶åœ¨ groupId å˜åŒ–æ—¶æ›´æ–°
  group: Link.to(GroupModule, {
    key: (s) => s.groupId,
    // ç±»ä¼¼äº SQL Join æˆ– GraphQL Resolver
    resolve: (groupId, groupModuleState) => groupModuleState.groups[groupId]
  }),

  // 5. è®¡ç®—å­—æ®µ (Computed)
  // "æˆ‘æ˜¯åŸºäºä¸Šè¿°æ‰€æœ‰ä¿¡æ¯æ¨å¯¼å‡ºçš„å±•ç¤ºå"
  displayName: Computed.field({
    deps: (s) => [s.profile, s.group],
    derive: ([profile, group]) =>
      `${profile.name} @ ${group?.name || 'No Group'}`
  })
})

// 6. ç”šè‡³æ”¯æŒåŒå‘ç»‘å®š/æŒä¹…åŒ–
const SettingsState = Schema.Struct({
  theme: Storage.field({
    key: 'app-theme',
    default: 'dark'
  })
})
```

## 4. æ¶æ„æ·±æ„ (Architectural Implications)

### 4.1 "è™šå®åˆ†ç¦»" çš„æè‡´
*   **Schema (è™š)**: æè¿°äº†å®Œæ•´çš„ **Data Graph**ã€‚å®ƒæ˜¯ä¸€å¼ é™æ€çš„åœ°å›¾ã€‚
*   **Runtime (å®)**: `Module.live` å®ä¾‹åŒ–æ—¶ï¼Œæ ¹æ®åœ°å›¾ï¼š
    *   ä¸º `Query` å¯åŠ¨ Fetcher Fiberã€‚
    *   ä¸º `Socket` å»ºç«‹ Connectionã€‚
    *   ä¸º `Link` å»ºç«‹è·¨ Module è®¢é˜…ã€‚
    *   ä¸º `Computed` å»ºç«‹ Memoized Streamã€‚

### 4.2 ç»Ÿä¸€çš„ "Resource State" å®¹å™¨
æ‰€æœ‰ä¸Šè¿° "æ™ºèƒ½å­—æ®µ"ï¼Œåœ¨ State ä¸­æœ€ç»ˆéƒ½è½åœ°ä¸ºç»Ÿä¸€çš„å½¢çŠ¶ï¼ˆResource Stateï¼‰ï¼š

```typescript
type ResourceState<T> = {
  data: T | null
  loading: boolean
  error: Error | null
  updatedAt: number
  // ... å¯èƒ½è¿˜æœ‰ source metadata
}
```

è¿™æ · UI å±‚å¯ä»¥ç»Ÿä¸€å¤„ç† Loading/Errorï¼Œè€Œä¸ç”¨å…³å¿ƒæ•°æ®æ˜¯ HTTP æ¥çš„ï¼Œè¿˜æ˜¯ WebSocket æ¨é€çš„ï¼Œè¿˜æ˜¯ä»åˆ«çš„ Module ç®—å‡ºæ¥çš„ã€‚

### 4.3 å¯¹ "å…³è”å­—æ®µ" (Relations) çš„æ·±å…¥æ€è€ƒ
è¿™æ˜¯æœ€å¤æ‚ä¹Ÿæœ€è¿·äººçš„éƒ¨åˆ†ã€‚å¦‚æœ Logix èƒ½åƒ ORM ä¸€æ ·å¤„ç† Module é—´çš„å…³è”ï¼š

*   **One-to-One**: `Link.to(OtherModule)`
*   **One-to-Many**: `Link.hasMany(OtherModule)` ? (å¯èƒ½å¤ªå¤æ‚ï¼Œæš‚ä¸è€ƒè™‘)
*   **Lazy Loading**: å…³è”å­—æ®µæ˜¯å¦æ”¯æŒ Lazyï¼Ÿè®¿é—®æ—¶æ‰è®¢é˜…ï¼Ÿ

**æŒ‘æˆ˜**: å¾ªç¯ä¾èµ–ã€‚å¦‚æœ A Link Bï¼ŒB Link Aï¼Œåˆå§‹åŒ–é¡ºåºå¦‚ä½•ä¿è¯ï¼Ÿ
**è§£æ³•**:
1.  **Late Binding**: è¿è¡Œæ—¶è§£æ Linkï¼Œå…è®¸ `null` ä¸­é—´æ€ã€‚
2.  **Explicit Dependency**: åœ¨ `Logix.app` å±‚æ˜¾å¼å£°æ˜æ‹“æ‰‘é¡ºåºï¼ˆDAGï¼‰ã€‚

### 4.4 ä¸ç°æœ‰ Logix Links çš„å…³ç³» (The Evolution)

ç°æœ‰çš„ `Logix.Link` (åŸ Orchestrator) æ˜¯ **"å‘½ä»¤å¼èƒ¶æ°´å±‚"**ï¼Œè€Œ `Link.to` æ˜¯å…¶ **"å£°æ˜å¼æŠ•å½±"**ã€‚

| ç‰¹æ€§ | Logix.Link (Existing) | Schema Link (Proposed) |
| :--- | :--- | :--- |
| **å®šä½** | ç‹¬ç«‹çš„èƒ¶æ°´é€»è¾‘ (Imperative) | State å†…éƒ¨çš„å…³è”å®šä¹‰ (Declarative) |
| **å®šä¹‰ä½ç½®** | `Logix.app` æˆ–ç‹¬ç«‹æ–‡ä»¶ | `Module.state` Schema å†…éƒ¨ |
| **ä¾§é‡** | æµç¨‹ç¼–æ’ (Process Orchestration) | æ•°æ®ä¾èµ– (Data Dependency) |
| **è¿è¡Œæ—¶** | `Link(modules, logic)` | ç¼–è¯‘ä¸ºéšå¼çš„ `Link` æˆ– `Logic` |

**æ¼”è¿›è·¯çº¿**:
1.  **Layer 3 (Manual)**: æ‰‹å†™ `Logix.Link` æˆ–åœ¨ Logic ä¸­ä½¿ç”¨ `$.use(OtherModule)`ã€‚
2.  **Layer 1 (Schema)**: åœ¨ Schema ä¸­å®šä¹‰ `Link.to`ï¼Œè¿è¡Œæ—¶è‡ªåŠ¨ç”Ÿæˆç­‰ä»·çš„ Logicã€‚

è¿™æ„å‘³ç€ **Schema Link æœ¬è´¨ä¸Šå°±æ˜¯ `$.use` + `$.on` çš„è¯­æ³•ç³–**ã€‚

- `Logix.Link` é€‚åˆ **"ç¬¬ä¸‰æ–¹è§†è§’"** çš„ç¼–æ’ï¼ˆA å’Œ B éƒ½ä¸çŸ¥æƒ…ï¼‰ã€‚
- `$.use` é€‚åˆ **"ç¬¬ä¸€æ–¹è§†è§’"** çš„ä¾èµ–ï¼ˆA æ˜ç¡®ä¾èµ– Bï¼‰ã€‚
- `Link.to` æ˜¯ **"ç¬¬ä¸€æ–¹è§†è§’"** çš„å£°æ˜å¼å†™æ³•ã€‚


## 5. æ€»ç»“

ç”¨æˆ·çš„ "å‘æ•£" è¯·æ±‚æŒ‡å‘äº†ä¸€ä¸ªæ›´å®å¤§çš„å›¾æ™¯ï¼š**Logix ä¸ä»…ä»…æ˜¯çŠ¶æ€ç®¡ç†åº“ï¼Œå®ƒæ˜¯åº”ç”¨çš„æ•°æ®æ“ä½œç³»ç»Ÿ (Data OS)**ã€‚

*   **Schema** æ˜¯æ–‡ä»¶ç³»ç»Ÿè¡¨ (FAT)ã€‚
*   **Module** æ˜¯è¿›ç¨‹ã€‚
*   **Query/Socket/Link** æ˜¯ I/O é©±åŠ¨ã€‚

åœ¨è¿™ä¸ªæ„¿æ™¯ä¸‹ï¼ŒTanStack Query åªæ˜¯ä¼—å¤š "I/O é©±åŠ¨" ä¸­çš„ä¸€ä¸ªï¼ˆHTTP Driverï¼‰ã€‚æˆ‘ä»¬è®¾è®¡çš„ API åº”è¯¥è¶³å¤Ÿé€šç”¨ï¼Œèƒ½å®¹çº³è¿™äº›ä¸åŒçš„é©±åŠ¨ã€‚
</file>

<file path="drafts/topics/query-integration/07-schema-link-deep-dive.md">
---
title: "Schema Link: The Relational State Paradigm"
status: draft
version: 1.0
layer: Concept
value: extension
priority: later
related:
  - 06-unified-data-vision.md
---

# Schema Link: The Relational State Paradigm

> **æ ¸å¿ƒå®šä¹‰**: Schema Link (`Link.to`) æ˜¯ Logix ä¸­çš„ **"å£°æ˜å¼å¤–é”® (Declarative Foreign Key)"**ã€‚å®ƒå…è®¸ä½ åœ¨å®šä¹‰ State Schema æ—¶ï¼Œç›´æ¥å£°æ˜æŸä¸ªå­—æ®µ "å¼•ç”¨" è‡ªå¦ä¸€ä¸ª Module çš„æ•°æ®ã€‚

## 1. ä¸ºä»€ä¹ˆéœ€è¦ Schema Link?

åœ¨ä¼ ç»ŸçŠ¶æ€ç®¡ç†ï¼ˆå¦‚ Redux/Zustandï¼‰ä¸­ï¼Œå¤„ç† "å…³è”æ•°æ®" é€šå¸¸æœ‰ä¸¤ç§ç—›è‹¦æ¨¡å¼ï¼š

1.  **Denormalization (æ•°æ®å†—ä½™)**: æŠŠ User ä¿¡æ¯æ‹·è´ä¸€ä»½å­˜åˆ° Post Store é‡Œã€‚
    *   *ç—›ç‚¹*: æ•°æ®åŒæ­¥å›°éš¾ï¼ŒUser æ”¹åäº†ï¼ŒPost é‡Œçš„åå­—æ²¡å˜ã€‚
2.  **Selector Joining (è¿è¡Œæ—¶æ‹¼æ¥)**: åœ¨ç»„ä»¶å±‚ç”¨ `useSelector` åˆ†åˆ«å– User å’Œ Postï¼Œç„¶åæ‹¼åœ¨ä¸€èµ·ã€‚
    *   *ç—›ç‚¹*: é€»è¾‘æ³„éœ²åˆ° UI å±‚ï¼›å¦‚æœå…³è”é€»è¾‘å¤æ‚ï¼ˆæ¯”å¦‚çº§è”æŸ¥æ‰¾ï¼‰ï¼Œç»„ä»¶ä»£ç ä¼šå¾ˆè„ã€‚

**Schema Link çš„ç›®æ ‡**: åƒ SQL æˆ– GraphQL ä¸€æ ·ï¼Œ**åœ¨æ•°æ®å®šä¹‰å±‚è§£å†³å…³è”é—®é¢˜**ï¼ŒåŒæ—¶ä¿æŒåº•å±‚æ•°æ®çš„ Normalizedï¼ˆèŒƒå¼åŒ–ï¼‰ã€‚

## 2. API è®¾è®¡ (The Shape)

```typescript
import { Logix, Schema, Link } from '@logix/core'

const PostState = Schema.Struct({
  id: Schema.String,
  title: Schema.String,
  authorId: Schema.String, // å¤–é”® (Foreign Key)

  // ğŸŒŸ Schema Link: å£°æ˜å¼å…³è”
  author: Link.to(UserModule, {
    // 1. ä¾èµ–é”® (Dependency Key)
    // å½“ state.authorId å˜åŒ–ï¼Œæˆ– UserModule ä¸­å¯¹åº”æ•°æ®å˜åŒ–æ—¶ï¼Œé‡æ–°è®¡ç®—
    key: (post) => post.authorId,

    // 2. è§£æå™¨ (Resolver)
    // ç±»ä¼¼äº SQL çš„ JOIN æ¡ä»¶æˆ– GraphQL Resolver
    // å‚æ•°: (key, targetModuleState)
    resolve: (authorId, userState) => userState.users[authorId] ?? null
  })
})
```

### ç±»å‹æ¨å¯¼ (Type Inference)

TypeScript ä¼šè‡ªåŠ¨æ¨å¯¼ `author` å­—æ®µçš„ç±»å‹ï¼š
*   è¾“å…¥: `UserModule` çš„ State ç±»å‹ã€‚
*   è¾“å‡º: `resolve` å‡½æ•°çš„è¿”å›å€¼ç±»å‹ (ä¾‹å¦‚ `User | null`)ã€‚
*   ç»“æœ: `PostState.author` çš„ç±»å‹å°±æ˜¯ `User | null`ã€‚

## 3. è¿è¡Œæ—¶æœºåˆ¶ (The "Sugar" Revealed)

æ­£å¦‚ä¹‹å‰çš„æ–‡æ¡£æ‰€è¿°ï¼Œ`Link.to` æ˜¯ `$.use` + `$.on` çš„è¯­æ³•ç³–ã€‚

å½“ `Module.live` å¯åŠ¨æ—¶ï¼Œå®ƒä¼šæ‰«æ Schemaï¼Œå‘ç° `Link.to` å­—æ®µï¼Œç„¶å**è‡ªåŠ¨ç”Ÿæˆ**ä¸€æ®µéšå¼çš„ Logicã€‚

### ç¼–è¯‘å‰ (Schema):
```typescript
author: Link.to(UserModule, { key: s => s.authorId, resolve: ... })
```

### ç¼–è¯‘å (Implicit Logic):
```typescript
// ä¼ªä»£ç ï¼šè¿è¡Œæ—¶è‡ªåŠ¨ç”Ÿæˆçš„ Logic
Module.logic(($) => Effect.gen(function*() {
  // 1. è·å–ç›®æ ‡æ¨¡å—å¥æŸ„
  const $User = yield* $.use(UserModule)

  // 2. æ„é€ ç»„åˆæµ (Combined Stream)
  // ç›‘å¬ æœ¬åœ° authorId å˜åŒ– + è¿œç«¯ UserState å˜åŒ–
  const deps$ = Stream.combineLatest(
    $.state.changes(s => s.authorId),
    $User.changes(s => s), // æˆ–è€…æ›´ç»†ç²’åº¦çš„ selector
    (authorId, userState) => ({ authorId, userState })
  )

  // 3. å“åº”å˜åŒ–å¹¶æ›´æ–°æœ¬åœ°å­—æ®µ
  yield* $.on(deps$).runLatest(({ authorId, userState }) =>
    $.state.update(draft => {
      // æ‰§è¡Œ resolve é€»è¾‘
      draft.author = resolve(authorId, userState)
    })
  )
}))
```

**å…³é”®ç‰¹æ€§**:
*   **Reactive**: æ— è®ºæ˜¯ `authorId` å˜äº†ï¼Œè¿˜æ˜¯ `UserModule` é‡Œçš„æ•°æ®å˜äº†ï¼Œ`author` å­—æ®µéƒ½ä¼šè‡ªåŠ¨æ›´æ–°ã€‚
*   **Read-Only**: `author` å­—æ®µåœ¨æœ¬åœ°æ˜¯åªè¯»çš„ï¼ˆComputedï¼‰ï¼Œä½ ä¸èƒ½ç›´æ¥ `setAuthor(...)`ï¼Œåªèƒ½é€šè¿‡æ”¹ `authorId` æˆ–æ”¹ `UserModule` æ¥é©±åŠ¨å®ƒå˜åŒ–ã€‚

## 4. é«˜çº§æ¨¡å¼

### 4.1 åˆ—è¡¨å…³è” (One-to-Many / Many-to-Many)

```typescript
// GroupModule
members: Link.to(UserModule, {
  key: (group) => group.memberIds, // string[]
  resolve: (ids, userState) => ids.map(id => userState.users[id])
})
```

### 4.2 è·¨æ¨¡å—è®¡ç®— (Cross-Module Computed)

Link ä¸ä»…ä»…æ˜¯æŸ¥è¡¨ï¼Œè¿˜å¯ä»¥åšè®¡ç®—ï¼š

```typescript
// CartModule
totalPrice: Link.to(ProductModule, {
  key: (cart) => cart.items,
  resolve: (items, productState) => {
    return items.reduce((sum, item) => {
      const price = productState.products[item.productId]?.price ?? 0
      return sum + price * item.quantity
    }, 0)
  }
})
```

## 5. æ€»ç»“

Schema Link å®é™…ä¸ŠæŠŠ **"Derived Data" (æ´¾ç”Ÿæ•°æ®)** çš„æ¦‚å¿µä» **å•æ¨¡å—å†…éƒ¨** æ‰©å±•åˆ°äº† **è·¨æ¨¡å—**ã€‚

*   **Computed**: æ¨¡å—å†…æ´¾ç”Ÿ (State A -> State B)
*   **Link**: è·¨æ¨¡å—æ´¾ç”Ÿ (Module A + Module B -> Module A)

å®ƒè®© Logix çš„ State å˜æˆäº†ä¸€ä¸ª **è¿é€šå›¾ (Connected Graph)**ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸ªå­¤ç«‹çš„æ•°æ®å­¤å²›ã€‚
</file>

<file path="drafts/topics/query-integration/README.md">
---
title: Query Integration Â· æ¦‚è§ˆä¸è·¯çº¿å›¾
status: draft
version: 2025-11-30
value: extension
priority: next
---

# Query Integration Â· æ¦‚è§ˆä¸è·¯çº¿å›¾

## ä¸»é¢˜å®šä½

æœ¬ Topic æ”¶å½•æ‰€æœ‰å…³äº **"Logix + Query/å¼‚æ­¥æ•°æ®ç®¡ç†"** é›†æˆçš„è‰ç¨¿ï¼Œæ¶µç›–ï¼š

- TanStack Query é›†æˆç­–ç•¥
- Module å±‚ Query API è®¾è®¡ï¼ˆå£°æ˜å¼ Query Fieldã€æ˜¾å¼ Query Logicã€æ‰‹åŠ¨é›†æˆï¼‰
- Reactive Schema ä¸æ•°æ®èŒƒå¼
- Module Computed ä¸ Query çš„èåˆ

## å½“å‰è·¯çº¿å…±è¯†

### æ ¸å¿ƒè®¾è®¡æ–¹å‘

**ä¸‰å±‚æ¸è¿›å¼ API**ï¼ˆä»å£°æ˜å¼åˆ°æ‰‹åŠ¨ï¼‰ï¼š

1. **Layer 1: Declarative Query Field** (`Query.field`)
   - ç›®æ ‡ï¼š80% æ ‡å‡† GET åœºæ™¯
   - å½¢æ€ï¼šå°† Query å®šä¹‰å†…èšåœ¨ State Schema ä¸­
   - ç¤ºä¾‹ï¼š`profile: Query.field({ queryKey, queryFn, enabled })`

2. **Layer 2: Explicit Query Logic** (`createQueryLogic`)
   - ç›®æ ‡ï¼šè‡ªå®šä¹‰å‰¯ä½œç”¨ã€è·¨ Module ä¾èµ–ã€å¤æ‚è§¦å‘æ¡ä»¶
   - å½¢æ€ï¼šæ˜¾å¼ Logic å·¥å‚å‡½æ•°
   - ç¤ºä¾‹ï¼š`createQueryLogic(Module, { params, query, target, onSuccess })`

3. **Layer 3: Manual Integration**
   - ç›®æ ‡ï¼šå…œåº•æ–¹æ¡ˆï¼ˆInfinite Queryã€Suspenseã€æç«¯ç«æ€æ§åˆ¶ï¼‰
   - å½¢æ€ï¼šåœ¨ `Module.logic` ä¸­æ‰‹åŠ¨ç¼–æ’ `QueryClient`

### å…³é”®å†³ç­–

- **Module-Native**: Query ä¸æ˜¯å¤–æŒ‚ï¼Œè€Œæ˜¯ State çš„ä¸€éƒ¨åˆ†
- **Schema-Driven**: åˆ©ç”¨ Schema å…ƒæ•°æ®è‡ªåŠ¨ç”Ÿæˆæ ‡å‡† Logic
- **Progressive**: 80% åœºæ™¯ç”¨ Layer 1ï¼Œ20% å¤æ‚åœºæ™¯ä¸‹æ²‰åˆ° Layer 2/3

## Topic æ–‡æ¡£åˆ—è¡¨

- [01-unified-api-design.md](./01-unified-api-design.md) - ä¸‰å±‚ API è®¾è®¡ä¸æ¶æ„è¯„ä¼°
- [02-integration-strategies.md](./02-integration-strategies.md) - TanStack Query é›†æˆç­–ç•¥ï¼ˆé›¶å°è£… vs äºŒæ¬¡å°è£…ï¼‰
- [03-module-computed.md](./03-module-computed.md) - Module å±‚ Computed ä¸ Query çš„å®Œç¾å¦¥å
- [04-reactive-paradigm.md](./04-reactive-paradigm.md) - Reactive Schema ä¸ç»Ÿä¸€æ•°æ®èŒƒå¼

## å¾…å†³é—®é¢˜

- [ ] Layer 1 (`Query.field`) çš„ TypeScript é€’å½’ç±»å‹æ¨å¯¼å¦‚ä½•è§£å†³ï¼Ÿ
- [ ] æ˜¯å¦åœ¨ `Module.live` é˜¶æ®µè‡ªåŠ¨æ‰«æ Schema å¹¶æ³¨å…¥ Query Logicï¼Ÿ
- [ ] Mutation / Infinite Query çš„è®¾è®¡æ–¹æ¡ˆ
- [ ] ä¸ Reactive Module çš„èåˆè·¯å¾„

## åç»­å·¥ä½œ

1. **çŸ­æœŸï¼ˆv3.xï¼‰**: å®ç° Layer 3ï¼ˆæ‰‹åŠ¨é›†æˆï¼‰æ‰“é€šåº•å±‚
2. **ä¸­æœŸï¼ˆv3.x+ï¼‰**: å®ç° `createQueryLogic`ï¼ˆLayer 2ï¼‰è¦†ç›–å¤§éƒ¨åˆ†åœºæ™¯
3. **é•¿æœŸï¼ˆv4.0ï¼‰**: æ”»å…‹ TypeScript ç±»å‹éš¾ç‚¹ï¼Œå®ç° `Query.field`ï¼ˆLayer 1ï¼‰

---

æœ€åæ›´æ–°ï¼š2025-12-02
</file>

<file path="drafts/topics/react-adapter/01-hooks-api.md">
# é€šç”¨ Hooks API (Hooks API Specification)

> **Status**: Draft (Aligned with v3)
> **Layer**: React Adapter
> **Audience**: React ä¸šåŠ¡å¼€å‘è€…ï¼ˆåªéœ€å…³å¿ƒé«˜å±‚ Hooks ç”¨æ³•ï¼‰ä¸ Adapter ä½œè€…ï¼ˆéœ€è¦å…³å¿ƒå®Œæ•´ç±»å‹ä¸å®ç°çº¦æŸï¼‰ã€‚

æœ¬æ–‡æ¡£å®šä¹‰ç”¨äºè¿æ¥ Logix ä¸ React çš„é€šç”¨ Hooksã€‚
ç±»å‹ç¤ºä¾‹ä»¥ `docs/specs/intent-driven-ai-coding/v3/effect-poc/shared/logix-v3-core.ts` ä¸­çš„ `Logix.Module` / `ModuleRuntime` ç­‰ä¸ºåŸºå‡†ã€‚

## 0. è§’è‰²è§†è§’é€Ÿè§ˆ

| è§’è‰² | ä¸»è¦å…³æ³¨ç‚¹ | æ¨èé˜…è¯»æ®µè½ |
| :--- | :--- | :--- |
| React ä¸šåŠ¡å¼€å‘è€… | ä¼šç”¨å³å¯ï¼šå¦‚ä½•æ‹¿åˆ°æ¨¡å—å®ä¾‹ã€è®¢é˜…çŠ¶æ€ã€å‘äº‹ä»¶ | 1ï¼ˆ`useModule` / `useLocalModule`ï¼‰ã€2ï¼ˆ`useSelector`ï¼‰ã€3ï¼ˆ`useDispatch`ï¼‰ |
| Adapter ä½œè€… / æ¶æ„å¸ˆ | å¦‚ä½•å®ç°è¿™äº› Hooksã€å¦‚ä½•å¯¹æ¥ Runtime/Scope | å…¨æ–‡ï¼Œå°¤å…¶æ˜¯æ¯èŠ‚çš„â€œå®ç°è§„èŒƒâ€å’Œç±»å‹ç­¾å |

ä¸šåŠ¡å¼€å‘è€…å¯ä»¥æŠŠæœ¬ç¯‡å½“æˆâ€œæ€ä¹ˆç”¨ Hooksâ€ï¼›Adapter ä½œè€…éœ€è¦é¢å¤–éµå®ˆè¿™é‡Œçš„çº¦æŸæ¥å®ç°åº“ã€‚

## 1. `useModule` / `useLocalModule` (Lifecycle & Access)

ç”¨äºåœ¨ç»„ä»¶å†…éƒ¨**åˆ›å»ºæˆ–è·å–é¢†åŸŸæ¨¡å—çš„è¿è¡Œæ—¶å®ä¾‹**ï¼Œå¹¶ç®¡ç†å…¶ç”Ÿå‘½å‘¨æœŸï¼Œå¯¹åº”ä¸¤ç±»å…¸å‹æ¨¡å¼ï¼š

| åœºæ™¯æ¨¡å¼ | ä½œç”¨åŸŸ (Scope) | æ¥æº (Source) | `useModule` ä¼ ä»€ä¹ˆï¼Ÿ | å¿ƒæ™ºæ¨¡å‹ (Mental Model) |
| :--- | :--- | :--- | :--- | :--- |
| **å…¨å±€æ¨¡å¼** (Global) | **åº”ç”¨çº§å¸¸é©»** (App-wide singleton) | å®šä¹‰åœ¨ `Logix.app` è“å›¾ä¸­ï¼Œç”±æ ¹ Provider æä¾› | **ä¼  Tag** (Module Definition) | **â€œæŸ¥æ‰¾ (Lookup)â€**<br>å‘ç¯å¢ƒè¯¢é—®ï¼šâ€œè°è´Ÿè´£è¿™ä¸ª Moduleï¼Ÿç»™æˆ‘å®ƒçš„ Runtimeã€‚â€ |
| **å±€éƒ¨æ¨¡å¼** (Local) | **ç»„ä»¶çº§ä¸´æ—¶** (Component transient) | åœ¨å½“å‰ç»„ä»¶ï¼ˆæˆ–çˆ¶ç»„ä»¶ï¼‰ä¸­ä½¿ç”¨ `useLocalModule` åˆ›å»º | **ä¼  Factory** (Logic Factory) | **â€œæŒæœ‰ (Holding)â€**<br>ç›´æ¥æ“ä½œæ‰‹é‡Œæ‹¿ç€çš„è¿™ä¸ªå…·ä½“çš„ Module Runtime å¯¹è±¡ã€‚ |

åœ¨ React Adapter ä¸­ï¼Œ`useModule` æ¨èä»¥ç»Ÿä¸€çš„å¥æŸ„ç±»å‹ï¼ˆå¦‚ `Logix.ModuleInstance`ï¼‰ä½œä¸ºå‚æ•°ï¼Œåº•å±‚æ ¹æ®å®é™…å½¢æ€ï¼ˆTag / è¿è¡Œæ—¶å®ä¾‹ï¼‰å†³å®šæ˜¯â€œæŸ¥æ‰¾ç¯å¢ƒâ€è¿˜æ˜¯â€œç›´æ¥ä½¿ç”¨å®ä¾‹â€ã€‚

å¯¹åº”çš„ Hooks ç±»å‹ç­¾åå»ºè®®å¦‚ä¸‹ï¼ˆæ¦‚å¿µæ€§ï¼Œä»¥ Logix v3 Core ç±»å‹ä¸ºå‚è€ƒï¼‰ï¼š

```typescript
// åœºæ™¯ A: ç»„ä»¶çº§æ¨¡å—å®ä¾‹ (Local State)
// è‡ªåŠ¨ç®¡ç† Scopeï¼šç»„ä»¶æŒ‚è½½æ—¶åˆ›å»ºï¼Œå¸è½½æ—¶é”€æ¯
function useLocalModule<Sh extends Logix.ModuleShape<any, any>>(
  factory: () => Effect.Effect<ModuleRuntime<Store.StateOf<Sh>, Store.ActionOf<Sh>>>
): ModuleRuntime<Store.StateOf<Sh>, Store.ActionOf<Sh>>;

// åœºæ™¯ B: å…¨å±€/å…±äº« Module (Global State)
// ä»…è·å–å®ä¾‹ï¼Œä¸ç®¡ç†ç”Ÿå‘½å‘¨æœŸ â€”â€” é€šè¿‡ Handle ä» AppRuntime ä¸­æŸ¥æ‰¾æˆ–ç›´æ¥ä½¿ç”¨å®ä¾‹
function useModule<Sh extends Logix.ModuleShape<any, any>>(
  handle: Logix.ModuleInstance<any, Sh>
): ModuleRuntime<Store.StateOf<Sh>, Store.ActionOf<Sh>>;
```

## 2. `useSelector` (Fine-Grained Subscription)

è¿™æ˜¯æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒã€‚ç»„ä»¶ä¸åº”è¯¥è®¢é˜…æ•´ä¸ª Module Stateï¼Œè€Œåº”è¯¥è®¢é˜…å®ƒå…³å¿ƒçš„åˆ‡ç‰‡ã€‚

```typescript
function useSelector<S, T>(
  runtime: ModuleRuntime<S, any>,
  selector: (state: S) => T,
  equalityFn?: (a: T, b: T) => boolean
): T;
```

**å®ç°è§„èŒƒ**:
*   å¿…é¡»åŸºäº `useSyncExternalStore` å®ç°ã€‚
*   æ”¯æŒ `proxy-memoize` è‡ªåŠ¨è¿½è¸ªä¾èµ–ï¼ˆå¯é€‰ç‰¹æ€§ï¼‰ï¼Œå®ç°ç±»ä¼¼ Vue/MobX çš„è‡ªåŠ¨è®¢é˜…ä½“éªŒã€‚

## 3. `useDispatch` (Event Trigger)

æä¾›ä¸€ä¸ªç¨³å®šçš„ dispatch å‡½æ•°ï¼Œç”¨äºè§¦å‘ Logix Actionã€‚

```typescript
function useDispatch<E>(runtime: ModuleRuntime<any, E>): (action: E) => void;
```

**æ³¨æ„**: è¿”å›çš„ dispatch å‡½æ•°å¿…é¡»æ˜¯ **Reference Stable** çš„ï¼ˆå³åœ¨ç»„ä»¶é‡æ¸²æŸ“æœŸé—´ä¿æŒä¸å˜ï¼‰ï¼Œä»¥ä¾¿å¯ä»¥å®‰å…¨åœ°ä¼ é€’ç»™å­ç»„ä»¶è€Œä¸ç ´å `memo`ã€‚

## 4. `useEventCallback` (Effect Bridge)

æœ‰æ—¶æˆ‘ä»¬éœ€è¦åœ¨ React äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ç›´æ¥è°ƒç”¨ Logix çš„ Effect é€»è¾‘ï¼Œå¹¶ç­‰å¾…å…¶ç»“æœï¼ˆä¾‹å¦‚ï¼šç‚¹å‡»æŒ‰é’® -> è°ƒç”¨ API -> ç­‰å¾…å®Œæˆ -> è·³è½¬é¡µé¢ï¼‰ã€‚

è™½ç„¶ Logix æ¨è Event-Drivenï¼Œä½†ä¸ºäº†å®ç”¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª Escape Hatchã€‚

```typescript
function useEffectCallback<Args extends any[], R>(
  runtime: ModuleRuntime<any, any>,
  effectFn: (...args: Args) => Effect.Effect<R, any, any>
): (...args: Args) => Promise<R>;
```

*   **åŠŸèƒ½**: å°†ä¸€ä¸ª Effect åŒ…è£…æˆä¸€ä¸ªè¿”å› Promise çš„æ™®é€šå‡½æ•°ã€‚
*   **Runtime**: è‡ªåŠ¨ä½¿ç”¨ Module å…³è”çš„ Runtime æ‰§è¡Œ Effectã€‚
</file>

<file path="drafts/topics/react-adapter/02-context-injection.md">
# ä¾èµ–æ³¨å…¥ä¸ Context (Dependency Injection)

> **Status**: Draft (Aligned with v3)
> **Layer**: React Adapter

æœ¬æ–‡æ¡£è¯¦ç»†é˜è¿°å¦‚ä½•åœ¨ React ç»„ä»¶æ ‘ä¸­ä¼˜é›…åœ°æ³¨å…¥ Logix æ‰€éœ€çš„ä¾èµ–ï¼ˆServicesï¼‰ã€‚æˆ‘ä»¬é‡‡ç”¨ **"Implicit Context + Runtime Guard"** æ¨¡å¼ï¼Œåœ¨ä¿æŒ API ç®€æ´çš„åŒæ—¶æä¾›å¼ºå¤§çš„è¿è¡Œæ—¶ä¿éšœã€‚

## 1. æ ¸å¿ƒæ¨¡å¼ï¼šéšå¼ä¸Šä¸‹æ–‡ (Implicit Context)

ä¸ºäº†é¿å…åœ¨æ¯ä¸ª `useModule` è°ƒç”¨ä¸­é‡å¤ä¼ é€’ Layerï¼Œæˆ‘ä»¬åˆ©ç”¨ React Context åœ¨ç»„ä»¶æ ‘ä¸Šå±‚ç»Ÿä¸€æ³¨å…¥ Runtimeã€‚

### 1.1 `RuntimeProvider`

è¿™æ˜¯ä¾èµ–æ³¨å…¥çš„å…¥å£ã€‚å®ƒæ¥å—ä¸€ä¸ª Effect Layerï¼Œå¹¶å°†å…¶æ„å»ºä¸º Runtime ä¸‹å‘ç»™å­ç»„ä»¶ã€‚

```tsx
// App.tsx
import { RuntimeProvider } from '@logix/react';
import { AppLayer } from './layers';

function App() {
  return (
    // åœ¨è¿™é‡Œä¸€æ¬¡æ€§æ³¨å…¥æ‰€æœ‰æœåŠ¡ (API, Router, Config)
    <RuntimeProvider layer={AppLayer}>
      <Page />
    </RuntimeProvider>
  );
}
```

### 1.2 `useModule` çš„è‡ªåŠ¨æ¨å¯¼

å­ç»„ä»¶ä¸­çš„ `useModule` ä¼šè‡ªåŠ¨ä»æœ€è¿‘çš„ `RuntimeProvider` è·å–è¿è¡Œæ—¶ç¯å¢ƒã€‚

> **Performance Note**: `RuntimeProvider` å†…éƒ¨ä½¿ç”¨ React Context ä¼ é€’ `Layer`ã€‚è™½ç„¶ Context åµŒå¥—æœ¬èº«å¼€é”€å¾ˆå°ï¼Œä½†é¢‘ç¹å˜æ›´ Context Value ä¼šå¯¼è‡´å­æ ‘é‡æ¸²æŸ“ã€‚Logix ä¿è¯ `layer` å¼•ç”¨ç¨³å®šï¼Œä»…åœ¨ä¾èµ–é…ç½®å˜æ›´æ—¶æ›´æ–°ã€‚

```tsx
// Page.tsx
function Page() {
  // âœ… ä¸éœ€è¦ä¼  Layerï¼Œè‡ªåŠ¨è·å–
  // å¦‚æœ UserModule ä¾èµ–äº† ApiServiceï¼Œå®ƒä¼šä» Context ä¸­æŸ¥æ‰¾
  const runtime = useModule(UserModule);

  return <div>...</div>;
}
```

## 2. è¿è¡Œæ—¶å®‰å…¨ (Runtime Safety)

ç”±äº TypeScript æ— æ³•é™æ€åˆ†æ React Context çš„å†…å®¹ï¼Œæˆ‘ä»¬æ— æ³•åœ¨ç¼–è¯‘æœŸä¿è¯ Service ä¸€å®šå­˜åœ¨ã€‚å› æ­¤ï¼ŒLogix å®ç°äº†ä¸¥æ ¼çš„ **Runtime Guard**ã€‚

### 2.1 é”™è¯¯å¤„ç†
å¦‚æœ `UserModule` éœ€è¦ `ApiService`ï¼Œä½†ä¸Šå±‚ Provider æœªæä¾›ï¼Œ`useModule` ä¼šæ•è· Effect çš„æ‰§è¡Œå¤±è´¥ï¼Œå¹¶æŠ›å‡ºå‹å¥½çš„é”™è¯¯ï¼š

> **[Logix Error] Service Not Found**
> Your module requires `ApiService`, but it was not provided in the context.
> **Fix**: Please wrap your component tree with `<RuntimeProvider layer={Layer.succeed(ApiService, ...)}>`.

### 2.2 æœ€ä½³å®è·µ
*   **Global Services**: (å¦‚ API, Router, I18n) æ¨èåœ¨ App æ ¹èŠ‚ç‚¹é€šè¿‡ `RuntimeProvider` æ³¨å…¥ã€‚
*   **Local Services**: (å¦‚ ModalConfig, TabContext) æ¨èåœ¨æ¨¡å—æ ¹èŠ‚ç‚¹æ³¨å…¥ï¼Œå®ç°å±€éƒ¨è¦†ç›–ã€‚

### 2.3 `ModuleProvider` å¿«æ·å°è£…

åœ¨éƒ¨åˆ†åº”ç”¨ä¸­ï¼Œä¸å¸Œæœ›ä¸ºæ¯ç±» Module éƒ½å•ç‹¬å£°æ˜ä¸€ä¸ª Contextï¼Œå¯ä»¥åœ¨ Adapter å±‚æä¾›ä¸€ä¸ªé€šç”¨çš„ `ModuleProvider` / `useModuleContext` å°è£…ï¼Œå†…éƒ¨ä¾ç„¶åŸºäº `createModuleContext` å®ç°ï¼š

```tsx
<ModuleProvider module={myModuleRuntime}>
  <UserProfile />
</ModuleProvider>

// å­ç»„ä»¶
const runtime = useModuleContext();
```

è¿™ç§æ¨¡å¼é€‚åˆç®€å•åœºæ™¯æˆ– Demoï¼›åœ¨ä¸­å¤§å‹é¡¹ç›®ä¸­ï¼Œä»æ¨èä¸ºæ¯ä¸ªé¢†åŸŸ Module æ˜¾å¼åˆ›å»ºç‹¬ç«‹çš„ Contextï¼Œä»¥è·å¾—æ›´æ¸…æ™°çš„è¾¹ç•Œä¸ç±»å‹ä¿¡æ¯ã€‚

## 3. `createModuleContext` (Module ä¼ é€’)

é™¤äº†æ³¨å…¥ Servicesï¼Œæœ‰æ—¶æˆ‘ä»¬éœ€è¦å°† **Module Runtime å®ä¾‹æœ¬èº«** æ³¨å…¥åˆ°æ·±å±‚ç»„ä»¶ï¼ˆé¿å… Prop Drillingï¼‰ã€‚

```typescript
// 1. å®šä¹‰ Context
const MyModuleContext = createModuleContext<MyState, MyEvent>();

// 2. æ³¨å…¥ Runtime
<MyModuleContext.Provider value={runtime}>
  <DeepComponent />
</MyModuleContext.Provider>

// 3. æ¶ˆè´¹ Runtime
const runtime = MyModuleContext.useModule();
const value = MyModuleContext.useSelector(s => s.value);
```

## 4. åµŒå¥— Module ä¸è·¨å±‚é€šä¿¡

æ”¯æŒ Module çš„å±‚çº§åµŒå¥—ã€‚å­ Module å¯ä»¥é€šè¿‡ Effect Context è®¿é—®çˆ¶ Module æä¾›çš„ Servicesï¼Œæˆ–è€…ç›´æ¥è®¿é—®çˆ¶ Module å®ä¾‹ï¼ˆå¦‚æœçˆ¶ Module å°†è‡ªå·±ä½œä¸º Service æš´éœ²ï¼‰ã€‚

```tsx
<ParentModuleProvider>
  <ChildModuleProvider>
    <ChildComponent />
  </ChildModuleProvider>
</ParentModuleProvider>
```

åœ¨ Child Module çš„ Logic ä¸­ï¼š
```typescript
// é€šè¿‡ Effect Context è·å–çˆ¶çº§æœåŠ¡
const parentService = yield* ParentService;
```

## 5. é”™è¯¯æµä¸ Error Boundary é›†æˆ

Logix æš´éœ²çš„ `error$` æµå¯ä»¥ä¸ React Error Boundary é›†æˆã€‚React Adapter æ¨èæä¾›ä¸€ä¸ªç±»ä¼¼ `useErrorStream` çš„ Hookï¼Œå°†è‡´å‘½é”™è¯¯æ¡¥æ¥åˆ° UIï¼š

```tsx
useErrorStream(runtime, (error) => {
  // å½“ Logix æŠ›å‡ºè‡´å‘½é”™è¯¯æ—¶ï¼Œè§¦å‘ Error Boundary æˆ–å…¨å±€æç¤º
  showBoundary(error);
});
```

åœ¨å®ç°ä¸Šï¼Œ`useErrorStream` è®¢é˜… Runtime çš„ `error$`ï¼Œå¹¶åœ¨ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨å–æ¶ˆè®¢é˜…ï¼›è°ƒç”¨æ–¹åªè´Ÿè´£å†³å®šå¦‚ä½•å±•ç¤ºé”™è¯¯ï¼ˆError Boundaryã€Toastã€å…¨å±€æ—¥å¿—ä¸ŠæŠ¥ç­‰ï¼‰ã€‚
</file>

<file path="drafts/topics/react-adapter/03-concurrent-rendering.md">
# å¹¶å‘æ¸²æŸ“æ”¯æŒ (Concurrent Rendering)

> **Status**: Draft
> **Layer**: React Adapter

React 18+ å¼•å…¥äº†å¹¶å‘æ¸²æŸ“ç‰¹æ€§ (Concurrent Features)ï¼Œè¿™å¯¹å¤–éƒ¨çŠ¶æ€åº“æå‡ºäº†æ–°çš„æŒ‘æˆ˜ã€‚æœ¬å±‚å¿…é¡»ç¡®ä¿ Logix ä¸ React çš„å¹¶å‘æœºåˆ¶å’Œè°å…±å­˜ã€‚

## 1. Tearing Prevention (é˜²æ­¢æ’•è£‚)

åœ¨å¹¶å‘æ¸²æŸ“ä¸­ï¼ŒReact å¯èƒ½ä¼šåœ¨ä¸€æ¬¡æ¸²æŸ“è¿‡ç¨‹ä¸­å¤šæ¬¡æš‚åœå’Œæ¢å¤ã€‚å¦‚æœå¤–éƒ¨ Store çš„çŠ¶æ€åœ¨æ­¤æœŸé—´å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç»„ä»¶æ ‘çš„ä¸åŒéƒ¨åˆ†æ¸²æŸ“å‡ºä¸ä¸€è‡´çš„æ•°æ®ï¼ˆTearingï¼‰ã€‚

**è§£å†³æ–¹æ¡ˆ**: ä¸¥æ ¼ä½¿ç”¨ `useSyncExternalStore`ã€‚

*   å®ƒä¼šåœ¨æ¸²æŸ“æœŸé—´å¼ºåˆ¶ React åŒæ­¥è¯»å–å¤–éƒ¨ Storeã€‚
*   å¦‚æœåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­ Store å‘ç”Ÿå˜åŒ–ï¼ŒReact ä¼šä¸¢å¼ƒå½“å‰çš„æ¸²æŸ“æ ‘å¹¶é‡æ–°å¼€å§‹ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚

## 2. Transition Support (è¿‡æ¸¡æ”¯æŒ)

æœ‰æ—¶æˆ‘ä»¬å¸Œæœ› Logix çš„çŠ¶æ€æ›´æ–°è¢«è§†ä¸ºâ€œä½ä¼˜å…ˆçº§â€çš„ï¼ˆä¾‹å¦‚ï¼šæœç´¢æ¡†è¾“å…¥å¯¼è‡´çš„å¤§åˆ—è¡¨è¿‡æ»¤ï¼‰ï¼Œä»¥å…é˜»å¡ç”¨æˆ·è¾“å…¥ã€‚

**API**: `useTransitionDispatch`

```typescript
const [isPending, startTransition] = useTransition();
const dispatch = useDispatch(store);

const handleSearch = (e) => {
  // å°† Logix çš„æ›´æ–°æ ‡è®°ä¸º Transition
  startTransition(() => {
    dispatch({ type: 'SEARCH', query: e.target.value });
  });
};
```

**æ³¨æ„**: è¿™éœ€è¦ Logix çš„ `set` æ“ä½œèƒ½å¤Ÿé…åˆ React çš„æ‰¹å¤„ç†æœºåˆ¶ã€‚ç›®å‰çš„ Logix å®ç°æ˜¯åŒæ­¥é€šçŸ¥çš„ï¼Œè¿™é€šå¸¸å…¼å®¹ React çš„è‡ªåŠ¨æ‰¹å¤„ç†ã€‚ä½†åœ¨ `startTransition` ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ Logix çš„é€šçŸ¥å›è°ƒæ˜¯åœ¨ React çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œçš„ã€‚

## 3. Suspense Integration (Phase 2 / Experimental)

æ”¯æŒ `useSuspenseSelector`ï¼Œå…è®¸ç»„ä»¶åœ¨ Logix æ•°æ®å°šæœªå°±ç»ªï¼ˆå¦‚å¼‚æ­¥åŠ è½½ä¸­ï¼‰æ—¶æŒ‚èµ·ã€‚

> **Strategy**:
> 1.  **Selector-based**: `useSuspenseSelector(store, selector)`ã€‚Selector ä¿æŒåŒæ­¥ï¼Œç”± Adapter åˆ¤æ–­å½“å‰ Store çŠ¶æ€ï¼ˆPending/Errorï¼‰å†³å®šæ˜¯å¦æŠ›å‡º Promise æˆ– Errorã€‚
> 2.  **Resource Cache**: Adapter å†…éƒ¨ç»´æŠ¤ Suspense Resource Cacheï¼Œç¡®ä¿ Promise ç”Ÿå‘½å‘¨æœŸä¸ React è¦æ±‚å¯¹é½ã€‚

```typescript
// è¿™æ˜¯ä¸€ä¸ª Effectï¼Œå¯èƒ½ä¼šæŒ‚èµ·
const data = useSuspenseSelector(store, (state) => {
  // å¦‚æœ state.status === 'pending'ï¼ŒHook å†…éƒ¨ä¼šè‡ªåŠ¨ throw Promise
  return state.data;
});
```

è¿™éœ€è¦ Logix æ”¯æŒ **"Promise-based State Access"**ï¼Œç›®å‰æš‚åˆ—ä¸º Phase 2 ç‰¹æ€§ã€‚
</file>

<file path="drafts/topics/react-adapter/index.md">
---
title: Logix React Adapter Specs
status: draft
version: 2025-11-28
---

# Logix React Adapter Specs (L3 Draft)

æœ¬ç›®å½•åŒ…å« Logix React Adapter çš„è¯¦ç»†è®¾è®¡è‰æ¡ˆã€‚è¿™äº›æ–‡æ¡£åŸè®¡åˆ’ä½äº `docs/specs/runtime-logix/react`ï¼Œç°æ ¹æ® Drafts Tiered System è¿ç§»è‡³æ­¤è¿›è¡Œå­µåŒ–ã€‚

## ç›®å½•ç´¢å¼•

- **[01-hooks-api.md](./01-hooks-api.md)**: æ ¸å¿ƒ Hooks å®šä¹‰ (`useModule`, `useSelector`)ã€‚
- **[02-context-injection.md](./02-context-injection.md)**: ä¾èµ–æ³¨å…¥ä¸ `RuntimeProvider` è®¾è®¡ã€‚
- **[03-concurrent-rendering.md](./03-concurrent-rendering.md)**: å¹¶å‘æ¸²æŸ“ä¸é˜²æ’•è£‚ (Tearing) ç­–ç•¥ã€‚
- **[04-ssr-and-testing.md](./04-ssr-and-testing.md)**: SSR Hydration ä¸ Mock æµ‹è¯•ç­–ç•¥ã€‚
- **[README.md](./README.md)**: åŸå§‹æ¦‚è¿°æ–‡æ¡£ã€‚
</file>

<file path="drafts/topics/react-adapter/README.md">
---
title: React Adapter Specification
status: draft
version: 2025-11-21
layer: Integration Layer
value: core
priority: next
---

# React Adapter Specification

> **Status**: Draftï¼ˆéƒ¨åˆ†å†…å®¹å·²è½åœ°åˆ° @logix/react ä¸ runtime-logix/reactï¼‰
> **Date**: 2025-11-21
> **Layer**: Integration Layer

æœ¬æ–‡æ¡£å®šä¹‰ Logix çš„é€šç”¨ React é€‚é…å±‚ã€‚è¿™ä¸€å±‚çš„ç›®æ ‡æ˜¯æä¾›ä¸€ç»„åº•å±‚çš„ã€é«˜æ€§èƒ½çš„ Hooks å’Œç»„ä»¶ï¼Œç”¨äºå°† Logix çš„çŠ¶æ€æœºæ— ç¼æ¥å…¥ React ç»„ä»¶æ ‘ã€‚å®ƒä¸åŒ…å«ä»»ä½•ç‰¹å®šä¸šåŠ¡é¢†åŸŸï¼ˆå¦‚è¡¨å•ï¼‰çš„é€»è¾‘ï¼Œè€Œæ˜¯ä¸“æ³¨äº **State Synchronization** å’Œ **Event Dispatching**ã€‚

## 1. æ ¸å¿ƒå®šä½ (Positioning)

å¦‚æœ Logix æ˜¯ Reduxï¼Œé‚£ä¹ˆæœ¬å±‚å°±æ˜¯ `react-redux`ã€‚
å¦‚æœ Logix æ˜¯ MobXï¼Œé‚£ä¹ˆæœ¬å±‚å°±æ˜¯ `mobx-react`ã€‚

å®ƒçš„æ ¸å¿ƒèŒè´£æ˜¯ï¼š
1.  **Lifecycle Management**: ç®¡ç† Logix Store åœ¨ React ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå†…çš„åˆ›å»ºä¸é”€æ¯ (Scope Handling)ã€‚
2.  **Subscription**: åˆ©ç”¨ `useSyncExternalStore` å®ç°å¯¹ Logix State çš„é«˜æ•ˆè®¢é˜…ã€‚
3.  **Bridge**: å°† React çš„äº¤äº’äº‹ä»¶ (Click, Change) æ¡¥æ¥åˆ° Logix çš„ Event Hubã€‚

## 2. è®¾è®¡åŸåˆ™ (Design Principles)

*   **Tearing Free**: å¿…é¡»ä½¿ç”¨ `useSyncExternalStore` ä¿è¯å¹¶å‘æ¸²æŸ“ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚
*   **Selector First**: é»˜è®¤é¼“åŠ±ä½¿ç”¨ Selector è¿›è¡Œç»†ç²’åº¦è®¢é˜…ï¼Œé¿å…å…¨é‡é‡æ¸²æŸ“ã€‚
*   **Suspense Compatible**: æ”¯æŒä¸ React Suspense é›†æˆï¼ˆæœªæ¥è§„åˆ’ï¼‰ã€‚
*   **UI-Intent Agnostic**: ä¸ç›´æ¥æ‰¿è½½ UI Intent / ç»„ä»¶æ ‘ç»“æ„ï¼Œä»…æä¾› Store / Event çº§æ¡¥æ¥èƒ½åŠ›ï¼Œç”±ä¸Šå±‚ UI Intent / Studio ä½¿ç”¨è¿™äº›é”šç‚¹åšå›¾ç åŒæ­¥ã€‚

## 3. æ¨¡å—ç´¢å¼•

*   [01-hooks-api.md](./01-hooks-api.md): æ ¸å¿ƒ Hooks (`useModule`, `useSelector`)ã€‚
*   [02-context-injection.md](./02-context-injection.md): ä¾èµ–æ³¨å…¥ä¸ `RuntimeProvider`ã€‚

## æ ¸å¿ƒåŸåˆ™

1.  **Implicit Context**: é¿å… Prop Drillingï¼Œé€šè¿‡ Context éšå¼ä¼ é€’ Runtimeã€‚
2.  **Runtime Guard**: è¿è¡Œæ—¶æ£€æŸ¥ä¾èµ–å®Œæ•´æ€§ï¼Œæä¾›å‹å¥½æŠ¥é”™ã€‚
3.  **Read/Write Segregation**:
    *   è¯»ï¼šä½¿ç”¨ `useModule` / `useSelector` å°† Module State æ˜ å°„ä¸ºè§†å›¾æ•°æ®ï¼›
    *   å†™ï¼šä½¿ç”¨ `useDispatch` è·å– dispatch å‡½æ•°è§¦å‘ Actionã€‚

> ä¸Šå±‚å…³ç³»ï¼šUI Intent / Studio ä¸»è¦é€šè¿‡ä¸¤ä¸ªç»´åº¦æ¶ˆè´¹ React Adapterï¼š
> - è¯»ï¼šä½¿ç”¨ `useModule` / `useSelector` å°† Store.State æ˜ å°„ä¸ºè§†å›¾æ•°æ®ï¼›
> - å†™ï¼šé€šè¿‡ç»‘å®šåˆ° `$.actions.dispatch` / IntentRule Anchor çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå°† UI äº‹ä»¶æŠ•é€’ç»™ Logixã€‚
> React Adapter è‡ªèº«ä¿æŒä¸æ„ŸçŸ¥å…·ä½“ UI Schema æˆ–ç»„ä»¶åº“ï¼Œåªæš´éœ²è¿™äº›ç¨³å®šé”šç‚¹ã€‚
</file>

<file path="drafts/topics/spec-studio/00-design.md">
---
title: Spec Studio Design (SPEC Integration)
status: Ready for Review
version: 2
value: vision
priority: later
---

# Spec Studio: L0 æ„å›¾å…¥å£ (The L0 Intent Interface)

> **Status**: Ready for Review (Topic Draft)
> **Focus**: å®šä¹‰å¹³å°çš„ **L0 (Spec)** å±‚ã€‚è¿™æ˜¯å°†â€œæ¨¡ç³Šæ„å›¾â€è½¬åŒ–ä¸ºâ€œæ¸…æ™°éœ€æ±‚â€çš„å…¥å£ã€‚

## 1. æ ¸å¿ƒç†å¿µï¼šSPEC

å¹³å°é‡‡ç”¨ **SPEC** æ–¹æ³•è®ºæ¥å¼•å¯¼ç”¨æˆ·ä»æƒ³æ³•åˆ°å®ç°ï¼š

1.  **S**pecification (L0): å®šä¹‰ **What** å’Œ **Why**ã€‚é—®é¢˜ã€èƒƒå£ï¼ˆæŠ•å…¥é¢„æœŸï¼‰ã€è§£å†³æ–¹æ¡ˆã€‚
2.  **P**lanning (L1): æ‹†è§£ä¸ºæ¨¡å—å’Œä¾èµ– (Universe è§†å›¾)ã€‚
3.  **E**xecution (L2): è®¾è®¡é€»è¾‘æµå’Œé¢†åŸŸæ¨¡å‹ (Galaxy è§†å›¾)ã€‚
4.  **C**oding (L3): å®ç°ç»†èŠ‚ (Planet/Studio è§†å›¾)ã€‚

**Spec Studio** æ˜¯ **Specification** é˜¶æ®µçš„ä¸“ç”¨ç•Œé¢ã€‚

## 2. Spec æ¨¡ç‰ˆ (The "Kit")

æˆ‘ä»¬é‡‡ç”¨å— GitHub Spec Kit / Shape Up å¯å‘çš„ç»“æ„åŒ–æ–¹æ³•ã€‚æ¯ä¸ªé¡¹ç›®æˆ–ç‰¹æ€§éƒ½å§‹äºä¸€ä¸ª **Spec èµ„äº§**ã€‚

### 2.1 ç»“æ„

```markdown
# [Feature Name]

## 0. Goals & Metrics (Teleological Intent)
æˆ‘ä»¬å¸Œæœ›è¾¾æˆä»€ä¹ˆå¯é‡åŒ–çš„ç›®æ ‡ï¼Ÿ
- [ ] ä¸šåŠ¡ç›®æ ‡: æ³¨å†Œè½¬åŒ–ç‡æå‡ 10%ã€‚
- [ ] ç³»ç»Ÿç›®æ ‡: API å“åº”æ—¶é—´ < 200msã€‚
> *Platform Magic*: è¿™äº›ç›®æ ‡å°†è‡ªåŠ¨ç”Ÿæˆä»£ç ä¸­çš„ **Telemetry/Metrics** åŸ‹ç‚¹ã€‚

## 1. The Problem (é—®é¢˜)

## 2. Appetite (èƒƒå£/æŠ•å…¥é¢„æœŸ)
æˆ‘ä»¬æ„¿æ„æŠ•å…¥å¤šå°‘æ—¶é—´/ç²¾åŠ›ï¼Ÿ
- [ ] Small Batch (1-2 å¤©)
- [ ] Big Batch (1-2 å‘¨)

## 3. The Solution (è§£å†³æ–¹æ¡ˆ)
æ–¹æ¡ˆçš„é«˜å±‚æè¿°ã€‚

### User Stories (Logic Intent L0)
- [ ] ç”¨æˆ·åš Xï¼Œç³»ç»Ÿå“åº” Yã€‚
- [ ] å½“ Z å‘ç”Ÿæ—¶ï¼Œè§¦å‘ Wã€‚

### UI Sketches (UI Intent L0)
- [ ] ä»ªè¡¨ç›˜: éœ€è¦ä¸€ä¸ªå›¾è¡¨å’Œä¸€ä¸ªæœ€è¿‘è®¢å•åˆ—è¡¨ã€‚
- [ ] å¼¹çª—: ç®€å•çš„è¡¨å•ï¼Œå¸¦â€œæäº¤â€æŒ‰é’®ã€‚

### Domain Concepts (Domain Intent L0)
- [ ] Order (è®¢å•): { id, status, total }
- [ ] Customer (å®¢æˆ·): { id, name }

## 4. Rabbit Holes (æ½œåœ¨é£é™©)
é£é™©ã€æœªçŸ¥æ•°å’ŒæŠ€æœ¯æŒ‘æˆ˜ã€‚

## 5. No-Gos (ä¸åšåˆ—è¡¨)
æ˜ç¡®æˆ‘ä»¬åœ¨æœ¬æ¬¡è¿­ä»£ä¸­ **ä¸åš** ä»€ä¹ˆã€‚
### 2.2 æ„å›¾åŸè¯­ (Intent Primitives)

ä¸ºäº†å°†éç»“æ„åŒ–çš„è‡ªç„¶è¯­è¨€è½¬åŒ–ä¸ºç»“æ„åŒ– Specï¼Œæˆ‘ä»¬æç‚¼äº†ä¸€ç»„æ ¸å¿ƒçš„ **æ„å›¾åŸè¯­**ã€‚

> [!NOTE]
> **æ–¹æ³•è®ºæº¯æº (Methodology Lineage)**
> æˆ‘ä»¬çš„æ•°æ®æ¨¡å‹ç›´æ¥ç»§æ‰¿è‡ª **GitHub Spec Kit**ï¼Œå¹¶é’ˆå¯¹å¤æ‚ä¸šåŠ¡åœºæ™¯è¿›è¡Œäº†æ‰©å±•ï¼š
> *   **Spec**: å¯¹åº” Spec Kit çš„ `Spec` (æ–‡æ¡£å®¹å™¨)ã€‚
> *   **User Story**: å¯¹åº” Spec Kit çš„ `Story` (ç”¨æˆ·ä»·å€¼å•å…ƒ)ã€‚
> *   **Task**: å¯¹åº” Spec Kit çš„ `Task` (å·¥ç¨‹æ‰§è¡Œå•å…ƒ)ã€‚
> *   **Epic (æ‰©å±•)**: è¿™æ˜¯ä¸€ä¸ªæ–°å¢å±‚çº§ï¼Œç”¨äºèšåˆç›¸å…³çš„ Storiesï¼Œè§£å†³å¤§å‹ ToB ç³»ç»Ÿä¸­ Story è¿‡äºé›¶æ•£çš„é—®é¢˜ã€‚

#### A. å²è¯— (Epic / Feature Group)
*   **å®šä¹‰**: å¤§é¢—ç²’åº¦çš„ä¸šåŠ¡æ¨¡å—æˆ–èƒ½åŠ›é›†åˆï¼ˆä¾‹å¦‚â€œæ”¯ä»˜ç³»ç»Ÿâ€ã€â€œç”¨æˆ·ä¸­å¿ƒâ€ï¼‰ã€‚
*   **ä½œç”¨**: ä½œä¸º User Story çš„å®¹å™¨ï¼Œç”¨äºç»„ç»‡å’Œè§„åˆ’ï¼ˆL0.5 å±‚çº§ï¼‰ã€‚
*   **äº¤äº’**: åœ¨ç”»å¸ƒä¸Šè¡¨ç°ä¸ºåŒ…å«å¤šä¸ª Story çš„â€œæ³³é“â€æˆ–â€œåˆ†ç»„æ¡†â€ã€‚

#### B. ç”¨æˆ·æ•…äº‹ (User Story Widget)
*   **ç»“æ„**: `As a <Role>, I want <Feature>, So that <Benefit>`
*   **äº¤äº’**: å¡«ç©ºå¼å¡ç‰‡ã€‚
    *   `Role`: ä¸‹æ‹‰é€‰æ‹©ï¼ˆå¤ç”¨ Domain ä¸­å®šä¹‰çš„è§’è‰²ï¼‰ã€‚
    *   `Feature`: ç®€çŸ­æ–‡æœ¬ã€‚
    *   `Benefit`: ç®€çŸ­æ–‡æœ¬ï¼ˆå¯é€‰ï¼‰ã€‚

#### B. é€»è¾‘æµ (Logic Flow / Gherkin Widget)
*   **ç»“æ„**: `Given <Context>, When <Event>, Then <Outcome>`
*   **äº¤äº’**: æ­¥éª¤æ¡æˆ–å³æ—¶é€»è¾‘æ„å»ºå™¨ã€‚
    *   `Given`: åˆå§‹çŠ¶æ€ï¼ˆe.g., "è®¢å•çŠ¶æ€ä¸ºå¾…æ”¯ä»˜"ï¼‰ã€‚
    *   `When`: è§¦å‘äº‹ä»¶ï¼ˆe.g., "ç”¨æˆ·ç‚¹å‡»æ”¯ä»˜"ï¼‰ã€‚
    *   `Then`: æœŸæœ›ç»“æœï¼ˆe.g., "è·³è½¬æ”¶é“¶å°"ï¼‰ã€‚

#### C. é¢†åŸŸæ¦‚å¿µ (Domain Concept Widget)
*   **ç»“æ„**: `Entity <Name> { <Field>: <Type> }`
*   **äº¤äº’**: ç®€æ˜“ ER å›¾ç¼–è¾‘å™¨æˆ–è¡¨æ ¼ã€‚
    *   è‡ªåŠ¨è¯†åˆ«åè¯å¹¶å»ºè®®ä¸ºå®ä½“ã€‚
    *   è‡ªåŠ¨æ¨å¯¼å­—æ®µç±»å‹ã€‚

#### D. ç•Œé¢è‰å›¾ (UI Sketch Widget)
*   **ç»“æ„**: `Screen <Name> contains <Component List>`
*   **äº¤äº’**: æ‹–æ‹½å¼çº¿æ¡†å›¾å·¥å…·æˆ–è‡ªç„¶è¯­è¨€ç”Ÿæˆï¼ˆ"ç”»ä¸€ä¸ªå¸¦æœç´¢æ çš„åˆ—è¡¨"ï¼‰ã€‚


## 3. äº¤äº’è®¾è®¡ï¼šSpec å‘å¯¼ (The Spec Wizard)

Spec Studio ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ª **AI è¾…åŠ©çš„è®¿è°ˆç•Œé¢**ã€‚

### 3.1 æµç¨‹ (The Flow)

1.  **Brain Dump (æƒ³æ³•å€¾å€’)**: ç”¨æˆ·åœ¨å¯¹è¯æ¡†ä¸­è¾“å…¥æˆ–è¯­éŸ³æè¿°æ¨¡ç³Šçš„æƒ³æ³•ã€‚
    *   *User*: â€œæˆ‘æƒ³åšä¸€ä¸ªè¿½è¸ªæŠ«è¨é…é€çš„ä»ªè¡¨ç›˜ã€‚â€
2.  **The Interview (è®¿è°ˆ)**: **Spec Agent** åˆ†æè¾“å…¥ï¼Œå¹¶åŸºäº Spec æ¨¡ç‰ˆæå‡ºæ¾„æ¸…é—®é¢˜ã€‚
    *   *Agent*: â€œæ˜ç™½äº†ã€‚å¯¹äºä»ªè¡¨ç›˜ï¼Œä½ éœ€è¦å®æ—¶çš„åœ°å›¾è¿½è¸ªï¼Œè¿˜æ˜¯åªéœ€è¦ä¸€ä¸ªçŠ¶æ€åˆ—è¡¨ï¼Ÿåœ¨ä½ çš„ä¸šåŠ¡é¢†åŸŸä¸­ï¼Œâ€˜é…é€â€™æ˜¯å¦‚ä½•å®šä¹‰çš„ï¼Ÿâ€
3.  **Live Crystallization (å®æ—¶ç»“æ™¶)**: éšç€å¯¹è¯è¿›è¡Œï¼ŒAgent åœ¨å±å¹•å³ä¾§ **å®æ—¶æ›´æ–°** ç»“æ„åŒ–çš„ Spec æ–‡æ¡£ã€‚
    *   *User*: â€œå®æ—¶å¤ªå¤æ‚äº†ï¼Œå…ˆè¦ä¸ªåˆ—è¡¨å°±è¡Œã€‚â€
    *   *Agent æ›´æ–° 'No-Gos' ç« èŠ‚*: â€œå®æ—¶åœ°å›¾è¿½è¸ªã€‚â€
4.  **Approval & Handover (å®¡æ‰¹ä¸äº¤æ¥)**:
    *   ç”¨æˆ·ç‚¹å‡» â€œApprove Specâ€ã€‚
    *   å¹³å°ä» Spec ç”Ÿæˆ **Intent Rules** (L1/L2 è‰ç¨¿)ã€‚
    *   ç”¨æˆ·è¢«é‡å®šå‘åˆ° **Universe è§†å›¾** (L1)ï¼Œå…¶ä¸­åŒ…å«é¢„å¡«å……çš„æ¨¡å—ç»“æ„ã€‚

## 4. æ˜ å°„åˆ°æ„å›¾å±‚ (Mapping to Intent Layers)

Spec Studio å……å½“ä»è‡ªç„¶è¯­è¨€åˆ°æ„å›¾æ¨¡å‹çš„ **è§£ç å™¨**ã€‚

| æ„å›¾åŸè¯­ (Primitive) | ç›®æ ‡æ„å›¾å±‚ (Target Layer) | ç”Ÿæˆçš„èµ„äº§ (Artifact) | æ˜ å°„é€»è¾‘ |
| :--- | :--- | :--- | :--- |
| **User Story** | **Logic Intent (L1)** | `LogicIntentNode` | `Role` -> Actor, `Feature` -> Description, `Benefit` -> Comment |
| **Logic Flow (Gherkin)** | **Logic Intent (L2)** | `IntentRule` | `Given/When` -> `Source` (Trigger), `Then` -> `Sink` (Action) |
| **Module Concept** | **Module Intent** | `ModuleIntentNode` | `Entity` -> `Module.make`, `Fields` -> `Schema.Struct` |
| **UI Sketch** | **UI Intent** | `UIIntentNode` | `Screen` -> Layout Component, `Component` -> Placeholder Node |
| **Appetite** | **Project Meta** | `Task.md` | `Small/Big Batch` -> Task Complexity / Due Date |

### 2.3 æ˜ å°„ä¸äº¤äº’æ·±åº¦åˆ†æ (Deep Dive)

ä¸ºäº†ç¡®ä¿ Spec ä¸ä»…ä»…æ˜¯æ–‡æ¡£ï¼Œè€Œæ˜¯å¯æ‰§è¡Œä»£ç çš„è‰ç¨¿ï¼Œæˆ‘ä»¬éœ€è¦å»ºç«‹ä» **æ„å›¾åŸè¯­** åˆ° **Logix Runtime** çš„ç²¾ç¡®æ˜ å°„ï¼Œå¹¶ä¸ºæ¯ä¸ªåŸè¯­åŒ¹é…æœ€è‡ªç„¶çš„äº¤äº’å½¢å¼ã€‚

#### A. ç”¨æˆ·æ•…äº‹ (User Story) -> Logic Intent (L1)
*   **è¿è¡Œæ—¶æ˜ å°„**:
    *   `Role` -> **Auth Context / Actor**: æ˜ å°„åˆ° Runtime ä¸­çš„ `CurrentRole` æˆ–æƒé™å®ˆå«ã€‚
    *   `Feature` -> **Logic Module Name**: ä½œä¸ºä¸€ä¸ªé€»è¾‘æ¨¡å—çš„è‡ªç„¶è¯­è¨€æ ‡è¯†ã€‚
    *   `Benefit` -> **Doc Comment**: ç”Ÿæˆä»£ç æ—¶çš„ JSDoc æ³¨é‡Šï¼Œè§£é‡Š *Why*ã€‚
*   **äº¤äº’å½¢å¼**: **ç»“æ„åŒ–å¡«ç©º (Mad Libs)**
    *   ä¸è¦è®©ç”¨æˆ·é¢å¯¹ç©ºç™½æ–‡æœ¬æ¡†ã€‚
    *   æä¾›ä¸€ä¸ªå¥å­æ¨¡ç‰ˆï¼š`ä½œä¸º [è§’è‰²ä¸‹æ‹‰æ¡†]ï¼Œæˆ‘æƒ³ [è¾“å…¥åŠŸèƒ½]ï¼Œä»¥ä¾¿äº [è¾“å…¥ä»·å€¼]`ã€‚
    *   *ä¼˜åŠ¿*: å¼ºåˆ¶ç”¨æˆ·æ€è€ƒè§’è‰²å’Œä»·å€¼ï¼ŒåŒæ—¶åˆ©ç”¨ç°æœ‰çš„ Domain Role æ•°æ®ã€‚

#### B. é€»è¾‘æµ (Gherkin) -> IntentRule / Fluent API (L2)
è¿™æ˜¯æœ€æ ¸å¿ƒçš„æ˜ å°„ï¼Œè¿æ¥äº†è‡ªç„¶è¯­è¨€ä¸ä¸šåŠ¡é€»è¾‘ã€‚

*   **è¿è¡Œæ—¶æ˜ å°„**:
    *   `Given <Context>` -> **Pre-condition / State Selector**:
        *   æ˜ å°„ä¸º `yield* $.onState(s => s.status === 'Pending')`
        *   æˆ– `Store.invariant` (ä¸šåŠ¡ä¸å˜é‡)ã€‚
    *   `When <Event>` -> **Trigger / Signal**:
        *   æ˜ å°„ä¸º `yield* $.fromAction('Pay')` æˆ– `yield* $.onSignal(...)`ã€‚
    *   `Then <Outcome>` -> **Effect / Mutation**:
        *   æ˜ å°„ä¸º `Service.call(...)` æˆ– `$.dispatch(...)`ã€‚
*   **äº¤äº’å½¢å¼**: **ç§¯æœ¨å¼è¯­å¥æ„å»ºå™¨ (Block-based Builder)**
    *   ç±»ä¼¼ IFTTT æˆ– Zapierï¼Œä½†æ›´ç»†ç²’åº¦ã€‚
    *   ç”¨æˆ·å…ˆé€‰æ‹© `Given/When/Then` å¼•å¯¼è¯ï¼Œç„¶åç³»ç»Ÿæ ¹æ®å½“å‰ä¸Šä¸‹æ–‡æ¨èåç»­å†…å®¹ï¼ˆä¾‹å¦‚é€‰æ‹©äº† `Order` Domainï¼Œå°±æ¨è `Status` å­—æ®µï¼‰ã€‚
    *   *ä¼˜åŠ¿*: æ—¢ä¿ç•™äº†è‡ªç„¶è¯­è¨€çš„å¯è¯»æ€§ï¼Œåˆé™åˆ¶äº†è¾“å…¥èŒƒå›´ï¼Œç¡®ä¿èƒ½ 100% ç¼–è¯‘ä¸ºä»£ç ã€‚

#### C. é¢†åŸŸæ¦‚å¿µ (Domain Concept) -> Domain Assets
*   **è¿è¡Œæ—¶æ˜ å°„**:
    *   `Entity` -> **Module ID**: `Logix.Module('Order', ...)`ã€‚
    *   `Field` -> **Schema Definition**: `Schema.Struct({ status: Schema.String })`ã€‚
    *   `Relation` -> **Domain Reference**: åœ¨ Schema ä¸­å¼•ç”¨å…¶ä»– Module çš„ IDã€‚
*   **äº¤äº’å½¢å¼**: **æ™ºèƒ½è¡¨æ ¼ (Smart Spreadsheet)**
    *   ç±»ä¼¼ Notion Database æˆ– Airtableã€‚
    *   ç¬¬ä¸€åˆ—å®šä¹‰å­—æ®µåï¼Œç¬¬äºŒåˆ—å®šä¹‰ç±»å‹ï¼ˆæä¾›æ™ºèƒ½æ¨å¯¼ï¼‰ï¼Œç¬¬ä¸‰åˆ—å®šä¹‰æ ¡éªŒè§„åˆ™ã€‚
    *   *ä¼˜åŠ¿*: å¼€å‘è€…ç†Ÿæ‚‰çš„å®šä¹‰æ•°æ®çš„æ–¹å¼ï¼Œæ¯”å›¾å½¢åŒ–çš„ ER å›¾æ›´é«˜æ•ˆï¼Œæ¯”çº¯ä»£ç æ›´ç›´è§‚ã€‚

#### D. ç•Œé¢è‰å›¾ (UI Sketch) -> UI Intent / Component Tree
*   **è¿è¡Œæ—¶æ˜ å°„**:
    *   `Screen` -> **Route / Page Component**ã€‚
    *   `Component` -> **UI Pattern / Placeholder**: æ˜ å°„åˆ°ç»„ä»¶åº“ä¸­çš„å…·ä½“ç»„ä»¶ï¼ˆå¦‚ `ProTable`ï¼‰æˆ–é€šç”¨å ä½ç¬¦ï¼ˆ`Box`ï¼‰ã€‚
*   **äº¤äº’å½¢å¼**: **ç™½æ¿ + AI è¯†åˆ« (Whiteboard + Vision)**
    *   å…è®¸ç”¨æˆ·ç»˜åˆ¶ç®€å•çš„çº¿æ¡†å›¾ï¼ˆExcalidraw é£æ ¼ï¼‰ã€‚
    *   AI è¯†åˆ«å›¾ä¸­çš„å…ƒç´ ï¼ˆ"è¿™æ˜¯ä¸€ä¸ªåˆ—è¡¨"ï¼Œ"è¿™æ˜¯ä¸€ä¸ªæŒ‰é’®"ï¼‰å¹¶è½¬æ¢ä¸ºç»„ä»¶æ ‘ç»“æ„ã€‚
    *   *ä¼˜åŠ¿*: åœ¨ L0 é˜¶æ®µï¼Œç”¨æˆ·æ›´å€¾å‘äºâ€œç”»â€è€Œä¸æ˜¯â€œé…â€ã€‚

### 2.4 æ´»ä½“ SPEC ç”»å¸ƒ (The Living SPEC Canvas)

ä¸ºäº†è®© SPEC æ–¹æ³•è®ºæ·±å…¥å¹³å°éª¨é«“ï¼Œæˆ‘ä»¬ä¸èƒ½åªæä¾›è‡ªç”±ç”»å¸ƒï¼Œå¿…é¡»æä¾› **â€œå¸¦æ–¹æ³•è®ºçº¦æŸçš„ç”»å¸ƒâ€**ã€‚ç”¨æˆ·åœ¨ç”»å¸ƒä¸Šçš„æ¯ä¸€æ¬¡æ“ä½œï¼Œéƒ½æ˜¯åœ¨è·µè¡Œ SPEC æ€æƒ³ã€‚

#### A. æ™ºèƒ½èŠ‚ç‚¹ (Smart Nodes)
ç”»å¸ƒä¸å†æä¾›çŸ©å½¢æˆ–åœ†å½¢ï¼Œè€Œæ˜¯ç›´æ¥æä¾› **æ„å›¾åŸè¯­èŠ‚ç‚¹**ã€‚
*   **User Story Node**: åŒ…å« Role/Feature/Benefit ä¸‰ä¸ªæ’æ§½ã€‚
*   **Entity Node**: è‡ªåŠ¨å±•å¼€ä¸ºå­—æ®µåˆ—è¡¨ã€‚
*   **Screen Node**: ä¹Ÿå°±æ˜¯ UI Sketch Widget çš„ç”»å¸ƒå½¢æ€ã€‚

#### D. è§†è§‰è¡¥å…¨ (Visual Gap Filling)
è¿™æ˜¯å¤šæ¨¡æ€åœ¨â€œæ‹†è§£è¿‡ç¨‹â€ä¸­çš„æ ¸å¿ƒä»·å€¼ã€‚å½“æ–‡å­—éš¾ä»¥æè¿°å¤æ‚é€»è¾‘æ—¶ï¼Œç”»å›¾æ˜¯æœ€é«˜æ•ˆçš„â€œä¿¡æ¯æ³¨å…¥â€æ–¹å¼ã€‚
*   **åœºæ™¯**: AI æç¤ºâ€œæˆ‘ä¸ç†è§£â€˜å¤æ‚çš„å®¡æ‰¹æµâ€™å…·ä½“æŒ‡ä»€ä¹ˆâ€ã€‚
*   **åŠ¨ä½œ**: ç”¨æˆ·åœ¨ Tldraw ä¸Šç”»ä¸€ä¸ªå¸¦åˆ†æ”¯çš„æµç¨‹è‰å›¾ã€‚
*   **è¡¥å…¨**: AI è¯†åˆ«è‰å›¾ç»“æ„ï¼Œè‡ªåŠ¨è¡¥å…¨ Logic Flow çš„ç»†èŠ‚ï¼Œå¡«è¡¥äº†æ–‡å­—æè¿°çš„ä¿¡æ¯ç¼ºå£ã€‚

#### E. æ·±åº¦æ„å›¾è§£æ (Deep Intent Parsing)
ä¸ºäº†æ”¯æŒé«˜ä¿çœŸç”Ÿæˆï¼Œå¤šæ¨¡æ€å¼•æ“è¾“å‡ºçš„ JSON éµå¾ª **UI Intent Schema** (Abstract/Concrete/Visual)ã€‚
*   **æŠ½è±¡ç»„ä»¶**: è¯†åˆ«å‡º `Input { role: 'password' }` è€Œéå…·ä½“çš„ `Antd.Input`ã€‚
*   **äººæœºç¡®è®¤ (Human-in-the-loop)**: å½“ AI ä¸ç¡®å®šæ—¶ï¼ˆä¾‹å¦‚â€œè¿™æ˜¯æœç´¢æ¡†è¿˜æ˜¯è¾“å…¥æ¡†ï¼Ÿâ€ï¼‰ï¼Œè°ƒç”¨ `$.ask` API åœ¨ç”»å¸ƒä¸Šå¼¹å‡ºç¡®è®¤æ°”æ³¡ã€‚



#### B. è¯­ä¹‰è¿æ¥ (Semantic Links)
è¿çº¿ä¸ä»…ä»…æ˜¯ç”»çº¿ï¼Œè€Œæ˜¯å»ºç«‹ **æ„å›¾å…³è”**ã€‚
*   **Realizes (å®ç°)**: å°† `User Story` è¿å‘ `Screen` æˆ– `Logic Flow`ã€‚
    *   *äº¤äº’*: è¿çº¿æ—¶å¼¹å‡ºæç¤º "è¿™ä¸ªç•Œé¢å®ç°äº†æ•…äº‹ä¸­çš„å“ªä¸ª Featureï¼Ÿ"
*   **Displays (å±•ç¤º)**: å°† `Entity` è¿å‘ `Screen`ã€‚
    *   *äº¤äº’*: è‡ªåŠ¨åœ¨ Screen ä¸­ç”Ÿæˆå¯¹åº”å­—æ®µçš„å ä½ç»„ä»¶ã€‚
*   **Triggers (è§¦å‘)**: å°† `Screen` ä¸­çš„æŒ‰é’®è¿å‘ `Logic Flow`ã€‚
    *   *äº¤äº’*: è‡ªåŠ¨å¡«å…… Logic Flow çš„ `When` æ¡ä»¶ã€‚

#### C. è‡ªæˆ‘é—­ç¯ (The Self-Closing Loop)
å¹³å°å®æ—¶ç›‘æ§ SPEC çš„å®Œæ•´æ€§ï¼Œå½¢æˆé—­ç¯ã€‚
*   **å­¤å²›æ£€æµ‹**: å¦‚æœä¸€ä¸ª `User Story` æ²¡æœ‰è¿å‘ä»»ä½• `Screen` æˆ– `Logic`ï¼Œå®ƒä¼šæ˜¾ç¤ºä¸ºâ€œæœªå®ç° (Unrealized)â€çŠ¶æ€ï¼ˆçº¢è‰²é«˜äº®ï¼‰ã€‚
*   **å¹½çµæ£€æµ‹**: å¦‚æœä¸€ä¸ª `Screen` å±•ç¤ºäº† `Entity` ä¸­ä¸å­˜åœ¨çš„å­—æ®µï¼Œå®ƒä¼šæç¤ºâ€œæ•°æ®ç¼ºå¤±â€ã€‚
*   **æ„å›¾å¯¼èˆª**: åŒå‡» `User Story`ï¼Œç”»å¸ƒè‡ªåŠ¨èšç„¦åˆ°æ‰€æœ‰å®ç°å®ƒçš„ `Screen` å’Œ `Logic`ï¼Œå±•ç¤ºå®Œæ•´çš„â€œéœ€æ±‚å®ç°é“¾â€ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œç”»å¸ƒä¸å†æ˜¯æ¶‚é¸¦æ¿ï¼Œè€Œæ˜¯ **å¯è§†åŒ–çš„ SPEC ç¼–è¯‘å™¨**ã€‚

### 2.5 ä¸¥æ ¼æº¯æºä½“ç³» (The Strict Traceability System)

å‚è€ƒ Spec Kit çš„ Prompt ç»“æ„ï¼Œæˆ‘ä»¬å°†â€œUser Story -> Task -> Implementationâ€çš„ä¸¥æ ¼å…³è”è½¬åŒ–ä¸ºå¹³å°çš„ UI/UX æ ¸å¿ƒæœºåˆ¶ã€‚

#### A. æº¯æºé“¾ (The Traceability Chain)
å¹³å°å¼ºåˆ¶ç»´æŠ¤ä»¥ä¸‹å±‚çº§å…³ç³»ï¼Œç¦æ­¢è¶Šçº§æ“ä½œï¼š
1.  **User Story (L0)**: ä»·å€¼çš„èµ·ç‚¹ã€‚
2.  **Task (L0.5)**: æ•…äº‹çš„æ‹†è§£ï¼ˆTODO Listï¼‰ã€‚
3.  **Intent Rule (L1/L2)**: ä»»åŠ¡çš„é€»è¾‘/UI æ˜ å°„ã€‚
4.  **Implementation (L3)**: æœ€ç»ˆçš„ä»£ç å®ç°ã€‚

#### B. äº¤äº’è®¾è®¡ï¼šä¸‰è§†å›¾ (The Three Views)

1.  **æº¯æºçŸ©é˜µ (Traceability Matrix)**
    *   *å½¢æ€*: ä¸€ä¸ªäºŒç»´è¡¨æ ¼æˆ–æ³³é“å›¾ã€‚
    *   *è¡Œ*: User Storiesã€‚
    *   *åˆ—*: Tasks / Logic / UI / Codeã€‚
    *   *ä½œç”¨*: ä¸€çœ¼çœ‹å‡ºå“ªä¸ªæ•…äº‹è¿˜æ²¡æ‹†è§£ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡è¿˜æ²¡å†™ä»£ç ã€‚çº¢/ç»¿/ç°çŠ¶æ€ç¯ç›´è§‚å±•ç¤ºè¿›åº¦ã€‚

2.  **é’»å–å¯¼èˆª (Drill-down Navigation)**
    *   *äº¤äº’*: åœ¨ Spec æ–‡æ¡£ä¸­ç‚¹å‡»ä¸€ä¸ª `User Story`ï¼ŒUI ä¸ä»…é«˜äº®ï¼Œè¿˜ä¼šå±•å¼€å…¶ä¸‹çš„ `Task` åˆ—è¡¨ã€‚
    *   *äº¤äº’*: ç‚¹å‡»æŸä¸ª `Task`ï¼Œç›´æ¥è·³è½¬åˆ°å¯¹åº”çš„ `Logic Module` æˆ– `Code Block`ã€‚
    *   *éšå–»*: "å‰¥æ´‹è‘±" â€”â€” ä»ä»·å€¼å±‚ä¸€å±‚å±‚å‰¥ç¦»åˆ°å®ç°å±‚ã€‚

3.  **ä¸¥æ ¼æ¨¡å¼å®ˆå« (Strict Mode Guardrails)**
    *   **ç¦æ­¢æ¸¸ç¦»ä»£ç **: åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œè¯•å›¾åˆ›å»ºä¸å±äºä»»ä½• Task çš„ Logic/UI æ—¶ï¼Œç³»ç»Ÿä¼šå¼¹çª—è¯¢é—®ï¼šâ€œè¿™æ˜¯ä¸ºäº†å“ªä¸ª Task æœåŠ¡ï¼Ÿâ€
    *   **å®Œæˆåº¦æ ¡éªŒ**: å½“æ ‡è®° User Story ä¸º "Done" æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨æ£€æŸ¥å…¶ä¸‹æ‰€æœ‰ Task æ˜¯å¦å·²å®Œæˆï¼Œä»¥åŠæ‰€æœ‰ Task æ˜¯å¦éƒ½æœ‰å¯¹åº”çš„ Intent/Code å®ç°ã€‚

é€šè¿‡è¿™å¥—ä½“ç³»ï¼Œæˆ‘ä»¬æŠŠ Spec Kit Prompt ä¸­çš„æ–‡æœ¬çº¦æŸå˜æˆäº† **å¹³å°äº¤äº’çº¦æŸ**ï¼Œç¡®ä¿â€œæ¯ä¸€è¡Œä»£ç éƒ½æœ‰è¿¹å¯å¾ªâ€ã€‚

### 2.6 æ¥åœ°æ°”ï¼šToB ä¸ Effect-Native æ·±åº¦é›†æˆ

æˆ‘ä»¬çš„å¹³å°æœåŠ¡äº ToB å¤æ‚ä¸šåŠ¡ï¼Œä¸”åŸºäº Effect-Native æ¶æ„ã€‚å› æ­¤ï¼ŒSPEC ä¸èƒ½æ­¢æ­¥äºç®€å•çš„ CRUDï¼Œå¿…é¡»èƒ½è¡¨è¾¾ **å¤æ‚çš„é€»è¾‘çº¦æŸ** å’Œ **Effect è¿è¡Œæ—¶ç‰¹æ€§**ã€‚

#### A. ToB ä¸“ç”¨æ„å›¾åŸè¯­ (ToB Primitives)
ToB ä¸šåŠ¡çš„æ ¸å¿ƒä¸æ˜¯â€œç•Œé¢è·³è½¬â€ï¼Œè€Œæ˜¯â€œæƒé™ã€å®¡æ‰¹ã€æŠ¥è¡¨ã€æ•°æ®ä¸€è‡´æ€§â€ã€‚
*   **Permission Rule (æƒé™è§„åˆ™)**: `Role <R> CAN/CANNOT <Action> ON <Resource> WHEN <Condition>`
    *   *æ˜ å°„*: `Policy.make(...)` æˆ– `Effect.when(isPermitted)`ã€‚
*   **Workflow State (å·¥ä½œæµçŠ¶æ€)**: `State <S> TRANSITIONS TO <S'> ON <Event> WITH <Guard>`
    *   *æ˜ å°„*: çŠ¶æ€æœºå®šä¹‰ä¸ `Flow.fromState(...)`ã€‚
*   **Data Consistency (ä¸€è‡´æ€§çº¦æŸ)**: `Invariant: <Field A> MUST BE <Relation> <Field B>`
    *   *æ˜ å°„*: `Store.invariant(...)` æˆ– Database Constraintã€‚

#### B. Effect-Native æ˜ å°„ (The Effect Mapping)
Spec ä¸­çš„â€œRabbit Holes (æ½œåœ¨é£é™©)â€å’Œâ€œContext (èƒŒæ™¯)â€ç›´æ¥æ˜ å°„åˆ° Effect çš„ç±»å‹ç³»ç»Ÿã€‚

*   **Rabbit Holes -> Error Channel (E)**
    *   å¦‚æœåœ¨ Spec ä¸­å†™ä¸‹ï¼šâ€œé£é™©ï¼šåº“å­˜æœåŠ¡å¯èƒ½è¶…æ—¶â€ï¼Œ
    *   ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼š`Effect<..., InventoryError | TimeoutError, ...>`ï¼Œå¼ºåˆ¶å¼€å‘è€…å¤„ç†é”™è¯¯ã€‚
*   **Context -> Environment (R)**
    *   å¦‚æœåœ¨ Spec ä¸­å†™ä¸‹ï¼šâ€œèƒŒæ™¯ï¼šéœ€è¦å½“å‰ç”¨æˆ·ä¿¡æ¯â€ï¼Œ
    *   ç³»ç»Ÿè‡ªåŠ¨æ³¨å…¥ï¼š`yield* CurrentUser` Tagã€‚
*   **Appetite -> Timeout/Retry Policy**
    *   å¦‚æœåœ¨ Spec ä¸­æ ‡è®°ä¸º "Critical Path"ï¼Œ
    *   ç³»ç»Ÿè‡ªåŠ¨é…ç½®ï¼š`Effect.retry({ times: 3 })`ã€‚

#### C. é€»è¾‘ä¼˜å…ˆçš„äº¤äº’ (Logic-First UX)
å¯¹äº ToB ç³»ç»Ÿï¼ŒUI å¾€å¾€æ˜¯é€»è¾‘çš„å‰¯äº§å“ã€‚
*   **å…ˆé€»è¾‘ï¼Œå UI**: åœ¨ Spec Wizard ä¸­ï¼Œä¼˜å…ˆå¼•å¯¼ç”¨æˆ·å®šä¹‰â€œæ•°æ®æµâ€å’Œâ€œè§„åˆ™â€ï¼Œè€Œä¸æ˜¯å…ˆç”»å›¾ã€‚
*   **è‡ªåŠ¨ç”Ÿæˆç®¡ç†å°**: åŸºäº Domain å®šä¹‰ï¼Œè‡ªåŠ¨ç”Ÿæˆæ ‡å‡†çš„ CRUD + ç­›é€‰ + å¯¼å‡ºç•Œé¢ï¼ˆProComponentsï¼‰ï¼Œè®©å¼€å‘è€…ä¸“æ³¨äºæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€‚

é€šè¿‡è¿™ç§æ·±åº¦é›†æˆï¼ŒSPEC ä¸å†æ˜¯æ³›æ³›çš„æ–‡æ¡£ï¼Œè€Œæ˜¯ **Effect ä»£ç çš„è‡ªç„¶è¯­è¨€å£°æ˜**ã€‚

### 2.7 ç†è®ºåŸºçŸ³ï¼šSDD ä¸ Spec-DD çš„èåˆ

æœ¬è®¾è®¡æ·±å— **è§„èŒƒé©±åŠ¨å¼€å‘ (SDD)** ä¸ **Spec-DD** ç†è®ºæŠ¥å‘Šçš„å¯å‘ï¼Œæ—¨åœ¨å®ç° **Level 3: è§„èŒƒå³æºç  (Spec-as-Source)** çš„æˆ˜ç•¥æ„¿æ™¯ã€‚

#### A. åŒé‡å¥‘çº¦ä½“ç³» (The Dual Contract System)
æˆ‘ä»¬é‡‡çº³ Spec-DD çš„æ ¸å¿ƒæ¶æ„ï¼Œå»ºç«‹ä¸¤å¥—äº’è¡¥çš„å¥‘çº¦ï¼š
1.  **è¡Œä¸ºå¥‘çº¦ (Behavioral Contract)**:
    *   *è½½ä½“*: **Gherkin (Logic Flow)**ã€‚
    *   *ä½œç”¨*: å®šä¹‰â€œç³»ç»Ÿåº”è¯¥åšä»€ä¹ˆâ€ (The Why & What)ã€‚
    *   *SSOT*: äº§å“ç»ç†æ‹¥æœ‰ï¼Œä½œä¸ºåŠŸèƒ½éªŒæ”¶çš„å”¯ä¸€æ ‡å‡†ã€‚
2.  **æŠ€æœ¯å¥‘çº¦ (Technical Contract)**:
    *   *è½½ä½“*: **Domain Schema & Effect Signature** (ç±»æ¯” OAS)ã€‚
    *   *ä½œç”¨*: å®šä¹‰â€œç³»ç»Ÿå¦‚ä½•äº¤äº’â€ (The Interface)ã€‚
    *   *SSOT*: æ¶æ„å¸ˆæ‹¥æœ‰ï¼Œä½œä¸ºä»£ç ç”Ÿæˆçš„å¼ºåˆ¶çº¦æŸã€‚

#### B. å½¢å¼åŒ–éªŒè¯ä¸åé¦ˆå¾ªç¯ (Formal Verification Loop)
å€Ÿé‰´ SDD çš„â€œç”Ÿæˆå¼åé¦ˆå¾ªç¯â€æœºåˆ¶ï¼š
1.  **ç”Ÿæˆ (Synthesize)**: AI Agent æ ¹æ® Spec ç”Ÿæˆ `IntentRule` å’Œä»£ç ã€‚
2.  **éªŒè¯ (Verify)**: å¹³å°åˆ©ç”¨ Effect çš„ç±»å‹ç³»ç»Ÿå’Œ `Store.invariant` è¿›è¡Œè‡ªåŠ¨éªŒè¯ã€‚
3.  **åé¦ˆ (Refine)**: éªŒè¯å¤±è´¥ï¼ˆå¦‚ç±»å‹ä¸åŒ¹é…ã€æ­»é”æ£€æµ‹ï¼‰ç›´æ¥åé¦ˆå› Spec Studioï¼Œæç¤ºç”¨æˆ·ä¿®æ”¹ Specï¼Œè€Œä¸æ˜¯ä¿®æ”¹ä»£ç ã€‚

#### C. æ²»ç†å‰ç½® (Shift-Left Governance)
é€šè¿‡ Spec Studioï¼Œæˆ‘ä»¬å°†æ²»ç†é‡å¿ƒä» Code Review è½¬ç§»åˆ° **Spec Review**ã€‚
*   **å®ªæ³•åˆè§„ (Constitutional Compliance)**: åœ¨ Spec é˜¶æ®µå°±æ£€æŸ¥æ˜¯å¦ç¬¦åˆæ¶æ„åŸåˆ™ï¼ˆå¦‚â€œç¦æ­¢åœ¨ View å±‚ç›´æ¥è°ƒç”¨ APIâ€ï¼‰ã€‚
*   **é£é™©æ¨¡å‹è½¬ç§»**: å°†é£é™©ä»â€œå®ç°é£é™©â€ï¼ˆä»£ç å†™é”™ï¼‰è½¬ç§»ä¸ºâ€œéœ€æ±‚é£é™©â€ï¼ˆSpec å†™é”™ï¼‰ï¼Œåˆ©ç”¨ AI çš„ä»£ç ç”Ÿæˆèƒ½åŠ›æ¶ˆé™¤å®ç°è¯¯å·®ã€‚

é€šè¿‡è¿™ä¸€ç†è®ºå‡ç»´ï¼ŒSpec Studio ä¸å†æ˜¯ä¸€ä¸ªç®€å•çš„éœ€æ±‚å½•å…¥å·¥å…·ï¼Œè€Œæ˜¯ **ä¸‹ä¸€ä»£è½¯ä»¶å·¥ç¨‹èŒƒå¼çš„æ§åˆ¶å°**ã€‚

### 2.8 ç”¨æˆ·ç­–ç•¥ï¼šå‰ç«¯ä¼˜å…ˆï¼Œå…¼å®¹äº§å“ (Frontend-First, Product-Compatible)

åŸºäºç°çŠ¶ï¼Œ**å‰ç«¯å¼€å‘è€…**æ˜¯ Spec Studio çš„ç¬¬ä¸€æ‰¹æ ¸å¿ƒç”¨æˆ·ï¼Œä»–ä»¬æ‰®æ¼”ç€â€œéœ€æ±‚ç¿»è¯‘å®˜â€çš„è§’è‰²ã€‚å› æ­¤ï¼Œäº¤äº’è®¾è®¡å¿…é¡»ä¼˜å…ˆæ»¡è¶³å‰ç«¯çš„é«˜æ•ˆå½•å…¥éœ€æ±‚ï¼ŒåŒæ—¶ä¸ºæœªæ¥â€œäº§å“ç»ç†ç›´æ¥ä½¿ç”¨â€é¢„ç•™ç©ºé—´ã€‚

#### A. å¼€å‘è€…å‹å¥½çš„è¾“å…¥ (Dev-Friendly Inputs)
å‰ç«¯å¼€å‘è€…ä¹ æƒ¯ä»£ç æ€ç»´ï¼Œå¼ºåˆ¶ä½¿ç”¨å›¾å½¢åŒ– Wizard å¯èƒ½ä¼šé™ä½æ•ˆç‡ã€‚
*   **TS æ¥å£å³é¢†åŸŸ (TS Interface as Domain)**:
    *   å…è®¸ç”¨æˆ·ç›´æ¥åœ¨ Domain Widget ä¸­ç²˜è´´ TypeScript Interface å®šä¹‰ï¼ˆå¦‚ `interface Order { id: string; ... }`ï¼‰ã€‚
    *   ç³»ç»Ÿè‡ªåŠ¨å°†å…¶è§£æä¸º Domain Schemaï¼Œæ— éœ€æ‰‹åŠ¨ç‚¹å‡»æ·»åŠ å­—æ®µã€‚
*   **Markdown é€Ÿè®° (Markdown Shorthand)**:
    *   æ”¯æŒåœ¨æ–‡æœ¬æ¡†ä¸­ç›´æ¥ç”¨ Markdown åˆ—è¡¨å¿«é€Ÿå½•å…¥ User Storiesï¼Œç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å¹¶ç»“æ„åŒ–ã€‚

#### B. æ¸è¿›å¼å½¢å¼åŒ– (Progressive Formalization)
ä¸è¦ä¸€å¼€å§‹å°±å¼ºè¿«å‰ç«¯å†™å‡ºå®Œç¾çš„ Gherkinã€‚
*   **è‰ç¨¿æ¨¡å¼ (Draft Mode)**: å…è®¸å…ˆç²˜è´´æ‚ä¹±çš„ PRD ç‰‡æ®µæˆ–ä¼šè®®è®°å½•ã€‚
*   **AI æç‚¼ (AI Refinement)**: ç‚¹å‡»â€œæ•´ç†â€æŒ‰é’®ï¼ŒAI è¾…åŠ©å°†è‰ç¨¿è½¬åŒ–ä¸ºç»“æ„åŒ–çš„ User Story å’Œ Logic Flowã€‚
*   **ä»â€œæ€ä¹ˆåšâ€åæ¨â€œè¦åšä»€ä¹ˆâ€**: å…è®¸å‰ç«¯å…ˆå†™ä¼ªä»£ç ï¼ˆLogicï¼‰ï¼Œç„¶ååå‘ç”Ÿæˆ User Storyï¼Œè¡¥å…¨ Specã€‚

#### C. åˆ†å·¥åä½œè“å›¾ (Collaboration Blueprint)
ä¸ºæœªæ¥çš„ PM/FE åä½œè®¾è®¡â€œäº¤æ¥ç‚¹â€ã€‚
*   **PM è§†å›¾**: ä¸“æ³¨äº User Story å’Œ UI Sketchï¼ˆä½ä¿çœŸï¼‰ã€‚
*   **FE è§†å›¾**: ä¸“æ³¨äº Logic Flow å’Œ Domain Schemaï¼ˆé«˜ä¿çœŸï¼‰ã€‚
*   **é”å®šä¸ç»§æ‰¿**: PM é”å®šçš„éœ€æ±‚ï¼ŒFE åªèƒ½â€œå®ç°â€ä¸èƒ½â€œç¯¡æ”¹â€ï¼ˆé™¤éç”³è¯·å˜æ›´ï¼‰ï¼Œå½¢æˆå¥åº·çš„åˆ¶è¡¡ã€‚

é€šè¿‡è¿™ç§ç­–ç•¥ï¼Œæˆ‘ä»¬æ—¢è®©å‰ç«¯ç°åœ¨å°±èƒ½â€œç©å¾—è½¬â€ï¼ˆé«˜æ•ˆç‡ï¼‰ï¼Œåˆä¸ºæœªæ¥äº§å“ç»ç†çš„åŠ å…¥é“ºå¹³äº†é“è·¯ï¼ˆä½é—¨æ§›ï¼‰ã€‚

## 3. äº¤äº’è®¾è®¡ï¼šSpec å‘å¯¼ (The Spec Wizard)

è™½ç„¶ L0 æ˜¯é«˜å±‚çš„ï¼Œä½†å®ƒæ¤æ ¹äº Runtime èƒ½åŠ›ï¼š

### 3.1 æ ¸å¿ƒæµç¨‹ï¼šæ‹†è§£å‘å¯¼ (The Decomposition Wizard)

ä¸åŒäºä¼ ç»Ÿçš„â€œæ–°å»ºå‘å¯¼â€ï¼ŒSpec Wizard æ˜¯ä¸€ä¸ª **â€œæ‹†è§£å·¥ä½œå°â€**ã€‚

1.  **å¯¼å…¥ (Ingest)**:
    *   ç”¨æˆ·ç²˜è´´ PRD æ–‡æœ¬ã€ä¼šè®®è®°å½•ï¼Œæˆ–ä¸Šä¼ ä¸€å¼ ç™½æ¿è‰å›¾ã€‚
    *   ç³»ç»Ÿæç¤ºï¼šâ€œæ­£åœ¨åˆ†ææ–¹æ¡ˆèƒŒæ™¯ä¸æ ¸å¿ƒæ„å›¾...â€
2.  **è¯†åˆ« (Identify)**:
    *   AI æå–å‡ºå…³é”®çš„ **Epics (å¤§é¢—ç²’éœ€æ±‚)** å’Œ **Domain Objects (é¢†åŸŸå¯¹è±¡)**ã€‚
    *   **æ¨¡å¼åŒ¹é… (Pattern Matching)**: è‡ªåŠ¨æ£€ç´¢ `Generative Patterns` åº“ã€‚
        *   è¯†åˆ«å‡ºâ€œå®¡æ‰¹â€ï¼Œæ¨è `ApprovalPattern`ã€‚
        *   è¯†åˆ«å‡ºâ€œCRUDâ€ï¼Œæ¨è `ResourcePattern`ã€‚
    *   å±•ç¤ºä¸€ä¸ªæ¦‚è§ˆå¡ç‰‡ï¼šâ€œæˆ‘è¯†åˆ«å‡º 3 ä¸ªæ ¸å¿ƒæ¨¡å—...â€
3.  **æ‹†è§£ (Decompose)**:
    *   ç”¨æˆ·ç‚¹å‡»æŸä¸ª Epicï¼Œè¿›å…¥æ‹†è§£è§†å›¾ã€‚
    *   AI å»ºè®®ï¼šâ€œå»ºè®®å°†â€˜æ”¯ä»˜æµç¨‹â€™æ‹†è§£ä¸ºï¼šé€‰æ‹©æ”¯ä»˜æ–¹å¼ã€æ‰§è¡Œæ”¯ä»˜ã€æ”¯ä»˜å›è°ƒå¤„ç†ã€‚â€
    *   ç”¨æˆ·ç¡®è®¤æˆ–è°ƒæ•´æ‹†è§£ç²’åº¦ã€‚
4.  **ç”Ÿæˆ (Generate)**:
    *   ç¡®è®¤æ‹†è§£æ— è¯¯åï¼Œç”Ÿæˆå¯¹åº”çš„ Spec æ–‡ä»¶ç»“æ„å’Œåˆå§‹ä»£ç æ¡†æ¶ã€‚


### 3.2 æ‹†è§£è§†å›¾ï¼šæ ‘ä¸çŸ©é˜µ (The Decomposition View: Tree & Matrix)

é’ˆå¯¹â€œå¦‚ä½•å±•ç¤ºå’Œè¿½è¸ªæ‹†è§£â€ï¼Œæˆ‘ä»¬è®¾è®¡äº† **â€œå·¦æ ‘å³è¡¨â€** çš„è”åŠ¨è§†å›¾ã€‚

#### A. è§†è§‰æ‹†è§£æ ‘ (The Visual Decomposition Tree)
*   **å½¢æ€**: åŸºäº ReactFlow çš„æ€ç»´å¯¼å›¾ç»“æ„ã€‚
*   **å±‚çº§**: `Epic (æ ¹)` -> `User Story (æ)` -> `Task (å¶)`ã€‚
*   **å¹½çµèŠ‚ç‚¹ (Ghost Nodes)**:
    *   AI ä¼šæ ¹æ®ä¸Šä¸‹æ–‡ï¼Œåœ¨æ ‘ä¸Šç”ŸæˆåŠé€æ˜çš„â€œå¹½çµèŠ‚ç‚¹â€ï¼ˆå»ºè®®çš„æ‹†è§£ä»»åŠ¡ï¼‰ã€‚
    *   **äº¤äº’**: ç”¨æˆ·ç‚¹å‡»å¹½çµèŠ‚ç‚¹ï¼Œå°†å…¶â€œå®ä½“åŒ–â€ä¸ºæ­£å¼ Taskï¼›æˆ–è€…æ‹–æ‹½èŠ‚ç‚¹è¿›è¡Œåˆå¹¶/æ‹†åˆ†ã€‚
    *   *ä»·å€¼*: é™ä½æ‹†è§£çš„è®¤çŸ¥è´Ÿæ‹…ï¼Œç”¨æˆ·åªéœ€åšâ€œé€‰æ‹©é¢˜â€ã€‚

#### B. è¿½è¸ªçŸ©é˜µ (The Traceability Matrix)
*   **å½¢æ€**: ä½äºåº•éƒ¨çš„å¯æŠ˜å è¡¨æ ¼ï¼ˆç±»ä¼¼ Excelï¼‰ã€‚
*   **åˆ—å®šä¹‰**:
    *   `Task`: ä»»åŠ¡åç§°ã€‚
    *   `Status`: ğŸš¦ çº¢ç»¿ç¯ï¼ˆRed: æœªå¼€å§‹, Yellow: å¼€å‘ä¸­, Green: å·²å®Œæˆï¼‰ã€‚
    *   `Linked Logic`: å…³è”çš„ä»£ç å‡½æ•°ï¼ˆç‚¹å‡»è·³è½¬ VSCodeï¼‰ã€‚
    *   `Test Coverage`: æµ‹è¯•è¦†ç›–ç‡ã€‚
        *   **Intent as Test**: å¹³å°ä¼šè‡ªåŠ¨ç”Ÿæˆ `business.test.ts`ï¼Œæµ‹è¯•ç»“æœç›´æ¥åå‘ç‚¹äº®æ­¤å¤„çš„çº¢ç»¿ç¯ã€‚
*   **è”åŠ¨**: ç‚¹å‡»æ ‘ä¸Šçš„èŠ‚ç‚¹ï¼ŒçŸ©é˜µè‡ªåŠ¨è¿‡æ»¤æ˜¾ç¤ºè¯¥èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­ä»»åŠ¡çŠ¶æ€ã€‚

#### C. è¿›åº¦å¯è§†åŒ– (Progress Visualization)
*   æ ‘ä¸Šçš„çˆ¶èŠ‚ç‚¹ï¼ˆUser Storyï¼‰ä¼šæ ¹æ®å­èŠ‚ç‚¹ï¼ˆTaskï¼‰çš„å®Œæˆåº¦ï¼ŒåŠ¨æ€å¡«å…… **è¿›åº¦ç¯**ã€‚
*   ä¸€çœ¼å°±èƒ½çœ‹å‡ºå“ªä¸ª Story è¿˜åœ¨â€œå¡å£³â€ï¼Œå“ªä¸ªå·²ç» Closeã€‚


ç”¨æˆ·çš„ç›´è§‰æ˜¯æ­£ç¡®çš„ï¼š**ç”»å¸ƒ (Canvas)** æ˜¯æ‰¿è½½éç»“æ„åŒ–æ„å›¾çš„æœ€ä½³å®¹å™¨ã€‚æ— è®ºæ˜¯æµç¨‹å›¾ã€æ€ç»´å¯¼å›¾è¿˜æ˜¯è‰å›¾ï¼Œéƒ½æ˜¯äº§å“æ„å›¾çš„è‡ªç„¶æµéœ²ã€‚
ä½†æˆ‘ä»¬ä¸èƒ½åªåšä¸€ä¸ªâ€œç”»å›¾å·¥å…·â€ï¼ˆDrawing Toolï¼‰ï¼Œå¿…é¡»åšä¸€ä¸ª **â€œè¯­ä¹‰åŒ–ç”»å¸ƒâ€ (Semantic Canvas)**ã€‚

### 4.1 æ ¸å¿ƒåŸåˆ™ï¼šå›¾å³æ•°æ® (Diagram as Data)
*   **åŸºç¡€å±‚**: é‡‡ç”¨æˆç†Ÿçš„ç”»å¸ƒå¼•æ“ï¼ˆæ¨è **ReactFlow** ç”¨äºé€»è¾‘æµï¼Œ**Tldraw** ç”¨äºè‡ªç”±è‰å›¾/æ€ç»´å¯¼å›¾ï¼‰ã€‚
*   **è¯­ä¹‰å±‚**: æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰å’Œè¿çº¿ï¼ˆEdgeï¼‰èƒŒåéƒ½å¿…é¡»ç»‘å®šä¸€ä¸ª **Spec ID**ã€‚
    *   ç”»ä¸€ä¸ªçŸ©å½¢ -> åå°ç”Ÿæˆä¸€ä¸ª `UserStory` å¯¹è±¡ã€‚
    *   ç”»ä¸€æ¡è¿çº¿ -> åå°ç”Ÿæˆä¸€ä¸ª `Relation` å¯¹è±¡ã€‚
*   **æ‹’ç»çº¯å›¾å½¢**: ä¸å…è®¸å­˜åœ¨â€œæ²¡æœ‰å«ä¹‰çš„å›¾å½¢â€ã€‚å¦‚æœç”¨æˆ·ç”»äº†ä¸€ä¸ªåœ†ï¼Œç³»ç»Ÿå¿…é¡»é—®ï¼šâ€œè¿™æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯å¼€å§‹èŠ‚ç‚¹ï¼Œè¿˜æ˜¯æŸä¸ªå®ä½“ï¼Ÿâ€

### 4.2 ä¸ºä»€ä¹ˆå¿…é¡»åšç”»å¸ƒï¼Ÿ
1.  **æ€ç»´çš„ç¼“å†²åŒº**: å‰ç«¯å¼€å‘è€…åœ¨â€œç¿»è¯‘â€éœ€æ±‚æ—¶ï¼Œéœ€è¦ä¸€ä¸ªåœ°æ–¹æ•´ç†æ€è·¯ã€‚æ€ç»´å¯¼å›¾æ˜¯æœ€å¥½çš„ User Story æ‹†è§£å·¥å…·ã€‚
2.  **æ²Ÿé€šçš„ä»‹è´¨**: æœªæ¥äº§å“ç»ç†ä»‹å…¥æ—¶ï¼Œä»–ä»¬çœ‹ä¸æ‡‚ä»£ç ï¼Œä½†çœ‹æ‡‚æµç¨‹å›¾ã€‚ç”»å¸ƒæ˜¯ PM å’Œ FE çš„é€šç”¨è¯­è¨€ã€‚
3.  **æ„å›¾çš„ç´¢å¼•**: å½“éœ€æ±‚å˜å¤šæ—¶ï¼Œåˆ—è¡¨è§†å›¾ä¼šå¤±æ•ˆã€‚ç”»å¸ƒæä¾›äº†å¤©ç„¶çš„ç©ºé—´ç´¢å¼•ï¼ˆSpatial Indexingï¼‰ã€‚

### 4.3 å®æ–½è·¯çº¿
1.  **Phase 1: è‡ªç”±ç»˜å›¾ + æ ‡æ³¨**: å…ˆé›†æˆ Tldrawï¼Œå…è®¸ç”¨æˆ·è‡ªç”±ç”»å›¾ï¼Œç„¶åç”¨â€œæ ‡æ³¨æ¡†â€åœˆé€‰å†…å®¹å¹¶å…³è”åˆ° Specã€‚
2.  **Phase 2: ç»“æ„åŒ–èŠ‚ç‚¹**: å¼•å…¥ ReactFlowï¼Œæä¾›æ ‡å‡†çš„ User Story Node å’Œ Logic Nodeï¼Œå¼ºåˆ¶ç»“æ„åŒ–è¿çº¿ã€‚
3.  **Phase 3: åŒå‘åŒæ­¥**: ç”»å¸ƒä¸Šçš„ä¿®æ”¹å®æ—¶åŒæ­¥åˆ° Markdown Specï¼Œåä¹‹äº¦ç„¶ã€‚

### 4.4 åŒå¼•æ“ååŒç­–ç•¥ (The Dual-Engine Strategy)

ReactFlow å’Œ Tldraw å„æœ‰åƒç§‹ï¼Œæˆ‘ä»¬é‡‡ç”¨ **â€œåˆ†å±‚æ²»ç†ï¼Œæ¸è¿›å½¢å¼åŒ–â€** çš„ç­–ç•¥å°†äºŒè€…ç»“åˆã€‚

#### A. è§’è‰²åˆ†å·¥ (Role Separation)
*   **L0 åˆ›æ„å±‚ (The Whiteboard - Tldraw)**:
    *   *å®šä½*: **"Messy & Free"**ã€‚
    *   *åœºæ™¯*: è„‘æš´ã€ç”»è‰å›¾ã€è´´ä¾¿åˆ©è´´ã€ç»˜åˆ¶ç²—ç³™çš„ User Journey Mapã€‚
    *   *æ•°æ®*: å­˜å‚¨ä¸ºéç»“æ„åŒ–çš„ JSONï¼Œä½†æ”¯æŒé€šè¿‡â€œæ™ºèƒ½åœˆé€‰â€æå–è¯­ä¹‰ã€‚
*   **L1/L2 é€»è¾‘å±‚ (The Blueprint - ReactFlow)**:
    *   *å®šä½*: **"Strict & Executable"**ã€‚
    *   *åœºæ™¯*: ç¼–æ’ Logic Flowã€å®šä¹‰çŠ¶æ€æœºã€è¿æ¥ Domain å®ä½“å…³ç³»ã€‚
    *   *æ•°æ®*: ç›´æ¥æ˜ å°„åˆ° `IntentRule` å’Œ `Domain Schema`ï¼Œå¼ºç±»å‹çº¦æŸã€‚

#### B. æ¡¥æ¥æœºåˆ¶ï¼šæ¸è¿›å½¢å¼åŒ– (The Formalization Bridge)
å¦‚ä½•ä» Tldraw è¿‡æ¸¡åˆ° ReactFlowï¼Ÿæˆ‘ä»¬è®¾è®¡äº† **â€œè½¬åŒ– (Morphing)â€** åŠ¨ä½œã€‚

1.  **åœˆé€‰å³å®šä¹‰ (Select to Define)**:
    *   ç”¨æˆ·åœ¨ Tldraw ä¸­ç”»äº†ä¸€ä¸ªæ–¹æ¡†ï¼Œé‡Œé¢å†™äº†â€œè®¢å•åˆ—è¡¨â€ã€‚
    *   æ“ä½œï¼šå³é”® -> "Formalize as UI Node"ã€‚
    *   ç»“æœï¼šç³»ç»Ÿåœ¨åå°åˆ›å»ºäº†ä¸€ä¸ª `UIIntentNode`ã€‚
2.  **æ— ç¼åˆ‡æ¢ (Seamless Switch)**:
    *   ç”¨æˆ·ç‚¹å‡» "Switch to Logic View" (è¿›å…¥ ReactFlow æ¨¡å¼)ã€‚
    *   åˆšæ‰é‚£ä¸ªâ€œè®¢å•åˆ—è¡¨â€æ–¹æ¡†å˜æˆäº†ä¸€ä¸ªæ ‡å‡†çš„ ReactFlow èŠ‚ç‚¹ï¼Œæ‹¥æœ‰äº†è¾“å…¥è¾“å‡ºç«¯å£ï¼ˆPortsï¼‰ã€‚
3.  **åŒå‘é”šç‚¹ (Bidirectional Anchors)**:
    *   åœ¨ ReactFlow ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œçš„é€»è¾‘è¿çº¿ï¼Œä¼šåœ¨ Tldraw ä¸­æ˜¾ç¤ºä¸ºâ€œéšå«çš„å…³è”çº¿â€ï¼ˆè™šçº¿ï¼‰ï¼Œæç¤ºç”¨æˆ·è¿™äº›è‰å›¾å…ƒç´ åœ¨é€»è¾‘ä¸Šæ˜¯ç›¸è¿çš„ã€‚

#### C. è§†å›¾é›†æˆï¼šç”»ä¸­ç”»ä¸é’»å– (PIP & Drill-down)
æ‚¨çš„ç›´è§‰éå¸¸å‡†ç¡®ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬è®¾è®¡çš„æ ¸å¿ƒäº¤äº’æ¨¡å¼ï¼š

1.  **ç¼©ç•¥å›¾æ¨¡å¼ (Thumbnail Mode)**:
    *   åœ¨ ReactFlow ç”»å¸ƒä¸­ï¼Œ`UIIntentNode` ä¸æ¸²æŸ“æ²‰é‡çš„ Tldraw ç¼–è¾‘å™¨ï¼Œè€Œæ˜¯æ¸²æŸ“ä¸€å¼  **SVG/Image å¿«ç…§**ã€‚
    *   *è§†è§‰*: çœ‹èµ·æ¥åƒä¸€å¼ ç¼©ç•¥å›¾å¡ç‰‡ï¼Œä¸Šé¢æœ‰è¾“å…¥è¾“å‡ºç«¯å£ï¼ˆç”¨äºè¿æ¥ Logicï¼‰ã€‚
2.  **æ²‰æµ¸ç¼–è¾‘æ¨¡å¼ (Immersive Edit Mode)**:
    *   *äº¤äº’*: **åŒå‡»** ReactFlow ä¸­çš„ `UIIntentNode`ã€‚
    *   *å“åº”*: å¼¹å‡ºä¸€ä¸ªå…¨å±æ¨¡æ€æ¡†ï¼ˆæˆ–ä¾§è¾¹æŠ½å±‰ï¼‰ï¼ŒåŠ è½½ **Tldraw ç¼–è¾‘å™¨**ã€‚
    *   *æ“ä½œ*: ç”¨æˆ·åœ¨è¿™é‡Œç²¾ç»†ç»˜åˆ¶ UI è‰å›¾ã€‚å…³é—­åï¼Œè‡ªåŠ¨æ›´æ–° ReactFlow ä¸­çš„ç¼©ç•¥å›¾ã€‚
3.  **æ•°æ®ä¸€è‡´æ€§**:
    *   ReactFlow èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯ `specId`ã€‚
    *   Tldraw å­˜å‚¨çš„æ˜¯è¯¥ `specId` å¯¹åº”çš„ `canvasData`ã€‚
    *   äºŒè€…é€šè¿‡ Spec ID å®æ—¶åŒæ­¥ã€‚

### 4.5 å¤šæ¨¡æ€å½¢å¼åŒ–å¼•æ“ (The Multimodal Formalization Engine)

æ­£å¦‚æ‚¨æ‰€è§ï¼Œä»â€œä¹±æ¶‚ä¹±ç”»â€åˆ°â€œç»“æ„åŒ–æ•°æ®â€çš„é£è·ƒï¼Œå¿…é¡»ä¾èµ– **LLM çš„å¤šæ¨¡æ€èƒ½åŠ› (Vision)**ã€‚

#### A. è§†è§‰è§£ææµç¨‹ (Vision-to-Spec Pipeline)
å½“ç”¨æˆ·åœ¨ Tldraw ä¸­åœˆé€‰å¹¶ç‚¹å‡» "Formalize" æ—¶ï¼Œåå°å‘ç”Ÿä»¥ä¸‹è¿‡ç¨‹ï¼š
1.  **å¿«ç…§æˆªå–**: ç³»ç»Ÿæˆªå–åœˆé€‰åŒºåŸŸçš„å›¾ç‰‡ï¼ˆPNGï¼‰ã€‚
2.  **è§†è§‰ç†è§£**: å‘é€ç»™å¤šæ¨¡æ€å¤§æ¨¡å‹ï¼ˆå¦‚ Gemini 2.5 Pro / GPT-4oï¼‰ï¼ŒPrompt: *"Analyze this UI sketch. Identify components, layout, and potential user interactions."*
3.  **ç»“æ„åŒ–æå–**: æ¨¡å‹è¿”å› JSON æ ¼å¼çš„ç»„ä»¶æ ‘æè¿°ã€‚
4.  **Spec ç”Ÿæˆ**: å¹³å°å°† JSON è½¬æ¢ä¸º `UIIntentNode` å’Œ `LogicIntentNode`ã€‚

#### B. æ™ºèƒ½æ¨æ–­ (Intelligent Inference)
å¤šæ¨¡æ€ä¸ä»…èƒ½è¯†åˆ«â€œæ˜¯ä»€ä¹ˆâ€ï¼Œè¿˜èƒ½æ¨æ–­â€œç¼ºä»€ä¹ˆâ€ï¼š
*   **äº¤äº’æ¨æ–­**: è¯†åˆ«å‡ºç”»äº†ä¸€ä¸ªâ€œæœç´¢å›¾æ ‡â€ï¼Œè‡ªåŠ¨ç”Ÿæˆ `User Story: ç”¨æˆ·å¯ä»¥é€šè¿‡å…³é”®å­—æœç´¢...`ã€‚
*   **å­—æ®µæ¨æ–­**: è¯†åˆ«å‡ºç”»äº†ä¸€ä¸ªâ€œè¡¨æ ¼â€ï¼Œè‡ªåŠ¨æ ¹æ®è¡¨å¤´æ–‡å­—æ¨æ–­ `Domain Schema`ã€‚

#### C. æŒç»­æ ¡å‡† (Continuous Calibration)
*   å¦‚æœ AI è¯†åˆ«é”™äº†ï¼ˆæ¯”å¦‚æŠŠæŒ‰é’®è¯†åˆ«æˆäº†æ ‡ç­¾ï¼‰ï¼Œç”¨æˆ·å¯ä»¥åœ¨ç”Ÿæˆçš„ ReactFlow èŠ‚ç‚¹å±æ€§ä¸­ä¿®æ­£ã€‚
*   ä¿®æ­£åçš„æ•°æ®ä¼šä½œä¸º **Few-Shot æ ·æœ¬** åé¦ˆç»™ä¸‹ä¸€æ¬¡è¯†åˆ«ï¼Œè®© Spec Studio è¶Šç”¨è¶Šæ‡‚ä½ çš„ç”»é£ã€‚

### 2.9 æ ¸å¿ƒå“²å­¦ï¼šæ‹†è§£ä¼˜å…ˆ (Decomposition-First)

æˆ‘ä»¬æ·±åˆ»è®¤è¯†åˆ°ï¼Œ**Spec Studio çš„æ ¸å¿ƒä»·å€¼ä¸æ˜¯â€œæ— ä¸­ç”Ÿæœ‰â€çš„åˆ›é€ ï¼Œè€Œæ˜¯å¯¹å·²æœ‰æ–¹æ¡ˆçš„â€œæ‹†è§£ä¸è¿½è¸ªâ€**ã€‚
äº§å“ç»ç†çš„æ€è€ƒï¼ˆBackground/Solutionï¼‰å‘ç”Ÿåœ¨å¤§è„‘æˆ–å¤–éƒ¨æ–‡æ¡£ä¸­ï¼ŒSpec Studio çš„ä»»åŠ¡æ˜¯æ¥æ‰‹è¿™ä¸ªâ€œæ–¹æ¡ˆâ€ï¼Œå°†å…¶æ‹†è§£ä¸ºå¯æ‰§è¡Œçš„é¢—ç²’åº¦ã€‚

#### 1.1 æ‹†è§£å·¥ä½œæµ (The Decomposition Workflow)

> **Progressive Constraint**: æ‹†è§£ä¸æ˜¯ä¸€è¹´è€Œå°±çš„ã€‚ç³»ç»Ÿå…è®¸ç”¨æˆ·åœ¨æ—©æœŸä¿æŒæ¨¡ç³Š (Epic/Sketch)ï¼Œä»…åœ¨è¿›å…¥å‡ºç é˜¶æ®µå‰å¼ºåˆ¶è¦æ±‚ Story/Task çš„å®Œæ•´åº¦ã€‚

1.  **è¾“å…¥ (Ingest)**: ç”¨æˆ·ç²˜è´´å¤§æ®µçš„ PRDã€ä¼šè®®è®°å½•æˆ–æ–¹æ¡ˆæè¿°ã€‚
2.  **è¯†åˆ« (Identify)**: AI è¯†åˆ«å‡ºå…¶ä¸­çš„â€œå¤§çŸ³å¤´â€ (Epics/Features)ã€‚
3.  **æ‹†è§£ (Decompose)**:
    *   **é¢—ç²’åº¦æ§åˆ¶**: AI è¾…åŠ©å°† Feature æ‹†è§£ä¸º User Storyï¼Œå°† User Story æ‹†è§£ä¸º Taskã€‚
    *   **äººæœºåä½œ**: ç”¨æˆ·åœ¨ç”»å¸ƒä¸Šæ‹–æ‹½ã€åˆå¹¶ã€åˆ†å‰²è¿™äº›æ‹†è§£åçš„èŠ‚ç‚¹ã€‚
4.  **è¿½è¸ª (Trace)**: ç³»ç»Ÿå®æ—¶ç›‘æ§æ‹†è§£çš„å®Œæ•´æ€§ã€‚

### 1.2 è¦†ç›–ç‡ä¸å­¤å²›æ£€æµ‹ (Coverage & Island Detection)

> **Alert Levels**:
> *   **Info (Gray)**: æ¢ç´¢é˜¶æ®µçš„æ¸©å’Œæç¤ºã€‚
> *   **Warn (Yellow)**: å‡†å¤‡é˜¶æ®µçš„å»ºè®®ã€‚
> *   **Blocker (Red)**: å‡ºç é˜¶æ®µçš„å¼ºåˆ¶é˜»æ–­ã€‚

*   **æœªè¦†ç›– (Uncovered)**: æ–¹æ¡ˆé‡Œæåˆ°â€œæ”¯æŒå¾®ä¿¡æ”¯ä»˜â€ï¼Œä½†æ²¡æœ‰å¯¹åº”çš„ User Storyã€‚
*   **å­¤å²› (Orphaned)**: æœ‰ä¸€ä¸ª User Story â€œç”¨æˆ·å¯ä»¥ä¿®æ”¹å¯†ç â€ï¼Œä½†æ²¡æœ‰å¯¹åº”çš„ Task æˆ– Logic å®ç°ã€‚
*   **é¢—ç²’åº¦è­¦æŠ¥ (Granularity Alert)**: æŸä¸ª Task è¿‡äºåºå¤§ï¼ˆå¦‚â€œå®ç°æ•´ä¸ªåå°â€ï¼‰ï¼Œç³»ç»Ÿå»ºè®®ç»§ç»­æ‹†è§£ã€‚

#### C. æ„å›¾è¯†åˆ«çš„è¾…åŠ©è§’è‰² (AI as Copilot)
AI ä¸æ˜¯æ›¿ä»£æ€è€ƒï¼Œè€Œæ˜¯**è¾…åŠ©æ‹†è§£**ã€‚
*   å®ƒè´Ÿè´£ä»æ–‡æœ¬ä¸­æå–å€™é€‰å¯¹è±¡ï¼ˆCandidate Objectsï¼‰ã€‚
*   å®ƒè´Ÿè´£æ£€æŸ¥é€»è¾‘æ¼æ´ï¼ˆGap Analysisï¼‰ã€‚
*   æœ€ç»ˆçš„**ç¡®è®¤ä¸ç¼–æ’**ç”±äººç±»ï¼ˆå‰ç«¯/äº§å“ï¼‰å®Œæˆã€‚

é€šè¿‡è¿™ç§å“²å­¦ï¼ŒSpec Studio æˆä¸ºäº†ä¸€ä¸ª**â€œæ–¹æ¡ˆè½åœ°æ˜¾å¾®é•œâ€**ï¼Œå¸®åŠ©å›¢é˜ŸæŠŠæ¨¡ç³Šçš„æ–¹æ¡ˆå˜æˆç²¾ç¡®çš„æ‰§è¡Œè·¯å¾„ã€‚


è¿™æ˜¯ Logix åŒºåˆ«äºæ‰€æœ‰â€œåŸå‹å·¥å…·â€çš„æ ¹æœ¬æ‰€åœ¨ï¼š**ç”»å¸ƒä¸ä»…æ˜¯ç”Ÿæˆå™¨ï¼Œæ›´æ˜¯è¿è¡Œæ—¶çš„â€œæ•°å­—å­ªç”Ÿ (Digital Twin)â€**ã€‚

#### 4.1 ä»£ç å³ç”»å¸ƒ (Code-to-Canvas)

> **Scope Constraint**: "Digital Twin" ä»…é’ˆå¯¹ **Logix DSL (Intent/Flow)** åŠå…¶æ ‡å‡† Patternï¼Œä¸è¯•å›¾è§£æä»»æ„ç”¨æˆ·æ‰‹å†™ä»£ç ã€‚

å¾—ç›Šäº **å…¨åŒå·¥è§£æå™¨ (Full-Duplex Parser)**ï¼Œä»£ç çš„ä»»ä½•å˜åŠ¨éƒ½ä¼šå®æ—¶æ˜ å°„å›ç”»å¸ƒã€‚
*   **åœºæ™¯**: å¼€å‘è€…åœ¨ VSCode ä¸­ä¿®æ”¹äº† `user.flow.ts`ï¼Œå¢åŠ äº†ä¸€ä¸ª `Effect.retry` æ­¥éª¤ã€‚
*   **æ¸²æŸ“**: ReactFlow ç”»å¸ƒè‡ªåŠ¨åˆ·æ–°ï¼Œå¯¹åº”çš„ Logic Node ä¸Šå¤šå‡ºäº†ä¸€ä¸ªâ€œé‡è¯•â€å›¾æ ‡/åˆ†æ”¯ã€‚

#### B. è¿è¡Œæ—¶å¯è§†åŒ– (Runtime Visualization)
å› ä¸º Logix Runtime (Effect) æ˜¯å¼ºç»“æ„çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿è¡Œæ—¶çŠ¶æ€æŠ•å°„åˆ°ç”»å¸ƒä¸Šã€‚
1.  **æ‰§è¡Œé«˜äº®**: å½“æœ¬åœ°è°ƒè¯•è¿è¡Œæ—¶ï¼ŒReactFlow ä¸­çš„è¿çº¿ä¼šéšç€ä»£ç æ‰§è¡Œä¾æ¬¡é«˜äº®ï¼ˆç±»ä¼¼ç”µè·¯å›¾é€šç”µï¼‰ã€‚
2.  **é”™è¯¯å›æ˜¾**: å¦‚æœæŸä¸ª Effect æŠ›å‡ºäº† Errorï¼Œç”»å¸ƒä¸Šå¯¹åº”çš„èŠ‚ç‚¹ä¼šå˜çº¢ï¼Œå¹¶æ˜¾ç¤ºé”™è¯¯å †æ ˆã€‚
3.  **çƒ­æ•°æ®å¡«å……**: å¯ä»¥åœ¨ Tldraw çš„ UI è‰å›¾ä¸­ï¼Œç›´æ¥å¡«å…… Runtime é‡Œçš„çœŸå® Mock æ•°æ®ï¼Œé¢„è§ˆâ€œæœ‰æ•°æ®çš„è‰å›¾â€ã€‚

#### C. æ¶æ„å®ˆå« (Architecture Guard)
å¦‚æœå¼€å‘è€…åœ¨ä»£ç é‡Œå†™äº†â€œè¿è§„ä»£ç â€ï¼ˆä¾‹å¦‚ç»•è¿‡ Service ç›´æ¥è°ƒ APIï¼‰ï¼ŒParser ä¼šè¯†åˆ«å‡ºè¿™ä¸ªâ€œæœªçŸ¥è°ƒç”¨â€ï¼Œå¹¶åœ¨ç”»å¸ƒä¸Šæ¸²æŸ“ä¸€æ¡**çº¢è‰²çš„è™šçº¿**ï¼Œæ ‡è®°ä¸ºâ€œéæ³•è·¯å¾„ (Illegal Path)â€ï¼Œå¼ºåˆ¶å¼€å‘è€…åœ¨è§†è§‰ä¸Šç›´é¢æ¶æ„è…åŒ–ã€‚

### 5. å‡ºç ç­–ç•¥ï¼šG3C (Granular Generation, Global Context)

é’ˆå¯¹â€œEpic æ•´ä½“å‡ºç â€è¿˜æ˜¯â€œTask é€ä¸ªå‡ºç â€çš„æŠ‰æ‹©ï¼Œæˆ‘ä»¬é‡‡ç”¨ **G3C ç­–ç•¥**ï¼š**é¢—ç²’åº¦ç”Ÿæˆï¼Œå…¨å±€ä¸Šä¸‹æ–‡**ã€‚

#### A. ä¸ºä»€ä¹ˆä¸æ¨è Epic æ•´ä½“å‡ºç ï¼Ÿ
*   **ä¸Šä¸‹æ–‡æº¢å‡º**: ä¸€ä¸ª Epic å¯èƒ½åŒ…å«å‡ åä¸ªæ–‡ä»¶ï¼ŒLLM ä¸€æ¬¡æ€§ç”Ÿæˆå®¹æ˜“ä¸¢å¤±ç»†èŠ‚æˆ–äº§ç”Ÿå¹»è§‰ã€‚
*   **è°ƒè¯•å›°éš¾**: ä¸€æ¬¡æ€§ç”Ÿæˆ 1000 è¡Œä»£ç ï¼Œå¦‚æœè·‘ä¸é€šï¼Œæ’æŸ¥æˆæœ¬æé«˜ã€‚
*   **å¿ƒç†è´Ÿæ‹…**: ç”¨æˆ·ä¸æ•¢è½»æ˜“ç‚¹å‡»â€œç”Ÿæˆâ€ï¼Œå› ä¸ºå›æ»šæˆæœ¬å¤ªé«˜ã€‚

#### B. æ¨èè·¯å¾„ï¼šTask/Story çº§æ¸è¿›å¼ç”Ÿæˆ
1.  **åŸå­åŒ–å•å…ƒ**: æœ€å°å‡ºç å•å…ƒæ˜¯ **Task (L0.5)** æˆ– **User Story (L0)**ã€‚
    *   ä¾‹å¦‚ï¼šåªç”Ÿæˆâ€œåˆ›å»ºè®¢å•â€è¿™ä¸€ä¸ª Flowï¼Œè€Œä¸æ˜¯ç”Ÿæˆæ•´ä¸ªè®¢å•ç³»ç»Ÿã€‚
2.  **å…¨å±€ä¸Šä¸‹æ–‡æ³¨å…¥ (Global Context Injection)**:
    *   è™½ç„¶åªç”Ÿæˆä¸€ä¸ª Taskï¼Œä½† Prompt ä¼šæ³¨å…¥ **Epic çº§åˆ«çš„å…ƒæ•°æ®**ï¼ˆDomain Schemaã€å…¬å…±å·¥å…·ç±»ã€æ¶æ„è§„èŒƒï¼‰ã€‚
    *   ç¡®ä¿ç”Ÿæˆçš„å±€éƒ¨ä»£ç ç¬¦åˆå…¨å±€è§„èŒƒï¼Œä¸ä¼šäº§ç”Ÿâ€œæ–¹è¨€â€ã€‚
3.  **ä¾èµ–æ„ŸçŸ¥**:
    *   å¦‚æœ Task B ä¾èµ– Task Aï¼Œç³»ç»Ÿä¼šæç¤ºâ€œå»ºè®®å…ˆç”Ÿæˆ Task Aâ€ã€‚

#### C. æ‰¹é‡æ¨¡å¼ (Batch Mode)
å¯¹äºç†Ÿç»ƒç”¨æˆ·ï¼Œæ”¯æŒâ€œå‹¾é€‰å¤šä¸ª Taskâ€è¿›è¡Œæ‰¹é‡ç”Ÿæˆã€‚
*   ç³»ç»Ÿå†…éƒ¨ä¾ç„¶æ˜¯**ä¸²è¡Œæˆ–å¹¶è¡Œåœ°ç‹¬ç«‹ç”Ÿæˆ**æ¯ä¸ª Taskï¼Œæœ€åè¿›è¡Œä»£ç åˆå¹¶ã€‚
*   è¿™æ—¢ä¿ç•™äº†æ•ˆç‡ï¼Œåˆè§„é¿äº†ä¸Šä¸‹æ–‡æº¢å‡ºçš„é£é™©ã€‚

ç»“è®ºï¼š**åƒæ­ç§¯æœ¨ä¸€æ ·å‡ºç ï¼Œè€Œä¸æ˜¯åƒ 3D æ‰“å°ä¸€æ ·ä¸€æ¬¡æˆå‹ã€‚**






*   **Pattern æ¨è**: å¦‚æœ Spec æåˆ°â€œå®¡æ‰¹æµç¨‹â€ï¼ŒAgent ä¼šå»ºè®®å¯¼å…¥ `ApprovalFlow` Patternã€‚
*   **Domain æ£€æŸ¥**: å¦‚æœ Spec æåˆ°â€œç”¨æˆ·â€ï¼ŒAgent ä¼šæ£€æŸ¥å·¥ä½œåŒºä¸­æ˜¯å¦å·²å­˜åœ¨ `User` Domain å¹¶å»ºè®®å¤ç”¨ã€‚
</file>

<file path="drafts/index.md">
# Drafts Index

> **Note**: This index tracks the status and location of all drafts in the `docs/specs/drafts` tiered system.

## Topics (Consolidated)

### AI Native & API

- [AI Native Core](./topics/ai-native-core)
- [AI Native UI](./topics/ai-native-ui)
- [API Evolution](./topics/api-evolution)

### Platform & Patterns

- [Platform Vision](./topics/platform-vision)
- [Platform Patterns](./topics/platform-patterns)
- [Draft Pattern](./topics/draft-pattern)

### Runtime & Data

- [Query Integration](./topics/query-integration) - Logix + Query/å¼‚æ­¥æ•°æ®ç®¡ç†é›†æˆï¼ˆä¸‰å±‚ APIã€Reactive Schema ç­‰ï¼‰

### React & Studio

- [React Adapter](./topics/react-adapter)
- [Spec Studio](./topics/spec-studio)

## Tiered Drafts

### L1 (Stable Candidates)
*(None)*

### L2 (Refining)
*(None)*

### L3 (Structured)

*(None)*

### L4 (Defined)
*(None)*

### L5 (Comparative)

*   [Logix Runtime Core Evolution](./L5/runtime-core-evolution.md) - æ•´åˆè§‚æµ‹æ€§é‡æ„ã€è§„èŒƒè¾¹ç•Œä¼˜åŒ–ã€Runtime é€‚é…æ‰©å±•ä¸‰ä¸ªç»´åº¦çš„æ¼”è¿›è·¯çº¿
*   [Logix DSL Evolution Roadmap](./L5/dsl-evolution-roadmap.md) - æ•´åˆ Sugar å¯èƒ½æ€§æ„¿æ™¯ä¸ Env-First API è®¾è®¡çš„ DSL æ¼”è¿›æ–¹å‘

### L6 (Exploratory)
*(None)*

### L7 (Fragments)
*(None)*

### L8 (Transient)
*(None)*

### L9 (Raw Ideas)

*   [DSL Sugar & Concurrency Safety](./L9/dsl-sugar-and-concurrency.md) - Flow.run é»˜è®¤è¯­ä¹‰ä¸å¹¶å‘ API æ¼”è¿›
*   [Dynamic List Form Pattern](./L9/dynamic-list-form-pattern.md) - å¤æ‚åŠ¨æ€åˆ—è¡¨è¡¨å•æ”¯æ’‘æ–¹æ¡ˆ
*   [Matrix Acceptance Logix Support](./L9/matrix-acceptance-logix-support.md) - çŸ©é˜µéªŒæ”¶è¯¦æƒ…é¡µå¤æ‚é€»è¾‘æ”¯æ’‘
*   [Poisoned Effect Pattern](./L9/poisoned-effect-pattern.md) - æ¶æ„é˜²å¾¡ï¼šæ¯’è¯ Effect æ¨¡å¼
*   [Logix Unified Middleware](./L9/logix-unified-middleware.md) - ç»Ÿä¸€ä¸­é—´ä»¶æ¶æ„ï¼ˆå¾…æ‰©å……åæå‡ï¼‰
*   [Runtime Logix Core Gaps & Production Readiness](./L9/runtime-logix-core-gaps-and-production-readiness.md) - æ±‡æ€»å½“å‰ v3 Core åœ¨æ¥è¿‘ç”Ÿäº§å¯ç”¨å‰ä»éœ€è¡¥é½çš„å…³é”®ç¼ºå£ä¸ä¼˜å…ˆçº§æ’åº
*   [Page Level Module State Retention](./L9/page-level-module-state-retention.md) - æ¢è®¨é¡µé¢çº§æ¨¡å—çš„çŠ¶æ€ä¿æŒä¸ä¼˜é›…å®ç°ï¼ˆé¿å…å…¨å±€ Module çˆ†ç‚¸ï¼‰
*   [Fractal Runtime Architecture](./L9/fractal-runtime-architecture.md) - åˆ†æåˆ†å½¢è¿è¡Œæ—¶æ¦‚å¿µï¼Œè¯„ä¼°å¹¶æ”¶æŸ Logix ä½“ç³»è®¾è®¡ï¼ˆåºŸå¼ƒ Logix.appï¼Œç»Ÿä¸€ Module/Runtimeï¼‰
*   [Resource Field: Unified Data Plane](./L9/resource-field-unified-data-plane.md) - å°è¯•ç”¨ ResourceField æŠ½è±¡ç»Ÿä¸€ Query/Socket/AI ç­‰â€œæœ‰æ¥æºå­—æ®µâ€çš„æ•°æ®å¹³é¢
*   [Form Session & Draft Pattern Convergence](./L9/form-session-draft-pattern-convergence.md) - å°† Draft Pattern æ”¶ç¼©ä¸ºè¡¨å•é¢†åŸŸçš„ Form/Wizard Session èƒ½åŠ›çš„æ”¶æ•›è‰æ¡ˆ
*   [React LiveComponent Host PoC](./L9/react-live-component-host-poc.md) - åœ¨ examples/logix-react ä¸­å°è¯• LiveComponent Host åŸå‹ä»¥éªŒè¯ AI Native UI è¿è¡Œæ—¶æ¥å£
*   [Platform Patterns as Flow Templates](./L9/platform-patterns-as-flow-templates.md) - å°†å¹³å° Pattern æ”¶ç´§ä¸º BoundApi/Flow æ¨¡æ¿ä¸å…ƒæ•°æ®ï¼Œè€Œéç¬¬äºŒå¥—è¿è¡Œæ—¶
*   [Builder & Studio Roadmap Alignment](./L9/builder-studio-roadmap-alignment.md) - ä» Generative Language Server/Spec Studio ä¸­æç‚¼ Builder çš„è¿‘æœŸå¯è½åœ°è·¯çº¿

## Recently Organized (2025-12-02)

### Elevated

- L9 â†’ L3: `logix-react-feature-and-hook-design.md`
- L9 â†’ L5: `runtime-core-evolution.md` (åˆå¹¶ 3 ç¯‡)
- L9 â†’ L5: `dsl-evolution-roadmap.md` (åˆå¹¶ 2 ç¯‡)

### Topic Collection

- **query-integration** (æ–°å»º): æ”¶ç¼– 5 ç¯‡ Query ç›¸å…³è‰ç¨¿
- **react-adapter**: è¡¥å…… ModuleImpl è®¾è®¡
- **platform-vision**: è¡¥å…… JSON/Intent æ–¹æ¡ˆ

### Superseded/Merged

- `logix-instrumentation-overhaul.md` â†’ superseded by L5/runtime-core-evolution.md
- `runtime-logix-spec-adjustments.md` â†’ superseded by L5/runtime-core-evolution.md
- `module-runtime-adapter-and-customization.md` â†’ superseded by L5/runtime-core-evolution.md
- `logix-sugar-possibilities.md` â†’ superseded by L5/dsl-evolution-roadmap.md
- `logic-for-shape-env-first-roadmap.md` â†’ superseded by L5/dsl-evolution-roadmap.md
- `logix-query-unified-api-design.md` â†’ moved to topics/query-integration
- `logix-query-integration-strategies.md` â†’ moved to topics/query-integration
- `logix-module-computed-query.md` â†’ moved to topics/query-integration
- `logix-reactive-schema.md` â†’ merged to topics/query-integration
- `logix-reactive-module-integration.md` â†’ merged to topics/query-integration
- `platform-json-runtime-separation.md` â†’ moved to topics/platform-vision
- `intent-dev-api-and-dollars.md` â†’ moved to topics/platform-vision
</file>

<file path="drafts/README.md">
# Logix Drafts & Topics

> **Status**: Experimental / Incubating
> **Context**: `v3/ai-native`

è¿™é‡Œå­˜æ”¾ Logix çš„æ‰€æœ‰è‰ç¨¿æ–‡æ¡£ã€‚

## 1. Topics (Consolidated Drafts)

æŒ‰ç‰¹å®šä¸»é¢˜æ•´ç†çš„ã€ç›¸å¯¹å®Œæ•´çš„è‰ç¨¿é›†åˆã€‚

- **[AI-Native UI](./topics/ai-native-ui/00-architecture-overview.md)**
  - æ ¸å¿ƒæ¶æ„ï¼šIntent <-> Code å…¨åŒå·¥é“¾è·¯ (Skeleton, Live Component)ã€‚
- **[AI-Native Core](./topics/ai-native-core/00-architecture.md)**
  - æ ¸å¿ƒæ¶æ„ï¼šåŸºäº Effect AI çš„è¿è¡Œæ—¶åº•åº§ã€‚
- **[Draft Pattern](./topics/draft-pattern/00-design.md)**
  - äº¤äº’çŠ¶æ€ç®¡ç†è®¾è®¡ã€‚
- **[React Adapter](./topics/react-adapter/README.md)**
  - React é›†æˆå±‚ã€‚
- **[Platform Vision](./topics/platform-vision/00-generative-language-server.md)**
  - é•¿æœŸæ„¿æ™¯ä¸åˆ†æã€‚
- **[API Evolution](./topics/api-evolution/next-gen-killer-apis.md)**
  - æœªæ¥ API ææ¡ˆã€‚
- **[Platform Patterns](./topics/platform-patterns/generative-patterns-refined.md)**
  - ç”Ÿæˆå¼æ¨¡å¼ã€‚
- **[Spec Studio](./topics/spec-studio/00-design.md)**
  - å¯è§†åŒ– Spec ç¼–è¾‘å™¨ã€‚

## 2. Tiered Drafts (L1~L9)

æŒ‰æˆç†Ÿåº¦åˆ†çº§çš„è‰ç¨¿ä½“ç³»ï¼ˆç”¨äºæ–°æƒ³æ³•å­µåŒ–ï¼‰ã€‚

*   **L1**: High Maturity (Baseline)
*   **L2**: Vision & Strategy
*   **L3**: Design Proposals
*   **L4**: Integration Specs
*   **L5**: Protocol & Architecture
*   **L6**: Workflow & Value
*   **L7**: Consolidated Architecture
*   **L8**: Research / Exploration
*   **L9**: Raw Ideas / Notes

> è¯¦ç»†åˆ†çº§è¯´æ˜è¯·å‚è€ƒ `.agent/skills/drafts-tiered-system/SKILL.md`ã€‚
</file>

<file path="intent-driven-ai-coding/v1/01-overview.md">
---
title: æ„å›¾é©±åŠ¨çš„å£°æ˜å¼ AI ç¼–ç ä½“ç³» Â· æ€»è§ˆï¼ˆv1 å¿«ç…§ï¼‰
status: archived
version: v1
supersededBy: ../v3
---

> æœ¬æ–‡æ˜¯ intent-driven-ai-coding v1 çš„ç²¾ç®€å¿«ç…§ï¼Œä»…ç”¨äºå¯¹ç…§ç†è§£æ—©æœŸæ€è·¯ä¸ v3 çš„å·®å¼‚ã€‚  
> å½“å‰ä¸€åˆ‡è§„èŒƒä¸å®ç°ä»¥ `v3` ä¸ºå‡†ï¼Œè¿™é‡Œæè¿°çš„æ¦‚å¿µå¦‚æœä¸ v3 å†²çªï¼Œä¸€å¾‹ä»¥ v3 ä¸ºå‡†ã€‚

## 1. v1 å½“æ—¶çš„å‰æå‡è®¾

- **LLM ä¼˜å…ˆ**ï¼šè®¤ä¸ºæ²¡æœ‰ LLMï¼Œè¿™å¥— Intent/Pattern/Template ä½“ç³»åªæ˜¯å¢åŠ è´Ÿæ‹…ï¼›çœŸæ­£ç›®æ ‡æ˜¯ç»™ LLM ä¸€æ¡ç¨³å®šâ€œè·‘é“â€ã€‚  
- **æ„å›¾å…ˆäºä»£ç **ï¼šå¸Œæœ›å¼€å‘è€…åªéœ€æŠŠä¸šåŠ¡è®²æ¸…æ¥šï¼Œå¹³å°+LLM å°†å…¶è½¬æˆç»“æ„åŒ– Intentï¼Œç„¶åå†è‡ªåŠ¨è¡”æ¥æ¨¡å¼ä¸ä»£ç éª¨æ¶ã€‚  
- **è¡Œä¸ºå±‚å•ç‹¬å»ºæ¨¡**ï¼šåŒºåˆ†â€œçŠ¶æ€/ç¼“å­˜â€ä¸â€œè¡Œä¸ºç¼–æ’â€ï¼Œå°è¯•ç”¨ Flow DSL + Effect ç¨‹åºä¸ºå¤æ‚è¡Œä¸ºå»ºç«‹ç‹¬ç«‹äº‹å®æºã€‚

è¿™äº›å‡è®¾åœ¨ v3 ä¸­å¤§å¤šè¢«ä¿ç•™ï¼Œåªæ˜¯æ‰¿è½½æ–¹å¼ä»ã€Œä¸€å † YAML + æ–‡æ¡£ã€å˜æˆäº†ã€ŒIntent/Flow DSL + Logix Engineã€çš„ç»Ÿä¸€è¿è¡Œæ—¶è§†è§’ã€‚

## 2. v1 çš„æ ¸å¿ƒä¸»å¼ ï¼ˆå¯¹æ¯” v3ï¼‰

- **ä¸‰å…ƒåˆ†å±‚ï¼šIntent / Pattern / Template**  
  - Intentï¼šè¡¨è¾¾ä¸šåŠ¡ç›®æ ‡ä¸åœºæ™¯ç»“æ„ï¼›  
  - Patternï¼šè¡¨è¾¾â€œè¿™ç±»åœºæ™¯é€šå¸¸æ€ä¹ˆè§£â€ï¼›  
  - Templateï¼šè¡¨è¾¾åœ¨å…·ä½“æŠ€æœ¯æ ˆä¸‹çš„è½åœ°å½¢å¼ã€‚  
  - v3 ä¸­ï¼Œè¿™ä¸‰è€…æ›´å¤šè¢«æŠ˜å è¿›ã€ŒIntent + Flow DSL + ä»£ç /æ–‡ä»¶ç»“æ„çº¦å®šã€ä¸­ï¼Œä¸å†å•ç‹¬ç»´æŠ¤å¤§é‡ YAMLã€‚

- **è¡Œä¸ºå±‚ SSoT æ”¾åœ¨ Effect ç¨‹åºä¸Š**  
  - v1 å¾ˆå¼ºè°ƒâ€œFlow AST â†’ Effect ç¨‹åºæ˜¯è¡Œä¸ºçœŸèº«â€ï¼Œä»£ç éª¨æ¶åªæ˜¯æŠ•å½±ï¼›  
  - v3 é‡Œè¿™ä¸€ç‚¹ç”± Logix/Effect è¿è¡Œæ—¶æ­£å¼æ‰¿æ¥ï¼Œä¸å†åœç•™åœ¨â€œè§„åˆ’å±‚â€ã€‚

## 3. éœ€è¦ä» v1 è®°ä½çš„ä¸œè¥¿

- Intent ä¸åªæ˜¯â€œé…ç½®â€ï¼Œè€Œæ˜¯ LLM å’Œäººç±»å…±åŒç»´æŠ¤çš„**ç»“æ„åŒ–éœ€æ±‚è½½ä½“**ï¼›  
- Pattern ä¸åªæ˜¯ç¤ºä¾‹ä»£ç ï¼Œè€Œæ˜¯â€œå¯è¢«é€‰æ‹©ä¸æ¯”è¾ƒçš„ç­–ç•¥é›†åˆâ€ï¼›  
- Flow/Effect ç¨‹åºæ˜¯è¡Œä¸ºçš„æœ€ç»ˆäº‹å®æºï¼Œå¹³å°/LLM åº”å›´ç»•å®ƒåšçº¦æŸä¸å¯è§†åŒ–ï¼Œè€Œä¸æ˜¯å›´ç»•æ•£è½çš„ Hook ä¸ useEffectã€‚

å…¶ä½™ç»†èŠ‚ï¼ˆå…·ä½“å­—æ®µã€YAML ç»“æ„ç­‰ï¼‰éƒ½åº”ä»¥ v3 ä¸­çš„æœ€æ–°è®¾è®¡ä¸ºå‡†ã€‚
</file>

<file path="intent-driven-ai-coding/v1/02-patterns-and-intents.md">
---
title: æ¨¡å¼åº“ä¸æ„å›¾èµ„äº§ï¼ˆv1 ç²¾ç®€ç‰ˆï¼‰
status: archived
version: v1
supersededBy: ../v3
---

> æœ¬æ–‡ä»…ä¿ç•™ v1 æ—¶ä»£å¯¹ Pattern / Intent çš„æ ¸å¿ƒå®šä¹‰ï¼Œä½œä¸ºä¸ v3 çš„æ¦‚å¿µå¯¹ç…§ã€‚å½“å‰ Pattern/Intent è§„èŒƒä»¥ `v3` ä¸ºå‡†ã€‚

## 1. Pattern åœ¨ v1 é‡Œçš„å®šä¹‰

åœ¨ v1 ä¸­ï¼Œä¸€ä¸ª Pattern è¢«ç†è§£ä¸ºï¼š

- æ¥è‡ªçœŸå®ä¸šåŠ¡çš„â€œé«˜é¢‘å¥—è·¯â€ï¼Œåœ¨å¤šä¸ªåœºæ™¯ä¸­å¤ç”¨ï¼›  
- å¯¹åº”ä¸€æ•´å¥— UI ç»“æ„ + çŠ¶æ€æ‹†åˆ† + æ•°æ®æµå†™æ³•ï¼Œè€Œä¸æ˜¯å•ä¸ªç»„ä»¶ï¼›  
- åŒæ—¶ç»™å‡ºâ€œé€‚ç”¨åœºæ™¯ / ä¸é€‚ç”¨åœºæ™¯ / å¸¸è§åæ¨¡å¼â€ã€‚

ç®€åŒ–åçš„å¿ƒæ™ºæ¨¡å‹ï¼š

- **ç»„ä»¶**ï¼šè§£å†³â€œæŸä¸ªå±€éƒ¨ UI æ€ä¹ˆé•¿â€çš„é—®é¢˜ï¼›  
- **Pattern**ï¼šè§£å†³â€œä¸€ç±»åœºæ™¯æ•´ä½“è¯¥æ€ä¹ˆæ‹†å’Œç¼–æ’â€çš„é—®é¢˜ï¼›  
- **Template**ï¼šPattern åœ¨å…·ä½“æŠ€æœ¯æ ˆä¸‹çš„ä¸€æ¬¡æ€§è½åœ°ã€‚

v3 ä¸­ä¸å†å¼ºè°ƒç‹¬ç«‹çš„ Pattern YAMLï¼Œä½†ä»æ²¿ç”¨ã€Œå…ˆé€‰è§£æ³•ï¼Œå†è½åœ°ä»£ç ã€çš„æ€è·¯ï¼Œåªæ˜¯æ‰¿è½½ä½ç½®è½¬ç§»åˆ° Flow/Intent/Logix ç»„åˆä¸Šã€‚

## 2. Intent åœ¨ v1 é‡Œçš„è§’è‰²

v1 æŠŠ Intent è§†ä¸ºï¼š

- **ç»“æ„åŒ–çš„éœ€æ±‚è¯´æ˜**ï¼šåŒ…å«ç›®æ ‡ (goals)ã€åœºæ™¯ç»“æ„ (scene)ã€é¢†åŸŸæ¨¡å‹ (domain)ã€å·²é€‰æ¨¡å¼ (patterns) ç­‰ï¼›  
- **LLM çš„ Prompt å®¹å™¨**ï¼šä¾¿äºæ¨¡å‹åŸºäºç»Ÿä¸€ Schema ç”Ÿæˆ Pattern å»ºè®®ã€Plan è‰ç¨¿ä¸ä»£ç éª¨æ¶ï¼›  
- **å›¢é˜Ÿçš„å…±è¯†æ–‡æ¡£**ï¼šå¯è§†åŒ–åœ°å±•ç°â€œè¿™ä¸ª feature æƒ³åšä»€ä¹ˆâ€å’Œâ€œé‡‡ç”¨äº†å“ªäº›é€šç”¨å¥—è·¯â€ã€‚

åœ¨ v3 ä¸­ï¼ŒIntent è¿›ä¸€æ­¥æ”¶æ•›åˆ°ä¸ Flow/Schema/Logix æ›´å¯†åˆ‡çš„ç»‘å®šï¼š  
åœºæ™¯ç»“æ„ã€è¡Œä¸ºæ­¥éª¤ã€æ•°æ®å¥‘çº¦æ›´å€¾å‘äºç›´æ¥è½åœ¨ Flow DSL ä¸è¿è¡Œæ—¶ä»£ç ä¸Šï¼Œè€Œä¸æ˜¯å¤§å— YAMLã€‚

## 3. v1 å¯¹åç»­ç‰ˆæœ¬ä»æœ‰å‚è€ƒä»·å€¼çš„ç‚¹

- æ˜ç¡®åŒºåˆ†â€œä¸šåŠ¡æ„å›¾ï¼ˆIntentï¼‰â€ä¸â€œå·¥ç¨‹è§£æ³•ï¼ˆPatternï¼‰â€ï¼Œé¿å…äºŒè€…æ··åœ¨ä¸€å¼ é…ç½®é‡Œï¼›  
- ä¸º Pattern ç»´æŠ¤ã€Œé€‚ç”¨æ€§è¯´æ˜ + roles + dataContractã€çš„åšæ³•ï¼Œæœ‰åŠ©äºæœªæ¥åœ¨ v3 ä¸­ç»§ç»­æ²‰æ·€â€œå¯é€‰è§£æ³•é›†åˆâ€ï¼›  
- æŠŠ Intent/Pattern/Template/Plan éƒ½è§†ä¸º LLM å¯è¯»å†™çš„ä¸€ç­‰èµ„äº§ï¼Œè€Œä¸æ˜¯å•å‘ç”Ÿæˆç‰©ã€‚
</file>

<file path="intent-driven-ai-coding/v1/08-flow-dsl-and-ast.md">
---
title: Flow DSL Â· AST Â· Effect ç¨‹åºï¼ˆv1 ç²¾ç®€ç‰ˆï¼‰
status: archived
version: v1
supersededBy: ../v3
---

> æœ¬æ–‡ä¿ç•™ v1 å¯¹ â€œFlow DSL â†’ AST â†’ Effect ç¨‹åºâ€ ä¸‰å±‚æ˜ å°„çš„æœ€å°è¯´æ˜ï¼Œä½œä¸ºå¯¹æ¯” v3 Logix/Flow è®¾è®¡çš„å‚è€ƒã€‚

## 1. ä¸‰å±‚ä¸€æ¡é“¾ï¼ˆv1 è§†è§’ï¼‰

åœ¨ v1 é‡Œï¼Œè¡Œä¸ºç›¸å…³â€œç¨‹åºâ€è¢«æ‹†æˆä¸‰å±‚ï¼š

```text
Intent.runtimeFlows (YAML Flow DSL)
        â†“ parse
FlowAstï¼ˆå†…å­˜ä¸­çš„ Flow æŠ½è±¡è¯­æ³•æ ‘ï¼‰
        â†“
Effect ç¨‹åºï¼ˆEffect<Env, E, A>ï¼‰
```

- **Flow DSLï¼ˆYAMLï¼‰**ï¼šé¢å‘å¹³å° UI çš„å£°æ˜å¼æµç¨‹æè¿°ï¼ˆtrigger + pipelineï¼‰ã€‚  
- **Flow AST**ï¼šå¹³å°å†…éƒ¨çš„ä¸­é—´ç»“æ„ï¼Œä¾¿äºæ ¡éªŒã€å¯è§†åŒ–å’Œè½¬æ¢ã€‚  
- **Effect ç¨‹åº**ï¼šå°† Flow AST æ˜ å°„ä¸º Effect/TS ä¸–ç•Œçš„çœŸæ­£å¯æ‰§è¡Œé€»è¾‘ï¼Œè¢«è§†ä¸ºè¡Œä¸ºå±‚ SSoTã€‚

v3 ä¸­ï¼Œè¿™æ¡é“¾è·¯æ›´å¤šè½åœ¨ã€ŒFlow DSL + Logix/Effect Runtimeã€çš„ä¸€ä½“åŒ–å®ç°ä¸Šï¼Œä½†â€œAST/ä¸­é—´è¡¨ç¤º + è¡Œä¸º SSoTâ€è¿™ä¸¤ä¸ªæƒ³æ³•ä»ç„¶é‡è¦ã€‚

## 2. ä¸€ä¸ªæœ€å°çš„ v1 Flow DSL ç¤ºä¾‹

```yaml
runtimeFlows:
  - id: exportOrders
    trigger:
      element: toolbar.exportButton
      event: click
    pipeline:
      - call: FilterService.getCurrentFilters
        as: filters
      - call: ExportService.submitExportTask
        params:
          filters: "{{filters}}"
```

å¯¹åº”çš„ç®€åŒ– AST å½¢å¼ï¼š

```ts
type FlowStep =
  | { _tag: 'Call'; service: string; method: string; as?: string; params?: Record<string, unknown> }

interface FlowAst {
  id: string
  trigger: { element: string; event: string }
  pipeline: FlowStep[]
}
```

ä»¥åŠä¸€ä¸ªå…¸å‹çš„ Effect ç¨‹åºæŠ•å½±ï¼ˆç¤ºæ„ï¼‰ï¼š

```ts
const exportOrdersFlow = (env: Env) =>
  Effect.gen(function* () {
    const filters = yield* env.FilterService.getCurrentFilters()
    yield* env.ExportService.submitExportTask({ filters })
  })
```

v3 ä¸­ Flow/Logix çš„è®¾è®¡å¯ä»¥è¢«è§†ä¸ºè¿™æ¡é“¾çš„æ¼”è¿›ç‰ˆæœ¬ï¼š  
Flow DSL æ›´ç»“æ„åŒ–ï¼ŒEffect/Logix ç¨‹åºæˆä¸ºç»Ÿä¸€è¿è¡Œæ—¶ï¼Œå¹¶ä¸”å’Œ Intent/Schema/Codegen å»ºç«‹äº†æ›´ç›´æ¥çš„æ˜ å°„å…³ç³»ã€‚
</file>

<file path="intent-driven-ai-coding/v1/09-llm-collaboration-and-intent-workflow.md">
---
title: LLM ååŒè§†è§’ä¸‹çš„æ„å›¾é©±åŠ¨å·¥ä½œæµï¼ˆv1 å¿«ç…§ï¼‰
status: archived
version: v1
supersededBy: ../v3
---

> è¯´æ˜ï¼šæœ¬ç¯‡ä¿ç•™çš„æ˜¯ v1 æ—¶ä»£å¯¹ã€ŒLLM åœ¨æ•´æ¡æµæ°´çº¿ä¸­æ‰®æ¼”ä»€ä¹ˆè§’è‰²ã€çš„æ—©æœŸç†è§£ã€‚  
> å½“å‰è®¾è®¡ä¸å®ç°ä¸€å¾‹ä»¥ v3 ä¸ºå‡†ï¼›è¿™é‡Œä»…ä½œä¸ºå¯¹ç…§ææ–™ï¼Œç”¨æ¥å¯¹æ¯” v3 çš„ Logix/Flow æ–¹æ¡ˆï¼Œä»¥åŠæŒ–æ˜ä»å¯èåˆçš„ç»†èŠ‚ã€‚

## 1. Intent ä½œä¸º LLM çš„ç»“æ„åŒ– Prompt

åœ¨ v1 è§†è§’ä¸‹ï¼ŒIntent çš„æ ¸å¿ƒä»·å€¼æ˜¯ï¼šä¸º LLM æä¾›ä¸€ä»½**ç»“æ„åŒ–ã€å¯è§£æçš„éœ€æ±‚æè¿°**ï¼Œè€Œä¸æ˜¯æ•£æ–‡å¼ promptã€‚

- å¯¹ LLM æ¥è¯´ï¼ŒIntent æ˜¯â€œå†™ä»£ç å‰çš„äº‹å®æºâ€ï¼ŒåŒ…å«ï¼šç›®æ ‡ (goals)ã€åœºæ™¯ç»“æ„ (scene)ã€é¢†åŸŸå®ä½“ä¸æ¥å£ (domain)ã€å·²é€‰æ¨¡å¼ (patterns) ç­‰ã€‚  
- å¯¹äººç±»æ¥è¯´ï¼ŒIntent æ˜¯éœ€æ±‚å…±è¯†æ–‡æ¡£ï¼Œæ—¢å¯ä»¥çº¯æ–‡æœ¬è®¨è®ºï¼Œä¹Ÿå¯ä»¥åœ¨ UI ä¸­ç¼–è¾‘ã€‚
- v3 å»¶ç»­äº†è¿™ä¸ªæ€è·¯ï¼Œåªæ˜¯å°† Intent æ›´ç´§åœ°ä¸ Flow DSL / Logix Engine ç»‘å®šï¼Œå¼±åŒ–äº†çº¯ YAML ä¸ºä¸­å¿ƒçš„å½¢æ€ã€‚

## 2. å››ç±»ä¸€ç­‰å·¥ä»¶ï¼ˆv1 çš„ä¸–ç•Œè§‚ï¼‰

ä» v1 çš„ LLM è§†è§’çœ‹ï¼Œå¹³å°åªéœ€è¦è®©æ¨¡å‹ç†è§£å’Œæ“ä½œå››ç±»â€œç¡¬èµ„äº§â€ï¼š

1. **Intentï¼ˆæ„å›¾è¯´æ˜ï¼‰**  
   - æè¿°ä¸šåŠ¡ç›®æ ‡ã€åœºæ™¯ç»“æ„ã€é¢†åŸŸå®ä½“ä¸æ¥å£ã€‚  
   - ä½œä¸ºâ€œæˆ‘è¦åšä»€ä¹ˆâ€çš„äº‹å®æºï¼Œæ˜¯åç»­æ­¥éª¤çš„è¾“å…¥ã€‚

2. **Patternï¼ˆæ¨¡å¼ï¼‰**  
   - æè¿°â€œæŸç±»åœºæ™¯ä¸€è´¯æ€ä¹ˆè§£â€çš„å¤ç”¨å¥—è·¯ï¼šé€‚ç”¨åœºæ™¯ã€ç»„æˆè§’è‰² (roles)ã€æ•°æ®å¥‘çº¦ã€å‚æ•° Schema ç­‰ã€‚  
   - çº¦æŸ LLM ä¸è¦éšæ„â€œå‘æ˜æ–°æ¶æ„â€ï¼Œè€Œæ˜¯åœ¨æ—¢æœ‰æ¨¡å¼åº“å†…é€‰å‹ã€‚

3. **Template Metaï¼ˆæ¨¡æ¿å…ƒæ•°æ®ï¼‰**  
   - æè¿°æŸä¸ªæ¨¡å¼åœ¨å½“å‰å·¥ç¨‹æ ˆé‡Œçš„å®ç°æ–¹å¼ï¼š  
     - å®ç°äº†å“ªäº› rolesï¼›  
     - éœ€è¦å“ªäº›å‚æ•°ï¼›  
     - ä¼šç”Ÿæˆ/ä¿®æ”¹å“ªäº›æ–‡ä»¶ã€‚  
   - LLM ä¸ç›´æ¥å†™æºç ï¼Œè€Œæ˜¯é€‰æ¨¡æ¿ + å¡«å‚æ•°ã€‚

4. **Plan + Execution Logï¼ˆå‡ºç è®¡åˆ’ä¸æ‰§è¡Œæ—¥å¿—ï¼‰**  
   - Planï¼šåˆ—å‡ºå³å°†åˆ›å»º/ä¿®æ”¹/åˆ é™¤çš„æ–‡ä»¶åŠå…¶æ¥æºï¼ˆpatternId/templateId/params ç­‰ï¼‰ã€‚  
   - Logï¼šè®°å½•çœŸå®æ‰§è¡Œçš„åŠ¨ä½œä¸ diffï¼Œæ–¹ä¾¿å›æº¯ä¸å¢é‡é‡æ„ã€‚  
   - v3 ä¸­è¿™éƒ¨åˆ†æ›´å¤šè¿ç§»åˆ°ç»Ÿä¸€çš„â€œFlow/Effect è¿è¡Œæ—¶ + å‡ºç å¼•æ“â€è§†è§’ï¼Œä½†â€œPlan ä½œä¸ºä¸­é—´å±‚â€çš„æ€æƒ³ä¾ç„¶æœ‰å‚è€ƒä»·å€¼ã€‚

## 3. v1 å®šä¹‰çš„å››é˜¶æ®µæµæ°´çº¿ï¼ˆç²¾ç®€ç‰ˆï¼‰

v1 æŠŠ LLM ååŒçš„æ•´ä¸ªè¿‡ç¨‹æ‹†æˆå››ä¸ªé˜¶æ®µï¼Œè¿™åœ¨ v3 ä¸­ä»æœ‰å‚è€ƒæ„ä¹‰ï¼Œåªæ˜¯å…·ä½“æ‰¿è½½ç‰©ä¸åŒï¼š

1. **é˜¶æ®µä¸€ï¼šè‡ªç„¶è¯­è¨€ â†’ Intent è‰ç¨¿**  
   - è¾“å…¥ï¼šå¼€å‘è€…ç”¨è‡ªç„¶è¯­è¨€æè¿°ä¸šåŠ¡åœºæ™¯ï¼ˆä¾‹å¦‚è®¢å• CRUDï¼‰ã€‚  
   - LLM è§’è‰²ï¼šIntent Builderâ€”â€”æ ¹æ®çº¦å®šçš„ Intent Schema è¡¥é½ç»“æ„åŒ– YAML/JSONï¼ˆgoals/scene/domain/patterns è‰ç¨¿ï¼‰ã€‚  
   - v3 å¯¹åº”ï¼šIntent ç¼–è¾‘è§†å›¾ + ä¸ Flow/Schema çš„åŒå‘åŒæ­¥ã€‚

2. **é˜¶æ®µäºŒï¼šIntent â†’ Pattern ç»„åˆ**  
   - è¾“å…¥ï¼šå·²æˆå‹çš„ Intentï¼ˆå°¤å…¶æ˜¯ scene + domain éƒ¨åˆ†ï¼‰ã€‚  
   - LLM è§’è‰²ï¼šPattern Advisorâ€”â€”åœ¨æ—¢æœ‰æ¨¡å¼åº“ä¸­åŒ¹é…åˆé€‚çš„æ¨¡å¼ç»„åˆï¼Œå¹¶ç»™å‡ºé…ç½®åˆç¨¿ã€‚  
   - v3 å¯¹åº”ï¼šæ›´å¤šæŠ˜å è¿› Flow/Logix çš„â€œå…¸å‹åœºæ™¯ DSLâ€ä¸æ¨¡æ¿é€‰å‹é€»è¾‘ä¸­ã€‚

3. **é˜¶æ®µä¸‰ï¼šPattern â†’ Plan è‰ç¨¿**  
   - è¾“å…¥ï¼šIntent + å·²é€‰ Patternã€‚  
   - LLM è§’è‰²ï¼šPlan Drafterâ€”â€”æ ¹æ® Pattern.roles ä¸æ¨¡æ¿å…ƒæ•°æ®ï¼Œç”Ÿæˆä¸€ä»½â€œå°†è¦æ”¹åŠ¨å“ªäº›æ–‡ä»¶â€çš„ Planã€‚  
   - ä»·å€¼ï¼šç»“æ„åŒ–åœ°è¡¨è¾¾â€œå‡ºç æ‰“ç®—åšä»€ä¹ˆâ€ï¼Œæ–¹ä¾¿äººç±»å®¡é˜…å’Œå·¥å…·æ ¡éªŒã€‚

4. **é˜¶æ®µå››ï¼šæ‰§è¡Œ Plan + å¢é‡é‡æ„**  
   - æ‰§è¡Œæ—¶ï¼Œæ¨¡æ¿å†³å®šæ–‡ä»¶ç»“æ„ï¼ŒLLM åªåœ¨æ ‡è®°ä¸º slot çš„å±€éƒ¨ä½ç½®ç”Ÿæˆä»£ç ï¼›  
   - éœ€æ±‚å˜æ›´æ—¶ï¼Œé€šè¿‡ Intent diff â†’ Plan diff â†’ å±€éƒ¨ä»£ç  diff çš„é“¾è·¯ï¼Œé©±åŠ¨å¢é‡ä¿®æ”¹ï¼Œè€Œä¸æ˜¯é‡å†™æ•´ä¸ªç‰¹æ€§ã€‚

v3 åœ¨å®ç°ä¸Šæ›´åå‘ä»¥ Logix Engine / Flow DSL ä¸ºç»Ÿä¸€è¿è¡Œæ—¶ï¼Œä½†è¿™æ¡â€œIntent â†’ Pattern â†’ Plan â†’ Code/Flowâ€çš„åˆ†é˜¶æ®µæ€è·¯ï¼Œä»å¯ä»¥ä½œä¸ºè®¾è®¡å’Œè¯„ä¼°æ–°æ–¹æ¡ˆæ—¶çš„å‚è€ƒè§†è§’ã€‚
</file>

<file path="intent-driven-ai-coding/v1/README.md">
---
title: Intent-Driven AI Coding v1 Â· å†å²å¿«ç…§
status: archived
version: v1
supersededBy: ../v3
---

> æœ¬ç›®å½•ä¿å­˜çš„æ˜¯ intent-driven-ai-coding v1 é˜¶æ®µçš„æ—©æœŸæ–¹æ¡ˆï¼Œåªä½œä¸ºä¸ v2/v3 å¯¹æ¯”çš„å†å²å¿«ç…§ä½¿ç”¨ã€‚  
> å½“å‰è§„åˆ’ä¸å®ç°ä¸€å¾‹ä»¥ `v3` ä¸ºäº‹å®æºï¼›v1 ä¸­çš„æ¦‚å¿µå’Œçº¦å®šå¦‚æœä¸ v3 å†²çªï¼Œåº”ä»¥ v3 ä¸ºå‡†ã€‚

æ¨èåªä»ä¸‰ç±»æ–‡æ¡£äº†è§£ v1ï¼š

- æ€»è§ˆä¸èƒŒæ™¯ï¼š`01-overview.md`  
- æ¨¡å¼ä¸æ„å›¾èµ„äº§é›å½¢ï¼š`02-patterns-and-intents.md`  
- å…¸å‹è®¾è®¡/ç¤ºä¾‹ï¼š`design/`ã€`examples/` ä¸­éœ€è¦æ—¶ç‚¹è¯»ï¼Œä¸å†ä½œä¸ºè§„èŒƒã€‚

åç»­å¦‚æœåœ¨ v1 ä¸­å‘ç°ä»æœ‰ä»·å€¼çš„ç»†èŠ‚ï¼ˆä¾‹å¦‚æŸäº› Pattern çš„æ‹†è§£æ–¹å¼ï¼‰ï¼Œåº”åœ¨ `v3` ä¸‹è¡¥å……å¯¹åº”ç« èŠ‚åï¼Œå†å°†è¿™é‡Œæ ‡è®°ä¸ºã€Œå·²åˆå¹¶ã€è€Œä¸æ˜¯ç»§ç»­æ‰©å±• v1ã€‚
</file>

<file path="intent-driven-ai-coding/v2/00-architecture-decision-records.md">
---
title: 00 Â· æ¶æ„æ¼”è¿›ä¸å†³ç­–è®°å½• (v2 Snapshot)
status: archived
---

> æœ¬æ–‡æ¡£æ˜¯ v2 æ—¶æœŸçš„æ¶æ„å†³ç­–å¿«ç…§ï¼Œè¯¦ç»†è®°å½•äº†â€œå…­å±‚æ¨¡å‹â€çš„è®¾è®¡èƒŒæ™¯ä¸ç†ç”±ã€‚è™½ç„¶å·²è¢« v3 å–ä»£ï¼Œä½†å…¶å¯¹é—®é¢˜çš„æ‹†è§£æ€è·¯ä»å…·å‚è€ƒä»·å€¼ã€‚

## ADR-002: ç¡®ç«‹â€œå…­å±‚æ„å›¾â€æ¨¡å‹ (v2)

*   **æ—¥æœŸ**: 2025-11-20
*   **çŠ¶æ€**: **Superseded by ADR-003**
*   **èƒŒæ™¯**: 
    åœ¨ v1 é˜¶æ®µï¼ŒIntentã€Pattern å’Œ Plan çš„æ¦‚å¿µæ··æ‚åœ¨ä¸€èµ·ï¼Œå¯¼è‡´ LLM éš¾ä»¥ç”Ÿæˆé«˜è´¨é‡çš„ä»£ç ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå›¢é˜Ÿè®¤ä¸ºéœ€è¦å¯¹å‰ç«¯å·¥ç¨‹è¿›è¡Œâ€œå…¨åˆ‡é¢â€çš„è§£æ„ï¼Œè¯•å›¾ç©·å°½æ‰€æœ‰å¼€å‘ç»†èŠ‚ï¼Œä»¥ä¾¿è®© LLM åœ¨æ¯ä¸ªåˆ‡é¢ä¸Šéƒ½èƒ½ç²¾å‡†å·¥ä½œã€‚
*   **å½“æ—¶çš„æ–¹æ¡ˆ (The Six Layers)**:
    æˆ‘ä»¬å°†å‰ç«¯æ„å›¾æ‹†è§£ä¸ºå…­ä¸ªç‹¬ç«‹çš„å±‚çº§ï¼š
    1.  **Layout Intent (å¸ƒå±€)**ï¼š
        *   *å®šä¹‰*ï¼šé¡µé¢çš„åˆ†åŒºç»“æ„ï¼ˆå¦‚ Sidebar, Header, Contentï¼‰ã€‚
        *   *ç›®çš„*ï¼šè§£å†³â€œé¡µé¢é•¿ä»€ä¹ˆæ ·â€çš„å®è§‚é—®é¢˜ã€‚
    2.  **View & Component Intent (è§†å›¾)**ï¼š
        *   *å®šä¹‰*ï¼šåŒºåŸŸå†…çš„å…·ä½“ç»„ä»¶æ¨¡å¼ï¼ˆå¦‚ Table, Formï¼‰ã€‚
        *   *ç›®çš„*ï¼šè§£å†³â€œåŒºåŸŸé‡Œæ”¾ä»€ä¹ˆâ€çš„å¾®è§‚é—®é¢˜ã€‚
    3.  **Interaction Intent (äº¤äº’)**ï¼š
        *   *å®šä¹‰*ï¼šç”¨æˆ·æ“ä½œï¼ˆClick/Hoverï¼‰ä¸ UI åé¦ˆæˆ–ä¿¡å·è§¦å‘çš„ç»‘å®šã€‚
        *   *ç›®çš„*ï¼šè¯•å›¾å°†â€œäº¤äº’â€ä»ç»„ä»¶å’Œé€»è¾‘ä¸­å‰¥ç¦»å‡ºæ¥ç‹¬ç«‹ç®¡ç†ã€‚
    4.  **Behavior & Flow Intent (è¡Œä¸º)**ï¼š
        *   *å®šä¹‰*ï¼šä¸šåŠ¡ä¿¡å·çš„å¤„ç†æµç¨‹ï¼ˆService Call, Branchï¼‰ã€‚
        *   *ç›®çš„*ï¼šè§£å†³â€œä¸šåŠ¡é€»è¾‘æ€ä¹ˆè·‘â€çš„é—®é¢˜ã€‚
    5.  **Data & State Intent (æ•°æ®)**ï¼š
        *   *å®šä¹‰*ï¼šå®ä½“å®šä¹‰ã€çŠ¶æ€å­˜å‚¨ä½ç½®ï¼ˆLocal vs Globalï¼‰ã€‚
        *   *ç›®çš„*ï¼šè§£å†³â€œæ•°æ®é•¿ä»€ä¹ˆæ ·ã€å­˜åœ¨å“ªâ€çš„é—®é¢˜ã€‚
    6.  **Code Structure Intent (å·¥ç¨‹ç»“æ„)**ï¼š
        *   *å®šä¹‰*ï¼šæ¨¡å—æ‹†åˆ†ã€æ–‡ä»¶è·¯å¾„ã€ç›®å½•è§„èŒƒã€‚
        *   *ç›®çš„*ï¼šè¯•å›¾è®© LLM æ˜¾å¼æ§åˆ¶ä»£ç æ–‡ä»¶çš„ç»„ç»‡æ–¹å¼ã€‚
*   **å†³ç­–ç†ç”±**ï¼š
    å½“æ—¶è®¤ä¸ºâ€œåˆ†å¾—è¶Šç»†ï¼ŒLLM è¶Šå¥½æ§åˆ¶â€ã€‚é€šè¿‡æ˜¾å¼å®šä¹‰ `Code Structure`ï¼Œå¸Œæœ›è§£å†³ LLM ç”Ÿæˆä»£ç æ—¶æ–‡ä»¶ä¹±æ”¾çš„é—®é¢˜ï¼›é€šè¿‡ç‹¬ç«‹ `Interaction`ï¼Œå¸Œæœ›å®ç° UI ä¸é€»è¾‘çš„è§£è€¦ã€‚
*   **åæ€ä¸æ•™è®­**ï¼š
    è™½ç„¶å‡ºå‘ç‚¹æ˜¯å¥½çš„ï¼Œä½†è¿™ç§åˆ†ç±»æ–¹å¼æ˜¯**â€œå®ç°å¯¼å‘â€**è€Œé**â€œæ„å›¾å¯¼å‘â€**çš„ã€‚ç‰¹åˆ«æ˜¯ `Code Structure`ï¼Œå®ƒå®é™…ä¸Šæ˜¯ Constraint æˆ– Pattern çš„äº§ç‰©ï¼Œä¸åº”ç”±ç”¨æˆ·ï¼ˆå°¤å…¶æ˜¯ PMï¼‰æ¥å®šä¹‰ã€‚å…­å±‚æ¨¡å‹å¯¼è‡´äº†ä¿¡æ¯çš„ç¢ç‰‡åŒ–ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„ç†µã€‚

## ADR-001: æ„å›¾é©±åŠ¨å¼€å‘ (v1)

*   **æ—¥æœŸ**: 2025-10-01
*   **çŠ¶æ€**: **Superseded by ADR-002**
*   **èƒŒæ™¯**: 
    ä¼ ç»Ÿä½ä»£ç å¹³å°çµæ´»æ€§ä¸è¶³ï¼Œè€Œç›´æ¥å†™ä»£ç åˆç¼ºä¹è§„èŒƒä¸”éš¾ä»¥ç»´æŠ¤ã€‚LLM çš„å‡ºç°æä¾›äº†æ–°çš„å¯èƒ½ï¼Œä½†ç›´æ¥è®© LLM ç”Ÿæˆä»£ç å¾€å¾€ä¸å¯æ§ã€‚
*   **å½“æ—¶çš„æ–¹æ¡ˆ**:
    *   æå‡º **"Intent"** æ¦‚å¿µï¼Œä½œä¸ºè‡ªç„¶è¯­è¨€å’Œä»£ç ä¹‹é—´çš„ä¸­é—´å±‚ DSLã€‚
    *   å¼•å…¥ **Pattern** (æ¨¡å¼) å’Œ **Plan** (æ‰§è¡Œè®¡åˆ’) çš„æ¦‚å¿µã€‚
    *   Intent ä¸»è¦æ˜¯ä¸€ä¸ªæ‰å¹³çš„ JSON é…ç½®ï¼Œæ··åˆäº† UIã€é€»è¾‘å’Œæ•°æ®é…ç½®ã€‚
*   **å†³ç­–ç†ç”±**ï¼š
    éœ€è¦ä¸€ä¸ªç»“æ„åŒ–çš„è½½ä½“æ¥æ‰¿è½½ LLM çš„æ€è€ƒç»“æœï¼Œè€Œä¸æ˜¯ç›´æ¥ç”Ÿæˆä»£ç æ–‡ä»¶ã€‚
*   **åæ€**ï¼š
    v1 éªŒè¯äº†â€œæ„å›¾é©±åŠ¨â€çš„å¯è¡Œæ€§ï¼Œä½†ç”±äº Intent ç»“æ„å®šä¹‰è¿‡äºéšæ„ï¼ˆæ··åˆå¤§æ‚çƒ©ï¼‰ï¼Œå¯¼è‡´å¤æ‚åœºæ™¯ä¸‹ LLM æ— æ³•ç”Ÿæˆç¨³å®šçš„ç»“æœï¼Œä¹Ÿæ— æ³•æ”¯æŒå¤æ‚çš„ä¸šåŠ¡é€»è¾‘ç¼–æ’ï¼Œå› æ­¤å‚¬ç”Ÿäº† v2 çš„åˆ†å±‚æ¢ç´¢ã€‚
</file>

<file path="intent-driven-ai-coding/v2/02-intent-layers.md">
---
title: å‰ç«¯æ„å›¾å…­å±‚æ¨¡å‹ (The Six Layers Model)
status: archived
version: 2
---

> **æ³¨æ„**ï¼šæœ¬æ–‡æ¡£æè¿°çš„æ˜¯ v2 ç‰ˆæœ¬çš„æ¶æ„è®¾è®¡ï¼Œå·²è¢« v3 çš„â€œä¸‰ä½ä¸€ä½“â€æ¨¡å‹å–ä»£ã€‚ä¿ç•™æ­¤æ–‡æ¡£ä»…ä¾›å†å²å‚è€ƒã€‚

## 1. æ¨¡å‹æ€»è§ˆ

åœ¨ v2 ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å°†å‰ç«¯æ„å›¾æ‹†è§£ä¸ºå…­ä¸ªç‹¬ç«‹çš„å±‚çº§ï¼Œè¯•å›¾ç©·å°½æ‰€æœ‰å¼€å‘ç»†èŠ‚ï¼š

1.  **Layout Intent (å¸ƒå±€)**ï¼šé¡µé¢çš„åˆ†åŒºç»“æ„ã€‚
2.  **View & Component Intent (è§†å›¾)**ï¼šåŒºåŸŸå†…çš„å…·ä½“ç»„ä»¶æ¨¡å¼ã€‚
3.  **Interaction Intent (äº¤äº’)**ï¼šç”¨æˆ·æ“ä½œä¸ UI åé¦ˆæˆ–ä¿¡å·è§¦å‘çš„ç»‘å®šã€‚
4.  **Behavior & Flow Intent (è¡Œä¸º)**ï¼šä¸šåŠ¡ä¿¡å·çš„å¤„ç†æµç¨‹ã€‚
5.  **Data & State Intent (æ•°æ®)**ï¼šå®ä½“å®šä¹‰ä¸çŠ¶æ€å­˜å‚¨ã€‚
6.  **Code Structure Intent (å·¥ç¨‹ç»“æ„)**ï¼šæ¨¡å—æ‹†åˆ†ä¸æ–‡ä»¶è·¯å¾„ã€‚

## 2. è¯¦ç»†å®šä¹‰

### 2.1 Layout Intent
*   **å…³æ³¨ç‚¹**ï¼šé¡µé¢éª¨æ¶ã€‚
*   **Schema**ï¼š`regions`, `layoutType`ã€‚
*   **é—®é¢˜**ï¼šä¸ View å±‚å‰²è£‚ï¼Œå¯¼è‡´éœ€è¦é€šè¿‡ ID äº’ç›¸å¼•ç”¨ã€‚

### 2.2 View & Component Intent
*   **å…³æ³¨ç‚¹**ï¼šç»„ä»¶å¡«å……ã€‚
*   **Schema**ï¼š`slot`, `patternId`, `props`ã€‚

### 2.3 Interaction Intent
*   **å…³æ³¨ç‚¹**ï¼šäº‹ä»¶ç»‘å®šã€‚
*   **Schema**ï¼š`source`, `event`, `triggerSignal`ã€‚
*   **é—®é¢˜**ï¼šå°†â€œç‚¹å‡»â€ä¸â€œè§¦å‘â€å¼ºè¡Œå‰¥ç¦»ï¼Œå¯¼è‡´é€»è¾‘ç¢ç‰‡åŒ–ã€‚

### 2.4 Behavior & Flow Intent
*   **å…³æ³¨ç‚¹**ï¼šä¸šåŠ¡é€»è¾‘ã€‚
*   **Schema**ï¼š`signals`, `flows`ã€‚
*   **è®¾è®¡**ï¼šåŒºåˆ†äº†å‰ç«¯ Runtime ä¸ `effect-flow-runtime` ä¸¤ä¸ªç›®æ ‡ã€‚

### 2.5 Data & State Intent
*   **å…³æ³¨ç‚¹**ï¼šæ•°æ®æ¨¡å‹ã€‚
*   **Schema**ï¼š`entities`, `apis`, `stateSources`ã€‚

### 2.6 Code Structure Intent
*   **å…³æ³¨ç‚¹**ï¼šæ–‡ä»¶ç»„ç»‡ã€‚
*   **Schema**ï¼š`files`, `modules`ã€‚
*   **é—®é¢˜**ï¼šè¿™æ˜¯å®ç°ç»†èŠ‚ï¼Œä¸åº”ä½œä¸ºæ„å›¾æš´éœ²ç»™ç”¨æˆ·ã€‚
</file>

<file path="intent-driven-ai-coding/v2/99-history-and-comparison.md">
---
title: v1 / v2 / v3 ç®€å²ä¸å¯¹ç…§
status: archived
version: v2
supersededBy: ../v3
---

> ç›®çš„ï¼šå¸®åŠ©é˜…è¯»è€…å¿«é€Ÿç†è§£ intent-driven-ai-coding åœ¨ v1 â†’ v2 â†’ v3 è¿‡ç¨‹ä¸­çš„å…³é”®æ¼”è¿›ï¼Œå“ªäº›æ¦‚å¿µå·²ç»åºŸå¼ƒã€å“ªäº›è¢«ç»§æ‰¿ï¼Œå“ªäº›ä»åœ¨ç­‰å¾…èåˆè¿› v3ã€‚  
> äº‹å®æºï¼šå½“å‰ä¸€åˆ‡æ­£å¼è§„èŒƒä»¥ `../v3` ä¸ºå‡†ï¼›æœ¬æ–‡ä»¶å’Œ `v1/`ã€`v2/` å…¶ä»–æ–‡æ¡£åªä½œä¸ºå¯¹ç…§ææ–™ã€‚

## 1. ä¸‰ä¸ªç‰ˆæœ¬çš„å¤§è‡´è§’è‰²

- **v1**ï¼š  
  - å…³æ³¨ã€Œæ„å›¾ â†’ æ¨¡å¼ â†’ æ¨¡æ¿ã€è¿™ä¸€æ¡ä¸»çº¿ï¼›  
  - æ›´åå‘â€œç”¨ç»“æ„åŒ–æ–‡æ¡£çº¦æŸäººç±»/LLMâ€çš„è§„åˆ’ï¼Œè¿è¡Œæ—¶ä¸æ‰§è¡Œå¼•æ“ç€å¢¨è¾ƒå°‘ï¼›  
  - å¯¹ Pattern/Intent çš„åˆ†å±‚å’Œæœ¯è¯­æ¯”è¾ƒä¸°å¯Œï¼Œä½†ä¸å…·ä½“ Runtime çš„è¿æ¥è¾ƒæ¾æ•£ã€‚

- **v2**ï¼š  
  - å¼•å…¥ã€Œå…­å±‚æ„å›¾æ¨¡å‹ã€ä¸æ›´å®Œæ•´çš„ Runtime å®¶æ—è§†è§’ï¼›  
  - å°è¯•æŠŠ Layout / View / Interaction / Behavior & Flow / Data & State / Code Structure å…¨éƒ¨æ‹†å¼€ç®¡ç†ï¼›  
  - æå‡ºäº†åŒè¿è¡Œæ—¶ï¼ˆEffect / å‰ç«¯è¿è¡Œæ—¶ï¼‰çš„æ•´ä½“è“å›¾ï¼Œä½†åœ¨å®é™…ä½¿ç”¨ä¸Šæš´éœ²å‡ºâ€œæ¦‚å¿µè¿‡å¤šã€è½åœ°æˆæœ¬é«˜â€çš„é—®é¢˜ã€‚

- **v3**ï¼š  
  - ä»¥ `Logix Engine` + Effect Runtime ä¸ºç»Ÿä¸€é€»è¾‘å†…æ ¸ï¼Œæ”¶æ•›å‰ç«¯ Runtime å½¢æ€ï¼›  
  - è®¤ä¸º Intent / Flow / Runtime åº”è¯¥å°½é‡è½åœ¨åŒä¸€å¥— DSL / Engine ä¸Šï¼Œè€Œä¸æ˜¯åœ¨â€œå±‚â€ä¸Šæ¨ªå‘æ‰©å±•ï¼›  
  - æ›´å¼ºè°ƒç«¯åˆ°ç«¯çš„â€œåŒå·¥åŒæ­¥â€ï¼ˆIntent â†” Codeï¼‰ä¸å¯¹çœŸå®ä¸šåŠ¡ä»“åº“çš„å¯è½åœ°æ€§ã€‚

## 2. å…¸å‹å·®å¼‚ä¸€è§ˆï¼ˆç®€åŒ–ç‰ˆï¼‰

| ç»´åº¦ | v1 | v2 | v3 |
| --- | --- | --- | --- |
| æ ¸å¿ƒå…³æ³¨ | æ„å›¾ + æ¨¡å¼ + æ¨¡æ¿ | å…­å±‚ Intent å…¨æ™¯å›¾ | Intent + Flow DSL + Logix Engine |
| Runtime è§’è‰² | æ¾æ•£æåŠ Effect/çŠ¶æ€åº“ | åŒ Runtimeï¼šEffect / å‰ç«¯ Runtime | ä»¥ Logix + Effect ä¸º Runtime å®¶æ—ä¸­å¿ƒ |
| å¤æ‚åº¦æ§åˆ¶ | ä¸»è¦ä¾èµ–æ–‡æ¡£ä¸ Pattern çº¦æŸ | é€šè¿‡å±‚çº§æ‹†åˆ†æ§åˆ¶æ¦‚å¿µï¼Œä½†æœ‰è¿‡åº¦å·¥ç¨‹é£é™© | é€šè¿‡ DSL/Engine ç»Ÿä¸€æ”¶æ•›ï¼Œå®ç°ä¸Šç®€åŒ–ã€è¯­ä¹‰ä¸Šå¢å¼º |

æ›´ç»†çš„å·®å¼‚åœ¨ `v2/02-intent-layers.md` ä¸ `../v3/01-overview.md` ä¸­éƒ½æœ‰ä½“ç°ï¼Œæœ¬æ–‡ä»¶ä¸é‡å¤å±•å¼€ã€‚

## 3. å¦‚ä½•ä½¿ç”¨ v1/v2 æ–‡æ¡£

- å½“ä½ åœ¨æ€è€ƒã€ŒæŸä¸ªæ¦‚å¿µåˆ°åº•æ˜¯ v3 æ–°å¼•å…¥çš„ï¼Œè¿˜æ˜¯æ—©æœŸç‰ˆæœ¬æ²¿è¢­çš„ï¼Ÿã€æ—¶ï¼Œå¯ä»¥ï¼š  
  - å»çœ‹ `v1/01-overview.md` / `v1/02-patterns-and-intents.md` é‡Œçš„åŸå§‹è¯´æ³•ï¼›  
  - å¯¹æ¯” `v2/02-intent-layers.md` å¦‚ä½•æŠŠè¿™äº›æ¦‚å¿µæ‹†å¾—æ›´ç»†ï¼›  
  - å†å›åˆ° `../v3` ä¸‹çš„å¯¹åº”ç« èŠ‚ï¼Œçœ‹æœ€ç»ˆæ”¶æ•›åˆ°äº†å“ªäº›åè¯å’Œè¾¹ç•Œã€‚

- å½“ä½ æƒ³ä¸º v3 å¼•å…¥æ–°èƒ½åŠ›æ—¶ï¼Œå¦‚æœåœ¨ v1/v2 ä¸­æ‰¾åˆ°ç±»ä¼¼æ€è·¯ï¼š  
  - ä¼˜å…ˆåœ¨ `../v3` ä¸­è¡¥å……è®¾è®¡ä¸å¥‘çº¦ï¼›  
  - ç„¶ååœ¨è¿™é‡Œæ ‡æ³¨è¯¥èƒ½åŠ›â€œå·²åœ¨ v3 åˆå¹¶â€ï¼Œé¿å… v1/v2 å†é•¿å‡ºç¬¬äºŒå¥—è§„èŒƒã€‚

## 4. åç»­çº¦å®š

- ä¸å†å‘ v1/v2 è¡¥å……æ–°çš„è§„èŒƒæ€§å†…å®¹ï¼Œåªå…è®¸å¢åŠ å°‘é‡â€œå¯¹ç…§/æ‰¹æ³¨â€æ€§è´¨çš„æ®µè½ï¼›  
- ä»»ä½•å¯¹ Intent æ¨¡å‹ã€Flow DSLã€Runtime å¥‘çº¦çš„è°ƒæ•´ï¼Œå¿…é¡»å…ˆåœ¨ `../v3` ç›®å½•ä¸‹è¾¾æˆå…±è¯†ï¼Œå†è§†æƒ…å†µåœ¨æœ¬æ–‡ä»¶ä¸­è¡¥ä¸€è¡Œâ€œä» v1/v2 æ²¿è¢­è€Œæ¥/å·²è¢«å–ä»£â€çš„è¯´æ˜ã€‚
</file>

<file path="intent-driven-ai-coding/v2/README.md">
# Intent-Driven AI Coding v2 (Archived)

> **Status**: Archived / Superseded by v3
> **Date**: 2025-11-20 ~ 2025-11-23

## è¯¥ç›®å½•ç°åœ¨çš„è§’è‰²

- **å†å²å¿«ç…§**ï¼šä¿ç•™ v2 æ—¶æœŸçš„ã€Œå…­å±‚æ„å›¾æ¨¡å‹ã€ä¸ç›¸å…³ ADRï¼Œä¾¿äºå’Œ v3 çš„è®¾è®¡è¿›è¡Œå¯¹ç…§ï¼›  
- **å¯¹ç…§ææ–™**ï¼šå¸®åŠ©è¯†åˆ«å“ªäº›æ¦‚å¿µå·²ç»åœ¨ v3 ä¸­è¢«ç»§æ‰¿ã€å“ªäº›è¢«å¦å®šã€å“ªäº›ä»å¯ä»¥ä½œä¸ºå€™é€‰èƒ½åŠ›èå…¥ v3ï¼›  
- **éäº‹å®æº**ï¼šå½“å‰ä¸€åˆ‡è§„èŒƒè¯´æ˜ã€å‡ºç å¥‘çº¦ä¸è¿è¡Œæ—¶è®¾è®¡ä¸€å¾‹ä»¥ `../v3` ä¸ºå‡†ï¼Œè¿™é‡Œä¸å†æ–°å¢æ–°çš„è§„èŒƒæ€§å†…å®¹ã€‚

å¦‚éœ€å¿«é€Ÿäº†è§£ v2ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹è·¯å¾„é˜…è¯»ï¼š

- `00-architecture-decision-records.md`ï¼šv2 æ¶æ„å†³ç­–å¿«ç…§ï¼›  
- `02-intent-layers.md`ï¼šå…­å±‚ Intent æ¨¡å‹è¯¦æƒ…ï¼›  
- `99-history-and-comparison.md`ï¼šv1/v2/v3 çš„ç®€è¦å¯¹ç…§ä¸æ¼”è¿›è¯´æ˜ã€‚
</file>

<file path="intent-driven-ai-coding/v3/design/behavior-and-flow.md">
---
title: è¡Œä¸º/æµç¨‹æ„å›¾ (Behavior & Flow Intent)
status: draft
version: 3
---

> **[å®šä½æ¾„æ¸…]** æœ¬æ–‡æ¡£æè¿°çš„æ˜¯ Logic Intent çš„ **æŠ½è±¡æ¨¡å‹**ï¼Œä¸»è¦æœåŠ¡äºå¹³å°çš„å¯è§†åŒ–ä¸ä»£ç ç”Ÿæˆã€‚åœ¨ v3 æ¶æ„ä¸­ï¼Œ**ä»£ç æ˜¯å”¯ä¸€äº‹å®æº (Code is Truth)**ã€‚æœ¬æ–‡å®šä¹‰çš„å›¾çŠ¶ DSL (Nodes/Edges) æœ€ç»ˆä¼šç¼–è¯‘ä¸ºï¼ˆæˆ–ä»ä¸­è§£æå‡ºï¼‰æ ‡å‡†çš„ Effect-Native ä»£ç ï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶è¢«ç›´æ¥è§£é‡Šã€‚
> 
> ---
> 
> æœ¬æ–‡å®šä¹‰äº† v3 æ¶æ„ä¸‹çš„æ ¸å¿ƒè¡Œä¸ºæ¨¡å‹ï¼šåŸºäº DAG çš„é€»è¾‘ç¼–æ’ã€å¼ºç±»å‹çš„ Signal é©±åŠ¨ã€ä»¥åŠåŒè¿è¡Œæ—¶ï¼ˆEffect/Logix Engineï¼‰çš„åˆ†å‘æœºåˆ¶ã€‚

## 1. æ ¸å¿ƒå®šä¹‰

Behavior & Flow Intent å›ç­”ï¼š**â€œå½“ä¸šåŠ¡ä¿¡å·å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿå¦‚ä½•å“åº”ï¼Ÿâ€**

å®ƒä¸ä»…ä»…æ˜¯çº¿æ€§çš„æ­¥éª¤é“¾ï¼Œè€Œæ˜¯**å‰¥ç¦»äº†æŠ€æœ¯å®ç°ç»†èŠ‚çš„ã€å¯è¢«æœºå™¨æ‰§è¡Œçš„ä¸šåŠ¡é€»è¾‘è“å›¾**ã€‚åœ¨å¹³å°ä¸­ï¼Œå®ƒæ‰®æ¼”ç€â€œä¸šåŠ¡å‰§æœ¬â€ä¸â€œæŠ€æœ¯å®ç°â€ä¹‹é—´çš„åŒé¢èƒ¶è§’è‰²ã€‚

### 1.1 å…³é”®ç‰¹æ€§

1.  **Signal é©±åŠ¨ (Signal-Driven)**ï¼šFlow ä¸ç›´æ¥ç›‘å¬ UI äº‹ä»¶ï¼Œè€Œæ˜¯ç›‘å¬ä¸šåŠ¡ä¿¡å·ï¼ˆSignalï¼‰ã€‚UI äº‹ä»¶é€šè¿‡ Interaction Intent è½¬åŒ–ä¸º Signalï¼Œä»è€Œå®ç° UI ä¸é€»è¾‘çš„å½»åº•è§£è€¦ã€‚
2.  **å›¾çŠ¶ç¼–æ’ (Graph-based)**ï¼šåº•å±‚é‡‡ç”¨ DAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰ç»“æ„ï¼Œæ”¯æŒä¸²è¡Œã€å¹¶è¡Œã€ç«æ€ã€åˆ†æ”¯ä¸æ±‡èšï¼Œè¶³ä»¥è¡¨è¾¾ä¼ä¸šçº§å¤æ‚ä¸šåŠ¡ã€‚
3.  **åŒè¿è¡Œæ—¶ (Dual Runtime)**ï¼šåŒä¸€ä»½ Flow Intent å¯æ ¹æ® `runtimeTarget` ç¼–è¯‘ä¸ºæœåŠ¡ç«¯ Effect ç¨‹åºæˆ–å‰ç«¯ Logix è§„åˆ™ã€‚

## 2. æ¨¡å‹è¯¦è§£

### 2.1 Signal Intentï¼šå¼ºç±»å‹çš„ä¸šåŠ¡å¥‘çº¦

Signal æ˜¯è¿æ¥ Interactionï¼ˆè§¦å‘æºï¼‰ä¸ Flowï¼ˆå¤„ç†å™¨ï¼‰çš„æ ‡å‡†åŒ–åè®®ã€‚

```typescript
interface SignalIntent {
  id: string
  name: string // e.g. "submitOrder"
  description?: string
  // å¿…é¡»å¼•ç”¨ Data Schemaï¼Œä¿è¯ Payload ç±»å‹å®‰å…¨
  payloadSchemaId?: string // e.g. "OrderSubmissionPayload"
}
```

### 2.2 Flow Intentï¼šåŸºäºå›¾çš„é€»è¾‘ç¼–æ’

ä¸ºäº†æ”¯æ’‘å¤æ‚ç¼–æ’å¹¶ä¸ React Flow ç­‰å¯è§†åŒ–å·¥å…·æ— ç¼æ˜ å°„ï¼ŒFlow DSL é‡‡ç”¨ **Nodes + Edges + Groups** çš„æ‰å¹³åŒ–å›¾ç»“æ„ã€‚

```typescript
interface FlowIntent {
  id: string
  name: string
  description?: string
  
  // è§¦å‘æºï¼šç›‘å¬å“ªä¸ª Signal
  triggerSignalId: string
  
  // è¿è¡Œæ—¶ç›®æ ‡
  runtimeTarget: 'effect-flow-runtime' | 'logix-engine'

  // å›¾ç»“æ„å®šä¹‰
  nodes: Record<string, FlowNode>
  edges: FlowEdge[]
  
  // å…¥å£èŠ‚ç‚¹
  startNodeId: string
}

type FlowNode = 
  | ServiceCallNode   // è°ƒç”¨æœåŠ¡ (Effect.promise/call)
  | BranchNode        // æ¡ä»¶åˆ†æ”¯ (Effect.match / matchEffect)
  | WaitNode          // ç­‰å¾…ä¿¡å·/æ—¶é—´ (Effect.sleep/race)
  | StateMachineNode  // åµŒå…¥å¤æ‚çŠ¶æ€æœº (XState/Workflow)
  | ReturnNode        // ç»“æŸå¹¶è¿”å›
  | ErrorHandlerNode  // é”™è¯¯å¤„ç†è¾¹ç•Œ

interface FlowEdge {
  id: string
  source: string
  target: string
  type?: 'default' | 'true' | 'false' | 'error'
}

// å¯è§†åŒ–åˆ†ç»„ (å¯¹åº” Effect ç»„åˆå­ä½œç”¨åŸŸ)
interface FlowGroup {
  id: string
  type: 'parallel' | 'race' | 'tryCatch'
  childrenNodeIds: string[] // åŒ…å«å“ªäº›èŠ‚ç‚¹
}
```

## 3. ç¼–è¯‘é€»è¾‘ï¼šä» DAG åˆ° Effect

Flow DSL çš„å›¾ç»“æ„ä¸ Effect-ts çš„ç»„åˆå­ï¼ˆCombinatorsï¼‰å­˜åœ¨å¤©ç„¶çš„åŒæ„æ˜ å°„å…³ç³»ã€‚ç¼–è¯‘å™¨é€šè¿‡æ‹“æ‰‘æ’åºå’Œæ¨¡å¼åŒ¹é…ï¼Œå°† DAG â€œç›´è¯‘â€ä¸º Effect ä»£ç ã€‚

| DAG é€»è¾‘ç»“æ„ | Effect ç»„åˆå­ | è¯´æ˜ |
| :--- | :--- | :--- |
| **ä¸²è¡Œè¾¹ (Sequence)** | `Effect.flatMap` / `yield*` | èŠ‚ç‚¹ B ä¾èµ–èŠ‚ç‚¹ Aï¼Œç¼–è¯‘ä¸º `taskA.pipe(flatMap(() => taskB))` |
| **å¹¶è¡Œåˆ†ç»„ (Parallel Group)** | `Effect.all([...])` | å¤šä¸ªèŠ‚ç‚¹æ— ä¾èµ–ä¸”è¢«æ¡†åœ¨å¹¶è¡Œç»„å†…ï¼Œç¼–è¯‘ä¸º `Effect.all([taskA, taskB])` |
| **ç«æ€åˆ†ç»„ (Race Group)** | `Effect.race(...)` | å¤šä¸ªèŠ‚ç‚¹è¢«æ¡†åœ¨ç«æ€ç»„å†…ï¼Œç¼–è¯‘ä¸º `Effect.race(taskA, taskB)` |
| **é”™è¯¯è¾¹ (Error Edge)** | `Effect.catchAll(...)` | èŠ‚ç‚¹/ç»„çš„ Error Handle è¿å‡ºçš„è¾¹ï¼Œç¼–è¯‘ä¸º `task.pipe(catchAll(err => errorHandler))` |
| **æ¡ä»¶åˆ†æ”¯ (Branch)** | `Effect.if` / `match` | è±å½¢èŠ‚ç‚¹çš„ True/False è¾¹ï¼Œç¼–è¯‘ä¸ºæ¡ä»¶é€»è¾‘ |

è¿™ç§æ˜ å°„ä¿è¯äº†ï¼š**åªè¦ Flow å›¾æ˜¯åˆæ³•çš„ï¼Œç”Ÿæˆçš„ Effect ä»£ç å°±æ˜¯å¥å£®çš„ã€å¹¶å‘å®‰å…¨çš„ã€èµ„æºå¯ç®¡ç†çš„ã€‚**

## 4. è¿è¡Œæ—¶åˆ†å‘ (Runtime Dispatch)

Flow Intent æ˜¯é€»è¾‘è“å›¾ï¼Œå…·ä½“çš„æ‰§è¡Œç”± `runtimeTarget` å†³å®šï¼š

### 4.1 Target: Effect Flow Runtime (æœåŠ¡ç«¯/BFF)
- **é€‚ç”¨åœºæ™¯**ï¼šè·¨ç³»ç»Ÿè°ƒç”¨ã€é•¿æµç¨‹ã€éœ€è¦å¼ºä¸€è‡´æ€§/å®¡è®¡/é‡è¯•çš„åœºæ™¯ï¼ˆå¦‚è®¢å•åˆ›å»ºã€æ”¯ä»˜å›è°ƒï¼‰ã€‚
- **äº§ç‰©**ï¼š`.flow.ts` æ–‡ä»¶ã€‚
- **å®ç°**ï¼šå®Œæ•´çš„ Effect-ts ç¨‹åºï¼Œè¿è¡Œåœ¨ Node.js å®¹å™¨ä¸­ï¼Œé€šè¿‡ Layer æ³¨å…¥åŸºç¡€è®¾æ–½ã€‚

### 4.2 Target: Logix Engine (å‰ç«¯)
- **é€‚ç”¨åœºæ™¯**ï¼šè´´è¿‘ UI çš„äº¤äº’é€»è¾‘ã€å­—æ®µè”åŠ¨ã€ä¹è§‚æ›´æ–°ã€æœ¬åœ°æ ¡éªŒï¼ˆå¦‚è¡¨å•çº§è”ã€å³æ—¶æœç´¢ï¼‰ã€‚
- **äº§ç‰©**ï¼šLogix Module å®šä¹‰ + `Module.logic` é…ç½®ã€‚
- **å®ç°**ï¼š
  - ç®€å•é€»è¾‘ç¼–è¯‘ä¸º `Logic` è§„åˆ™ã€‚
  - å¤æ‚ DAG é€»è¾‘ç¼–è¯‘ä¸º Logix å†…éƒ¨çš„å¾®å‹ Effect Runner è°ƒç”¨ï¼ˆLogix é›†æˆç²¾ç®€ç‰ˆ Effect è¿è¡Œæ—¶ï¼‰ã€‚

### 4.3 Hybrid Flow (æ··åˆè¿è¡Œæ—¶)
- **æ¦‚å¿µ**ï¼šä¸€ä¸ª Flow å¯èƒ½æ¨ªè·¨å‰åç«¯ã€‚ä¾‹å¦‚ï¼šå‰ç«¯æ ¡éªŒ -> åç«¯æäº¤ -> å‰ç«¯æ›´æ–°çŠ¶æ€ã€‚
- **å®ç°**ï¼šå¹³å°è‡ªåŠ¨å°† Flow åˆ‡åˆ†ä¸ºâ€œå‰ç«¯æ®µâ€å’Œâ€œåç«¯æ®µâ€ï¼Œå¹¶ç”Ÿæˆä¸­é—´çš„èƒ¶æ°´ä»£ç ï¼ˆAPI è°ƒç”¨ã€Loading çŠ¶æ€ç®¡ç†ã€é”™è¯¯å›æ»šï¼‰ã€‚

#### ç¼–è¯‘å®ä¾‹ï¼šä»ç”»å¸ƒåˆ°ä»£ç 

åœºæ™¯ï¼š**â€œç‚¹å‡»ä¿å­˜æŒ‰é’® -> æ ¡éªŒè¡¨å• -> æäº¤æ•°æ® -> æˆåŠŸåå…³é—­å¼¹çª—å¹¶åˆ·æ–°åˆ—è¡¨â€**

**1. ç”»å¸ƒæ„å›¾ (Intent)**
- **UI èŠ‚ç‚¹**: `SaveButton`, `EditModal`, `OrderList`
- **é€»è¾‘èŠ‚ç‚¹**: `SubmitFlow` (åŒ…å«æ ¡éªŒã€æäº¤ API)
- **è¿çº¿**: 
  - `SaveButton` -> `SubmitFlow` (Trigger)
  - `SubmitFlow` (Success) -> `EditModal` (Close)
  - `SubmitFlow` (Success) -> `OrderList` (Refresh)

**2. ç¼–è¯‘äº§ç‰© A: å‰ç«¯ Logix (`order.module.ts`)**
```typescript
// è‡ªåŠ¨ç”Ÿæˆçš„ Logix Logic
logic: (api) => [
  // 1. Interaction: ç‚¹å‡»æŒ‰é’® -> è§¦å‘ submit ä¿¡å·
  // UIç»„ä»¶çš„onClickå¤„ç†å™¨ä¼šè°ƒç”¨: dispatch({ _tag: 'submit' })


  // 2. Behavior: æ”¶åˆ° submit ä¿¡å· -> è°ƒç”¨åç«¯ Flow
  flow.fromAction(a => a._tag === 'submit').pipe(
    flow.run(
    Effect.gen(function*() {
      yield* ops.set('isSubmitting', true);
      // è‡ªåŠ¨ç”Ÿæˆçš„èƒ¶æ°´ä»£ç ï¼šè°ƒç”¨åç«¯ Effect Flow
      yield* runFlow('submitOrderFlow', { ...ops.get() });
      yield* ops.set('isSubmitting', false);
            yield* dispatch({ _tag: 'submitSuccess' });
    }).pipe(
      Effect.catchAll(err => ops.set('error', err))
    )
  ),

  // 3. UI Effect: æ”¶åˆ° success ä¿¡å· -> å…³é—­å¼¹çª— & åˆ·æ–°åˆ—è¡¨
  flow.fromAction(a => a._tag === 'submitSuccess').pipe(
    flow.run(
      // è¿™é‡Œçš„UIæ“ä½œå¯ä»¥é€šè¿‡æ›´æ–°çŠ¶æ€æ¥è§¦å‘ï¼Œæˆ–è°ƒç”¨ä¸€ä¸ªUIæœåŠ¡
      state.mutate(draft => { 
        draft.showModal = false; 
        draft.needsRefresh = true; 
      })
    )
  )
]
```

**3. ç¼–è¯‘äº§ç‰© B: åç«¯ Effect (`submit-order.flow.ts`)**
```typescript
// çº¯ç²¹çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸å« UI ç»†èŠ‚
export const submitOrderFlow = (input: OrderInput) => 
  Effect.gen(function*() {
    yield* validateOrder(input);
    const order = yield* OrderService.create(input);
    yield* NotificationService.sendCreated(order);
    return order;
  });
```

## 5. UI æ˜ å°„ç­–ç•¥

ä¸ºäº†å¹³è¡¡æ˜“ç”¨æ€§ä¸ä¸“ä¸šæ€§ï¼ŒFlow Intent åœ¨ UI ä¸Šæ”¯æŒ**æ¸è¿›å¼è¡¨è¾¾**ï¼š

1.  **åˆ—è¡¨è§†å›¾ (The Checklist)**ï¼šé»˜è®¤è§†å›¾ã€‚å°†çº¿æ€§çš„ DAG æ¸²æŸ“ä¸ºç®€å•çš„æ­¥éª¤åˆ—è¡¨ï¼Œéšè—å¤æ‚çš„åˆ†æ”¯å’Œå¹¶è¡Œç»†èŠ‚ã€‚é€‚åˆ 80% çš„ CRUD åœºæ™¯ã€‚
2.  **ç”»å¸ƒè§†å›¾ (The Canvas)**ï¼šé«˜çº§è§†å›¾ã€‚å®Œæ•´æ¸²æŸ“ Nodes + Edges + Groupsã€‚é€‚åˆå¤„ç†å¹¶è¡Œã€ç«æ€ã€å¤æ‚é”™è¯¯å¤„ç†ç­‰åœºæ™¯ã€‚

ç”¨æˆ·å¯ä»¥åœ¨ä¸¤ç§è§†å›¾é—´æ— ç¼åˆ‡æ¢ï¼Œåº•å±‚æ•°æ®å§‹ç»ˆä¿æŒä¸ºåŒä¸€ä»½ DAG ç»“æ„ã€‚
</file>

<file path="intent-driven-ai-coding/v3/design/code-structure.md">
---
title: å·¥ç¨‹ç»“æ„æ„å›¾ (Code Structure Intent)
status: draft
version: 3
---

> æœ¬æ–‡å®šä¹‰äº† v2 æ¶æ„ä¸‹çš„å·¥ç¨‹ç»“æ„æ¨¡å‹ï¼šå¦‚ä½•å°†æŠ½è±¡çš„ Intent æ˜ å°„ä¸ºå…·ä½“çš„ç‰©ç†æ–‡ä»¶ï¼Œç‰¹åˆ«æ˜¯åŒè¿è¡Œæ—¶æ¶æ„ä¸‹çš„äº§ç‰©è½ç‚¹ã€‚

## 1. æ ¸å¿ƒå®šä¹‰

Code Structure Intent å›ç­”ï¼š**â€œæ„å›¾æœ€ç»ˆå˜æˆäº†å“ªäº›æ–‡ä»¶ï¼Ÿæ”¾åœ¨å“ªé‡Œï¼Ÿâ€**

å®ƒè¿æ¥äº† Intent æ¨¡å‹ä¸ç‰©ç†æ–‡ä»¶ç³»ç»Ÿã€‚åœ¨ v2 æ¶æ„ä¸­ï¼Œç”±äºå¼•å…¥äº†åŒè¿è¡Œæ—¶ï¼ˆEffect/Logix Engineï¼‰ï¼Œæ–‡ä»¶ç»“æ„å˜å¾—æ›´åŠ åˆ†å±‚å’Œæ¨¡å—åŒ–ã€‚

## 2. æ ‡å‡†ç›®å½•ç»“æ„ (Standard Directory Layout)

åŸºäº `best-practice` å’Œ v2 æ¶æ„ï¼Œå»ºè®®é‡‡ç”¨**é¢†åŸŸé©±åŠ¨ (DDD)** é£æ ¼çš„åˆ†å±‚ç»“æ„ï¼Œä»¥æ”¯æŒä¼ä¸šçº§å¤æ‚åº¦ï¼š

```text
src/features/order/
â”œâ”€â”€ module/                 # é¢†åŸŸå±‚ (çº¯å¥‘çº¦ï¼Œæ— å‰¯ä½œç”¨å®ç°)
â”‚   â”œâ”€â”€ Order.schema.ts     # Entity Schema (Data Intent)
â”‚   â””â”€â”€ OrderApi.ts         # Service Interface / Tag å®šä¹‰
â”œâ”€â”€ infrastructure/         # åŸºç¡€è®¾æ–½å±‚ (å‰¯ä½œç”¨å®ç°)
â”‚   â””â”€â”€ OrderApiLive.ts     # Service Implementation (Http/RPC Call)
â”œâ”€â”€ application/            # åº”ç”¨å±‚ (æµç¨‹ä¸çŠ¶æ€)
â”‚   â”œâ”€â”€ flows/              # åç«¯ Effect æµç¨‹ (Behavior Intent)
â”‚   â”‚   â””â”€â”€ submit-order.flow.ts
â”‚   â””â”€â”€ stores/             # å‰ç«¯ Logix çŠ¶æ€ (Interaction Intent)
â”‚       â””â”€â”€ order.store.ts
â”œâ”€â”€ components/             # è¡¨ç°å±‚ (View Intent)
â”‚   â”œâ”€â”€ OrderTable.tsx
â”‚   â””â”€â”€ OrderForm.tsx
â””â”€â”€ index.ts                # æ¨¡å—å‡ºå£ (å¯¼å‡º RuntimeLayer)
```

è¿™ç§ç»“æ„æ¸…æ™°åœ°åˆ†ç¦»äº†**å¥‘çº¦ (Module)** ä¸ **å®ç° (Infrastructure)**ï¼Œå¤©ç„¶å¥‘åˆ Effect-ts çš„ `Tag` vs `Layer` æ¨¡å¼ã€‚

## 3. è¿è¡Œæ—¶äº§ç‰©è½ç‚¹ (Runtime Artifacts)

æ ¹æ® `runtimeTarget` çš„ä¸åŒï¼ŒBehavior & Flow Intent ä¼šç”Ÿæˆä¸åŒçš„æ–‡ä»¶ï¼š

### 3.1 Target: Effect Flow Runtime
- **è½ç‚¹**ï¼š`src/features/*/application/flows/*.flow.ts`
- **å†…å®¹**ï¼š
  - å¯¼å‡ºä¸€ä¸ªæˆ–å¤šä¸ª Effect ç¨‹åºå‡½æ•°ã€‚
  - å¼•ç”¨ `module/*` ä¸­çš„ Tag å®šä¹‰ï¼ˆEnv ä¾èµ–ï¼‰ã€‚
  - çº¯ç²¹çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ—  UI ä¾èµ–ã€‚

### 3.4 Env ä¸ Layer çš„è‡ªåŠ¨åŒ–

å¹³å°åœ¨å‡ºç æ—¶ä¼šè‡ªåŠ¨å¤„ç† Effect çš„ä¾èµ–æ³¨å…¥ï¼š
- **Tag å®šä¹‰**ï¼šåœ¨ `module/OrderApi.ts` ä¸­ç”Ÿæˆ `Context.Tag`ã€‚
- **Layer å®ç°**ï¼šåœ¨ `infrastructure/OrderApiLive.ts` ä¸­ç”Ÿæˆ `Layer.effect`ã€‚
- **Runtime èšåˆ**ï¼šåœ¨ `index.ts` ä¸­è‡ªåŠ¨ç”Ÿæˆ `OrderFeatureLayer`ï¼Œé€šè¿‡ `Layer.mergeAll` èšåˆè¯¥æ¨¡å—æ‰€æœ‰æœåŠ¡çš„ Live å®ç°ï¼Œä¾›æ ¹è¿è¡Œæ—¶ä½¿ç”¨ã€‚

### 3.2 Target: Logix Engine
- **è½ç‚¹**ï¼š`src/features/*/stores/*.store.ts`
- **å†…å®¹**ï¼š
  - `makeStore` é…ç½®å¯¹è±¡ã€‚
  - `logic` æ•°ç»„ä¸­åŒ…å«ç¼–è¯‘åçš„ `Logic` è§„åˆ™ã€‚
  - å¼•ç”¨ `*.schema.ts` ä¸­çš„æ•°æ®å®šä¹‰ã€‚

### 3.3 Hybrid Flow (èƒ¶æ°´ä»£ç )
- **è½ç‚¹**ï¼šé€šå¸¸å†…è”åœ¨ `*.store.ts` çš„ Logic è§„åˆ™ä¸­ï¼Œæˆ–è€…ä½œä¸ºç‹¬ç«‹çš„ `src/features/*/glue/*.ts` æ–‡ä»¶ã€‚
- **å†…å®¹**ï¼š
  - è´Ÿè´£è°ƒç”¨åç«¯ Flow APIã€‚
  - ç®¡ç† Loading / Error çŠ¶æ€ã€‚
  - å¤„ç†æ•°æ®æ ¼å¼è½¬æ¢ã€‚

## 4. UI æ˜ å°„ç­–ç•¥

åœ¨å¹³å°çš„â€œè‡ªç”±ç”»å¸ƒâ€è§†å›¾ä¸­ï¼ŒCode Structure Intent è¡¨ç°ä¸º**æ¨¡å—å›¾ (Module Graph)**ï¼š

1.  **æ–‡ä»¶æ ‘è§†å›¾**ï¼šä¼ ç»Ÿçš„ IDE ä¾§è¾¹æ æ–‡ä»¶æ ‘ã€‚
2.  **æ¶æ„æ‹“æ‰‘å›¾**ï¼š
    - å±•ç¤º Feature æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚
    - å±•ç¤º Storeã€Flowã€Component ä¹‹é—´çš„å¼•ç”¨å…³ç³»ã€‚
    - ç”¨æˆ·å¯ä»¥æ‹–æ‹½æ–‡ä»¶èŠ‚ç‚¹æ¥é‡æ„ç›®å½•ç»“æ„ï¼ˆRefactorï¼‰ã€‚

## 5. è‡ªåŠ¨åŒ–ä¸ Plan

Code Structure Intent é€šå¸¸ä¸éœ€ç”¨æˆ·æ‰‹åŠ¨ç¼–å†™ï¼Œè€Œæ˜¯ç”± **Plan Generator** æ ¹æ®å…¶ä»– Intent è‡ªåŠ¨ç”Ÿæˆï¼š

1.  ç”¨æˆ·å®šä¹‰äº† `Order` å®ä½“å’Œ `submitOrder` æµç¨‹ã€‚
2.  Plan Generator åˆ†æä¾èµ–ï¼Œè‡ªåŠ¨è§„åˆ’å‡º `order.schema.ts`, `order.store.ts`, `submit-order.flow.ts` ç­‰æ–‡ä»¶è·¯å¾„ã€‚
3.  ç”¨æˆ·åœ¨â€œé¢„è§ˆè§†å›¾â€ä¸­ç¡®è®¤æ–‡ä»¶åˆ—è¡¨ï¼Œç‚¹å‡»â€œç”Ÿæˆâ€è½åœ°åˆ°ç£ç›˜ã€‚
</file>

<file path="intent-driven-ai-coding/v3/design/constraints-and-quality.md">
---
title: çº¦æŸä¸è´¨é‡æ„å›¾ (Constraint & Quality Intent)
status: draft
version: 3
---

> æœ¬æ–‡å®šä¹‰äº† v2 æ¶æ„ä¸‹çš„éåŠŸèƒ½æ€§éœ€æ±‚æ¨¡å‹ï¼šå¦‚ä½•å°†æ€§èƒ½ã€å¯é æ€§ã€å®‰å…¨ç­‰çº¦æŸæ¡ä»¶ï¼Œç¼–è¯‘ä¸ºåŒè¿è¡Œæ—¶ï¼ˆEffect/Logix Engineï¼‰çš„å…·ä½“ç­–ç•¥ã€‚

## 1. æ ¸å¿ƒå®šä¹‰

Constraint & Quality Intent å›ç­”ï¼š**â€œç³»ç»Ÿä¸ä»…è¦è·‘é€šï¼Œè¿˜è¦è·‘å¾—å¥½ã€è·‘å¾—ç¨³ã€‚â€**

å®ƒé€šå¸¸ä¸ç›´æ¥ç”Ÿæˆä¸šåŠ¡é€»è¾‘ä»£ç ï¼Œè€Œæ˜¯ä½œä¸º**å…ƒæ•°æ® (Metadata)** é™„ç€åœ¨ Flowã€Data æˆ– Interaction ä¸Šï¼ŒæŒ‡å¯¼ç¼–è¯‘å™¨ç”Ÿæˆç‰¹å®šçš„**ä¸­é—´ä»¶ (Middleware)** æˆ– **ç­–ç•¥é…ç½® (Policy)**ã€‚

## 2. è¿è¡Œæ—¶åˆ†å‘ç­–ç•¥

ä¸åŒçš„ Runtime Target å¯¹çº¦æŸçš„å®ç°æ–¹å¼å®Œå…¨ä¸åŒã€‚Intent å±‚ç»Ÿä¸€æè¿°çº¦æŸï¼Œç¼–è¯‘å™¨è´Ÿè´£åˆ†å‘ã€‚

### 2.1 é€šç”¨çº¦æŸ (Universal Constraints)

| çº¦æŸç±»å‹ | Intent æè¿° | Effect Runtime å®ç° | Logix Runtime å®ç° |
| :--- | :--- | :--- | :--- |
| **è¶…æ—¶ (Timeout)** | `timeout: '5s'` | `Effect.timeout('5s')` | `AbortController` / `RxJS.timeout` |
| **é‡è¯• (Retry)** | `retry: { times: 3 }` | `Effect.retry({ times: 3 })` | `retry` ä¸­é—´ä»¶ / ç­–ç•¥ |
| **å¹¶å‘ (Concurrency)** | `concurrency: 'serial'` | `Effect.all(..., { concurrency: 1 })` | `switchMap` / `concatMap` |

### 2.2 ç‰¹å®šè¿è¡Œæ—¶çº¦æŸ

#### A. ä»…é™ Effect Runtime (æœåŠ¡ç«¯)
- **äº‹åŠ¡ (Transaction)**ï¼š`transactional: true` -> ç¼–è¯‘ä¸º `Effect.scoped(db.transaction(...))`ã€‚
- **å®¡è®¡ (Audit)**ï¼š`audit: true` -> ç¼–è¯‘ä¸º `AuditLayer` æ³¨å…¥ã€‚
- **ç†”æ–­ (Circuit Breaker)**ï¼š`circuitBreaker: { ... }` -> ç¼–è¯‘ä¸ºç†”æ–­å™¨ä¸­é—´ä»¶ã€‚

#### B. ä»…é™ Logix Runtime (å‰ç«¯)
- **é˜²æŠ– (Debounce)**ï¼š`debounce: '500ms'` -> ç¼–è¯‘ä¸º `flow.debounce(500)`ã€‚
- **èŠ‚æµ (Throttle)**ï¼š`throttle: '1s'` -> ç¼–è¯‘ä¸º `flow.throttle(1000)`ã€‚
- **ä¹è§‚æ›´æ–° (Optimistic)**ï¼š`optimistic: true` -> ç¼–è¯‘ä¸º Store çš„ä¹è§‚ UI æ›´æ–°é€»è¾‘ã€‚

## 3. Schema å®šä¹‰

```typescript
interface ConstraintIntent {
  // è¿è¡Œæ—¶æ— å…³
  performance?: {
    timeout?: string
    concurrency?: number | 'unbounded'
  }
  reliability?: {
    retry?: { times: number; delay?: string }
    circuitBreaker?: boolean
  }
  
  // å‰ç«¯ç‰¹æœ‰
  interaction?: {
    debounce?: string
    throttle?: string
  }
  
  // åç«¯ç‰¹æœ‰
  transaction?: boolean
  audit?: boolean
}
```

## 4. ç¼–è¯‘å®ä¾‹

å‡è®¾ä¸€ä¸ª Flow Intent é…ç½®äº† `retry: 3` å’Œ `audit: true`ã€‚

**Target: Effect Runtime**
```typescript
export const myFlow = Effect.gen(function*() {
  // ... ä¸šåŠ¡é€»è¾‘ ...
}).pipe(
  // ç¼–è¯‘å™¨è‡ªåŠ¨åŒ…è£¹é‡è¯•ç­–ç•¥
  Effect.retry({ times: 3 }),
  // ç¼–è¯‘å™¨è‡ªåŠ¨æ³¨å…¥å®¡è®¡
  AuditService.middleware()
);
```

**Target: Logix Runtime**
```typescript
// å‡è®¾é…ç½®äº† debounce
flow.fromState(s => s.searchKeyword).pipe(
  flow.debounce(500),
  flow.run(val => {
    // ...
  })
);
  // ...
}, { debounce: 500 }); // ç¼–è¯‘å™¨ç”Ÿæˆ options
```

## 5. UI æ˜ å°„ç­–ç•¥

åœ¨å¹³å°çš„â€œè‡ªç”±ç”»å¸ƒâ€è§†å›¾ä¸­ï¼ŒConstraint Intent è¡¨ç°ä¸º**å±æ€§é…ç½®é¢æ¿ (Property Panel)**ï¼š

1.  **é€‰ä¸­èŠ‚ç‚¹**ï¼šç”¨æˆ·ç‚¹å‡»ä¸€ä¸ª Flow èŠ‚ç‚¹æˆ–è¿çº¿ã€‚
2.  **é…ç½®çº¦æŸ**ï¼šåœ¨å³ä¾§é¢æ¿ä¸­å‹¾é€‰â€œå¼€å¯é‡è¯•â€ã€â€œå¼€å¯é˜²æŠ–â€ç­‰é€‰é¡¹ã€‚
3.  **å¯è§†åŒ–åé¦ˆ**ï¼šèŠ‚ç‚¹ä¸Šå‡ºç°å°å›¾æ ‡ï¼ˆå¦‚æ—¶é’Ÿå›¾æ ‡ä»£è¡¨è¶…æ—¶/é˜²æŠ–ï¼Œç›¾ç‰Œå›¾æ ‡ä»£è¡¨å®‰å…¨/äº‹åŠ¡ï¼‰ï¼Œç›´è§‚å±•ç¤ºå½“å‰çš„çº¦æŸçŠ¶æ€ã€‚
</file>

<file path="intent-driven-ai-coding/v3/design/data-and-state.md">
---
title: æ•°æ®/çŠ¶æ€æ„å›¾ (Module Intent)
status: draft
version: 3
---

> æœ¬æ–‡å®šä¹‰äº† v2 æ¶æ„ä¸‹çš„æ•°æ®æ¨¡å‹ï¼šä½œä¸ºä¸šåŠ¡å®ä½“çš„å•ä¸€äº‹å®æºï¼Œä¸º Signal Payload æä¾›ç±»å‹å®šä¹‰ï¼Œå¹¶æ˜ å°„ä¸º Logix Module çš„çŠ¶æ€ç»“æ„ï¼ˆstateSchema + initialStateï¼‰ã€‚

## 1. æ ¸å¿ƒå®šä¹‰

Module Intent å›ç­”ï¼š**â€œç³»ç»Ÿä¸­æœ‰å“ªäº›ä¸šåŠ¡å®ä½“ï¼Ÿå®ƒä»¬çš„çŠ¶æ€å¦‚ä½•æµè½¬ï¼Ÿâ€**

å®ƒä¸ä»…ä»…æ˜¯æ•°æ®åº“è¡¨ç»“æ„çš„æ˜ å°„ï¼Œæ›´æ˜¯**å…¨é“¾è·¯ç±»å‹ç³»ç»Ÿ (Type System)** çš„åŸºçŸ³ã€‚ä» UI ç»„ä»¶åˆ° Signal Payloadï¼Œå†åˆ° Logix Module å’Œåç«¯ APIï¼Œæ‰€æœ‰æ•°æ®ç»“æ„éƒ½å¿…é¡»å¼•ç”¨ Module Intent ä¸­å®šä¹‰çš„ Schemaã€‚

### 1.1 å…³é”®ç‰¹æ€§

1.  **Schema First**ï¼šæ‰€æœ‰æ•°æ®äº¤äº’ï¼ˆAPIã€Signalã€Moduleï¼‰å¿…é¡»å…ˆå®šä¹‰ Schemaã€‚æ¶ˆç­ `any` å’Œéšå¼ç±»å‹ã€‚
2.  **Signal ç±»å‹æº**ï¼šSignal Intent ä¸­çš„ `payloadSchemaId` ç›´æ¥å¼•ç”¨æœ¬å±‚çš„ Entity å®šä¹‰ã€‚
3.  **Logix æ˜ å°„**ï¼šEntity Schema ç›´æ¥æ˜ å°„ä¸º Logix Module çš„ `stateSchema` å’Œåˆå§‹å€¼ï¼ˆ`initialState`ï¼‰ã€‚

## 2. æ¨¡å‹è¯¦è§£

```typescript
interface ModuleIntent {
  entities: EntityIntent[]
  apis: ApiIntent[]
  stateSources?: StateSourceIntent[]
}

interface EntityIntent {
  id: string
  name: string
  description?: string
  fields: EntityFieldIntent[]

  // éªŒè¯è§„åˆ™ (Zod/Effect Schema)
  validation?: {
    rule: string // e.g. "email", "min(10)"
    message?: string
  }[]
}

interface EntityFieldIntent {
  name: string
  type: 'string' | 'number' | 'boolean' | 'date' | 'enum' | 'array' | 'object'
  required?: boolean
  defaultValue?: any
  enumValues?: string[]
  children?: EntityFieldIntent[] // åµŒå¥—ç»“æ„
}
```

## 3. å…¨é“¾è·¯ç±»å‹æ˜ å°„

Module Intent æ˜¯æ•´ä¸ªç³»ç»Ÿçš„â€œç±»å‹å­—å…¸â€ã€‚ä»¥ä¸‹æ˜¯å®ƒåœ¨ä¸åŒå±‚çº§çš„è½ç‚¹ï¼š

### 3.1 Signal Payload (é€šä¿¡å¥‘çº¦)

```typescript
// Intent
Signal: { name: "submitOrder", payloadSchemaId: "OrderInput" }
Module: { id: "OrderInput", fields: [...] }

// Code (TypeScript)
interface OrderInput { ... }
type SubmitOrderSignal = { type: 'submitOrder', payload: OrderInput }
```

### 3.2 Logix Module (å‰ç«¯çŠ¶æ€)

```typescript
// Intent
StateSource: { kind: "logix-engine", entityId: "OrderForm" }

// Code (Logix Module)
const OrderFormModule = Logix.Module("OrderForm", {
  state: OrderFormSchema,          // ç›´æ¥ä½¿ç”¨ Effect Schema
  actions: OrderFormActionSchema,  // è¡Œä¸ºæ„å›¾å¯¹åº”çš„ Action Schema
})

const OrderFormLive = OrderFormModule.live(
  initialOrderFormState,
  OrderFormLogic,
)
```

### 3.3 API Service & Layer (æœåŠ¡å±‚)

Module Intent ä¸­çš„ `apis` å®šä¹‰ä¸ä»…ç”Ÿæˆ DTOï¼Œè¿˜é©±åŠ¨æ•´ä¸ªæœåŠ¡å±‚çš„ç”Ÿæˆï¼š

1.  **Interface (Module)**ï¼šç”Ÿæˆ `OrderApi` Tagï¼Œå®šä¹‰ `create: (input: OrderInput) => Effect<Order>`ã€‚
2.  **Implementation (Infrastructure)**ï¼šç”Ÿæˆ `OrderApiLive` Layerï¼Œå†…éƒ¨ä½¿ç”¨ `Effect Http` å®ç°å…·ä½“çš„ RESTful è°ƒç”¨ã€‚
3.  **Repository (Optional)**ï¼šå¯¹äºå¤æ‚çš„èšåˆæ ¹å®ä½“ï¼Œå¯ç”Ÿæˆ `OrderRepository` æ¥å£ï¼Œå°è£…åº•å±‚çš„å¤šä¸ª API è°ƒç”¨æˆ–æœ¬åœ°ç¼“å­˜ç­–ç•¥ã€‚

```typescript
// Intent
Api: { name: "createOrder", inputSchemaId: "OrderInput" }

// Code: module/OrderApi.ts
export class OrderApi extends Context.Tag("OrderApi")<OrderApi, {
  create: (input: OrderInput) => Effect.Effect<Order>
}>() {}

// Code: infrastructure/OrderApiLive.ts
export const OrderApiLive = Layer.effect(OrderApi, Effect.gen(function*() {
  const client = yield* Http.Client;
  return {
    create: (input) => client.post('/orders', { body: input })...
  };
}));
```

## 4. UI æ˜ å°„ç­–ç•¥

åœ¨å¹³å°çš„â€œè‡ªç”±ç”»å¸ƒâ€è§†å›¾ä¸­ï¼ŒModule Intent è¡¨ç°ä¸º**å®ä½“èŠ‚ç‚¹ (Entity Node)**ï¼š

1.  **å¯è§†åŒ– ER å›¾**ï¼šå±•ç¤ºå®ä½“åŠå…¶å­—æ®µï¼Œæ”¯æŒæ‹–æ‹½å»ºç«‹å…³è”å…³ç³»ï¼ˆå¦‚ `Order` -> `OrderItem`ï¼‰ã€‚
2.  **Schema ç»‘å®š**ï¼š
    - ç”¨æˆ·åœ¨ç”»å¸ƒä¸Šç”»ä¸€ä¸ªâ€œè¡¨å•â€ï¼Œå¯ä»¥å°†å…¶ç»‘å®šåˆ°æŸä¸ªâ€œå®ä½“èŠ‚ç‚¹â€ã€‚
    - ç»‘å®šåï¼Œè¡¨å•å­—æ®µè‡ªåŠ¨æ ¹æ®å®ä½“å­—æ®µç”Ÿæˆï¼ˆLabel, Type, Validationï¼‰ã€‚

## 5. æœ€ä½³å®è·µ

- **è¯»å†™åˆ†ç¦»**ï¼šå»ºè®®ä¸ºâ€œè¯»å–ï¼ˆViewï¼‰â€å’Œâ€œå†™å…¥ï¼ˆInputï¼‰â€å®šä¹‰ä¸åŒçš„ Entity Schemaï¼ˆå¦‚ `Order` vs `OrderInput`ï¼‰ã€‚
- **åŸå­åŒ–**ï¼šå°½é‡å°† Schema å®šä¹‰ä¸ºåŸå­çš„ã€å¯å¤ç”¨çš„ç‰‡æ®µï¼Œé€šè¿‡ç»„åˆæ„å»ºå¤æ‚å¯¹è±¡ã€‚
</file>

<file path="intent-driven-ai-coding/v3/design/interaction.md">
---
title: äº¤äº’æ„å›¾ (Interaction Intent)
status: draft
version: 3
---

> æœ¬æ–‡å®šä¹‰äº† v2 æ¶æ„ä¸‹çš„äº¤äº’æ¨¡å‹ï¼šä½œä¸ºç‰©ç†ä¸–ç•Œä¸æ•°å­—ä¸–ç•Œçš„è½¬æ¢å™¨ï¼Œè´Ÿè´£å°†ç”¨æˆ·çš„åŸå§‹æ“ä½œè½¬åŒ–ä¸º UI åé¦ˆæˆ–ä¸šåŠ¡ä¿¡å· (Signal)ã€‚

## 1. æ ¸å¿ƒå®šä¹‰

Interaction Intent å›ç­”ï¼š**â€œç”¨æˆ·åšäº†ä»€ä¹ˆï¼Œç³»ç»Ÿå¦‚ä½•ç«‹å³å“åº”ï¼Ÿâ€**

å®ƒæ˜¯è¿æ¥ UI ç»„ä»¶ï¼ˆViewï¼‰ä¸ä¸šåŠ¡é€»è¾‘ï¼ˆBehaviorï¼‰çš„æ¡¥æ¢ã€‚å®ƒçš„æ ¸å¿ƒèŒè´£æ˜¯**â€œç¿»è¯‘â€**ï¼š
- å°†ç‰©ç†äº‹ä»¶ï¼ˆç‚¹å‡»ã€è¾“å…¥ï¼‰ç¿»è¯‘ä¸º **UI Effect**ï¼ˆå¼¹çª—ã€é«˜äº®ï¼‰ã€‚
- å°†ç‰©ç†äº‹ä»¶ç¿»è¯‘ä¸º **Business Signal**ï¼ˆæäº¤è®¢å•ã€åˆ·æ–°åˆ—è¡¨ï¼‰ã€‚

### 1.1 å…³é”®ç‰¹æ€§

1.  **Input -> Signal è½¬åŒ–**ï¼šè¿™æ˜¯ Logix æ¶æ„çš„æ ¸å¿ƒè¾“å…¥æºã€‚Interaction è´Ÿè´£å°†åº•å±‚çš„ DOM äº‹ä»¶ï¼ˆInputï¼‰æ˜ å°„ä¸ºè¯­ä¹‰åŒ–çš„ä¸šåŠ¡ä¿¡å·ï¼ˆSignalï¼‰ã€‚
2.  **çº¯ UI åé¦ˆ**ï¼šå¤„ç†ä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘çš„è§†è§‰å˜åŒ–ï¼ˆå¦‚æ‰“å¼€å¼¹çª—ã€åˆ‡æ¢ Tabï¼‰ï¼Œè¿™éƒ¨åˆ†é€šå¸¸ç›´æ¥ç”± UI æ¡†æ¶ï¼ˆReact/Logix Module/æœ¬åœ°çŠ¶æ€ï¼‰å¤„ç†ï¼Œä¸ç»è¿‡ Flow Runtimeã€‚
3.  **è§£è€¦**ï¼šInteraction å±‚çš„å˜åŒ–ï¼ˆå¦‚ä»æŒ‰é’®ç‚¹å‡»æ”¹ä¸ºå¿«æ·é”®è§¦å‘ï¼‰ä¸å½±å“ Behavior å±‚çš„é€»è¾‘ã€‚

## 2. æ¨¡å‹è¯¦è§£

```typescript
interface InteractionIntent {
  events: InteractionEventIntent[]
}

interface InteractionEventIntent {
  id: string
  // è§¦å‘æºï¼šå“ªä¸ªç»„ä»¶çš„å“ªä¸ªäº‹ä»¶
  source: string // e.g. "toolbar.addButton"
  event: 'click' | 'change' | 'hover' | 'keydown' | string
  
  // å“åº”åŠ¨ä½œ (Action)
  action: 
    | { type: 'uiEffect', effect: UiEffectIntent } // çº¯ UI åé¦ˆ
    | { type: 'dispatch', action: any } // æ´¾å‘ Action
    | { type: 'composite', actions: Action[] } // ç»„åˆåŠ¨ä½œ
}

interface UiEffectIntent {
  type:
    | 'openModal'
    | 'openDrawer'
    | 'closeModal'
    | 'toggle'
    | 'scrollIntoView'
    | 'selectRow'
    | 'none'
  target?: string // modalId/drawerId/elementId/rowId
}
```

## 3. ä¸ Behavior & Flow çš„è¿æ¥

åœ¨ v2 æ¶æ„ä¸­ï¼ŒInteraction ä¸å†ç›´æ¥è§¦å‘ Flowï¼Œè€Œæ˜¯é€šè¿‡ **Signal** è¿›è¡Œé—´æ¥è¿æ¥ï¼š

1.  **Interaction å±‚**ï¼š`Button.onClick` -> `dispatch({ _tag: "submitOrder" })`
2.  **Behavior å±‚**ï¼š`Logic` é€šè¿‡ `flow.fromAction(a => a._tag === 'submitOrder')` ç›‘å¬åŠ¨ä½œ

è¿™ç§è®¾è®¡å®ç°äº†å½»åº•çš„è§£è€¦ï¼š
- **å¤šå¯¹ä¸€**ï¼šå¤šä¸ª Interactionï¼ˆæŒ‰é’®ç‚¹å‡»ã€å¿«æ·é”®ã€è¯­éŸ³æŒ‡ä»¤ï¼‰å¯ä»¥è§¦å‘åŒä¸€ä¸ª Signalã€‚
- **ä¸€å¯¹å¤š**ï¼šä¸€ä¸ª Signalï¼ˆå¦‚â€œç™»å½•æˆåŠŸâ€ï¼‰å¯ä»¥è§¦å‘å¤šä¸ª Flowï¼ˆè·³è½¬é¡µé¢ã€æ‹‰å–ç”¨æˆ·ä¿¡æ¯ã€å»ºç«‹ WebSocketï¼‰ã€‚

## 4. UI æ˜ å°„ç­–ç•¥

åœ¨å¹³å°çš„â€œè‡ªç”±ç”»å¸ƒâ€è§†å›¾ä¸­ï¼ŒInteraction Intent è¡¨ç°ä¸º**é€»è¾‘è¿çº¿**ï¼š

1.  **UI -> UI è¿çº¿**ï¼š
    - ä»â€œæŒ‰é’®â€è¿å‘â€œå¼¹çª—â€ã€‚
    - å«ä¹‰ï¼šç‚¹å‡»æŒ‰é’®æ‰“å¼€å¼¹çª— (UI Effect)ã€‚
    - è§†è§‰ï¼šé€šå¸¸ç”¨è™šçº¿æˆ–ç‰¹å®šé¢œè‰²çš„çº¿è¡¨ç¤ºã€‚

2.  **UI -> Logic è¿çº¿**ï¼š
    - ä»â€œæŒ‰é’®â€è¿å‘â€œé€»è¾‘å¡ç‰‡/Flow èŠ‚ç‚¹â€ã€‚
    - å«ä¹‰ï¼šç‚¹å‡»æŒ‰é’®è§¦å‘è¯¥é€»è¾‘ (Dispatch Action)ã€‚
    - è§†è§‰ï¼šé€šå¸¸ç”¨å®çº¿è¡¨ç¤ºï¼Œçº¿ä¸Šå¯æ ‡æ³¨ Signal åç§°ã€‚

## 5. Logix è¿è¡Œæ—¶è½åœ°

å½“ `runtimeTarget = 'logix-engine'` æ—¶ï¼ŒInteraction Intent ä¼šè¢«ç¼–è¯‘ä¸º Logix çš„ Input ç›‘å¬è§„åˆ™ï¼š

```typescript
// ç¼–è¯‘å‰ (Intent)
{
  source: 'submitBtn',
  event: 'click',
  action: { type: 'dispatch', action: { _tag: 'submit' } }
}

// ç¼–è¯‘å (Logix Logic)
// åœ¨ React ç»„ä»¶ä¸­:
// <button onClick={() => dispatch({ _tag: 'submit', payload: extractPayload() })} />
```
</file>

<file path="intent-driven-ai-coding/v3/design/layout.md">
---
title: å¸ƒå±€æ„å›¾ï¼ˆLayout Intentï¼‰
status: draft
version: 2
---

> æœ¬æ–‡å®šä¹‰å¸ƒå±€æ„å›¾çš„å«ä¹‰ã€è¾¹ç•Œä¸ Schema è‰å›¾ï¼Œå¹¶ç»™å‡ºç¤ºä¾‹ã€‚

## 1. å®šä¹‰ä¸è¾¹ç•Œ

**å¸ƒå±€æ„å›¾ï¼ˆLayout Intentï¼‰åªå›ç­”ä¸‰ä¸ªé—®é¢˜ï¼š**

1. é¡µé¢æœ‰å¤šå°‘ä¸ªâ€œè¯­ä¹‰åŒºåŸŸâ€ï¼Ÿ
2. è¿™äº›åŒºåŸŸå¦‚ä½•æ’åˆ—ã€å æ¯”å¦‚ä½•ï¼Ÿï¼ˆä¸Š/ä¸‹/å·¦/å³ã€å¤šåˆ—/å•åˆ—ï¼‰
3. æ¯ä¸ªåŒºåŸŸåœ¨ä¸šåŠ¡ä¸Šæ‰®æ¼”ä»€ä¹ˆè§’è‰²ï¼Ÿï¼ˆfilters/table/toolbar/metrics/detail ç­‰ï¼‰

ä¸è´Ÿè´£ï¼š

- ç»„ä»¶å†…éƒ¨å¸ƒå±€ï¼ˆè¡¨å•é¡¹å¯¹é½æ–¹å¼ã€æŒ‰é’®é—´è·ï¼‰ï¼›
- è§†è§‰é£æ ¼ï¼ˆé¢œè‰²ã€é˜´å½±ã€åœ†è§’ï¼‰ï¼›
- è¡Œä¸º/æ•°æ®/å·¥ç¨‹ç»“æ„ç­‰å…¶å®ƒæ„å›¾å±‚ã€‚

## 2. LayoutIntent v2 Schema è‰å›¾

```ts
interface LayoutRegionIntent {
  id: string
  label: string
  role:
    | 'filters'
    | 'toolbar'
    | 'table'
    | 'metrics'
    | 'detail'
    | 'sidebar'
    | 'footer'
    | string
}

interface LayoutIntent {
  layoutType: 'list-page' | 'workbench' | 'dashboard' | 'custom'
  regions: LayoutRegionIntent[]
  // å¯é€‰ï¼šç”¨äº layout å¼•æ“çš„ç»“æ„æ ‘ï¼ˆç”±ç½‘æ ¼çº¿ç¨¿æˆ–å…¶å®ƒäº¤äº’ç”Ÿæˆï¼‰
  tree?: LayoutNode
}
```

åœ¨ IntentSpec v2 ä¸­ï¼š

```ts
interface IntentSpecV2 {
  // ...
  layout: LayoutIntent
  // å…¶å®ƒæ„å›¾å±‚ï¼šview/interaction/behavior/data/codeStructure/constraints
}
```

## 3. ä¸ Pattern/Template çš„å…³ç³»

- layout Patternï¼ˆå¦‚ `workbench-layout`ã€`list-page-shell`ï¼‰ä¸»è¦ä½œç”¨äº Layout + View ä¸¤å±‚ï¼š
  - LayoutIntent å†³å®šæœ‰å“ªäº›åŒºåŸŸã€å¦‚ä½•æ’åˆ—ï¼›
  - Pattern è´Ÿè´£æŠŠè¿™äº›åŒºåŸŸæ˜ å°„ä¸ºå®¹å™¨ç»„ä»¶/Slot ç»“æ„ï¼›
  - Template åˆ™ç”Ÿæˆå®é™…çš„å¸ƒå±€ Shell ä»£ç ï¼ˆReact ç»„ä»¶ã€Tailwind ç±»ç­‰ï¼‰ã€‚
- åœ¨ PatternSpec v2 ä¸­ï¼Œlayout å‹æ¨¡å¼åº”å£°æ˜ï¼š

```yaml
intentLayers:
  - layout
  - view
```

## 4. äº¤äº’å½¢æ€å»ºè®®ï¼ˆä¸é™å®šå®ç°ï¼‰

å¸ƒå±€æ„å›¾çš„è¡¨è¾¾å½¢æ€å¯ä»¥æœ‰å¤šç§ï¼š

- ç½‘æ ¼çº¿ç¨¿ï¼ˆè¯¦è§ v1 `design/layout.md`ï¼‰ï¼šnÃ—m ç½‘æ ¼ + åŒºåŸŸä¸Šè‰² + è¯­ä¹‰æ ‡ç­¾ï¼›
- åŒºåŸŸåˆ—è¡¨ + é¢„è®¾å¸ƒå±€æ¨¡æ¿ï¼š
  - å…ˆé€‰æ¨¡æ¿ï¼ˆå¦‚â€œåˆ—è¡¨é¡µä¸‰æ®µå¼â€ã€â€œå·¥ä½œå°ä¸‰æ å¼â€ï¼‰ï¼›
  - å†ä¸ºæ¯ä¸ªåŒºåŸŸå¡« id/label/roleï¼›
- ç›´æ¥åœ¨ Intent Studio çš„ Layout é¢æ¿ä¸­ç¼–è¾‘ç»“æ„æ ‘ï¼ˆé€‚åˆé«˜çº§ç”¨æˆ·ï¼‰ã€‚

å¹³å°åº”å½“ï¼š

- ä¸ºâ€œçº¿ç¨¿çº§â€å¸ƒå±€è¡¨è¾¾æä¾›ä½é—¨æ§›äº¤äº’ï¼ˆç”»æ ¼å­/é€‰æ¨¡æ¿å³å¯ï¼‰ï¼›
- ä¸º LLM æä¾›ç»“æ„åŒ– LayoutIntentï¼Œé¿å…æ¨¡å‹ä» Figma/æˆªå›¾ä¸­ç¡¬çŒœå¸ƒå±€ï¼›
- åœ¨ Plan/Template å±‚ç»Ÿä¸€æŠŠ LayoutIntent æ˜ å°„ä¸ºå¸ƒå±€ç»„ä»¶éª¨æ¶ï¼Œè€Œä¸æ˜¯æ¯æ¬¡ä¸´æ—¶å†™å¸ƒå±€ä»£ç ã€‚
</file>

<file path="intent-driven-ai-coding/v3/design/orchestration-and-wizards.md">
---
title: ç¼–æ’ä¸å‘å¯¼äº¤äº’ (Link & Wizards)
status: draft
version: 3 (Auto-Generated)
---

> **æ ¸å¿ƒç†å¿µ**ï¼šç¼–æ’å³é…ç½®ã€‚é€šè¿‡ `definePattern` æä¾›çš„ Schemaï¼Œå¹³å°è‡ªåŠ¨ç”Ÿæˆé…ç½®å‘å¯¼ (Wizard)ï¼Œè®©å¤æ‚çš„é€»è¾‘ç¼–æ’å˜æˆç®€å•çš„è¡¨å•å¡«å†™ã€‚
> **æœ¯è¯­æ³¨**ï¼šæœ¬æ–‡æ¡£ä¸­çš„â€œç¼–æ’â€åœ¨æ¶æ„å®ä½“ä¸Šå¯¹åº” **Link**ã€‚Link åœ¨è¿è¡Œæ—¶å¹¶éç‹¬ç«‹åŸè¯­ï¼Œè€Œæ˜¯ **Logic** çš„ä¸€ç§ç‰¹æ®Šå½¢æ€ï¼ˆè·¨æ¨¡å—åä½œï¼‰ï¼Œä»£ç ä¸Šä½“ç°ä¸º `$.use()` + `$.on()` çš„ç»„åˆã€‚

## 1. è‡ªåŠ¨åŒ–å‘å¯¼ (Auto-Generated Wizards)

åœ¨ v3 æ¶æ„ä¸­ï¼Œæˆ‘ä»¬ä¸å†æ‰‹åŠ¨å¼€å‘ Wizard UIã€‚ä¸€åˆ‡ UI å‡ç”± Schema é©±åŠ¨ã€‚

### 1.1 é©±åŠ¨æºï¼š`PatternSpec.config`

```typescript
// Pattern å®šä¹‰
config: Schema.Struct({
  delay: Schema.Number.pipe(Schema.default(500)),
  target: Schema.String
})
```

### 1.2 æ¸²æŸ“å¼•æ“
å¹³å°å†…ç½® **Schema Form Renderer**ï¼Œå°†ä¸Šè¿° Schema æ¸²æŸ“ä¸ºï¼š
*   `delay`: æ•°å­—è¾“å…¥æ¡† (é»˜è®¤å€¼ 500)ã€‚
*   `target`: æ–‡æœ¬è¾“å…¥æ¡† (æˆ–ä¸‹æ‹‰é€‰ï¼Œå¦‚æœä½¿ç”¨äº† Enum)ã€‚

## 2. ç¼–æ’æµç¨‹ (The Link Flow)

### 2.1 æ§½ä½è¯†åˆ« (Slot Recognition)
å¹³å°åˆ†æä»£ç ï¼Œè¯†åˆ«å‡ºå¯ä»¥æ’å…¥é€»è¾‘çš„â€œç©ºä½â€ï¼š
*   `yield* flow.fromAction(a => a.type === 'click').pipe(/* Slot */)`
*   `yield* $.match(cond).when(true, ...).when(false, ...)`

### 2.2 AI æ¨è (AI Recommendation)
ç”¨æˆ·ç‚¹å‡»æ§½ä½ï¼ŒAI åˆ†æä¸Šä¸‹æ–‡ (Context) å¹¶æ¨è Patternã€‚

*   **Context**: "è¿™æ˜¯ä¸€ä¸ªæäº¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶"ã€‚
*   **Recommendation**:
    1. `StandardSubmit` (90%)
    2. `OptimisticUpdate` (60%)

### 2.3 å¡«è¡¨ (Configuration)
ç”¨æˆ·é€‰æ‹© `StandardSubmit`ï¼Œå¼¹å‡ºè‡ªåŠ¨ç”Ÿæˆçš„ Wizard è¡¨å•ã€‚ç”¨æˆ·å¡«å†™å‚æ•°ã€‚

### 2.4 ä»£ç ç”Ÿæˆ (Codegen)
ç¡®è®¤åï¼Œå¹³å°ç”Ÿæˆä»£ç å¹¶æ’å…¥æ§½ä½ï¼š

```typescript
// Before
yield* flow.fromAction(a => a.type === 'click').pipe(flow.run(Effect.void));

// After (AI Generated)
yield* flow.fromAction(a => a.type === 'click').pipe(
  flow.run(StandardSubmit({ service: "Order", method: "create" }))
);
```

## 3. æ··åˆè§†å›¾äº¤äº’ (Hybrid Interaction)

### 3.1 å®è§‚ç¼–æ’ (L2 View)
åœ¨ L2 è§†å›¾ä¸­ï¼Œç”¨æˆ·çœ‹åˆ°çš„æ˜¯ **Link Node** æˆ– **Pattern Block**ã€‚è¿çº¿è¡¨ç¤º Pattern ä¹‹é—´çš„ä¿¡å·æµã€‚

### 3.2 å¾®è§‚é€è§† (L3 View)
ç”¨æˆ·å¯ä»¥åŒå‡» Pattern Block è¿›å…¥ L3 è§†å›¾ã€‚
*   **Managed Pattern**: æ˜¾ç¤ºä¸ºåªè¯»çš„ DSL æµç¨‹å›¾ã€‚ç”¨äºç†è§£å†…éƒ¨é€»è¾‘ã€‚
*   **Ejected Logic**: æ˜¾ç¤ºä¸ºå¯ç¼–è¾‘çš„ DSL èŠ‚ç‚¹æˆ–ä»£ç ç¼–è¾‘å™¨ã€‚

## 4. AI è¾…åŠ©é‡æ„ (AI Refactoring)

AI ä¸ä»…èƒ½ç”Ÿæˆï¼Œè¿˜èƒ½é‡æ„ã€‚

*   **Extract Pattern**: é€‰ä¸­ä¸€æ®µæ•£ä¹±çš„ DSL èŠ‚ç‚¹ -> "Extract to Pattern" -> AI ç”Ÿæˆ `definePattern` ä»£ç ã€‚
*   **Upgrade Pattern**: å½“ Pattern åº“æ›´æ–°æ—¶ï¼ŒAI è‡ªåŠ¨æ‰«æä»£ç ï¼Œæç¤ºå‡çº§å¹¶è¿ç§»å‚æ•°ã€‚
</file>

<file path="intent-driven-ai-coding/v3/design/pattern-system.md">
---
title: æ¨¡å¼ç³»ç»Ÿè®¾è®¡ (Pattern System Design)
status: draft
version: 8 (Effect-Native-Simplified)
---

> **æ ¸å¿ƒå…±è¯†**ï¼šåœ¨ v3 é˜¶æ®µï¼ŒPattern çš„è¿è¡Œæ—¶å®šä¹‰å·²ç»æ”¶æ•›ä¸ºâ€œæ™®é€šçš„ `(input) => Effect` å‡½æ•°â€ï¼Œå¹³å°ä¾§åªåœ¨å…¶å¤–éƒ¨åŒ…ä¸€å±‚èµ„äº§ metadataï¼ˆid / configSchema / tags ç­‰ï¼‰ã€‚
> æœ¬æ–‡ä»¶ç”¨äºè¡¥å…… Pattern åœ¨ v3 ä½“ç³»ä¸­çš„è§’è‰²ï¼Œèšç„¦æœ€å°å¿…è¦çº¦å®šï¼Œæ—©æœŸæ„æƒ³çš„ `definePattern` / è‡ªå®šä¹‰ DSL / Spy Runtime ç­‰é«˜çº§ç‰¹æ€§æ­£å¼è§†ä¸ºå†å²æ€è·¯ï¼Œä¸å†ä½œä¸ºå½“å‰è§„èŒƒçš„ä¸€éƒ¨åˆ†ã€‚

## 1. Pattern èµ„äº§å®šä¹‰

åœ¨ v3 æ¶æ„ä¸­ï¼ŒPattern ä¸å†æ˜¯é™æ€é…ç½®ï¼Œè€Œæ˜¯æ ‡å‡†çš„ TypeScript ä»£ç èµ„äº§ã€‚

- **Pattern Functionï¼ˆæºç å½¢æ€ï¼‰**ï¼šå½¢å¦‚ `(config: C) => Effect.Effect<A, E, R>` çš„æ™®é€šå‡½æ•°ï¼Œå†…éƒ¨ä½¿ç”¨ Effect / Store / Logic / Flow / Control ç­‰åŸè¯­å®Œæˆä¸šåŠ¡é€»è¾‘ï¼›
- **Pattern Assetï¼ˆå¹³å°å½¢æ€ï¼‰**ï¼šåœ¨ Pattern Function å¤–å†åŒ…ä¸€å±‚ metadataï¼ˆid / version / configSchema / tags ç­‰ï¼‰ï¼Œç”¨äºå¹³å°æ³¨å†Œã€å¯è§†åŒ–å’Œæ²»ç†ã€‚

å¼€å‘è€…æ—¥å¸¸ä¸»è¦å…³å¿ƒ **Pattern Function** çš„ç¼–å†™ï¼›Pattern Asset å¯ä»¥ç”± Builder / CLI å·¥å…·è‡ªåŠ¨ç”Ÿæˆæˆ–è¡¥å…¨ã€‚

## 2. Pattern çš„å½¢æ€åˆ†ç±»

### 2.1 åŸå­ Pattern (Atomic Pattern)
åªåŒ…å«å•ä¸€åŠŸèƒ½çš„é€»è¾‘ç‰‡æ®µï¼Œé€šå¸¸ç”¨äºæ›¿ä»£åŸºç¡€ç®—å­ã€‚
*   **ç¤ºä¾‹**: `Debounce`, `Retry`, `Poll`ã€‚
*   **ç”»å¸ƒè¡¨ç°**: å°å‹çš„åŠŸèƒ½èŠ‚ç‚¹ã€‚

### 2.2 åœºæ™¯ Pattern (Scenario Pattern)
åŒ…å«å®Œæ•´äº¤äº’é—­åŒ…çš„å¾®åº”ç”¨ã€‚å®ƒé€šå¸¸ä¼šåˆ›å»ºå±€éƒ¨çŠ¶æ€å’Œä¿¡å·ã€‚
*   **ç¤ºä¾‹**: `ModalFormWorkflow` (åŒ…å« Open/Close ä¿¡å·, Loading çŠ¶æ€, è¡¨å•æäº¤é€»è¾‘)ã€‚
*   **ç”»å¸ƒè¡¨ç°**: å¤§å‹å®¹å™¨èŠ‚ç‚¹ï¼Œæš´éœ² Signal ç«¯å£ã€‚

## 3. Pattern ä¸ ModuleImpl çš„ååŒå…³ç³»

éšç€ React ä¾§ `ModuleImpl` æ–¹æ¡ˆçš„å¼•å…¥ï¼ŒPattern åœ¨ä¸šåŠ¡è½åœ°ä¸­çš„è§’è‰²å¾—åˆ°äº†è¿›ä¸€æ­¥æ˜ç¡®ã€‚Pattern æ˜¯â€œæ¨¡å…·â€ï¼Œ`ModuleImpl` æ˜¯â€œæˆå“â€ã€‚

### 3.1 æ¶ˆè´¹æ˜ å°„

åœ¨ `ModuleImpl` ä½“ç³»ä¸‹ï¼ŒPattern çš„äº§å‡ºç‰©æœ‰äº†æ˜ç¡®çš„å½’å®¿ï¼š

- **åŸå­ Pattern** (Retry, Debounce)ï¼šä½œä¸º **Logic Helper**ï¼Œåœ¨ `Module.logic` å†…éƒ¨è¢«è°ƒç”¨ã€‚
- **é€»è¾‘ Pattern** (CRUD, Pagination)ï¼šä½œä¸º **Logic Factory**ï¼Œåœ¨ `ModuleImpl` çš„ `logics` æ•°ç»„ä¸­è¢«é…ç½®å’Œå®ä¾‹åŒ–ã€‚
  ```ts
  // ç¤ºä¾‹ï¼šåœ¨ ModuleImpl ä¸­æ¶ˆè´¹ Pattern
  export const UserListImpl = UserModule.make({
    initial: { ... },
    logics: [
      // PaginationPattern.make è¿”å›ä¸€ä¸ª ModuleLogic
      PaginationPattern.make({ fetch: UserApi.list })
    ]
  })
  ```
- **åœºæ™¯ Pattern** (å®Œæ•´å·¥ä½œæµ)ï¼šä½œä¸º **Module Factory**ï¼Œç›´æ¥è¿”å›é…ç½®å¥½çš„ `ModuleImpl`ï¼Œæˆ–è€…ç”ŸæˆåŒ…å«å®Œæ•´ Shape çš„ `Module`ã€‚
  åœºæ™¯ Pattern ä¹Ÿå¯ä»¥åœ¨ `ModuleImpl` åŸºç¡€ä¸Šè¿›ä¸€æ­¥å°è£… Envï¼Œä¾‹å¦‚é€šè¿‡ `ModuleImpl.withLayer` é¢„ç»‘å®š Serviceï¼š
  ```ts
  // åœºæ™¯ Patternï¼šè¿”å›ä¸€ä¸ªå·²ç»ç»‘å®š Service çš„ Impl
  export const makeRegionImplWithService = () => {
    const RegionImpl = RegionModule.make<RegionService>({
      initial,
      logics: [RegionLogicFromPattern],
    })

    return RegionImpl.withLayer(RegionServiceLive)
  }
  ```

è¿™ç§åˆ†å±‚ä½¿å¾— Pattern åº“ä¸“æ³¨äºâ€œé€šç”¨é€»è¾‘çš„å¯å¤ç”¨æ€§â€ï¼Œè€Œ `ModuleImpl` ä¸“æ³¨äºâ€œå…·ä½“é¡µé¢çš„ç»„è£…ä¸è½åœ°â€ã€‚

## 4. Pattern ä¸å¹³å°çš„å…³ç³»ï¼ˆv3 èŒƒå›´å†…ï¼‰

åœ¨ v3 é˜¶æ®µï¼Œæ¨èçš„å·¥ç¨‹å®è·µæ˜¯ï¼š

- åœ¨è¿è¡Œæ—¶ä»£ç ä¸­ï¼Œå°†å¸¸è§é•¿é€»è¾‘å°è£…ä¸º Pattern Functionï¼š
  - ä¾‹å¦‚å®¡æ‰¹æµã€Job æ‰§è¡Œã€è¡¨å•æäº¤ã€é•¿ä»»åŠ¡è½®è¯¢ç­‰ï¼›
  - é€šè¿‡æ¸…æ™°çš„è¾“å…¥å‚æ•°ä¸ Effect è¡Œä¸ºï¼Œä¿æŒé€»è¾‘å¯æµ‹è¯•ã€å¯ç»„åˆã€‚
- åœ¨å¹³å°å±‚ï¼Œå°†è¿™äº› Pattern Function ä¸å…ƒæ•°æ®ï¼ˆid/configSchema/tagsï¼‰å…³è”ï¼š
  - ç”¨äºåœ¨ Galaxy è§†å›¾ä¸­ä»¥â€œé»‘ç›’ç§¯æœ¨â€çš„å½¢å¼å‘ˆç°ï¼›
  - ç”¨äºåœ¨ Pattern Studio ä¸­æä¾›é…ç½®è¡¨å•ä¸æ¨¡æ‹Ÿè¿è¡Œã€‚
- æ›´å¤æ‚çš„ AI ååŒï¼ˆä¾‹å¦‚æ™ºèƒ½å¡«æ§½ã€è‡ªåŠ¨æç‚¼ Patternã€å¯Œäº¤äº’ Playgroundï¼‰å¯ä»¥åœ¨åç»­ç‰ˆæœ¬ä¸­æŒ‰éœ€å¼•å…¥ï¼Œä¸ä½œä¸º v3 çš„å‰ç½®ä¾èµ–ã€‚

æœ¬è®¾è®¡æ–‡ä»¶åç»­å¦‚éœ€æ‰©å±•ï¼ˆä¾‹å¦‚é‡æ–°å¼•å…¥æ›´å¼ºçš„ Builder DSLã€AI Slot ç­‰ï¼‰ï¼Œåº”åœ¨ v3/v4 çš„ Roadmap ä¸ runtime-logix / platform è§„èŒƒæ›´æ–°åï¼Œå†è¡¥å……æ–°çš„ç« èŠ‚ï¼›å½“å‰ç‰ˆæœ¬ä»¥ pattern-style `(input) => Effect` + èµ„äº§ metadata ä¸ºå”¯ä¸€äº‹å®æºã€‚***

## 5. å·¥ç¨‹çº¦å®šï¼šç›®å½•ã€å‘½åä¸å¤ç”¨éªŒè¯

ä»â€œçœŸå®ä¸šåŠ¡å¼€å‘â€çš„è§†è§’å‡ºå‘ï¼Œä¸ºäº†è®© Pattern åœ¨ä»“åº“å†…å¯æŸ¥ã€å¯æµ‹ã€å¯å¤ç”¨ï¼Œv3 é˜¶æ®µè¡¥å……ä»¥ä¸‹å·¥ç¨‹çº¦å®šã€‚å½“å‰ PoC çš„å‚è€ƒè½ç‚¹ä¸ºï¼š

- ä»£ç ä½ç½®ï¼š
  - `docs/specs/intent-driven-ai-coding/v3/effect-poc/patterns/*.ts`ï¼šPattern Function çš„ç¤ºä¾‹å®ç°ï¼ˆLevel 2 èµ„äº§ï¼‰ï¼›
  - `docs/specs/intent-driven-ai-coding/v3/effect-poc/scenarios/*.ts`ï¼šåœºæ™¯ PoCï¼Œä½œä¸º Pattern çš„æ¶ˆè´¹æ–¹ï¼ˆLevel 3 ä»£ç ï¼‰ã€‚

- å‘½åçº¦å®šï¼ˆæºç çº§ï¼‰ï¼š
  - çº¯ Effect Patternï¼ˆä¸ç›´æ¥ä¾èµ– Logix.Envï¼‰ï¼š
    - å‡½æ•°ï¼š`runXxxPattern(input: XxxPatternInput): Effect.Effect<A, E, R>`ï¼›
    - è¾“å…¥ç±»å‹ï¼š`XxxPatternInput`ï¼›
    - é”™è¯¯ç±»å‹ï¼ˆå¦‚æœ‰ï¼‰ï¼š`XxxPatternError`ã€‚
  - Logic Patternï¼ˆä¾èµ– `Logic.Env<Sh,R>` / Store / Flow / Controlï¼‰ï¼š
    - å·¥å‚å‡½æ•°ï¼š`makeXxxLogicPattern(config?: C) => Logic.Of<Sh, R, A, E>`ï¼›
    - å¯é€‰å¯¼å‡ºä¸€ä¸ªè¯­æ³•ç³–ï¼š`XxxLogicFromPattern = makeXxxLogicPattern()`ï¼Œæ–¹ä¾¿ç›´æ¥æŒ‚åˆ° Store ä¸Šã€‚

- Tag-only Service vs è‡ªå¸¦å®ç°ï¼š
  - å¯¹çœŸå®ä¸šåŠ¡æ›´æœ‰å¤ç”¨ä»·å€¼çš„æ¨¡å¼ï¼Œæ¨è **åªåœ¨ Pattern ä¸­å®šä¹‰ Service å¥‘çº¦ï¼ˆTag + interfaceï¼‰ï¼Œä¸æä¾›é»˜è®¤å®ç°**ï¼š
    - Module é¢†åŸŸæœåŠ¡ï¼ˆApprovalServiceã€ArchiveService ç­‰ï¼‰å»ºè®®å½’ç±»åœ¨ Module å±‚ï¼ˆå¦‚ `module/order/service.ts`ï¼‰ï¼ŒTag ä»£è¡¨ä¸šåŠ¡è¯­è¨€ä¸­çš„â€œåŠ¨è¯â€ï¼›
    - é€šç”¨èƒ½åŠ›ï¼ˆNotification/Confirm ç­‰ï¼‰å¯ä»¥æ”¾åœ¨ `patterns/shared` æˆ– `patterns/<pattern-name>/service.ts`ï¼Œä½œä¸º Pattern çš„â€œæ’æ§½â€ï¼›
    - Pattern å†…éƒ¨åª `yield* SomeServiceTag`ï¼Œä¸ `provide` å®ç°ã€‚
  - å…·ä½“å®ç°ç”±æ¶ˆè´¹æ–¹åœ¨â€œè¿è¡Œç»„åˆå±‚â€æä¾›ï¼š
    - PoC åœºæ™¯ä¸­ï¼Œå¯ä»¥åœ¨å•æ–‡ä»¶å†…ä½¿ç”¨ `Effect.provideService(Tag, impl)` é—­ç¯æ¼”ç¤ºï¼›
    - çœŸæ­£åº”ç”¨ä¸­ï¼Œæ¨èé›†ä¸­åœ¨ RuntimeLayer / App Root ä¸­é€šè¿‡ `Layer.succeed` / `Layer.mergeAll` æ³¨å…¥çœŸå®å®ç°æˆ–æµ‹è¯•æ›¿èº«ã€‚

- åœºæ™¯æ–‡ä»¶ï¼ˆscenariosï¼‰è¦æ±‚ï¼š
  - æ¯ä¸ªåœºæ™¯æ–‡ä»¶åº”å½“æ˜¯**å•æ–‡ä»¶å®Œå¤‡**ï¼š
    - æ˜ç¡® import ä½¿ç”¨çš„ Pattern / Service Tagï¼›
    - åœ¨æ–‡ä»¶å†…æˆ–é€šè¿‡æ³¨é‡Šå±•ç¤ºâ€œå¦‚ä½•æä¾›ä¾èµ–å¹¶è¿è¡Œâ€ï¼š
      - å¯¹çº¯ Effect Patternï¼Œè‡³å°‘ç»™å‡ºä¸€ä¸ª `const program = ...` å¹¶åœ¨æ–‡ä»¶åº•éƒ¨ç”¨ `Effect.runPromise(program)` æˆ–ç­‰ä»·å…¥å£ï¼›
      - å¯¹ä¾èµ– Service Tag çš„ Patternï¼Œæ¼”ç¤ºå¦‚ä½•åœ¨åœºæ™¯å†… `provideService`ï¼ˆæˆ–è¯´æ˜ç”±ä¸Šå±‚ Runtime æä¾›ï¼‰ï¼›
    - è®©è¯»è€…åœ¨ä¸é¢å¤–æŸ¥æ‰¾å…¶å®ƒæ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œç†è§£â€œä» Action / è¾“å…¥åˆ° Effect æ‰§è¡Œâ€çš„å®Œæ•´é“¾è·¯ã€‚

- å¤ç”¨éªŒè¯çº¦æŸï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰ï¼š
  - ä¸ºäº†é˜²æ­¢ Pattern è®¾è®¡æˆâ€œåªé€‚é…å•ä¸€ demoâ€ï¼Œæ¯ä¸ªè¿›å…¥ `patterns/` çš„ Patternï¼Œç†æƒ³çŠ¶æ€åº”è‡³å°‘è¢« **ä¸¤ä¸ªåŠä»¥ä¸Š** åœºæ™¯ä½¿ç”¨ï¼š
    - ä¾‹å¦‚ï¼š
      - `patterns/optimistic-toggle.ts` åŒæ—¶è¢« `scenarios/optimistic-toggle.ts` ä¸ `scenarios/optimistic-toggle-from-pattern.ts` æ¶ˆè´¹ï¼›
      - `patterns/long-task.ts` åŒæ—¶è¢« `scenarios/long-task-pattern.ts` ä¸ `scenarios/long-task-from-pattern.ts` æ¶ˆè´¹ï¼›
      - `patterns/notification.ts` åŒæ—¶è¢« `scenarios/notify-simple-run.ts` ä¸ `scenarios/notify-with-bulk-and-import.ts` æ¶ˆè´¹ã€‚
  - å¹³å°åŒ–é˜¶æ®µï¼Œå¯ä»¥å°†è¿™ç§â€œä¸€ä¸ª Pattern è¢«å¤šä¸ªåœºæ™¯å¼•ç”¨â€çš„å…³ç³»ç›´æ¥æ˜ å°„ä¸º Pattern èµ„äº§çš„å¥åº·åº¦æŒ‡æ ‡ï¼Œé¿å…åªæœåŠ¡æŸä¸ªå­¤ç«‹æ¡ˆä¾‹çš„â€œä¼ªå¤ç”¨â€ã€‚

è¿™äº›çº¦å®šä¸å¼ºåˆ¶æŸç¼šæœªæ¥çš„ Builder / Codegen å½¢æ€ï¼Œä½†ä¸ºå½“å‰ v3 PoC æä¾›äº†ä¸€å¥—æ¸…æ™°ã€ä¸€è‡´çš„â€œPattern å·¥ç¨‹å®è·µâ€ï¼Œå…¼é¡¾ä¸šåŠ¡å¼€å‘è§†è§’ï¼ˆèƒ½åœ¨çœŸå®éœ€æ±‚é‡Œç›´æ¥ç”¨ï¼‰ä¸å¹³å°è§†è§’ï¼ˆèµ„äº§å¯è§£æã€å¯ç®¡ç†ï¼‰ã€‚***
</file>

<file path="intent-driven-ai-coding/v3/design/playground-and-debug.md">
# Playground & Debugging åŠŸèƒ½è®¾è®¡

> **Status**: Draft (v3 Final Â· Design)
> **Scope**: å¹³å°ä¾§é¢å‘ç”¨æˆ·çš„â€œè¿è¡Œä¸è°ƒè¯•â€åŠŸèƒ½å®šä¹‰ã€‚

## 1. ä»·å€¼ä¸»å¼  (Value Proposition)

æˆ‘ä»¬ä¸ä»…ä»…æ˜¯åœ¨åšä¸€ä¸ªâ€œåœ¨çº¿ IDEâ€ï¼Œè€Œæ˜¯åœ¨æ„å»ºä¸€å¥— **Intent-Driven çš„è´¨é‡ä¿éšœä½“ç³»**ã€‚

### 1.1 è´¨é‡å·¦ç§» (Shift Left Quality)
*   **Before**: ä¸šåŠ¡é€»è¾‘å¿…é¡»ç­‰åˆ°åç«¯ API å¼€å‘å®Œæ¯•ã€éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒã€ç”šè‡³è”è°ƒæ—¶æ‰èƒ½éªŒè¯ã€‚
*   **After**: åœ¨ **å†™ä¸‹ç¬¬ä¸€è¡Œä»£ç çš„ç¬é—´**ï¼Œå³å¯åœ¨ Playground ä¸­é€šè¿‡ Mock éªŒè¯æ ¸å¿ƒé€»è¾‘ï¼ˆå¦‚æ”¯ä»˜é‡è¯•ã€å¹¶å‘ç«æ€ï¼‰ã€‚
*   **Slogan**: **"Verify Logic before Deploying Infrastructure."**

### 1.2 æ´»ä½“æ–‡æ¡£ (Living Documentation)
*   **Before**: Wiki é‡Œçš„â€œä¸šåŠ¡æµç¨‹å›¾â€å’Œâ€œé‡è¯•ç­–ç•¥è¯´æ˜â€æ°¸è¿œæ˜¯è¿‡æœŸçš„ï¼Œä¸ä»£ç è„±èŠ‚ã€‚
*   **After**: Playground é‡Œä¿å­˜çš„ Mock Case å°±æ˜¯ **å¯æ‰§è¡Œçš„ä¸šåŠ¡è§„çº¦**ã€‚
    *   â€œæ”¯ä»˜å¤±è´¥é‡è¯• 3 æ¬¡â€ä¸å†æ˜¯æ–‡æ¡£é‡Œçš„ä¸€å¥è¯ï¼Œè€Œæ˜¯ä¸€ä¸ª **ç‚¹å‡»å³è·‘çš„å¯äº¤äº’ç”¨ä¾‹**ã€‚
*   **Slogan**: **"Executable Specs over Stale Wikis."**

### 1.3 æ¶æ„æ²»ç† (Architecture Governance)
*   **Before**: ä»£ç è€¦åˆä¸¥é‡ï¼Œä¸šåŠ¡é€»è¾‘æ··æ‚äº†æ•°æ®åº“è¿æ¥å’Œ HTTP è¯·æ±‚ï¼Œéš¾ä»¥æ‹†åˆ†ã€‚
*   **After**: Playground æ˜¯æ¶æ„å¥åº·çš„ **å¼ºåˆ¶ä½“æ£€ä¸­å¿ƒ**ã€‚å¦‚æœä½ çš„ Module é€»è¾‘èƒ½åœ¨æµè§ˆå™¨é‡Œè·‘é€šï¼ˆè„±ç¦» Node/DBï¼‰ï¼Œè¯´æ˜å®ƒçœŸæ­£åšåˆ°äº† **ä¾èµ–å€’ç½® (Dependency Inversion)**ã€‚
*   **Slogan**: **"Browser-Compatible means Architecture-Clean."**

---

åŸºäºå‰ç«¯è¿è¡Œæ—¶ (WebWorker + esbuild) çš„åº•å±‚èƒ½åŠ›ï¼Œå¹³å°æä¾›ä»¥ä¸‹æ ¸å¿ƒäº¤äº’åŠŸèƒ½ï¼Œé—­ç¯ä¸Šè¿°ä»·å€¼é“¾è·¯ã€‚

## 2. Mock ä»ªè¡¨ç›˜ (Mock Dashboard)

ç”¨æˆ·æ— éœ€ä¿®æ”¹ä»£ç å³å¯åŠ¨æ€è°ƒæ•´ç¯å¢ƒè¡Œä¸ºï¼ŒéªŒè¯ä¸šåŠ¡é€»è¾‘çš„å¥å£®æ€§ã€‚

### 1.1 æœåŠ¡åˆ—è¡¨ä¸çŠ¶æ€
*   **è‡ªåŠ¨å‘ç°**ï¼šå¹³å°åˆ†æ `ModuleDef.providers` å’Œ `Layer` ç»“æ„ï¼Œåˆ—å‡ºæ‰€æœ‰å¯ Mock çš„ Tagï¼ˆå¦‚ `PaymentService`, `UserRepo`ï¼‰ã€‚
*   **æ§åˆ¶é¢æ¿**ï¼šä¸ºæ¯ä¸ª Mock Service ç”Ÿæˆæ§åˆ¶ UIï¼ˆåŸºäº Schemaï¼‰ï¼š
    *   **å¼€å…³**ï¼š`simulateFailure` (æ¨¡æ‹Ÿå¤±è´¥)ã€‚
    *   **æ»‘å—**ï¼š`latency` (æ¨¡æ‹Ÿå»¶è¿Ÿ 0-5000ms)ã€‚
    *   **JSON ç¼–è¾‘å™¨**ï¼š`mockData` (è‡ªå®šä¹‰è¿”å›æ•°æ®)ã€‚

### 1.2 å®æ—¶åé¦ˆ
*   **äº¤äº’**ï¼šç”¨æˆ·æ‹–åŠ¨å»¶è¿Ÿæ»‘å—æˆ–åˆ‡æ¢å¤±è´¥å¼€å…³ã€‚
*   **å“åº”**ï¼šå¹³å°è‡ªåŠ¨å‘ Worker å‘é€ `updateEnv` æ¶ˆæ¯ï¼ŒWorker ç«‹å³ä½¿ç”¨æ–°ç¯å¢ƒé‡è·‘å½“å‰ Effectï¼Œç»“æœå®æ—¶åˆ·æ–°ã€‚

## 2. æ—¶å…‰å›æº¯ä¸è¿½è¸ª (Time Travel & Trace)

åˆ©ç”¨ Effect-TS å¼ºå¤§çš„ Tracing èƒ½åŠ›ï¼Œå¯è§†åŒ–é€»è¾‘æ‰§è¡Œæµã€‚

### 2.1 ç€‘å¸ƒå›¾ (Waterfall View)
*   **å±•ç¤º**ï¼šä»¥æ—¶é—´è½´å±•ç¤ºæ‰€æœ‰ Effect Span çš„æ‰§è¡Œé¡ºåºã€è€—æ—¶ã€çˆ¶å­å…³ç³»ã€‚
*   **é«˜äº®**ï¼š
    *   **çº¢è‰²**ï¼šæ‰§è¡Œå¤±è´¥çš„ Spanï¼ˆæ˜¾ç¤º Error è¯¦æƒ…ï¼‰ã€‚
    *   **é»„è‰²**ï¼šè€—æ—¶è¿‡é•¿çš„ Spanï¼ˆæ€§èƒ½ç“¶é¢ˆï¼‰ã€‚
    *   **è™šçº¿**ï¼šè¢« Mock çš„å¤–éƒ¨è°ƒç”¨ã€‚

### 2.2 çŠ¶æ€å¿«ç…§ (State Inspector)
*   **ç‚¹å‡»**ï¼šç‚¹å‡»ç€‘å¸ƒå›¾ä¸­çš„ä»»æ„ Spanã€‚
*   **è¯¦æƒ…**ï¼šå±•ç¤ºè¯¥æ—¶åˆ»çš„ Context çŠ¶æ€ã€è¾“å…¥å‚æ•°ã€è¾“å‡ºç»“æœã€‚
*   **Diff**ï¼šå¯¹äº Store æ›´æ–°æ“ä½œï¼Œå±•ç¤º State çš„ Before/After å·®å¼‚ã€‚

## 3. çƒ­é‡è½½ä¸å®ˆæŠ¤ (Hot Feedback & Guard)

æä¾›æè‡´æµç•…çš„â€œä¿®æ”¹-éªŒè¯â€å¾ªç¯ï¼ŒåŒæ—¶ä¿è¯æµè§ˆå™¨å®‰å…¨ã€‚

### 3.1 æé€Ÿçƒ­æ›´
*   **æœºåˆ¶**ï¼šæ–‡ä»¶ä¿å­˜ -> å¢é‡ç¼–è¯‘ (esbuild) -> Worker é‡è½½ -> è‡ªåŠ¨é‡è·‘ã€‚
*   **ç›®æ ‡**ï¼šä» Ctrl+S åˆ°çœ‹åˆ°æ–°ç»“æœï¼Œå»¶è¿Ÿ < 200msã€‚

### 3.2 æ­»å¾ªç¯ç†”æ–­ (Loop Breaker)
*   **æ£€æµ‹**ï¼šè‹¥ Worker è¶…è¿‡ 5ç§’ æœªå“åº”å¿ƒè·³æˆ–æœªè¿”å›ç»“æœã€‚
*   **äº¤äº’**ï¼š
    *   UI å˜çº¢ï¼Œæç¤º "Execution Timeout"ã€‚
    *   æä¾›æ˜¾çœ¼çš„ **"Kill & Restart"** æŒ‰é’®ã€‚
    *   (é«˜çº§) å°è¯•åˆ†æå †æ ˆï¼Œæç¤ºå¯èƒ½çš„æ­»å¾ªç¯ä½ç½®ã€‚

## 4. åœºæ™¯ç”¨ä¾‹ (User Stories)

### Story A: éªŒè¯æ”¯ä»˜é‡è¯•
1.  ç”¨æˆ·æ‰“å¼€ `CheckoutFlow` çš„ Playgroundã€‚
2.  åœ¨ Mock ä»ªè¡¨ç›˜ä¸­ï¼Œå°† `PaymentService` è®¾ä¸º "Fail 2 times, then Success"ã€‚
3.  ç‚¹å‡»è¿è¡Œã€‚
4.  åœ¨ç€‘å¸ƒå›¾ä¸­ç¡®è®¤ï¼šçœ‹åˆ°äº† 2 ä¸ªçº¢è‰²çš„å¤±è´¥ Spanï¼Œç´§æ¥ç€ 1 ä¸ªç»¿è‰²çš„æˆåŠŸ Spanï¼Œä¸”æ€»è€—æ—¶ç¬¦åˆé‡è¯•ç­–ç•¥ã€‚

### Story B: è°ƒè¯•æ­»é”
1.  ç”¨æˆ·å†™äº†ä¸€ä¸ªå¤æ‚çš„å¹¶å‘é€»è¾‘ï¼ŒPlayground å¡ä½ã€‚
2.  UI æç¤ºè¶…æ—¶ï¼Œç”¨æˆ·ç‚¹å‡» Killã€‚
3.  ç”¨æˆ·æ‰“å¼€ Trace è§†å›¾ï¼ˆæŸ¥çœ‹ä¸Šä¸€æ¬¡éƒ¨åˆ†æˆåŠŸçš„æ—¥å¿—ï¼‰ï¼Œå‘ç° A ç­‰ Bï¼ŒB ç­‰ Aã€‚
4.  ä¿®æ”¹ä»£ç ï¼Œä¿å­˜ï¼Œç¬é—´é€šè¿‡ã€‚

## 5. AI å¢å¼º (LLM Integration)

Playground ä¸ä»…æ˜¯äººå·¥è°ƒè¯•å™¨ï¼Œæ›´æ˜¯ AI è¾…åŠ©æ¼”ç»ƒåœºã€‚

### 5.1 æ™ºèƒ½ç”¨ä¾‹ç”Ÿæˆ (AI Case Generator)
*   **ç—›ç‚¹**ï¼šæ‰‹åŠ¨æ„é€ è¾¹ç•Œæ¡ä»¶çš„ Mock æ•°æ®å¾ˆç´¯ã€‚
*   **åŠŸèƒ½**ï¼šç‚¹å‡» "Generate Edge Cases"ï¼ŒLLM è¯»å– Module ä»£ç ä¸ Schemaã€‚
*   **äº§å‡º**ï¼šè‡ªåŠ¨ç”Ÿæˆä¸€ç»„é«˜ä»·å€¼çš„ Mock åœºæ™¯ï¼ˆå¦‚â€œæ”¯ä»˜å¤±è´¥â€ã€â€œé«˜å¹¶å‘å†²çªâ€ã€â€œç½‘ç»œæŠ–åŠ¨â€ï¼‰ï¼Œç”¨æˆ·ä¸€é”®è¿è¡Œã€‚

### 5.2 æ™ºèƒ½è¯Šæ–­ (AI Trace Analysis)
*   **ç—›ç‚¹**ï¼šTrace ç€‘å¸ƒå›¾å¤ªå¤æ‚ï¼Œçœ‹ä¸æ‡‚æ ¹å› ã€‚
*   **åŠŸèƒ½**ï¼šç‚¹å‡» "Analyze Failure"ï¼ŒLLM åˆ†æ Trace æ•°æ®ä¸ Error å †æ ˆã€‚
*   **äº§å‡º**ï¼šè‡ªç„¶è¯­è¨€ç»“è®ºï¼ˆå¦‚â€œé”™è¯¯æ ¹å› æ˜¯ PaymentService è¿ç»­ 3 æ¬¡ 503ï¼Œå¯¼è‡´é‡è¯•è€—å°½â€ï¼‰ï¼Œå¹¶é«˜äº®å…³é”® Spanã€‚

### 5.3 è‡ªåŠ¨ä¿®å¤é—­ç¯ (Auto-Fix Loop)
*   **ç—›ç‚¹**ï¼šå‘ç° Bug åè¿˜è¦è‡ªå·±æ”¹ä»£ç ã€‚
*   **åŠŸèƒ½**ï¼šPlayground æ•è·è¿è¡Œæ—¶å¼‚å¸¸ -> LLM åˆ†ææºç ä¸å¼‚å¸¸ -> ç”Ÿæˆ Patchã€‚
*   **äº§å‡º**ï¼šè‡ªåŠ¨åº”ç”¨ä¿®å¤ä»£ç  -> è‡ªåŠ¨è§¦å‘çƒ­é‡è½½ -> éªŒè¯é€šè¿‡ã€‚ç”¨æˆ·åªéœ€å®¡æ ¸æœ€ç»ˆç»“æœã€‚

## 6. äº§å“äº¤äº’è®¾è®¡ (Product UX Design)

æœ¬æ¨¡å—æ­£å¼å‘½åä¸º **Logic Playground**ã€‚

### 6.1 ç•Œé¢å¸ƒå±€ (UI Layout)
é‡‡ç”¨ç»å…¸çš„ **ä¸‰æ å¼å¸ƒå±€ (Three-Column Layout)**ï¼Œå…¼é¡¾é…ç½®ã€æ‰§è¡Œä¸åˆ†æã€‚

*   **å·¦æ ï¼šå¯¼èˆªä¸é…ç½® (Navigation & Config)**
    *   **Case List**ï¼šä¿å­˜çš„ç”¨ä¾‹åˆ—è¡¨ï¼ˆå¦‚ "Happy Path", "Payment Fail"ï¼‰ã€‚æ”¯æŒæ–‡ä»¶å¤¹ç®¡ç†ã€‚
    *   **Mock Dashboard**ï¼šMock æœåŠ¡çš„æ§åˆ¶é¢æ¿ï¼ˆå¼€å…³ã€å»¶è¿Ÿæ»‘å—ã€JSON ç¼–è¾‘å™¨ï¼‰ã€‚
*   **ä¸­æ ï¼šä»£ç ä¸ç”»å¸ƒ (Code & Canvas)**
    *   **Tab é¡µ**ï¼šæ”¯æŒåˆ‡æ¢ "Code View" (æºç ç¼–è¾‘å™¨) å’Œ "Flow View" (åªè¯»æµç¨‹å›¾)ã€‚
    *   **Run Bar**ï¼šé¡¶éƒ¨æ‚¬æµ®æ¡ï¼ŒåŒ…å« "Run" (â–¶), "Debug", "Generate AI Case" (âœ¨) æŒ‰é’®ã€‚
*   **å³æ ï¼šæ‰§è¡Œç»“æœ (Execution Result)**
    *   **Console**ï¼šå®æ—¶æ—¥å¿—è¾“å‡ºï¼Œæ”¯æŒæŒ‰ Level è¿‡æ»¤ã€‚
    *   **Trace Waterfall**ï¼šæ‰§è¡Œç€‘å¸ƒå›¾ï¼Œæ”¯æŒç¼©æ”¾å’Œç‚¹å‡»æŸ¥çœ‹ Span è¯¦æƒ…ã€‚
    *   **State Inspector**ï¼šå½“å‰ Store çŠ¶æ€å¿«ç…§ä¸ Diffã€‚

### 6.2 ä½¿ç”¨è§’è‰² (User Roles)

| è§’è‰² | æ ¸å¿ƒåœºæ™¯ | ä»·å€¼ç‚¹ |
| :--- | :--- | :--- |
| **åç«¯å¼€å‘** | å®šä¹‰ API å¥‘çº¦ï¼Œç¼–å†™ Mock æ•°æ® | ç¡®ä¿å‰ç«¯/é€»è¾‘å±‚åœ¨æ— çœŸå® API æ—¶ä¹Ÿèƒ½å¹¶è¡Œå¼€å‘ |
| **å…¨æ ˆå¼€å‘** | ç¼–å†™ Module é€»è¾‘ï¼Œè°ƒè¯•ç¼–æ’æµç¨‹ | æé€Ÿåé¦ˆ (<200ms)ï¼Œæ— éœ€ç­‰å¾… Webpack çƒ­æ›´æˆ–éƒ¨ç½² |
| **QA / æµ‹è¯•** | æ„é€ è¾¹ç•Œç”¨ä¾‹ (Edge Cases)ï¼ŒéªŒè¯å¥å£®æ€§ | æ— éœ€æ­å»ºå¤æ‚ç¯å¢ƒï¼Œç›´æ¥åœ¨æµè§ˆå™¨é‡ŒæŠŠé€»è¾‘æµ‹é€ |
| **äº§å“ç»ç†** | éªŒæ”¶ä¸šåŠ¡æµç¨‹ (Acceptance Testing) | ç‚¹å‡» "Happy Path" ç”¨ä¾‹ï¼Œç›´è§‚ç¡®è®¤ä¸šåŠ¡é€»è¾‘ç¬¦åˆé¢„æœŸ |

### 6.3 æ ¸å¿ƒäº¤äº’æµç¨‹ (Core Flows)

#### Flow A: å¼€å‘è°ƒè¯•é—­ç¯ (The Dev Loop)
1.  **Coding**: Dev åœ¨ VSCode / ä¸­æ ç¼–è¾‘å™¨å†™ä»£ç ã€‚
2.  **Hot Reload**: ä¿å­˜å³è¿è¡Œï¼Œå³æ  Console å®æ—¶è¾“å‡ºã€‚
3.  **Debug**: å‘ç°æŠ¥é”™ -> ç‚¹å‡» Trace çº¢è‰²èŠ‚ç‚¹ -> å®šä½é—®é¢˜ã€‚
4.  **Fix**: ç‚¹å‡» "AI Fix" -> ç¡®è®¤ Patch -> é—®é¢˜è§£å†³ã€‚

#### Flow B: å¥‘çº¦éªŒæ”¶é—­ç¯ (The Contract Loop)
1.  **Mocking**: åç«¯å®šä¹‰å¥½ `UserRepo` çš„ Mock æ•°æ®ä¸ Schemaã€‚
2.  **Verifying**: å‰ç«¯åœ¨ Playground é‡Œè·‘é€šä¸šåŠ¡æµç¨‹ï¼Œç¡®è®¤ UI/é€»è¾‘ é€‚é…è¯¥ Mockã€‚
3.  **Sign-off**: åŒæ–¹ç¡®è®¤ï¼šåªè¦åç«¯çœŸå® API ç¬¦åˆè¿™ä¸ª Mockï¼Œä¸Šçº¿å°±æ²¡é—®é¢˜ã€‚
</file>

<file path="intent-driven-ai-coding/v3/design/view-and-component.md">
---
title: è§†å›¾/ç»„ä»¶æ„å›¾ï¼ˆView & Component Intentï¼‰
status: draft
version: 2
---

> æœ¬æ–‡æ‰©å±•â€œè§†å›¾/ç»„ä»¶æ„å›¾â€çš„å«ä¹‰ä¸ Schema è‰å›¾ï¼Œå¹¶è¯´æ˜ä¸ Patternã€UI è®¾è®¡ç³»ç»Ÿçš„å…³ç³»ã€‚

## 1. å®šä¹‰

è§†å›¾/ç»„ä»¶æ„å›¾å›ç­”ï¼š

1. æ¯ä¸ªå¸ƒå±€åŒºåŸŸé‡Œç”¨ä»€ä¹ˆ UI æ¨¡å¼/ç»„ä»¶ï¼Ÿ
2. å®ƒä»¬æœ‰å“ªäº›å˜ä½“ï¼ˆå¯†åº¦ã€é£æ ¼ã€æ˜¯å¦å¸¦æ“ä½œåˆ—ç­‰ï¼‰ï¼Ÿ
3. è¿™äº›ç»„ä»¶éœ€è¦å“ªäº›â€œä¸šåŠ¡çº§â€é…ç½®ï¼ˆä¾‹å¦‚åˆ—é…ç½®ã€ç­›é€‰å­—æ®µã€æ˜¯å¦æ”¯æŒå¯¼å‡ºï¼‰ã€‚

å®ƒä¸è´Ÿè´£ï¼š

- å…·ä½“å¸ƒå±€ä½ç½®ï¼ˆäº¤ç»™ LayoutIntentï¼‰ï¼›
- è¡Œä¸ºæµç¨‹ï¼ˆè°ƒç”¨å“ªä¸ª serviceã€ä¸šåŠ¡æ­¥éª¤é“¾ï¼‰ï¼›
- çŠ¶æ€æ¥æºï¼ˆreact-query è¿˜æ˜¯ zustandï¼‰â€”â€”è¿™äº›å±äº Data/State ä¸ Behavior å±‚ã€‚

## 2. ViewIntent Schema è‰å›¾

```ts
interface ViewComponentIntent {
  slot: string // å¯¹åº” LayoutIntent.regions[].id
  patternId: string // e.g. table-with-server-filter, filter-bar
  variant?: string // e.g. dense / card / compact
  propsIntent?: Record<string, unknown> // è§†å›¾å±‚çš„å‚æ•°åŒ–æ„å›¾ï¼ˆåˆ—é…ç½®ã€æŒ‰é’®é›†åˆç­‰ï¼‰
}

interface ViewIntent {
  components: ViewComponentIntent[]
}
```

åœ¨ IntentSpec v2 ä¸­ï¼š

```ts
interface IntentSpecV2 {
  layout: LayoutIntent
  view?: ViewIntent
  // ... interaction/behavior/data/codeStructure/constraints
}
```

## 3. Pattern åœ¨è§†å›¾å±‚çš„è§’è‰²

UI/Pro Patternï¼ˆå¦‚ `table-with-server-filter`ã€`filter-bar`ã€`toolbar-with-quick-edit`ï¼‰æœ¬è´¨ä¸Šæ˜¯â€œè§†å›¾æ„å›¾ + éƒ¨åˆ†è¡Œä¸º/æ•°æ®æ„å›¾â€çš„æ¨¡æ¿ï¼š

- åœ¨ PatternSpec v2 ä¸­ï¼Œå®ƒä»¬åº”å£°æ˜ï¼š

```yaml
intentLayers:
  - view
  - behavior
  - data
```

- å¹¶é€šè¿‡ä»¥ä¸‹å­—æ®µæä¾›è§†å›¾å±‚é…ç½®ï¼š
  - `composition.roles`ï¼šè§†å›¾ç»„ä»¶å’Œå­ç»„ä»¶çš„è§’è‰²ï¼ˆTableComponent/ToolbarComponent/...ï¼‰ï¼›
  - `paramsSchema`ï¼šè§†å›¾å±‚å‚æ•°ï¼ˆåˆ—é…ç½®ã€æ˜¯å¦æ˜¾ç¤ºé‡ç½®æŒ‰é’®ç­‰ï¼‰ï¼›
  - `uiSchema`ï¼šåœ¨â€œPattern Studio / Intent Studioâ€ä¸­ç¼–è¾‘è¿™äº›å‚æ•°æ—¶çš„è¡¨å•æ§ä»¶é…ç½®ã€‚

## 4. ä¸ LayoutIntent çš„é…åˆ

- LayoutIntent å®šä¹‰äº†æœ‰å“ªäº› slotï¼Œä¾‹å¦‚ `filters/toolbar/table/metrics`ï¼›
- ViewIntent å°† slot ç»‘å®šåˆ°å…·ä½“ Patternï¼š

```yaml
layout:
  layoutType: list-page
  regions:
    - id: filters
      role: filters
    - id: toolbar
      role: toolbar
    - id: table
      role: table

view:
  components:
    - slot: filters
      patternId: filter-bar
      propsIntent:
        fields: [status, createdAt]
    - slot: toolbar
      patternId: toolbar-with-quick-edit
      propsIntent:
        supportExport: true
    - slot: table
      patternId: table-with-server-filter
      propsIntent:
        entity: Order
        columns: [...]
```

å¹³å°æ®æ­¤å¯ï¼š

- æ¸²æŸ“å‡ºå¯¹åº”çš„ UI ç»“æ„ï¼ˆåœ¨ Preview/Docs ä¸­ï¼‰ï¼›
- ä¸º Code Structure/Template ç”Ÿæˆç»„ä»¶éª¨æ¶æ–‡ä»¶ï¼›
- ä¸º LLM æä¾›å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆåˆç†çš„ JSX/TSX ä»£ç ã€‚

## 5. äº¤äº’å½¢æ€ç¤ºä¾‹

åœ¨å¹³å° UI ä¸Šï¼Œè§†å›¾/ç»„ä»¶æ„å›¾å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¡¨è¾¾ï¼š

- Pattern é€‰æ‹©å™¨ï¼š
  - æŒ‰ Layout slot å±•ç¤ºå€™é€‰ Pattern å¡ç‰‡ï¼›
  - ç”¨æˆ·é€‰æ‹©æŸä¸ª Patternï¼Œå³ä¾§å‡ºç°å‚æ•°è¡¨å•ï¼ˆç”± uiSchema é©±åŠ¨ï¼‰ã€‚
- ç»„ä»¶æ ‘è§†å›¾ï¼š
  - å±•ç¤º `Layout` + `View` çš„ç»„åˆæˆæ ‘çŠ¶ç»“æ„ï¼›
  - æ”¯æŒä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ /åˆ é™¤å­ç»„ä»¶ï¼ˆå¦‚æŒ‰é’®ã€æ“ä½œåˆ—ï¼‰å¹¶æ›´æ–° propsIntentã€‚

## 6. è¾¹ç•Œä¸ç¤ºä¾‹ï¼šä¸šåŠ¡è§†å›¾ vs å®ç°ç»†èŠ‚

View & Component Intent å…³æ³¨â€œæ¯ä¸ªåŒºåŸŸæƒ³è¦ä»€ä¹ˆ UI èƒ½åŠ›â€ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°æ–¹å¼ã€‚

### 6.1 æœ¬å±‚å…è®¸/ä¸å…è®¸çš„å†…å®¹

- å…è®¸ï¼ˆWhatï¼‰ï¼š
  - æ¯ä¸ª slot ä½¿ç”¨å“ªç§ Patternï¼ˆè¡¨æ ¼/ç­›é€‰æ /å·¥å…·æ /æŒ‡æ ‡å¡ç­‰ï¼‰ï¼›
  - ä¸šåŠ¡çº§é…ç½®ï¼šæ˜¾ç¤ºå“ªäº›åˆ—ã€å“ªäº›å­—æ®µå¯ç­›é€‰ã€æ”¯æŒå“ªäº›æ“ä½œæŒ‰é’®ç­‰ï¼›
  - å˜ä½“/å¯†åº¦/æ¨¡å¼ï¼ˆdense/card/compact ç­‰ï¼‰ã€‚
- ä¸å…è®¸ï¼ˆHowï¼‰ï¼š
  - å…·ä½“ç»„ä»¶å®ç°åï¼ˆæŸä¸ªå†…éƒ¨ç»„ä»¶çš„ import åç§°ï¼‰ï¼›
  - props å¾®è°ƒç»†èŠ‚ï¼ˆCSS ç±»ã€å…·ä½“ gutter/spacingã€åƒç´ çº§å®½åº¦ï¼‰ï¼›
  - å¤æ‚æ¸²æŸ“é€»è¾‘ï¼ˆè‡ªå®šä¹‰ cell renderer çš„ä»£ç ï¼‰ã€‚

ç¤ºæ„å¯¹æ¯”ï¼š

```yaml
# âœ… Goodï¼šIntent å±‚ View é…ç½®
view:
  components:
    - slot: table
      patternId: table-with-server-filter
      propsIntent:
        entity: Order
        columns:
          - { key: id, title: è®¢å•å·, sortable: true }
          - { key: status, title: çŠ¶æ€ }
          - { key: createdAt, title: ä¸‹å•æ—¶é—´, sortable: true }
        pagination: true

# âŒ Badï¼šæŠŠå®ç°ç»†èŠ‚å†™è¿› View Intent
view:
  components:
    - slot: table
      patternId: table-with-server-filter
      component: OrderTableImpl        # â† å…·ä½“ç»„ä»¶å®ç°
      propsIntent:
        columns:
          - key: id
            title: è®¢å•å·
            width: 120                 # â† åƒç´ çº§å®½åº¦
            cellRenderer: customRender # â† è‡ªå®šä¹‰æ¸²æŸ“å‡½æ•°å
```

è¿™äº›å®ç°ç»†èŠ‚åº”ç”± Pattern å®ç°ã€Template/Plan æˆ–ä»£ç å±‚è´Ÿè´£ã€‚

### 6.2 Minimal ViewIntent å»ºè®®

ä¸€ä¸ªå¯ç”¨çš„ ViewIntent é€šå¸¸è‡³å°‘åŒ…å«ï¼š

- ç›®æ ‡å¸ƒå±€åŒºåŸŸçš„ slotï¼›
- å¯¹åº” Pattern çš„ patternIdï¼›
- è¯¥ Pattern æ‰€éœ€çš„æœ€å°ä¸šåŠ¡é…ç½®ï¼ˆå¦‚ä¸»å®ä½“ã€æ ¸å¿ƒå­—æ®µ/åˆ—ã€å…³é”®æŒ‰é’®ï¼‰ã€‚

LLM çš„è§’è‰²ï¼š

- è¯» Layout + å½“å‰ ViewIntentï¼Œæ¨èåˆé€‚çš„ Pattern / å˜ä½“ï¼›
- æ ¹æ®æ•°æ®æ„å›¾ï¼ˆentities/apisï¼‰è‡ªåŠ¨å»ºè®®åˆ—é…ç½®ã€ç­›é€‰å­—æ®µç­‰è§†å›¾å‚æ•°ã€‚
</file>

<file path="intent-driven-ai-coding/v3/examples/01-smart-search-poc.md">
# POC: æ™ºèƒ½é˜²æŠ–æœç´¢ (Smart Debounced Search)

> **Scenario**: CRM ç³»ç»Ÿä¸­çš„å®¢æˆ·æœç´¢åŠŸèƒ½ã€‚
> **Goal**: éªŒè¯æ¶æ„ä¸‹ "AI Copilot -> Pattern -> Hybrid Coding" çš„å…¨é“¾è·¯å·¥ä½œæµã€‚
> **Status**: PoCã€‚
> **Note**: æœ¬ PoC å·²æ›´æ–°ä¸º v3 Effect-Native æ ‡å‡†èŒƒå¼ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Bound API (`$`) å’Œ `flow` API ç»“åˆ `Effect.Service` æ¥å®ç°ä¸€ä¸ªåŒ…å«é˜²æŠ–ã€ç«æ€å¤„ç†å’ŒçŠ¶æ€ç®¡ç†çš„å¤æ‚æœç´¢åŠŸèƒ½ã€‚

## 1. åœºæ™¯æè¿° (The Context)

*   **UI**: åŒ…å« `SearchInput` (è¾“å…¥æ¡†) å’Œ `CustomerTable` (è¡¨æ ¼)ã€‚
*   **Requirement**:
    1. ç›‘å¬è¾“å…¥æ¡†å˜åŒ–ã€‚
    2. é˜²æŠ– 500msã€‚
    3. è°ƒç”¨ `CustomerService.search`ã€‚
    4. å¤„ç†ç«æ€ (SwitchMap)ï¼šæ–°è¯·æ±‚å‘å‡ºå»æ—¶ï¼Œå–æ¶ˆæ—§è¯·æ±‚ã€‚
    5. è‡ªåŠ¨ç®¡ç† Loading çŠ¶æ€ã€‚
    6. **å˜æ›´éœ€æ±‚**: åœ¨æœç´¢å‰å¢åŠ ä¸€ä¸ªå¤æ‚çš„åŸ‹ç‚¹é€»è¾‘ã€‚

## 2. èµ„äº§å‡†å¤‡ (Architect View)

æ¶æ„å¸ˆé¢„å…ˆå®šä¹‰å¥½äº† `DebouncedSearch` Patternã€‚è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„â€œé»‘ç›’ç§¯æœ¨â€ã€‚

```typescript
// src/patterns/std/search.ts
import { Effect, Schema, Context } from 'effect';
import { Store, Logic } from '~/logix-v3-core'; // æ¦‚å¿µæ€§è·¯å¾„

// 1. å®šä¹‰æœåŠ¡ä¸ Schema
class CustomerApi extends Context.Tag('CustomerApi')<CustomerApi, {
  readonly search: (keyword: string) => Effect.Effect<Customer[], Error>;
}>() {}

const SearchStateSchema = Schema.Struct({
  keyword: Schema.String,
  results: Schema.Array(Schema.Any), // åº”æ›¿æ¢ä¸º Customer Schema
  isSearching: Schema.Boolean
});

const SearchActionSchema = Schema.Never;

type SearchShape = Logix.ModuleShape<typeof SearchStateSchema, typeof SearchActionSchema>;
```

## 3. å¼€å‘è€…å®æˆ˜ (Developer View)

### Phase 1: AI è¾…åŠ©ç”Ÿæˆ

å¼€å‘è€…åœ¨ç”»å¸ƒä¸Šé€‰ä¸­ `SearchInput.onChange`ï¼Œå‘Šè¯‰ AIï¼šâ€œæˆ‘è¦æœç´¢å®¢æˆ·ï¼ŒåŠ é˜²æŠ–â€ã€‚
AI æ¨èå¹¶é…ç½®äº† `DebouncedSearch` Patternï¼Œç”Ÿæˆå¦‚ä¸‹ä»£ç ï¼š

```typescript
// src/features/customer/logic.ts


// 2. Logic å®ç°
export const SearchLogic: Logic.Of<SearchShape, CustomerApi> = Effect.gen(function* () {
  Effect.gen(function*(_) {
    const keyword$ = flow.fromState(s => s.keyword);

    const searchEffect = Effect.gen(function*(_) {
      const api = yield* CustomerApi;
      const { keyword } = yield* state.read;

      yield* state.mutate(draft => { draft.isSearching = true; });
      const result = yield* Effect.either(api.search(keyword));

      if (result._tag === 'Left') {
        // é”™è¯¯å¤„ç†
        yield* state.mutate(draft => { draft.isSearching = false; });
      } else {
        yield* state.mutate(draft => {
          draft.isSearching = false;
          draft.results = result.right;
        });
      }
    });

    yield* keyword$.pipe(
      flow.debounce(500),
      flow.filter(kw => kw.length > 2),
      flow.runLatest(searchEffect)
    );
  })
);
```

**ç”»å¸ƒè¡¨ç°**ï¼š
`Start` -> `[Block: Customer Search]`

---

### Phase 2: æ··åˆç¼–ç  (Hybrid Coding)

éœ€æ±‚å˜æ›´ï¼šéœ€è¦å¢åŠ å¤æ‚çš„åŸ‹ç‚¹é€»è¾‘ã€‚å¼€å‘è€…ç›´æ¥åœ¨ IDE ä¸­æ’å…¥ä»£ç ã€‚

```typescript
// 3. æ··åˆç¼–ç  (Hybrid Coding)
// éœ€æ±‚å˜æ›´ï¼šå¢åŠ ä¸€ä¸ªå¤æ‚çš„åŸ‹ç‚¹é€»è¾‘
export const SearchLogicWithAnalytics: Logic.Of<SearchShape, CustomerApi | AnalyticsApi> = Effect.gen(function* () {
  ({ flow, state }) =>
    Effect.gen(function*(_) {
      const keyword$ = flow.fromState(s => s.keyword);

      // åŸ‹ç‚¹é€»è¾‘ (Black Box)
      const analyticsEffect = Effect.gen(function*(_) {
        const analyticsApi = yield* AnalyticsApi;
        const { keyword } = yield* state.read;
        if (keyword.length > 5 && keyword.includes("VIP")) {
          const encrypted = myComplexCrypto(keyword);
          yield* analyticsApi.track({ encrypted });
        }
      });

      // å°†åŸ‹ç‚¹é€»è¾‘å’Œæœç´¢é€»è¾‘ç»„åˆ
      const combinedEffect = Effect.all([analyticsEffect, searchEffect], { discard: true });

      yield* keyword$.pipe(
        flow.debounce(500),
        flow.filter(kw => kw.length > 2),
        flow.runLatest(combinedEffect)
      );
    })
);
```

**ç”»å¸ƒè¡¨ç°**ï¼š
`Start` -> `[Code: Complex Analytics]` -> `[Block: Customer Search]`

## 4. ä»·å€¼æ€»ç»“

1.  **Efficiency**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ç”± AI + Pattern ç§’çº§ç”Ÿæˆã€‚
2.  **Quality**: å¹¶å‘æ§åˆ¶ç­‰å¤æ‚ç»†èŠ‚è¢«å°è£…åœ¨ Pattern ä¸­ï¼Œå¼€å‘è€…æ— éœ€æ“å¿ƒã€‚
3.  **Flexibility**: é‡åˆ°ç‰¹æ®Šéœ€æ±‚ï¼Œç›´æ¥å†™ TypeScriptï¼Œå¹³å°å®Œç¾å…¼å®¹é»‘ç›’ä»£ç ã€‚
</file>

<file path="intent-driven-ai-coding/v3/platform/impl/app-and-universe-view.md">
# App / Module / Store â†’ Universe View å®ç°è‰å›¾

> **Status**: Draft (v3 Final Â· Implementation Planning)
> **Scope**: å¹³å°å¦‚ä½•ä» `Logix.app` / `Logix.module` / `ModuleDef` æ„å»º Universe Viewï¼ˆæ¨¡å—æ‹“æ‰‘å›¾ï¼‰ä¸ä¾èµ–æ£€æŸ¥ã€‚

æœ¬è¯´æ˜æ–‡æ¡£ä»å¹³å°å®ç°è§†è§’ï¼Œæ•´ç† v3 ä¸­åŸºäº `ModuleDef` çš„ Universe View ä¸ä¾èµ–æ£€æŸ¥æ–¹æ¡ˆã€‚
ç›®æ ‡ï¼š

- æ˜ç¡® Parser åœ¨ TS ä»£ç ä¸­éœ€è¦è¯†åˆ«çš„æ¨¡å¼ï¼ˆAST Patternï¼‰ï¼›
- æè¿°ä» AST â†’ ModuleDef IR â†’ æ‹“æ‰‘å›¾èŠ‚ç‚¹/è¾¹çš„æ„å»ºè¿‡ç¨‹ï¼›
- æŒ‡å‡ºä¸ Runtime å®ç°çš„è€¦åˆç‚¹ä¸å·²çŸ¥å–èˆã€‚

## 1. éœ€è¦è¯†åˆ«çš„ä»£ç æ¨¡å¼

åœ¨ v3 è§„èŒƒä¸­ï¼Œæ¨¡å—ä½“ç³»é€šè¿‡ä»¥ä¸‹ API æš´éœ²ï¼š

```ts
// runtime-logix/core/architecture-app-runtime.ts (æ¦‚å¿µæ€§)

export interface ModuleDef<R> { /* ... */ }

export const Logix = {
  module: <R>(def: ModuleDef<R>) => def,
  app:   <R>(def: Omit<ModuleDef<R>, "exports">) => AppDefinition<R>,
  provide: <S>(tag: Context.Tag<S, S>, value: S): Provider<S> => ({ tag, value }),
}
```

å¹³å°è§£æå™¨éœ€è¦è¯†åˆ«çš„ä¸»è¦è°ƒç”¨å½¢å¼ï¼š

- `Logix.module({ ... })`ï¼šå®šä¹‰æ™®é€š Moduleï¼›
- `Logix.app({ ... })`ï¼šå®šä¹‰æ ¹ Appï¼›
- `imports: [OrderModule, UserModule, ...]`ï¼šæ¨¡å—é—´ä¾èµ–ï¼›
- `providers: [Logix.provide(SomeTag, SomeStore), ...]`ï¼šæ¨¡å—æä¾›çš„ Store / Serviceï¼›
- `links: [SearchSyncLink, ...]`ï¼šä¸šåŠ¡ç¼–æ’é€»è¾‘ï¼ˆèƒ¶æ°´ï¼‰ï¼›
- `processes: [SomeDaemon, ...]`ï¼šåŸºç¡€è®¾æ–½è¿›ç¨‹ï¼ˆæ‚å½¹ï¼‰ï¼›
- `exports: [SomeTag, ...]`ï¼šå¯¹å¤–å…¬å¼€çš„ Tag åˆ—è¡¨ã€‚

> å®ç°å»ºè®®
> - åœ¨ TS å±‚å¯¹ `Logix` ä½¿ç”¨å‘½å importï¼ˆä¾‹å¦‚ `import { Logix } from "@logix/core"`ï¼‰ï¼Œä»¥ä¾¿è§£æå™¨å¿«é€Ÿå®šä½ï¼›
> - å¹³å°å¯ä»¥çº¦å®šï¼šæ‰€æœ‰ Module / App å®šä¹‰å¿…é¡»ä½¿ç”¨ `export const XxxModule = Logix.module(...)` / `export const XxxApp = Logix.app(...)` å½¢å¼ï¼Œé¿å…è¿è¡Œæ—¶åŠ¨æ€æ„é€ ã€‚

## 2. AST â†’ ModuleIR çš„æŠ½è±¡

ä¸ºä¾¿äºå¹³å°å†…éƒ¨å¤„ç†ï¼Œå¯ä»¥å…ˆå°†æºä»£ç ä¸­çš„ ModuleDef æ˜ å°„ä¸ºä¸€ä¸ªç®€åŒ– IRï¼š

```ts
interface ModuleIR {
  id: string

  // æ ‡è¯†è¯¥æ¨¡å—å®šä¹‰æ‰€åœ¨æ–‡ä»¶ / å¯¼å‡ºç¬¦å·
  filePath: string
  exportedName: string

  imports: string[]           // å¼•å…¥çš„å­æ¨¡å— IDï¼ˆæˆ–ç¬¦å·åï¼‰
  providers: Array<{
    tagSymbol: string         // Tag çš„ç¬¦å·åï¼ˆç”¨äºè¿çº¿ï¼‰
    valueSymbol: string       // Store/Service çš„ç¬¦å·å
  }>

  links: string[]             // ä¸šåŠ¡ç¼–æ’ Link çš„ç¬¦å·å
  processes: string[]         // åŸºç¡€è®¾æ–½ Process çš„ç¬¦å·å
  exports: string[]           // å¯¹å¤–å…¬å¼€çš„ Tag ç¬¦å·å

  // é™„åŠ å…ƒæ•°æ®ï¼ˆå¦‚ middlewaresã€æ³¨é‡Šç­‰ï¼‰ï¼Œä¾›åç»­ä½¿ç”¨
  middlewares: string[]
  jsDoc: string | null
}
```

è§£ææµç¨‹ï¼ˆæ¦‚å¿µï¼‰ï¼š

1. æ‰«ææ•´ä¸ªé¡¹ç›®ï¼Œå®šä½æ‰€æœ‰ `Logix.module(...)` / `Logix.app(...)` è°ƒç”¨ï¼›
2. å¯¹æ¯ä¸ªè°ƒç”¨ï¼š
   - è¯»å– `id` å­—æ®µï¼ˆè¦æ±‚ä¸ºå­—ç¬¦ä¸²å­—é¢é‡ï¼‰ï¼›
   - ä»å˜é‡å£°æ˜ä¸­è·å– `filePath` + `exportedName`ï¼›
   - éå† `imports` å±æ€§æ•°ç»„ï¼Œæ”¶é›†å¼•ç”¨çš„æ¨¡å—ç¬¦å·åï¼›
   - éå† `providers` å±æ€§æ•°ç»„ï¼Œè¯†åˆ« `Logix.provide(TagSymbol, ValueSymbol)` æ¨¡å¼ï¼›
   - éå† `links` / `processes` / `exports` / `middlewares` æ•°ç»„ï¼Œæ”¶é›†ç¬¦å·åï¼›
   - **æ³¨æ„**ï¼šéœ€åŒºåˆ† `links` å’Œ `processes` å­—æ®µï¼Œåˆ†åˆ«æ”¶é›†ã€‚
3. ç”Ÿæˆæ•´ä½“ ModuleIR å›¾ã€‚

> è§£æå·¥å…·
> - å®ç°ä¸Šå¯ä½¿ç”¨ ts-morph æˆ– TypeScript Compiler APIï¼›
> - å…³é”®æ˜¯å›ºå®šæ¨¡å¼ï¼šåªæ”¯æŒå¯¹è±¡å­—é¢é‡ + ç®€å•æ ‡è¯†ç¬¦æ•°ç»„ï¼Œé¿å…åœ¨ ModuleDef ä¸­å†™å¤æ‚è¡¨è¾¾å¼ï¼ˆå¦‚æ¡ä»¶è¿ç®—ã€spread ç­‰ï¼‰ï¼Œå¦åˆ™è§£ææˆæœ¬å‰§å¢ã€‚

## 3. ä» ModuleIR æ„å»º Universe View

Universe View å…³æ³¨çš„æ˜¯â€œæ¨¡å—é—´æ‹“æ‰‘â€ä¸â€œæ¨¡å—å†…éƒ¨çš„ Store/Link ç»“æ„â€ã€‚

### 3.1 èŠ‚ç‚¹ç±»å‹

æ¨èçš„èŠ‚ç‚¹ç±»å‹ï¼š

- **App Node**ï¼šæ ¹æ¨¡å—ï¼ˆ`Logix.app`ï¼‰ï¼›
- **Module Node**ï¼šé€šè¿‡ `Logix.module` å®šä¹‰çš„æ¨¡å—ï¼›
- **Store Node**ï¼š`providers` ä¸­ valueSymbol å¯¹åº”çš„ Storeï¼ˆé€šå¸¸æ˜¯ `Logix.ModuleRuntime` æˆ– `ModuleRuntime.make()` ç»“æœï¼‰ï¼›
- **Link Node**ï¼š`links` ä¸­çš„ä¸šåŠ¡ç¼–æ’é€»è¾‘ï¼ˆèƒ¶æ°´èŠ‚ç‚¹ï¼‰ï¼›
- **Process Node**ï¼š`processes` ä¸­çš„åŸºç¡€è®¾æ–½è¿›ç¨‹ï¼ˆé€šå¸¸é»˜è®¤éšè—ï¼Œä»…åœ¨è¯¦ç»†æ¨¡å¼æ˜¾ç¤ºï¼‰ã€‚

### 3.2 è¾¹ç±»å‹

åŸºç¡€è¾¹ï¼š

- **Module Import Edge**ï¼š
  - ä» A æ¨¡å—æŒ‡å‘å…¶ `imports` ä¸­çš„æ¯ä¸ªæ¨¡å—ï¼›
  - è¡¨ç¤ºâ€œç»„åˆ/åŒ…å«å…³ç³»â€ï¼Œä¸ Runtime ä¸­çš„ Layer.mergeAll å¯¹åº”ã€‚

- **Module â†’ Store Edge**ï¼š
  - ä» Module/App Node æŒ‡å‘å…¶ `providers` ä¸­çš„ Store Nodeï¼›
  - è¡¨ç¤ºâ€œè¯¥ Store ç”±æ­¤æ¨¡å—æä¾›â€ã€‚

- **Module â†’ Link Edge**ï¼š
  - ä» Module Node æŒ‡å‘å…¶ `links` ä¸­çš„ Link Nodeï¼›
  - è¡¨ç¤ºâ€œè¯¥ Link å±äºæ­¤æ¨¡å—çš„ä¸šåŠ¡ç¼–æ’â€ã€‚

æ‰©å±•è¾¹ï¼ˆä¾èµ–äºè¿›ä¸€æ­¥è§£æï¼‰ï¼š

- **Link â†’ Store/Service Edge**ï¼š
  - é€šè¿‡å¯¹ `links` æ‰€æŒ‡ Effect ä»£ç åšäºŒæ¬¡è§£æï¼Œè¯†åˆ«å…¶ä¸­ `yield* StoreTag` / `yield* ServiceTag` ç­‰æ¨¡å¼ï¼›
  - **è¿™æ˜¯ Universe View çš„æ ¸å¿ƒä»·å€¼**ï¼šå±•ç¤º Link å¦‚ä½•è¿æ¥å¤šä¸ª Moduleï¼ˆä¾‹å¦‚ Link A åŒæ—¶æŒ‡å‘ Store B å’Œ Store Cï¼‰ã€‚

### 3.3 Drillâ€‘down è§„åˆ™

- ç¬¬ä¸€å±‚ä»…æ˜¾ç¤º App Node + é¡¶å±‚ Module Nodeï¼š
  - èŠ‚ç‚¹æ ‡ç­¾ä½¿ç”¨ `ModuleDef.id`ï¼›
  - æä¾›â€œå±•å¼€â€æ“ä½œã€‚
- å±•å¼€æŸ Module èŠ‚ç‚¹æ—¶ï¼š
  - å±•ç¤ºè¯¥ Module å†…éƒ¨çš„ Store Node / Link Nodeï¼›
  - **Link Node ä¼šæ˜¾ç¤ºå…¶è¿æ¥çš„è·¨åŸŸè¿çº¿**ï¼ˆå³ä½¿è¿æ¥çš„ç›®æ ‡ Store åœ¨å…¶ä»– Module ä¸­ï¼‰ï¼›
  - å¯ç»§ç»­å±•å¼€å­ Moduleï¼ˆimportsï¼‰å½¢æˆå¤šçº§æ ‘ã€‚

è¿™æ ·å½¢æˆçš„è§†å›¾æ—¢èƒ½ä»å®è§‚ä¸Šçœ‹åˆ°â€œæ¨¡å—/é¢†åŸŸä¹‹é—´çš„å…³ç³»â€ï¼Œåˆèƒ½é€šè¿‡ Link Node æ¸…æ™°åœ°çœ‹åˆ°â€œä¸šåŠ¡æ˜¯å¦‚ä½•è·¨åŸŸæµè½¬çš„â€ã€‚

## 4. ä¾èµ–æ£€æŸ¥ä¸é”™è¯¯æç¤º

å€ŸåŠ© ModuleIRï¼Œå¹³å°å¯ä»¥åœ¨é™æ€é˜¶æ®µåšä¸€äº›æ¶æ„çº§æ£€æŸ¥ï¼š

### 4.1 exports çº¦æŸæ£€æŸ¥

åœºæ™¯ï¼šæ¨¡å— A çš„æŸä¸ª Link æˆ– Logic ä»£ç ä¸­ä½¿ç”¨äº†æ¨¡å— B å†…éƒ¨æœªå¯¼å‡ºçš„ Tagã€‚

å®ç°æ­¥éª¤ï¼š

1. é€šè¿‡ Code â†’ Tag ä½¿ç”¨åˆ†æï¼ˆä¾‹å¦‚æ‰«æ `yield* SomeTag`ã€`useModule(SomeTag)` ç­‰è°ƒç”¨ï¼‰æ„å»º â€œé€»è¾‘ä¾èµ–å›¾â€ï¼›
2. å°†ä¾èµ–ä¸­çš„ Tag ä½¿ç”¨ä¸ ModuleIR çš„ `exports` ä¿¡æ¯å¯¹é½ï¼š
   - å¦‚æœæŸä¸ª Tag åªåœ¨ B.providers ä¸­å£°æ˜ï¼Œä½†ä¸åœ¨ B.exports ä¸­å‡ºç°ï¼Œåˆ™è§†ä¸º **å†…éƒ¨ Tag**ï¼›
   - è‹¥ A ä¸æ˜¯ B æœ¬èº«æˆ–å…¶å­æ¨¡å—ï¼Œå´å¼•ç”¨äº†å†…éƒ¨ Tagï¼Œåˆ™åˆ¤å®šä¸ºå°è£…è¿è§„ã€‚

å¹³å°è¡Œä¸ºï¼š

- åœ¨ Universe View ä¸­é«˜äº®è¿è§„è¿çº¿ï¼›
- åœ¨è§„åˆ™åˆ—è¡¨ / ä»£ç è§†å›¾ä¸­ç»™å‡ºé”™è¯¯æˆ–å¼ºè­¦å‘Šï¼›
- æç¤ºå¼€å‘è€…ï¼šåº”å½“å°† Tag åŠ å…¥ B.exportsï¼Œæˆ–å°†ç›¸å…³ Logic ä¸‹æ²‰åˆ° B æ¨¡å—å†…éƒ¨ã€‚

### 4.2 å¾ªç¯ä¾èµ–æ£€æµ‹

ModuleIR çš„ imports å…³ç³»æ„æˆä¸€å¼ æœ‰å‘å›¾ï¼š

- æ£€æµ‹ ModuleDef.id èŠ‚ç‚¹ä¸Šçš„ç¯ï¼ˆA â†’ B â†’ ... â†’ Aï¼‰ï¼›
- åœ¨ Universe View ä¸­é«˜äº®å¾ªç¯è·¯å¾„ï¼›
- å»ºè®®æ‹†åˆ†æ¨¡å—æˆ–å¼•å…¥æ›´ç»†çš„å­æ¨¡å—ä»¥è§£é™¤å¾ªç¯ã€‚

### 4.3 è¿‡åº¦è·¨åŸŸä¾èµ–

åŸºäº â€œLink â†’ Store/Service Edgeâ€ï¼Œå¯ä»¥ç»Ÿè®¡ï¼š

- æŸä¸ª Module ä¸­çš„ Link è¿‡å¤šä¾èµ–å…¶ä»– Module çš„ Store/Serviceï¼ˆä¾‹å¦‚è¶…è¿‡æŸä¸ªé˜ˆå€¼ï¼‰ï¼›
- åœ¨ Universe View ä¸­æç¤ºâ€œè·¨åŸŸä¾èµ–è¿‡å¤šâ€çš„æ¨¡å—ï¼Œè¾…åŠ©æ¶æ„æ²»ç†ã€‚

## 5. ä¸ Runtime çš„è€¦åˆç‚¹

åœ¨ v3 ä¸­ï¼Œå¹³å°ä¸ Runtime åœ¨æ¨¡å—ä½“ç³»ä¸Šçš„å…³é”®å¥‘çº¦æ˜¯ï¼š**éƒ½ä»¥ ModuleDef ä¸ºæ ¸å¿ƒ**ï¼Œä½†å…³æ³¨ç‚¹ä¸åŒï¼š

- Runtimeï¼š
  - ä½¿ç”¨ ModuleDef æ„å»º Layer å’Œ processesï¼Œé‡‡ç”¨ Env æ‰å¹³åˆå¹¶ç­–ç•¥ï¼›
  - ä¸ç†ä¼š exports ä¸ middlewares çš„å…·ä½“è¯­ä¹‰ï¼›
  - å°† `links` å’Œ `processes` åˆå¹¶æ‰§è¡Œã€‚
- å¹³å°ï¼š
  - ä½¿ç”¨ ModuleDef æ„å»º Universe View ä¸ä¾èµ–å›¾ï¼›
  - **ä¸¥æ ¼åŒºåˆ† `links` (ä¸šåŠ¡) å’Œ `processes` (åŸºå»º)**ï¼›
  - ä½¿ç”¨ exports è¿›è¡Œå°è£…çº¦æŸæ£€æŸ¥ï¼›
  - ä½¿ç”¨ middlewares å…ƒä¿¡æ¯å¸®åŠ© AOP/UI é…ç½®ã€‚

é‡è¦çš„æ˜¯ï¼šå³ä¾¿ Runtime æš‚ä¸åš Env è£å‰ªï¼Œå¹³å°å±‚ä»ç„¶å¯ä»¥é€šè¿‡ ModuleIR åšå‡ºä¸¥è°¨çš„â€œå¯è§æ€§â€çº¦æŸä¸é”™è¯¯æŠ¥å‘Šï¼Œè¿™ä¹Ÿæ˜¯ v3 çš„è®¾è®¡å–èˆä¹‹ä¸€ã€‚

## 6. çº¦æŸä¸å¯è§£æå­é›†

ä¸ºäº†è®©ä¸Šè¿°å®ç°ä¿æŒå¯æ§ï¼Œå¹³å°éœ€è¦å¯¹ ModuleDef å†™æ³•åšä¸€äº›çº¦æŸï¼š

- **å¯¹è±¡å­—é¢é‡ä¼˜å…ˆ**ï¼š
  - `Logix.module({ ... })` / `Logix.app({ ... })` æ¨èä½¿ç”¨ç›´æ¥çš„å¯¹è±¡å­—é¢é‡ï¼›
  - é¿å…åœ¨é…ç½®ä¸­ä½¿ç”¨ `...spread`ã€æ¡ä»¶è¡¨è¾¾å¼ã€è¿è¡Œæ—¶å˜é‡æ‹¼æ¥ç­‰å¤æ‚å†™æ³•ã€‚
- **ç¬¦å·å¼•ç”¨ä¼˜å…ˆ**ï¼š
  - `imports` / `providers` / `links` / `processes` / `exports` æ•°ç»„ä¸­çš„å…ƒç´ åº”ä¸ºç®€å•æ ‡è¯†ç¬¦æˆ– `Logix.provide(Tag, Value)` è¿™ç§å›ºå®šæ¨¡å¼ï¼›
  - é¿å…åœ¨æ•°ç»„ä¸­å†™å¤æ‚è¡¨è¾¾å¼ï¼ˆå¦‚ç«‹å³è°ƒç”¨å‡½æ•°ç­‰ï¼‰ã€‚

å¯¹äºä¸æ»¡è¶³ä¸Šè¿°çº¦æŸçš„å†™æ³•ï¼Œå¹³å°å¯ä»¥ï¼š

- å°†å¯¹åº”æ¨¡å—æ ‡è®°ä¸ºâ€œéƒ¨åˆ†å¯è§£æâ€æˆ– Gray Boxï¼›
- ä»…åœ¨ Universe View ä¸­å±•ç¤ºæœ‰é™ä¿¡æ¯ï¼Œé¿å…ç»™å‡ºè¯¯å¯¼æ€§çš„æ‹“æ‰‘ã€‚

## 7. äº¤äº’ç­–ç•¥ï¼šå®è§‚å¯ç¼–ï¼Œå¾®è§‚åªè¯» (Interaction Strategy)

é’ˆå¯¹â€œå›¾å½¢åŒ–ç¼–è¾‘æ˜¯å¦æœ‰æ„ä¹‰â€çš„é—®é¢˜ï¼Œv3 é‡‡å– **äºŒå…«åŸåˆ™**ï¼š

### 7.1 å®è§‚æ¶æ„ (L1/L2)ï¼šå¯ç¼–è¾‘ (Editable)
**åœºæ™¯**ï¼šæ¨¡å—åˆ’åˆ†ã€ä¾èµ–æ²»ç†ã€é“¾è·¯éª¨æ¶è®¾è®¡ã€‚
**ä»·å€¼**ï¼šé™ä½æ¶æ„é‡æ„æˆæœ¬ï¼Œå¯è§†åŒ–æ„å›¾ã€‚

*   **æ‹–æ‹½é‡æ„**ï¼šå°† Module èŠ‚ç‚¹åœ¨ Module ä¹‹é—´æ‹–æ‹½ï¼Œå¹³å°è‡ªåŠ¨é‡æ„æ–‡ä»¶ç›®å½•ä¸ `imports` é…ç½®ã€‚
*   **è¿çº¿ç¼–æ’**ï¼šåœ¨ Link Node ä¸ Module Node ä¹‹é—´æ‹‰çº¿ï¼Œå¹³å°è‡ªåŠ¨åœ¨ Link ä»£ç ä¸­æ’å…¥ `yield* Module.Tag` éª¨æ¶ã€‚
*   **çˆ†ç‚¸åŠå¾„åˆ†æ**ï¼šç‚¹å‡»èŠ‚ç‚¹é«˜äº®æ‰€æœ‰ä¸Šä¸‹æ¸¸ä¾èµ–ï¼Œè¾…åŠ©æ¶æ„å†³ç­–ã€‚

### 7.2 å¾®è§‚é€»è¾‘ (L3)ï¼šåªè¯»/è·³è½¬ (Read-only / Jump)
**åœºæ™¯**ï¼šå…·ä½“ä¸šåŠ¡é€»è¾‘å®ç°ï¼ˆå¦‚ `filter`, `map`, `if/else`ï¼‰ã€‚
**ä»·å€¼**ï¼šé¿å…â€œè¿çº¿ç¼–ç¨‹â€å¸¦æ¥çš„ä½æ•ˆä¸è‡ƒè‚¿ã€‚

*   **æ‹’ç»æ„å¤§åˆ©é¢æ¡**ï¼šä¸æä¾›ç»†ç²’åº¦çš„ AST èŠ‚ç‚¹ç¼–è¾‘ï¼ˆå¦‚ä¸æä¾›â€œIf èŠ‚ç‚¹â€ã€â€œLoop èŠ‚ç‚¹â€ï¼‰ã€‚
*   **ä»£ç ä¸ºç‹**ï¼šåŒå‡» Link/Module èŠ‚ç‚¹ï¼Œç›´æ¥è·³è½¬åˆ° VSCode / ç¼–è¾‘å™¨å¯¹åº”è¡Œã€‚
*   **AI è¾…åŠ©**ï¼šL3 å±‚çš„é€»è¾‘ä¿®æ”¹ç”± **AI Copilot** åœ¨ä»£ç ç¼–è¾‘å™¨ä¸­å®Œæˆï¼Œè€Œä¸æ˜¯åœ¨ç”»å¸ƒä¸Šè¿çº¿ã€‚

**æ€»ç»“**ï¼šUniverse View æ˜¯æ¶æ„å¸ˆçš„ä¸Šå¸è§†è§’ï¼ˆGod Modeï¼‰ï¼Œè€Œä¸æ˜¯ç¨‹åºå‘˜çš„ç§¯æœ¨ç©å…·ã€‚
</file>

<file path="intent-driven-ai-coding/v3/platform/impl/code-runner-and-sandbox.md">
# Code Runner & Sandbox ç­–ç•¥

> **Status**: Draft (v3 Final Â· Implementation Planning)
> **Scope**: å¹³å°å¦‚ä½•è¿è¡Œå’Œè°ƒè¯•ç”¨æˆ·çš„ Effect-TS ä»£ç ã€‚

## 1. æ ¸å¿ƒå†³ç­–ï¼šFrontend First

é’ˆå¯¹â€œå¦‚ä½•è¿è¡Œç”¨æˆ·ä»£ç â€è¿™ä¸€é—®é¢˜ï¼Œv3 æ¶æ„æ˜ç¡®é€‰æ‹© **å‰ç«¯æ–¹æ¡ˆ (Browser / WebWorker)** ä½œä¸ºé¦–é€‰è¿è¡Œæ—¶ï¼Œè€Œéåç«¯æ²™ç®± (Node/Docker)ã€‚

### 1.1 å†³ç­–ä¾æ®

| ç»´åº¦ | å‰ç«¯æ–¹æ¡ˆ (Web Worker) | åç«¯æ–¹æ¡ˆ (Node Sandbox) |
| :--- | :--- | :--- |
| **å“åº”é€Ÿåº¦** | âš¡ï¸ **é›¶å»¶è¿Ÿ** (æœ¬åœ°å†…å­˜) | ğŸ¢ **é«˜å»¶è¿Ÿ** (ç½‘ç»œ + å®¹å™¨å¯åŠ¨) |
| **èµ„æºæˆæœ¬** | ğŸ’° **å…è´¹** (ç”¨æˆ·ç®—åŠ›) | ğŸ’¸ **æ˜‚è´µ** (æœåŠ¡å™¨ç®—åŠ›) |
| **Mock ä½“éªŒ** | **ä¸æ»‘** (ç›´æ¥æ³¨å…¥ JS å¯¹è±¡) | **ç¹ç** (éœ€ RPC/åºåˆ—åŒ–) |
| **æ¶æ„éªŒè¯** | âœ… **å¼ºè¿«è§£è€¦** (Platform Agnostic) | âš ï¸ **å®¹æ˜“è€¦åˆ** (ä¾èµ– fs/net) |

### 1.2 å“²å­¦æ„ä¹‰

é€‰æ‹©å‰ç«¯è¿è¡Œæ—¶ä¸ä»…æ˜¯æˆæœ¬è€ƒé‡ï¼Œæ›´æ˜¯å¯¹ **Effect-Native** æ¶æ„çš„ç»ˆæéªŒæ”¶ï¼š
å¦‚æœä¸šåŠ¡é€»è¾‘ (Module Logic) æ— æ³•åœ¨æµè§ˆå™¨ä¸­é…åˆ Mock Layer è¿è¡Œï¼Œè¯´æ˜å®ƒ**è€¦åˆäº†ä¸è¯¥è€¦åˆçš„åŸºç¡€è®¾æ–½**ï¼Œè¿èƒŒäº†ä¾èµ–å€’ç½®åŸåˆ™ã€‚

## 2. å®ç°æ¶æ„

### 2.1 è¿è¡Œæ—¶å®¹å™¨ï¼šWeb Worker

ä¸ºäº†é˜²æ­¢ç”¨æˆ·ä»£ç æ­»å¾ªç¯å¡æ­» UI çº¿ç¨‹ï¼Œå¿…é¡»åœ¨ Web Worker ä¸­è¿è¡Œé€»è¾‘ã€‚

#### 2.1.1 ç¼–è¯‘å™¨é€‰å‹ï¼šesbuild-wasm

åœ¨ `esbuild-wasm` ä¸ `swc-wasm` ä¹‹é—´ï¼Œv3 æ˜ç¡®é€‰æ‹© **`esbuild-wasm`**ã€‚

*   **ç†ç”±**ï¼š
    1.  **Bundling èƒ½åŠ›**ï¼šæˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿå¤šæ–‡ä»¶æ¨¡å—ç¯å¢ƒï¼ˆModule Resolutionï¼‰ï¼Œ`esbuild` çš„ Bundling ç®—æ³•æˆç†Ÿä¸”ç¨³å¥ï¼Œè€Œ `swc` çš„ bundler (`swcpack`) å°šå¤„äºå®éªŒé˜¶æ®µã€‚
    2.  **Plugin API**ï¼š`esbuild` æä¾›äº†å¼ºå¤§çš„ `onResolve` / `onLoad` é’©å­ï¼Œå…è®¸æˆ‘ä»¬åœ¨æµè§ˆå™¨ç«¯è½»æ¾å®ç° **Virtual File System**ï¼ˆä»å†…å­˜è¯»å– TS æ–‡ä»¶å†…å®¹ï¼‰ï¼Œè¿™æ˜¯ Playground çš„æ ¸å¿ƒéœ€æ±‚ã€‚
    3.  **ç”Ÿæ€å…¼å®¹**ï¼šEffect-TS å®˜æ–¹ Playground åŠå¤§å¤šæ•°åœ¨çº¿ IDE (StackBlitz ç­‰) å‡é‡‡ç”¨ esbuild æ–¹æ¡ˆï¼Œå‘å°‘è·¯å¹³ã€‚
*   **ä»£ä»·**ï¼š
    *   WASM åŒ…ä½“ç§¯è¾ƒå¤§ (~8MB)ï¼Œéœ€é…ç½® HTTP Cache å’Œ Lazy Load ç­–ç•¥ä¼˜åŒ–é¦–å±ä½“éªŒã€‚

```mermaid
graph TD
    Main[Main Thread (UI)] <-->|postMessage| Worker[Web Worker (Runtime)]

    subgraph Worker
        Compiler[esbuild-wasm] -->|Bundle (Virtual FS)| UserCode[User Effect]
        MockLayer[Mock Environment] -->|Provide| UserCode
        UserCode -->|Run| Result
    end
```

### 2.2 ä¾èµ–æ³¨å…¥ (DI) ä¸ Mock

åˆ©ç”¨ Effect çš„ Layer ç³»ç»Ÿï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾æ›¿æ¢æ‰€æœ‰å‰¯ä½œç”¨æœåŠ¡ï¼š

```typescript
// çœŸå®ç¯å¢ƒ (Node/Server)
const LiveEnv = Layer.mergeAll(
  PostgresDB.Live,
  RedisCache.Live,
  StripePayment.Live
);

// å¹³å°è¿è¡Œæ—¶ (Browser Worker)
const PlaygroundEnv = Layer.mergeAll(
  // ä½¿ç”¨å†…å­˜æ•°æ®åº“æ¨¡æ‹Ÿ
  InMemoryDB.Live,
  // ä½¿ç”¨æ§åˆ¶å°æ—¥å¿—
  ConsoleLogger.Live,
  // ä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜æœåŠ¡ (æ€»æ˜¯æˆåŠŸæˆ–éšæœºå¤±è´¥)
  MockPayment.Live
);

// è¿è¡Œ
userEffect.pipe(Effect.provide(PlaygroundEnv));
```

### 2.3 äº¤äº’åè®®

Worker ä¸ä¸»çº¿ç¨‹é€šè¿‡ç»“æ„åŒ–æ¶ˆæ¯é€šä¿¡ï¼š

*   **Log**: Worker æ•è· `ConsoleLogger` çš„è¾“å‡º -> å‘é€ç»™ä¸»çº¿ç¨‹ -> æ§åˆ¶å°å±•ç¤ºã€‚
*   **Trace**: Worker æ”¶é›† `Effect.Tracer` æ•°æ® -> å‘é€ç»™ä¸»çº¿ç¨‹ -> ç€‘å¸ƒå›¾å±•ç¤ºã€‚
*   **Hot Update**: ä¸»çº¿ç¨‹ä¿®æ”¹ Mock æ•°æ® (å¦‚ "æ¨¡æ‹Ÿç½‘ç»œè¶…æ—¶") -> å‘é€ç»™ Worker -> Worker é‡ç½® Env å¹¶é‡è·‘ã€‚

## 3. å±€é™æ€§ä¸è¾¹ç•Œ (Limitations)

è™½ç„¶å‰ç«¯æ–¹æ¡ˆä¼˜åŠ¿å·¨å¤§ï¼Œä½†åœ¨ `logix` + `effect-ts` ä½“ç³»ä¸‹æœ‰ä»¥ä¸‹å…·ä½“å±€é™ï¼š

### 3.1 ä¸¥ç¦å¼•ç”¨ `@effect/platform-node`
è¿™æ˜¯æœ€å¸¸è§çš„é”™è¯¯æ¥æºã€‚
*   **é—®é¢˜**ï¼šè‹¥ä¸šåŠ¡ä»£ç  import äº† `@effect/platform-node`ï¼ŒBundler ä¼šè¯•å›¾æ‰“åŒ… Node.js çš„ `fs`/`net` æ¨¡å—ï¼Œå¯¼è‡´æ„å»ºå¤±è´¥ã€‚
*   **çº¦æŸ**ï¼šModule/Link å±‚ä»£ç  **åªèƒ½ä¾èµ– `@effect/platform` (çº¯æ¥å£)**ã€‚
*   **æ²»ç†**ï¼šå¹³å°åº”é…ç½® ESLint è§„åˆ™ï¼Œç¦æ­¢åœ¨ä¸šåŠ¡é€»è¾‘ç›®å½•å¼•å…¥ `-node` ç»“å°¾çš„åŒ…ã€‚

### 3.2 HttpClient çš„ CORS é™åˆ¶
*   **é—®é¢˜**ï¼šæµè§ˆå™¨ç¯å¢ƒå—åŒæºç­–ç•¥é™åˆ¶ã€‚è‹¥ç”¨æˆ·å°è¯•åœ¨ Playground ä¸­é€šè¿‡ `HttpClient` è°ƒç”¨çœŸå®çš„å¤–éƒ¨ APIï¼ˆè€Œé Mockï¼‰ï¼Œä¸”è¯¥ API æœªé…ç½® CORS Headersï¼Œè¯·æ±‚ä¼šå¤±è´¥ã€‚
*   **å¯¹ç­–**ï¼š
    1.  **æ¨è Mock**ï¼šPlayground æ ¸å¿ƒåœºæ™¯åº”åŸºäº `MockLayer`ã€‚
    2.  **ä»£ç†è½¬å‘**ï¼šè‹¥å¿…é¡»è°ƒç”¨çœŸå®æ¥å£ï¼Œéœ€åœ¨å¹³å°ä¾§æä¾› CORS Proxy æœåŠ¡ã€‚

### 3.3 åŒæ­¥é˜»å¡ (CPU Bound)
*   **é—®é¢˜**ï¼šEffect è™½æ“…é•¿å¼‚æ­¥ï¼Œä½†è‹¥åŒ…å«å¤§é‡åŒæ­¥è®¡ç®—ï¼ˆå¦‚ `while(true)` æ­»å¾ªç¯ï¼‰ï¼Œä¼šé˜»å¡ Worker çš„ Event Loopï¼Œå¯¼è‡´æ— æ³•å“åº” `postMessage`ï¼ˆåŒ…æ‹¬åœæ­¢æŒ‡ä»¤ï¼‰ã€‚
*   **å¯¹ç­–**ï¼šå¹³å°å¿…é¡»å…·å¤‡ **"Terminate & Restart Worker"** çš„ç¡¬é‡ç½®èƒ½åŠ›ï¼Œè€Œä¸èƒ½ä»…ä¾èµ–è½¯æ€§çš„ `Fiber.interrupt`ã€‚

### 3.4 å¯†é’¥å®‰å…¨
*   **é—®é¢˜**ï¼šæµè§ˆå™¨ç¯å¢ƒä¸èƒ½å­˜å‚¨çœŸå® API Keyã€‚
*   **å¯¹ç­–**ï¼šPlayground ç¯å¢ƒä¸€å¾‹ä½¿ç”¨ Mock Serviceï¼Œä¸å‘èµ·çœŸå® HTTP è¯·æ±‚ã€‚

## 4. æ€»ç»“

v3 å¹³å°é€šè¿‡ **Web Worker + Effect Layer** å®ç°äº†ä¸€ä¸ªé›¶æˆæœ¬ã€æ¯«ç§’çº§å“åº”çš„ **å…¨åŒå·¥ä»£ç æ¼”ç»ƒåœº**ã€‚è¿™æ—¢æå‡äº† DXï¼Œåˆå€’é€¼äº†æ¶æ„çš„çº¯æ´æ€§ã€‚
</file>

<file path="intent-driven-ai-coding/v3/platform/impl/intent-rule-and-codegen.md">
# IntentRule â†” TS ä»£ç  Â· è§£æä¸å‡ºç è‰å›¾

> **Status**: Draft (v3 Final Â· Implementation Planning)
> **Scope**: å¹³å°å¦‚ä½•åœ¨ v3 ä¸‹å®ç° IntentRule ä¸ Logix/TS ä»£ç ä¹‹é—´çš„å•å‘/åŒå‘æ˜ å°„ï¼ˆParser & Codegenï¼‰ã€‚

æœ¬è¯´æ˜æ–‡æ¡£åŸºäº `runtime-logix/core/06-platform-integration.md` ä¸­çš„ IntentRule å®šä¹‰ï¼Œè¡¥å……å¹³å°å®ç°è§†è§’çš„ç»†èŠ‚ï¼š
- ä» TS ä»£ç ä¸­è§£æå‡º IntentRuleï¼ˆCode â†’ IRï¼‰ï¼›
- ä» IntentRule ç”Ÿæˆæ ‡å‡†åŒ– TS ä»£ç ï¼ˆIR â†’ Codeï¼‰ï¼›
- é™å®šâ€œå¯è§£æå­é›†â€ï¼Œé¿å…è§£æå™¨è¿‡åº¦å¤æ‚ã€‚

## 1. IntentRule å›é¡¾

æ ¸å¿ƒç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

```ts
interface IntentRule {
  source: {
    context: "self" | string
    type: "state" | "action"
    selector: string        // AST å¼•ç”¨æˆ–åºåˆ—åŒ–è¡¨è¾¾å¼
  }
  pipeline: Array<{
    op: "debounce" | "throttle" | "filter" | "switchMap" | "exhaustMap" | "custom"
    args: ReadonlyArray<unknown>
  }>
  sink: {
    context: "self" | string
    type: "mutate" | "dispatch" | "service"
    handler: string        // AST å¼•ç”¨æˆ–åºåˆ—åŒ–è¡¨è¾¾å¼
  }
}
```

å¹³å°èŒè´£ï¼š

- å°½å¯èƒ½ä»è§„èŒƒåŒ–çš„ Logix ä»£ç æ¢å¤ä¸º IntentRuleï¼›
- åœ¨å¹³å° UI ä¸­ç¼–è¾‘ IntentRuleï¼Œå†ç”Ÿæˆè§„èŒƒåŒ–çš„ Logix ä»£ç ã€‚

## 2. Code â†’ IntentRuleï¼šå¯è§£æå­é›†

è§£æå™¨åªå¤„ç†ç‰¹å®šæ¨¡å¼çš„ä»£ç ï¼Œè¶…å‡ºéƒ¨åˆ†è§†ä¸º Gray Boxã€‚

### 2.1 Source æ¨¡å¼

æ”¯æŒä¸¤ç±» Sourceï¼š

1. State è§¦å‘ï¼š

```ts
const country$ = $Form.flow.fromState((s) => s.country)
```

æ˜ å°„ä¸ºï¼š

```json
{
  "source": {
    "context": "self",
    "type": "state",
    "selector": "s => s.country" // ä»¥å­—ç¬¦ä¸²æˆ– AST åºåˆ—åŒ–å­˜å‚¨
  }
}
```

2. Action è§¦å‘ï¼š

```ts
const submit$ = $Form.flow.fromAction(
  (a): a is { _tag: "form/submit" } => a._tag === "form/submit"
)
```

æ˜ å°„ä¸ºï¼š

```json
{
  "source": {
    "context": "self",
    "type": "action",
    "selector": "a => a._tag === 'form/submit'"
  }
}
```

è§£æå™¨åœ¨ AST å±‚çš„åŒ¹é…è§„åˆ™ï¼š

- è°ƒç”¨é“¾èµ·ç‚¹ä¸º `$X.flow.fromState` / `$X.flow.fromAction`ï¼›
- ä»…æ”¯æŒå‚æ•°ä¸ºå•ä¸ªç®­å¤´å‡½æ•°ï¼Œå†…éƒ¨æ˜¯ç®€å•å±æ€§è®¿é—®æˆ– `_tag` å­—é¢é‡æ¯”è¾ƒã€‚

### 2.2 Pipeline æ¨¡å¼

æ”¯æŒçš„ Flow ç»„åˆç®—å­ï¼š

- `flow.debounce(ms)` â†’ `op: "debounce", args: [ms]`
- `flow.throttle(ms)` â†’ `op: "throttle", args: [ms]`
- `flow.filter(predicate)` â†’ `op: "filter", args: [<predicate AST>]`
- `flow.run(...)` / `runLatest` / `runExhaust` â†’ å½±å“å¹¶å‘è¯­ä¹‰ï¼Œå¯ç¼–ç è¿› pipeline çš„æœ€åä¸€æ­¥ã€‚

ä»£ç æ¨¡å¼ï¼ˆé“¾å¼ï¼‰ï¼š

```ts
const effect$ = source$.pipe(
  $X.flow.debounce(300),
  $X.flow.filter((v) => v.length > 2),
  $X.flow.runLatest(someEffect),
)
```

è§£æå™¨ç­–ç•¥ï¼š

1. è¯†åˆ« `CallExpression` é“¾å¼ç»“æ„ï¼š`source$.pipe( ... )`ï¼›
2. é€ä¸ªåˆ†æ `pipe` å‚æ•°ï¼š
   - è‹¥æ˜¯ `Identifier` æˆ– `PropertyAccessExpression` æŒ‡å‘ `$X.flow.debounce`ï¼šè®°å½•ä¸º `debounce`ï¼›
   - è‹¥æ˜¯ `CallExpression`ï¼Œæ£€æŸ¥ callee æ˜¯å¦æ˜¯ `$X.flow.debounce/throttle/filter/run*`ï¼›
3. å°†è¯†åˆ«åˆ°çš„ç®—å­æŒ‰é¡ºåºå†™å…¥ IntentRule.pipelineã€‚

è¶…å‡ºå¯è§£æå­é›†çš„ Patternï¼š

- ä½¿ç”¨ä»»æ„ Stream/Effect ç»„åˆå™¨ï¼ˆé Flow APIï¼‰ï¼›
- åœ¨ `pipe` ä¸­ä¼ å…¥åŒ¿åå‡½æ•°æˆ–å¤æ‚è¡¨è¾¾å¼ï¼›

è¿™äº›å°†è¢«æ ‡è®°ä¸º `op: "custom"`ï¼Œå¹¶é™„å¸¦åŸå§‹ä»£ç ç‰‡æ®µä¾›åç»­äººå·¥æŸ¥çœ‹ã€‚

### 2.3 Sink æ¨¡å¼

æ”¯æŒä¸‰ç±» Sinkï¼š

1. State mutateï¼š

```ts
$X.flow.run(
  $X.state.mutate((draft) => {
    draft.province = ""
  }),
)
```

æ˜ å°„ä¸ºï¼š

```json
{
  "sink": {
    "context": "self",
    "type": "mutate",
    "handler": "draft => { draft.province = '' }"
  }
}
```

2. State updateï¼ˆçº¯å‡½æ•°ï¼‰ï¼š

```ts
$X.flow.run(
  $X.state.update((prev) => ({ ...prev, count: prev.count + 1 })),
)
```

åŒæ ·æ˜ å°„ä¸º `type: "mutate"` æˆ– `type: "update"`ï¼ˆå¯é€‰åŒºåˆ†ï¼‰ã€‚

3. Action dispatchï¼ˆè·¨ Store alsoï¼‰ï¼š

```ts
$Source.flow.run(
  Target.actions.dispatch({ _tag: "detail/init", payload: ... }),
)
```

æ˜ å°„ä¸ºï¼š

```json
{
  "sink": {
    "context": "DetailStore",    // ä» Target Tag æˆ–å˜é‡åæ¨å¯¼
    "type": "dispatch",
    "handler": "a => ({ _tag: 'detail/init', payload: ... })"
  }
}
```

è§£æå™¨æ¨¡å¼ï¼š

- è¯†åˆ« `$X.state.mutate` / `$X.state.update` / `$X.actions.dispatch` / `OtherStore.actions.dispatch` è°ƒç”¨ï¼›
- å°†å†…éƒ¨ç®­å¤´å‡½æ•° AST åºåˆ—åŒ–ä¸º handler å­—ç¬¦ä¸²ã€‚

## 3. L1 / L2 Fluent DSL ä¸ Intent.IR çš„æ˜ å°„

åœ¨ v3 æœ€ç»ˆå½¢æ€ä¸­ï¼Œä¸šåŠ¡ä»£ç æ¨èä½¿ç”¨ Fluent DSL ç¼–æ’ L1/L2 è§„åˆ™ï¼ŒIR å±‚ç»Ÿä¸€ä½¿ç”¨ `IntentRule` è¡¨è¾¾ï¼Œä¸å†å•ç‹¬å®šä¹‰ä»»ä½•è¿è¡Œæ—¶ `Intent` å‘½åç©ºé—´ã€‚
æœ¬èŠ‚è¯´æ˜ Fluent å†™æ³•ä¸ IntentRule / Intent.IR ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚

### 3.1 L1ï¼šå• Store å†…è”åŠ¨

ä»£ç å†™æ³•ï¼ˆFluentï¼‰ï¼š

```ts
yield* $.onState((s: FormState) => s.country)
  .then(
    $.state.update((prev) => ({ ...prev, province: "" })),
  )
```

IntentRule IR å½¢æ€ï¼š

```json
{
  "source": { "context": "self", "type": "state", "selector": "s => s.country" },
  "pipeline": [],
  "sink": { "context": "self", "type": "mutate", "handler": "(value, prev) => ({ ... })" }
}
```

### 3.2 L2ï¼šè·¨ Store åä½œ

ä»£ç å†™æ³•ï¼ˆFluentï¼‰ï¼š

```ts
const $Search = yield* $.use(Search);
const $Detail = yield* $.use(Detail);

yield* $.on($Search.changes((s) => s.results))
  .filter((results) => results.length > 0)
  .then((results) =>
    $Detail.dispatch({
      _tag: "detail/init",
      payload: pickFirst(results),
    }),
  );
```

IntentRule IR å½¢æ€ï¼š

```json
{
  "source": { "context": "SearchModule", "type": "state", "selector": "s => s.results" },
  "pipeline": [{ "op": "filter", "args": ["results => results.length > 0"] }],
  "sink": {
    "context": "DetailModule",
    "type": "dispatch",
    "handler": "results => ({ _tag: 'detail/init', payload: pickFirst(results) })"
  }
}
```

å‰ææ˜¯ï¼šè°ƒç”¨ç‚¹é™„è¿‘èƒ½è§£æå‡º Source/Target Module å®šä¹‰æˆ– Context.Tag ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨ IR ä¸­å¡«å…… `context` å­—æ®µã€‚

## 4. IntentRule â†’ Codeï¼šç”Ÿæˆè§„èŒƒåŒ– Logix å†™æ³•

ä» IntentRule ç”Ÿæˆä»£ç æ—¶ï¼Œå¹³å°åº”è¾“å‡º **ç»“æ„åŒ–ä¸”å¯è§£æçš„æ ‡å‡†å†™æ³•**ï¼Œé¿å…ç”Ÿæˆè¿‡äºâ€œèªæ˜â€çš„ä»£ç ã€‚

### 4.1 ç”Ÿæˆ L1 ä»£ç ç¤ºä¾‹

ç»™å®š IntentRuleï¼š

```json
{
  "source": { "context": "self", "type": "state", "selector": "s => s.country" },
  "pipeline": [{ "op": "debounce", "args": [300] }],
  "sink": { "context": "self", "type": "mutate", "handler": "draft => { draft.province = '' }" }
}
```

ç”Ÿæˆä»£ç ï¼ˆFluent ç‰ˆæœ¬ï¼›ç¤ºä¾‹ä¸­çš„ `$Form` æ¦‚å¿µä¸Šè¡¨ç¤ºé’ˆå¯¹ FormShape é¢„ç»‘å®šçš„ Bound APIï¼Œå®é™… PoC ä¸­æ¨èåœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($Form)=>...)` è·å– `$Form`ï¼‰ï¼š

```ts
const $Form = {} as Logic.BoundApi<FormShape>

export const CountryProvinceLogic: Logic.Of<FormShape> = Effect.gen(function* () {
  const country$ = $Form.flow.fromState((s) => s.country)

  yield* country$.pipe(
    $Form.flow.debounce(300),
    $Form.flow.run(
      $Form.state.mutate((draft) => {
        draft.province = ""
      }),
    ),
  )
})
```

æˆ–ç›´æ¥ç”Ÿæˆ Fluent Intent DSLï¼ˆåŒæ ·å‡å®š `$Form` ç”±å¯¹åº” Module æ³¨å…¥ï¼‰ï¼š

```ts
export const CountryProvinceLogic: Logic.Of<FormShape> = Effect.gen(function* () {
  yield* $Form.onState((s) => s.country)
    .debounce(300)
    .then(
      $Form.state.mutate((draft) => {
        draft.province = ""
      }),
    )
})
```

å¹³å°å¯ä»¥æä¾›é€‰é¡¹ï¼šä¼˜å…ˆç”Ÿæˆ Fluent DSLï¼Œæˆ–ä¼˜å…ˆç”Ÿæˆåº•å±‚ Flow å†™æ³•ã€‚

### 4.2 ç”Ÿæˆ L2 ä»£ç ç¤ºä¾‹

ç»™å®šè·¨ Store IntentRuleï¼š

```json
{
  "source": { "context": "SearchStore", "type": "state", "selector": "s => s.results" },
  "pipeline": [],
  "sink": { "context": "DetailStore", "type": "dispatch", "handler": "results => ({ ... })" }
}
```

ç”Ÿæˆä»£ç ï¼ˆFluent ç‰ˆæœ¬ï¼›ç¤ºä¾‹ä¸­çš„ `$` æ¦‚å¿µä¸Šè¡¨ç¤ºé’ˆå¯¹ CoordinatorShape é¢„ç»‘å®šçš„ Bound APIï¼Œå®é™… PoC ä¸­æ¨èåœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ï¼‰ï¼š

```ts
const $ = {} as Logic.BoundApi<CoordinatorShape>

export const SearchDetailCoordinator: Logic.Of<CoordinatorShape> = Effect.gen(function* () {
  const $Search = yield* $.use(SearchStore)
  const $Detail = yield* $.use(DetailStore)

  yield* $.on($Search.changes((s) => s.results))
    .filter((results) => results.length > 0)
    .then((results) =>
      $Detail.dispatch({
        _tag: "detail/init" as const,
        payload: pickFirst(results),
      }),
    )
})
```

æ­¤ç±» Fluent ä»£ç éå¸¸é€‚åˆè¢«è§£æå™¨è¯†åˆ«å› IntentRuleï¼Œå®ç° Fullâ€‘Duplexã€‚

## 5. ä¸ ESLint / å·¥å…·é“¾çš„åä½œ

ä¸ºäº†ä¿æŒâ€œä»£ç å¯è§£æâ€ï¼Œå¹³å°å’Œ runtime å»ºè®®æä¾› ESLint è§„åˆ™æˆ– CLI æ£€æŸ¥ï¼š

- ç¦æ­¢åœ¨å¯è§£æå­é›†èŒƒå›´å†…ä½¿ç”¨å¤æ‚è¡¨è¾¾å¼ï¼š
  - ä¾‹å¦‚ forbiddingï¼š`source.pipe(doSomethingDynamic())` ä½œä¸º IntentRule æºï¼›
  - å¼•å¯¼å¼€å‘è€…æŠŠå¤æ‚é€»è¾‘æ”¾å…¥ Pattern / Serviceï¼Œè€Œä¸æ˜¯å¡è¿› Flow pipeline ä¸­ã€‚

- æä¾›è‡ªåŠ¨ä¿®å¤å»ºè®®ï¼š
- å°†â€œå±•å¼€å†™æ³•â€é‡æ„ä¸ºæ ‡å‡† Fluent é“¾ï¼ˆe.g. è¯†åˆ« `fromState + debounce + run(state.mutate)`ï¼Œè‡ªåŠ¨å»ºè®®æ›¿æ¢ä¸º `$.onState(...).debounce(...).then($.state.mutate(...))`ï¼‰ã€‚

è¿™å¯ä»¥ä¿è¯éšç€ä»£ç åº“å¢é•¿ï¼Œè¶Šæ¥è¶Šå¤šçš„ Logic å†™æ³•è½åœ¨â€œå¯è§£æã€å¯ roundâ€‘tripâ€çš„å­é›†å†…ã€‚

## 6. æ€»ç»“

v3 åœ¨ IntentRule â†” TS ä»£ç æ˜ å°„ä¸Šçš„ç­–ç•¥æ˜¯ï¼š

- æ˜ç¡®å¯è§£æå­é›†ï¼ˆFluent DSL + å¸¸è§ Flow ç»„åˆï¼‰ï¼›
- ç”Ÿæˆè§„èŒƒåŒ–ã€ç»“æ„åŒ–çš„ä»£ç å†™æ³•ï¼Œæ–¹ä¾¿ Parser åå‘è¿˜åŸï¼›
- åˆ©ç”¨ ESLint/å·¥å…·é“¾çº¦æŸè¶Šç•Œå†™æ³•ï¼Œé™ä½è§£æå™¨å¤æ‚åº¦ï¼›
- å¯¹è§£æä¸äº†çš„éƒ¨åˆ†å¦ç‡æ ‡ä¸º Gray/Black Boxï¼Œè€Œä¸æ˜¯åšä¸å¯é çš„â€œæ™ºèƒ½çŒœæµ‹â€ã€‚

è¿™ä¸ºåç»­ v4 çº§åˆ«çš„ Fullâ€‘Duplexï¼ˆç”»å¸ƒ â†” ä»£ç åŒå‘å®æ—¶åŒæ­¥ï¼‰æ‰“ä¸‹ç¨³å®šåŸºç¡€ã€‚***
</file>

<file path="intent-driven-ai-coding/v3/platform/impl/logic-middleware-and-aop-ui.md">
# Logic Middleware & AOP Â· å¹³å°é…ç½®ä¸å¯è§†åŒ–è‰å›¾

> **Status**: Draft (v3 Final Â· Implementation Planning)  
> **Scope**: å¹³å°å¦‚ä½•å›´ç»• Logic Middlewareï¼ˆæ—¥å¿—/é‰´æƒç­‰ AOP èƒ½åŠ›ï¼‰æä¾›é…ç½® UIã€ä»£ç ç”Ÿæˆä¸å¯è§†åŒ–å±•ç¤ºã€‚

æœ¬è¯´æ˜æ–‡æ¡£ä»å¹³å°è§†è§’æ•´ç† v3 ä¸­ Logic Middleware çš„ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠ UI/å‡ºç å™¨åº”å¦‚ä½•ä¸ runtime è§„èŒƒå¯¹é½ã€‚

## 1. æ ¸å¿ƒä¿¡æ¯æ¥æº

å¹³å°å…³äº Middleware/AOP çš„ä¿¡æ¯ä¸»è¦æ¥è‡ªä¸‰å¤„ï¼š

1. **ModuleDef.middlewares**ï¼ˆæ¶æ„çº§é…ç½®ï¼‰  
   - æ¯ä¸ª Group/App å¯ä»¥é€šè¿‡ `middlewares` å­—æ®µå£°æ˜ä¸€ç»„é»˜è®¤ä¸­é—´ä»¶ï¼Œä¾‹å¦‚ `LoggingMiddleware`ã€`AuthMiddleware` ç­‰ï¼›  
   - è¿™äº›ä¸­é—´ä»¶å¾€å¾€å…·æœ‰â€œæ—¥å¿—â€â€œæƒé™â€â€œå®¡è®¡â€ç­‰è¯­ä¹‰æ ‡ç­¾ã€‚

2. **ä»£ç ä¸­çš„ Middleware å®šä¹‰**ï¼ˆå®ç°ç»†èŠ‚ï¼‰  
   - åœ¨ TS ä»£ç ä¸­ï¼Œä»¥ `const Logging = (next, meta) => ...` çš„å½¢å¼å®šä¹‰ï¼›  
   - å¹³å°å¯ä»¥é€šè¿‡ç®€å•çº¦å®šï¼ˆæ–‡ä»¶å¤¹/å‘½åè§„èŒƒï¼‰è¯†åˆ«å‡ºä¸€éƒ¨åˆ†â€œæ ‡å‡†ä¸­é—´ä»¶â€ã€‚

3. **Logic ä¸­çš„è°ƒç”¨æ¨¡å¼**ï¼ˆå®é™…ä½¿ç”¨ï¼‰  
   - ä¾‹å¦‚ï¼š

     ```ts
     const secure = Logic.compose(Logging, AuthGuard);
     yield* $.flow.fromAction('delete').pipe(
       $.flow.run(secure(deleteEffect, { name: 'deleteUser' }))
     );
     ```

   - é€šè¿‡ AST è¯†åˆ« `Logic.compose(...)` ä¸ `secure(effect, meta)` çš„ patternï¼Œå¹³å°å¯ä»¥åˆ¤æ–­æŸä¸ª Logic èŠ‚ç‚¹å¯ç”¨äº†å“ªäº› AOP èƒ½åŠ›ã€‚

## 2. é…ç½®æ¨¡å‹ï¼šAOP èƒ½åŠ›çš„å…ƒä¿¡æ¯

å¹³å°ä¾§å¯ä»¥æŠ½è±¡å‡ºä¸€ä¸ª AOP èƒ½åŠ›æè¿°ï¼š

```ts
interface AopCapability {
  id: string;               // ä¾‹å¦‚ "logging", "auth"
  label: string;            // UI ä¸Šæ˜¾ç¤ºçš„åç§°
  description?: string;     // è¯´æ˜æ–‡æ¡ˆ

  // ç»‘å®šåˆ°å…·ä½“ Middleware çš„æ˜ å°„ä¿¡æ¯
  // å¦‚ "LoggingMiddleware" æˆ– "AuthGuard"
  middlewareSymbol: string; 
}
```

ModuleDef ä¸ Logic å¯ä»¥åˆ†åˆ«æŒ‚è½½è¿™äº›èƒ½åŠ›ï¼š

- åœ¨ ModuleDef ä¸­ï¼š

  ```ts
  export const UserModule = Logix.module({
    id: "UserModule",
    // ...
    middlewares: [LoggingMiddleware, AuthGuard],
  })
  ```

- åœ¨ Logic ä¸­ï¼ˆè‹¥éœ€è¦å±€éƒ¨è¦†ç›–ï¼‰ï¼š

  ```ts
  const secure = Logic.compose(LoggingMiddleware, AuthGuard);
  ```

å¹³å°å¯ä»¥ç»´æŠ¤ä¸€å¼ æ˜ å°„è¡¨ï¼š

```ts
const AOP_CAPABILITIES: Record<string, AopCapability> = {
  LoggingMiddleware: { id: "logging", label: "å®¡è®¡æ—¥å¿—", middlewareSymbol: "LoggingMiddleware" },
  AuthGuard: { id: "auth", label: "æƒé™æ ¡éªŒ", middlewareSymbol: "AuthGuard" },
};
```

## 3. é…ç½® UIï¼šæ¨¡å—çº§ & é€»è¾‘çº§

### 3.1 æ¨¡å—çº§ AOP é…ç½®ï¼ˆModule Panelï¼‰

åœ¨ Universe / Module è§†å›¾ä¸­ï¼Œæ¯ä¸ªæ¨¡å—èŠ‚ç‚¹å¯ä»¥æœ‰ä¸€ä¸ªé…ç½®é¢æ¿ï¼Œå±•ç¤ºï¼š

- å¯ç”¨ AOP èƒ½åŠ›åˆ—è¡¨ï¼ˆæ¥è‡ª `AOP_CAPABILITIES`ï¼‰ï¼›  
- å½“å‰æ¨¡å—å¯ç”¨çš„èƒ½åŠ›ï¼ˆæ¥è‡ª ModuleDef.middlewares çš„è§£æç»“æœï¼‰ã€‚

UI äº¤äº’ï¼š

- å‹¾é€‰/å–æ¶ˆå‹¾é€‰æŸä¸ªèƒ½åŠ› â†’ æ›´æ–°æ¨¡å—é…ç½®ä¸­çš„ `middlewares` å­—æ®µï¼›  
- ä¿å­˜åè§¦å‘ä»£ç ç”Ÿæˆï¼šæ›´æ–°å¯¹åº”çš„ ModuleDef ä¸ç›¸å…³ Logic ä»£ç ã€‚

### 3.2 Logic çº§ AOP é…ç½®ï¼ˆLogic Node Panelï¼‰

åœ¨ Logic è§†å›¾ä¸­ï¼ˆGalaxy View æˆ–è§„åˆ™åˆ—è¡¨ï¼‰ï¼Œæ¯ä¸ª Logic èŠ‚ç‚¹å¯ä»¥å±•ç¤ºï¼š

- è¯¥é€»è¾‘å®é™…ä½¿ç”¨çš„ä¸­é—´ä»¶åˆ—è¡¨ï¼š  
  - ä¼˜å…ˆä»ä»£ç ä¸­çš„ `Logic.compose(...)` + `secure(...)` è§£æï¼›  
  - è‹¥æ— æ˜¾å¼è°ƒç”¨ï¼Œåˆ™å›é€€åˆ°æ¨¡å—çº§é»˜è®¤ Middlewareï¼ˆModuleDef.middlewaresï¼‰ã€‚

UI äº¤äº’ï¼š

- å…è®¸åœ¨å•ä¸ª Logic ä¸Šâ€œå…³é—­æŸä¸ª AOPâ€ï¼Œå³ä¸åº”ç”¨æ¨¡å—çº§é»˜è®¤ Middlewareï¼›  
- æˆ–ä¸ºæŸä¸ª Logic å¢åŠ é¢å¤– Middlewareã€‚

è¿™äº›æ“ä½œéƒ½å¯¹åº”ä¸ºä»£ç å±‚çš„æ˜¾å¼æ’å…¥/ç§»é™¤ï¼š

- æ’å…¥/åˆ é™¤æŸä¸ª Logic å†…éƒ¨çš„ `Logic.compose(...)` å‚æ•°ï¼›  
- æˆ–è€…ç”Ÿæˆä¸€ä¸ªæ–°çš„ `compose(...)` åŒ…è£¹å±‚ã€‚

## 4. ä»£ç ç”Ÿæˆç­–ç•¥

### 4.1 æ¨¡å—çº§ â†’ Logic å†…éƒ¨ä»£ç 

å‡ºç å™¨æµç¨‹ç¤ºæ„ï¼š

1. è¯»å–æŸ Module çš„ `middlewares` é…ç½®ï¼Œå¾—åˆ°ä¸€ä¸ª Middleware åˆ—è¡¨ï¼›  
2. å¯¹è¯¥æ¨¡å—å†…æ‰€æœ‰ Logic å®šä¹‰ï¼š  
   - è‹¥ Logic æ— æ˜¾å¼ä¸­é—´ä»¶è°ƒç”¨ï¼Œåˆ™åœ¨ç”Ÿæˆä»£ç æ—¶æ’å…¥ï¼š

     ```ts
     const secure = Logic.compose(LoggingMiddleware, AuthGuard);
     // ...
     yield* $.flow.fromAction(...).pipe(
       $.flow.run(secure(effect, { name: "..." }))
     );
     ```

   - è‹¥ Logic å·²æœ‰ `secure = Logic.compose(...)`ï¼Œåˆ™æŒ‰ UI é…ç½®è°ƒæ•´ compose å‚æ•°åºåˆ—ã€‚

3. ç¡®ä¿ç”Ÿæˆçš„å½¢å¼æ»¡è¶³â€œå¯è§£æå­é›†â€è¦æ±‚ï¼ˆç»“æ„ç®€å•ã€æ˜“è¿˜åŸï¼‰ã€‚

### 4.2 é€»è¾‘çº§è¦†ç›–æ¨¡å—é»˜è®¤

å½“ Logic çº§åˆ«çš„é…ç½®ä¸æ¨¡å—çº§é»˜è®¤é…ç½®ä¸ä¸€è‡´æ—¶ï¼Œå¯ä»¥é‡‡ç”¨ä¸¤ç§ç­–ç•¥ï¼š

- **Override æ¨¡å¼**ï¼šLogic çº§é…ç½®å®Œå…¨è¦†ç›–æ¨¡å—çº§é»˜è®¤ï¼›  
- **Merge æ¨¡å¼**ï¼šåœ¨æ¨¡å—çº§é»˜è®¤åŸºç¡€ä¸Šå¢åŠ /ç§»é™¤éƒ¨åˆ† Middlewareã€‚

å»ºè®®ï¼š

- v3 å…ˆé‡‡ç”¨ Override æ¨¡å¼ï¼š  
  - Logic ä¸Šæ˜¾å¼é…ç½®çš„ Middleware åˆ—è¡¨å³ä¸ºæœ€ç»ˆåå•ï¼›  
  - å¦‚æœ Logic ä¸Šæ— é…ç½®ï¼Œåˆ™ç»§æ‰¿æ¨¡å—çº§åˆ—è¡¨ã€‚  

è¿™æ ·å¯ä»¥å‡è½»ä»£ç ç”Ÿæˆå’Œè§£æå¤æ‚åº¦ã€‚

## 5. å¯è§†åŒ–ï¼šåœ¨å›¾ä¸Šè¡¨è¾¾ AOP

### 5.1 èŠ‚ç‚¹æ ‡è®°

åœ¨ Logic èŠ‚ç‚¹ä¸Šï¼Œå¯ä»¥é‡‡ç”¨ç®€å•çš„æ ‡ç­¾/å›¾æ ‡è¡¨è¾¾ AOP çŠ¶æ€ï¼š

- â€œå®¡è®¡æ—¥å¿—â€ï¼šåœ¨èŠ‚ç‚¹å³ä¸Šè§’æ˜¾ç¤ºä¸€ä¸ª log å›¾æ ‡ï¼›  
- â€œæƒé™æ ¡éªŒâ€ï¼šæ˜¾ç¤º shield å›¾æ ‡ï¼›  
- æ‚¬æµ®æ—¶å±•ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆæ¥è‡ª LogicMeta / AopCapability.descriptionï¼‰ã€‚

### 5.2 è¿‡æ»¤è§†å›¾

æä¾› AOP ç»´åº¦çš„è¿‡æ»¤èƒ½åŠ›ï¼š

- åªæ˜¾ç¤ºå¯ç”¨äº†æŸä¸ªèƒ½åŠ›çš„ Logic èŠ‚ç‚¹ï¼ˆä¾‹å¦‚æ‰€æœ‰å¸¦â€œæƒé™æ ¡éªŒâ€çš„é€»è¾‘ï¼‰ï¼›  
- ç”¨äºå®¡è®¡å’Œæ²»ç†ï¼Œå¦‚â€œå“ªäº›é€»è¾‘è¿˜æ²¡æœ‰æ¥å…¥å®¡è®¡æ—¥å¿—ï¼Ÿâ€ã€‚

## 6. ä¸ Runtime çš„è¾¹ç•Œ

å¦‚ Runtime å®ç°å¤‡å¿˜ä¸­æ‰€è¿°ï¼Œv3 ä¸è®¡åˆ’åœ¨è¿è¡Œæ—¶è‡ªåŠ¨ä» ModuleDef.middlewares æ³¨å…¥ Middlewareã€‚  
å› æ­¤å¹³å°å±‚åœ¨è®¾è®¡æ—¶è¦æ³¨æ„ï¼š

- **æ‰€æœ‰ AOP é…ç½®æœ€ç»ˆéƒ½åº”ä½“ç°åœ¨ TS ä»£ç ä¸­**ï¼ˆå³é€šè¿‡ Middleware è°ƒç”¨æ˜¾å¼è¡¨è¾¾ï¼‰ï¼›  
- ModuleDef.middlewares åªæ˜¯è¾…åŠ©å¹³å°åœ¨â€œæ¨¡å—å±‚é¢â€å­˜å‚¨è¿™äº›é…ç½®ï¼ŒRuntime ä¸åŸºäºå®ƒåšä»»ä½•éšå¼è¡Œä¸ºï¼›
- å¦‚æœæœªæ¥ v4 å¼•å…¥è¿è¡Œæ—¶ Middleware Registryï¼Œå¹³å°å¯ä»¥ç»§ç»­å¤ç”¨è¿™äº›é…ç½®ï¼Œä½†ä¸éœ€è¦ä¿®æ”¹ v3 å·²ç”Ÿæˆçš„ä»£ç ã€‚

## 7. çº¦æŸä¸å¯è§£æå­é›†

ä¸ IntentRule ç±»ä¼¼ï¼Œå¹³å°éœ€è¦çº¦å®š Middleware ä½¿ç”¨çš„å¯è§£æå­é›†ï¼š

- æ¨è Patternï¼š  

  ```ts
  const secure = Logic.compose(LoggingMiddleware, AuthGuard /*, ... */);
  yield* source$.pipe(
    $.flow.run(secure(effect, { name: "xxx", storeId: "StoreId" })),
  );
  ```

- é¿å…åœ¨ compose / secure è°ƒç”¨ä¸­å¡å…¥å¤æ‚è¡¨è¾¾å¼ï¼ˆå¦‚åŠ¨æ€æ•°ç»„ã€æ¡ä»¶è¿ç®—ç­‰ï¼‰ï¼›  
- å¯¹ä¸æ»¡è¶³ Pattern çš„ä»£ç ï¼Œå¯ä»¥ï¼š  
  - åœ¨ UI ä¸Šæ˜¾ç¤ºä¸ºâ€œè‡ªå®šä¹‰ AOPï¼ˆä¸å¯è§£æï¼‰â€ï¼›  
  - ä¸æä¾›é…ç½®åŒ–ç¼–è¾‘ï¼Œä»…æ”¯æŒæŸ¥çœ‹ã€‚

é€šè¿‡è¿™äº›çº¦å®šï¼Œå¹³å°å¯ä»¥åœ¨ä¸ä¾µå…¥ Runtime çš„å‰æä¸‹ï¼Œæä¾›ä¸€ä¸ªå¯ç”¨ã€å¯è¿›åŒ–çš„ AOP é…ç½®ä¸å¯è§†åŒ–æ–¹æ¡ˆï¼Œä¸ºåç»­ç‰ˆæœ¬æ›´å¼ºçš„ Middleware èƒ½åŠ›æ‰“åŸºç¡€ã€‚***
</file>

<file path="intent-driven-ai-coding/v3/platform/impl/README.md">
# Platform Â· Implementation Notes (å¹³å°å®ç°å¤‡å¿˜å½•)

> **Status**: Draft (v3 Final Â· Implementation Planning)
> **Scope**: å¹³å°ä¾§è§£æ / å‡ºç  / å¯è§†åŒ– ç­‰èƒ½åŠ›çš„å®ç°è‰å›¾ä¸æŠ€æœ¯å¤‡å¿˜ï¼Œä¸ç›´æ¥é¢å‘ä¸šåŠ¡ä½¿ç”¨è€…ã€‚

æœ¬ç›®å½•ç”¨äºæ²‰æ·€ **å¹³å°è§†è§’** ä¸‹çš„å®ç°ç»†èŠ‚ä¸æŠ€æœ¯å†³ç­–ï¼Œç‰¹åˆ«æ˜¯ä¸ Logix Runtime ç´§è€¦åˆçš„éƒ¨åˆ†ï¼Œä¾‹å¦‚ï¼š

- Universe View / Galaxy View å¦‚ä½•æ¶ˆè´¹ `ModuleDef` / `Logix.app` / `Logix.module` / `IntentRule` ç­‰ç»“æ„åŒ–ä¿¡æ¯ï¼›
- Parser å¦‚ä½•ä» TS ä»£ç ä¸­è¿˜åŸ IntentRule / Logic Graphï¼Œå¹¶ä¸å¹³å° UI åšåŒå‘åŒæ­¥ï¼ˆFullâ€‘Duplexï¼‰çš„â€œå¯è§£æå­é›†â€å®šä¹‰ï¼›
- å¹³å°å¦‚ä½•åŸºäº Module/App/Store æ‹“æ‰‘åšä¾èµ–æ£€æŸ¥ã€é£é™©åˆ†æï¼ˆå¾ªç¯ä¾èµ–ã€è·¨åŸŸè¿‡å¤šè”åŠ¨ç­‰ï¼‰ä¸å¯è§†åŒ–æç¤ºã€‚

## ä½¿ç”¨æ–¹å¼

- å½“æˆ‘ä»¬åœ¨è®¨è®º **å¹³å°ä¸ runtime çš„é›†æˆåè®®** æ—¶ï¼ˆä¾‹å¦‚ App/Module/Store æ¨¡å—æ ‘ â†’ Universe Viewã€IntentRule â†â†’ TS ä»£ç ã€AOP ä¸­é—´ä»¶åœ¨å¹³å° UI ä¸­çš„é…ç½®æ–¹å¼ï¼‰ï¼Œé™¤äº†æ›´æ–° v3 ä¸»è§„èŒƒï¼ˆ`platform/README.md`ã€`06-codegen-and-parser.md` ç­‰ï¼‰ï¼Œè¿˜åº”åœ¨æœ¬ç›®å½•ä¸‹è¡¥ä¸€ä»½ã€Œå¹³å°å®ç°è§†è§’ã€çš„æŠ€å¤‡æ–‡æ¡£ï¼š
  - æè¿°è§£æ/ç”Ÿæˆçš„æ ¸å¿ƒæ•°æ®æµä¸å…³é”® AST Patternï¼›
  - æ˜ç¡®å“ªäº›ä»£ç å†™æ³•è¢«è§†ä¸ºâ€œå¯è§£æå­é›†â€ï¼Œå“ªäº›ä¼šé€€åŒ–ä¸º Gray/Black Boxï¼›
  - è®°å½•ä¸ Logix Runtime çš„è€¦åˆç‚¹ï¼ˆä¾‹å¦‚ï¼šå¦‚ä½•åˆ©ç”¨ `ModuleDef.imports/providers/exports/processes/middlewares` æ„å»º Universe Viewï¼‰ã€‚

## è§„åˆ’ä¸­çš„å­æ–‡æ¡£

å»ºè®®æŒ‰åŠŸèƒ½åŸŸæ‹†åˆ†å®ç°å¤‡å¿˜ï¼š

- `app-and-universe-view.md`
  è®°å½•å¹³å°å¦‚ä½•ä» `Logix.app` / `Logix.module` / `ModuleDef` æ„å»ºæ¨¡å—æ‹“æ‰‘ï¼ˆUniverse Viewï¼‰ï¼š
  - AST è§£æå…¥å£ï¼ˆ`Logix.app(...)` / `Logix.module(...)` / `Logix.provide(...)` / `imports/providers/processes/exports`ï¼‰ï¼›
  - Drillâ€‘down è§„åˆ™ï¼ˆModule å±•å¼€ä¸º Store / Process èŠ‚ç‚¹ï¼‰ï¼›
  - ä¾èµ–æ£€æŸ¥ä¸é”™è¯¯æç¤ºç­–ç•¥ï¼ˆæœª export Tag çš„éæ³•å¼•ç”¨ã€å¾ªç¯ä¾èµ–ç­‰ï¼‰ã€‚

- `intent-rule-and-codegen.md`
  è®°å½• IntentRule ä¸ TS ä»£ç ä¹‹é—´çš„æ˜ å°„å®ç°ï¼š
  - Parser å¦‚ä½•è¯†åˆ« Fluent DSLï¼ˆ`$.onState` / `$.onAction` / `$.on`ï¼‰/ Flow ç»„åˆå¹¶è¿˜åŸä¸º IntentRuleï¼›
  - Generator å¦‚ä½•ä» IntentRule ç”Ÿæˆæ ‡å‡†åŒ– `*.logic.ts` ä»£ç ï¼›
  - å¯è§£æå­é›†çš„è¾¹ç•Œè§„åˆ™ä¸ ESLint / å·¥å…·é“¾çº¦æŸã€‚

- `logic-middleware-and-aop-ui.md`
  è®°å½•å¹³å°ä¾§å¦‚ä½•é…ç½®ä¸å±•ç¤º Logic Middleware / AOPï¼š
  - å¦‚ä½•ä» `ModuleDef.middlewares` ä¸ä»£ç ä¸­çš„ `Logic.compose(...)` / `secure(effect, meta)` æ¨å¯¼æ¨ªåˆ‡èƒ½åŠ›ï¼›
  - åœ¨ Logic å›¾ä¸èŠ‚ç‚¹å±æ€§é¢æ¿ä¸Šçš„æ˜ å°„æ–¹å¼ã€‚

> æ³¨ï¼šæœ¬ç›®å½•æ˜¯å¹³å°å®ç°è€…çš„â€œå·¥ä½œè‰ç¨¿åŒºâ€ã€‚ä¸€æ—¦æŸä¸ªå®ç°ç»†èŠ‚ä¸Šå‡ä¸ºé•¿æœŸç¨³å®šçš„åè®®æˆ–è§„èŒƒï¼Œåº”åŒæ­¥å›å†™åˆ° v3 ä¸»è§„æ ¼æ–‡æ¡£ï¼Œå¹¶åœ¨æ­¤å¤„ç•™é“¾æ¥è¯´æ˜ã€‚

## Fluent Intent / Universal $ çš„å¹³å°å®ç°æ³¨æ„äº‹é¡¹ï¼ˆv3 Finalï¼‰

ç»“åˆ `v3/06-codegen-and-parser.md` ä¸ `runtime-logix/core/03-logic-and-flow.md`ï¼Œå¹³å°ä¾§åœ¨å®ç°è§£æä¸å‡ºç æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹ç¡¬çº¦æŸï¼š

1. **è§£æå…¥å£ï¼šä»¥ `$` ä¸ Module ä¸ºä¸­å¿ƒ**
   - è§£æå™¨ä¸å†å›´ç»• `Flow.from().pipe(...)`ï¼Œè€Œæ˜¯ä»¥ä»¥ä¸‹ç»“æ„ä½œä¸ºä¸»å…¥å£ï¼š
     - `const X = Logix.Module("Id", { state, actions })`ï¼šå®šä¹‰é¢†åŸŸæ¨¡å—ä¸ Idï¼›
     - `X.logic(($) => Effect.gen(function* (_) { ... }))`ï¼šæ ‡è®° Logic å•å…ƒä¸ `$` ä¸Šä¸‹æ–‡ï¼›
     - `yield* $.use(ModuleOrService)`ï¼šæ„å»ºä¾èµ–ç¬¦å·è¡¨ï¼ˆModule / Serviceï¼‰ã€‚
   - å¹³å°åº”å°†â€œ`Logix.Module` + `.logic` + `$.use` + Fluent é“¾â€è§†ä½œå®Œæ•´çš„ **é€»è¾‘ç¼–æ’ä¸Šä¸‹æ–‡**ï¼Œå…¶ä»–ä»£ç ä»…ä½œä¸ºè¡¥å……ä¿¡æ¯æ˜¾ç¤ºã€‚

2. **Fluent é“¾çš„ç™½ç›’å­é›†ä¸ AST æ¨¡å¼**
   - ç™½ç›’æ¨¡å¼ä»…è¦†ç›–ä»¥ä¸‹ç›´æ¥è°ƒç”¨å½¢æ€ï¼ˆå•è¯­å¥ï¼Œä¸ç»ä¸­è½¬å˜é‡ï¼‰ï¼š
     - `yield* $.onState(selector).op1().op2().then(effect, opts?)`ï¼›
     - `yield* $.onAction(predicate).op().then(effect, opts?)`ï¼›
     - `yield* $.on(streamExpr).op().then(effect, opts?)`ã€‚
   - å®ç°æ—¶åº”ä¼˜å…ˆç”¨ç®€å•çš„æ¨¡å¼åŒ¹é…ï¼ˆä¾‹å¦‚â€œåµŒå¥— CallExpression é“¾ + æœ€å¤–å±‚æ˜¯ YieldExpressionâ€ï¼‰ï¼Œé¿å…æ„å»ºå¤æ‚çš„æ§åˆ¶æµåˆ†æï¼›
   - ä¸€æ—¦é“¾æ¡è¢«æ‹†æˆä¸­é—´å˜é‡æˆ–åŒ…è£¹åœ¨é«˜é˜¶å‡½æ•°é‡Œï¼Œå³è§†ä¸º Raw Modeï¼Œè§£æå™¨åªè®°å½•æœ€å¤–å±‚ Effect Block çš„ä½ç½®ä¿¡æ¯ã€‚

3. **Symbol Tableï¼š`$.use` é©±åŠ¨çš„ä¾èµ–æ‹“æ‰‘**
   - è§£æå™¨å¿…é¡»å»ºç«‹â€œå±€éƒ¨å˜é‡å â†’ StoreId / ServiceIdâ€çš„ç¬¦å·è¡¨ï¼š
     - `const $User = yield* $.use(User)` â†’ `$User` ç»‘å®šåˆ° StoreId `"User"`ï¼›
     - `const tracker = yield* $.use(Analytics)` â†’ `tracker` ç»‘å®šåˆ° Service `"Analytics"`ã€‚
   - åœ¨è§£æ Fluent é“¾æ—¶ï¼Œé€šè¿‡è¯¥ç¬¦å·è¡¨åˆ¤æ–­ï¼š
     - æŸä¸ª `when($User.changes(...))` çš„ Source å±äºå“ªä¸ª Storeï¼›
     - `then` ä¸­çš„ `$User.dispatch(...)` / `$.state.mutate(...)` / `tracker.track(...)` çš„ Sink å±äºå“ªä¸ª Store/Serviceã€‚
   - è‹¥ä»£ç æœªé€šè¿‡ `$.use` è·å–ä¾èµ–ï¼ˆä¾‹å¦‚ç›´æ¥ä½¿ç”¨ Tagï¼‰ï¼Œå¹³å°å¯ä»¥é€‰æ‹©ï¼š
     - è¦ä¹ˆå®Œå…¨ä¸è§£æè¯¥éƒ¨åˆ†ï¼ˆæ ‡è®°ä¸º Rawï¼‰ï¼›
     - è¦ä¹ˆåœ¨ Universe/Galaxy è§†å›¾ä¸­é™çº§ä¸ºâ€œæœªå»ºæ¨¡ä¾èµ–â€ï¼Œä½†ä¸å¯¹å…¶åšè¯­ä¹‰æ¨æ–­ã€‚

4. **IntentRule IR çš„ç”Ÿæˆä¸å›å†™**
   - å¯¹ç™½ç›’ Fluent é“¾ï¼Œè§£æå™¨åº”ç”Ÿæˆå®Œæ•´çš„ IntentRuleï¼š
     - `source`ï¼šä» `when*` + ç¬¦å·è¡¨æ¨å¯¼ï¼›
     - `pipeline`ï¼šä» `.debounce/.throttle/.filter/.map` ç­‰ç®—å­æ¨å¯¼ï¼›
     - `sink`ï¼šä» `then` å†…éƒ¨å¯¹ `$`/StoreHandle/Service çš„è°ƒç”¨æ¨å¯¼ã€‚
  - IR å±‚ç»Ÿä¸€ä½¿ç”¨ `IntentRule` ç»“æ„æ¥è¡¨è¾¾è¯­ä¹‰ï¼Œä¸å†ä¾èµ–ä»»ä½• `Intent.*` å‘½åç©ºé—´ï¼›
  - Graph â†’ Code æ—¶ï¼Œå¹³å°ä¿®æ”¹ Fluent é“¾ï¼ˆè€Œä¸æ˜¯ç”Ÿæˆé¢å¤–çš„é€‚é… APIï¼‰ï¼Œä¿è¯ä»£ç ä¸ IR çš„å•ä¸€äº‹å®æºä»æ˜¯ `$`ã€‚

5. **Eject / Raw Mode çš„å¹³å°è¡Œä¸º**
   - ä¸€æ—¦ç”¨æˆ·åœ¨ç”»å¸ƒä¸­é€‰æ‹©â€œEject to Codeâ€ï¼š
     - å¹³å°åº”å°† Fluent é“¾è½¬æ¢ä¸ºåº•å±‚ `$.flow.fromX().pipe(..., run*)` æˆ–å…¶ä»– Effect ç»„åˆï¼›
     - åœ¨å¯¹åº”èŠ‚ç‚¹ä¸Šæ ‡è®°ä¸º Raw Modeï¼Œå¹¶åœ¨ IR ä¸­ä¿ç•™æœ€å°å…ƒä¿¡æ¯ï¼ˆæ‰€å± Store/Logicã€å¯èƒ½çš„ Source/Sink æ¦‚ç•¥ï¼‰ï¼›
     - åç»­ç¼–è¾‘ä¸å†å°è¯•å°†è¯¥èŠ‚ç‚¹è¿˜åŸä¸º Fluent Cardï¼Œä»…æä¾›â€œæ‰“å¼€ä»£ç â€å…¥å£ã€‚
   - è§£æå™¨ä¸å¾—åœ¨ Raw Mode ä¸Šåšå¤æ‚çš„â€œåå‘æ¢å¤ Fluentâ€å°è¯•ï¼Œä»¥é¿å…å®ç°å¤æ‚åº¦å¤±æ§ã€‚

6. **Ghost Annotation çš„ä½¿ç”¨è¾¹ç•Œ**
   - `@intent-sink` ç­‰å¹½çµæ³¨è§£ä»…ç”¨äºæç«¯åœºæ™¯ï¼ˆä¾‹å¦‚ Sink é€šè¿‡é«˜é˜¶å‡½æ•°åŠ¨æ€ä¼ å…¥ï¼‰ï¼Œä¸åº”æˆä¸ºä¸»æµè·¯å¾„ï¼›
   - å¹³å°å®ç°ä¸Šåº”éµå¾ªï¼š
     - ä¼˜å…ˆä¾èµ–ç»“æ„åŒ– Fluent é“¾ä¸ `$.use`ï¼›
     - ä»…åœ¨æ— æ³•é™æ€æ¨å¯¼æ—¶è¯»å–æ³¨é‡Šï¼Œå¹¶åœ¨ UI ä¸Šæ˜¾å¼æç¤ºâ€œæ­¤è§„åˆ™ä¾èµ–æ³¨é‡Šï¼Œè¯·è°¨æ…ä¿®æ”¹â€ï¼›
     - è‹¥åç»­ä»£ç è¢«æ”¹å†™ä¸ºæ ‡å‡† Fluent å†™æ³•ï¼Œåº”è‡ªåŠ¨ç§»é™¤æˆ–æ ‡è®°æ³¨é‡Šä¸ºè¿‡æœŸã€‚

7. **ä¸ Runtime çš„å¥‘çº¦å¯¹é½**
   - å¹³å°å‡è®¾ runtime å¯¹ä»¥ä¸‹çº¦æŸè´Ÿè´£ï¼š
     - StoreHandle æ— è·¨ Store å†™æ¥å£ï¼ˆåªæœ‰ `read/changes/dispatch`ï¼‰ï¼Œä¿è¯ IR ä¸­â€œè°å†™è°â€çš„å…³ç³»å¯é ï¼›
     - Fluent é“¾åœ¨è¿è¡Œæ—¶ç­‰ä»·äº Flow/Effect ç»„åˆï¼Œä¸ä¼šå¼•å…¥é¢å¤–çš„éšå½¢æ§åˆ¶æµã€‚
   - è‹¥å®ç°ä¸­éœ€è¦çªç ´ä¸Šè¿°çº¦æŸï¼ˆä¾‹å¦‚æ–°å¢æ–°çš„ `when*` å˜ç§ï¼‰ï¼Œå¿…é¡»åŒæ­¥æ›´æ–°ï¼š
     - `v3/06-codegen-and-parser.md`ï¼ˆè§£æè§„åˆ™ï¼‰ï¼›
     - `runtime-logix/core/03-logic-and-flow.md`ï¼ˆBound API å¥‘çº¦ï¼‰ï¼›
     - æœ¬ READMEï¼ˆå¹³å°å®ç°å¤‡å¿˜ï¼‰ã€‚

ä»¥ä¸Šæ¡ç›®æ—¨åœ¨ä¿è¯ï¼š**åªè¦ä¸šåŠ¡ä»£ç éµå®ˆ Fluent DSL çš„å†™æ³•ï¼Œå¹³å°å°±èƒ½åœ¨å¯æ§å¤æ‚åº¦ä¸‹æä¾›ç¨³å®šçš„ Graph â†” Code åŒå‘åŒæ­¥ï¼›ä¸€æ—¦ä¸šåŠ¡è„±ç¦»è¿™å¥—å†™æ³•ï¼Œå¹³å°åˆ™æœ‰æ¸…æ™°çš„é™çº§ç­–ç•¥ï¼Œè€Œä¸ä¼šâ€œåŠæ‡‚åŠä¸æ‡‚â€ã€‚**
</file>

<file path="intent-driven-ai-coding/v3/platform/agent-orchestration.md">
---
title: Agent é›†æˆä¸ç¼–æ’è§„åˆ’ (Agent Integration & Orchestration)
status: draft
version: v3-code-first
---

> æœ¬æ–‡æ˜¯ `v3/06-codegen-and-parser.md` çš„ **Agent è§†è§’è¡¥ç¯‡**ï¼Œä¸å¼•å…¥æ–°çš„è¿è¡Œæ—¶ APIï¼Œ
> ä»…ä»ã€ŒLLM / Agent å¦‚ä½•ä¸ Logix v3 åä½œã€è§’åº¦ï¼Œå¯¹æ—¢æœ‰è§„èŒƒåšçº¦æŸä¸å±•å¼€ã€‚

æ ¸å¿ƒåŸåˆ™å¯ä»¥æ¦‚æ‹¬ä¸ºä¸€å¥è¯ï¼š

> **å…ˆç«‹æ³•ï¼ˆç±»å‹ä¸æ–‡æ¡£ï¼‰ï¼Œåæ‰§æ³•ï¼ˆParserï¼‰ï¼Œæœ€åä¸Šå²—ï¼ˆAgentï¼‰ã€‚**
> Bound API (`$`) + Fluent DSL + IntentRule IR æ˜¯å”¯ä¸€äº‹å®æºï¼ŒAgent åªæ˜¯ç†Ÿè¯»æ‰‹å†Œçš„è™šæ‹Ÿå·¥ç¨‹å¸ˆã€‚

## 1. è§’è‰²ä¸ç›®æ ‡ï¼šAgent ä¸æ˜¯ Chatbot

- è§’è‰²å®šä½ï¼š**Logic Pilot** â€”â€” åœ¨å•ä¸ª Logic æ–‡ä»¶ / Module ä¸Šï¼ŒåŸºäº Bound API (`$`) ç¼–æ’ä¸šåŠ¡é€»è¾‘ã€‚
- æ“ä½œå¯¹è±¡ï¼šä¸æ“ä½œ JSON é…ç½®ï¼Œè€Œæ˜¯ç›´æ¥ç¼–è¾‘ TypeScript ä»£ç ï¼ˆ`Module.logic(($)=>...)` å†…éƒ¨ï¼‰ï¼Œä½¿ç”¨ `$.onState` / `$.onAction` / `$.on` / `$.state` / `$.actions` / `$.use` / `$.match`ã€‚
- ä¸Šä¸‹æ–‡æ¥æºï¼šAgent çš„â€œä¸–ç•Œè§‚â€æ¥è‡ªç±»å‹ä¸ ASTï¼š
  - ç±»å‹å±‚ï¼š`logix-v3-core.ts`ï¼ˆBound API / Flow / Control / Coordinator ç±»å‹è‰æ¡ˆï¼‰ï¼›
  - æ–‡æ¡£å±‚ï¼š`runtime-logix/core/03-logic-and-flow.md`ã€`06-codegen-and-parser.md`ï¼›
  - ä»£ç å±‚ï¼šå½“å‰ Logic æ–‡ä»¶ä¸å¾®è§‚æ²™ç®±ä¸­çš„ Schemas / Spec / IntentRule ç‰‡æ®µã€‚
- ç›®æ ‡ï¼šåœ¨ **ä¿è¯ç±»å‹ä¸ IR æ­£ç¡®æ€§** çš„å‰æä¸‹ï¼Œå°½é‡ä½¿ç”¨ Fluent ç™½ç›’å­é›†è¡¨è¾¾é€»è¾‘ï¼Œä½¿å¹³å°å¯ä»¥ç¨³å®šè¿˜åŸ IntentRule ä¸ Logic Graphã€‚

## 2. äº”ç§æŠ€èƒ½ï¼šBound API ä½œä¸ºè®¤çŸ¥æ¨¡å‹

åœ¨ Agent è§†è§’ä¸‹ï¼ŒBound API (`$`) ä¸æ˜¯æ™®é€šå·¥å…·é›†ï¼Œè€Œæ˜¯ä¸€å¥—ã€Œæ€ç»´æŠ€èƒ½ã€ï¼š

1. **æ„ŸçŸ¥ (Perception) â†’ `$.flow` / `$.onState` / `$.onAction` / `$.on`**
   - è´Ÿè´£å›ç­”ï¼šâ€œ**ä»€ä¹ˆæ—¶å€™è§¦å‘ï¼Ÿ**â€
   - å…¸å‹æ˜ å°„ï¼š
    - â€œç›‘å¬æœ¬åœ° State å˜åŒ–â€ â†’ `$.onState(selector)`ï¼ˆè¯­ä¹‰ç­‰ä»·äº `$.flow.fromState`ï¼‰ï¼›
    - â€œç›‘å¬æœ¬åœ° Actionâ€ â†’ `$.onAction(predicate)`ï¼ˆè¯­ä¹‰ç­‰ä»·äº `$.flow.fromAction`ï¼‰ï¼›
     - "ç›‘å¬è·¨ Store / å¤–éƒ¨æµ" â†’ `$.on(stream)`ï¼Œå¸¸è§å†™æ³•æ˜¯ `$.on($Other.changes(...))`ã€‚

2. **ç­–ç•¥ (Strategy) â†’ Pipeline Operators / `$.flow`**
   - è´Ÿè´£å›ç­”ï¼šâ€œ**ä¿¡å·å¦‚ä½•æµåŠ¨ï¼Ÿ**â€
   - å…¸å‹æ˜ å°„ï¼š
     - â€œé˜²æŠ–â€ â†’ `.debounce(ms)`ï¼›
     - â€œèŠ‚æµâ€ â†’ `.throttle(ms)`ï¼›
     - â€œè¿‡æ»¤â€ â†’ `.filter(predicate)`ï¼›
     - â€œå¹¶å‘ç­–ç•¥â€ â†’ `{ mode: "run" | "latest" | "exhaust" | "sequence" }` æˆ–å¯¹åº” `Flow.run*` å˜ä½“ã€‚

3. **è¡ŒåŠ¨ (Actuation) â†’ `$.state` / `$.actions`**
   - è´Ÿè´£å›ç­”ï¼šâ€œ**æœ€åä½œç”¨åœ¨å“ªï¼Ÿ**â€
   - å…¸å‹æ˜ å°„ï¼š
     - â€œä¿®æ”¹å½“å‰ Store çŠ¶æ€â€ â†’ `$.state.mutate(draft => { ... })` / `$.state.update(prev => next)`ï¼›
     - â€œæ´¾å‘ Actionâ€ â†’ `$.actions.dispatch(action)`ã€‚

4. **åä½œ (Collaboration) â†’ `$.use`**
   - è´Ÿè´£å›ç­”ï¼šâ€œ**éœ€è¦è°çš„å¸®åŠ©ï¼Ÿ**â€
   - å…¸å‹æ˜ å°„ï¼š
     - â€œè¯»å–å…¶ä»– Store çš„çŠ¶æ€/å˜åŒ–â€ â†’ `const $Other = yield* $.use(OtherSpec)`ï¼›
     - â€œè°ƒç”¨ Serviceâ€ â†’ `const api = yield* $.use(ApiServiceTag)`ã€‚

5. **ç»“æ„ (Structure) â†’ `$.match` / `Effect.*`**
   - **æ„å›¾**ï¼šè¡¨è¾¾åˆ†æ”¯ã€é”™è¯¯å¤„ç†ã€å¹¶å‘ç­‰ç»“æ„åŒ–é€»è¾‘ã€‚
   - **æ˜ å°„**ï¼š
     - æ¡ä»¶åˆ†æ”¯ â†’ `$.match(val).when(...).exhaustive()`ï¼›
     - é”™è¯¯è¾¹ç•Œ â†’ `Effect.catchAll(...)`ï¼›
     - å¹¶è¡Œæ‰§è¡Œ â†’ `Effect.all([...])`ã€‚

> Agent è§†è§’ä¸‹ï¼Œè¿™äº”ä¸ªæŠ€èƒ½æ˜¯ç­‰ä»·çš„ä¸€ç­‰å…¬æ°‘ï¼š
> **ä¸è¦åªä¼šå†™ `$.onState` / `$.onAction` / `$.on` å’Œ `$.state`ï¼Œå´æŠŠæ‰€æœ‰ç»“æ„å±‚é€»è¾‘åŸ‹åœ¨è£¸ `if/else` å’Œ `try/catch` é‡Œã€‚**

> ä¸ runtime-logix v3 çš„å¯¹é½è¯´æ˜ï¼šè¿™é‡Œçš„â€œæ„ŸçŸ¥/ç­–ç•¥/è¡ŒåŠ¨â€ç­‰æŠ€èƒ½ï¼Œæ­£å¥½å¯¹åº” Bound API `$` å†…éƒ¨çš„å‡ ä¸ªå­åŸŸâ€”â€”`$.on*` è´Ÿè´£æ„ŸçŸ¥ (Perception)ã€`$.flow.*` è´Ÿè´£ç­–ç•¥ (Strategyï¼Œæ—¶é—´è½´ä¸å¹¶å‘)ã€`$.state / $.actions` è´Ÿè´£è¡ŒåŠ¨ (Actuation)ã€`$.use` ä¸ `$.match` åˆ†åˆ«æ‰¿æ‹…åä½œä¸ç»“æ„å±‚èŒè´£ã€‚Agent åœ¨å†™ä»£ç æ—¶åº”å§‹ç»ˆæ²¿ç€è¿™æ¡é“¾è·¯æ€è€ƒï¼Œè€Œä¸æ˜¯æŠŠå®ƒä»¬å½“æˆä¸‰å¥—å‰²è£‚çš„ APIã€‚

## 3. Fluent ç™½ç›’å­é›†ä¸ Effect çº¯åº¦ï¼ˆç¡¬çº¦æŸï¼‰

Agent è¾“å‡ºçš„ä»£ç å¿…é¡»éµå®ˆ v3 å·²ç»ç¡®å®šçš„â€œç™½ç›’å­é›†â€å’Œ Effect çº¦å®šã€‚è¿åè¿™äº›çº¦æŸï¼ŒParser å°†ç›´æ¥æ‹’ç»ç”Ÿæˆ IntentRuleï¼š

1. **Fluent é“¾å½¢æ€ï¼ˆç™½ç›’å­é›†ï¼‰**
   - ä»…ä»¥ä¸‹å½¢æ€è¢«è§†ä¸ºç™½ç›’ Fluent é“¾ï¼Œå¹¶è¢« Parser è¿˜åŸä¸º IntentRuleï¼š
    - `yield* $.onState(selector).op1().op2().then(effect, opts?)`
    - `yield* $.onAction(predicate).op().then(effect, opts?)`
     - `yield* $.on(streamExpr).op().then(effect, opts?)`
   - çº¦æŸï¼š
     - é“¾å¿…é¡»å†™åœ¨**å•æ¡ `yield*` è¯­å¥**ä¸­ï¼Œä¸å¾—æ‹†æˆä¸­é—´å˜é‡ï¼š
      - âœ… `yield* $.onState(...).debounce(300).then(...);`
      - âŒ `const flow = $.onState(...).debounce(300); yield* flow.then(...);`ï¼ˆParser è§†ä¸º Raw Blockï¼‰ã€‚
     - ä¸­é—´ç®—å­å¿…é¡»æ¥è‡ªå—æ”¯æŒå­é›†ï¼š`debounce` / `throttle` / `filter` ç­‰ï¼Œåç»­å¯æ‰©å±•ï¼Œä½† Agent ä¸å¾—æ“…è‡ªåˆ›é€ æ–°ç®—å­åã€‚

2. **Effect çº¯åº¦ï¼šç¦æ­¢åœ¨ Logic ä¸­ä½¿ç”¨ async/await**
   - Logic ä¸ Handler å†…éƒ¨ä¸å¾—ç›´æ¥ä½¿ç”¨ `async/await` æˆ–è¿”å› Promise çš„å‡½æ•°ï¼š
     - `then` çš„ç¬¬ä¸€ä¸ªå‚æ•°å¿…é¡»æ˜¯ `Effect.Effect`ï¼ˆé€šå¸¸ç”± `Effect.gen(function*(){ ... })` æ„é€ ï¼‰ï¼Œä¸å¾—æ˜¯ `async () => { ... }`ã€‚
     - è‹¥éœ€è¦è°ƒç”¨ Promise APIï¼Œåº”è§†ä¸º Service å°è£…é—®é¢˜ï¼šç”±äººç±»/å¹³å°åœ¨ Service å±‚ä½¿ç”¨ `Effect.tryPromise` / `Effect.promise` åŒ…è£¹ï¼›Agent åªè°ƒç”¨ `yield* api.method(...)`ã€‚
   - Parser åœ¨é‡åˆ° `async` å½¢å¼çš„ Handler æ—¶ï¼Œåº”å½“è¿”å› `ERR_ASYNC_HANDLER`ï¼Œå¹¶æç¤º Agent æ”¹å†™ä¸º `Effect.gen + yield*` å½¢å¼ã€‚

3. **IR-firstï¼šä¼˜å…ˆä½¿ç”¨ Fluent å­é›†è¡¨è¾¾ IntentRule**
   - Agent çš„é¦–è¦ç›®æ ‡ä¸æ˜¯â€œå†™å‡ºä»»ä½•èƒ½è·‘çš„ä»£ç â€ï¼Œè€Œæ˜¯**ç”¨ Fluent å­é›†è¡¨è¾¾ IntentRule**ï¼š
     - åœ¨ä¿è¯ç±»å‹ä¸ä¸šåŠ¡è¯­ä¹‰æ­£ç¡®çš„å‰æä¸‹ï¼Œåº”ä¼˜å…ˆé€‰æ‹© `$.onState().then(...)` / `$.onAction().then(...)` / `$.on().then(...)` + `$.match` çš„ç»„åˆï¼›
     - åªæœ‰åœ¨éœ€æ±‚ç¡®å®æ— æ³•è½åœ¨ Fluent å­é›†å†…ï¼Œæˆ–ç”¨æˆ·æ˜ç¡®è¦æ±‚â€œEject åˆ°ä»£ç â€æ—¶ï¼Œæ‰å…è®¸ç”Ÿæˆ Raw Blockï¼ˆä¾‹å¦‚ç›´æ¥ç¼–æ’ `Flow.*` / å¤æ‚ `Effect`ï¼‰ã€‚
   - Prompt å±‚æ¨èåŠ å…¥æ˜¾å¼æŒ‡ä»¤ï¼š**â€œé™¤éä¸‡ä¸å¾—å·²ï¼Œä¸è¦å†™ Parser æ— æ³•è¯†åˆ«çš„ç»“æ„ï¼ˆå¦‚æ‹†é“¾/ä»»æ„ `async` handlerï¼‰ã€‚â€**

## 4. æ‰€æœ‰æƒä¸ Eject åè®®ï¼š`@agent-generated`

ä¸ºé¿å… Agent å’Œäººç±»â€œæŠ¢åœ°ç›˜â€ï¼Œéœ€è¦å¯¹ `@agent-generated` ä»£ç å—çš„ä¸»æƒåšæ¸…æ™°çº¦å®šã€‚

### 4.1 çŠ¶æ€æœºï¼ˆç®€åŒ–ç‰ˆï¼‰

ä»¥å•ä¸ª Fluent è§„åˆ™ä¸ºç²’åº¦ï¼Œå¯ä»¥æŠ½è±¡å‡ºä¸‰ç§çŠ¶æ€ï¼š

1. **Agent æ§åˆ¶ï¼ˆAgent-ownedï¼‰**
   - ä»£ç å—å¸¦æœ‰ `@agent-generated` æ ‡è®°ï¼Œä¸”ä»ç„¶æ˜¯åˆæ³•çš„ Fluent é“¾ï¼š
    `yield* $.onState(...).op().then(Effect.gen(...))`ã€‚
   - è§†ä¸ºç”± Agent è´Ÿè´£ç»´æŠ¤çš„å—æ§åŒºåŸŸï¼šå¹³å°å…è®¸ Agent åœ¨å…¶ä¸Šåšç»“æ„åŒ–ä¿®æ”¹ï¼ˆè°ƒæ•´ debounce æ—¶é—´ã€åˆ‡æ¢å¹¶å‘æ¨¡å¼ç­‰ï¼‰ã€‚

2. **äººç±»å¾®è°ƒä½†ä»åœ¨ç™½ç›’å­é›†å†…ï¼ˆCo-ownedï¼‰**
   - äººç±»å¯¹ `@agent-generated` åŒºåŸŸè¿›è¡Œäº†ä¿®æ”¹ï¼Œä½† Parser ä»èƒ½è¯†åˆ«ä¸ºåˆæ³• Fluent é“¾ã€‚
   - è¡Œä¸ºï¼š
     - `@agent-generated` æ ‡è®°ä¿ç•™ï¼›
     - åç»­ Agent ä¿®æ”¹å¿…é¡»ä»¥**å½“å‰ AST** ä¸ºå”¯ä¸€äº‹å®æºï¼Œä¸å¾—å‡­å†å²å¿«ç…§è¦†ç›–äººç±»ä¿®æ”¹ï¼›
     - å…è®¸ Agent åœ¨é“¾æ¡ç»“æ„ä¸å˜çš„å‰æä¸‹åšå¢é‡ä¿®æ”¹ï¼ˆå¦‚è°ƒæ•´å‚æ•°ã€å¡«å…… handler å†…éƒ¨é€»è¾‘ï¼‰ã€‚

3. **å·²è¢« Eject çš„ Raw Blockï¼ˆEjectedï¼‰**
   - ä»»ä¸€æ¡ä»¶æ»¡è¶³æ—¶è§†ä¸ºå·² Ejectï¼š
     - Fluent é“¾è¢«æ‹†æˆå˜é‡ / åŠ¨æ€ç»„åˆï¼ŒParser æ— æ³•è¿˜åŸ R-S-T ç»“æ„ï¼›
     - è¡Œå†…æ··å…¥å¤§é‡è£¸ `if/else` / `try/catch` / ä»»æ„æ§åˆ¶ç»“æ„ï¼Œå¤±å»å¯è§†åŒ–è¾¹ç•Œï¼›
     - å¼€å‘è€…æ˜¾å¼ç§»é™¤ `@agent-generated` æ³¨é‡Šã€‚
   - è¡Œä¸ºï¼š
     - å¹³å°åœ¨è§£ææ—¶è‡ªåŠ¨ç§»é™¤ `@agent-generated` æ ‡è®°ï¼Œå¹¶å°†è¯¥æ®µè§†ä¸º Raw Blockï¼›
     - Agent ä¸å†å¯¹è¯¥åŒºåŸŸåšâ€œç»“æ„åŒ–ç»´æŠ¤â€ï¼Œåªèƒ½ç»™å‡º**éå¼ºåˆ¶æ€§çš„å»ºè®®**ï¼ˆä¾‹å¦‚è¯„è®º/é‡æ„å»ºè®®ï¼‰ï¼Œä¸å¾—é™é»˜è¦†ç›–æ•´æ®µå®ç°ã€‚

### 4.2 Agent è¡Œä¸ºçº¦æŸ

ä» Agent ä¾§çœ‹ï¼Œå¿…é¡»éµå®ˆçš„åº•çº¿ï¼š

- ä¸å¾—åœ¨ç”¨æˆ·æœªæ˜ç¡®åŒæ„çš„æƒ…å†µä¸‹ï¼Œé‡å†™å·² Eject çš„ Raw Blockï¼›
- åœ¨ Co-owned åŒºåŸŸï¼Œåªèƒ½åŸºäºå½“å‰ä»£ç åšå¢é‡ä¿®æ”¹ï¼Œç¦æ­¢ç”¨â€œé‡å†™æ•´ä¸ªå‡½æ•°â€çš„æ–¹å¼è¦†ç›–äººç±»é€»è¾‘ï¼›
- å¦‚å‘ç° Fluent é“¾å·²ç»è„±ç¦»ç™½ç›’å­é›†ï¼Œåº”ä¸»åŠ¨æé†’â€œæ­¤è§„åˆ™å·² Ejectï¼Œæ— æ³•å†è¿›è¡Œç»“æ„åŒ–ç¼–è¾‘â€ï¼Œå¹¶å»ºè®®ç”¨æˆ·æ¢å¤ Fluent å†™æ³•æˆ–æ¥å— Raw æ¨¡å¼ã€‚

## 5. å¾®è§‚æ²™ç®±ï¼šæœ€å°ç‰¹æƒä¸Šä¸‹æ–‡

ä¸ºäº†é™ä½å¹»è§‰å’Œè¯¯ç”¨ä¾èµ–çš„é£é™©ï¼Œå¹³å°å‘ Agent æ³¨å…¥çš„ä¸Šä¸‹æ–‡å¿…é¡»éµå®ˆ**æœ€å°ç‰¹æƒåŸåˆ™**ã€‚

### 5.1 å¿…é¡»æ³¨å…¥çš„å†…å®¹

é’ˆå¯¹å•ä¸ª Logic æ–‡ä»¶ï¼ˆé€šå¸¸å¯¹åº”æŸä¸ª `Module.logic(($)=>...)`ï¼‰ï¼š

- å½“å‰ Module çš„å®šä¹‰ä¸ Schema æŠ•å½±ï¼š
  - Module æ ‡è¯†ï¼ˆIdï¼‰ã€State/Action Schema ç‰‡æ®µï¼ˆå­—æ®µåä¸ç±»å‹ï¼Œè€Œéå…¨éƒ¨å®ç°ï¼‰ï¼›
  - å·²å­˜åœ¨çš„ Logic ä»£ç ç‰‡æ®µï¼ˆä¾¿äº Agent åšå¢é‡ä¿®æ”¹ï¼‰ã€‚
- å·²å£°æ˜çš„ä¾èµ–ä¸ä¸€è·³é‚»å±…ï¼š
  - å½“å‰ Logic ä¸­å‡ºç°çš„ `yield* $.use(ModuleOrService)` è°ƒç”¨åˆ—è¡¨ï¼›
  - ä¸è¿™äº› Module / Service åœ¨ IntentRule æ‹“æ‰‘ä¸Šç›´æ¥ç›¸è¿çš„ä¸€è·³é‚»å±…ï¼ˆä¾¿äºå¤„ç†å¸¸è§ L2 åä½œï¼‰ã€‚
- Bound API ä¸ Fluent å­é›†è¯´æ˜ï¼š
  - `$` çš„ç±»å‹ç­¾åç‰‡æ®µï¼š`state` / `actions` / `flow` / `control` / `use` ç­‰æ–¹æ³•åç§°ä¸å‚æ•°å½¢çŠ¶ï¼›
  - 1â€“2 ä¸ªå®˜æ–¹ Fluent ç¤ºä¾‹ï¼Œä½œä¸ºé£æ ¼ä¸çº¦æŸçš„ç¤ºä¾‹ä»£ç ã€‚

### 5.2 æ˜ç¡®ç¦æ­¢æ³¨å…¥çš„å†…å®¹

- ä¸å½“å‰ Logic åœ¨ Module / IR ä¸Š**æ— ç›´æ¥å…³ç³»**çš„å…¶ä»–ä¸šåŠ¡åŸŸ Module / Serviceï¼›
- å¤§ä½“é‡å®ç°ç»†èŠ‚ï¼šå®Œæ•´ Service å®ç°ã€é•¿ç®—æ³•ã€éæœ¬åœºæ™¯çš„ Logic æ–‡ä»¶ï¼›
- Runtime å†…æ ¸ç»†èŠ‚ï¼šTag / Context / Layer ç»„åˆå®ç°ç­‰ï¼ˆå¯¹ Agent æ¥è¯´è§†ä¸ºé»‘ç›’ï¼‰ã€‚

> Agent ä¾§é¢å¤–çº¦æŸï¼š
> åªèƒ½å¯¹ã€ŒAvailable Stores/Servicesã€åˆ—è¡¨ä¸­çš„å®ä½“è°ƒç”¨ `$.use`ï¼Œä¸å¾—å‡­ç©ºåˆ›é€ æ–°çš„åç§°ï¼›
> å¦‚éœ€è¦èƒ½åŠ›ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œåº”æŠ¥å‘Šâ€œå½“å‰æ²™ç®±ä¸å¯ç”¨â€ï¼Œè€Œä¸æ˜¯ç¼–é€ æ¨¡å—ã€‚

## 6. Parserï¼šæ‰§æ³•è€…ä¸åé¦ˆå¾ªç¯

Parser æ˜¯ Code-First è·¯å¾„ä¸‹çš„â€œæ‰§æ³•è€…â€ï¼Œè´Ÿè´£åœ¨ç±»å‹ä¸ AST å±‚é¢æ‰§è¡Œä¸Šè¿°çº¦æŸï¼Œå¹¶ä¸º Agent æä¾›ç»“æ„åŒ–åé¦ˆã€‚

### 6.1 èŒè´£ä¸è¾“å…¥è¾“å‡º

- è¾“å…¥ï¼š
  - å•ä¸ª Logic æ–‡ä»¶çš„ TypeScript æ–‡æœ¬ï¼ˆæˆ– ASTï¼‰ï¼›
  - å¯é€‰ï¼šå¯¹åº”çš„ IntentRule / Spec å…ƒä¿¡æ¯ï¼Œç”¨äºéªŒè¯ä¸Šä¸‹æ–‡ä¸€è‡´æ€§ã€‚
- è¡Œä¸ºï¼š
  - æ‰«æ `yield* $.onState(...) / $.onAction(...) / $.on(stream)...` å½¢æ€çš„ Fluent é“¾ï¼›
  - å°è¯•å°†å…¶è¿˜åŸä¸º `{ source, pipeline, sink }` ç»“æ„çš„ IntentRuleï¼›
  - è¯†åˆ«å¸¸è§è¿è§„æ¨¡å¼å¹¶ç»™å‡ºé”™è¯¯ç ï¼ˆä¾‹å¦‚ `ERR_ASYNC_HANDLER` / `ERR_SPLIT_CHAIN` / `ERR_UNSUPPORTED_OP`ï¼‰ã€‚
- è¾“å‡ºï¼š
  - æˆåŠŸï¼š`{ rules: IntentRule[], errors: [] }`ï¼Œæ¯æ¡è§„åˆ™é™„å¸¦ä½ç½®ä¸ç®€è¦è¯´æ˜ï¼›
  - å¤±è´¥ï¼š`{ rules: PartialIntentRule[], errors: ParseError[] }`ï¼Œæä¾›è¶³å¤Ÿä¿¡æ¯å¸®åŠ© Agent/äººç±»å®šä½é—®é¢˜ã€‚

> å®ç°å»ºè®®ï¼š
> é¦–ç‰ˆ Parser å¯ä»¥åŸºäº `ts-morph` å®ç°ä¸º CLI å·¥å…·ï¼š
> `pnpm tsx scripts/intent-fluent-parser.ts --file path/to/logic.ts`ï¼Œ
> åªæ”¯æŒæœ€å° Fluent å­é›†ä¸å°‘é‡é”™è¯¯ç å³å¯ï¼Œåç»­å†è¿­ä»£ã€‚

### 6.2 ä¸ Agent çš„äº¤äº’æ¨¡å¼

- åœ¨ Copilot / Agent åœºæ™¯ä¸­ï¼Œä¸€æ¬¡å®Œæ•´çš„äº¤äº’åº”åŒ…å«ï¼š
  1. Agent ç”Ÿæˆ/ä¿®æ”¹ Logic ä»£ç ï¼ˆéµå®ˆæœ¬è¡¥ç¯‡çº¦æŸï¼‰ï¼›
  2. å¹³å°è°ƒç”¨ Parser å¯¹æœ€æ–°ä»£ç åšé™æ€éªŒè¯ï¼›
  3. è‹¥é€šè¿‡ï¼šè¿”å› IntentRule é›†åˆä¸ Graph é¢„è§ˆï¼›
  4. è‹¥å¤±è´¥ï¼šå°†ç»“æ„åŒ–é”™è¯¯ï¼ˆé”™è¯¯ç  + ä½ç½® + ç®€çŸ­è¯´æ˜ï¼‰åé¦ˆç»™ Agentï¼Œè®©å…¶è‡ªæ„ˆä¿®å¤ã€‚
- Parser ä¸è´Ÿè´£â€œæ›¿ç”¨æˆ·æ”¹ä»£ç â€ï¼Œåªè´Ÿè´£åš**åˆ¤å®šä¸è§£é‡Š**ï¼›ä¿®å¤è¡Œä¸ºå§‹ç»ˆç”± Agent æˆ–äººç±»æ‰¿æ‹…ã€‚

## 7. å®æ–½è·¯çº¿å›¾å›é¡¾ï¼ˆPhase 1 â†’ 3ï¼‰

ç»“åˆ v3 å…¶ä»–æ–‡æ¡£ï¼Œæœ¬è¡¥ç¯‡æ¨èçš„å®æ–½é¡ºåºæ˜¯ï¼š

1. **Phase 1ï¼šIDE Copilotï¼ˆHeadlessï¼‰**
   - ä»¥å•æ–‡ä»¶ Copilot ä¸ºä¸»ï¼ŒéªŒè¯ Bound API å¯¹ LLM çš„å‹å¥½åº¦ï¼›
   - å…³é”®æŒ‡æ ‡ï¼š`Pass@1`ï¼ˆTSC + Parser åŒæ—¶é€šè¿‡çš„æ¯”ä¾‹ï¼‰ä¸ Fluent ç™½ç›’è¦†ç›–ç‡ã€‚

2. **Phase 2ï¼šCanvas Orchestratorï¼ˆGalaxy View é›†æˆï¼‰**
   - åœ¨ Galaxy View ä¸­æŒ‚è½½ Agentï¼Œå…è®¸ç”¨æˆ·å¯¹å•æ¡è§„åˆ™å‘èµ·è‡ªç„¶è¯­è¨€ä¿®æ”¹è¯·æ±‚ï¼›
   - Agent åŸºäº AST + IntentRule åšå±€éƒ¨ patchï¼ŒParser æ ¡éªŒåæ›´æ–° Graphï¼›
   - Eject / Raw Block åªæä¾›â€œè·³è½¬ä»£ç â€å’Œâ€œEject åˆ°ä»£ç â€çš„äº¤äº’ï¼Œä¸æä¾›å¯è§†åŒ–ç¼–è¾‘ã€‚

3. **Phase 3ï¼šSemantic Refactoringï¼ˆè¯­ä¹‰çº§é‡æ„ï¼‰**
   - Agent åœ¨ IR / Module / æ‹“æ‰‘å±‚é¢è§„åˆ’é‡æ„ï¼ˆä¾‹å¦‚æ‹† Module / æŠ½ Patternï¼‰ï¼Œå†ä¸‹æ²‰åˆ°å…·ä½“ä»£ç  patchï¼›
   - å¿…é¡»ä¾æ‰˜ IntentRule æ‹“æ‰‘ä¸ Module å…³ç³»ï¼Œè€Œä¸æ˜¯çº¯æ–‡æœ¬/AST é‡å†™ï¼›
   - å…³é”®æŒ‡æ ‡ï¼šå…¸å‹ä¸šåŠ¡ Flow çš„å›å½’è„šæœ¬é€šè¿‡ç‡ä¸ Graph æ‹“æ‰‘ç¨³å®šæ€§ã€‚

é€šè¿‡ä»¥ä¸Šâ€œç«‹æ³• â†’ æ‰§æ³• â†’ ä¸Šå²—â€çš„è·¯å¾„ï¼Œå¯ä»¥ä¿è¯ï¼š

- å¯¹äººç±»å¼€å‘è€…ï¼šå§‹ç»ˆå¯ä»¥åœ¨ç±»å‹ä¸æ–‡æ¡£å±‚æ¸…æ™°ç†è§£ Agent çš„æƒé™ä¸è¡Œä¸ºè¾¹ç•Œï¼›
- å¯¹å¹³å°ï¼šParser ä¸ IntentRule æˆä¸ºç»Ÿä¸€äº‹å®æºï¼Œä¸è¢« Agent çš„å®ç°ç»†èŠ‚ç‰µç€èµ°ï¼›
- å¯¹ Agentï¼šæ‹¥æœ‰æ¸…æ™°çš„äº”ç§æŠ€èƒ½ä¸å†™ä½œå­é›†ï¼Œä¸å¿…çŒœæµ‹å“ªäº›å†™æ³•æ˜¯â€œå¹³å°å¯æ¥å—çš„â€ã€‚
</file>

<file path="intent-driven-ai-coding/v3/platform/README.md">
# Platform Â· Intent & UX Planning (Draft)

> **Status**: Draft
> **Scope**: å¹³å°ä¾§å›´ç»•ã€Œä¸šåŠ¡æ„å›¾ â†’ è§„åˆ™ IR â†’ ä»£ç  / Runtimeã€çš„æ•´ä½“äº¤äº’è§„åˆ’ã€‚
> **Goal**: ä¸ºåç»­æ›´ç»†åŒ–çš„äº§å“éœ€æ±‚ä¸äº¤äº’ç¨¿æä¾›ç»Ÿä¸€éª¨æ¶ï¼ˆç›®å½•çº§è§„åˆ’ï¼‰ï¼Œé¿å… Intent å±‚è®¾è®¡å’Œå¹³å°ä½“éªŒè„±èŠ‚ã€‚

æœ¬ç›®å½•ç”¨äºæ²‰æ·€ã€Œå¹³å°è§†è§’ã€ä¸‹çš„è§„åˆ’ï¼š
- äº§å“ / è®¾è®¡ / æ¶æ„ / å¼€å‘ å¦‚ä½•åœ¨åŒä¸€å¥— **æ„å›¾æ¨¡å‹** ä¸Šåä½œï¼›
- ç”»å¸ƒ / åˆ—è¡¨ / è¡¨å• / è°ƒè¯•è§†å›¾ å¦‚ä½•æ‰¿è½½ `IntentRule` ä¸ L1/L2/L3 APIï¼›
- å¦‚ä½•è®©æœªæ¥çš„ LLM / Agent åœ¨å¹³å°ä¸Šä¸äººååŒç¼–æ’ä¸šåŠ¡é€»è¾‘ã€‚

## 1. æ ¸å¿ƒå…±è¯†å›é¡¾ï¼ˆR-S-T + L1/L2/L3 + IntentRuleï¼‰

å¹³å° / Runtime / ä»£ç ä¸‰ç«¯å…±åŒéµå¾ªçš„ç»Ÿä¸€æ¨¡å‹ï¼š

- **R-S-T é“¾è·¯**ï¼šä»»ä½•è”åŠ¨éƒ½æŠ½è±¡ä¸ºä¸€æ¡ `Source --Strategy--> Target` çš„å“åº”å¼é“¾è·¯ï¼š
  - Sourceï¼šäº‹ä»¶ä»å“ªé‡Œæ¥ï¼Ÿï¼ˆState è§†å›¾ / Action / Externalï¼‰
  - Strategyï¼šå¦‚ä½•æµåŠ¨ï¼Ÿï¼ˆè¿‡æ»¤ã€é˜²æŠ–ã€å¹¶å‘ã€é”™è¯¯ã€Scopeï¼‰
  - Targetï¼šæœ€åä½œç”¨åœ¨å“ªï¼Ÿï¼ˆæœ¬ Store çŠ¶æ€ã€æœ¬/ä»– Store Actionã€Service è°ƒç”¨ç­‰ï¼‰

-- **IntentRuleï¼ˆIRï¼‰**ï¼šå¹³å°ä¾§çš„ç»Ÿä¸€è§„åˆ™è¡¨ç¤ºï¼ˆè¯¦è§ `runtime-logix/core/06-platform-integration.md`ï¼‰ï¼š
  - `source`: `{ context, type, selector }`
  - `pipeline`: `[{ op, args }]`
  - `sink`: `{ context, type, handler }`
  ä»£ç ä¸­çš„ **Fluent DSLï¼ˆ`$.onState` / `$.onAction` / `$.on(stream)`ï¼‰** ä¼šè¢«è§£æä¸º IntentRuleï¼›ä¸åŒ L1/L2 è§„åˆ™å½¢æ€ä»…é€šè¿‡ IntentRule çš„å­—æ®µï¼ˆä¾‹å¦‚ kind/context/typeï¼‰åŒºåˆ†ï¼Œä¸å†ä¾èµ–è¿è¡Œæ—¶ `Intent.*` å‘½åç©ºé—´ã€‚

- **L1 / L2 / L3 åˆ†å±‚ APIï¼ˆä»£ç è§†å›¾ï¼‰**ï¼š
  - L1ï¼šå• Store å†…åŒæ­¥è”åŠ¨ â€”â€” ä»£ç ä¾§æ¨èç”¨ `$.onState / $.onAction` + `$.state.mutate/update` è¡¨è¾¾ï¼›åœ¨ IR ä¸­å¯¹åº” L1 IntentRuleï¼ˆself.state/self.action â†’ self.mutateï¼‰ï¼›
  - L2ï¼šè·¨ Store åä½œ â€”â€” ä»£ç ä¾§æ¨èç”¨ `$.use(StoreSpec)` è·å– StoreHandle + `$.on($Other.changes/â€¦ ).then($SelfOrOther.dispatch)` è¡¨è¾¾ï¼›åœ¨ IR ä¸­å¯¹åº” L2 IntentRuleï¼ˆA.state/A.action â†’ B.dispatchï¼‰ï¼›
  - L3ï¼šFlow/Stream/Effect â€”â€” æåº¦å®šåˆ¶åŒ–é€»è¾‘çš„é€ƒé€¸å£ï¼Œå¹³å°ä»…éƒ¨åˆ†å¯è§†åŒ–æˆ–é™çº§ä¸º Code Blockã€‚

æœ¬ç›®å½•åç»­æ‰€æœ‰å¹³å°äº¤äº’è®¾è®¡ï¼Œéƒ½é»˜è®¤å»ºç«‹åœ¨è¿™å¥—æ¨¡å‹ä¹‹ä¸Šï¼š

> ç”»å¸ƒ / è¡¨å• / åˆ—è¡¨ æ“ä½œçš„æ˜¯ä¸šåŠ¡è¯­ä¹‰ â†’ æ˜ å°„ä¸º `IntentRule` â†’ å†ç”±ç”Ÿæˆå™¨è½åˆ° Fluent ä»£ç ï¼ˆ`$.onState` / `$.onAction` / `$.on` + `$.state/dispatch`ï¼‰/ Flow / Pattern ä¸Šã€‚

## 2. å¹³å°é¡¶å±‚æ¨¡å—ï¼ˆè§†è§’ä¸èŒè´£ï¼‰

ç»“åˆç°æœ‰ v3 æ–‡æ¡£ï¼ˆ`06-platform-ui-and-interactions.md` ç­‰ï¼‰ï¼Œå¹³å° UI è§„åˆ’åˆæ­¥æ‹†ä¸ºä»¥ä¸‹å‡ å¤§æ¨¡å—ï¼ˆä¹‹åå¯æ¼”è¿›ä¸ºç‹¬ç«‹æ–‡æ¡£ï¼‰ï¼š

1. **Universe Viewï¼ˆæ¨¡å—æ‹“æ‰‘è§†å›¾ï¼‰**
   - è§†è§’ï¼šä¸šåŠ¡åŸŸ / æ¨¡å—ä¹‹é—´çš„ä¾èµ–æ‹“æ‰‘ã€‚
   - ç›®æ ‡ç”¨æˆ·ï¼šäº§å“ã€æ¶æ„ã€‚
   - æ ¸å¿ƒèƒ½åŠ›ï¼š
     - å±•ç¤ºä¸šåŠ¡åŸŸã€æ¨¡å—ã€è·¨æ¨¡å—ä¾èµ–ï¼ˆå¯ç”± IntentRule èšåˆå¾—åˆ°ï¼‰ã€‚
     - æ”¯æŒä»æ¨¡å—èŠ‚ç‚¹ Drill-down åˆ° Logic/Intent ç¼–æ’è§†å›¾ã€‚
     - é«˜äº®â€œå¾ªç¯ä¾èµ–æ¨¡å—â€â€œè·¨åŸŸè¿‡å¤šè”åŠ¨â€ç­‰æ²»ç†ä¿¡å·ã€‚

2. **Galaxy Viewï¼ˆLogic & Intent ç¼–æ’ç”»å¸ƒï¼‰**
   - è§†è§’ï¼šå•ä¸ª Logic Module å†…çš„ Pattern / Store / è§„åˆ™ç¼–æ’ã€‚
   - ç›®æ ‡ç”¨æˆ·ï¼šPMã€èµ„æ·±å‰ç«¯ã€æ¶æ„å¸ˆã€‚
   - æ ¸å¿ƒèƒ½åŠ›ï¼š
     - æŠŠ Store / Pattern / Service ä»£ç†èŠ‚ç‚¹ä¸ UI Trigger è¿æ¥æˆä¿¡å·æµï¼›
     - æ”¯æŒæ‹–æ‹½ä¸šåŠ¡ç§¯æœ¨ï¼ˆå­—æ®µè”åŠ¨ã€æ¨¡å—è”åŠ¨ã€å®¡æ‰¹æµã€æœç´¢-è¯¦æƒ…ç­‰ï¼‰ï¼Œè‡ªåŠ¨ç”Ÿæˆ/æ›´æ–° IntentRuleï¼›
     - å³ä¾§ Config Panel ç›´æ¥ç¼–è¾‘è§„åˆ™å‚æ•°ï¼ˆæº/ç›®æ ‡/æ¡ä»¶/ç­–ç•¥ï¼‰ï¼Œé©±åŠ¨å¯¹åº” IntentRule çš„å˜æ›´ï¼›
     - ä¸ä»£ç è”åŠ¨ï¼šèŠ‚ç‚¹/è¿çº¿æ”¯æŒã€ŒJump to Codeã€ã€ŒPeek Definitionã€ã€‚

3. **UI & Module Studioï¼ˆå±å¹•ä¸æ•°æ®æ¨¡å‹å·¥ä½œå°ï¼‰**
   - è§†è§’ï¼šé¡µé¢ç»“æ„ã€ç»„ä»¶ã€å­—æ®µä¸äº¤äº’å…¥å£ã€‚
   - ç›®æ ‡ç”¨æˆ·ï¼šäº§å“ã€è®¾è®¡ã€å‰ç«¯ã€‚
   - æ ¸å¿ƒèƒ½åŠ›ï¼š
     - å£°æ˜/ç¼–è¾‘é¡µé¢å¸ƒå±€ä¸ UI Intentï¼ˆå‚ç…§ `07-ui-ux-detailed-specs.md`ï¼‰ï¼›
     - åŸºäº Module Schema ç®¡ç†å­—æ®µã€æ ¡éªŒã€åˆå€¼ï¼›
     - ä¸ºå„ UI äº¤äº’é…ç½® Logic å…¥å£ï¼ˆç»‘å®šåˆ°å…·ä½“ Store / Action / IntentRuleï¼‰ã€‚

4. **Pattern Studioï¼ˆæ¨¡å¼èµ„äº§å·¥ä½œå°ï¼‰**
   - è§†è§’ï¼šPattern ä½œä¸ºå¯å¤ç”¨é€»è¾‘èµ„äº§ã€‚
   - ç›®æ ‡ç”¨æˆ·ï¼šæ¶æ„å¸ˆã€é«˜çº§å¼€å‘ã€‚
   - æ ¸å¿ƒèƒ½åŠ›ï¼š
     - ç¼–å†™ `(input) => Effect` + Config Schema çš„ Pattern ä»£ç ï¼›
     - å®æ—¶é¢„è§ˆ Pattern çš„é…ç½®è¡¨å•ä¸æ¨¡æ‹Ÿæ‰§è¡Œç»“æœï¼›
     - å‘å¸ƒåˆ° Pattern Registryï¼Œä½œä¸º Galaxy View ä¸­çš„ä¸šåŠ¡ç§¯æœ¨ï¼›
-- Pattern å†…éƒ¨å¯ä½¿ç”¨ Fluent DSL / Flow / Control / Serviceï¼Œå¹³å°ä»…éœ€å…³å¿ƒ Pattern çš„è¾“å…¥/è¾“å‡ºå¥‘çº¦ä¸ metaã€‚

5. **IntentRule Explorerï¼ˆè§„åˆ™åˆ—è¡¨è§†å›¾ï¼‰**
   - è§†è§’ï¼šä»¥â€œè§„åˆ™è¡¨â€çš„æ–¹å¼å®¡è§†ä¸€ä¸ªæ¨¡å—/é¡µé¢çš„æ‰€æœ‰è”åŠ¨ã€‚
   - ç›®æ ‡ç”¨æˆ·ï¼šPMã€å¼€å‘ã€æµ‹è¯•ã€‚
   - æ ¸å¿ƒèƒ½åŠ›ï¼š
     - æŒ‰æ¨¡å—/å­—æ®µ/Action åˆ—å‡ºæ‰€æœ‰ IntentRuleï¼›
     - æ”¯æŒæœç´¢/è¿‡æ»¤ï¼ˆä¾‹å¦‚â€œæ‰€æœ‰å½±å“å­—æ®µ X çš„è§„åˆ™â€â€œæ‰€æœ‰è·¨æ¨¡å—è§„åˆ™â€ï¼‰ï¼›
     - è¡Œçº§æ“ä½œè·³è½¬åˆ° Galaxy èŠ‚ç‚¹æˆ–ä»£ç ï¼›
     - ä¸ºæ²»ç†/å®¡è®¡æä¾›åŸºç¡€è§†å›¾ã€‚

6. **Runtime & Debug Viewï¼ˆè¿è¡Œæ—¶è¿½è¸ªä¸è°ƒè¯•ï¼‰**
   - è§†è§’ï¼šè¿è¡Œæ—¶çš„è§¦å‘ã€ä¼ æ’­ä¸çŠ¶æ€å˜åŒ–ã€‚
   - ç›®æ ‡ç”¨æˆ·ï¼šå¼€å‘ã€æµ‹è¯•ã€è¿ç»´ã€PMï¼ˆé—®é¢˜å®šä½ï¼‰ã€‚
   - æ ¸å¿ƒèƒ½åŠ›ï¼š
     - æ—¶é—´çº¿ï¼šæŒ‰æ—¶é—´å±•ç¤º Action/State å˜åŒ–ä¸è§¦å‘çš„ IntentRuleï¼›
     - å› æœå›¾ï¼šä»ä¸€æ¬¡å˜æ›´è¿½æº¯æ•´æ¡ R-S-T é“¾è·¯ï¼›
     - ä¸ Galaxy è”åŠ¨ï¼šä» Trace ç›´æ¥é«˜äº®å¯¹åº”èŠ‚ç‚¹ä¸è§„åˆ™ã€‚

7. **AI Assist / Copilotï¼ˆæ„å›¾çº§åŠ©æ‰‹ï¼‰**
   - è§†è§’ï¼šå›´ç»•å½“å‰ä¸Šä¸‹æ–‡ï¼ˆæ¨¡å—/å±å¹•/è§„åˆ™ï¼‰æä¾›è‡ªç„¶è¯­è¨€è¾…åŠ©ã€‚
   - æ ¸å¿ƒèƒ½åŠ›ï¼š
     - è¯»å–å½“å‰æ¨¡å—çš„ IntentRule é›†åˆä¸ Schemaï¼Œå›ç­”â€œè¿™å—é€»è¾‘åœ¨åšä»€ä¹ˆâ€ï¼›
     - æ ¹æ®è‡ªç„¶è¯­è¨€éœ€æ±‚ç”Ÿæˆ/ä¿®æ”¹ IntentRuleï¼ˆä¾‹å¦‚â€œè¿™é‡ŒåŠ ä¸ª 500ms é˜²æŠ–â€â€œSearch ç»“æœä¸ºç©ºæ—¶é‡ç½® Detailâ€ï¼‰ï¼›
     - ååŠ©åœ¨ Universe/Galaxy/Explorer ä¹‹é—´å¯¼èˆªå’Œåšæ²»ç†å»ºè®®ã€‚

> åç»­å¯ä»¥ä¸ºä¸Šè¿°æ¯ä¸ªæ¨¡å—å•ç‹¬å»ºç«‹æ–‡æ¡£ï¼ˆå¦‚ `platform/universe.md`, `platform/galaxy-intent-canvas.md` ç­‰ï¼‰ï¼Œæœ¬ README ä»…ä½œä¸ºå¹³å°ä¾§è§„åˆ’çš„â€œç´¢å¼•ä¸éª¨æ¶â€ã€‚

## 3. åç»­ç»†åŒ–æ–¹å‘ï¼ˆTODOï¼‰

1. **IntentRule è§†è§’ä¸‹çš„ä¸šåŠ¡ç§¯æœ¨è§„èŒƒ**
   - ä¸ºâ€œå­—æ®µè”åŠ¨å¡ç‰‡ / æ¨¡å—è”åŠ¨è¿çº¿ / Pattern èŠ‚ç‚¹â€ç­‰å®šä¹‰ç»Ÿä¸€çš„é…ç½® Schema ä¸å¯¹åº”çš„ IntentRule æ¨¡æ¿ï¼›
   - æ˜ç¡®å“ªäº›ç§¯æœ¨ä»…ç”Ÿæˆ L1ï¼ˆandUpdate*ï¼‰ï¼Œå“ªäº›ç”Ÿæˆ L2ï¼ˆCoordinateï¼‰ï¼Œå“ªäº›ç”Ÿæˆ L2/L3 ç»„åˆï¼ˆreact/Flowï¼‰ã€‚

2. **è·¨æ–‡æ¡£å¯¹é½**
   - å°†æœ¬ç›®å½•ä¸­çš„æ¨¡å—æ‹†åˆ†ç‚¹ä¸ `runtime-logix/core/*`ã€`v3/02-intent-layers.md`ã€`v3/03-assets-and-schemas.md` ç­‰æ–‡æ¡£å»ºç«‹äº¤å‰é“¾æ¥ï¼Œä¿è¯â€œIntent æ¨¡å‹ â†’ Runtime â†’ å¹³å° UIâ€ä¸‰çº¿ä¸€è‡´ã€‚

3. **PM è§†è§’æ„å›¾è¯­è¨€ï¼ˆè‰æ¡ˆï¼‰**
   - åŸºäº IntentRule è®¾è®¡ä¸€å¥—è½»é‡çš„ä¸šåŠ¡ DSL / æ–‡æœ¬æè¿°è§„èŒƒï¼ˆå¯é€‰ï¼‰ï¼Œä¸ç”»å¸ƒæ“ä½œäº’é€šï¼›
   - ä¾‹å¦‚æ”¯æŒç±»ä¼¼ YAML çš„â€œå½“ X æ—¶ï¼Œè‹¥æ¡ä»¶ Yï¼Œåˆ™æ‰§è¡Œ Zâ€æè¿°ï¼Œå¹³å°è½¬è¯‘ä¸º IntentRuleã€‚

4. **AI è¾…åŠ©ç­–ç•¥**
   - å®šä¹‰ Copilot çš„ä¸Šä¸‹æ–‡æ‰“åŒ…è§„èŒƒï¼šæ¯ç§è§†å›¾ä¸‹ï¼Œå‘ LLM æä¾›å“ªäº› IntentRule/Schema/Trace ä¿¡æ¯ï¼›
   - è§„èŒƒâ€œAI æ¨èæ¨¡å¼ / AI è‡ªåŠ¨ä¿®å¤æ„å›¾â€çš„äº¤äº’è¾¹ç•Œä¸äººå·¥ç¡®è®¤æµç¨‹ã€‚

æœ¬ README åªæ˜¯èµ·ç‚¹ï¼Œç›®çš„æ˜¯ç»™â€œå¹³å°ä¾§æ„å›¾ä¸äº¤äº’ä½“éªŒè®¾è®¡â€å¼€ä¸€ä¸ªæ˜ç¡®çš„è½è„šç‚¹ã€‚åç»­å¯ä»¥æ ¹æ®å®é™…äº§å“è®¨è®ºï¼Œå°†æ¯ä¸ªæ¨¡å—æ‹†æˆæ›´ç»†çš„éœ€æ±‚ä¸äº¤äº’æ–‡æ¡£ã€‚

## 4. è‡ªä¸Šè€Œä¸‹çš„èµ„äº§é“¾è·¯ï¼šä¸šåŠ¡éœ€æ±‚ â†’ æ„å›¾ â†’ å®ç°

ä¸ºäº†é¿å…â€œæ„å›¾åœ¨äº§å“ / å¹³å° / ä»£ç ä¹‹é—´ä¸€è·¯å˜å½¢â€ï¼Œå¹³å°éœ€è¦ä»ä¸šåŠ¡éœ€æ±‚å¼€å§‹å°±ç”¨ç»Ÿä¸€çš„èµ„äº§ä½“ç³»æ‰¿è½½æ„å›¾ã€‚å¯ä»¥ç²—åˆ†ä¸ºå››ä¸ªå±‚çº§ï¼š

### 4.1 Level 0ï¼šä¸šåŠ¡éœ€æ±‚ï¼ˆBusiness Requirementï¼‰

- å½¢æ€ï¼šéœ€æ±‚æ–‡æ¡£ / ç”¨æˆ·æ•…äº‹ / PRD æ®µè½ï¼Œä¾‹å¦‚ï¼š
  - â€œæœç´¢ç»“æœåˆ—è¡¨çš„ç¬¬ä¸€æ¡åº”è‡ªåŠ¨åœ¨å³ä¾§è¯¦æƒ…é¢æ¿å±•ç¤ºâ€ï¼›
  - â€œå®¡æ‰¹é€šè¿‡æ—¶è®°å½•å®¡è®¡æ—¥å¿—å¹¶åˆ·æ–°å¾…åŠåˆ—è¡¨â€ï¼›
  - â€œç”¨æˆ·åˆ‡æ¢å›½å®¶æ—¶ï¼Œåº”æ¸…ç©ºçœä»½å’ŒåŸå¸‚å­—æ®µâ€ã€‚
- è´£ä»»è§’è‰²ï¼šPM / ä¸šåŠ¡æ–¹ã€‚
- å¹³å°èŒè´£ï¼š
  - æä¾›ç»“æ„åŒ–æ¨¡æ¿ï¼Œå¼•å¯¼éœ€æ±‚ç”¨â€œå½“ X æ—¶ï¼Œå¦‚æœ Yï¼Œåˆ™ç³»ç»Ÿåº” Zâ€çš„å½¢å¼ä¹¦å†™ï¼›
  - ä¸º Level 1 çš„æ„å›¾æ‹†è§£æä¾›ä¸Šä¸‹æ–‡è¾“å…¥ï¼ˆåŒ…æ‹¬åœºæ™¯ã€é¡µé¢ã€å­—æ®µã€çº¦æŸç­‰ï¼‰ã€‚

### 4.2 Level 1ï¼šéœ€æ±‚æ„å›¾ï¼ˆRequirement Intentï¼‰

- å½¢æ€ï¼šå°†è‡ªç„¶è¯­è¨€éœ€æ±‚æŠ•å½±åˆ° v3 Intent æ¨¡å‹ï¼ˆUI / Logic / Module / Constraintï¼‰ï¼Œå¹¶åˆæ­¥æ‹†æˆã€Œç”¨ä¾‹çº§è“å›¾ã€ï¼š
  - UI / Interactionï¼šæ¶‰åŠå“ªäº›é¡µé¢ã€å“ªç±»ç”¨æˆ·è¡Œä¸ºï¼ˆç‚¹å‡»ã€è¾“å…¥ã€åˆ‡æ¢ï¼‰ä½œä¸º Triggerï¼›
  - Data & Stateï¼šå“ªäº›å­—æ®µ/å®ä½“å‚ä¸è”åŠ¨ï¼›
  - Behavior & Flowï¼šéœ€è¦å“ªå‡ æ­¥è¡Œä¸ºï¼ˆè°ƒç”¨ Serviceã€æ›´æ–°çŠ¶æ€ã€è°ƒåº¦å…¶ä»–æ¨¡å—ï¼‰ï¼›
  - Constraintsï¼šé˜²æŠ–/å¹‚ç­‰/å¹¶å‘/è¶…æ—¶ç­‰çº¦æŸã€‚
- å¹³å°èµ„äº§ï¼š
  - **Use Case Blueprint**ï¼šä¸€ä¸ªç”¨ä¾‹çº§çš„â€œæ„å›¾è“å›¾â€ï¼Œå¯¹åº”ä¸€ç»„å€™é€‰çš„ `IntentRule` é›†åˆ + å¯èƒ½ç”¨åˆ°çš„ Pattern/æ¨¡å—ã€‚
- è´£ä»»è§’è‰²ï¼šPM / æ¶æ„ / AI ååŒã€‚
- ä¸ IR çš„å…³ç³»ï¼š
  - Level 1 ä¸ä¸€å®šç›´æ¥ç”¨ TS API è¡¨è¾¾ï¼Œä½†å¯ä»¥å…ˆç”Ÿæˆè¾ƒç²—ç²’åº¦çš„ `IntentRule` è‰ç¨¿ï¼ˆåªå¡« source/sinkï¼Œpipeline å¯ä»¥ç•™ç©ºæˆ–ç”¨è‡ªç„¶è¯­è¨€æ³¨é‡Šï¼‰ã€‚

### 4.3 Level 2ï¼šå¼€å‘æ„å›¾ï¼ˆDeveloper Intentï¼‰

- å½¢æ€ï¼šåœ¨ Requirement Intent çš„åŸºç¡€ä¸Šï¼Œæ˜¾å¼è½åˆ°å…·ä½“çš„ Store / Pattern / Intent API é€‰æ‹©ä¸Šï¼š
  - ç¡®è®¤æ¶‰åŠåˆ°å“ªäº› Logix.ModuleShapeï¼ˆState/Action Schemaï¼‰ï¼›
  - ç¡®è®¤å“ªäº›è”åŠ¨å±äº L1ï¼ˆandUpdate*ï¼‰/ L2ï¼ˆCoordinateï¼‰/ L3ï¼ˆFlow/Patternï¼‰ï¼›
  - ä¸ºæ¯æ¡è§„åˆ™é€‰æ‹©åˆé€‚çš„ API å½¢æ€ï¼ˆIntent å¿«æ·æ–¹å¼ / ç»“æ„åŒ– Coordinate / Flow ç»„åˆï¼‰ã€‚
- å¹³å°èµ„äº§ï¼š
  - **IntentRule é›†åˆ**ï¼šç”¨ç»“æ„åŒ–çš„ IR å…¨é¢è¦†ç›–æŸä¸ªç”¨ä¾‹/æ¨¡å—çš„è”åŠ¨è§„åˆ™ï¼›
  - **Pattern Asset**ï¼š`(input) => Effect` çº§åˆ«çš„å¯å¤ç”¨è¡Œä¸ºï¼›
  - ï¼ˆå¯é€‰ï¼‰Logic æ¨¡æ¿ / Store æ¨¡æ¿ï¼Œç”¨äºåœ¨å•é¡¹ç›®å†…å¤ç”¨åœºæ™¯çº§æ¨¡å—ã€‚
- è´£ä»»è§’è‰²ï¼šèµ„æ·±å‰ç«¯ / æ¶æ„ / LLMï¼ˆåœ¨ä¸Šä¸‹æ–‡ä¸­è¡¥å…¨ IntentRule â†’ Intent API æ˜ å°„ï¼‰ã€‚

### 4.4 Level 3ï¼šå®ç°ä¸å‡ºç ï¼ˆImplementation & Codegenï¼‰

- å½¢æ€ï¼šå°† Level 2 çš„å¼€å‘æ„å›¾è‡ªåŠ¨æˆ–åŠè‡ªåŠ¨ç”Ÿæˆä¸ºå…·ä½“ä»£ç ä¸è¿è¡Œæ—¶é…ç½®ï¼š
  - ç±»å‹å®‰å…¨çš„ Module Schema / `Logix.Module` å®šä¹‰ä¸ `Module.logic` / `Module.live` è°ƒç”¨ï¼›
  - Logic ç¨‹åºå†…éƒ¨çš„ Fluent DSL / Flow / Control è°ƒç”¨ï¼›
  - Pattern å®šä¹‰æ–‡ä»¶ã€æµ‹è¯•ç”¨ä¾‹ã€React ç»‘å®šä»£ç ç­‰ã€‚
- å¹³å°èŒè´£ï¼š
  - æä¾›ç¨³å®šçš„ Codegen æ¨¡æ¿ï¼šä» `IntentRule` åˆ° Fluent DSL / Flow è°ƒç”¨çš„æ ‡å‡†åŒ–ç”Ÿæˆï¼›
  - é€šè¿‡ AST patch æ–¹å¼å®‰å…¨åœ°å¯¹ç°æœ‰ä»£ç è¿›è¡Œå¢é‡ä¿®æ”¹ï¼ˆéµå®ˆé¡¹ç›®é£æ ¼ä¸å·²æœ‰ç»“æ„ï¼‰ï¼›
  - ä¸ Runtimeï¼ˆLogix / Effect Flow Runtimeï¼‰å¯¹é½ç±»å‹ä¸ Layer ç»„åˆæ–¹å¼ã€‚

### 4.5 èµ„äº§ä½“ç³»åœ¨å››ä¸ªå±‚çº§ä¸­çš„è§’è‰²

ç»“åˆå‰è¿°èµ„äº§åˆ†ç±»ï¼Œå››ä¸ªå±‚çº§å¯ä»¥å¤§è‡´å¯¹åº”ä¸åŒç²’åº¦çš„å¯å¤ç”¨èµ„äº§ï¼š

- Level 0ï¼š
  - éœ€æ±‚æ¨¡æ¿ / ç”¨ä¾‹åº“ï¼ˆä»¥è‡ªç„¶è¯­è¨€æˆ–è½»é‡ DSL å½¢å¼å­˜åœ¨ï¼‰ï¼Œä¾¿äºæ²‰æ·€ä¸šåŠ¡åœºæ™¯ã€‚
- Level 1ï¼š
  - Use Case Blueprintï¼ˆéœ€æ±‚æ„å›¾è“å›¾ï¼‰ï¼Œæœ¬è´¨æ˜¯ä¸€ç»„æœªå®Œå…¨å®ç°çš„ IntentRule + Pattern/æ¨¡å—å¼•ç”¨ã€‚
- Level 2ï¼š
  - Pattern èµ„äº§ / Logic æ¨¡æ¿ / Store æ¨¡æ¿ / IntentRule é›†åˆï¼Œæ„æˆå¼€å‘ä¾§çš„â€œæ„å›¾å®ç°èµ„äº§â€ã€‚
- Level 3ï¼š
  - å…·ä½“çš„ Store / Logic / Pattern / React ç»„ä»¶ä»£ç ï¼Œä¸ Runtime é…ç½®ï¼›
  - ä»ç„¶å¯ä»¥é€šè¿‡ Pattern/æ¨¡æ¿æœºåˆ¶åœ¨å¤šä¸ªé¡¹ç›®ä¸­æ¨ªå‘å¤ç”¨ã€‚

è¿™å¥—è‡ªä¸Šè€Œä¸‹çš„é“¾è·¯ï¼Œç›®æ ‡æ˜¯è®©â€œä¸šåŠ¡éœ€æ±‚ â†’ éœ€æ±‚æ„å›¾ â†’ å¼€å‘æ„å›¾ â†’ å®ç°å‡ºç â€åœ¨å¹³å°å†…éƒ¨éƒ½èƒ½ç”¨åŒä¸€å¥—æ¦‚å¿µå¯¹é½ï¼š

- PM / ä¸šåŠ¡ä¾§ä¸»è¦æ“ä½œ Level 0â€“1ï¼›
- æ¶æ„ / é«˜çº§å¼€å‘ä¸»è¦åœ¨ Level 1â€“2 è®¾è®¡è“å›¾ä¸èµ„äº§ï¼›
- ä»£ç ç”Ÿæˆä¸ Runtime å®ç°è´Ÿè´£ Level 2â€“3 çš„è½åœ°ï¼›
- LLM/Agent è´¯ç©¿å…¨é“¾è·¯ï¼Œå¸®åŠ©ä»è‡ªç„¶è¯­è¨€æ¨å¯¼/å¯¹é½ IntentRule ä¸å…·ä½“å®ç°ã€‚***
</file>

<file path="intent-driven-ai-coding/v3/00-platform-manifesto.md">
# å¹³å°å®£è¨€ (Platform Manifesto)

> **Status**: Draft
> **Version**: v3

## 1. æ„å›¾ä¼˜å…ˆ (Intent First)

ä»£ç æ˜¯æ„å›¾çš„**æŠ•å½±**ï¼Œè€Œéæœ¬ä½“ã€‚æˆ‘ä»¬è‡´åŠ›äºæ•æ‰ã€ç»“æ„åŒ–å’Œæ¼”è¿›â€œæ„å›¾â€ï¼Œè€Œéä»…ä»…æ˜¯ç®¡ç†ä»£ç æ–‡ä»¶ã€‚

## 2. èµ„äº§å…±å»º (Asset Co-Creation)

å¹³å°çš„ä»·å€¼ä¸åœ¨äºå®ƒå†…ç½®äº†å¤šå°‘åŠŸèƒ½ï¼Œè€Œåœ¨äºå®ƒèƒ½æ‰¿è½½å¤šå°‘å›¢é˜Ÿçš„æ™ºæ…§ã€‚Pattern æ˜¯å›¢é˜Ÿæœ€ä½³å®è·µçš„ç»“æ™¶ï¼Œå¹³å°æ˜¯ Pattern çš„æµé€šå¸‚åœºã€‚

## 3. å¼€å‘è€…ä¸»æƒ (Developer Sovereignty)

æˆ‘ä»¬å°Šé‡å¼€å‘è€…çš„ä»£ç æ‰€æœ‰æƒå’Œå·¥å…·é€‰æ‹©æƒã€‚

*   **é›¶é”å®š (No Vendor Lock-in)**ï¼šå¹³å°ç”Ÿæˆçš„ä»£ç åº”å½“æ˜¯æ ‡å‡†çš„ã€å¯è¯»çš„ã€æ— è¿è¡Œæ—¶é»‘ç›’çš„ã€‚
*   **éšæ—¶é€ƒé€¸ (Always Ejectable)**ï¼šæä¾› **Clean Mode**ã€‚å¼€å‘è€…å¯ä»¥éšæ—¶åˆ‡æ–­ä¸å¹³å°çš„è”ç³»ï¼Œå¸¦èµ°çº¯å‡€çš„ä»£ç ï¼Œä¸ç•™ä»»ä½•é—æ†¾ã€‚
*   **åŒå‘å°Šé‡ (Mutual Respect)**ï¼šå¹³å°å°Šé‡äººå·¥ä¿®æ”¹çš„ä»£ç ï¼ˆé€šè¿‡é”šç‚¹ä¿æŠ¤ï¼‰ï¼Œä¸å¼ºè¡Œè¦†ç›–ï¼›å¼€å‘è€…å°Šé‡å¹³å°çš„ç»“æ„åŒ–çº¦æŸï¼Œä»¥æ¢å–è‡ªåŠ¨åŒ–çº¢åˆ©ã€‚

## 4. ç»“æ™¶è€Œéç¿»è¯‘ (Crystallization, not Translation)

è½¯ä»¶å¼€å‘æ˜¯ä»æ¨¡ç³Šåˆ°ç²¾ç¡®çš„è¿‡ç¨‹ã€‚å¹³å°ä¸åº”åªæ˜¯ä¸€ä¸ªâ€œç¿»è¯‘å™¨â€ï¼ˆæŠŠéœ€æ±‚ç¿»è¯‘æˆä»£ç ï¼‰ï¼Œè€Œåº”æ˜¯ä¸€ä¸ªâ€œç»“æ™¶å™¨â€â€”â€”å¸®åŠ©æ¨¡ç³Šçš„æƒ³æ³•åœ¨äº¤äº’ä¸­é€æ¸æ²‰æ·€ä¸ºæ¸…æ™°çš„ç»“æ„ã€‚

## 5. è¿è¡Œæ—¶æ— å…³ (Runtime Agnostic)

è™½ç„¶æˆ‘ä»¬é¦–é€‰ Effect-TSï¼Œä½†æ„å›¾æ¨¡å‹æœ¬èº«åº”ç‹¬ç«‹äºå…·ä½“çš„æŠ€æœ¯æ ˆã€‚Logic Intent æè¿°çš„æ˜¯â€œåšä»€ä¹ˆâ€ï¼Œè€Œéâ€œæ€ä¹ˆåšâ€ã€‚
</file>

<file path="intent-driven-ai-coding/v3/01-overview.md">
---
title: 01 Â· æ„å›¾é©±åŠ¨å¼€å‘å¹³å° (v3) (Intent-Driven Development Platform)
status: draft
version: 9 (Unified-API-Aligned)
---

## 1. æ ¸å¿ƒç†å¿µï¼šæ„å›¾æ˜¾å½±ä¸èµ„äº§å¤ç”¨

æœ¬å¹³å°è‡´åŠ›äºæ„å»ºä¸€ä¸ª**æ„å›¾æ˜¾å½±å¼•æ“**ä¸**èµ„äº§å…±å»ºå¹³å°**ã€‚å®ƒä¸ä»…å¸®åŠ©ä¸ªäººå¼€å‘è€…ææ•ˆï¼Œæ›´å¸®åŠ©å›¢é˜Ÿæ²‰æ·€çŸ¥è¯†èµ„äº§ã€‚

## 2. ä¸‰ä½ä¸€ä½“æ¨¡å‹ (The Trinity Model)

1.  **UI (Presentation)**ï¼š**èº¯å£³**ã€‚ç•Œé¢ç»“æ„ä¸è§†è§‰è¡¨ç°ã€‚
2.  **Logic (Behavior)**ï¼š**çµé­‚**ã€‚ä¸šåŠ¡è§„åˆ™ä¸æµç¨‹ç¼–æ’ã€‚
3.  **Module (Data)**ï¼š**è®°å¿†**ã€‚ä¸šåŠ¡æ¦‚å¿µä¸æ•°æ®æ¨¡å‹ã€‚

## 3. æŠ€æœ¯åŸºåº§ (The Tech Stack)

*   **Runtime**: åŸºäº `Effect-TS` æ„å»ºå¯ç»„åˆã€å¯æµ‹è¯•ã€å¹¶å‘å®‰å…¨çš„ä¸šåŠ¡æµç¨‹ã€‚
*   **Engine**: **å…¨åŒå·¥é”šç‚¹å¼•æ“ (Full-Duplex Anchor Engine)**ã€‚
    *   æ”¯æŒ **Intent -> Code** çš„é«˜è´¨é‡ç”Ÿæˆã€‚
    *   æ”¯æŒ **Code -> Intent** çš„æ— æŸå›æµï¼ˆå³ä½¿ä»£ç è¢«äººå·¥ä¿®æ”¹ï¼‰ã€‚
    *   æ”¯æŒ **Type Projection**ï¼Œåœ¨ Web ç«¯æä¾› IDE çº§çš„ç±»å‹å®‰å…¨ã€‚

## 4. æ¸è¿›å¼é‡‡ç”¨ç­–ç•¥ (Progressive Adoption)

### Phase 1: å‰ç«¯å¼€å‘è€…çš„è¶…çº§ IDE (Solo Mode)
*   **åœºæ™¯**ï¼šä¸ªäººææ•ˆã€‚
*   **ä»·å€¼**ï¼šåˆ©ç”¨ AI å’Œå†…ç½® Pattern å¿«é€Ÿç”Ÿæˆé«˜è´¨é‡ä»£ç ã€‚
*   **å‡ºå£**ï¼šæ”¯æŒ **Clean Mode** å¯¼å‡ºã€‚ç”Ÿæˆçº¯å‡€ã€æ— ä¾èµ–çš„ä»£ç ï¼Œéšæ—¶è„±ç¦»å¹³å°ï¼Œé›¶å‚å•†é”å®šã€‚

### Phase 2: äº§ç ”åä½œå¹³å° (Team Mode)
*   **åœºæ™¯**ï¼šPM/Designer ä»‹å…¥ã€‚
*   **ä»·å€¼**ï¼šæ¶ˆé™¤æ–‡æ¡£ä¸ä»£ç çš„é¸¿æ²Ÿï¼Œå®ç° DevOps é—­ç¯ã€‚

### Phase 3: èµ„äº§è¿è¥å¹³å° (Asset Mode)
*   **åœºæ™¯**ï¼šå›¢é˜Ÿèµ„äº§æ²‰æ·€ã€‚
*   **ç”¨æ³•**ï¼š
    *   **æç‚¼**ï¼šèµ„æ·±å¼€å‘å°†æœ¬åœ°æœ€ä½³å®è·µï¼ˆHooks, Flowsï¼‰æç‚¼ä¸º Pattern ä¸Šä¼ ã€‚
    *   **å¤ç”¨**ï¼šå›¢é˜Ÿæˆå‘˜æ¶ˆè´¹ Patternï¼Œå®ç°æŠ€æœ¯æ ‡å‡†çš„ç»Ÿä¸€ã€‚
*   **ä»·å€¼**ï¼šæŠµæ¶ˆäººå‘˜æµåŠ¨å¸¦æ¥çš„ç†µå¢ï¼Œé€šè¿‡èµ„äº§å¤ç”¨å®ç°æ•°å€ææ•ˆã€‚

## 5. å¹³å°è§†å›¾ä½“ç³»

*   **Doc View**ï¼šéœ€æ±‚å½•å…¥ã€‚
*   **Canvas View**ï¼šæ¶æ„ç¼–æ’ï¼ˆæ”¯æŒé»‘ç›’/ç™½ç›’æ··åˆè§†å›¾ï¼‰ã€‚
*   **Studio View**ï¼šä»£ç ç”Ÿæˆä¸ç²¾ä¿®ï¼ˆæ”¯æŒ Monaco Editor ç±»å‹å¢å¼ºï¼‰ã€‚

## 6. ä¸€æ¡é»„é‡‘é“¾è·¯ï¼ˆModule â†’ Logic â†’ Fluent â†’ IntentRuleï¼‰

åœ¨ v3 ä¸­ï¼Œå¹³å°ä¸ Runtime å›´ç»•ä¸€æ¡â€œé»„é‡‘é“¾è·¯â€ååŒï¼š

> **Module â†’ Module.logic(($) => ...) â†’ $.use(Module) â†’ Fluent DSL (`$.onState` / `$.onAction` / `$.on`) â†’ IntentRule**

ç›´è§‚ç†è§£ï¼š

- **Define**ï¼šç”¨ `Logix.Module('Id', { state, actions })` å®šä¹‰é¢†åŸŸèµ„äº§ï¼ˆModule Assetï¼‰ï¼ŒåŒæ—¶æ‰¿è½½ Id / Schema / Runtime Tagï¼›
- **Logic**ï¼šåœ¨ Module ä¸Šé€šè¿‡ `Module.logic(($)=>Effect.gen(...))` ç¼–å†™ Logicï¼Œ`$` æ˜¯ BoundContextï¼ˆç»‘å®šå½“å‰ Module Runtime + ä¸šåŠ¡ Env çš„ç»Ÿä¸€å…¥å£ï¼‰ï¼›
- **Collaborate**ï¼šåœ¨å…¶ä»– Logic ä¸­é€šè¿‡ `$.use(Module)` è·å–è·¨æ¨¡å—å¥æŸ„ï¼›
- **Fluent**ï¼šä½¿ç”¨ `$.onState / $.onAction / $.on(stream)` + `$.state/dispatch` è¡¨è¾¾è§„åˆ™ï¼›
- **IntentRule**ï¼šå¹³å°è§£æ Fluent é“¾ï¼Œå°†å…¶è¿˜åŸä¸ºç»“æ„åŒ–çš„ IntentRuleï¼Œç”¨äº Universe/Galaxy ç­‰è§†å›¾ã€‚

è¿™æ¡é“¾è·¯åœ¨ä»¥ä¸‹æ–‡æ¡£ä¸­æœ‰è¯¦ç»†è¯´æ˜ï¼š

- Runtime è§†è§’ï¼š`runtime-logix/core/03-logic-and-flow.md`ï¼ˆç¬¬ 9 èŠ‚ï¼‰ï¼›
- Intent & Asset è§†è§’ï¼š`03-assets-and-schemas.md`ã€`03-module-assets.md`ï¼›
- è§£æ & å‡ºç è§†è§’ï¼š`06-codegen-and-parser.md`ã€`runtime-logix/core/06-platform-integration.md`ã€‚

## 6. æ–‡æ¡£ç´¢å¼•

*   `00-platform-manifesto.md`ï¼šå¹³å°å®£è¨€ä¸èµ„äº§å…±å»ºç­–ç•¥ã€‚
*   `02-intent-layers.md`ï¼šè¯¦è§£ä¸‰ä½ä¸€ä½“æ¨¡å‹ã€‚
*   `03-assets-and-schemas.md`ï¼šæ ¸å¿ƒèµ„äº§ç»“æ„å®šä¹‰ã€‚
*   `04-intent-to-code-example.md`ï¼šv3 æ¼”ç»ƒç¤ºä¾‹ï¼ˆå«é”šç‚¹ä»£ç ï¼‰ã€‚
*   `06-codegen-and-parser.md`ï¼šå…¨åŒå·¥å¼•æ“ä¸é”šç‚¹è§„èŒƒã€‚
*   `97-effect-runtime-and-flow-execution.md`ï¼šLogic æ„å›¾çš„è¿è¡Œæ—¶å®ç°ã€‚
*   `99-glossary-and-ssot.md`ï¼šè·¨å±‚æ¦‚å¿µæ€»è§ˆä¸æœ¯è¯­è¡¨ï¼ˆConceptual SSOTï¼‰ã€‚

## 7. å•ä¸€äº‹å®æºä¸ä¼˜å…ˆçº§ï¼ˆSSOT & Priorityï¼‰

v3 è§„èŒƒä»åœ¨æ¼”è¿›ä¸­ï¼Œéš¾å…å­˜åœ¨å†å²å†™æ³•ä¸æ–°è§„åˆ’å¹¶å­˜çš„æƒ…å†µã€‚ä¸ºé¿å…æ­§ä¹‰ï¼Œå‡ºç°å†²çªæ—¶åº”æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§åˆ¤æ–­â€œè°è¯´äº†ç®—â€ï¼š

1. **å¹³å°ä¸æ„å›¾æ¨¡å‹ï¼ˆæ¦‚å¿µå±‚ï¼‰**
   - ä»¥æœ¬ç›®å½•ä¸‹çš„ v3 æ–‡æ¡£ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œç‰¹åˆ«æ˜¯ï¼š
     - `00-platform-manifesto.md`ï¼šå¹³å°ä»·å€¼è§‚ä¸é•¿æœŸæ–¹å‘ï¼›
     - `02-intent-layers.md` / `03-assets-and-schemas.md`ï¼šä¸‰ä½ä¸€ä½“æ¨¡å‹ä¸èµ„äº§ç»“æ„çš„å®šä¹‰ï¼›
     - `blueprint.md`ï¼šé•¿æœŸæ¼”è¿›è·¯çº¿ä¸ç»ˆå±€å½¢æ€ã€‚
   - v1/v2 æ–‡æ¡£ä»…ä½œä¸ºå†å²å‚è€ƒï¼Œä¸å†ä½œä¸ºäº‹å®æºã€‚

2. **Runtime ä¸ Intent APIï¼ˆç±»å‹ä¸è¡Œä¸ºå±‚ï¼‰**
   - ä»¥ `runtime-logix/core/*.md` ä¸­æ ‡è®°ä¸º `Status: Definitive` çš„æ–‡æ¡£ä¸ºå‡†ï¼Œä¾‹å¦‚ï¼š
     - `02-module-and-logic-api.md`ï¼šModule / Logic / Bound API `$` ä¸ Module-first ç¼–ç¨‹æ¨¡å‹ï¼›
     - `03-logic-and-flow.md`ï¼šLogic / Flow / Intent L1/L2 API å½¢æ€ä¸ Fluent DSLï¼›
     - `06-platform-integration.md`ï¼šIntentRule IR åŠå¹³å°é›†æˆè§„èŒƒã€‚
   - å½“æ–‡æ¡£ä¸ä»£ç å­˜åœ¨ä¸ä¸€è‡´æ—¶ï¼Œä»¥ `v3/effect-poc/shared/logix-v3-core.ts` ä¸­çš„ç±»å‹å®šä¹‰ä¸ºæœ€ç»ˆè£å†³ï¼Œå¹¶éšåå›å†™ä¿®æ­£æ–‡æ¡£ã€‚

3. **å¹³å°äº¤äº’ä¸èµ„äº§ä½“ç³»ï¼ˆäº§å“/UX å±‚ï¼‰**
   - ä»¥ä»¥ä¸‹æ–‡æ¡£ä¸ºå¹³å°ä¾§ SSOTï¼š
     - `06-platform-ui-and-interactions.md`ï¼šUniverse/Galaxy/Studio ç­‰è§†å›¾ä¸äº¤äº’åŸåˆ™ï¼›
     - `platform/README.md`ï¼šå¹³å° Intent & UX è§„åˆ’ã€L0â€“L3 èµ„äº§é“¾è·¯ï¼ˆä¸šåŠ¡éœ€æ±‚ â†’ éœ€æ±‚æ„å›¾ â†’ å¼€å‘æ„å›¾ â†’ å®ç°ï¼‰çš„å®šä¹‰ã€‚
   - è‹¥å¹³å°äº¤äº’è®¾è®¡ä¸ Runtime/API ç»†èŠ‚æœ‰å†²çªï¼Œä¼˜å…ˆä¿è¯ v3 Intent æ¨¡å‹ä¸ Runtime è¯­ä¹‰ä¸€è‡´ï¼Œç„¶åå†è°ƒæ•´äº¤äº’æ–¹æ¡ˆã€‚

4. **å®ç°ç»†èŠ‚ä¸ PoC**
   - `v3/effect-poc` ä¸‹çš„ä»£ç ç¤ºä¾‹ï¼ˆå¦‚ `shared/logix-v3-core.ts`ã€å„ `scenarios/*.ts`ï¼‰æ˜¯å½“å‰å®ç°çš„å‚è€ƒæ ·ä¾‹ï¼Œä½†ä¸ç­‰åŒäºé•¿æœŸ API è®¾è®¡æ‰¿è¯ºï¼›
   - åœ¨æ¼”è¿›è¿‡ç¨‹ä¸­ï¼ŒPoC å¯ä»¥å…ˆè¡Œè¯•éªŒæ–°å†™æ³•ï¼Œå†æ ¹æ®éªŒè¯ç»“æœå›å†™/è°ƒæ•´ä¸Šè¿°è§„èŒƒæ–‡æ¡£ã€‚

ç®€è¨€ä¹‹ï¼Œå½“é‡åˆ°â€œå¤šå¤„ä¸ä¸€è‡´â€çš„æƒ…å†µæ—¶ï¼Œä¼˜å…ˆçº§æ’åºä¸ºï¼š

> **å¹³å°å®£è¨€ & æ„å›¾æ¨¡å‹ â‰¥ Runtime è§„èŒƒ & ç±»å‹å®šä¹‰ â‰¥ å¹³å°äº¤äº’è§„èŒƒ â‰¥ PoC å®ç°ç»†èŠ‚ã€‚**

ä»»ä½•å¯¹ Intent æ¨¡å‹ã€Runtime API æˆ–å¹³å°äº¤äº’æœ‰ç ´åæ€§å½±å“çš„æ”¹åŠ¨ï¼Œéƒ½åº”å…ˆåœ¨å¯¹åº”çš„ v3 è§„èŒƒæ–‡æ¡£ä¸­è¾¾æˆå…±è¯†ï¼Œå†å›å†™åˆ° PoC ä»£ç ä¸åç»­å®ç°ä¸­ã€‚***
</file>

<file path="intent-driven-ai-coding/v3/02-intent-layers.md">
---
title: 02 Â· ä¸‰ä½ä¸€ä½“æ„å›¾æ¨¡å‹ (The Trinity Intent Model)
status: draft
version: 5 (Unified-API-Aligned)
---

> æœ¬æ–‡æ¡£åŸºäºâ€œå¥¥å¡å§†å‰ƒåˆ€â€åŸåˆ™ï¼Œå°†åŸæœ‰çš„å…­å±‚æ„å›¾æ¨¡å‹æ”¶æ•›ä¸º **UI (è¡¨ç°)**ã€**Logic (é€»è¾‘)**ã€**Module (é¢†åŸŸ)** ä¸‰å¤§æ ¸å¿ƒç»´åº¦ã€‚æ¯ä¸ªç»´åº¦éƒ½æ”¯æŒä» PMï¼ˆæ¨¡ç³Šéœ€æ±‚ï¼‰åˆ° Devï¼ˆç²¾ç¡®å®ç°ï¼‰çš„æ¸è¿›å¼æ˜¾å½±ã€‚

## 1. æ¨¡å‹æ€»è§ˆ (Overview)

ä¸ºäº†æ¶ˆé™¤æ¦‚å¿µå†—ä½™å¹¶å¯¹é½äº§å“ä¸å¼€å‘è§†è§’ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸‰ä¸ªæ­£äº¤çš„æ„å›¾ç»´åº¦ï¼š

| ç»´åº¦ | æ ¸å¿ƒèŒè´£ | åŒ…å«çš„åŸæ¦‚å¿µ | å¯¹åº”èµ„äº§ |
| :--- | :--- | :--- | :--- |
| **UI Intent** | **Presentation (èº¯å£³)**<br>ç•Œé¢ç»“æ„ã€ç»„ä»¶ç»„åˆä¸è§†è§‰äº¤äº’ | Layout, View, Visual Interaction | Wireframe / Component Tree |
| **Logic Intent** | **Behavior (çµé­‚)**<br>ä¸šåŠ¡è§„åˆ™ã€æµç¨‹ç¼–æ’ä¸å‰¯ä½œç”¨ | Interaction(Trigger), Behavior, Flow | User Story / Logic (Effect-based DSL) |
| **Module Intent** | **Data (è®°å¿†)**<br>ä¸šåŠ¡å®ä½“ã€æ•°æ®æ¨¡å‹ä¸å¥‘çº¦ | Data, State | Concept Model / Schema |

## 2. UI Intent Â· è¡¨ç°æ„å›¾

**å®šä¹‰**ï¼šæè¿°ç•Œé¢â€œé•¿ä»€ä¹ˆæ ·â€ä»¥åŠâ€œå¦‚ä½•å“åº”è§†è§‰æ“ä½œâ€ã€‚éµå¾ªâ€œä¸€åˆ‡çš†ç»„ä»¶â€åŸåˆ™ã€‚

### 2.1 åŒé‡è§†è§’

*   **PM è§†è§’ (Low-Res)**ï¼š**çº¿æ¡†å›¾ (Wireframe)**
    *   å…³æ³¨åŒºåŸŸåˆ’åˆ† (Layout) å’Œå†…å®¹å ä½ (Placeholder)ã€‚
    *   *ä¾‹ï¼šâ€œå·¦è¾¹æ˜¯å¯¼èˆªæ ï¼Œä¸­é—´æ”¾ä¸€ä¸ªè®¢å•åˆ—è¡¨ã€‚â€*
*   **Dev è§†è§’ (High-Res)**ï¼š**ç»„ä»¶æ ‘ (Component Tree)**
    *   å…³æ³¨å…·ä½“ç»„ä»¶é€‰æ‹© (Pattern) å’Œå±æ€§é…ç½® (Props)ã€‚
    *   *ä¾‹ï¼šâ€œä½¿ç”¨ `WorkbenchLayout`ï¼Œæ’æ§½ `content` ç»‘å®š `ProTable` ç»„ä»¶ã€‚â€*

### 2.2 è§†è§‰äº¤äº’ (Visual Interaction)

*   **å®šä¹‰**ï¼šä¸æ¶‰åŠä¸šåŠ¡æ•°æ®å˜æ›´ã€ä»…æ”¹å˜ç•Œé¢çŠ¶æ€çš„äº¤äº’ã€‚
*   **å½’å±**ï¼šUI Intent å†…éƒ¨ï¼ˆç»„ä»¶çš„ UI Stateï¼‰ã€‚
*   **ç¤ºä¾‹**ï¼šå±•å¼€/æ”¶èµ·ä¾§è¾¹æ ã€åˆ‡æ¢ Tabã€æ‰“å¼€ Modalã€è¡¨å•å­—æ®µæ˜¾éšè”åŠ¨ã€‚

### 2.3 Schema ç»“æ„ç¤ºæ„

```typescript
interface UIIntentNode {
  id: string;
  type: string; // ç»„ä»¶ç±»å‹æˆ– 'Placeholder'

  // è§†è§‰äº¤äº’ä¸å±æ€§
  props: Record<string, any>;

  // å¸ƒå±€æ’æ§½
  slots?: Record<string, UIIntentNode[]>;

  // ä¿¡å·å‘å°„å£ (è¿æ¥ Logic çš„é”šç‚¹)
  emits?: Record<string, string>; // e.g. { onClick: 'submitOrder' }
}
```

## 3. Logic Intent Â· é€»è¾‘æ„å›¾

**å®šä¹‰**ï¼šæè¿°ç³»ç»Ÿâ€œå¦‚ä½•å“åº”ä¿¡å·â€ä»¥åŠâ€œæ‰§è¡Œä»€ä¹ˆä¸šåŠ¡æµç¨‹â€ã€‚éµå¾ªâ€œä¿¡å·é©±åŠ¨â€åŸåˆ™ã€‚

### 3.1 åŒé‡è§†è§’

*   **PM è§†è§’ (Low-Res)**ï¼š**ç”¨æˆ·æ•…äº‹ (User Story)**
    *   å…³æ³¨è§¦å‘æ¡ä»¶ã€ä¸šåŠ¡è§„åˆ™å’ŒéªŒæ”¶æ ‡å‡† (AC)ã€‚
    *   *ä¾‹ï¼šâ€œç”¨æˆ·ç‚¹å‡»æäº¤åï¼Œæ ¡éªŒåº“å­˜ã€‚å¦‚æœåº“å­˜ä¸è¶³ï¼Œæç¤ºé”™è¯¯ï¼›å¦åˆ™åˆ›å»ºè®¢å•ã€‚â€*
*   **Dev è§†è§’ (High-Res)**ï¼š**Logic ç¨‹åº (Effect-based DSL)**
    *   å…³æ³¨ä¿¡å·ç›‘å¬ã€æœåŠ¡è°ƒç”¨ã€çŠ¶æ€æ›´æ–°ã€åˆ†æ”¯åˆ¤æ–­å’Œäº‹åŠ¡æ§åˆ¶ã€‚
    *   *ä¾‹ï¼šâ€œ`flow.fromAction(a => a._tag === 'submitOrder')` -> `Effect.catchAll` è°ƒç”¨ `InventoryService.check` -> `state.update` ...â€*

### 3.2 ä¸šåŠ¡äº¤äº’ (Business Interaction)

*   **å®šä¹‰**ï¼šæ¶‰åŠä¸šåŠ¡æ•°æ®å˜æ›´ã€æœåŠ¡è°ƒç”¨æˆ–è·¨ç»„ä»¶é€šä¿¡çš„äº¤äº’ã€‚
*   **å½’å±**ï¼šLogic Intentï¼ˆä½œä¸º Triggerï¼‰ã€‚
*   **æœºåˆ¶**ï¼šUI ç»„ä»¶å‘å°„ä¿¡å· (Emit)ï¼ŒLogic æ„å›¾ç›‘å¬ä¿¡å· (Listen)ã€‚UI ä¸å…³å¿ƒä¿¡å·è¢«è°å¤„ç†ï¼Œå®ç°äº† UI ä¸é€»è¾‘çš„å½»åº•è§£è€¦ã€‚

### 3.3 Schema ç»“æ„ç¤ºæ„

```typescript
interface LogicIntentNode {
  id: string;

  // è§¦å‘å™¨
  trigger: {
    type: 'onSignal' | 'onLifecycle' | 'onSchedule';
    signalId?: string;
  };

  // æµç¨‹ç¼–æ’ (Code is Truth)
  // åœ¨ v3 ä¸­ï¼Œè¿™é‡Œä¸å†æ˜¯ JSONï¼Œè€Œæ˜¯æŒ‡å‘æºç çš„å¼•ç”¨
  source: {
    file: string;
    exportName: string;
  };

  // çº¦æŸ (åŸ Constraint Intent)
  constraints?: {
    transaction: boolean;
    timeout: number;
  };
}
```

## 4. Module Intent Â· é¢†åŸŸæ„å›¾

**å®šä¹‰**ï¼šæè¿°ä¸šåŠ¡ä¸–ç•Œä¸­çš„â€œæ¦‚å¿µâ€åŠå…¶â€œæ•°æ®ç»“æ„â€ã€‚éµå¾ªâ€œé€šç”¨è¯­è¨€ (Ubiquitous Language)â€åŸåˆ™ã€‚

### 4.1 åŒé‡è§†è§’

*   **PM è§†è§’ (Low-Res)**ï¼š**æ¦‚å¿µæ¨¡å‹ (Concept Model)**
    *   å…³æ³¨ä¸šåŠ¡åè¯ã€æ ¸å¿ƒå±æ€§å’Œä¸šåŠ¡çº¦æŸã€‚
    *   *ä¾‹ï¼šâ€œæœ‰ä¸ªä¸œè¥¿å«â€˜è®¢å•â€™ï¼ŒåŒ…å«é‡‘é¢ã€çŠ¶æ€ã€‚çŠ¶æ€æœ‰å¾…æ”¯ä»˜ã€å·²å‘è´§ã€‚â€*
*   **Dev è§†è§’ (High-Res)**ï¼š**Schema / ER**
    *   å…³æ³¨å­—æ®µç±»å‹ã€æ•°æ®åº“å®šä¹‰ã€API å¥‘çº¦å’Œæ ¡éªŒè§„åˆ™ã€‚
    *   *ä¾‹ï¼šâ€œ`Order` å®ä½“ï¼Œ`amount` æ˜¯ `Decimal(10,2)`ï¼Œ`status` æ˜¯æšä¸¾ã€‚â€*

### 4.2 æ•°æ®æº (Data Source)

*   **å®šä¹‰**ï¼šæ•°æ®çš„å­˜å‚¨ä¸åŒæ­¥æ–¹å¼ã€‚
*   **å½’å±**ï¼šModule Intent çš„å®ç°ç»†èŠ‚ã€‚
*   **ç¤ºä¾‹**ï¼šReact Query (Server State)ã€Zustand (Client State)ã€URL Queryã€‚

### 4.3 Schema ç»“æ„ç¤ºæ„

```typescript
interface ModuleIntentNode {
  id: string;
  name: string; // ä¸šåŠ¡åè¯

  // å­—æ®µå®šä¹‰
  fields: Array<{
    name: string;
    type: string;
    validation?: string;
    description?: string;
  }>;

  // å®ä½“å…³ç³»
  relations?: Relation[];
}
```

## 5. æ„å›¾çš„ç»“æ™¶ (Crystallization)

åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œè½¯ä»¶å¼€å‘ä¸å†æ˜¯â€œç¿»è¯‘â€ï¼Œè€Œæ˜¯â€œç»“æ™¶â€ã€‚

1.  **æ¶²æ€ (Liquid)**ï¼šPM åœ¨æ–‡æ¡£æˆ–ç”»å¸ƒä¸­è¾“å…¥çš„è‡ªç„¶è¯­è¨€æè¿°ã€è‰å›¾ã€‚
2.  **å›ºæ€ (Solid)**ï¼šDev (æˆ– LLM) å°†å…¶è½¬åŒ–ä¸ºç²¾ç¡®çš„ç»„ä»¶æ ‘ã€Logic ç¨‹åºï¼ˆåŸºäº Store / Logic / Flow / Control / Effect.Service / Configï¼‰å’Œ Schemaã€‚

å¹³å°çš„æ ¸å¿ƒèŒè´£æ˜¯ç»´æŠ¤æ¶²æ€ Spec å’Œå›ºæ€ Impl ä¹‹é—´çš„**åŒå‘æ˜ å°„**ï¼Œç¡®ä¿â€œéœ€æ±‚â€ä¸â€œä»£ç â€æ°¸è¿œåŒæ­¥ã€‚
</file>

<file path="intent-driven-ai-coding/v3/03-assets-and-schemas.md">
---
title: 03 Â· èµ„äº§æ˜ å°„ä¸ Schema å®šä¹‰ (Assets & Schemas)
status: draft
version: 14 (Effect-Native)
---

> æœ¬æ–‡æ¡£å®šä¹‰äº†â€œä¸‰ä½ä¸€ä½“â€æ¨¡å‹ä¸‹çš„æ ¸å¿ƒèµ„äº§ç»“æ„ã€‚Intent æ˜¯å”¯ä¸€çš„çœŸç†æ¥æºï¼Œé€»è¾‘æ‰§è¡Œå±‚åœ¨æ—©æœŸæ›¾ç»Ÿä¸€å½’çº³ä¸º LogicDSLï¼›å½“å‰ v3 åœ¨å®ç°ä¸Šå·²æ”¶æ•›ä¸º **Store / Logic / Flow** ä¸‰å¤§è¿è¡Œæ—¶åŸè¯­ + åŸºäº Effect çš„ **pattern-style é•¿é€»è¾‘å°è£…é£æ ¼**ã€‚LogicDSL å¯ä»¥ç†è§£ä¸ºè¿™äº›åŸè¯­åœ¨ Intent / å·¥å…·é“¾è§†è§’ä¸‹çš„ç»Ÿç§°ï¼Œå…·ä½“ç±»å‹è®¾è®¡ä»¥ `v3/effect-poc` ä¸‹ PoC ä¸ºæœ€æ–°äº‹å®æºï¼›Pattern èµ„äº§ï¼ˆå¸¦ id/config çš„å¯å¤ç”¨é€»è¾‘ï¼‰å±äºå¹³å°å±‚æ¦‚å¿µï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶å†…å»ºç±»å‹ã€‚

## 1. IntentSpec v3 (The SSoT)

Intent ä¸å†æ˜¯æ‰å¹³çš„é…ç½®ï¼Œè€Œæ˜¯åˆ†å±‚çš„æ ‘çŠ¶ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹åŒ…å« `spec` (éœ€æ±‚) å’Œ `impl` (å®ç°)ã€‚

```typescript
interface IntentSpecV3 {
  id: string;
  title: string;
  version: string;

  // ä¸‰å¤§ç»´åº¦
  ui: UIIntentNode[];
  logic: LogicIntentNode[];
  module: ModuleIntentNode[];

  // å…¨å±€çº¦æŸ
  constraints?: {
    performance?: PerformanceBudget;
    security?: SecurityPolicy;
  };
}
```

## 2. UI Intent Schema

UI æ„å›¾æè¿°ç•Œé¢ç»“æ„ã€‚å®ƒæ˜¯ä¸€æ£µç»„ä»¶æ ‘ã€‚

```typescript
interface UIImplConfig {
  component: string; // ç»„ä»¶åæˆ– Pattern èµ„äº§ IDï¼ˆå¹³å°å±‚æ¦‚å¿µï¼‰
  props: Record<string, any>;
  slots?: Record<string, string>; // æ’æ§½æ˜ å°„åˆ°å­èŠ‚ç‚¹ ID

  // ä¿¡å·å‘å°„é…ç½®
  emits?: Record<string, { _tag: string, payload?: any }>; // e.g. { onClick: { _tag: 'submitOrder' } }

  // è§†è§‰äº¤äº’çŠ¶æ€ (Visual State)
  state?: Record<string, any>; // e.g. { isOpen: false }
}
```

## 3. Logic Intent Schema (Intent Graph)

Logic æ„å›¾æè¿°ä¸šåŠ¡æµç¨‹ã€‚åœ¨ v3 ä¸­ï¼Œ**Code is Truth**ã€‚Logic Intent Schema å®é™…ä¸Šæ˜¯ Parser ä»æºç ä¸­æå–çš„ **Memory AST**ï¼Œç”¨äºå¯è§†åŒ–æ¸²æŸ“ã€‚

```typescript
interface LogicImplConfig {
  // è§¦å‘å™¨
  trigger: {
    type: 'onAction';
    actionTag: string; // e.g. 'submitOrder'
    payloadSchema?: JSONSchema;
  };

  // æºç å¼•ç”¨ (The Truth)
  source: {
    file: string;
    exportName: string;
  };

  // å†…å­˜å›¾ç»“æ„ (The View)
  // ä»…ç”¨äºç”»å¸ƒæ¸²æŸ“ï¼Œä¸æŒä¹…åŒ–å­˜å‚¨
  graph: {
    nodes: Record<string, LogicNode>;
    edges: LogicEdge[];
  };
}

type LogicNode =
  // åŸºäº Effect çš„é•¿é€»è¾‘å°è£…ï¼ˆpattern-styleï¼‰ï¼š(input) => Effect
  | { type: 'effect-block'; fnName: string; config?: any }
  // Flow ä¾§éª¨æ¶èŠ‚ç‚¹ï¼šå›´ç»• actions$ / state çš„æ—¶åºä¸å¹¶å‘è¯­ä¹‰
  | { type: 'flow-op'; op: 'debounce' | 'throttle' | 'filter'
      | 'run' | 'runLatest' | 'runExhaust' }
  // Control ä¾§éª¨æ¶èŠ‚ç‚¹ï¼šå›´ç»• Effect çš„ç»“æ„åŒ–æ§åˆ¶æµ
  | { type: 'control-op'; op: 'branch' | 'tryCatch' | 'parallel' }
  // å…¶å®ƒæ— æ³•ç»“æ„åŒ–å±•å¼€çš„ä»£ç å—ï¼ˆé»‘ç›’ï¼‰
  | { type: 'code-block'; content: string };

// å…ƒæ•°æ®ï¼šç”¨äºæ”¯æŒå…¨åŒå·¥åŒæ­¥
interface NodeMetadata {
  source?: {
    file: string;
    line: number;
    hash: string; // å†…å®¹æŒ‡çº¹ï¼Œç”¨äºæ£€æµ‹äººå·¥ä¿®æ”¹
  };
  visual?: {
    x: number;
    y: number;
    collapsed?: boolean;
  };
}
```

## 4. Module Intent Schema

Module æ„å›¾æè¿°æ•°æ®æ¨¡å‹å’ŒæœåŠ¡å¥‘çº¦ã€‚

```typescript
interface ModuleImplConfig {
  name: string;

  // å®ä½“ / çŠ¶æ€å®šä¹‰ (æ˜ å°„ä¸º Effect.Schema)
  fields: Record<string, FieldSchema>;

  // æœåŠ¡å¥‘çº¦ (æ˜ å°„ä¸º Effect Service / Tag)
  services: Record<string, {
    args: FieldSchema[];
    return: FieldSchema | 'void';
    errors?: string[];
  }>;

  /**
   * å®ç°æ¥æºï¼š
   * - "module"ï¼šç”Ÿæˆ Logix.Module + ModuleImplï¼ˆå½¢å¦‚ Module.make({ initial, logics })ï¼‰ï¼›
   * - "pattern"ï¼šåŸºäº Pattern ç›´æ¥ç”Ÿæˆ ModuleImplï¼ˆä¾‹å¦‚ åœºæ™¯ Pattern -> ImplWithServiceï¼‰ï¼›
   * - "custom"ï¼šç”±ä¸šåŠ¡è‡ªå®šä¹‰è½ç‚¹ï¼Œä»…åœ¨ Schema å±‚è®°å½•ç»“æ„ã€‚
   *
   * åœ¨ runtime ä¸­ï¼ŒModuleImplConfig ä¼šè¢«è½å®ä¸ºï¼š
   * - ä¸€ä¸ª Module è“å›¾ï¼ˆModuleInstanceï¼‰ï¼›
   * - è‡³å°‘ä¸€ä¸ª ModuleImplï¼ˆé…ç½®å¥½çš„ initial/logics/Env ç»„åˆï¼‰ï¼›
   * - å¯é€‰çš„ withLayer ç»„åˆï¼ˆä¾‹å¦‚ Impl.withLayer(ServiceLayer)ï¼‰ã€‚
   */
  source?: {
    type: 'module' | 'pattern' | 'custom';
    config?: any;
  };
}
```

## 5. Logix Builder SDK (`@logix/builder`)

ä¸ºäº†æ”¯æŒ **pattern-style é•¿é€»è¾‘å°è£…**ï¼ŒLogix ä½“ç³»æä¾›äº†ä¸€å¥—åŸºäº Store / Logic / Flow çš„ Builder SDKã€‚å®ƒä¸æ˜¯å¦ä¸€ä¸ªè¿è¡Œæ—¶ï¼Œè€Œæ˜¯å¸®åŠ©å¼€å‘è€…ï¼ˆæˆ– LLMï¼‰æ›´å®¹æ˜“å†™å‡ºã€Œå¯è¢«å¹³å°ç†è§£çš„ `(input) => Effect` å‡½æ•°ã€ã€‚

è¯¦ç»†è®¾è®¡ä»å‚è€ƒï¼š**[Logix Builder SDK Design](../../runtime-logix/builder/01-builder-design.md)**ï¼Œä½†å½“å‰ v3 çš„çº¦å®šæ˜¯ï¼š

```typescript
import { Effect } from "effect";

// ç¤ºä¾‹ï¼šä½¿ç”¨ Builder å®šä¹‰ä¸€ä¸ª pattern-style æäº¤æµç¨‹
// å¯¹å¤–æš´éœ²çš„åªæ˜¯ (input) => Effect ç¨‹åºï¼Œæœ¬èº«ä¸å¼•å…¥ç¬¬äºŒå¥— Flow/Logic è¿è¡Œæ—¶ã€‚
export const runReliableSubmit = (input: { data: SubmitData }) =>
  Effect.gen(function* (_) {
    // å†…éƒ¨å¯ä»¥è°ƒç”¨ Module Service æˆ–å…¶å®ƒ pattern-style å‡½æ•°ï¼›
    // å¦‚éœ€ä¸ Logix ModuleRuntime / Flow äº¤äº’ï¼Œåˆ™ç”±è°ƒç”¨ä¾§åœ¨ Module.logic ä¸­é€šè¿‡ Bound API `$` è®¿é—® state / flow / controlã€‚
  });
```

**æ ¸å¿ƒä»·å€¼**ï¼š
1.  **åŒæ„ä½“éªŒ**ï¼špattern-style å‡½æ•°åœ¨è¯­è¨€å±‚é¢ä»åŸºäº Effect / Service / Configï¼Œä¸ä¸šåŠ¡ Logic ä½¿ç”¨çš„åŸè¯­ä¸€è‡´ï¼›åŒºåˆ«åªåœ¨äºå®ƒè¢«èµ„äº§åŒ–ä¸º `(input) => Effect`ã€‚
2.  **ç±»å‹å®‰å…¨**ï¼šåŸºäº TypeScript ä¸æœ¬åœ° `effect` d.ts çš„å¼ºç±»å‹æ¨å¯¼ã€‚
3.  **é€»è¾‘å¤ç”¨ (Composition)**ï¼šé•¿é€»è¾‘æœ¬è´¨æ˜¯ `(input) => Effect`ï¼Œå¯ä»¥åƒç§¯æœ¨ä¸€æ ·ç»„åˆï¼Œå¹¶åœ¨å¹³å°å±‚é€‰æ‹©æ€§èµ„äº§åŒ–ï¼ˆæŒ‚æ¥ id/configSchema ç­‰ metaï¼‰ã€‚
4.  **å›¾ç åŒæ­¥**ï¼šé€šè¿‡ Logic / Flow / Control åœ¨ä¸šåŠ¡ Logic ä¸­çš„æ ‡å‡†è°ƒç”¨ï¼ˆå¦‚ `flow.runLatest` / `$.match` ç­‰ï¼‰ï¼ŒParser å¯ä»¥ç¨³å®šè¯†åˆ«é€»è¾‘éª¨æ¶å¹¶æ¸²æŸ“ä¸ºå›¾ï¼›pattern-style å‡½æ•°åˆ™ä½œä¸ºå›¾ä¸­çš„ `effect-block` èŠ‚ç‚¹å‡ºç°ã€‚

## 6. è‡ªä¸Šè€Œä¸‹çš„èµ„äº§åˆ†å±‚ä¸å¤ç”¨è§†è§’

ä¸ºäº†åœ¨å¹³å°åŒ–ä¸èµ„äº§å¤ç”¨é˜¶æ®µä¿æŒä¸€è‡´çš„è¯­è¨€ï¼Œæœ¬èŠ‚ä»â€œè‡ªä¸Šè€Œä¸‹â€çš„è§’åº¦ç»™å‡ºèµ„äº§åˆ†å±‚è§†å›¾ï¼Œè¡¥å……å‰æ–‡ä»è¿è¡Œæ—¶/å®ç°è§’åº¦ç»™å‡ºçš„åˆ†ç±»ã€‚

å¯ä»¥ç²—ç•¥å°†èµ„äº§åˆ†ä¸ºå››ä¸ªå±‚çº§ï¼Œå¯¹åº”ä»â€œä¸šåŠ¡éœ€æ±‚â€åˆ°â€œè¿è¡Œæ—¶ä»£ç â€çš„æ¸è¿›æ¼”åŒ–ï¼š

### 6.1 Level 0ï¼šä¸šåŠ¡éœ€æ±‚èµ„äº§ï¼ˆBusiness Requirementï¼‰

- å½¢æ€ï¼šéœ€æ±‚æ–‡æ¡£ / ç”¨æˆ·æ•…äº‹ / PRD ç‰‡æ®µï¼Œé€šå¸¸è®°è¿°ä¸ºâ€œå½“ X å‘ç”Ÿï¼Œè‹¥æ»¡è¶³ Yï¼Œåˆ™ç³»ç»Ÿåº” Zâ€ã€‚
- èµ„äº§ç¤ºä¾‹ï¼š
  - æœç´¢ç»“æœç¬¬ä¸€æ¡åº”åœ¨å³ä¾§è¯¦æƒ…å±•ç¤ºï¼›
  - å®¡æ‰¹é€šè¿‡æ—¶è®°å½•å®¡è®¡æ—¥å¿—å¹¶åˆ·æ–°å¾…åŠåˆ—è¡¨ï¼›
  - ç”¨æˆ·åˆ‡æ¢å›½å®¶æ—¶æ¸…ç©ºçœä»½å’ŒåŸå¸‚ã€‚
- å¤ç”¨æ–¹å¼ï¼š
  - é€šè¿‡ã€Œéœ€æ±‚æ¨¡æ¿ / ç”¨ä¾‹åº“ã€å¤ç”¨ï¼šä¸ºå¸¸è§ä¸šåŠ¡åœºæ™¯æä¾›ç»“æ„åŒ–çš„æè¿°æ¨¡æ¿ï¼Œä¾¿äºåœ¨æ–°é¡¹ç›®ä¸­å¿«é€Ÿâ€œå«å‡ºâ€ç±»ä¼¼éœ€æ±‚ï¼›
  - åœ¨å¹³å°ä¾§ï¼Œä¸ `IntentSpecV3` çš„é¡¶å±‚å­—æ®µï¼ˆ`ui / logic / domain / constraints`ï¼‰å¯¹é½ã€‚

### 6.2 Level 1ï¼šéœ€æ±‚æ„å›¾èµ„äº§ï¼ˆRequirement Intent / Use Case Blueprintï¼‰

- å½¢æ€ï¼šå°† Level 0 çš„è‡ªç„¶è¯­è¨€éœ€æ±‚æŠ•å½±åˆ° v3 ä¸‰ç»´ Intent æ¨¡å‹ä¸ Logic Intent Graph ä¸Šï¼Œå½¢æˆâ€œç”¨ä¾‹çº§è“å›¾â€ï¼š
  - æ˜ç¡®æ¶‰åŠå“ªäº› UI/Interaction èŠ‚ç‚¹ã€å“ªäº› Module å®ä½“/å­—æ®µã€å“ªäº› Logic æ­¥éª¤ï¼›
  - ä½¿ç”¨è¾ƒç²—ç²’åº¦çš„ `IntentRule` é›†åˆä½œä¸ºå†…éƒ¨è¡¨ç¤ºï¼ˆsource/sink å·²ç»‘å®šæ¨¡å—/å­—æ®µï¼Œä½† pipeline å¯ä»¥æš‚ç•™è‡ªç„¶è¯­è¨€æ³¨é‡Šï¼‰ã€‚
- èµ„äº§ç¤ºä¾‹ï¼š
  - â€œæœç´¢-è¯¦æƒ…è”åŠ¨è“å›¾â€ï¼šä¸€ç»„ä» Search.State/Action åˆ° Detail.Action çš„è§„åˆ™ï¼›
  - â€œå®¡æ‰¹æµè“å›¾â€ï¼šä¸€ç»„ä» UI äº¤äº’åˆ° Service è°ƒç”¨ä¸çŠ¶æ€æ›´æ–°çš„è§„åˆ™ã€‚
- å¤ç”¨æ–¹å¼ï¼š
  - åœ¨å¹³å° Galaxy è§†å›¾ä¸Šä½œä¸ºâ€œç”¨ä¾‹æ¨¡æ¿â€å‡ºç°ï¼Œé€šè¿‡å‚æ•°ï¼ˆæ¨¡å— IDã€å­—æ®µè·¯å¾„ã€ç­–ç•¥é€‰é¡¹ï¼‰åº”ç”¨åˆ°å…·ä½“é¡¹ç›®ï¼›
  - ä¸º Level 2 çš„å¼€å‘æ„å›¾æä¾›çº¦æŸä¸å‚è€ƒï¼Œä¸ç›´æ¥å†³å®šå…·ä½“ API å½¢æ€ã€‚

### 6.3 Level 2ï¼šå¼€å‘æ„å›¾èµ„äº§ï¼ˆDeveloper Intentï¼‰

- å½¢æ€ï¼šåœ¨ Level 1 è“å›¾çš„åŸºç¡€ä¸Šï¼Œè½åˆ°å…·ä½“çš„ Module / Pattern / Intent API é€‰æ‹©ä¸Šï¼š
  - ç¡®å®šä½¿ç”¨å“ªäº› Logix.ModuleShape / Logic / Spec æ¨¡å—ï¼›
  - ä¸ºæ¯æ¡è§„åˆ™é€‰æ‹©å¯¹åº”çš„è¡¨ç°å½¢å¼ï¼š
    - L1ï¼šå• Store å†…åŒæ­¥è”åŠ¨ â€”â€” ä»£ç ä¾§æ¨èä½¿ç”¨ Fluent DSLï¼ˆ`$.onState / $.onAction + $.state.update/mutate`ï¼‰ï¼Œåœ¨ IR ä¸­æ˜ å°„ä¸º L1 IntentRuleï¼›
    - L2ï¼šè·¨ Store åä½œ â€”â€” ä»£ç ä¾§æ¨èä½¿ç”¨ Fluent DSLï¼ˆ`$.use(StoreSpec) + Fluent DSLï¼ˆ$Other.changes/â€¦ â†’ $SelfOrOther.dispatchï¼‰`ï¼‰ï¼Œåœ¨ IR ä¸­æ˜ å°„ä¸º L2 IntentRuleï¼ˆCoordinateï¼‰ï¼›
    - L3ï¼šå¤æ‚ Flow/Pattern ç»„åˆ â€”â€” ç›´æ¥ä½¿ç”¨ `Flow.*` / Pattern / Effect ç»„åˆï¼Œå¹³å°è§†ä¸ºéƒ¨åˆ†å¯è§£ææˆ– Gray/Black Boxï¼›
  - å½¢æˆç»“æ„åŒ–ã€å¯å‡ºç çš„ `IntentRule` é›†åˆã€‚
 - èµ„äº§ç±»å‹ï¼š
  - **Pattern èµ„äº§**ï¼š`(input) => Effect` è¡Œä¸ºç§¯æœ¨ï¼Œé…æœ‰ `configSchema` ä¸ metaï¼Œå¯åœ¨å¤šä¸ªæ¨¡å—/é¡¹ç›®ä¸­å¤ç”¨ï¼›
  - **Logic æ¨¡æ¿**ï¼šé’ˆå¯¹æŸä¸€ç±»åœºæ™¯çš„ Logic ç¨‹åºå€¼ï¼ˆå¦‚æ ‡å‡†æœç´¢åœºæ™¯ Logicï¼‰ï¼Œé€‚åˆåœ¨ä¸€ä¸ªäº§å“çº¿å†…éƒ¨å¤ç”¨ï¼›
  - **Module æ¨¡æ¿**ï¼šåŒ…å«ç‰¹å®š State/Action å½¢çŠ¶ä¸ä¸€ç»„ Logic çš„â€œæ¨¡å—çº§æ¨¡æ¿â€ï¼ˆå¦‚æ ‡å‡†åˆ†é¡µåˆ—è¡¨ Moduleï¼‰ï¼›
  - **IntentRule é›†åˆ**ï¼šä¸€ä¸ªæ¨¡å—å†…æˆ–è·¨æ¨¡å—çš„å®Œæ•´è§„åˆ™è¡¨ã€‚
- å¤ç”¨æ–¹å¼ï¼š
  - Pattern ä¸ IntentRule é›†åˆæ˜¯å¹³å°åŒ–çš„é¦–é€‰èµ„äº§ï¼Œé€‚åˆåœ¨å›¢é˜Ÿ/å¤šé¡¹ç›®é—´å…±äº«ï¼›
  - Logic/Store æ¨¡æ¿æ›´åƒæ˜¯â€œä¸­å±‚æ¨¡æ¿â€ï¼Œé€‚åˆåœ¨å•é¡¹ç›®æˆ–å•æ¡äº§å“çº¿å†…å¤ç”¨ï¼Œå¹¶åœ¨å®è·µéªŒè¯åé€æ­¥æç‚¼å‡ºæ›´é€šç”¨çš„ Pattern/Blueprintã€‚

### 6.4 Level 3ï¼šå®ç°èµ„äº§ï¼ˆImplementation / Codeï¼‰

- å½¢æ€ï¼šå…·ä½“é¡¹ç›®ä¸­çš„ Module / Logic / Pattern / UI ä»£ç ä¸è¿è¡Œæ—¶é…ç½®ï¼š
  - ç±»å‹å®‰å…¨çš„ State/Action Schemaã€`Logix.Module('Id', { state, actions })` å®šä¹‰ä¸å¯¹åº”çš„ `Module.logic(($) => Effect.gen(...))` è°ƒç”¨ï¼›
  - Logic ç¨‹åºä¸­çš„ `Effect.gen` é€»è¾‘ï¼Œç»“åˆ Fluent DSLï¼ˆ`$.onState` / `$.onAction` / `$.on`ï¼‰/ Flow / Controlï¼ŒIR å±‚ç»Ÿä¸€ä½¿ç”¨ `IntentRule` è¡¨è¾¾è¯­ä¹‰ï¼›
  - Pattern å®ç°æ–‡ä»¶ã€æµ‹è¯•ç”¨ä¾‹ä¸ React ç»‘å®šä»£ç ã€‚
- å¤ç”¨æ–¹å¼ï¼š
  - ä»¥æ™®é€šå·¥ç¨‹æ–¹å¼æ‹·è´/æ”¹é€ ï¼›
  - æ›´æ¨èåœ¨æ—¥å¸¸å¼€å‘ä¸­â€œä» Level 3 åå‘æç‚¼å‡º Level 2/1 èµ„äº§â€ï¼š
    - å°†ç»å¸¸è¢« Copy çš„è¡Œä¸ºé€»è¾‘æç‚¼ä¸º Patternï¼›
    - å°†ç¨³å®šçš„æ¨¡å—åä½œå…³ç³»æç‚¼ä¸º Use Case Blueprint ä¸ IntentRule é›†åˆï¼›
    - å°†é«˜é¢‘éœ€æ±‚è¡¨è¿°æ–¹å¼å½’æ¡£ä¸º Level 0 çš„éœ€æ±‚æ¨¡æ¿ã€‚

### 6.5 å¹³å°åŒ–æ—¶çš„å…³æ³¨é‡ç‚¹

åœ¨è§„åˆ’å¹³å°ä¸èµ„äº§å¤ç”¨æ—¶ï¼Œå¯æŒ‰ç…§å±‚çº§å†³å®šâ€œä¼˜å…ˆå¹³å°åŒ–çš„å¯¹è±¡â€ï¼š

- **ä¼˜å…ˆçº§ 1ï¼šPattern + IntentRule é›†åˆï¼ˆLevel 2ï¼‰**
  - è¿™æ˜¯ã€Œå¼€å‘æ„å›¾ã€å±‚çš„ä¸»åŠ›èµ„äº§ï¼Œæ—¢ä¸è¿è¡Œæ—¶ä»£ç ç´§å¯†ç›¸å…³ï¼Œåˆè¶³å¤ŸæŠ½è±¡ã€æ˜“äºé…ç½®ã€‚
- **ä¼˜å…ˆçº§ 2ï¼šUse Case Blueprintï¼ˆLevel 1ï¼‰**
  - é¢å‘ PM/æ¶æ„å¸ˆçš„â€œä¸šåŠ¡ç”¨ä¾‹è“å›¾â€ï¼Œé€‚åˆåœ¨ Galaxy è§†å›¾ä¸­ä½œä¸ºèµ·ç‚¹ï¼Œé€šè¿‡å‚æ•°åŒ–æ´¾ç”Ÿå¤šä¸ªé¡¹ç›®å†…çš„å®ç°ã€‚
- **ä¼˜å…ˆçº§ 3ï¼šLogic/Store æ¨¡æ¿ï¼ˆLevel 2 / 3 ä¹‹é—´ï¼‰**
  - æ›´é€‚åˆä½œä¸ºæŸæ¡äº§å“çº¿å†…éƒ¨çš„æ¨¡æ¿ï¼Œç»è¿‡å®é™…é¡¹ç›®æ‰“ç£¨åï¼Œå†è€ƒè™‘éƒ¨åˆ†å†…å®¹ä¸Šå‡ä¸º Pattern/Blueprintã€‚
- **Level 0 æ¨¡æ¿**
  - ç”¨äºæ”¯æ’‘ä»éœ€æ±‚æ–‡æ¡£åˆ° IntentSpec çš„ç»“æ„åŒ–å½•å…¥ï¼Œå±äºå¹³å° UX å±‚é¢çš„å»ºè®¾ï¼Œä¸ç›´æ¥å‚ä¸è¿è¡Œæ—¶ä»£ç ç”Ÿæˆã€‚

æœ¬èŠ‚è§†å›¾ä¸æ˜¯å¯¹å‰æ–‡èµ„äº§åˆ†ç±»çš„æ›¿ä»£ï¼Œè€Œæ˜¯ä»â€œä¸šåŠ¡éœ€æ±‚ â†’ æ„å›¾ â†’ å®ç°â€çš„é“¾è·¯å‡ºå‘ï¼Œä¸ºåç»­å¹³å°åŒ–ä¸èµ„äº§è¿è¥æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å‚ç…§ç»´åº¦ã€‚***
</file>

<file path="intent-driven-ai-coding/v3/03-module-assets.md">
# Module Assets (Intent Layer)

> **Status**: Draft (v3 Proposal)
> **Date**: 2025-11-28
> **Scope**: Intent-Driven AI Coding / Asset Definition

## 1. æ ¸å¿ƒæ¦‚å¿µï¼šModule as Asset

åœ¨ Logix v3 çš„ Intent æ¶æ„ä¸­ï¼Œ**Module** æ˜¯æè¿°ä¸šåŠ¡é¢†åŸŸè¾¹ç•Œå’Œèƒ½åŠ›çš„**èµ„äº§å¯¹è±¡ï¼ˆAsset Objectï¼‰**ã€‚

å®ƒä½äº **Intent Layer**ï¼Œè´Ÿè´£å®šä¹‰â€œæ˜¯ä»€ä¹ˆâ€ï¼ˆSchema/Actionsï¼‰ï¼Œè€Œè¿è¡Œæ—¶å±‚è´Ÿè´£â€œæ€ä¹ˆè·‘â€ï¼ˆExecution/State Managementï¼‰ã€‚

### 1.1 èŒè´£åˆ†ç¦»

| æ¦‚å¿µ | å±‚çº§ | èŒè´£ | äº§ç‰© |
| :--- | :--- | :--- | :--- |
| **Module** | Intent (L1) | å®šä¹‰æ•°æ®å½¢çŠ¶ã€äº¤äº’å¥‘çº¦ã€é€»è¾‘è§„æ ¼ | `Module` å¯¹è±¡ (SSOT) |
| **Runtime** | Runtime (L0) | æä¾›çŠ¶æ€å®¹å™¨ã€åˆ†å‘åŠ¨ä½œã€ç®¡ç†å‰¯ä½œç”¨ | è¿è¡Œæ—¶å®¹å™¨å®ä¾‹ |

## 2. ä»£ç å±‚æ˜ å°„ï¼šModule â†” Logix.Module

åœ¨å½“å‰ v3 è§„åˆ’ä¸­ï¼Œæˆ‘ä»¬**ä¸å†å•ç‹¬å¼•å…¥ `Module.define` ä½œä¸ºä»£ç  API**ï¼Œè€Œæ˜¯çº¦å®šï¼š

- åœ¨ä»£ç å±‚ï¼Œ**ä¸€ä¸ªé¢†åŸŸèµ„äº§ç”± `Logix.Module` è¡¨ç¤º**ï¼›
- åœ¨æ¦‚å¿µå±‚ï¼Œæˆ‘ä»¬ä»ç„¶ç§°ä¹‹ä¸ºâ€œæŸä¸ªé¢†åŸŸçš„ Module èµ„äº§â€ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼š

```ts
import { Schema } from 'effect';
import { Logix } from '@logix/core';

// é¢†åŸŸèµ„äº§ï¼ˆModule Assetï¼‰ï¼šè®¡æ•°å™¨
export const Counter = Logix.Module('Counter', {
  state: Schema.Struct({
    count: Schema.Number,
  }),
  actions: Schema.Union(
    Schema.Struct({ _tag: Schema.Literal('inc') }),
    Schema.Struct({ _tag: Schema.Literal('dec') }),
  ),
});
```

è¿™é‡Œçš„ `Counter` åŒæ—¶æ‰®æ¼”ï¼š

- é¢†åŸŸèµ„äº§ï¼ˆModuleï¼‰ï¼šä» Intent è§†è§’ï¼Œè¿™æ˜¯æè¿° Counter é¢†åŸŸçš„â€œå¥‘çº¦å¯¹è±¡â€ï¼›
- Module å®šä¹‰ï¼šä» Runtime è§†è§’ï¼Œå®ƒæä¾› State/Action å½¢çŠ¶ä¸ Logic å…¥å£ï¼›
- Tagï¼šä» Env/DI è§†è§’ï¼Œå®ƒå¯ä»¥è¢« `$.use(Counter)` å¼•ç”¨ï¼Œç”¨äºè·¨æ¨¡å—åä½œã€‚

## 3. ä¸ Logic çš„å…³ç³»ï¼š`Module.logic(($) => ...)`

Logic ä¸ç›´æ¥ä¾èµ–æŸä¸ªâ€œModule API å‡½æ•°å®¶æ—â€ï¼Œè€Œæ˜¯é€šè¿‡ `Module.logic(($)=>Effect)` åœ¨é¢†åŸŸèµ„äº§ä¸ŠæŒ‚è½½é€»è¾‘ï¼š

```ts
// Counter.logic.ts
import { Effect } from 'effect';
import { Counter } from './counter.module';

export const CounterLogic = Counter.logic(($) =>
  Effect.gen(function* () {
    // Action â†’ State
    yield* $.onAction((a): a is { _tag: 'inc' } => a._tag === 'inc').then(
      $.state.update(prev => ({ ...prev, count: prev.count + 1 })),
    );

    // State â†’ State
    yield* $.onState(s => s.count).then(
      Effect.logInfo('Count changed'),
    );
  }),
);
```

åœ¨è¿™ä¸ªæ¨¡å‹ä¸‹ï¼š

- é¢†åŸŸèµ„äº§ï¼ˆCounter Moduleï¼‰åœ¨ä»£ç ä¸­å¯¹åº”äº `Counter`ï¼ˆä¸€ä¸ª `Logix.Module` å€¼ï¼‰ï¼›
- Logic é€šè¿‡ `Module.logic(($)=>...)` æ³¨å…¥ Bound APIï¼ˆ`$`ï¼‰å¹¶ä¸è¯¥é¢†åŸŸç´§å¯†ç»‘å®šï¼›
- å¹³å°å¯ä»¥ç›´æ¥å°† `Counter` è§†ä¸º Module èµ„äº§ï¼Œç”¨äºæ„å»º Universe View å’Œ IntentRule å›¾ã€‚

## 4. è¿è¡Œæ—¶æŠ•å½±ï¼š`Module.live`

åœ¨è¿è¡Œæ—¶ï¼Œé¢†åŸŸèµ„äº§æœ€ç»ˆä¼šè¢«æŠ•å½±ä¸ºè¿è¡Œæ—¶å®¹å™¨å®ä¾‹ã€‚v3.1 ä¹‹åï¼Œè¿™ä¸€æ­¥é€šè¿‡ `Module.live` å®Œæˆï¼š

```ts
// Counter.module.ts
export const Counter = Logix.Module('Counter', {
  state: CounterStateSchema,
  actions: CounterActionSchema,
});

// Counter.logic.ts
export const CounterLogic = Counter.logic(/* ... */);

// Counter.live.ts
export const CounterLive = Counter.live(
  { count: 0 },
  CounterLogic,
);
```

> **æ€»ç»“**
> - æ¦‚å¿µå±‚ï¼šModule æ˜¯ Intent/Asset è§†è§’ä¸‹çš„é¢†åŸŸæ¨¡å—ï¼›
> - ä»£ç å±‚ï¼šModule ç”± `Logix.Module('Id', { state, actions })` è¡¨ç¤ºï¼›
> - è¿è¡Œæ—¶å±‚ï¼šModule é€šè¿‡ `Module.live(initial, ...logics)` æŠ•å½±ä¸ºå¯æ³¨å…¥çš„è¿è¡Œæ—¶ Layerã€‚
>
> æˆ‘ä»¬åˆ»æ„é¿å…å¼•å…¥é¢å¤–çš„ `Module.define` APIï¼Œä»¥ä¿è¯æ¶æ„åªæœ‰ä¸€å¥—å®šä¹‰å…¥å£ï¼Œå‡è½»åç»­ç»´æŠ¤ä¸æ¼”è¿›æˆæœ¬ã€‚
</file>

<file path="intent-driven-ai-coding/v3/04-intent-to-code-example.md">
---
title: 04 Â· ä»æ„å›¾åˆ°ä»£ç ï¼šv3 æ¼”ç»ƒ (Example)
status: draft
version: 11 (Effect-Native)
---

> æœ¬æ–‡æ¡£é€šè¿‡ä¸€ä¸ªâ€œä¹è§‚æ›´æ–°çš„ç‚¹èµæŒ‰é’®â€ç¤ºä¾‹ï¼Œå±•ç¤ºåœ¨ **Effect-Native** æ¶æ„ä¸‹ï¼Œæ„å›¾æ˜¯å¦‚ä½•ä» Spec æ˜¾å½±ä¸ºå¸¦æœ‰ **å…¨åŒå·¥é”šç‚¹** çš„é«˜è´¨é‡ä»£ç çš„ã€‚

## åœºæ™¯ï¼šç‚¹èµ (Toggle Like)

### 1. Module Intent (è®°å¿†)

**Spec**: â€œæ–‡ç« å®ä½“åŒ…å«ç‚¹èµçŠ¶æ€ã€‚éœ€è¦ä¸€ä¸ªç‚¹èµæœåŠ¡ã€‚â€

**Generated Code (Effect Tag)**:
```typescript
// src/domain/article/service.ts
// @intent-entity: Article
export interface ArticleService {
  toggleLike: (id: string) => Effect.Effect<void, Error>;
}
export class ArticleServiceTag extends Context.Tag('ArticleService')<ArticleServiceTag, ArticleService>() {}
```

### 2. UI Intent (èº¯å£³)

**Spec**: â€œä¸€ä¸ªçˆ±å¿ƒæŒ‰é’®ï¼Œç‚¹å‡»åˆ‡æ¢çŠ¶æ€ã€‚â€

**Generated Code (React Component)**:
```tsx
// src/ui/LikeButton.tsx
import { useModule, useDispatch } from '@logix/react';
import { ArticleModule } from '@/features/article/store'; // Corrected path to ArticleModule

export const LikeButton = () => { // Kept component name as LikeButton for consistency with the example
  // 1. è·å– Runtime (Stable)
  const runtime = useModule(ArticleModule);
  const dispatch = useDispatch(runtime);

  // 2. è®¢é˜…çŠ¶æ€
  const liked = useModule(ArticleModule, s => s.liked); // Subscribing to 'liked' state

  return (
    <IconButton
      icon="heart"
      active={liked}
      onClick={() => dispatch({ _tag: 'toggleLike' })}
    />
  );
};
```

### 3. Logic Intent (çµé­‚)

**Spec**: â€œç‚¹å‡»åç«‹å³å˜è‰²ï¼ˆä¹è§‚æ›´æ–°ï¼‰ï¼Œç„¶åè°ƒæ¥å£ã€‚å¤±è´¥åˆ™å›æ»šå¹¶æç¤ºã€‚â€

**Generated Code (Logix Program with Anchors)**:
> æ³¨æ„ï¼šä»£ç é‡‡ç”¨äº† Module-first + Fluent Intent (`$.onAction().then(...)`) çš„ Effect-Native é£æ ¼ï¼ŒLogic æœ¬èº«æ˜¯è¿è¡Œåœ¨å…¶ä¸Šçš„é•¿ç”Ÿå‘½å‘¨æœŸ Effect ç¨‹åºã€‚

```typescript
// src/features/article/store.ts
import { Effect } from 'effect';
import { Logix } from '@logix/core';
import { ArticleServiceTag } from '@/domain/article/service';
import { OptimisticToggle } from '@patterns/common';

// 1. å®šä¹‰é¢†åŸŸ Moduleï¼ˆstate/actions å½¢çŠ¶ï¼‰
export const ArticleModule = Logix.Module('Article', {
  state: ArticleStateSchema,
  actions: ArticleActionSchema,
});

// 2. å®šä¹‰ Logic ç¨‹åºï¼ˆåŸºäº Fluent Intent + Patternï¼‰
export const ArticleLogic = ArticleModule.logic(($) =>
  Effect.gen(function* () {
    // @intent-rule: toggle-like { x: 100, y: 200 }
    yield* $.onAction(
      (a): a is { _tag: 'toggleLike'; payload: { id: string } } => a._tag === 'toggleLike',
    ).then(
      // ä½¿ç”¨ Pattern å¤ç”¨é€»è¾‘
      OptimisticToggle({
        statePath: 'liked',
        action: (ctx) =>
          Effect.gen(function* () {
            const service = yield* $.use(ArticleServiceTag);
            yield* service.toggleLike(ctx.payload.id);
          }),
      }),
      { mode: 'exhaust' },
    );
  }),
);

// 3. ç»„è£… Module Liveï¼ˆåŸºäºé¢†åŸŸå®šä¹‰ + Logic ç¨‹åºï¼‰
export const ArticleLive = ArticleModule.live(
  {
    status: 'idle',
    title: '',
    content: '',
  },
  ArticleLogic,
);
```

### 4. æ€»ç»“

é€šè¿‡å¼•å…¥ **Effect-Native** æ¶æ„ï¼š
1.  **çº¯ç²¹æ€§**ï¼šé€»è¾‘å®šä¹‰å®Œå…¨åŸºäº Effect å’Œ Streamï¼Œæ²¡æœ‰é»‘ç›’é…ç½®ã€‚
2.  **å¤ç”¨æ€§**ï¼š`Flow.run(Logic.run(Pattern))` ä½œä¸ºâ€œé»˜è®¤ä¸²è¡ŒæŒ‚è½½ç‚¹â€ï¼Œä½¿å¾—ä¸šåŠ¡ç§¯æœ¨çš„ç»„åˆä¸å¤ç”¨å˜å¾—è‡ªç„¶ã€å¯é¢„æœŸï¼›éœ€è¦é«˜ååæ—¶å¯ä»¥æ˜¾å¼é€‰æ‹© `Flow.runParallel(...)` ç­‰å˜ä½“ã€‚
3.  **å…¨åŒå·¥**ï¼šParser ä¾ç„¶å¯ä»¥é€šè¿‡è¯†åˆ« `Flow.from(...).pipe(...)` ç»“æ„ï¼Œå°†è¿™æ®µçº¯ä»£ç è¿˜åŸä¸ºå¯è§†åŒ–çš„æµç¨‹å›¾ã€‚
</file>

<file path="intent-driven-ai-coding/v3/06-codegen-and-parser.md">
---
title: 06 Â· å…¨åŒå·¥å¼•æ“ï¼šé™æ€åˆ†æä¸é”šç‚¹ç³»ç»Ÿ (The Full-Duplex Engine)
status: draft
version: 15 (Effect-Native Â· Fluent DSL)
---

> **æ ¸å¿ƒç›®æ ‡**ï¼šå®ç° Intent (å›¾) ä¸ Code (ç ) çš„**æ— æŸåŒå‘åŒæ­¥**ã€‚
> åœ¨ v3 æœ€ç»ˆæ¶æ„ï¼ˆContext is Worldï¼‰ä¸‹ï¼ŒParser èšç„¦äºè¯†åˆ« **Module + Fluent Intent é“¾**ï¼Œå¹¶å°†å…¶æ˜ å°„ä¸ºç¨³å®šçš„ IntentRule IRã€‚

## 1. æ ¸å¿ƒç†å¿µï¼šæ¶æ„å³è§†å›¾ (Architecture as View)

æˆ‘ä»¬ä¾ç„¶ä¸è¯•å›¾è§£ææ¯ä¸€è¡Œä»£ç ï¼Œè€Œæ˜¯åªå…³æ³¨æ¶æ„éª¨æ¶ï¼Œä½†éª¨æ¶çš„é”šç‚¹å·²ç»æ¼”è¿›ä¸ºï¼š

- **Module å®šä¹‰ä¸ Logic å…¥å£**ï¼šè¯†åˆ« `Logix.Module` å®šä¹‰ä¸ `Module.logic(($) => ...)` å½¢å¼çš„ Logicï¼›
- **Fluent Intent é“¾**ï¼šè¯†åˆ« `yield* $.onState(...).op().then(...)` / `$.onAction(...)` / `$.on(streamFromHandle)...then(...)` ç»“æ„ï¼›
- **ä¾èµ–ä¸ä¸Šä¸‹æ–‡**ï¼šè¯†åˆ« `yield* $.use(ModuleOrService)` æ„å»ºæ¨¡å—ä¾èµ–å›¾ä¸ç¬¦å·è¡¨ã€‚

æ¢è¨€ä¹‹ï¼š
> å¯¹ Parser æ¥è¯´ï¼Œ**Bound API (`$`) + Fluent DSL å°±æ˜¯â€œå¯è§†æ¶æ„â€æœ¬èº«**ã€‚
> å…¶ä»– Effect / Stream ä»£ç è§†ä¸ºç»†èŠ‚å®ç°ï¼Œé»˜è®¤é™çº§ä¸º Gray/Black Boxã€‚

## 2. é™æ€åˆ†æå¼•æ“ (The Static Analysis Engine)

### 2.1 è¯†åˆ«è§„åˆ™ (Recognition Rules)

Parser é€šè¿‡è¯†åˆ«ç‰¹å®šçš„ **AST Pattern** æ¥æå–è¯­ä¹‰ï¼š

1.  **Module å®šä¹‰ä¸ Logic å…¥å£**
   - åŒ¹é… `Logix.Module("Id", { state, actions })`ï¼Œæå–ï¼š
     - Module æ ‡è¯†ï¼ˆIdï¼‰ï¼›
     - State/Action Schemaï¼ˆç”¨äº Shape ä¸ IR è¡€ç¼˜è¿½è¸ªï¼‰ï¼›
   - åŒ¹é… `Module.logic(($) => Effect.gen(function* (_) { ... }))`ï¼Œå°†å…¶è§†ä¸ºä¸€ä¸ª Logic å•å…ƒï¼Œå¹¶ç»‘å®š `$` çš„ä¸Šä¸‹æ–‡ä¸ºå¯¹åº”çš„ Moduleã€‚

2.  **ä¾èµ–ç¬¦å·è¡¨ (`$.use`)**
   - æ‰«æ `const local = yield* $.use(ModuleOrService)`ï¼š
     - è‹¥å‚æ•°æ˜¯ Moduleï¼šè®°å½•ä¸º Module ä¾èµ–ï¼Œæ„å»º `$LocalModule` â†’ Module.Id çš„æ˜ å°„ï¼›
     - è‹¥å‚æ•°æ˜¯ Service Tagï¼šè®°å½•ä¸º Service ä¾èµ–ã€‚
   - è¯¥ç¬¦å·è¡¨åœ¨åç»­ Fluent è§£æä¸­ç”¨äºåˆ¤å®š â€œæŸä¸ªé“¾æ¡çš„ Source/Sink å±äºå“ªä¸ª Store / Serviceâ€ã€‚

3.  **Fluent Intent é“¾ï¼ˆR-S-Tï¼‰**
   - ç™½ç›’æ¨¡å¼ä»…è¦†ç›–ä»¥ä¸‹ç›´æ¥è°ƒç”¨å½¢æ€ï¼ˆUnified Whenï¼‰ï¼š
     - `yield* $.onState(selector).op().then(...)`  // State Selector (Function)
     - `yield* $.onAction('actionType').op().then(...)` // Action Type (String Literal)
     - `yield* $.on(stream$).op().then(...)`   // Stream (Object/Identifier)
   - è§£ææµç¨‹ï¼š
     - **Rule (Source)**ï¼šæ ¹æ® `$.onState` / `$.onAction` / `$.on` çš„ä¸åŒAPIï¼Œç»“åˆç¬¦å·è¡¨ç¡®å®š Sourceï¼š
       - Function / ArrowFunction â†’ **State Source** (å½“å‰ Store)ï¼›
       - StringLiteral â†’ **Action Source** (å½“å‰ Store)ï¼›
       - Identifier / CallExpression â†’ **Stream Source** (éœ€ç»“åˆ `$.use` ç¬¦å·è¡¨æ¨å¯¼)ï¼›
     - **Strategy (Pipeline)**ï¼šåœ¨æœ‰é™ç™½ç›’ç®—å­å­é›†å†…ï¼ˆ`debounce` / `throttle` / `filter` / `map` ç­‰ï¼‰æå– `[{ op, args }]`ï¼›
     - **Target (Sink)**ï¼šåˆ†æ `then(effect, opts?)` å†…éƒ¨å¯¹ `$` / `$Handle` / Service çš„è°ƒç”¨ï¼Œè¯†åˆ«ï¼š
       - æœ¬ Store çŠ¶æ€å†™å…¥ï¼ˆ`$.state.mutate/update`ï¼‰ï¼›
       - æœ¬/ä»– Store Action æ´¾å‘ï¼ˆ`$Handle.actions.xxx(...)`ï¼‰ï¼›
       - Service è°ƒç”¨ï¼ˆ`yield* service.method(...)`ï¼‰ï¼›
       - å¹¶å‘ç­–ç•¥ï¼ˆ`opts.mode` â†’ run / runLatest / runExhaustï¼Œå…¶ä¸­ `"sequence"`ï¼ˆå¦‚å­˜åœ¨ï¼‰åœ¨è½åœ°æ—¶ç­‰ä»·æ˜ å°„ä¸º `run`ï¼‰ã€‚

4.  **Pattern æŒ‚è½½ï¼ˆå¯é€‰ï¼‰**
   - åœ¨ Fluent é“¾ä¸­ï¼Œå¦‚ `then(SomePattern(config))`ï¼ŒParser å°† `SomePattern` è§†ä¸º Pattern èŠ‚ç‚¹ï¼š
     - ä½¿ç”¨ `config` Schema ç”Ÿæˆå±æ€§é¢æ¿ï¼›
     - å°† Pattern è§†ä¸ºå¸¦æœ‰è¾“å…¥/è¾“å‡ºå¥‘çº¦çš„é€»è¾‘å—ï¼Œå…¶å†…éƒ¨å®ç°ä»å¯è§†ä¸ºé»‘ç›’ã€‚

    - **è§£æå¤æ‚åº¦æ³¨è®°**:
      - é€šè¿‡ `$.onState` / `$.onAction` / `$.on` ä¸‰ä¸ªç‹¬ç«‹APIï¼ŒAST åˆ†æå¯ä»¥ç›´æ¥è¯†åˆ«ç±»å‹ï¼Œç®€åŒ–äº† Parser å®ç°ã€‚
      - **çº¦æŸ**: ä¸ºç¡®ä¿ç™½ç›’è¯†åˆ«ï¼Œ`Action Type` å¿…é¡»æ˜¯å­—ç¬¦ä¸²å­—é¢é‡ï¼Œ`State Selector` å¿…é¡»æ˜¯å†…è”å‡½æ•°ã€‚å˜é‡å¼•ç”¨ä¼šå¯¼è‡´é™çº§ä¸º Stream Sourceï¼ˆéœ€æŸ¥ç¬¦å·è¡¨ï¼‰ã€‚

### 2.2 ç»“æ„åŒ–æ§åˆ¶æµ (Structural Control Flow)

é™¤äº†çº¿æ€§çš„ Fluent é“¾ï¼ŒParser è¿˜èƒ½è¯†åˆ«ä»¥ä¸‹ **ç»“æ„åŒ–èŠ‚ç‚¹**ï¼Œå®ƒä»¬åœ¨å›¾ä¸Šè¡¨ç°ä¸ºç‰¹æ®Šå½¢çŠ¶ï¼ˆè±å½¢ã€åˆ†å‰ç­‰ï¼‰ï¼Œè€Œéé»‘ç›’ä»£ç å—ã€‚

1.  **åˆ†æ”¯ (Branch / Switch)**
    - **AST Pattern**: `$.match(val).when(...).exhaustive()`
    - **Graph Node**: è±å½¢åˆ†æ”¯èŠ‚ç‚¹ (Switch Node)ã€‚
    - **è§£æé€»è¾‘**: æå–æ¯ä¸ª `.when(predicate, body)` ä¸­çš„ `body` ä½œä¸ºå­å›¾ (Subgraph)ã€‚

2.  **é”™è¯¯è¾¹ç•Œ (Error Boundary)**
    - **AST Pattern**: `Effect.catchTags(...)` / `Effect.catchAll(...)`
    - **Graph Node**: å®¹å™¨èŠ‚ç‚¹ (Boundary Node)ï¼ŒåŒ…è£¹ä¸»é€»è¾‘ï¼Œä¾§è¾¹æŒ‚è½½é”™è¯¯å¤„ç†åˆ†æ”¯ã€‚

3.  **å¹¶å‘ç»„ (Concurrency Group)**
    - **AST Pattern**: `Effect.all([...], { concurrency: ... })`
    - **Graph Node**: å¹¶è¡Œå®¹å™¨ (Parallel Node)ã€‚

### 2.3 é™çº§ç­–ç•¥ (Degradation Strategy)

ä¸ºä¿è¯è§£æå™¨å®ç°çš„ç®€æ´ä¸é²æ£’æ€§ï¼Œv3 é‡‡ç”¨ **æ˜¾å¼çš„ç™½ç›’/é»‘ç›’åˆ†ç•Œ**ï¼š

- **White Boxï¼ˆFluent Modeï¼‰**ï¼š
  - æ»¡è¶³ä»¥ä¸‹å…¨éƒ¨æ¡ä»¶çš„ Fluent é“¾è¢«è§†ä¸ºç™½ç›’ï¼š
    - ç›´æ¥å†™æˆå•æ¡ `yield* $.onState(...).op().then(...)` / `yield* $.onAction(...).op().then(...)` / `yield* $.on(...).op().then(...)` è°ƒç”¨ï¼ˆä¸æ‹†æˆä¸­é—´å˜é‡ï¼‰ï¼›
    - ä½¿ç”¨å—æ”¯æŒç®—å­å­é›†ï¼›
    - ä½¿ç”¨ `$.use` è·å–çš„ StoreHandle / Serviceï¼Œè€Œéæ‰‹å†™ Tag / Contextã€‚
  - Parser å¯¹ç™½ç›’é“¾æä¾›å®Œæ•´çš„ R-S-T è§£æä¸ IntentRule è¿˜åŸèƒ½åŠ›ã€‚

- **Black Boxï¼ˆRaw Modeï¼‰**ï¼š
  - ä»¥ä¸‹æƒ…å†µç»Ÿä¸€è§†ä¸º Raw Modeï¼š
    - ä»»æ„ `Flow.from(...).pipe(...)` / `stream.pipe(...)` é£æ ¼ä»£ç ï¼›
    - Fluent é“¾è¢«æ‹†è§£ä¸ºä¸­é—´å˜é‡ï¼š
      `const flow = $.onState(...).op(); yield* flow.then(...);`
    - å¤æ‚é—­åŒ… / åŠ¨æ€ç»„åˆå¯¼è‡´æ— æ³•ç¨³å®šè¯†åˆ« Source/Sinkã€‚
  - Raw Mode ä»…åœ¨å›¾ä¸Šå±•ç¤ºä¸º Code Blockï¼Œä¸å°è¯•è¿˜åŸ IntentRuleï¼›å¹³å°ä»…æä¾›â€œæ‰“å¼€ä»£ç ç¼–è¾‘â€çš„å…¥å£ã€‚

## 3. é”šç‚¹ç³»ç»Ÿ (The Anchor System)

v3 ä¹‹åï¼Œé”šç‚¹ç³»ç»Ÿä¸å†ä¾èµ–å¤§é‡é­”æ³•æ³¨é‡Šï¼Œè€Œæ˜¯ä»¥å†…å»ºç»“æ„ä¸ºä¸»ã€æ³¨é‡Šä¸ºè¾…ï¼š

1. **ä¸Šä¸‹æ–‡é”šç‚¹ï¼š`$` ä¸ Module**
   - å¯¹ Parser è€Œè¨€ï¼Œ`Logix.Module` + `.logic(($) => ...)` æ˜ç¡®æ ‡è®°äº† Logic çš„ä¸Šä¸‹æ–‡ï¼ˆModule Idï¼‰ï¼›
   - `$` ä½œä¸º Logic æ–‡ä»¶ä¸­å”¯ä¸€çš„ Bound API å…¥å£ï¼Œæ˜¯æ‰€æœ‰ Intent é“¾çš„èµ·ç‚¹ã€‚

2. **ä¾èµ–é”šç‚¹ï¼š`$.use`**
   - `$.use(ModuleOrService)` æ—¢æ˜¯è¿è¡Œæ—¶ä»£ç çš„ DI APIï¼Œä¹Ÿæ˜¯ Parser æ„å»ºä¾èµ–å›¾çš„å”¯ä¸€äº‹å®æºï¼›
   - æ‰€æœ‰è·¨ Module åä½œã€Service è°ƒç”¨éƒ½å¿…é¡»ç»è¿‡ `$.use`ï¼Œå¦åˆ™å¹³å°æ— æ³•æä¾›ç¨³å®šçš„æ‹“æ‰‘è§†å›¾ã€‚

3. **è§„åˆ™é”šç‚¹ï¼š`$.onState().then(...)` / `$.onAction().then(...)` / `$.on().then(...)`**
   - Fluent é“¾æœ¬èº«å°±æ˜¯ IntentRule çš„ç»“æ„åŒ–è¡¨è¾¾ï¼š
     - `when*` å¯¹åº” IR çš„ `source`ï¼›
     - é“¾ä¸Šçš„ç®—å­å¯¹åº” `pipeline`ï¼›
     - `then` å¯¹åº” `sink`ã€‚
   - åªæœ‰æ»¡è¶³ 2.1/2.2 ä¸­çº¦æŸçš„ Fluent é“¾æ‰è¢«è§†ä¸ºâ€œé”šç‚¹è§„åˆ™â€ï¼Œå…¶ä½™é€»è¾‘èŠ‚ç‚¹ç»Ÿä¸€é™çº§ã€‚

4. **å¹½çµæ³¨è§£ï¼ˆGhost Annotationsï¼Œå…œåº•æ‰‹æ®µï¼‰**
   - åœ¨æå°‘æ•°æ— æ³•é™æ€æ¨å¯¼ Sink å½’å±çš„åœºæ™¯ï¼Œå¯ä½¿ç”¨è½»é‡æ³¨é‡Šæç¤º Parserï¼š
     ```ts
     // @intent-sink dispatch:Auth
     yield* $.onState((s) => s.xxx)
       .then(dynamicDispatchEffect)
     ```
   - Ghost æ³¨è§£ä»…ä½œä¸ºå…œåº•ï¼Œä¸åº”æˆä¸ºä¸»æµç¼–ç¨‹æ–¹å¼ï¼›ä¸€æ—¦å¯ä»¥ç”¨ Fluent æ˜ç¡®è¡¨è¾¾ï¼Œåº”ä¼˜å…ˆæ”¹å†™ä¸ºç»“æ„åŒ–é“¾è·¯ã€‚

## 4. å…¨åŒå·¥å·¥ä½œæµ (The Workflow)

åœ¨æ–°çš„ Fluent æ¶æ„ä¸‹ï¼Œå…¨åŒå·¥å·¥ä½œæµå¯ä»¥æ›´ç²¾ç¡®åœ°æè¿°ä¸ºï¼š

1. **Code â†’ Graphï¼ˆFluent ä¼˜å…ˆï¼‰**
   - è§£æå…¥å£ï¼šæ‰«æ `Logix.Module` / `Module.logic(($) => ...)` / `$.use` / Fluent é“¾ï¼›
   - æ„å»ºè¿‡ç¨‹ï¼š
     - åŸºäº Module / use ç”Ÿæˆ Module/Service æ‹“æ‰‘ï¼›
     - åŸºäº Fluent é“¾ç”Ÿæˆ IntentRule é›†åˆï¼Œå¹¶å°†å…¶æŒ‚è½½åˆ°å¯¹åº” Module/Logic èŠ‚ç‚¹ä¸‹ï¼›
     - Raw Mode ä»£ç ä½œä¸º Code Block é™„ç€åœ¨èŠ‚ç‚¹ä¸Šã€‚

2. **Graph â†’ Codeï¼ˆGraph-First ç¼–è¾‘ï¼‰**
   - å½“ç”¨æˆ·åœ¨ Galaxy View ä¸­ç¼–è¾‘è§„åˆ™ï¼ˆå¢åŠ /åˆ é™¤è¿çº¿ã€ä¿®æ”¹é˜²æŠ–æ—¶é—´ã€åˆ‡æ¢å¹¶å‘ç­–ç•¥ç­‰ï¼‰æ—¶ï¼š
     - å¹³å°ç›´æ¥ä¿®æ”¹å¯¹åº” Fluent é“¾ä¸­çš„ `when* / op / then` è°ƒç”¨å‚æ•°ï¼›
     - ä¿è¯ä¿®æ”¹èŒƒå›´ä¸¥æ ¼é™å®šåœ¨ç™½ç›’å­é›†å†…ï¼Œé¿å…ç ´åæ‰‹å†™ä»£ç ç»“æ„ã€‚
   - å¯¹äº Raw Mode èŠ‚ç‚¹ï¼Œå¹³å°åªæä¾›â€œè·³è½¬ä»£ç â€ä¸â€œEject åˆ°ä»£ç â€çš„æ“ä½œï¼Œä¸æä¾›å¯è§†åŒ–ç¼–è¾‘ã€‚

3. **Eject to Codeï¼ˆæ˜¾å¼é™çº§ï¼‰**
   - ç”¨æˆ·å¯ä¸»åŠ¨é€‰æ‹©å°†æŸä¸ª Fluent è§„åˆ™â€œEject åˆ°ä»£ç â€ï¼š
     - å¹³å°ç”¨è§„èŒƒåŒ–æ¨¡æ¿å°† Fluent é“¾è½¬æ¢ä¸º `$.flow.fromX().pipe(..., run*)` æˆ–æ›´åº•å±‚çš„ Effect ç»„åˆï¼›
     - åœ¨èŠ‚ç‚¹ä¸Šæ‰“ä¸Šâ€œRawâ€æ ‡è®°ï¼ŒParser ä¸å†å°è¯•å°†å…¶è¿˜åŸä¸º Fluent Cardã€‚
   - è¯¥æ“ä½œæ˜¯å•å‘çš„ï¼šä¸€æ—¦ Ejectï¼Œå³è§†ä¸ºâ€œæ‰‹å†™ä»£ç ä¼˜å…ˆâ€ï¼Œå¹³å°åªç»´æŠ¤æœ€å°çš„ç»“æ„åŒ–ä¿¡æ¯ï¼ˆå¦‚æ‰€å± Store/Logicï¼‰ã€‚

é€šè¿‡ä»¥ä¸Šçº¦æŸä¸æµç¨‹ï¼Œæˆ‘ä»¬åœ¨ v3 è¾¾æˆäº†ï¼š
- å¯¹ä¸šåŠ¡ä½œè€…ï¼š**ä¸€ä¸ªå…¥å£ `$` + Fluent DSL å³æ˜¯å…¨éƒ¨**ï¼›
- å¯¹å¹³å°ï¼š**æœ‰é™ä¸”ç¨³å®šçš„ AST å­é›†å³å¯å®Œæ•´é‡å»º IntentRule ä¸ Logic Graph**ï¼›
- å¯¹è¿è¡Œæ—¶ï¼šåœ¨ä¸ç‰ºç‰² Effect åŸç”Ÿè¡¨è¾¾åŠ›çš„å‰æä¸‹ï¼Œå°†æ¶æ„å¤æ‚æ€§æŠ˜å å› Module å®šä¹‰ä¸ Bound API å†…éƒ¨ã€‚
</file>

<file path="intent-driven-ai-coding/v3/06-platform-ui-and-interactions.md">
# Platform UI & Interaction Design (v3)

> **Status**: Draft
> **Focus**: èšç„¦äº **L2 ç¼–æ’è§†å›¾**ã€‚ç¡®ç«‹â€œé…ç½®ä¼˜äºè¿çº¿ï¼Œä»£ç ä¼˜äºå›¾å½¢â€çš„äº¤äº’åŸåˆ™ã€‚

## 1. æ ¸å¿ƒè®¾è®¡å“²å­¦

### 1.1 æ¶æ„å³è§†å›¾ (Architecture as View)
ç”»å¸ƒçš„é¦–è¦èŒè´£æ˜¯å±•ç¤º **Topology (æ‹“æ‰‘å…³ç³»)** â€”â€” ä¹Ÿå°±æ˜¯ Pattern ä¹‹é—´çš„è¿æ¥ã€‚å¯¹äº Pattern å†…éƒ¨çš„å¾®è§‚é€»è¾‘ï¼Œä»£ç ç¼–è¾‘å™¨æ˜¯æ›´å¥½çš„äº¤äº’ç•Œé¢ã€‚

### 1.2 ä¸Šä¸‹æ–‡ä¼˜å…ˆ (Context First)
*   **é¢†åŸŸèšåˆ**: é€»è¾‘ä¸åº”æ•£è½åœ¨ç‹¬ç«‹çš„â€œå°ç”»å¸ƒâ€ä¸­ã€‚ç›¸å…³çš„é€»è¾‘å¿…é¡»èšåˆåœ¨åŒä¸€ä¸ª **Logic Module** å®¹å™¨å†…ã€‚
*   **åŒå‘å¯¼èˆª**: é€‰ä¸­ UI å¿…è§ Logicï¼Œé€‰ä¸­ Logic å¿…è§ UIã€‚

## 2. ç•Œé¢å¸ƒå±€ (The Workbench)

### 2.1 è¯­ä¹‰åŒ–ç¼©æ”¾ (Semantic Zoom)

*   **L1: Universe (æ¨¡å—è§†å›¾)**
    *   **å†…å®¹**: ä¸šåŠ¡åŸŸ (Zones) å’Œæ¨¡å—ä¾èµ–ã€‚
    *   **è¿çº¿**: æ¨¡å—é—´ä¾èµ– (e.g. Order Module -> User Module)ã€‚
    *   **æ“ä½œ**: æ¶æ„è§„åˆ’ï¼Œåˆ’åˆ†è¾¹ç•Œã€‚

*   **L2: Galaxy (ç¼–æ’è§†å›¾) â€”â€” æ ¸å¿ƒå±‚**
    *   **å†…å®¹**: Pattern å®ä¾‹ (ç§¯æœ¨å—)ã€Logic Modulesã€State Atomsã€‚
    *   **è¿çº¿**: ä¿¡å·æµ (Signal Flow)ã€‚
    *   **æ“ä½œ**:
        *   **æ‹–æ‹½ç¼–æ’**: è°ƒæ•´ç§¯æœ¨é¡ºåºã€‚
        *   **å‘å¯¼é…ç½®**: ç‚¹å‡»ç§¯æœ¨ï¼Œåœ¨å³ä¾§é¢æ¿å¡«å†™è¡¨å•ã€‚
        *   **æ§½ä½è¯†åˆ«**: è‡ªåŠ¨é«˜äº®å¯æ’å…¥é€»è¾‘çš„ Trigger ç«¯å£ã€‚

*   **L3: Planet (å®ç°è§†å›¾) â€”â€” é™çº§å±‚**
    *   **é»˜è®¤**: **Code Editor**ã€‚åŒå‡»ç§¯æœ¨ï¼Œç›´æ¥åœ¨æµ®å±‚ä¸­æŸ¥çœ‹/ç¼–è¾‘æºç ã€‚è¿™æ˜¯æœ€æ¸…æ™°çš„é€»è¾‘å±•ç¤ºã€‚
    *   **å¯é€‰**: **Flow Graph**ã€‚ä»…å¯¹çº¯ DSL æ„å»ºçš„ç®€å•é€»è¾‘æä¾›å›¾å½¢åŒ–å±•å¼€ã€‚ä½†è¿™ä¸å†æ˜¯å¼ºåˆ¶è¦æ±‚ã€‚

## 3. å…³é”®äº¤äº’æ¨¡å¼

### 3.1 å‘å¯¼å¼é…ç½® (Wizard First)
ç»å¤§å¤šæ•°é€»è¾‘è°ƒæ•´ï¼ˆå¦‚ä¿®æ”¹è¶…æ—¶æ—¶é—´ã€é‡è¯•æ¬¡æ•°ï¼‰éƒ½åº”é€šè¿‡å³ä¾§çš„ **Configuration Panel** å®Œæˆï¼Œè€Œä¸æ˜¯å»ä¿®æ”¹å›¾æˆ–ä»£ç ã€‚

*   **è¯†åˆ«**: ç‚¹å‡» UI ç»„ä»¶çš„ Trigger ç«¯å£ã€‚
*   **æ¨è**: AI æ¨è Pattern åˆ—è¡¨ã€‚
*   **é…ç½®**: å¡«å†™ Schema é©±åŠ¨çš„è¡¨å•ã€‚
*   **ç”Ÿæˆ**: å¹³å°ç”Ÿæˆ DSL Patchã€‚

### 3.2 å¿«é€Ÿå¯¼èˆª (Quick Nav)
*   **Jump to Code**: é€‰ä¸­ä»»æ„èŠ‚ç‚¹ï¼ŒæŒ‰ `Cmd+Click` ç›´æ¥è·³è½¬åˆ° IDE ä¸­çš„å¯¹åº”æºç è¡Œã€‚
*   **Peek Definition**: æ‚¬åœåœ¨ Pattern èŠ‚ç‚¹ä¸Šï¼Œæµ®å±‚æ˜¾ç¤ºå…¶ TypeScript ç±»å‹å®šä¹‰å’Œæ–‡æ¡£æ³¨é‡Šã€‚

### 3.3 æ²»ç†æ¨¡å¼

*   **Managed Mode**: èŠ‚ç‚¹æ˜¾ç¤ºä¸ºâ€œé”å®šâ€çŠ¶æ€ï¼Œå±æ€§é¢æ¿ä»…å±•ç¤º Pattern é…ç½®è¡¨å•ã€‚
*   **Eject Mode**: ç”¨æˆ·ç‚¹å‡»â€œè„±ç¦» Patternâ€ï¼ŒèŠ‚ç‚¹è§£é”ï¼Œè½¬æ¢ä¸ºè‡ªç”±ç¼–è¾‘çš„ DSL èŠ‚ç‚¹ï¼ˆæ­¤æ—¶æ‰å…è®¸æ‰‹åŠ¨è¿çº¿ï¼‰ã€‚

## 4. Pattern Studio (æ¶æ„å¸ˆå·¥ä½œå°)

è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹äºä¸šåŠ¡ç”»å¸ƒçš„ IDE ç¯å¢ƒï¼Œä¸“ä¾›æ¶æ„å¸ˆå¼€å‘å’ŒéªŒè¯ Patternã€‚

### 4.1 ç•Œé¢åˆ†åŒº
*   **Code Editor (Left)**: å…¨åŠŸèƒ½çš„ Monaco Editorï¼Œæ”¯æŒ `definePattern` çš„ç±»å‹æç¤ºå’Œè¡¥å…¨ã€‚
*   **Live Wizard (Center)**: å®æ—¶æ¸²æŸ“å½“å‰ Config Schema å¯¹åº”çš„è¡¨å•ã€‚æ¶æ„å¸ˆä¿®æ”¹ Schemaï¼Œè¡¨å•å³æ—¶æ›´æ–°ã€‚
*   **Simulation Console (Right)**:
    *   **Trace Log**: å±•ç¤ºæœåŠ¡è°ƒç”¨ (`Effect.gen`) ä¸åŠ¨ä½œæ´¾å‘ (`dispatch`) çš„æ‰§è¡Œè½¨è¿¹ã€‚
    *   **State Tree**: å±•ç¤º `dsl.set` å¯¼è‡´çš„è™šæ‹ŸçŠ¶æ€å˜åŒ–ã€‚

### 4.2 äº¤äº’æµç¨‹
1.  **Define**: åœ¨å·¦ä¾§ç¼–å†™ Pattern ä»£ç ã€‚
2.  **Config**: åœ¨ä¸­é—´æµ‹è¯•è¡¨å•äº¤äº’ï¼ˆå¦‚è”åŠ¨æ˜¾éšï¼‰ã€‚
3.  **Run**: ç‚¹å‡» "Simulate"ï¼Œåœ¨å³ä¾§è§‚å¯Ÿé€»è¾‘æ‰§è¡Œç»“æœã€‚
4.  **Publish**: éªŒè¯é€šè¿‡åï¼Œç‚¹å‡» "Publish to Registry"ã€‚

## 5. æ€»ç»“

v3 çš„ UI è®¾è®¡ä¸å†è¿½æ±‚â€œå…¨å›¾å½¢åŒ–ç¼–ç¨‹â€ï¼Œè€Œæ˜¯è‡´åŠ›äºæ‰“é€ ä¸€ä¸ª **â€œå›¾å½¢å¢å¼ºçš„ IDEâ€**ã€‚å›¾å½¢è´Ÿè´£å®è§‚ç¼–æ’ï¼Œä»£ç è´Ÿè´£å¾®è§‚å®ç°ï¼Œä¸¤è€…å„å¸å…¶èŒï¼Œäº’ä¸å¹²æ‰°ã€‚

## 6. äº§å“ä¾§æ„å›¾è¯­è¨€ä¸ IntentRule æ˜ å°„

ä¸ºäº†è®©äº§å“ / è®¾è®¡ / æ¶æ„è§’è‰²ä¹Ÿèƒ½åœ¨å¹³å°ä¾§ç›´æ¥è¡¨è¾¾ä¸šåŠ¡æ„å›¾ï¼ŒåŒæ—¶ä¸ Logix / Effect Runtime ä¸¥æ ¼å¯¹é½ï¼Œæœ¬å¹³å°åœ¨ã€Œç”»å¸ƒè§†å›¾ â†’ è§„åˆ™ IR â†’ TypeScript Intent APIã€ä¹‹é—´å¼•å…¥äº†ç»Ÿä¸€çš„ä¸­é—´è¡¨ç¤º `IntentRule`ï¼ˆè§ `runtime-logix/core/06-platform-integration.md`ï¼‰ã€‚

### 6.1 ä¸šåŠ¡ç§¯æœ¨ â†’ IntentRule â†’ Intent API

å¹³å° UI ä¸ç›´æ¥æš´éœ²ä»»ä½• TS çº§ APIï¼ˆåŒ…æ‹¬å†å²ä¸Šçš„ `Intent.andUpdate*` / `Intent.Coordinate`ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡ä¸šåŠ¡åŒ–çš„â€œç§¯æœ¨â€è¡¨è¾¾æ„å›¾ï¼Œå†…éƒ¨ç»Ÿä¸€æ˜ å°„ä¸º `IntentRule`ï¼Œå†ç”±ä»£ç ç”Ÿæˆå™¨äº§å‡ºæ ‡å‡†çš„ Fluent ä»£ç ï¼ˆ`$.onState` / `$.onAction` / `$.on` + `$.state` / `dispatch` ç­‰ï¼‰ã€‚

å‡ ä¸ªå…¸å‹å¯¹ç…§ç¤ºä¾‹ï¼š

| ç”»å¸ƒä¸Šçš„ä¸šåŠ¡æ„ä»¶ | IntentRuleï¼ˆæ¦‚å¿µä¸Šï¼‰ | ç”Ÿæˆçš„ TS Intent API |
| --- | --- | --- |
| å­—æ®µè”åŠ¨å¡ç‰‡ï¼šâ€œå½“å­—æ®µ A å˜åŒ–æ—¶ï¼Œæ¸…ç©ºå­—æ®µ Bâ€ | `source: { context: self, type: state, selector: A }`ï¼›`pipeline: []`ï¼›`sink: { context: self, type: mutate }` | `yield* $.onState(s => s.A).then($.state.update(prev => ({ ...prev, B: '' })))` |
| æ¨¡å—è”åŠ¨è¿çº¿ï¼šâ€œSearch ç»“æœå˜åŒ– â†’ åˆå§‹åŒ– Detailâ€ | `source: { context: SearchStoreId, type: state, selector: results }`ï¼›`pipeline: []`ï¼›`sink: { context: DetailStoreId, type: dispatch }` | `yield* $.on($Search.changes(s => s.results)).then(results => $Detail.dispatch({ _tag: 'detail/initialize', payload: results[0] }))` |
| å®¡æ‰¹æµ Patternï¼šâ€œç‚¹å‡»æäº¤ â†’ è°ƒç”¨å®¡æ‰¹æœåŠ¡ â†’ æ›´æ–°çŠ¶æ€â€ | å¤šæ¡ `IntentRule`ï¼ˆAction è§¦å‘ã€Service è°ƒç”¨ã€çŠ¶æ€æ›´æ–°ï¼‰+ ä¸€ä¸ª Pattern èµ„äº§ ID | `flow.fromAction(...).pipe(flow.run(runApprovalPattern(config)))` |

ä»å¹³å°è§†è§’çœ‹ï¼š

- äº§å“ç»ç†åœ¨ç”»å¸ƒä¸Šåªéœ€è¦é€‰æ‹©åˆé€‚çš„ä¸šåŠ¡ç§¯æœ¨ï¼ˆå­—æ®µè”åŠ¨å¡ç‰‡ã€æ¨¡å—è¿çº¿ã€å®¡æ‰¹æµ Patternï¼‰ï¼Œå¹¶é€šè¿‡å³ä¾§è¡¨å•é…ç½®å‚æ•°ï¼›
- è¿™äº›æ“ä½œç”± UI ç”Ÿæˆæˆ–æ›´æ–°ä¸€ç»„ `IntentRule`ï¼›
- Codegen å±‚å†å°† `IntentRule` è½¬æ¢ä¸ºæ ‡å‡†åŒ–çš„ Fluent TypeScript è°ƒç”¨ï¼ˆé¦–é€‰ `$.onState` / `$.onAction` / `$.on` + `$.state/dispatch` ç»„åˆï¼Œå…¶æ¬¡æ˜¯ Flow/Control å°è£…ï¼‰ã€‚

### 6.2 ç»Ÿä¸€ IRï¼Œå…è®¸å¤šç§ä»£ç é£æ ¼

å€ŸåŠ© `IntentRule` è¿™ä¸€ IRï¼Œå¹³å°å¯ä»¥åšåˆ°ï¼š

- **ä»£ç  â†’ å›¾**ï¼šè§£æç°æœ‰ TS ä»£ç ä¸­çš„ Fluent DSL / Flow ç»„åˆï¼Œå°½é‡è¿˜åŸä¸ºä¸€ç»„ `IntentRule`ï¼Œåœ¨ç”»å¸ƒä¸Šå±•ç¤ºä¸ºå¯ç¼–è¾‘çš„è§„åˆ™èŠ‚ç‚¹ï¼›
- **å›¾ â†’ ä»£ç **ï¼šå½“ç”¨æˆ·åœ¨ç”»å¸ƒä¸Šè°ƒæ•´è§„åˆ™æˆ–é…ç½®å‚æ•°æ—¶ï¼Œä»…ä¿®æ”¹ `IntentRule` é›†åˆï¼Œå†ç”± Generator ç”Ÿæˆ/æ›´æ–° TS ä»£ç ï¼›
- **DSL æ¼”è¿›ä¸é”æ­»**ï¼šæœªæ¥å¦‚éœ€å¼•å…¥æ–°çš„ Intent APIï¼ˆä¾‹å¦‚ `Intent.react`ï¼‰ï¼Œåªè¦èƒ½æ˜ å°„åˆ°åŒä¸€å¥— `IntentRule`ï¼Œç”»å¸ƒä¸å†å²èµ„äº§éƒ½ä¸éœ€è¦å¤§æ”¹ã€‚

è¿™æ„å‘³ç€ï¼š**PM å±‚çš„â€œæ„å›¾è¯­è¨€â€å¯ä»¥å®Œå…¨å›´ç»•ä¸šåŠ¡æ„ä»¶ + è§„åˆ™è¡¨å•è®¾è®¡ï¼Œè€Œä¸éœ€è¦ç›´æ¥é¢å¯¹ TypeScript APIï¼›è€Œ Runtime/ä»£ç ç”Ÿæˆå±‚åˆ™é€šè¿‡ `IntentRule` ä¸ Logix / Effect-Native API ç²¾ç¡®å¯¹é½ï¼Œé¿å…è¯­ä¹‰æ¼‚ç§»ã€‚**
</file>

<file path="intent-driven-ai-coding/v3/07-ui-ux-detailed-specs.md">
---
title: 07 Â· UI æ„å›¾ä¸ç»„ä»¶èµ„äº§ (UI Intent & Component Assets)
status: draft
version: 1
---

> **æ ¸å¿ƒç›®æ ‡**ï¼šæ„å»ºä¸€ä¸ªå¼€æ”¾çš„ã€åŸºäº Manifest çš„ç»„ä»¶èµ„äº§ä½“ç³»ï¼Œæ”¯æŒä» Headless åˆ° Pro Components çš„å…¨å±‚çº§æ¥å…¥ï¼Œå¹¶å®ç°ä¸ Logix é€»è¾‘çš„å£°æ˜å¼ç»‘å®šã€‚

## 1. ç»„ä»¶èµ„äº§ä½“ç³» (Component Asset System)

Logix ä¸ç»‘å®šç‰¹å®š UI åº“ï¼Œè€Œæ˜¯é€šè¿‡ **Manifest Protocol** æ¥å…¥ä»»æ„ React ç»„ä»¶ã€‚

### 1.1 Component Manifest (ç»„ä»¶æ¸…å•)

Manifest æ˜¯ç»„ä»¶çš„â€œè¯´æ˜ä¹¦â€ï¼Œæè¿°äº†ç»„ä»¶çš„èƒ½åŠ›å’Œæ¥å£ã€‚

```json
{
  "id": "@my-org/pro-table",
  "version": "1.0.0",
  "kind": "pro", // pro | atom | layout
  
  // å±æ€§å®šä¹‰ (ç”¨äºå±æ€§é¢æ¿)
  "props": {
    "columns": { "type": "json", "editor": "column-builder" },
    "request": { "type": "function", "bindable": true },
    "rowKey": { "type": "string", "default": "id" }
  },

  // äº‹ä»¶å®šä¹‰ (ç”¨äºé€»è¾‘è§¦å‘)
  "events": {
    "onRowClick": { "payload": "{ record: any }" }
  },

  // æ’æ§½å®šä¹‰ (ç”¨äºå­ç»„ä»¶æ‹–æ‹½)
  "slots": {
    "toolBarRender": { "description": "è¡¨æ ¼ä¸Šæ–¹å·¥å…·æ " },
    "expandedRowRender": { "description": "å±•å¼€è¡Œå†…å®¹" }
  },

  // æ ·å¼èƒ½åŠ› (Tailwind)
  "styling": {
    "allowClassMerge": true,
    "presets": ["default", "compact", "bordered"]
  }
}
```

### 1.2 æ¥å…¥æ¨¡å¼ (Integration Modes)

1.  **NPM Package (Standard)**: 
    *   ç›´æ¥å¼•ç”¨ `node_modules` ä¸­çš„ç»„ä»¶ã€‚
    *   Manifest ç”± CLI å·¥å…·æ‰«æç±»å‹å®šä¹‰è‡ªåŠ¨ç”Ÿæˆï¼Œæˆ–æ‰‹åŠ¨ç»´æŠ¤ã€‚
    *   **é€‚ç”¨**: åŸºç¡€ç»„ä»¶åº“ã€Pro ç»„ä»¶åº“ã€‚

2.  **Local Source (Project)**:
    *   å¼•ç”¨é¡¹ç›®å†…çš„ `src/components`ã€‚
    *   æ”¯æŒçƒ­æ›´æ–°å’Œæºç è·³è½¬ã€‚
    *   **é€‚ç”¨**: ä¸šåŠ¡ä¸“ç”¨ç»„ä»¶ã€‚

## 2. UI Intent ç»“æ„ (The Graph)

UI Intent æ˜¯ä¸€æ£µé€»è¾‘å¢å¼ºçš„ç»„ä»¶æ ‘ã€‚

```typescript
interface UIIntentNode {
  id: string;
  component: string; // Ref to Manifest ID
  
  // é™æ€å±æ€§ (ç›´æ¥å€¼)
  props: Record<string, any>;

  // åŠ¨æ€ç»‘å®š (ç»‘å®šåˆ° Logix State)
  bindings: {
    // propName: statePath
    "loading": "ui.isLoading",
    "dataSource": "domain.userList"
  };

  // äº‹ä»¶æ˜ å°„ (æ˜ å°„åˆ° Logix Signal/Action)
  events: {
    // eventName: signalId
    "onRowClick": "signal:previewUser"
  };
  
  // æ’æ§½å†…å®¹
  slots: {
    [slotName: string]: UIIntentNode[];
  };

  // æ ·å¼ (Tailwind)
  className: string;
  classBindings: {
    [className: string]: string; // condition expression
  };
}
```

## 3. è¿è¡Œæ—¶æ¡¥æ¥ (Runtime Bridge)

Logix Renderer è´Ÿè´£å°† Intent å®ä¾‹åŒ–ä¸º React ç»„ä»¶æ ‘ã€‚

### 3.1 æ¸²æŸ“æµç¨‹

1.  **Resolve**: æ ¹æ® `node.component` ID ä» `ComponentRegistry` ä¸­è·å– React ç»„ä»¶å‡½æ•°ã€‚
2.  **Bind State**: è®¢é˜… `bindings` ä¸­æŒ‡å®šçš„ Logix Stateï¼Œå®æ—¶æ³¨å…¥ Propsã€‚
3.  **Bind Events**: åˆ›å»º Dispatcher å‡½æ•°ï¼Œç»‘å®šåˆ° `events` æŒ‡å®šçš„ Propsã€‚
4.  **Render Slots**: é€’å½’æ¸²æŸ“ `slots` ä¸­çš„å­èŠ‚ç‚¹ï¼Œå¹¶å°†ç»“æœä½œä¸º `ReactNode` ä¼ é€’ç»™å¯¹åº” Propã€‚
5.  **Merge Styles**: è®¡ç®—åŠ¨æ€ `classBindings`ï¼Œä¸é™æ€ `className` åˆå¹¶ã€‚

### 3.2 æ··åˆç”»å¸ƒäº¤äº’

*   **Pro ç»„ä»¶ (Black Box)**: é»˜è®¤ä½œä¸ºæ•´ä½“æ¸²æŸ“ã€‚æ’æ§½æ˜¾ç¤ºä¸º DropZoneã€‚
*   **åŸå­ç»„ä»¶ (White Box)**: å®Œå…¨å±•å¼€ï¼Œæ”¯æŒç²¾ç»†åŒ–å¸ƒå±€è°ƒæ•´ã€‚
*   **é’»å– (Drill-down)**: å…è®¸ç”¨æˆ·â€œè§£ç»„â€æŸäº›å¤åˆç»„ä»¶ï¼ˆå¦‚æœ Manifest å…è®¸ï¼‰ï¼ŒæŸ¥çœ‹å†…éƒ¨ç»“æ„ã€‚
</file>

<file path="intent-driven-ai-coding/v3/97-effect-runtime-and-flow-execution.md">
---
title: 97 Â· ç»Ÿä¸€é€»è¾‘è¿è¡Œæ—¶ (Unified Logic Runtime)
status: draft
version: 11 (Effect-Native)
---

> æœ¬æ–‡æ¡£æè¿° Logic Intent (Behavior) çš„è¿è¡Œæ—¶å®ç°ã€‚å®ç°å±‚ä»¥ **Store / Logic / Flow** ä¸‰å¤§è¿è¡Œæ—¶åŸè¯­ä¸ºåŸºç¡€ï¼Œç»“åˆ `Control`ã€`Effect.Service`ã€`Config` ç­‰èƒ½åŠ›æ„æˆç»Ÿä¸€çš„ Logic Runtimeã€‚å…·ä½“ç±»å‹ä¸ PoC ä»¥ `v3/effect-poc` ä¸‹ä»£ç ä¸ºå‡†ã€‚

## 1. æ ¸å¿ƒç†å¿µï¼šOne Logic, Any Runtime

Logic Intent çš„ Impl å±‚æ˜¯åŸºäº Effect çš„ **Bound API (`$`) ä¸ `Flow` API** é£æ ¼çš„ä»£ç ï¼š

- Storeï¼šé€šè¿‡ Schema å®šä¹‰ State/Action å½¢çŠ¶ï¼Œå¹¶ç”±é¢†åŸŸæ¨¡å—çš„è¿è¡Œæ—¶å®¹å™¨æä¾› `getState / actions / changes$ / ref` ç­‰èƒ½åŠ›ã€‚
  - **Smart Dispatchers**ï¼šç›´æ¥é€šè¿‡ `actions.updateUser(payload)` è°ƒç”¨ï¼Œæ›¿ä»£æ—§çš„ `dispatch({ _tag, ... })`ã€‚
- Logicï¼šé€šè¿‡ Bound APIï¼ˆ`$`ï¼‰è·å–ä¸Šä¸‹æ–‡ã€‚
  - **Unified Trigger**ï¼šç»Ÿä¸€ä½¿ç”¨ `$.onState(selector)` / `$.onAction(predicate)` / `$.on(stream)` æ›¿ä»£åˆ†æ•£çš„ `whenState/whenAction`ã€‚
- Flowï¼šå›´ç»• `actions$ / changes$` æä¾›æœ‰é™çš„æ—¶åºä¸å¹¶å‘ç®—å­ï¼ˆå¦‚ `debounce / throttle / run*`ï¼‰ã€‚
- Controlï¼šæä¾›ç»“æ„åŒ–çš„æ§åˆ¶æµç®—å­ï¼ˆå¦‚ `match / try / all`ï¼‰ã€‚

é•¿é€»è¾‘æœ¬èº«ä»¥ pattern-style çš„ `(input) => Effect` å‡½æ•°å­˜åœ¨ï¼Œå¯ä»¥ç›´æ¥è¢« Logic è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨å¹³å°å±‚è¢«èµ„äº§åŒ–ã€‚

### 1.1 Flow æœ¯è¯­æ¶ˆæ­§ (Terminology)

åœ¨ä¸åŒæ–‡æ¡£ä¸­ï¼Œ`Flow` ä¸€è¯æ›¾è¢«ç”¨æ¥æŒ‡ä»£ä¸åŒå±‚çº§çš„æ¦‚å¿µï¼Œè¿™é‡Œç»Ÿä¸€çº¦å®šï¼š

- `Logix Flow`ï¼šç‰¹æŒ‡å‰ç«¯ Logix Engine å†…éƒ¨çš„æ—¶é—´è½´ / å¹¶å‘åŸè¯­é›†åˆï¼Œå³ `runtime-logix/core/03-logic-and-flow.md` ä¸­çš„ `Flow.Api`ï¼ˆ`fromAction / fromState / debounce / run*` ç­‰ï¼‰ã€‚ä»£ç å±‚é¢é€šè¿‡ `flow.*` å‘½åç©ºé—´è®¿é—®ã€‚
- `Effect Flow Runtime`ï¼šç‰¹æŒ‡è¿è¡Œåœ¨ BFF / Server ä¾§çš„ Effect é©±åŠ¨ä¸šåŠ¡æµç¨‹è¿è¡Œæ—¶ï¼ˆä¾‹å¦‚ `.flow.ts` ä¸­ç¼–æ’çš„è·¨ç³»ç»Ÿé•¿æµç¨‹ï¼‰ã€‚ä¸ºäº†é¿å…æ­§ä¹‰ï¼Œåç»­æ–‡æ¡£ä¸­æ›´å€¾å‘ä½¿ç”¨ **Flow Runtime** æˆ– **ServerFlow Runtime** æ¥ç§°å‘¼å®ƒï¼Œè€Œä¸ç›´æ¥å†™ `Flow`ã€‚
- `Flow DSL`ï¼šæŒ‡ YAML/JSON çº§åˆ«çš„ç¼–æ’æè¿°ï¼ˆå‚è§ `v1/08-flow-dsl-and-ast.md`ï¼‰ï¼Œä¸»è¦ç”¨äº Flow ç»“æ„çš„æŠ½è±¡è¡¨è¾¾ï¼Œä¾¿äº Intent ä¸å·¥å…·é“¾è¿›è¡Œç»“æ„åŒ–å¯¹é½ã€‚

åç»­æ¶‰åŠâ€œFlowâ€çš„æ–‡æ¡£åº”æ˜¾å¼ä½¿ç”¨ä¸Šè¿°æœ¯è¯­ä¹‹ä¸€ï¼Œå¹¶åœ¨é¦–æ¬¡å‡ºç°æ—¶æŒ‡æ˜æ˜¯ `Logix Flow` è¿˜æ˜¯ `Flow Runtime`ï¼Œé¿å…å†å‡ºç°æ··ç”¨ã€‚

## 2. åŠ¨æ€æ€§ä¸çƒ­æ›´æ–° (Dynamism & HMR)

ä¸ºäº†æ”¯æŒâ€œå…¨åŒå·¥ç¼–æ’â€å’Œæè‡´çš„å¼€å‘ä½“éªŒ (DX)ï¼ŒLogix Runtime å¿…é¡»å…·å¤‡åŠ¨æ€åŠ è½½ä¸çƒ­æ›¿æ¢èƒ½åŠ›ã€‚

### 2.1 Direct Execution (å¼€å‘æ€)

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼ŒLogix ç›´æ¥è¿è¡Œ TypeScript ç¼–è¯‘åçš„ JS ä»£ç ã€‚**ä¸å†æœ‰ä¸­é—´å±‚çš„ JSON è§£é‡Šå™¨**ã€‚è¿™å®ç°äº† **Native Performance**ã€‚

### 2.2 HMR ç­–ç•¥ï¼šå®‰å…¨é‡å¯ä¸çŠ¶æ€åè°ƒ

Logix çš„ HMR å»ºç«‹åœ¨ Effect å¼ºå¤§çš„ **Scope (èµ„æºä½œç”¨åŸŸ)** æœºåˆ¶ä¹‹ä¸Šï¼Œé‡‡ç”¨â€œåŸºçº¿å…œåº• + æ¸è¿›å¢å¼ºâ€çš„ç­–ç•¥ã€‚

### 6.3 å¿ƒæ™ºæ¨¡å‹ï¼šSession å³äº‹åŠ¡ (Mental Model: Session as Transaction)

ä»è®¡ç®—æœºç§‘å­¦è§’åº¦çœ‹ï¼ŒSession æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **é•¿æ´»çš„äº¤äº’å¼äº‹åŠ¡ (Long-Lived Interactive Transaction)**ï¼Œå®ƒåœ¨ UI å±‚å®ç°äº†ç±»ä¼¼æ•°æ®åº“ ACID çš„ç‰¹æ€§ï¼š

-   **Isolation (éš”ç¦»æ€§)**ï¼šSession å†…çš„ Draft State å¯¹å¤–éƒ¨ Module ä¸å¯è§ï¼Œé¿å…äº†â€œè„è¯»â€ (Dirty Read)ã€‚
-   **Atomicity (åŸå­æ€§)**ï¼šSession åªæœ‰â€œæäº¤ (Result Action)â€å’Œâ€œé”€æ¯ (Rollback)â€ä¸¤ç§ç»ˆæ€ã€‚ä¸­é—´æ­¥éª¤çš„å–æ¶ˆä¼šè‡ªåŠ¨æ¸…ç†æ‰€æœ‰ä¸´æ—¶çŠ¶æ€ï¼Œæ— éœ€æ‰‹åŠ¨ GCã€‚

> **Future Roadmap (v4)**: åœ¨æœªæ¥ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è®¡åˆ’åˆ©ç”¨ Effect-TS çš„ **STM (Software Transactional Memory)** æ¨¡å—æ¥ç‰©ç†å®ç°è¿™ä¸€æŠ½è±¡ï¼Œæä¾›æ›´å¼ºçš„åŸå­æ€§ä¿è¯ã€‚ä½†åœ¨ v3 é˜¶æ®µï¼Œ`Scope` + `Ref` æ˜¯æ€§ä»·æ¯”æœ€é«˜çš„å·¥ç¨‹å®ç°ã€‚

#### 2.2.1 åŸºçº¿ç­–ç•¥ï¼šå®‰å…¨é‡å¯ (Baseline: Safe Restart)

è¿™æ˜¯ Logix HMR çš„é»˜è®¤è¡Œä¸ºï¼Œç¡®ä¿äº†**ç»å¯¹çš„å®‰å…¨æ€§**ï¼ˆæ— å†…å­˜æ³„æ¼ã€æ— åƒµå°¸é€»è¾‘ï¼‰ã€‚

*   **æœºåˆ¶**:
    1.  **Teardown**: å½“ Logic å˜æ›´æ—¶ï¼ŒRuntime è°ƒç”¨æ—§ Fiber çš„ `Scope.close()`ã€‚Effect è¿è¡Œæ—¶ä¿è¯æ‰€æœ‰æŒ‚èµ·çš„èµ„æºï¼ˆTimer, Socket, File Handleï¼‰è¢«å¼ºåˆ¶ä¸”ä¼˜é›…åœ°å…³é—­ã€‚
    2.  **Reboot**: ä½¿ç”¨æ–°å®šä¹‰å¯åŠ¨æ–° Fiberã€‚
    3.  **Data Retention**: **Store ä¸­çš„æ•°æ®çŠ¶æ€ (Data State) 100% ä¿ç•™**ã€‚ç”¨æˆ·å¡«å†™çš„è¡¨å•ã€åŠ è½½çš„æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚
*   **ä½“éªŒ**: é€»è¾‘æµç¨‹ä¼šé‡ç½®ï¼ˆä¾‹å¦‚å€’è®¡æ—¶é‡æ–°å¼€å§‹ï¼‰ï¼Œä½†ä¸šåŠ¡æ•°æ®ä¸ä¸¢ã€‚è¿™å¯¹äºç»å¤§å¤šæ•°è°ƒè¯•åœºæ™¯å·²è¶³å¤Ÿå®Œç¾ã€‚

#### 2.2.2 é«˜çº§ç­–ç•¥ï¼šä¸‰çº§çŠ¶æ€åè°ƒ (Advanced: Tri-Level Reconciliation)

åœ¨åŸºçº¿ç­–ç•¥ä¹‹ä¸Šï¼Œé’ˆå¯¹è¿½æ±‚æè‡´ä½“éªŒçš„åœºæ™¯ï¼ŒRuntime å°è¯•è¿›è¡Œæ›´ç»†ç²’åº¦çš„çŠ¶æ€ä¿ç•™ï¼ˆOptionalï¼‰ï¼š

1.  **Level 1: å‚æ•°çº§çƒ­æ›´ (Hot Parameter Swap)**
    *   å½“ä»…ä¿®æ”¹èŠ‚ç‚¹çš„**é…ç½®å‚æ•°**ï¼ˆå¦‚ `debounce` æ—¶é—´ï¼‰æ—¶ï¼Œä¸é‡å¯ Fiberï¼Œä»…æ›´æ–° `FiberRef`ã€‚æ­£åœ¨è¿è¡Œçš„é€»è¾‘ï¼ˆå¦‚å€’è®¡æ—¶ï¼‰æ— ç¼åˆ‡æ¢å‚æ•°ã€‚

2.  **Level 2: ç»“æ„å…¼å®¹æ€§é‡æ„ (Structural Reconciliation)**
    *   å½“èŠ‚ç‚¹ç»“æ„å¾®è°ƒæ—¶ï¼Œé‡å¯ Fiberï¼Œä½†å°è¯•å°†æ—§çš„**æ‰§è¡ŒçŠ¶æ€** (Execution State) æ˜ å°„ç»™æ–° Fiberã€‚

3.  **Level 3: æ˜¾å¼è¿ç§» (Explicit Migration)**
    *   å½“é€»è¾‘è´¨å˜æ—¶ï¼Œå…è®¸å¼€å‘è€…æä¾› `migrate(oldState)` å‡½æ•°è¿›è¡Œæ‰‹åŠ¨è¿ç§»ã€‚

### 2.3 Vite HMR é›†æˆ

å¹³å°æä¾› Vite æ’ä»¶ï¼Œç›‘å¬ `.logic.ts` çš„å˜æ›´ï¼Œè‡ªåŠ¨è§¦å‘ä¸Šè¿°åè°ƒæµç¨‹ã€‚

## 3. å›¾ç åŒæ­¥åŸç† (Code <-> Graph)

å¹³å°åˆ©ç”¨ **Static Analysis (é™æ€åˆ†æ)** å®ç°ä»£ç ä¸ç”»å¸ƒçš„æ— æŸåŒæ­¥ã€‚

*   **Code -> Graph**: Parser æå– `Flow` è°ƒç”¨é“¾ï¼Œæ„å»ºå†…å­˜å›¾ç»“æ„ã€‚
*   **Graph -> Code**: ä¿®æ”¹å›¾ç»“æ„åï¼Œåˆ©ç”¨ `ts-morph` ç²¾å‡†ä¿®æ”¹å¯¹åº”çš„ AST èŠ‚ç‚¹ã€‚

### 3.1 æ··åˆå¯è§†åŒ– (Hybrid Visualization)

è¿è¡Œæ—¶æ”¯æŒä¸‰ç§çº§åˆ«çš„å¯è§†åŒ–å‘ˆç°ï¼š

1.  **White Box (Managed)**: æ ‡å‡† DSL èŠ‚ç‚¹ã€‚å®Œå…¨å¯è§†åŒ–ï¼Œæ”¯æŒæ‹–æ‹½ã€å‚æ•°é…ç½®ã€‚
2.  **Gray Box (Ejected)**: ç»“æ„å·²çŸ¥ä½†å‚æ•°è¢«äººå·¥ä¿®æ”¹çš„èŠ‚ç‚¹ã€‚æ˜¾ç¤ºä¸ºâ€œå·²ä¿®æ”¹â€ï¼Œä»…å…è®¸æŸ¥çœ‹ä»£ç æˆ–é‡ç½®ã€‚
3.  **Black Box (Raw)**: çº¯æ‰‹å†™çš„ Effect ä»£ç å—ã€‚åœ¨å›¾ä¸­æ˜¾ç¤ºä¸ºä»£ç ç¼–è¾‘å™¨ç»„ä»¶ï¼Œæ”¯æŒç›´æ¥ç¼–å†™ TS ä»£ç ã€‚

## 4. è¿è¡Œæ—¶åˆ†å‘ (Runtime Dispatch)

ç¼–è¯‘å™¨åˆ†æ Logic ä¸­çš„èŠ‚ç‚¹ç±»å‹ï¼Œè‡ªåŠ¨å†³å®šä»£ç ç”Ÿæˆçš„ç›®æ ‡ç¯å¢ƒï¼š

*   **Logix Engine (å‰ç«¯)**ï¼šçº¯ UI é€»è¾‘ã€‚
*   **Effect Flow Runtime**ï¼šçº¯åç«¯é€»è¾‘ã€‚
*   **Hybrid**ï¼šæ··åˆé€»è¾‘ï¼ˆLogix è´Ÿè´£ UI + Remote Callï¼‰ã€‚

## 5. Effect-TS çš„è§’è‰²

æ— è®ºæ˜¯åœ¨å‰ç«¯ Logix è¿˜æ˜¯åç«¯ Runtimeï¼Œæˆ‘ä»¬éƒ½æ¨èä½¿ç”¨ **Effect-TS** ä½œä¸ºåº•å±‚çš„æ‰§è¡Œå¼•æ“ã€‚

## 6. é«˜çº§æ¨¡å¼ï¼šç¬æ—¶äº¤äº’ (Advanced Pattern: Ephemeral Interaction)

> **è§£å†³ç—›ç‚¹**ï¼šé˜²æ­¢äº¤äº’è¿‡ç¨‹ä¸­çš„ä¸´æ—¶çŠ¶æ€ï¼ˆå¦‚æ‹–æ‹½åæ ‡ã€å‘å¯¼æ­¥éª¤ï¼‰æ±¡æŸ“æŒä¹…åŒ–çš„ Module Stateã€‚

æˆ‘ä»¬å¼•å…¥ **Draft (è‰ç¨¿)** åŸè¯­æ¥æ ‡å‡†åŒ–è¿™ä¸€æ¨¡å¼ã€‚Draft æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **æ‹¥æœ‰ç‹¬ç«‹ç”Ÿå‘½å‘¨æœŸ (Scope) å’Œç§æœ‰çŠ¶æ€ (Ref) çš„å¾®å‹ Module**ã€‚

### 6.1 æ ¸å¿ƒç‰¹å¾

1.  **Micro Store**ï¼šæ‹¥æœ‰è‡ªå·±çš„ `state` å’Œ `actions`ï¼Œä½†ä»…åœ¨ Draft æœŸé—´å­˜åœ¨ã€‚
2.  **Scoped Lifecycle**ï¼š
    - **Start**ï¼šç”±ä¸» Module è§¦å‘ï¼ˆ`$.draft.start`ï¼‰ã€‚
    - **Interaction**ï¼šæ¥ç®¡éƒ¨åˆ†æˆ–å…¨éƒ¨ UI äº¤äº’æƒã€‚
    - **Commit/Rollback**ï¼šæœ€ç»ˆäº§å‡º Result Action æˆ–é”€æ¯ï¼ŒçŠ¶æ€è‡ªåŠ¨æ¸…ç†ã€‚
3.  **Transaction Semantics**ï¼šæä¾›ç±»ä¼¼äº‹åŠ¡çš„éš”ç¦»æ€§ (Isolation) å’ŒåŸå­æ€§ (Atomicity)ã€‚

### 6.2 API è®¾è®¡ (Draft API)

Draft çš„å®šä¹‰æ–¹å¼ä¸ Module å‡ ä¹ä¸€è‡´ï¼Œä½†æ›´åŠ è½»é‡ï¼š

```typescript
// 1. å®šä¹‰ Draft (Schema-First)
const WizardDraft = Logix.Module('WizardDraft', {
  // Draft å†…éƒ¨çš„ä¸´æ—¶çŠ¶æ€
  state: Schema.Struct({ step: Schema.Number, draftData: DataSchema }),
  // Draft å¯åŠ¨æ—¶éœ€è¦çš„ä¸Šä¸‹æ–‡ï¼ˆåªè¯»ï¼Œä½œä¸ºåˆå§‹çŠ¶æ€çš„ä¸€éƒ¨åˆ†æˆ– Contextï¼‰
  actions: Schema.Union(
      Schema.Struct({ _tag: Schema.Literal('next') }),
      Schema.Struct({ _tag: Schema.Literal('cancel') }),
  )
});

// 2. åœ¨ä¸» Module ä¸­ä½¿ç”¨
Module.logic(($) => Effect.gen(function* () {
  // å¯åŠ¨ Draft
  yield* $.onAction('startWizard').then((orderId) =>
    $.draft.start(WizardDraft, { orderId })
  );

  // æäº¤ Draft (Transactional Commit)
  yield* $.onAction('submitWizard').then(() =>
    $.draft.commit(WizardDraft).pipe(
      // æäº¤æˆåŠŸåï¼Œå°†ç»“æœå›å†™åˆ°ä¸» Module
      Effect.andThen((result) => $.actions.updateOrder(result))
    )
  );
}));
```

### 6.3 å¿ƒæ™ºæ¨¡å‹ï¼šDraft å³äº‹åŠ¡ (Mental Model: Draft as Transaction)

ä»è®¡ç®—æœºç§‘å­¦è§’åº¦çœ‹ï¼ŒDraft æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **é•¿æ´»çš„äº¤äº’å¼äº‹åŠ¡ (Long-Lived Interactive Transaction)**ï¼š

-   **Isolation (éš”ç¦»æ€§)**ï¼šDraft State å¯¹å¤–éƒ¨ Module ä¸å¯è§ï¼Œé¿å…äº†â€œè„è¯»â€ã€‚
-   **Atomicity (åŸå­æ€§)**ï¼šDraft åªæœ‰â€œæäº¤â€å’Œâ€œé”€æ¯â€ä¸¤ç§ç»ˆæ€ã€‚å³ä½¿åœ¨ç¬¬ 9 æ­¥å–æ¶ˆï¼Œæ‰€æœ‰ä¸´æ—¶çŠ¶æ€ä¹Ÿä¼šè‡ªåŠ¨å›æ»šï¼ˆå†…å­˜é‡Šæ”¾ï¼‰ã€‚

> **Future Roadmap**: æœªæ¥å°†ç»“åˆ Effect STM æä¾›ç‰©ç†çº§åˆ«çš„äº‹åŠ¡æ”¯æŒã€‚
</file>

<file path="intent-driven-ai-coding/v3/98-time-travel-debugger.md">
---
title: 98 Â· æ—¶é—´æ—…è¡Œè°ƒè¯•å™¨ (Time Travel Debugger)
status: draft
version: 1 (Initial)
---

> **æ ¸å¿ƒç›®æ ‡**ï¼šåˆ©ç”¨ Effect-TS çš„ç»“æ„åŒ–å¹¶å‘ç‰¹æ€§ï¼Œæä¾›ä¸Šå¸è§†è§’çš„è°ƒè¯•èƒ½åŠ›ã€‚ä¸ä»…èƒ½â€œçœ‹åˆ°â€è¿‡å»ï¼Œè¿˜èƒ½â€œå›åˆ°â€è¿‡å»ï¼Œç”šè‡³â€œæ”¹å˜â€è¿‡å»ã€‚

## 1. æ¶æ„åŸç†ï¼šå…¨æ¯å½•åˆ¶ (Holographic Recording)

ä¼ ç»Ÿçš„ Redux DevTools åªèƒ½è®°å½• State çš„å˜åŒ–ã€‚Logix Debugger åˆ™æ›´è¿›ä¸€æ­¥ï¼Œå®ƒè®°å½•çš„æ˜¯ **Effect çš„æ‰§è¡Œè½¨è¿¹ (Execution Trace)**ã€‚

### 1.1 LogixTracer

æˆ‘ä»¬åˆ©ç”¨ Effect çš„ `Tracer` APIï¼Œæ³¨å…¥ä¸€ä¸ªè‡ªå®šä¹‰çš„é¥æµ‹å±‚ã€‚

```typescript
// ä¼ªä»£ç ï¼šTrace æ•°æ®ç»“æ„
interface TraceSpan {
  traceId: string;
  parentId?: string;
  name: string; // e.g., "Flow:SubmitOrder", "Node:Validate"
  status: 'pending' | 'success' | 'failure';
  startTime: number;
  duration?: number;
  
  // ä¸Šä¸‹æ–‡å¿«ç…§ (å…³é”®)
  attributes: {
    input: any;      // èŠ‚ç‚¹çš„è¾“å…¥å‚æ•°
    output?: any;    // èŠ‚ç‚¹çš„è¾“å‡ºç»“æœ
    stateDiff?: any; // è¯¥æ“ä½œå¯¼è‡´çš„çŠ¶æ€å˜æ›´
  };
}
```

### 1.2 é‡‡æ ·ç­–ç•¥ (Sampling Strategy)

ä¸ºäº†é¿å…å†…å­˜çˆ†ç‚¸ï¼ŒDebugger æ”¯æŒæ™ºèƒ½é‡‡æ ·ï¼š
*   **Dev Mode**: å…¨é‡è®°å½• (100%)ã€‚
*   **Prod Mode**: ä»…è®°å½• Error åŠå…¶å‰åº N ä¸ªæ­¥éª¤ (Ring Buffer)ã€‚

## 2. å¯è§†åŒ–äº¤äº’ (Visual Interaction)

### 2.1 å¤šè½¨é“æ—¶é—´è½´ (Multi-Track Timeline)

UI åº•éƒ¨å±•ç¤ºä¸€ä¸ªç±»ä¼¼è§†é¢‘å‰ªè¾‘è½¯ä»¶çš„æ—¶é—´è½´ï¼š

*   **Action Track (ä¸»è½´)**: ç”¨æˆ·çš„äº¤äº’äº‹ä»¶ (Click, Input) å’Œå¤–éƒ¨ä¿¡å· (WebSocket Msg)ã€‚
*   **Flow Tracks (å­è½´)**: æ¯ä¸ªè§¦å‘çš„ Logic Flow å æ®ä¸€è¡Œã€‚
    *   **å¹¶å‘å¯è§†åŒ–**: ä½ å¯ä»¥ç›´è§‚åœ°çœ‹åˆ°å¤šä¸ª Flow æ˜¯å¦‚ä½•å¹¶è¡Œæ‰§è¡Œã€ç«æ€å–æ¶ˆ (Cancellation) çš„ã€‚
    *   **å› æœè¿çº¿**: ç‚¹å‡»ä¸€ä¸ª Actionï¼Œé«˜äº®å®ƒè§¦å‘çš„æ‰€æœ‰ Flowã€‚

### 2.2 çŠ¶æ€é€è§† (State Inspection)

ç‚¹å‡»æ—¶é—´è½´ä¸Šçš„ä»»æ„ Spanï¼Œå³ä¾§é¢æ¿æ˜¾ç¤ºï¼š
*   **Input/Output**: è¯¥èŠ‚ç‚¹çš„è¾“å…¥è¾“å‡ºã€‚
*   **State Before/After**: è¯¥æ“ä½œå‰åçš„ Store çŠ¶æ€å¯¹æ¯” (Diff View)ã€‚
*   **Code Link**: ç‚¹å‡»ç›´æ¥è·³è½¬åˆ°å¯¹åº”çš„æºç ä½ç½®ã€‚

## 3. æ—¶é—´æ—…è¡Œ (Time Travel)

### 3.1 å›æ»š (Rollback)

æ‹–åŠ¨æ—¶é—´è½´æ»‘å—ï¼ŒLogix Runtime æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
1.  **Suspend**: æš‚åœå½“å‰æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ Fiberã€‚
2.  **Restore**: å°† Store çš„çŠ¶æ€é‡ç½®ä¸ºç›®æ ‡æ—¶é—´ç‚¹çš„å¿«ç…§ã€‚
3.  **Freeze**: è¿›å…¥â€œæš‚åœæ¨¡å¼â€ï¼ŒUI å˜ä¸ºåªè¯»ï¼Œé˜²æ­¢äº§ç”Ÿæ–°çš„ Actionã€‚

### 3.2 é‡æ”¾ (Replay)

åœ¨æš‚åœæ¨¡å¼ä¸‹ï¼Œå¯ä»¥é€‰æ‹©â€œé‡æ”¾åç»­æ“ä½œâ€ã€‚Runtime ä¼šæŒ‰æ—¶é—´æˆ³é¡ºåºï¼Œæ¨¡æ‹Ÿè§¦å‘åç»­çš„ Actionï¼Œè®©ä½ æ…¢åŠ¨ä½œè§‚å¯Ÿ Bug æ˜¯å¦‚ä½•å¤ç°çš„ã€‚

## 4. é€»è¾‘åˆ†å‰ (Logic Forking) â€”â€” The Killer Feature

è¿™æ˜¯ Logix Debugger æœ€å¼ºå¤§çš„åŠŸèƒ½ã€‚å®ƒå…è®¸ä½ åœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹ï¼Œ**åŠ¨æ€éªŒè¯å‡è®¾**ã€‚

**åœºæ™¯**ï¼š
ä½ æ€€ç–‘æŸä¸ª API è¿”å›é”™è¯¯å¯¼è‡´äº† Bugï¼Œä½†å¾ˆéš¾å¤ç° API é”™è¯¯ã€‚

**æ“ä½œæµç¨‹**ï¼š
1.  åœ¨æ—¶é—´è½´ä¸Šæ‰¾åˆ°é‚£ä¸ª API è°ƒç”¨èŠ‚ç‚¹ã€‚
2.  å³é”®ç‚¹å‡» -> **"Fork & Mock"**ã€‚
3.  åœ¨å¼¹å‡ºçš„é¢æ¿ä¸­ï¼Œæ‰‹åŠ¨ä¿®æ”¹è¯¥èŠ‚ç‚¹çš„è¾“å‡ºï¼ˆä¾‹å¦‚ï¼šå¼ºåˆ¶è¿”å› 500 Errorï¼‰ã€‚
4.  ç‚¹å‡» **"Run Fork"**ã€‚

**ç³»ç»Ÿè¡Œä¸º**ï¼š
*   Runtime å…‹éš†å½“å‰çš„ Fiber ä¸Šä¸‹æ–‡ï¼ˆSandboxï¼‰ã€‚
*   ä»è¯¥èŠ‚ç‚¹å¼€å§‹æ‰§è¡Œï¼Œä½¿ç”¨ä½  Mock çš„æ•°æ®ã€‚
*   åç»­æµç¨‹åœ¨æ–°çš„æ²™ç®±ä¸­è·‘å®Œï¼Œä½ å¯ä»¥è§‚å¯Ÿ UI ä¼šå¦‚ä½•å“åº”è¿™ä¸ªé”™è¯¯ã€‚
*   **ä¸»æ—¶é—´è½´ä¸å—å½±å“**ã€‚

## 5. é›†æˆè®¡åˆ’

*   **Phase 1**: åŸºç¡€ Tracer é›†æˆï¼Œå®ç° Action æ—¥å¿—å’Œ State Diffã€‚
*   **Phase 2**: å¯è§†åŒ–æ—¶é—´è½´ï¼Œæ”¯æŒç®€å•çš„å›æ»šã€‚
*   **Phase 3**: æ·±åº¦é›†æˆ Effect Fiberï¼Œå®ç°é€»è¾‘åˆ†å‰ (Forking)ã€‚
</file>

<file path="intent-driven-ai-coding/v3/99-glossary-and-ssot.md">
---
title: 99 Â· æ¦‚å¿µæ€»è§ˆä¸æœ¯è¯­è¡¨ (Glossary & Conceptual SSOT)
status: draft
version: 1 (Concept-First)
---

> æœ¬æ–‡æ¡£ç«™åœ¨ã€Œæ¦‚å¿µå±‚ã€ä¹‹ä¸Šï¼Œå¯¹ v3 é˜¶æ®µå‡ºç°çš„æ ¸å¿ƒæ¦‚å¿µä¸æœ¯è¯­åšç»Ÿä¸€å®šä¹‰ã€‚
> è¿è¡Œæ—¶å®ç°ï¼ˆruntime-logixï¼‰ä¸å¹³å°å®ç°ï¼ˆplatform/Studio/Galaxyï¼‰éƒ½åº”å½“è¢«è§†ä¸ºè¿™äº›æ¦‚å¿µçš„**å…·ä½“åŒ–**ï¼Œè€Œä¸æ˜¯åè¿‡æ¥ç”±å®ç°å»â€œå®šä¹‰â€æ¦‚å¿µã€‚

## 1. åˆ†å±‚è§†è§’ï¼šæˆ‘ä»¬åœ¨è°ˆå“ªäº›ã€Œå±‚ã€ï¼Ÿ

ä»ä¸Šåˆ°ä¸‹ï¼Œå¯ä»¥ç²—ç•¥åˆ†ä¸ºå››å±‚ï¼š

1. **æ¦‚å¿µå±‚ (Conceptual Layer)**
   - è®¨è®ºçš„æ˜¯ã€Œä¸–ç•Œè§‚ã€ï¼š
     - ä»€ä¹ˆæ˜¯ Intentï¼Ÿä»€ä¹ˆæ˜¯ UI / Logic / Module ä¸‰ä½ä¸€ä½“ï¼Ÿ
     - ä»€ä¹ˆç®—â€œéœ€æ±‚æ„å›¾â€ã€â€œå¼€å‘æ„å›¾â€ã€â€œå®ç°â€ï¼Ÿ
   - æœ¬æ–‡æ¡£å±äºè¿™ä¸€å±‚ï¼Œæ˜¯æ‰€æœ‰æœ¯è¯­çš„æœ€ç»ˆè§£é‡Šæƒï¼ˆSSOTï¼‰ã€‚

2. **æ¨¡å‹ä¸åè®®å±‚ (Model & Protocol Layer)**
   - è®¨è®ºçš„æ˜¯ã€Œç»“æ„åŒ–è¡¨è¾¾ã€ï¼š
     - IntentSpec / IntentRule / Asset Schema é•¿ä»€ä¹ˆæ ·ï¼Ÿ
     - Patternã€Blueprintã€Store/Logic/Flow/Control åœ¨ç±»å‹ä¸Šçš„å¥‘çº¦æ˜¯ä»€ä¹ˆï¼Ÿ
   - ä¸»è¦ç”±ä¸‹åˆ—æ–‡æ¡£æ‰¿è½½ï¼š
     - `02-intent-layers.md` / `03-assets-and-schemas.md`
     - `runtime-logix/core/*.md`ï¼ˆStore / Logic / Flow / Control / IntentRuleï¼‰
     - `platform/README.md`ï¼ˆL0â€“L3 èµ„äº§é“¾è·¯ã€å¹³å°è§†å›¾ï¼‰ã€‚

3. **å®ç°å±‚ (Implementation Layer)**
   - è®¨è®ºçš„æ˜¯ã€Œå…·ä½“ä»£ç ã€ï¼š
     - Effect-native çš„ Logix Runtimeï¼›
     - å¹³å°çš„ Parser / Codegen / Studio äº¤äº’ï¼›
     - PoC åœºæ™¯ä¸ Pattern ç¤ºä¾‹ã€‚
   - ä¸»è¦ç”±ï¼š`runtime-logix`ã€`v3/effect-poc`ã€`v3/platform` ç›®å½•å†…ä»£ç ä¸æ–‡æ¡£æ‰¿è½½ã€‚

4. **åº”ç”¨å±‚ (Application Layer)**
   - è®¨è®ºçš„æ˜¯ã€Œåœ¨çœŸå®é¡¹ç›®é‡Œå¦‚ä½•ä½¿ç”¨ã€ï¼š
     - æŸä¸ªä¸šåŠ¡ä»“åº“å¦‚ä½•æ¥å…¥ Logixï¼›
     - æŸæ¡äº§å“çº¿å¦‚ä½•æ²‰æ·€ Pattern / IntentRuleï¼›
     - å›¢é˜Ÿå¦‚ä½•è¿è¥èµ„äº§ã€‚

åé¢æ‰€æœ‰æœ¯è¯­ï¼Œå¦‚æœå‡ºç°æ­§ä¹‰ï¼Œåº”ä¼˜å…ˆä»¥ **æ¦‚å¿µå±‚ â†’ æ¨¡å‹ä¸åè®®å±‚** çš„å®šä¹‰ä¸ºå‡†ï¼Œå†å›çœ‹å®ç°ä¸åº”ç”¨ã€‚

## 2. ä¸‰ä½ä¸€ä½“æ¨¡å‹ç›¸å…³æœ¯è¯­

### 2.1 Intentï¼ˆæ„å›¾ï¼‰

- **Intent**ï¼šå¯¹ã€Œç³»ç»Ÿåº”è¯¥åšä»€ä¹ˆã€çš„ç»“æ„åŒ–æè¿°ï¼Œè€Œä¸æ˜¯ã€Œæ€ä¹ˆåšã€ã€‚
  - ä»ä¸šåŠ¡è§†è§’ï¼šéœ€æ±‚ã€ç”¨ä¾‹ã€äº¤äº’è§„åˆ™ã€‚
  - ä»æŠ€æœ¯è§†è§’ï¼šå¯ä»¥è¢« Codegen / Parser æ¶ˆè´¹çš„ç»“æ„åŒ–æ•°æ®ï¼ˆIntentSpec / IntentRuleï¼‰ã€‚
- Intent æœ¬èº«ä¸ç»‘å®šå…·ä½“æŠ€æœ¯æ ˆï¼ˆReact / Vue / Effect / REST / gRPC ç­‰ï¼‰ï¼Œå®ƒåªæè¿°ï¼š
  - å“ªäº› UI èŠ‚ç‚¹å‚ä¸ï¼›
  - å“ªäº›ä¸šåŠ¡æµç¨‹å‘ç”Ÿï¼›
  - å“ªäº›é¢†åŸŸæ¦‚å¿µ/æ•°æ®è¢«è¯»å†™ã€‚

### 2.2 UI / Logic / Moduleï¼ˆä¸‰ä½ä¸€ä½“ï¼‰

- **UI (Presentation)**
  - è¡¨è¾¾ç•Œé¢ç»“æ„ä¸å±•ç¤ºçŠ¶æ€ï¼›
  - å…³æ³¨â€œçœ‹å¾—è§çš„è¡Œä¸ºâ€ï¼šç»„ä»¶æ ‘ã€å¸ƒå±€ã€äº¤äº’æ§ä»¶ã€è§†è§‰çŠ¶æ€ï¼ˆloading/disabled ç­‰ï¼‰ï¼›
  - ä¸ç›´æ¥æè¿°ä¸šåŠ¡æµç¨‹å’Œé¢†åŸŸè§„åˆ™ï¼Œåªè¡¨è¾¾ã€Œäº¤äº’å…¥å£ã€ä¸ã€Œå±•ç¤ºç»“æœã€ã€‚

- **Logic (Behavior)**
  - è¡¨è¾¾ä¸šåŠ¡è§„åˆ™ä¸æµç¨‹ç¼–æ’ï¼›
  - å…³æ³¨â€œäº‹ä»¶ â†’ æ­¥éª¤ â†’ ç»“æœâ€çš„é“¾è·¯ï¼š
    - è§¦å‘æ¡ä»¶ï¼ˆæŒ‰é’®ç‚¹å‡»ã€å­—æ®µå˜åŒ–ã€å®šæ—¶å™¨ï¼‰ï¼›
    - æ­¥éª¤é¡ºåºï¼ˆä¸²è¡Œ/å¹¶è¡Œ/é‡è¯•/è¡¥å¿ï¼‰ï¼›
    - çŠ¶æ€æ›´æ–°ä¸å‰¯ä½œç”¨ï¼ˆå†™ Storeã€è°ƒç”¨æœåŠ¡ã€å‘é€šçŸ¥ï¼‰ã€‚
  - åœ¨ v3 å®ç°ä¸­ï¼ŒLogic é€šå¸¸è½åœ¨ Logix Runtime çš„ `Store / Logic / Flow / Control` å±‚ã€‚

- **Module (Data)**
  - è¡¨è¾¾ä¸šåŠ¡æ¦‚å¿µä¸æ•°æ®æ¨¡å‹ï¼ˆå®ä½“ï¼‰åŠå…¶ä¸å˜é‡ï¼›
  - åŒ…å«ï¼š
    - å®ä½“ Schemaï¼ˆEmployeeã€Contractã€Taskã€ImportJobâ€¦ï¼‰ï¼›
    - é¢†åŸŸæœåŠ¡å¥‘çº¦ï¼ˆApprovalServiceã€ImportServiceã€NotificationService ç­‰ï¼‰ï¼›
    - é¢†åŸŸé”™è¯¯ï¼ˆApprovalServiceErrorã€FileImportErrorâ€¦ï¼‰ã€‚
  - åœ¨å®ç°å±‚ä¸­ï¼ŒModule é€šå¸¸ä»¥ Effect.Schema + Context.Tag/interface çš„å½¢å¼å‡ºç°ï¼Œä½†æ¦‚å¿µä¸Šå…ˆäºä»»ä½•å…·ä½“å®ç°ã€‚

## 3. èµ„äº§ä¸æ¨¡å¼ç›¸å…³æœ¯è¯­

### 3.1 Patternï¼ˆæ¨¡å¼ï¼‰

- **Pattern Function**ï¼ˆè¿è¡Œæ—¶äº‹å®å½¢æ€ï¼‰ï¼š
  - ç»Ÿä¸€è§†ä¸ºã€ŒEffect-native é•¿é€»è¾‘å°è£…ã€ï¼š
    - çº¯ Effect å½¢æ€ï¼š`runXxxPattern(input: XxxPatternInput): Effect.Effect<A, E, R>`ï¼›
    - Logic Pattern å½¢æ€ï¼š`makeXxxLogicPattern(config?): Logic.Of<Sh, R, A, E>`ã€‚
  - å†…éƒ¨åªä½¿ç”¨ Effect / Service Tag / Store / Logic / Flow / Control ç­‰åŸè¯­ï¼Œä¸å†å¼•å…¥ç¬¬äºŒå¥— DSLã€‚

- **Pattern Asset**ï¼ˆå¹³å°èµ„äº§å½¢æ€ï¼‰ï¼š
  - åœ¨ Pattern Function å¤–å±‚åŒ…ä¸€å±‚ metadataï¼š`{ id, version, configSchema, tags, ... }`ï¼›
  - ç”¨äº Pattern Studio / Galaxy ä¸­è¿›è¡Œæ³¨å†Œã€é…ç½®ä¸è¿è¡Œã€‚

- **Tag-only Pattern**ï¼š
  - Pattern ä¸­åªå®šä¹‰æœåŠ¡å¥‘çº¦ï¼ˆTag + interfaceï¼‰ï¼Œä¸æä¾›é»˜è®¤å®ç°ï¼›
  - å®ç°ç”±æ¶ˆè´¹æ–¹åœ¨åœºæ™¯æˆ– RuntimeLayer ä¸­é€šè¿‡ `Effect.provideService` / `Layer.succeed` æ³¨å…¥ï¼›
  - å…¸å‹ä¾‹å­ï¼šNotification Patternã€Confirm Patternã€‚

### 3.2 IntentRuleï¼ˆæ„å›¾è§„åˆ™ï¼‰

- **IntentRule**ï¼šå¹³å°ä¾§å¯¹ Logic Intent çš„ä¸­é—´è¡¨ç¤ºï¼ˆIRï¼‰ï¼Œç”¨äºå¯è§†åŒ–ä¸ Codegenã€‚
  - æè¿°ã€Œæº (Source) â†’ ç­–ç•¥ç®¡é“ (Pipeline) â†’ ç»ˆç‚¹ (Sink)ã€çš„é“¾è·¯ï¼š
    - Sourceï¼šæ¥è‡ªå“ªä¸ª Store / Service çš„çŠ¶æ€æˆ–åŠ¨ä½œï¼›
    - Pipelineï¼šé˜²æŠ–ã€è¿‡æ»¤ã€å¹¶å‘ç­–ç•¥ç­‰ç®—å­ï¼›
    - Sinkï¼šæ›´æ–°å“ªä¸ªçŠ¶æ€ã€æ´¾å‘å“ªä¸ªåŠ¨ä½œæˆ–è°ƒç”¨å“ªä¸ª Patternã€‚
  - ä¸ä¾èµ–å…·ä½“å®ç°ç»†èŠ‚ï¼Œä½†å¯ä»¥æ˜ å°„åˆ° Store / Logic / Flow / Pattern çš„ä»£ç ç»“æ„ã€‚

### 3.3 èµ„äº§å±‚çº§ï¼ˆL0â€“L3ï¼‰

å‚è€ƒ `03-assets-and-schemas.md` çš„å®šä¹‰ï¼Œè¿™é‡Œåªæç‚¼å…³é”®å«ä¹‰ï¼š

- **L0ï¼šä¸šåŠ¡éœ€æ±‚èµ„äº§**
  - éœ€æ±‚æ–‡æ¡£ã€ç”¨ä¾‹æè¿°ã€PRD æ‘˜è¦ï¼›
  - å½¢æ€ä¸é™ï¼Œä½†åº”èƒ½æ˜ å°„åˆ° IntentSpecã€‚

- **L1ï¼šéœ€æ±‚æ„å›¾ / ç”¨ä¾‹è“å›¾ (Use Case Blueprint)**
  - å°† L0 è‡ªç„¶è¯­è¨€æŠ•å½±åˆ°ä¸‰ä½ä¸€ä½“æ¨¡å‹ä¸ IntentRule é›†åˆä¸Šï¼›
  - æè¿°â€œä¸€ä¸ªç”¨ä¾‹â€æ¶‰åŠå“ªäº› UI/Logic/Module èŠ‚ç‚¹ä¸ç²—ç²’åº¦è§„åˆ™ã€‚

- **L2ï¼šå¼€å‘æ„å›¾èµ„äº§ (Developer Intent)**
  - Pattern `(input) => Effect`ã€Logic æ¨¡æ¿ã€Store æ¨¡æ¿ã€IntentRule é›†åˆï¼›
  - æ˜¯å¹³å°åŒ–ä¸å¤ç”¨çš„ä¸»æˆ˜åœºï¼šPattern + IntentRule æ˜¯é¦–é€‰å¹³å°èµ„äº§ã€‚

- **L3ï¼šå®ç°èµ„äº§ (Implementation)**
  - å…·ä½“é¡¹ç›®ä¸­çš„ä»£ç ä¸é…ç½®ï¼šStore å®ç°ã€Logic å†…éƒ¨ç»†èŠ‚ã€UI ä»£ç ç­‰ï¼›
  - æ›´è´´è¿‘å•ä¸€é¡¹ç›®ï¼Œå¯ä»¥åå‘æç‚¼ä¸º L2 èµ„äº§ã€‚

## 4. Runtime ç›¸å…³æœ¯è¯­ï¼ˆæ¦‚å¿µè§†è§’ï¼‰

### 4.1 Store / Logic / Flow / Control

- **Store**
  - æ¦‚å¿µä¸Šæ˜¯ã€Œä¸€ä¸ªå¯ç‹¬ç«‹æ¼”è¿›/å¤ç”¨çš„çŠ¶æ€+åŠ¨ä½œæ¨¡å—ã€ï¼š
    - æœ‰è‡ªå·±çš„ State Schema ä¸ Action Schemaï¼›
    - æä¾›è¯»å†™ã€è®¢é˜…ä¸æ´¾å‘èƒ½åŠ›ã€‚
  - ä¸ç­‰ä»·äºâ€œé¡µé¢â€æˆ–â€œç»„ä»¶â€ï¼Œæ›´ç±»ä¼¼äºâ€œä¸šåŠ¡æ¨¡å—çš„å¯è¿è¡Œå•å…ƒâ€ã€‚

- **Logic**
  - æ¦‚å¿µä¸Šæ˜¯ã€Œåœ¨æŸä¸€ç±» Store ä¸Šé•¿æœŸè¿è¡Œçš„ä¸€æ®µä¸šåŠ¡ç¨‹åºã€ï¼›
  - ä»¥ Effect å½¢æ€è¡¨è¾¾ï¼ŒEnv ä¸­å¯ä»¥çœ‹åˆ°å½“å‰ Store çš„ runtime èƒ½åŠ›ä»¥åŠé¢å¤–çš„ Module Serviceï¼›
  - é€šè¿‡ Flow / Control ç»„åˆå½¢æˆå¯è§†åŒ–çš„ä¸šåŠ¡æµç¨‹ã€‚

- **Flow**
  - æ¦‚å¿µä¸Šæ˜¯ã€Œå›´ç»•æ—¶é—´ä¸äº‹ä»¶æµçš„ç¼–æ’å·¥å…·é›†ã€ï¼š
    - å›ç­”ã€Œä»å“ªé‡Œå¼€å§‹ï¼Ÿå¦‚ä½•è§¦å‘ï¼Ÿå¦‚ä½•æ§åˆ¶å¹¶å‘ï¼Ÿã€ï¼›
    - fromAction / fromState / debounce / runLatest / runExhaust ç­‰ï¼ˆå¹¶å‘è¯­ä¹‰é€šè¿‡ `run` / `runLatest` / `runExhaust` / `runParallel` ç­‰ç®—å­è¡¨è¾¾ï¼‰ã€‚
  - ä¸è´Ÿè´£ä¸šåŠ¡å†³ç­–ï¼Œåªè´Ÿè´£â€œä»€ä¹ˆæ—¶å€™è·‘å“ªä¸ª Effectâ€ã€‚

- **Control**
  - æ¦‚å¿µä¸Šæ˜¯ã€Œå›´ç»• Effect çš„ç»“æ„åŒ–æ§åˆ¶æµå·¥å…·é›†ã€ï¼š
    - å›ç­”ã€Œè§¦å‘ä¹‹åæ€ä¹ˆæ‰§è¡Œï¼Ÿæœ‰å“ªäº›åˆ†æ”¯/é”™è¯¯åŸŸ/å¹¶å‘ç»“æ„ï¼Ÿã€ï¼›
    - branch / tryCatch / parallel ç­‰ã€‚
  - å¯¹å¹³å°è€Œè¨€ï¼Œè¿™äº›ç®—å­æ˜¯æ„å»º Logic Graph çš„ç»“æ„é”šç‚¹ã€‚

### 4.2 Link (The Edge)

- **Link**
  - æ¦‚å¿µä¸Šæ˜¯ã€Œè¿æ¥ä¸åŒ Store/Module çš„é€»è¾‘çº½å¸¦ã€ï¼š
    - åœ¨å¯è§†åŒ–è§†å›¾ï¼ˆGalaxy/Canvasï¼‰ä¸­è¡¨ç°ä¸ºè¿æ¥ Store èŠ‚ç‚¹çš„â€œè¾¹ï¼ˆEdgeï¼‰â€ï¼›
    - è´Ÿè´£è¡¨è¾¾â€œå½“ A å‘ç”Ÿæ—¶ï¼Œè§¦å‘ Bâ€çš„è·¨æ¨¡å—åä½œæ„å›¾ã€‚
  - **è¿è¡Œæ—¶æ˜ å°„**ï¼š
    - Link **ä¸æ˜¯** ä¸€ä¸ªç‹¬ç«‹çš„è¿è¡Œæ—¶åŸè¯­ï¼ˆæ²¡æœ‰ `Link.define`ï¼‰ã€‚
    - å®ƒåœ¨ä»£ç å±‚é¢é€šè¿‡ **Logic** + **Bound API (`$.use`)** å®ç°ï¼š
      - `$.use(TargetStore)` å£°æ˜ä¾èµ–ï¼›
      - `$.on(Source).then(Target.dispatch)` å®ç°äº¤äº’ã€‚
  - **å†å²æ³¨**ï¼šæ›¾è¢«ç§°ä¸º `Orchestrator`ï¼Œç°å·²åºŸå¼ƒè¯¥æœ¯è¯­ï¼Œç»Ÿä¸€æ”¶æ•›ä¸º Linkï¼ˆå›¾è§†è§’ï¼‰ä¸ Logicï¼ˆä»£ç è§†è§’ï¼‰ã€‚

### 4.2 Intent å‘½åç©ºé—´

- **Intent (L1/L2 é—¨é¢)**
  - æä¾›æ›´æ¥è¿‘ä¸šåŠ¡è¯­ä¹‰çš„åŸè¯­ï¼š
    - L1 IntentRuleï¼šå• Store å†…æ´¾ç”ŸçŠ¶æ€ / äº‹ä»¶é©±åŠ¨çŠ¶æ€æ›´æ–°ï¼ˆå¯¹åº”ä»£ç ä¾§ `$.onState / $.onAction + $.state.update/mutate`ï¼‰ï¼›
    - L2 IntentRuleï¼ˆCoordinateï¼‰ï¼šè·¨ Store åä½œï¼ˆA â†’ Bï¼Œä»£ç ä¾§ä½¿ç”¨ `$.use(StoreSpec) + $.on($Other.changes/...).then($SelfOrOther.dispatch)`ï¼‰ã€‚
  - å¯¹å¹³å°/Parser æ¥è¯´ï¼ŒIntent å‘½åç©ºé—´æ˜¯è¯†åˆ« â€œæ„å›¾åŸè¯­â€ çš„é¦–é€‰å…¥å£ã€‚

## 5. å¹³å°ç›¸å…³æœ¯è¯­ï¼ˆæ¦‚å¿µè§†è§’ï¼‰

### 5.1 å¹³å°è§†å›¾

- **Doc View**ï¼šéœ€æ±‚å½•å…¥ä¸ç”¨ä¾‹æ¢³ç†ï¼ˆå¯¹åº” L0/L1ï¼‰ã€‚
- **Canvas View (Galaxy)**ï¼šè·¨æ¨¡å—åä½œä¸ IntentRule å›¾å½¢åŒ–ç¼–è¾‘ï¼ˆå¯¹åº” L1/L2ï¼‰ã€‚
- **Studio View**ï¼šä»£ç ç”Ÿæˆä¸ç²¾ä¿®ï¼ˆå¯¹åº” L2/L3ï¼‰ï¼Œä¸æœ¬åœ°ä»“åº“ä¸­çš„ Pattern / Store / Logic ç­‰èµ„äº§æ‰“é€šã€‚

### 5.2 Full-Duplex Anchor Engineï¼ˆå…¨åŒå·¥é”šç‚¹å¼•æ“ï¼‰

- æ¦‚å¿µä¸Šæ˜¯ä¸€å¥—ã€ŒIntent â†” Codeã€äº’ç›¸æ˜ å°„çš„åè®®ä¸å·¥å…·é“¾ï¼š
  - Intent â†’ Codeï¼šæ ¹æ® IntentSpec / IntentRule ç”Ÿæˆç¬¦åˆçº¦å®šçš„ Store / Logic / Pattern å®ç°ï¼›
  - Code â†’ Intentï¼šä»å—çº¦æŸçš„ä»£ç å­é›†è§£æå‡º IntentRule / Logic Graphï¼Œå®ç°å¯è§†åŒ–å›æµã€‚
- å…³é”®å‰æï¼š
  - ä»£ç å­é›†å¿…é¡»éµå®ˆä¸Šæ–‡å®šä¹‰çš„ Pattern / Store / Logic / Flow / Control è¯­ä¹‰ï¼›
  - é”šç‚¹ï¼ˆAnchorï¼‰ä¸ IRï¼ˆIntentRuleï¼‰æ˜¯ä¸­é—´æ¡¥æ¢ã€‚

## 6. å†²çªè§£å†³ä¸ SSOT å½’å±

å½“ä½ åœ¨å®ç°æˆ–é˜…è¯»è¿‡ç¨‹ä¸­é‡åˆ°â€œæ¦‚å¿µä¸ä¸€è‡´â€æˆ–â€œå¤šå¤„å®šä¹‰å†²çªâ€æ—¶ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºåˆ¤æ–­ï¼š

1. **ä¼˜å…ˆæŸ¥æœ¬æ–‡ä»¶**ï¼š
   - è‹¥æœ¯è¯­åœ¨æ­¤æœ‰å®šä¹‰ï¼Œä»¥æ­¤ä¸ºå‡†ï¼›
   - è‹¥è¡¨è¿°ä¸å…¶å®ƒæ–‡æ¡£ä¸ä¸€è‡´ï¼Œåº”å…ˆä¿®æ”¹å…¶å®ƒæ–‡æ¡£ï¼Œä½¿ä¹‹ä¸æœ¬æ–‡ä»¶å¯¹é½ã€‚

2. **å…¶æ¬¡æŸ¥æ¨¡å‹ä¸åè®®å±‚æ–‡æ¡£**ï¼š
   - ä¸‰ä½ä¸€ä½“ä¸èµ„äº§ç»“æ„ï¼š`02-intent-layers.md`ã€`03-assets-and-schemas.md`ï¼›
   - Runtime å¥‘çº¦ï¼š`runtime-logix/core/*.md`ï¼›
   - å¹³å°èµ„äº§ä¸è§†å›¾ï¼š`platform/README.md`ã€`06-platform-ui-and-interactions.md`ã€‚

3. **æœ€åçœ‹ PoC ä¸å®ç°ç»†èŠ‚**ï¼š
   - `v3/effect-poc` ä¸å…¶å®ƒè¿è¡Œæ—¶ä»£ç ä»…ä½œä¸ºâ€œå®ç°å‚è€ƒâ€ï¼›
   - å¦‚å®ç°å…ˆäºæ–‡æ¡£æ¼”è¿›ï¼Œåº”å°½å¿«å›å†™æ¦‚å¿µå±‚ä¸æ¨¡å‹å±‚æ–‡æ¡£ï¼Œé¿å…â€œäº‹å®æºæ¼‚ç§»â€ã€‚

> ä¸€å¥è¯è®°å¿†ï¼š**æ¦‚å¿µå…ˆäºå®ç°ï¼Œæ¨¡å‹çº¦æŸå®ç°ï¼ŒPoC ç”¨æ¥å¸®æˆ‘ä»¬éªŒè¯ä¸ä¿®æ­£æ¦‚å¿µ/æ¨¡å‹ï¼Œè€Œä¸æ˜¯åè¿‡æ¥ç”± PoC å†³å®šä¸–ç•Œè§‚ã€‚**
</file>

<file path="intent-driven-ai-coding/v3/implementation-status.md">
# Logix v3 Implementation Status Snapshot

> **Last Updated: 2025-12-01**
>
> æœ¬æ–‡æ¡£ä½œä¸º Logix v3 å®æ–½è¿›åº¦çš„å•ä¸€äº‹å®æºï¼Œæ›¿ä»£æ—§ç‰ˆ TODO æ¸…å•ã€‚

## 1. æ ¸å¿ƒå¼•æ“ Â· @logix/core

**æ•´ä½“çŠ¶æ€**: âœ… **Stable** (å…³é”®è·¯å¾„å·²æ‰“é€šï¼Œè§‚æµ‹æ€§å·²è½åœ°)

- [x] **ModuleRuntime**: æ ¸å¿ƒè¿è¡Œæ—¶ï¼Œæ”¯æŒ State/Action/Logic/Lifecycleã€‚
  - [x] `getState` / `setState` / `dispatch`
  - [x] `changes(selector)`
  - [x] `ref(selector)` (æ”¯æŒ Lens/Prism)
  - [x] é”™è¯¯ä¸ŠæŠ¥ (`lifecycle:error` -> DebugSink)
- [x] **Logic / Flow**: ä¸šåŠ¡é€»è¾‘ç¼–æ’ DSLã€‚
  - [x] `BoundApi` (state, actions, flow, lifecycle)
  - [x] `FlowBuilder` (run, runLatest, runExhaust)
  - [x] `Logic.secure` (é”™è¯¯è¾¹ç•Œä¸è¿½è¸ª)
- [x] **Link / Orchestration**: è·¨æ¨¡å—ç¼–æ’ã€‚
  - [x] `Logic.Link` (å¤šæ¨¡å—è¾“å…¥ï¼Œå£°æ˜å¼è¿æ¥)
  - [x] `Logix.app` (Layer/Scope ç»Ÿä¸€ç®¡ç†ï¼Œè¿›ç¨‹ Fork)
- [x] **Observability**:
  - [x] `DebugSink` (æ”¯æŒ Console/Memory Sink)
  - [x] `Trace` (Action Dispatch, State Update, Lifecycle Error)
- [x] **Testing**:
  - [x] `ModuleRuntime.test.ts` (é”™è¯¯æµéªŒè¯)
  - [x] `Link.test.ts` (è·¨æ¨¡å—é›†æˆéªŒè¯)
  - [x] `compliance/ModuleRuntime.test.ts` (åŸºç¡€åˆè§„æ€§)

**Backlog**:
- [ ] **Performance**: å¤§è§„æ¨¡ Action ååä¸‹çš„æ€§èƒ½ä¼˜åŒ–ã€‚
- [ ] **Remote**: `RemoteStoreAdapter` (PoC é˜¶æ®µ)ã€‚

## 2. æµ‹è¯•å·¥å…·åŒ… Â· @logix/test

**æ•´ä½“çŠ¶æ€**: âœ… **Usable** (æ”¯æŒ TestClock / ExecutionResultï¼Œå¤šæ¨¡å—åœºæ™¯å·²å¯è¦†ç›–æ—¥å¸¸ç”¨ä¾‹)

- [x] `TestProgram` / `runTest`ï¼ˆæ¨èå…¥å£ï¼Œè¿”å› `ExecutionResult`ï¼‰
- [x] åŸºäºé…ç½®çš„åœºæ™¯æ„å»ºï¼ˆå•æ¨¡å— + å¤šæ¨¡å— / Link åœºæ™¯ï¼‰
- [x] **TestClock Integration**:
  - [x] å»é™¤ç¡¬ç¼–ç  `Effect.sleep`ï¼Œé€šè¿‡ `TestClock.adjust` + `waitUntil` æ§åˆ¶æ—¶é—´æ¨è¿›ã€‚
  - [x] `assertState` / `assertSignal` ç»Ÿä¸€ä½¿ç”¨ç¡®å®šæ€§ç­‰å¾… helperã€‚
- [x] **ExecutionResult**:
  - [x] `runTest` / `Scenario.run` è¿”å›å®Œæ•´æ‰§è¡Œ Trace (`ExecutionResult`)ã€‚
  - [ ] åŸºäº Trace çš„é«˜çº§æ–­è¨€å·¥å…· (e.g. `expect(result).toHaveAction('increment')`) ä»åœ¨è®¾è®¡ä¸­ã€‚
- [x] **Multi-Module Support**:
  - [x] `TestProgram.make` æ”¯æŒå¤šæ¨¡å—æ³¨å…¥ï¼ˆLink / åä½œåœºæ™¯ï¼‰ã€‚
  - [ ] å¤šæ¨¡å—åˆå§‹çŠ¶æ€ç›®å‰é€šè¿‡ `modules[].initial` é…ç½®ï¼Œåç»­å¯æŒ‰éœ€è¦è¡¥å……æ›´è¯­ä¹‰åŒ–çš„è¯­æ³•ç³–ã€‚

## 3. React é€‚é…å±‚ Â· @logix/react & @logix/form

**æ•´ä½“çŠ¶æ€**: âš ï¸ **Partial** (åŸºç¡€ Hooks å¯ç”¨ï¼Œé«˜çº§ç‰¹æ€§ä¸è¡¨å•å¼•æ“ç¼ºå¤±)

- [x] **Core Hooks**:
  - [x] `useModule` (è·å– Runtime)
  - [x] `useSelector` (è®¢é˜…çŠ¶æ€å˜åŒ–)
  - [x] `useDispatch` (æ´¾å‘ Action)
- [ ] **Advanced Features**:
  - [ ] **Suspense**: æ”¯æŒå¼‚æ­¥ State è¯»å–æŒ‚èµ·ã€‚
  - [ ] **Concurrent Mode**: éªŒè¯ React 18+ å¹¶å‘æ¸²æŸ“å…¼å®¹æ€§ã€‚
  - [ ] **Scope Isolation**: å¤š `RuntimeProvider` åµŒå¥—åœºæ™¯éªŒè¯ã€‚
- [ ] **Form Engine (@logix/form)**: **CRITICAL MISSING**
  - [ ] `FormShape` å®šä¹‰ (Values + UI State)ã€‚
  - [ ] `FormModule` å·¥å‚ã€‚
  - [ ] `useForm` / `useField` Hooksã€‚
  - [ ] å†…ç½®éªŒè¯é€»è¾‘ (`validate`, `dirty`, `touched`)ã€‚

## 4. Builder / å·¥å…·é“¾ Â· @logix/builder

**æ•´ä½“çŠ¶æ€**: ğŸ›‘ **Not Started**

- [ ] **AST Parsing**: è§£æ Intent DSL / Flow å›¾ã€‚
- [ ] **Code Generation**: ä» Spec ç”Ÿæˆä»£ç ã€‚
- [ ] **Visual Editor**: é›†æˆ ReactFlow / Tldraw (Spec Studio)ã€‚

## ä¼˜å…ˆçº§å»ºè®® (Next Steps)

1.  **@logix/test å‡çº§**: å¼•å…¥ `TestClock` å’Œ `ExecutionResult`ï¼Œæ¶ˆé™¤æµ‹è¯•ä¸­çš„ä¸ç¡®å®šæ€§ (Flakiness)ï¼Œä¸ºåç»­å¤æ‚åœºæ™¯æµ‹è¯•æ‰“åº•ã€‚
2.  **React é«˜çº§ç‰¹æ€§éªŒè¯**: è¡¥å…… Suspense/Concurrent æµ‹è¯•ï¼Œç¡®ä¿ UI å±‚å¥å£®ã€‚
3.  **Form å¼•æ“å¯åŠ¨**: å®ç° `@logix/form`ï¼Œè¿™æ˜¯ ToB ä¸šåŠ¡æœ€æ ¸å¿ƒçš„åœºæ™¯ã€‚
</file>

<file path="intent-driven-ai-coding/v3/roadmap-logix-platform.md">
---
title: Logix & Platform Â· Roadmap (v3)
status: draft
version: 1
---

> ä½œç”¨ï¼šä½œä¸ºã€ŒLogix Runtime + å¹³å°ä¾§ Intent & å‡ºç ã€é˜¶æ®µæ€§çš„å¯¹é½æ–‡æ¡£ï¼Œç”¨äºåœ¨è§„åˆ’æœŸæŒç»­æ ¡å‡†èŠ‚å¥ä¸ä¼˜å…ˆçº§ã€‚
> å…³æ³¨èŒƒå›´ï¼šv3 é˜¶æ®µï¼ˆæ„å›¾æ˜¾å½± + å•å‘å‡ºç ï¼‰ï¼Œä¸ºåç»­ v4 å…¨åŒå·¥ / v5 è‡ªæ„ˆé“ºè·¯ã€‚

## 0. æ€»ç›®æ ‡ï¼ˆv3 é˜¶æ®µï¼‰

- ä»¥ v3 ä¸‰ä½ä¸€ä½“æ¨¡å‹ï¼ˆUI / Logic / Moduleï¼‰ä¸ºåŸºç¡€ï¼Œ
  å»ºç«‹ä¸€æ¡ **ã€Œä¸šåŠ¡éœ€æ±‚ â†’ éœ€æ±‚æ„å›¾ â†’ å¼€å‘æ„å›¾ â†’ Logix ä»£ç ã€çš„å¯è½åœ°é“¾è·¯**ã€‚
- æ‰“ç£¨ä¸€å¥—è¶³å¤Ÿè¡¨è¾¾çœŸå®é¡¹ç›®çš„ **Logix Runtime + Intent APIï¼ˆL1/L2/L3ï¼‰**ï¼Œ
  å¹¶éªŒè¯å…¶åœ¨å…¸å‹ ToB åœºæ™¯ä¸­çš„ã€Œå¯è¡¨è¾¾æ€§ + å¯ç»´æŠ¤æ€§ã€ã€‚
- åœ¨å¹³å°ä¾§å…ˆè·‘é€š **å¹³å° â†’ å‡ºç **ï¼ˆå•å‘ï¼‰ï¼Œ
  åŒæ—¶ä¸ºæœªæ¥çš„ **Code â†’ IntentRule â†’ å›¾ï¼ˆåŒå‘ï¼‰** é¢„ç•™ç»“æ„åŒ–é”šç‚¹ï¼ˆIntentRule / L1/L2/L3 è§„åˆ™å½¢æ€ï¼‰ã€‚

## 1. è®¾è®¡çº¦æŸä¸ä¸å˜é‡

1. **æ–‡æ¡£å…ˆäºå®ç°**
   - ä»»ä½•æ¶‰åŠ Intent æ¨¡å‹ã€Logix Runtimeã€å¹³å°äº¤äº’çš„å˜æ›´ï¼Œå¿…é¡»å…ˆåœ¨ `docs/specs` v3 ä½“ç³»ä¸­è¾¾æˆå…±è¯†ï¼Œå†è¿›å…¥ PoC / è¿è¡Œæ—¶ä»£ç ã€‚
   - SSOT ä¼˜å…ˆçº§ä»¥ `v3/01-overview.md` ç¬¬ 7 èŠ‚çš„è§„åˆ™ä¸ºå‡†ã€‚

2. **Effect-Native & Intent-Friendly**
   - Runtime ä»¥ Effect-TS ä¸ºå”¯ä¸€æ‰§è¡Œå¼•æ“ï¼ŒAPI è®¾è®¡éµå®ˆ A/E/R æ³›å‹é¡ºåºä¸ Env é€†å˜è§„åˆ™ï¼›
   - Intent / Flow / IntentRule ä¸€å¾‹ä»¥â€œæ˜“è¢« LLM å’Œ Parser ç†è§£â€ä¸ºå‰æï¼ˆå°½é‡è¯­ä¹‰åŒ–å‘½å + é™å®šå¯è§£æå­é›†ï¼‰ã€‚

3. **å…ˆå¹³å°â†’å‡ºç ï¼Œåå…¨åŒå·¥**
   - v3 é˜¶æ®µä¸ä»¥â€œå®Œå…¨åŒå‘åŒæ­¥â€ä½œä¸ºç¡¬ç›®æ ‡ï¼Œä½†æ‰€æœ‰ç”Ÿæˆçš„ä»£ç åº”å½“ **ç»“æ„ä¸Šå¯è¢«è§£æå› IntentRule**ï¼›
   - Codeâ†’Graph çš„å®ç°å¯ä»¥æ»åï¼Œä½†ä¸èƒ½å› ä¸ºçŸ­æœŸå®ç°è€Œç ´åé•¿æœŸå¯è§£ææ€§ã€‚

4. **Runtime ä¼˜å…ˆå¯è¡¨è¾¾æ€§ï¼Œä¸åš premature micro-optim**
   - åœ¨å…¸å‹ä¸šåŠ¡åœºæ™¯ä¸‹ä¼˜å…ˆä¿è¯â€œèƒ½å†™æ¸…æ¥šã€èƒ½æ‹†å¼€ã€èƒ½è°ƒè¯•â€ï¼Œæ€§èƒ½ä¼˜åŒ–æ”¾åœ¨è¿è¡Œç¨³å®šåé›†ä¸­å¤„ç†ã€‚

## 2. åˆ†é˜¶æ®µè·¯çº¿å›¾ï¼ˆv3 å†…éƒ¨ï¼‰

### Phase Aï¼šæ”¶æ•›æ¨¡å‹ä¸ APIï¼ˆå·²å®Œæˆå¤§éƒ¨åˆ†ï¼‰

ç›®æ ‡ï¼šæŠŠã€Œè¯´è¯æ–¹å¼ã€ç»Ÿä¸€å¥½ã€‚

- æ¨¡å‹å±‚ï¼š
  - v3 ä¸‰ä½ä¸€ä½“æ¨¡å‹ï¼š`v3/02-intent-layers.md`ï¼›
  - èµ„äº§ç»“æ„ï¼š`v3/03-assets-and-schemas.md`ï¼›
  - é•¿æœŸè“å›¾ï¼š`blueprint.md` + `00-platform-manifesto.md`ã€‚
- Runtime & Intent APIï¼š
  - Logix æ ¸å¿ƒï¼š`runtime-logix/core/02-module-and-logic-api.md`ã€`03-logic-and-flow.md`ï¼›
  - Intent åŸè¯­ï¼ˆL1/L2ï¼‰ï¼šä»¥ Fluent DSLï¼ˆ`$.onState / $.onAction / $.on + $.state/dispatch`ï¼‰è¡¨è¾¾çš„æ ‡å‡†è§„åˆ™ï¼Œåœ¨ IR ä¸­æ˜ å°„ä¸º L1/L2 IntentRuleï¼›
  - å¹³å° IRï¼š`runtime-logix/core/06-platform-integration.md` ä¸­çš„ `IntentRule`ã€‚
- å¹³å°è§†è§’ï¼š
  - è§†å›¾ä½“ç³»ä¸äº¤äº’åŸåˆ™ï¼š`v3/06-platform-ui-and-interactions.md`ï¼›
  - Intent & UX è§„åˆ’ + L0â€“L3 èµ„äº§é“¾è·¯ï¼š`v3/platform/README.md`ã€‚

âœ… æœ¬é˜¶æ®µä¸»è¦å·¥ä½œå·²å®Œæˆï¼Œåç»­åªéœ€è·Ÿéšæ¼”è¿›åšå¢é‡ä¿®è®¢ã€‚

### Phase Bï¼šæ‰“å® Logix Runtime è¡¨è¾¾åŠ›ï¼ˆå½“å‰é‡ç‚¹ï¼‰

ç›®æ ‡ï¼šç”¨ Logix + Intent API æŠŠâ€œçœŸå®ä¸šåŠ¡åœºæ™¯â€å†™é¡ºæ‰‹ã€‚

1. **è¡¥é½ PoC åœºæ™¯çŸ©é˜µï¼ˆeffect-pocï¼‰**
   - åˆ—å‡º 5â€“10 ä¸ªæ¥è‡ªçœŸå®é¡¹ç›®çš„å…¸å‹åœºæ™¯ï¼ˆå»ºè®®åˆ†ç±»ï¼‰ï¼š
     - æœç´¢ + è¯¦æƒ… / åˆ—è¡¨ + è¿‡æ»¤ï¼›
     - å®¡æ‰¹æµ / æäº¤æµç¨‹ï¼›
     - é•¿ä»»åŠ¡ / å¯¼å‡º / Jobï¼›
     - è·¨ Store åä½œï¼ˆå…¨å±€äº‹ä»¶ / å¤šæ¨¡å—åŒæ­¥ï¼‰ï¼›
     - å¤æ‚è¡¨å•è”åŠ¨ã€‚
   - æ¯ç±»è‡³å°‘ç”¨ Logix + Fluent DSL å†™å‡ºä¸€ä¸ª PoCï¼š
     - å• Store å†…ä¼˜å…ˆç”¨ `$.onState / $.onAction + $.state.update/mutate` + Flow + Patternï¼›
     - è·¨ Store ç”¨ `$.use(StoreSpec) + Fluent DSLï¼ˆ$Other.changes/â€¦ â†’ $SelfOrOther.dispatchï¼‰`ï¼›
     - éœ€è¦ Service/åç«¯ Flow çš„åœ°æ–¹ç”¨ Pattern + Effect.Serviceã€‚

2. **Runtime èƒ½åŠ›æ”¶æ•›åˆ° effect-runtime-poc**
   - å°†åœ¨ effect-poc ä¸­è¯æ˜æœ‰æ•ˆçš„å†™æ³•ï¼Œä¸‹æ²‰ä¸º `packages/effect-runtime-poc` ä¸­çš„å…¬å…± Helper / Layer ç»„åˆï¼›
   - ç¡®ä¿ runtime-logix æ–‡æ¡£ï¼ˆç‰¹åˆ«æ˜¯ `02-module-and-logic-api` / `03-logic-and-flow`ï¼‰ç´§è·Ÿè¿™äº›èƒ½åŠ›æ›´æ–°ã€‚

3. **æ¯è½® PoC åçš„å›å†™ä¸åæ€**
   - å¯¹æ¯ä¸ª PoCï¼šè®°å½•â€œå“ªäº›åœ°æ–¹å†™èµ·æ¥ä¸é¡ºæ‰‹â€â€œå“ªäº›æ¨¡å¼è¢«åå¤ copy-pasteâ€ï¼›
   - è®¨è®ºæ˜¯å¦ï¼š
     - ä¸Šå‡ä¸ºæ–°çš„ Intent åŸè¯­ / Patternï¼›
     - æˆ–è€…æ˜¯æ¨¡å‹è®¾è®¡é—®é¢˜ï¼Œéœ€è¦è°ƒæ•´ Store/Logic/Patter/IntentRule çš„è§’è‰²åˆ’åˆ†ã€‚

äº§å‡ºï¼š
- ä¸€å¥—è¦†ç›–å…¸å‹åœºæ™¯çš„ `v3/effect-poc/scenarios`ï¼›
- runtime-logix æ–‡æ¡£ä¸­å¯¹è¿™äº›æ¨¡å¼çš„æ€»ç»“ä¸æ¨èç”¨æ³•ï¼›
- åˆæ­¥éªŒè¯â€œLogix + Intent APIâ€åœ¨çœŸå®åœºæ™¯ä¸‹çš„å¯è¡¨è¾¾æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚

### Phase Cï¼šè–„ç‰ˆå¹³å° â†’ å‡ºç ï¼ˆMVPï¼‰

ç›®æ ‡ï¼šåœ¨ä¸é‡å·¥ç¨‹é‡çš„å‰æä¸‹ï¼Œæ‰“é€šã€Œå¹³å°è§„åˆ™é…ç½® â†’ IntentRule â†’ TS ä»£ç ã€é“¾è·¯ã€‚

1. **IntentRule â†’ ä»£ç çš„æœ€å°ç”Ÿæˆå™¨**
   - è¾“å…¥ï¼šæ‰‹å†™æˆ– UI ç”Ÿæˆçš„ `IntentRule` JSONï¼›
   - è¾“å‡ºï¼š
     - æ ‡å‡†åŒ–çš„ `*.logic.ts`ï¼ˆæˆ–åœºæ™¯æ–‡ä»¶ï¼‰é‡Œçš„ Fluent DSL / Flow è°ƒç”¨ï¼›
     - å¿…è¦çš„ import / Tag / Shape å¼•ç”¨ã€‚
   - ä¼˜å…ˆæ”¯æŒï¼š
     - L1ï¼šç”Ÿæˆ L1 IntentRuleï¼ˆself.state/self.action â†’ self.mutateï¼‰ï¼›
     - L2ï¼šç”Ÿæˆ L2 IntentRuleï¼ˆA.state/A.action â†’ B.dispatchï¼‰ï¼›
     - ç®€å• pipelineï¼šç”Ÿæˆ `flow.debounce/filter/runLatest` ç»„åˆã€‚

2. **è§„åˆ™è¡¨è§†å›¾ï¼ˆIntentRule Explorerï¼‰MVP**
   - æœ€ç®€ UIï¼š
     - ä¸€ä¸ªè§„åˆ™è¡¨æ ¼ï¼ˆæ¯è¡Œæ˜¯ä¸€æ¡ IntentRuleï¼‰+ æ–°å»º/ç¼–è¾‘è¡¨å•ï¼›
     - ä¸€ä¸ªâ€œç”Ÿæˆ/æ›´æ–° TS æ–‡ä»¶â€çš„æŒ‰é’®ã€‚
   - æš‚æ—¶ä¸åš Galaxy ç”»å¸ƒï¼Œåªç”¨è¡¨æ ¼/è¡¨å•éªŒè¯ï¼š
     - PM/å¼€å‘åœ¨ UI ä¸Šè°ƒæ•´è§„åˆ™ â†’ ç”Ÿæˆä»£ç  â†’ åœ¨ IDE ä¸­æŸ¥çœ‹ / è°ƒæ•´ â†’ è¿è¡Œ PoCã€‚

3. **ä¸ PoC åœºæ™¯é›†æˆ**
   - é€‰ effect-poc ä¸­ 1â€“2 ä¸ªåœºæ™¯ï¼Œå…ˆç”¨æ‰‹å†™è§„åˆ™ï¼Œå†ç”¨ UI å¡«è¡¨å•ç”Ÿæˆè§„åˆ™å’Œä»£ç ï¼›
   - å¯¹æ¯”ä¸¤ç§æ–¹å¼ä½“éªŒï¼Œæ”¶é›†â€œå¹³å°ä¾§å‡ºç â€çš„çœŸå®åé¦ˆã€‚

äº§å‡ºï¼š
- ä¸€ä¸ªå¯ä»¥è¿è¡Œçš„ â€œIntentRule â†’ TSâ€ ç”Ÿæˆè„šæœ¬/æœåŠ¡ï¼›
- ä¸€ä¸ªå¯ç”¨çš„è§„åˆ™è¡¨ UIï¼ˆå“ªæ€•æ˜¯ç®€é™‹çš„å†…éƒ¨å·¥å…·ï¼‰ï¼›
- ä¸€å¥—è¢«å¹³å°å‡ºç è¦†ç›–çš„ PoC åœºæ™¯ï¼Œç”¨äºåç»­ Galaxy ç”»å¸ƒçš„éªŒè¯åŸºç¡€ã€‚

### Phase Dï¼šä¸ºå…¨åŒå·¥æ‰“é”šï¼ˆä¸æ€¥å®ç°ï¼Œå…ˆç•™é’©å­ï¼‰

ç›®æ ‡ï¼šä¸ç»™æœªæ¥çš„ Codeâ†’Graph æŒ–å‘ï¼Œè€Œä¸æ˜¯ç°åœ¨å°±å®ç°å®ŒåŒå‘åŒæ­¥ã€‚

1. **çº¦æŸ å¯è§£æå­é›† çš„ä»£ç é£æ ¼**
   - å¯¹ Intent API ä½¿ç”¨å®šä¹‰ç®€å•çº¦æŸï¼š
     - ä¸€æ¡è§„åˆ™å¯¹åº”ä¸€ä¸ª IntentRuleï¼ˆä¸å†è¦æ±‚æœ‰å¯¹åº”çš„ `Intent.*` è°ƒç”¨ï¼‰ï¼›
     - é¿å…åœ¨å•ä¸ª Effect.gen é‡ŒæŠŠå¤šä¸ªè§„åˆ™å†™æˆäº’ç›¸äº¤é”™çš„ if/loopï¼›
     - Intent.react / Flow ç»„åˆå…ˆé™åˆ¶åœ¨å°‘é‡å¯è§£ææ¨¡å¼ã€‚
   - ç”¨ ESLint / è‡ªå®šä¹‰æ£€æŸ¥è„šæœ¬æç¤ºè¶Šç•Œç”¨æ³•ã€‚

2. **PoC çº§ Codeâ†’IntentRule è§£æå™¨**
   - é’ˆå¯¹ç°æœ‰ PoC ä»£ç ï¼Œå®ç°ä¸€ä¸ªåŸºäº ts-morph çš„ç®€å• Parserï¼šè¯†åˆ« Fluent DSLï¼ˆ`$.onState` / `$.onAction` / `$.on`ï¼‰è°ƒç”¨å¹¶è¿˜åŸä¸º IntentRuleï¼›
   - ç”¨äºéªŒè¯ï¼š
     - ç°æœ‰ä»£ç æ˜¯å¦å¤§éƒ¨åˆ†è½åœ¨å¯è§£æå­é›†å†…ï¼›
     - å“ªäº›å†™æ³•éœ€è¦ç‰¹åˆ«å¤„ç†æˆ–æ‰“ä¸Š Gray/Black Box æ ‡è®°ã€‚

3. **ä¸ Blueprint å¯¹é½æ—¶é—´**
   - æ ¹æ® `blueprint.md` ä¸­ v4 å…¨åŒå·¥èŠ‚å¥å®‰æ’ï¼Œå°†è§£æå™¨/å¯è§†åŒ–è°ƒè¯•æ’å…¥åç»­ç‰ˆæœ¬ï¼Œè€Œä¸åœ¨ v3 å¼ºæ±‚äº¤ä»˜ã€‚

## 3. é˜¶æ®µå†…çš„å†³ç­–åŸåˆ™

åœ¨ v3 Roadmap æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œé‡åˆ°â€œè¦ä¸è¦åš X / æ€ä¹ˆåš Xâ€çš„é—®é¢˜æ—¶ï¼Œå¯ä»¥å…ˆå¯¹ç…§ï¼š

1. **æ˜¯å¦ç ´å v3 Intent æ¨¡å‹ / Runtime è¯­ä¹‰ï¼Ÿ**
   - å¦‚æœ‰å†²çªï¼Œå…ˆå›åˆ° `v3/02-intent-layers.md`ã€`03-assets-and-schemas.md`ã€runtime-logix æ–‡æ¡£ä¿®æ¨¡å‹ï¼Œå†åŠ¨å®ç°ã€‚

2. **æ˜¯å¦æœ‰åŠ©äº Logix è¡¨è¾¾çœŸå®åœºæ™¯ï¼Ÿ**
   - Phase B ä¼˜å…ˆï¼šèƒ½è®© 1â€“2 ä¸ªçœŸå®ä¸šåŠ¡åœºæ™¯â€œå†™é¡ºæ‰‹â€çš„æ”¹åŠ¨ä¼˜å…ˆçº§é«˜äºçº¯ç†è®ºä¸Šçš„ä¼˜é›…ã€‚

3. **æ˜¯å¦é™ä½æœªæ¥å¹³å°â†’å‡ºç  / Codeâ†’Graph çš„éš¾åº¦ï¼Ÿ**
   - ä¼˜å…ˆé€‰æ‹©ç»“æ„åŒ–ã€æ˜“è§£æçš„ API å½¢æ€ï¼Œå³ä¾¿å†™èµ·æ¥ç¨å¾®å•°å—¦ä¸€ç‚¹ã€‚

4. **æ˜¯å¦å¯ä»¥å…ˆåœ¨ PoC éªŒè¯ï¼Œå†æ²‰æ·€ä¸ºè§„èŒƒï¼Ÿ**
   - æ–° API / æ–° Pattern / æ–° IntentRule ç±»å‹ï¼Œç»Ÿä¸€å…ˆåœ¨ effect-poc ä¸­è¯•éªŒï¼Œå†å‡çº§åˆ° runtime-logix / v3 è§„èŒƒã€‚

æœ¬ Roadmap æœ¬èº«ä¹Ÿæ˜¯â€œliving documentâ€ï¼š
- æ¯å®Œæˆä¸€ä¸ª Phase æˆ–ç»å†ä¸€æ¬¡è¾ƒå¤§æ–¹å‘è°ƒæ•´æ—¶ï¼Œåº”å›åˆ°æœ¬æ–‡ä»¶æ›´æ–°ç›®æ ‡ä¸ä¼˜å…ˆçº§ï¼›
- è‹¥ Roadmap ä¸ `01-overview.md` / runtime-logix / platform è§„èŒƒäº§ç”Ÿå†²çªï¼Œä»¥è¿™äº› SSOT ä¸ºå‡†ï¼Œå¹¶åŒæ­¥ä¿®è®¢æœ¬æ–‡ä»¶ã€‚

## 4. å®ç°å¤‡å¿˜ä¸é£é™©å‰ç§»

ä» v3 æ”¶å°¾é˜¶æ®µå¼€å§‹ï¼Œå¹³å°ä¸è¿è¡Œæ—¶åœ¨è®¨è®ºã€Œå¤æ‚æ¶æ„çº§ APIã€æ—¶ï¼ˆä¾‹å¦‚ `Logix.app` / åˆ†å½¢æ¨¡å—ä½“ç³»ã€Logic Middlewareã€ç”Ÿå‘½å‘¨æœŸé’©å­ã€åŒå‘åŒæ­¥è§£æå™¨ï¼‰ï¼Œéœ€è¦**åŒæ­¥æ€è€ƒä¸è®°å½•å…¶å®ç°ç»†èŠ‚å’Œæ½œåœ¨éšæ‚£**ï¼Œé¿å…åç»­è½åœ°æ—¶è·‘åã€‚

å…·ä½“çº¦å®šï¼š

- **è¿è¡Œæ—¶ä¾§**ï¼š
  - æ‰€æœ‰å›´ç»• `ModuleDef` / AppRuntime / Module å±•å¼€ã€ä»¥åŠ Logic Middlewareã€Store ç”Ÿå‘½å‘¨æœŸçš„å®ç°æ€è·¯ä¸å–èˆï¼Œæ²‰æ·€åœ¨ `docs/specs/runtime-logix/impl/` ä¸‹ï¼ˆä¾‹å¦‚ `app-runtime-and-modules.md`ã€`logic-middleware-and-aop.md`ï¼‰ï¼›
  - è¿™äº›æ–‡æ¡£å¯ä»¥æ¯” core/ è§„èŒƒæ›´ç»†ã€æ›´å·¥ç¨‹åŒ–ï¼Œä½†ä¸€æ—¦å‘ç°ä¸æ ¸å¿ƒè§„èŒƒå†²çªï¼Œåº”å…ˆä¿® core/ å†ä¿® impl/ã€‚

- **å¹³å°ä¾§**ï¼š
  - å›´ç»• Universe View / Galaxy Viewã€IntentRule â†” TS ä»£ç ç”Ÿæˆã€AOP é…ç½®ä¸å¯è§†åŒ–ç­‰èƒ½åŠ›çš„è§£æ/ç”Ÿæˆé€»è¾‘ï¼Œæ²‰æ·€åœ¨ `v3/platform/impl/` ä¸‹ï¼ˆä¾‹å¦‚ `app-and-universe-view.md`ã€`intent-rule-and-codegen.md`ï¼‰ï¼›
  - å¹³å°å®ç°è€…åœ¨è®¾è®¡è§£æå™¨ä¸å‡ºç é“¾è·¯æ—¶ï¼Œä¼˜å…ˆæŸ¥é˜…è¿™äº›å®ç°å¤‡å¿˜ï¼Œå¹¶åœ¨æ–¹æ¡ˆç¡®å®šåå›å†™ä¸»è§„æ ¼ï¼ˆplatform/ ä¸ runtime-logix/core/ï¼‰ã€‚

ç›®æ ‡æ˜¯ï¼š**åœ¨è§„åˆ’é˜¶æ®µå°±æŠŠå¯èƒ½è¸©å‘çš„ç‚¹å‰ç§»åˆ°æ–‡æ¡£ä¸­**ï¼Œè®©åç»­å®ç°å·¥ä½œå°½é‡æ˜¯åœ¨â€œæœ‰åœ°åŸºçš„æ–½å·¥â€ï¼Œè€Œä¸æ˜¯åœ¨å¼€å‘ä¸­ä¸´æ—¶æ‹æ¿æ ¸å¿ƒæ¶æ„å†³ç­–ã€‚
</file>

<file path="intent-driven-ai-coding/v3/SCHEMA_EVOLUTION.md">
---
title: Schema æ¼”è¿›ä¸å…¼å®¹æ€§åˆåŒ
status: draft
version: 1
---

> v2 çš„æ‰€æœ‰ Specï¼ˆIntent/Pattern/Template/Plan/Flow/UseCase ç­‰ï¼‰åœ¨æ¼”è¿›æ—¶å¿…é¡»éµå®ˆæœ¬åˆåŒï¼Œç¡®ä¿â€œNever break userspaceâ€ã€‚

## 1. å˜æ›´çº§åˆ«

- **æ–°å¢å­—æ®µ**ï¼šå¿…é¡»å¯é€‰ä¸”æœ‰åˆç†é»˜è®¤ï¼Œä¸å¾—æ”¹å˜æ—¢æœ‰è¯­ä¹‰ã€‚
- **ä¿®æ”¹å­—æ®µè¯­ä¹‰/ç»“æ„**ï¼šå…ˆæ ‡è®°ä¸º `deprecated`ï¼Œæä¾›è¿ç§»è¯´æ˜ä¸è„šæœ¬ï¼Œè‡³å°‘ç»å†ä¸¤ä¸ªå°ç‰ˆæœ¬åæ‰å¯ç§»é™¤ã€‚
- **åˆ é™¤å­—æ®µ**ï¼šä»…åœ¨ deprecated æœŸæ»¡åæ‰§è¡Œï¼Œå¹¶æä¾›è‡ªåŠ¨è¿ç§»ã€‚
- **ç ´åæ€§å˜æ›´**ï¼ˆå¿…ç„¶å¯¼è‡´æ—§èµ„äº§å¤±æ•ˆï¼‰ï¼šå¿…é¡»æä¾›åŒå‘è¿ç§»å™¨æˆ–é•¿æœŸå¼€å¯è¯»æ—¶å…¼å®¹å±‚ï¼Œä¸”éœ€åœ¨ç‰ˆæœ¬å‘å¸ƒè¯´æ˜ä¸­æ˜ç¡®æ ‡æ³¨ã€‚

## 2. ID ä¸å¼•ç”¨

- å…­ç±»æ„å›¾ã€Use Caseã€Flowã€PlanActionã€TemplateBinding ç­‰å‡ä½¿ç”¨ç»Ÿä¸€ ID è§„èŒƒï¼ˆå‰ç¼€+è¯­ä¹‰ï¼‰ã€‚
- ç¦æ­¢è£¸å­—ç¬¦ä¸²å¼•ç”¨å¤–éƒ¨å®ä½“ï¼šFlow.trigger å¿…é¡»å¼•ç”¨ Interaction.eventIdï¼ŒPlanAction å¿…é¡»å¼•ç”¨ patternId/templateId/fileId ç­‰æ³¨å†Œ IDã€‚
- é‡å‘½ååŸåˆ™ï¼šæä¾›æ‰¹é‡è¿ç§»å·¥å…·ä¿è¯å¼•ç”¨åŒæ­¥ï¼›æ— æ³•è‡ªåŠ¨è¿ç§»æ—¶éœ€é˜»æ–­å‘å¸ƒå¹¶ç»™å‡ºäººå·¥ä¿®å¤æŒ‡å¼•ã€‚

## 3. äº‹å®æºä¸æŠ•å½±

- Data & Stateï¼šä¼˜å…ˆå°†å®ä½“/API ç»‘å®šåˆ°å¤–éƒ¨ schemaï¼ˆOpenAPI/TS ç±»å‹ï¼‰ï¼›Intent ä¸­çš„ç»“æ„è§†ä¸ºæŠ•å½±è€Œéäº‹å®æºã€‚
- Interactionï¼šäº‹ä»¶ `source/event` åªåœ¨ Interaction ä¸­å®šä¹‰ï¼ŒFlow/Behavior å¿…é¡»å¼•ç”¨äº‹ä»¶ IDã€‚
- Code Structureï¼šPlan/Template è·¯å¾„å— best-practice ç›®å½•è§„èŒƒçº¦æŸï¼›è·¯å¾„å˜æ›´éœ€æä¾›å…¼å®¹æ˜ å°„æˆ–è¿ç§»ã€‚

## 4. Plan/Template çš„å¹‚ç­‰ä¸å†²çª

- `create-file`ï¼šæ–‡ä»¶å­˜åœ¨æ—¶ä¸å¾—è¦†ç›–ç”¨æˆ·ä»£ç ï¼Œéœ€ no-op æˆ–æ˜¾å¼æŠ¥å†²çªã€‚
- `modify-file`/`append-snippet`ï¼šåº”åŸºäºé”šç‚¹/AST çš„ç²¾ç¡® patchï¼›å¤šæ¬¡æ‰§è¡Œç»“æœåº”ä¸€è‡´ã€‚
- æ‰§è¡Œå‰å¿…é¡»æ”¯æŒ dry-run diffï¼Œæ‰§è¡Œåå¯é‡å¤è¿è¡Œï¼Œä¸å¾—å‡ºç°é‡å¤ç‰‡æ®µã€‚

## 5. å…¼å®¹æ€§éªŒè¯ä¸å‘å¸ƒæµç¨‹

- æ¯æ¬¡ schema å˜æ›´éœ€æ›´æ–°æœ¬æ–‡ä»¶å¯¹åº”æ¡ç›®ï¼Œå¹¶åœ¨ changelog æ ‡æ³¨å…¼å®¹æ€§çº§åˆ«ã€‚
- ç ´åæ€§å˜æ›´å‘å¸ƒå‰ï¼Œéœ€åœ¨çœŸå®ä»“åº“è·‘é€šä¸€æ¬¡â€œæ—§èµ„äº§ â†’ è¿ç§» â†’ æ–°èµ„äº§â€çš„ç«¯åˆ°ç«¯éªŒè¯ã€‚
- CLI/LSP åº”å†…ç½®ç‰ˆæœ¬æ£€æŸ¥ï¼šæ£€æµ‹åˆ°ä¸å…¼å®¹èµ„äº§æ—¶ç»™å‡ºæ˜ç¡®é”™è¯¯ä¸è¿ç§»å»ºè®®ã€‚

## 6. è¿ç§»å·¥å…·åŸåˆ™

- ä¼˜å…ˆæä¾›è‡ªåŠ¨è¿ç§»è„šæœ¬ï¼›æ— æ³•è‡ªåŠ¨åŒ–çš„éƒ¨åˆ†éœ€ç»™å‡ºæœ€å°å¯æ‰§è¡Œçš„æ‰‹åŠ¨æ­¥éª¤ã€‚
- ä¿æŒè¿ç§»å¹‚ç­‰ï¼šé‡å¤è¿è¡Œä¸å¾—æŸåå·²è¿ç§»èµ„äº§ã€‚
- è¿ç§»è„šæœ¬è‡ªèº«ç‰ˆæœ¬åŒ–ï¼Œå¹¶åœ¨å‘å¸ƒä¸­è®°å½•é€‚ç”¨èŒƒå›´ä¸å›é€€ç­–ç•¥ã€‚
</file>

<file path="intent-driven-ai-coding/adr.md">
---
title: æ¶æ„æ¼”è¿›ä¸å†³ç­–è®°å½• (Architecture Decision Records)
status: living
---

> æœ¬æ–‡æ¡£è®°å½•äº† Intent-Driven AI Coding å¹³å°æ¶æ„æ¼”è¿›è¿‡ç¨‹ä¸­çš„å…³é”®å†³ç­–ã€‚è¯¦ç»†è®¾è®¡ä¸å†å²èƒŒæ™¯è¯·å‚è€ƒå„ç‰ˆæœ¬çš„å…·ä½“æ–‡æ¡£ã€‚

## ADR-003: æ”¶æ•›ä¸ºâ€œä¸‰ä½ä¸€ä½“â€æ¨¡å‹ (v3)

*   **æ—¥æœŸ**: 2025-11-23
*   **çŠ¶æ€**: **Accepted (Active)**
*   **å†³ç­–**: 
    åŸºäºå¥¥å¡å§†å‰ƒåˆ€åŸåˆ™ï¼Œå°†æ„å›¾æ”¶æ•›ä¸º **UI / Logic / Domain** ä¸‰å¤§ç»´åº¦ï¼Œå¼•å…¥ **Spec/Impl åŒæ¨¡æ€**ï¼Œå¹¶ç¡®ç«‹å¹³å°ä¸ºå‰ç«¯å¼€å‘è€…çš„â€œæ„å›¾æ˜¾å½±å¼•æ“â€ã€‚
*   **ç†ç”±**: 
    v2 çš„å…­å±‚æ¨¡å‹è¿‡åº¦å·¥ç¨‹åŒ–ï¼Œæ¦‚å¿µç¢ç‰‡åŒ–ä¸¥é‡ã€‚æ–°æ¨¡å‹æ›´ç¬¦åˆâ€œæ„å›¾é©±åŠ¨â€æœ¬è´¨ï¼Œä¸”æ”¯æŒä»å•äººåˆ°å›¢é˜Ÿçš„æ¸è¿›å¼åä½œã€‚
*   **å‚è€ƒ**: [v3 è§„èŒƒæ€»è§ˆ](./v3/01-overview.md)

## ADR-002: ç¡®ç«‹â€œå…­å±‚æ„å›¾â€æ¨¡å‹ (v2)

*   **æ—¥æœŸ**: 2025-11-20
*   **çŠ¶æ€**: **Superseded by ADR-003**
*   **å†³ç­–**: 
    å°†å‰ç«¯æ„å›¾æ‹†è§£ä¸º Layout, View, Interaction, Behavior, Data, Code Structure å…­ä¸ªç‹¬ç«‹å±‚çº§ã€‚
*   **ç†ç”±**: 
    è¯•å›¾é€šè¿‡å…¨åˆ‡é¢è§£æ„æ¥æ§åˆ¶ LLM ç”Ÿæˆä»£ç çš„å¤æ‚åº¦ã€‚è™½ç„¶åºŸå¼ƒï¼Œä½†å…¶å¯¹â€œå…³æ³¨ç‚¹åˆ†ç¦»â€çš„æ¢ç´¢å…·æœ‰å†å²å‚è€ƒä»·å€¼ã€‚
*   **å‚è€ƒ**: [v2 è¯¦ç»†è®¾è®¡ä¸èƒŒæ™¯](./v2/00-architecture-decision-records.md)

## ADR-001: æ„å›¾é©±åŠ¨å¼€å‘ (v1)

*   **æ—¥æœŸ**: 2025-10-01
*   **çŠ¶æ€**: **Superseded by ADR-002**
*   **å†³ç­–**: 
    æå‡º "Intent" æ¦‚å¿µä½œä¸ºè‡ªç„¶è¯­è¨€ä¸ä»£ç çš„ä¸­é—´å±‚ï¼Œå¼•å…¥ Pattern å’Œ Planï¼Œå°è¯•ç”¨ã€Œæ„å›¾ â†’ æ¨¡å¼ â†’ æ¨¡æ¿ â†’ ä»£ç ã€ä¸²èµ· AI ååŒå‡ºç æµæ°´çº¿ã€‚
*   **åŸå§‹æ„å›¾ï¼ˆv1 è§†è§’ï¼‰**: 
    - **LLM ä¼˜å…ˆ**ï¼šå‡è®¾æ²¡æœ‰ä»Šå¤©çš„ LLMï¼Œè¿™å¥— Intent/Pattern/Template ä½“ç³»åªæ˜¯é¢å¤–è´Ÿæ‹…ï¼›çœŸæ­£ç›®æ ‡æ˜¯ç»™ LLM ä¸€å¥—ç¨³å®šâ€œè·‘é“â€ï¼Œè®©å®ƒåœ¨ç»“æ„åŒ–çº¦æŸå†…è¡¥å…¨è®¾è®¡ä¸ä»£ç ï¼Œè€Œä¸æ˜¯è‡ªç”±å‘æŒ¥ã€‚  
    - **æ„å›¾å…ˆäºå®ç°**ï¼šå¸Œæœ›å¼€å‘è€…åªéœ€è®²æ¸…ä¸šåŠ¡ç›®æ ‡å’Œåœºæ™¯ç»“æ„ï¼ˆè‡ªç„¶è¯­è¨€ + Intentï¼‰ï¼Œå¹³å°å’Œ LLM è´Ÿè´£æŠŠå®ƒæ˜ å°„ä¸º Pattern ç»„åˆã€ç”Ÿæˆè®¡åˆ’å’Œä»£ç éª¨æ¶ã€‚  
    - **è¡Œä¸ºå±‚å•ç‹¬å»ºæ¨¡**ï¼šåŒºåˆ†â€œçŠ¶æ€/ç¼“å­˜â€å’Œâ€œè¡Œä¸ºç¼–æ’â€ï¼Œå°è¯•ç”¨ Flow DSL + AST + Effect ç¨‹åºæ„å»ºä¸€ä¸ªç‹¬ç«‹çš„è¡Œä¸ºäº‹å®æº (SSoT)ï¼Œé¿å…ä¸šåŠ¡é€»è¾‘æ•£è½åœ¨å„å¤„ useEffect/äº‹ä»¶å¤„ç†å™¨ä¸­ã€‚  
    - **IMD / best-practice ä½œä¸ºâ€œä¾›ä½“â€**ï¼šæŠŠç°æœ‰ç»„ä»¶åº“å’Œå®è·µä»“åº“è§†ä¸ºæ¨¡å¼/æ¨¡æ¿çš„çŸ¥è¯†åº“ï¼Œè€Œä¸æ˜¯ä¸å¯æ”¹åŠ¨çš„è§„èŒƒï¼›Intent/Pattern/Flow æ˜¯ä¸€ç­‰å…¬æ°‘ï¼ŒIMD/best-practice ä¸ºå®ƒä»¬æœåŠ¡ã€‚
*   **ä¸åç»­ç‰ˆæœ¬çš„å…³ç³»**: 
    - v2 åœ¨æ­¤åŸºç¡€ä¸ŠæŠŠ Intent è¿›ä¸€æ­¥æ‹†æˆå…­å±‚ï¼Œå¼ºè°ƒâ€œå…¨åˆ‡é¢è§£æ„â€ï¼›  
    - v3 åˆ™å›åˆ°â€œæ„å›¾èšåˆâ€çš„æ–¹å‘ï¼Œç”¨ UI / Logic / Domain ä¸‰ç»´ + Flow/Logix Runtime æ‰¿è½½ v1 çš„å¤§éƒ¨åˆ†åŸå§‹è¯‰æ±‚ï¼ŒåŒæ—¶å¼±åŒ–å¤§å— YAML/å¤šå±‚ Intent çš„å¤æ‚åº¦ã€‚
</file>

<file path="intent-driven-ai-coding/blueprint.md">
---
title: é•¿æœŸè“å›¾ï¼šè‡ªæ„ˆæ¶æ„ä¸å…¨åŒå·¥ç¼–æ’ (Long-term Blueprint)
status: living
---

> æœ¬æ–‡æ¡£æç»˜äº† Intent-Driven AI Coding å¹³å°çš„ç»ˆå±€å½¢æ€ã€‚å®ƒæŒ‡å¼•ç€æ¶æ„çš„æ¼”è¿›æ–¹å‘ï¼Œç¡®ä¿æ¯ä¸€ä¸ªç‰ˆæœ¬çš„è¿­ä»£éƒ½åœ¨å‘ç€è¿™ä¸ªæœªæ¥è¿ˆè¿›ã€‚

## 1. æ¼”è¿›è·¯çº¿å›¾ (Roadmap)

*   **Phase 1 (v3 - Current)**: **æ„å›¾æ˜¾å½±å¼•æ“**ã€‚ç¡®ç«‹ä¸‰ä½ä¸€ä½“æ¨¡å‹ï¼Œå®ç° Spec -> Impl çš„å•å‘ç”Ÿæˆä¸æ‰‹åŠ¨ç²¾ä¿®ã€‚é‡ç‚¹åœ¨ DX (å¼€å‘ä½“éªŒ) å’Œ Pattern èµ„äº§åŒ–ã€‚
*   **Phase 2 (v4)**: **å…¨åŒå·¥ç¼–æ’**ã€‚å®ç° Code <-> Graph çš„åŒå‘åŒæ­¥ä¸å®æ—¶å¯è§†åŒ–è°ƒè¯•ã€‚é‡ç‚¹åœ¨å¯è§†åŒ–ä¸ä½ä»£ç èƒ½åŠ›çš„èåˆã€‚
*   **Phase 3 (v5)**: **è‡ªæ„ˆæ¶æ„**ã€‚å®ç° Generate -> Run -> Verify -> Fix çš„å…¨è‡ªåŠ¨é—­ç¯ã€‚é‡ç‚¹åœ¨ AI Agent ä¸ Headless Runtime çš„æ·±åº¦é›†æˆã€‚

## 2. è‡ªæ„ˆæ¶æ„ (Self-Healing Architecture)

æˆ‘ä»¬è‡´åŠ›äºå®ç° **â€œç”Ÿæˆ -> è¿è¡Œ -> éªŒè¯ -> ä¿®å¤â€** çš„å…¨è‡ªåŠ¨é—­ç¯ã€‚AI äº¤ä»˜çš„ä¸åº”æ˜¯â€œå¾…éªŒè¯çš„ä»£ç â€ï¼Œè€Œæ˜¯â€œå·²é€šè¿‡æµ‹è¯•çš„é€»è¾‘â€ã€‚

### 2.1 æ ¸å¿ƒå¾ªç¯ (The Loop)

1.  **Generate**: AI æ ¹æ® Spec ç”Ÿæˆ Logic Flow å’Œ Test Casesã€‚
2.  **Run**: Headless Runner åœ¨æ²™ç®±ä¸­æ‰§è¡Œé€»è¾‘ï¼Œæ³¨å…¥ Mock Serviceã€‚
3.  **Verify**: è¿è¡Œ Test Casesï¼Œæ–­è¨€ State å’Œ Signal æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚
4.  **Debug**: å¦‚æœå¤±è´¥ï¼Œå°† Execution Dump (æ‰§è¡Œå¿«ç…§) å–‚å›ç»™ AIï¼ŒAI åˆ†æ Trace å¹¶è‡ªåŠ¨ä¿®å¤ä»£ç ã€‚
5.  **Deliver**: å¾ªç¯ç›´è‡³å…¨ç»¿ï¼Œäº¤ä»˜æœ€ç»ˆä»£ç ã€‚

### 2.2 åŸºç¡€è®¾æ–½ï¼š`@logix/test`

ä¸ºäº†æ”¯æ’‘è¿™ä¸€æ„¿æ™¯ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºå®˜æ–¹æµ‹è¯•å¥—ä»¶ `@logix/test`ã€‚è¯¦ç»†è®¾è®¡è¯·å‚è€ƒï¼š

*   **[Logix Test Kit Design](../../runtime-logix/test/01-test-kit-design.md)**

## 3. å…¨åŒå·¥å¯è§†åŒ– (Full-Duplex Visualization)

æˆ‘ä»¬è¿½æ±‚ **â€œå›¾ç äº’è½¬ï¼Œå®æ—¶åé¦ˆâ€** çš„æè‡´ä½“éªŒã€‚

### 3.1 å›¾ç äº’è½¬

*   **Code -> Graph**: å®æ—¶è§£æ Pattern ä»£ç ï¼Œæ¸²æŸ“ä¸ºé€»è¾‘æµç¨‹å›¾ã€‚
*   **Graph -> Code**: åœ¨ç”»å¸ƒä¸Šæ‹–æ‹½èŠ‚ç‚¹ï¼Œé€šè¿‡ AST å˜æ¢åå‘ä¿®æ”¹ Pattern æºç ã€‚

### 3.2 å®æ—¶è°ƒè¯• (Live Trace)

ç»“åˆ Effect Inspectorï¼Œåœ¨ç”»å¸ƒä¸Šå®æ—¶å±•ç¤ºæ•°æ®æµåŠ¨çš„åŠ¨ç”»ä¸çŠ¶æ€å¿«ç…§ï¼Œå®ç°â€œç™½ç›’åŒ–â€è°ƒè¯•ã€‚

*   **Signal Visualization**: å°† Signal å¯è§†åŒ–ä¸ºè¿æ¥çº¿ä¸Šçš„**è„‰å†²æ•°æ®åŒ…**ã€‚UI -> Logic çš„è§¦å‘ä¿¡å·ï¼Œä»¥åŠ Logic -> UI çš„å‰¯ä½œç”¨ä¿¡å·ï¼Œéƒ½ä»¥åŠ¨ç”»å½¢å¼å‘ˆç°ï¼Œç›´è§‚å±•ç¤ºâ€œå‰¯ä½œç”¨çš„ä¼ æ’­è·¯å¾„â€ã€‚
*   **Timeline**: åœ¨è°ƒè¯•é¢æ¿ä¸­ï¼Œä»¥æ—¶é—´è½´å½¢å¼å±•ç¤º Signal (ç¬æ€) å’Œ State (æŒä¹…) çš„äº¤ç»‡å˜åŒ–ï¼Œæ”¯æŒæ—¶é—´æ—…è¡Œã€‚

## 4. èµ„äº§è¿è¥ç½‘ç»œ (Asset Network)

å¹³å°å°†æ¼”å˜ä¸ºä¼ä¸šçº§çš„**èµ„äº§å…±å»ºç½‘ç»œ**ã€‚

*   **Pattern Market**: å†…éƒ¨çš„ Pattern å¸‚åœºï¼Œæ”¯æŒç‰ˆæœ¬ç®¡ç†ã€ä¾èµ–åˆ†æä¸çƒ­åº¦ç»Ÿè®¡ã€‚
*   **Knowledge Graph**: å»ºç«‹ Spec (éœ€æ±‚) ä¸ Pattern (å®ç°) çš„çŸ¥è¯†å›¾è°±ï¼ŒAI å¯ä»¥æ ¹æ®å†å²æ•°æ®æ¨èâ€œæœ€é€‚åˆå½“å‰ä¸šåŠ¡çš„ Patternâ€ã€‚
</file>

<file path="intent-driven-ai-coding/README.md">
# Intent-Driven AI Coding Specifications

> **Current Status**: Active Development (v3)
> **Focus**: Intent Development Engine, Trinity Model, Dev-Centric Workflow

æœ¬ç›®å½•åŒ…å« **Intent-Driven AI Coding** å¹³å°çš„æ ¸å¿ƒè§„èŒƒæ–‡æ¡£ã€‚æˆ‘ä»¬è‡´åŠ›äºæ„å»ºä¸€ä¸ª**æ„å›¾æ˜¾å½±å¼•æ“**ï¼Œåˆ©ç”¨ AI å°†æ¨¡ç³Šçš„ä¸šåŠ¡éœ€æ±‚å¹³æ»‘è½¬åŒ–ä¸ºç²¾ç¡®çš„ä»£ç å®ç°ã€‚

## ğŸ“‚ ç‰ˆæœ¬ç´¢å¼• (Version Index)

### [v3: ä¸‰ä½ä¸€ä½“æ¨¡å‹ (Active)](./v3/01-overview.md)
*   **æ ¸å¿ƒç†å¿µ**ï¼š**æ„å›¾æ˜¾å½± (Intent Development)**ã€‚è½¯ä»¶å¼€å‘æ˜¯æ„å›¾ä» Specï¼ˆéœ€æ±‚æ€ï¼‰åˆ° Implï¼ˆå®ç°æ€ï¼‰çš„åˆ†è¾¨ç‡æå‡è¿‡ç¨‹ã€‚
*   **æ¨¡å‹æ¶æ„**ï¼šæ”¶æ•›ä¸º **UI (è¡¨ç°) / Logic (é€»è¾‘) / Domain (é¢†åŸŸ)** ä¸‰å¤§æ ¸å¿ƒç»´åº¦ã€‚
*   **é€‚ç”¨åœºæ™¯**ï¼šä¼˜å…ˆæœåŠ¡äº**å‰ç«¯å¼€å‘è€…**çš„ä¸ªäººææ•ˆ (Solo Mode)ï¼Œå¹¶æ”¯æŒå‘å›¢é˜Ÿåä½œ (Team Mode) æ¼”è¿›ã€‚
*   **å…³é”®æ–‡æ¡£**ï¼š[å¹³å°å®£è¨€](./v3/00-platform-manifesto.md) | [æ¨¡å‹è¯¦è§£](./v3/02-intent-layers.md) | [èµ„äº§å®šä¹‰](./v3/03-assets-and-schemas.md)

### [v2: å…­å±‚æ¨¡å‹ (Archived)](./v2/README.md)
*   **æ ¸å¿ƒç†å¿µ**ï¼š**å…¨åˆ‡é¢è§£æ„**ã€‚è¯•å›¾ç©·å°½å‰ç«¯å·¥ç¨‹çš„æ‰€æœ‰ç»†èŠ‚ã€‚
*   **æ¨¡å‹æ¶æ„**ï¼šLayout, View, Interaction, Behavior, Data, Code Structureã€‚
*   **çŠ¶æ€**ï¼šå·²å½’æ¡£ã€‚ä½œä¸ºæ¶æ„æ¼”è¿›ä¸­çš„ä¸€æ¬¡é‡è¦æ¢ç´¢ï¼Œä¸º v3 çš„æ”¶æ•›æä¾›äº†ç†è®ºåŸºç¡€ã€‚

## ğŸ§  å†³ç­–ä¸è“å›¾ (Decisions & Blueprint)

*   **[Architecture Decision Records (ADR)](./adr.md)**: è®°å½•äº†æˆ‘ä»¬â€œä¸ºä»€ä¹ˆèµ°åˆ°ä»Šå¤©â€çš„å†å²å†³ç­–ã€‚
*   **[Long-term Blueprint](./blueprint.md)**: æç»˜äº†æˆ‘ä»¬â€œæœªæ¥è¦å»å“ªé‡Œâ€çš„ç»ˆå±€æ„¿æ™¯ï¼ˆè‡ªæ„ˆæ¶æ„ã€å…¨åŒå·¥ç¼–æ’ï¼‰ã€‚

## ğŸ—ºï¸ æ€»ä½“è¿›å±• (Progress)

1.  **æ¦‚å¿µéªŒè¯æœŸ (v1)**ï¼šéªŒè¯ Intent/Pattern/Plan åˆ†ç¦»çš„å¯è¡Œæ€§ã€‚ âœ…
2.  **æ·±åº¦åˆ†ææœŸ (v2)**ï¼šå¯¹å‰ç«¯å·¥ç¨‹è¿›è¡Œå…¨åˆ‡é¢è§£æ„ï¼Œæ¢ç´¢è¾¹ç•Œã€‚ âœ…
3.  **æ¶æ„å®šä¹‰æœŸ (v3)**ï¼šåŸºäºå¥¥å¡å§†å‰ƒåˆ€æ”¶æ•›æ¨¡å‹ï¼Œç¡®ç«‹â€œæ„å›¾æ˜¾å½±â€å®šä½ã€‚ ğŸ“ **(Current)**
4.  **POC éªŒè¯æœŸ**ï¼šåŸºäº v3 è§„èŒƒè¿›è¡Œ Schema éªŒè¯ä¸è¿è¡Œæ—¶å¼€å‘ã€‚ ğŸ”„
</file>

<file path="review/runtime-logix-spec-todo.md">
# runtime-logix è§„èŒƒè½åœ° TODO æ¸…å•

> **Review Report (2025-11-30)**
>
> ç»è¿‡å¯¹ `packages/logix-core`, `packages/logix-react`, `packages/logix-test` åŠ `packages/form` çš„ä»£ç å®¡æŸ¥ï¼Œå½“å‰å®æ–½çŠ¶æ€å¦‚ä¸‹ï¼š
> - **Core**: åŸºç¡€æ¶æ„ (`ModuleRuntime`, `DebugSink`) å·²å°±ä½ï¼Œä½†é«˜çº§ç‰¹æ€§ (`ref(selector)`, Compliance Test) ç¼ºå¤±ã€‚
> - **React**: åŸºç¡€ Hooks (`useModule`, `useSelector`) å·²å®ç°ã€‚
> - **Form**: **å®Œå…¨ç¼ºå¤±** (`packages/form/src` ä¸ºç©º)ï¼Œè¿™æ˜¯å½“å‰æœ€å¤§çš„åŠŸèƒ½ç¼ºå£ã€‚
> - **Test**: åŸå‹å¯ç”¨ (`Scenario`, `TestRuntime`)ï¼Œä½†ç¼ºä¹ `TestClock` é›†æˆä¸å¤šæ¨¡å—æ”¯æŒï¼Œå­˜åœ¨ç¡¬ç¼–ç  `sleep`ã€‚
> - **Builder**: å°šæœªå¯åŠ¨ã€‚

## 1. æ ¸å¿ƒå¼•æ“ Â· @logix/core

### 1.5 `ModuleRuntime.ref(selector)` ä¸ `BoundApi.state.ref`

- **å½“å‰çŠ¶æ€**:
  - `ModuleRuntime.ts` ä¸­ä»…å®ç°äº† `ref: () => stateRef`ï¼Œè¿”å›å®Œæ•´ State çš„ SubscriptionRefã€‚
  - `changes(selector)` å·²å®ç°ã€‚
- **TODO**:
  - [ ] å®ç° `ref(selector)`ï¼šè¿”å›ä¸€ä¸ªåªè¯»æˆ–å¯å†™çš„ `SubscriptionRef` è§†å›¾ï¼ˆéœ€å¤„ç† Lens/Prism é€»è¾‘ï¼‰ã€‚
  - [ ] åœ¨ `BoundApi` ä¸­æš´éœ²æ­¤èƒ½åŠ›ã€‚

### 1.7 Debug / Inspector èƒ½åŠ›

- **å½“å‰çŠ¶æ€**:
  - `DebugSink.ts` å·²å®ç°ï¼Œæ”¯æŒ `module:init`, `state:update`, `action:dispatch` ç­‰äº‹ä»¶è®°å½•ã€‚
- **TODO**:
  - [ ] **Test é›†æˆ**: è®© `runTest` æ”¶é›†è¿™äº› trace å¹¶è¿”å› `ExecutionResult`ã€‚
  - [ ] **DevTools**: å¼€å‘åŸºäº Chrome Extension æˆ–ç‹¬ç«‹ UI çš„ Inspectorã€‚

### 1.8 ModuleRuntime åˆè§„æµ‹è¯•å¥—ä»¶

- **å½“å‰çŠ¶æ€**: **ç¼ºå¤±**ã€‚
- **TODO**:
  - [ ] åˆ›å»º `@logix/core/test/compliance`ã€‚
  - [ ] ç¼–å†™æ ‡å‡†æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›– `getState`, `setState`, `dispatch` åŠå…¶æ—¶åºçº¦æŸã€‚
  - [ ] éªŒè¯ `RemoteStoreAdapter` ç­‰ PoCã€‚

## 2. React é€‚é…å±‚ Â· @logix/react & @logix/form

### 3.1 Form æ ¸å¿ƒæ¨¡å‹ (FormShape)

- **å½“å‰çŠ¶æ€**: **CRITICAL MISSING** (`packages/form` ä¸ºç©º)ã€‚
- **TODO**:
  - [ ] å®ç° `FormState<T>` (values + ui)ã€‚
  - [ ] å®šä¹‰ `FormAction` åè®®ã€‚
  - [ ] å®ç° `FormModule` å·¥å‚ã€‚

### 3.2 Form Logic Presets

- **å½“å‰çŠ¶æ€**: **MISSING**ã€‚
- **TODO**:
  - [ ] å®ç° `dirty`, `touched`, `validate` ç­‰é¢„ç½®é€»è¾‘ã€‚
  - [ ] å°è£… `FormPreset.make`ã€‚

### 3.3 React Hooks (Form)

- **å½“å‰çŠ¶æ€**: **MISSING**ã€‚
- **TODO**:
  - [ ] å®ç° `useForm`, `useField`, `useFieldArray`ã€‚
  - [ ] ç¡®ä¿åŸºäº `@logix/react` çš„ `useModule` æ„å»ºã€‚

## 4. æµ‹è¯•å·¥å…·åŒ… Â· @logix/test

### 4.1 æµ‹è¯•å…¥å£é‡æ„ï¼ˆTestProgramï¼‰

- **å½“å‰çŠ¶æ€**:
  - `@logix/test` å·²æä¾› `TestProgram.make` ä½œä¸ºæ¨èå…¥å£ï¼Œæ”¯æŒå•æ¨¡å—ä¸å¤šæ¨¡å— / Link åœºæ™¯ã€‚
  - `runTest` å·²è¿”å› `ExecutionResult`ï¼ˆåŒ…å« Traceï¼‰ã€‚
  - æ—§ç‰ˆ `defineTest` / `Scenario` å·²ä»å…¬å…± API ä¸­ç§»é™¤ï¼Œä»…ä¿ç•™å†…éƒ¨å®ç°ç‰‡æ®µã€‚
- **TODO**:
  - [ ] åŸºäº ExecutionResult.Trace è®¾è®¡æ›´å‹å¥½çš„æ–­è¨€ DSLï¼ˆä¾‹å¦‚ `Trace.expectAction`ã€`Trace.expectNoError`ï¼‰ã€‚
  - [ ] ä¸ºå¹³å° / AI åœºæ™¯å®šä¹‰ ExecutionDump ç»“æ„ï¼ˆåŒ…å« Trace + ä¸Šä¸‹æ–‡å¿«ç…§ï¼‰ã€‚


## 5. Builder / å·¥å…·é“¾ Â· @logix/builder

- **å½“å‰çŠ¶æ€**: **å°šæœªåˆ›å»º**ã€‚
- **TODO**:
  - [ ] åˆå§‹åŒ–åŒ…ç»“æ„ã€‚
  - [ ] å®ç°åŸºç¡€ AST è§£æä¸ Flow å›¾æ„å»ºã€‚
</file>

<file path="runtime-logix/builder/01-builder-design.md">
# Logix Builder SDK Design (@logix/builder)

> **Status**: Final Draft (v3 - Static Analysis Paradigm)
> **Purpose**: ä¸º Logix å¹³å°æä¾›ä¸€å¥—å¼ºç±»å‹çš„ DSL å¥‘çº¦ä¸ pattern-style é•¿é€»è¾‘å°è£…å·¥å…·ã€‚å®ƒæ˜¯è¿æ¥â€œä¸šåŠ¡ä»£ç â€ä¸â€œå¹³å°èµ„äº§â€çš„æ¡¥æ¢ï¼Œæ”¯æŒé€šè¿‡é™æ€åˆ†æå®ç°å…¨åŒå·¥æ„å›¾æ˜¾å½±ã€‚
> **Note**: æœ¬æ–‡åŸºäº **Store / Logic / Flow / Control / Effect.Service / Config** ç­‰è¿è¡Œæ—¶åŸè¯­å±•å¼€æè¿°ã€‚Builder è¢«è§†ä¸ºå›´ç»•è¿™äº›åŸè¯­çš„â€œå·¥å…·é“¾æŠ•å½±â€ï¼Œåªè´Ÿè´£**è§£æ / ç”Ÿæˆ**ä½¿ç”¨å®ƒä»¬çš„ä»£ç æœ¬èº«ï¼Œè€Œä¸æä¾›ç¬¬äºŒå¥—è¿è¡Œæ—¶ã€‚

## 1. æ ¸å¿ƒå®šä½ï¼šé™æ€åˆ†æå¥‘çº¦ (Static Analysis Contract)

åœ¨ v3 æ¶æ„ä¸­ï¼ŒBuilder SDK è¢«å®šä¹‰ä¸ºä¸€å¥— **DSL è¯­ä¹‰æ ‡å‡†**ã€‚

*   **Code is Truth**: å¼€å‘è€…ç¼–å†™çš„æ ‡å‡† TypeScript ä»£ç æ˜¯å”¯ä¸€çš„äº‹å®æºã€‚
*   **Parser is Viewer**: å¹³å°ä¸æ‰§è¡Œä»£ç æ¥è·å–ç»“æ„ï¼Œè€Œæ˜¯é€šè¿‡ **Static Analysis (Parser)** è¯»å–æºç ä¸­çš„ DSL è°ƒç”¨ï¼Œæ„å»ºå¯è§†åŒ–è§†å›¾ (AST)ã€‚
*   **Unified Language**: Runtime ä¸ Builder ä»¥åŒä¸€å¥—åŸºäº Store / Logic / Flow / Control çš„ Effect-Native API ä½œä¸ºâ€œè¯­è¨€â€ã€‚Builder åªä¾èµ–è¿™äº› API çš„ç±»å‹ä¸è°ƒç”¨çº¦å®šè¿›è¡Œè§£æå’Œä»£ç ç”Ÿæˆï¼Œè€Œä¸å¤åˆ»ä¸€å¥—ç‹¬ç«‹ DSLã€‚

## 2. ç›®æ ‡è¯­è¨€ï¼ˆBuilder è§†å›¾ï¼‰

Builder SDK ä¸å®šä¹‰ä¸€æ•´å¥—ç‹¬ç«‹çš„ `LogicDSL` ç±»å‹ï¼Œè€Œæ˜¯å›´ç»• Runtime Core çš„åŸè¯­æä¾›æ›´æ˜“åˆ†æçš„å†™æ³•è§„èŒƒï¼›æ¢è¨€ä¹‹ï¼Œ**Builder é¢å‘çš„â€œè¯­è¨€â€å°±æ˜¯ `@logix/core` æš´éœ²çš„ Store / Logic / Flow / Control API æœ¬èº«**ï¼š

- å¯¹çŠ¶æ€ï¼šé€šè¿‡ `Logic.Api.state`ï¼ˆ`read / update / mutate / ref`ï¼‰æ“ä½œ Storeï¼›
- å¯¹ Flowï¼šç»Ÿä¸€ä½¿ç”¨ `flow.*` ç®—å­æ„å»ºè§¦å‘æºä¸æ—¶åºè¾“å‡ºï¼›
- å¯¹ Controlï¼šä½¿ç”¨ `$.match` / `Effect.catch*` æ˜ç¡®è¡¨è¾¾åˆ†æ”¯ä¸é”™è¯¯è¾¹ç•Œï¼›
- å¯¹ Service / Configï¼šä½¿ç”¨ `Effect.Service` + Layer / Config è¯»å–çº¦å®šã€‚

### 2.1 pattern-style é•¿é€»è¾‘å°è£…

Builder è§†è§’ä¸‹çš„â€œä¸€ç­‰äº§ç‰©â€æ˜¯ pattern-style çš„ **é•¿é€»è¾‘å‡½æ•°**ï¼šå¯¹å¤–æš´éœ²å½¢å¦‚ `(input) => Effect` çš„ç¨‹åºï¼Œå†…éƒ¨å®ç°ä»æ—§å®Œå…¨åŸºäº Runtime Core çš„åŸè¯­ã€‚

```ts
import { Effect } from "effect";

// å…¸å‹çš„ pattern-style é•¿é€»è¾‘ï¼šå¯¹å¤–æš´éœ² (input) => Effect ç¨‹åº
export const runReliableSubmit = (input: {
  data: SubmitData;
  retryTimes: number;
}) =>
  Effect.gen(function* (_) {
    // æ­¤å¤„å¯ä»¥è°ƒç”¨ Domain Service / å…¶å®ƒ patternï¼Œ
    // ä¹Ÿå¯ä»¥åœ¨è°ƒç”¨ä¾§ç”± Domain.logic æ³¨å…¥ state / flow / control ç­‰èƒ½åŠ›ã€‚
    // Builder åªçº¦å®šï¼šè¿”å›å€¼æ˜¯ä¸€ä¸ª Effect ç¨‹åºï¼Œä¾¿äºå¹³å°å°†å…¶è§†ä¸ºå¯èµ„äº§åŒ–çš„é•¿é€»è¾‘å—ã€‚
  });
```

å¹³å°å¯ä»¥é€‰æ‹©æ€§åœ°å°†æŸäº› pattern-style å‡½æ•°åŒ…è£…ä¸º PatternAssetï¼ˆå¸¦ id/version/configSchema ç­‰ï¼‰ï¼ŒRuntime Core ä»ç„¶åªè®¤ `(input) => Effect` æœ¬èº«ï¼›PatternAsset åªå­˜åœ¨äºå¹³å° / Intent å±‚ã€‚

## 3. ç¼–å†™èŒƒå¼ (Coding Paradigms)

### 3.1 åŸºç¡€é€»è¾‘ (The Basic Flow)

å¼€å‘è€…ä½¿ç”¨ `Effect.gen` é…åˆ Runtime Core æä¾›çš„ Bound APIï¼ˆåœ¨ PoC ä¸­é€šè¿‡ `Module.logic(($)=>...)` æ³¨å…¥ `$`ï¼‰ç¼–å†™é€»è¾‘ï¼š

```typescript
import { Effect } from "effect";
import { Logic } from "@logix/core";

// Bound APIï¼šç»‘å®šå½“å‰ Shape ä¸ Envï¼Œæä¾› $ ä½œä¸º Logic å†…çš„ç¬¦å·é”šç‚¹
// æ¦‚å¿µæ€§ç¤ºæ„ï¼š`$` æ˜¯é’ˆå¯¹ OrderShape + OrderEnv é¢„ç»‘å®šçš„ Bound APIï¼Œ
// å®é™… PoC ä¸­é€šå¸¸ç”± `OrderModule.logic(($)=>...)` çš„å‚æ•°æ³¨å…¥ã€‚
export const submitOrder = (
  $: Logic.BoundApi<OrderShape, OrderEnv>,
): Logic.Of<OrderShape, OrderEnv> =>
  Effect.gen(function* (_) {
    const submit$ = $.flow.fromAction(
      (a): a is { type: "submit" } => a.type === "submit",
    );

    const handleSubmit = Effect.try({
      try: () => {
         // ...
      },
      catch: (e) => new Error("Submit failed")
    })
      try: Effect.gen(function* (_) {
        yield* $.state.update(prev => ({ ...prev, isSubmitting: true }));
        // è°ƒç”¨ Service / å¤„ç†ç»“æœ ...
      }),
      catch: err =>
        $.state.update(prev => ({ ...prev, errorMessage: err.message })),
    });

    yield* submit$.pipe($.flow.runExhaust(handleSubmit));
  }),
);
```

### 3.2 æ··åˆå†™æ³• (Hybrid Coding)

å¹³å°å…è®¸åœ¨ Logic ä¸­æ··å…¥åŸç”Ÿ Effect ä»£ç ã€‚Parser ä¼šæ ¹æ®ä»£ç ç‰¹å¾è¿›è¡Œé™çº§å¤„ç†ã€‚

```typescript
// æ­¤å¤„ç¤ºæ„ï¼š`$` ç”±å¯¹åº” Module.logic(($)=>...) æˆ–è°ƒç”¨æ–¹æ˜¾å¼æ³¨å…¥çš„ BoundApi<Shape, Env> æä¾›
export const complexFlow = (
  $: Logic.BoundApi<Shape, Env>,
): Logic.Of<Shape, Env> =>
  Effect.gen(function* (_) {
    // [White Box] å¹³å°å®Œå…¨ç†è§£
    const data$ = $.flow.fromState(s => s.filters);

    // [Black Box] å¹³å°è¯†åˆ«ä¸º "Raw Code Block"
    const processed = yield* Effect.promise(async () => {
      const raw = await fetch('/legacy-api');
      return complexMath(await raw.json());
    });

    // [White Box] ç»§ç»­å¯è§†åŒ–
    // ...
  }),
);
```

## 4. é™æ€åˆ†æåŸç† (How Parser Works)

Parser ä¸æ‰§è¡Œä»£ç ï¼Œè€Œæ˜¯éå† TypeScript ASTï¼š

1.  **Import Analysis**: è¯†åˆ« `Logic` / `Store` / pattern helper / pattern-style å‡½æ•°çš„å¼•å…¥å’Œé‡å‘½åã€‚
2.  **Context Tracking**: è¿½è¸ª `Logic.Of` ç”Ÿæˆçš„ Logic ç¨‹åºï¼Œä»¥åŠ `Logic.Api` è§£æ„å‡ºçš„ `state/actions/flow/control`ã€‚
3.  **Call Expression Matching**:
    *   åŒ¹é… `flow.fromAction / fromState / debounce / throttle / run*` -> æ„å»º Flow å±‚èŠ‚ç‚¹ã€‚
    *   åŒ¹é… `$.match / Effect.catch* / Effect.all` -> æ„å»ºç»“æ„åŒ–æ§åˆ¶æµèŠ‚ç‚¹ã€‚
    *   åŒ¹é… pattern-style é•¿é€»è¾‘ (`runXxxEffect`) çš„å¯¼å‡º / è°ƒç”¨ä½ç½® -> æ„å»º `effect-block` èŠ‚ç‚¹ï¼Œå¹¶ç»“åˆ PatternAssetï¼ˆå¦‚æœ‰ï¼‰é™„åŠ èµ„äº§ä¿¡æ¯ã€‚
4.  **Fallback Strategy**:
    *   **Fallback**ï¼š
    *   é‡åˆ°æ— æ³•è¯†åˆ«çš„ Effect ç»„åˆ -> æ ‡è®°ä¸º `GrayBox` (Code Block)ã€‚
    *   é‡åˆ°æ— æ³•è¯†åˆ«çš„è¯­å¥ (å¦‚ `console.log`, `native fetch`) -> å½’å¹¶ä¸º `RawCodeNode`ã€‚
    *   é‡åˆ°åŠ¨æ€å‚æ•° (å¦‚ `$.match(someVar).when(...)`) -> æ ‡è®°ä¸º `GrayBox` (Ejected Node)ã€‚

## 5. ä¼˜åŠ¿

1.  **Zero Runtime Overhead**: ç”Ÿäº§ç¯å¢ƒç›´æ¥è¿è¡Œç¼–è¯‘åçš„ JS ä»£ç ï¼Œæ— é¢å¤–çš„å½•åˆ¶/å›æ”¾å¼€é”€ã€‚
2.  **Full TypeScript Support**: å¼€å‘è€…å¯ä»¥ä½¿ç”¨å®Œæ•´çš„ TS èƒ½åŠ› (ç±»å‹æ£€æŸ¥ã€é‡æ„ã€è·³è½¬)ã€‚
3.  **Graceful Degradation**: å³ä½¿ä»£ç å†™å¾—å†ä¹±ï¼Œå¹³å°ä¹Ÿèƒ½è‡³å°‘æ˜¾ç¤ºä¸ºâ€œä»£ç å—â€ï¼Œè€Œä¸ä¼šå´©æºƒæˆ–æŠ¥é”™ã€‚
4.  **Runtime/Core è§£è€¦ PatternAsset**: Pattern èµ„äº§åªæ˜¯å¯¹ `(input) => Effect` çš„åŒ…è£…ï¼ŒRuntime-Core ä¸æ„ŸçŸ¥ id/version/configSchema ç­‰å…ƒä¿¡æ¯ï¼Œä¾¿äºæ¼”è¿›ã€‚

## 6. èŒè´£è¾¹ç•Œï¼ˆCore / Builder / Runtimeï¼‰

ä¸ºé¿å…â€œç¬¬äºŒå¥— DSLâ€ä¸èŒè´£æ··æ·†ï¼Œv3 çº¦å®šå¦‚ä¸‹è¾¹ç•Œï¼š

- `@logix/core`ï¼ˆRuntime Coreï¼‰
  - å®šä¹‰ Store / Logic / Flow / Control ç­‰è¿è¡Œæ—¶åŸè¯­ä»¥åŠ `Logic.Api` åˆåŒã€‚
  - åªå…³å¿ƒâ€œå¦‚ä½•ç¼–å†™ / å¦‚ä½•æ‰§è¡Œâ€ Logic ç¨‹åºï¼Œä¸å†…å»ºä»»ä½• AST è§£ææˆ– PatternAsset æ¦‚å¿µã€‚

- `@logix/builder`ï¼ˆBuilder / Toolchainï¼‰
  - å°† `@logix/core` çš„ API è§†ä¸ºç›®æ ‡è¯­è¨€ï¼Œè´Ÿè´£é™æ€åˆ†æï¼ˆASTï¼‰å’Œä»£ç ç”Ÿæˆã€‚
  - æä¾›ç”¨äºäº§å‡º pattern-style `(input) => Effect` å‡½æ•°ã€PatternAsset skeletonã€åœºæ™¯è„šæ‰‹æ¶çš„å·¥å…·ã€‚
  - æœ¬èº«ä¸å‚ä¸åº”ç”¨è¿è¡Œæ—¶ï¼Œä¸æä¾›ç¬¬äºŒå¥— Flow/Logic è¿è¡Œæ—¶å®ç°ã€‚

- åº”ç”¨ Runtime / Studio
  - ä¸šåŠ¡ä»£ç ä¸çº¿ä¸Šè¿è¡Œæ—¶ä»…ä¾èµ– `@logix/core`ã€‚
  - Studio / CLI / ç¼–è¯‘å™¨ç­‰å¹³å°ç»„ä»¶åœ¨æ„å»ºé˜¶æ®µä¾èµ– `@logix/builder`ï¼Œç”¨ä»¥â€œçœ‹æ‡‚â€å’Œâ€œäº§å‡ºâ€ Logix ä»£ç ã€‚
</file>

<file path="runtime-logix/core/examples/01-basic-form.md">
# Example: Basic Form Logic (v3 Gold Standard)

> **Scenario**: ç”¨æˆ·æ³¨å†Œè¡¨å•
> **Features**: å­—æ®µè”åŠ¨ã€å¼‚æ­¥æ ¡éªŒã€å¤šå­—æ®µçº¦æŸ
> **Note**: æœ¬ç¤ºä¾‹æ˜¯ v3 Effect-Native Logix API çš„ **é»„é‡‘æ ‡å‡†å®ç°**ã€‚æ‰€æœ‰æ–°ä¸šåŠ¡é€»è¾‘éƒ½åº”ä»¥æ­¤ä¸ºèŒƒæœ¬ï¼Œå®ƒä¸¥æ ¼å¯¹é½ `logix-v3-core.ts` ä¸­çš„ `Logix.ModuleShape` + Module-first + Bound API `$` + Fluent Intentï¼ˆ`$.on*().update/mutate/run*`ï¼‰èŒƒå¼ã€‚

## Schema Definition

```typescript
import { Schema, Context, Effect } from 'effect';
import { Store, Logic, Logix } from '~/logix-v3-core'; // æ¦‚å¿µæ€§è·¯å¾„

const RegisterStateSchema = Schema.Struct({
  username: Schema.String,
  password: Schema.String,
  confirmPassword: Schema.String,
  country: Schema.String,
  province: Schema.String,
  bio: Schema.String,
  errors: Schema.Record(Schema.String, Schema.optional(Schema.String))
});

const RegisterActionSchema = Schema.Union(
  Schema.Struct({ _tag: Schema.Literal('form/submit') }),
  Schema.Struct({ _tag: Schema.Literal('form/reset') })
);

// ä» Schema æ´¾ç”Ÿå‡º Shapeï¼Œä½œä¸º Logic ä¸è¿è¡Œæ—¶ä¹‹é—´çš„ç±»å‹å¥‘çº¦
type RegisterShape = Logix.ModuleShape<
  typeof RegisterStateSchema,
  typeof RegisterActionSchema
>;
```

## Logic Implementation (v3 Effect-Native)

```typescript
// å®šä¹‰ä¸šåŠ¡ä¾èµ–çš„æœåŠ¡
class UserApi extends Context.Tag("UserApi")<UserApi, {
  readonly checkUsername: (name: string) => Effect.Effect<boolean, never, any>
}>() {}

// å®šä¹‰é¢†åŸŸ Module
export const RegisterModule = Logix.Module('Register', {
  state: RegisterStateSchema,
  actions: RegisterActionSchema,
});

// ä½¿ç”¨ Module.logic + Bound API å®šä¹‰ä¸€ä¸ªè‡ªåŒ…å«çš„ã€å¯ç»„åˆçš„é€»è¾‘å•å…ƒ
export const RegisterLogic = RegisterModule.logic(($) =>
  Effect.gen(function* (_) {
    // 1. åŒæ­¥è”åŠ¨ï¼šcountry å˜åŒ–æ—¶é‡ç½® province
    yield* $.onState((s) => s.country).mutate((draft) => {
      draft.province = "";
    });

    // 2. å¼‚æ­¥æ ¡éªŒï¼šç›‘å¬ usernameï¼Œè°ƒç”¨ API æ£€æŸ¥é‡åï¼ˆlatest å¹¶å‘è¯­ä¹‰ï¼‰
    yield* $.onState((s) => s.username)
      .debounce(500)
      .filter((username) => username.length >= 3)
      .run(
        Effect.gen(function* (_) {
          const svc = yield* $.use(UserApi);
          const { username } = yield* $.state.read;
          const isTaken = yield* svc.checkUsername(username);
          yield* $.state.mutate((draft) => {
            draft.errors.username = isTaken ? "Username already taken" : undefined;
          });
        })
      );

    // 3. å¤šå­—æ®µçº¦æŸï¼šç›‘å¬ password / confirmPasswordï¼Œç¡®ä¿ä¸¤è€…ä¸€è‡´
    yield* $.onState((s) => [s.password, s.confirmPassword] as const).mutate(
      (draft) => {
        if (draft.confirmPassword && draft.password !== draft.confirmPassword) {
          draft.errors.confirmPassword = "Passwords do not match";
        } else {
          delete draft.errors.confirmPassword;
        }
      }
    );
  }),
);
```

## Module / Live Instantiation

```typescript
export const RegisterLive = RegisterModule.live(
  {
    username: "",
    password: "",
    confirmPassword: "",
    country: "",
    province: "",
    bio: "",
    errors: {},
  },
  RegisterLogic,
);
```

## Design Rationale

*   **Clarity & Cohesion**: ä¸‰ä¸ªæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆè”åŠ¨ã€å¼‚æ­¥æ ¡éªŒã€å¤šå­—æ®µçº¦æŸï¼‰è¢«æ¸…æ™°åœ°æ‹†åˆ†ä¸ºä¸‰ä¸ªç‹¬ç«‹çš„ã€å¯ç»„åˆçš„æµã€‚æ‰€æœ‰ä¸ç‰¹å®šåŠŸèƒ½ç›¸å…³çš„ä»£ç ï¼ˆè§¦å‘ã€é˜²æŠ–ã€æ‰§è¡Œï¼‰éƒ½å†…èšåœ¨ä¸€èµ·ï¼Œæå¤§åœ°æé«˜äº†å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
*   **Declarative Concurrency**: å¼‚æ­¥æ ¡éªŒçš„ç«æ€é—®é¢˜é€šè¿‡ Fluent DSL çš„ `{ mode: 'latest' }` å£°æ˜å¼åœ°è§£å†³ï¼Œå¼€å‘è€…æ— éœ€ç¼–å†™ä»»ä½•æ‰‹åŠ¨çš„å–æ¶ˆæˆ–æ ‡å¿—ä½ç®¡ç†é€»è¾‘ï¼Œä»£ç æ„å›¾æ¸…æ™°ï¼Œè¡Œä¸ºå¥å£®ã€‚
*   **Type-Safe Dependency Injection**: å¤–éƒ¨ä¾èµ–ï¼ˆå¦‚ `UserApi`ï¼‰é€šè¿‡ `Context.Tag` å®šä¹‰ï¼Œå¹¶ç”± Logic.Env / Logic.Of çš„æ³›å‹å‚æ•°çº¦æŸã€‚è¿™ç¡®ä¿äº†åœ¨ç¼–è¯‘æ—¶å°±èƒ½å‘ç°ä¾èµ–ç¼ºå¤±æˆ–ç±»å‹ä¸åŒ¹é…çš„é—®é¢˜ï¼Œä¿è¯äº†è¿è¡Œæ—¶çš„ç¨³å®šæ€§ã€‚
</file>

<file path="runtime-logix/core/examples/02-complex-list.md">
# Example: Complex List Logic

> **Scenario**: è´­ç‰©è½¦
> **Features**: è¡Œçº§è”åŠ¨ã€èšåˆè®¡ç®—ã€æ‰¹é‡æ›´æ–°
> **Note**: æœ¬ç¤ºä¾‹åŸºäº v3 Effect-Native Logix å†™æ³•ï¼ˆ`Logix.ModuleShape` + Bound API `$` + `Flow / Control`ï¼‰ã€‚å½“å‰ PoC ä¸­ï¼Œå®é™…ä»£ç åº”åœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ã€‚

## Schema Definition

```typescript
const CartItemSchema = Schema.Struct({
  id: Schema.String,
  price: Schema.Number,
  quantity: Schema.Number,
  total: Schema.Number,
  checked: Schema.Boolean
});

const CartStateSchema = Schema.Struct({
  items: Schema.Array(CartItemSchema),
  summary: Schema.Struct({
    totalAmount: Schema.Number,
    totalCount: Schema.Number
  }),
  isAllChecked: Schema.Boolean
});

const CartActionSchema = Schema.Union(
  Schema.Struct({
    type: Schema.Literal("cart/toggleAll")
  }),
  Schema.Struct({
    type: Schema.Literal("cart/toggleItem"),
    payload: Schema.Struct({ id: Schema.String })
  })
  // ... å…¶ä»–åŠ¨ä½œ
);

type CartShape = Logix.ModuleShape<
  typeof CartStateSchema,
  typeof CartActionSchema
>;
```

## Logic Implementationï¼ˆv3 Effect-Nativeï¼‰

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Cart` è¡¨ç¤ºé’ˆå¯¹ CartShape é¢„ç»‘å®šçš„ Bound APIã€‚
export const CartLogic: Logic.Of<CartShape> =
  Effect.gen(function* (_) {
    const items$ = $.flow.fromState((s) => s.items);
    const toggleAll$ = $.flow.fromAction(
      (a): a is { type: "cart/toggleAll" } => a.type === "cart/toggleAll"
    );

    // 1. è¡Œçº§è”åŠ¨ï¼šprice / quantity å˜åŒ–æ—¶æ›´æ–°å¯¹åº” total
    const recalcRowTotals = items$.pipe(
      $.flow.run(
        $.state.mutate((draft) => {
          draft.items.forEach((item) => {
            item.total = item.price * item.quantity;
          });
        })
      )
    );

    // 2. èšåˆè®¡ç®—ï¼šç›‘å¬ items æ•°ç»„å˜åŒ–ï¼Œæ±‡æ€»é€‰ä¸­è¡Œçš„é‡‘é¢ä¸æ•°é‡
    const recalcSummary = items$.pipe(
      $.flow.run(
        $.state.update((prev) => {
          const totalAmount = prev.items.reduce(
            (sum, item) => (item.checked ? sum + item.total : sum),
            0
          );
          const totalCount = prev.items.filter((i) => i.checked).length;

          return {
            ...prev,
            summary: { totalAmount, totalCount }
          };
        })
      )
    );

    // 3. æ‰¹é‡æ›´æ–°ï¼šç›‘å¬å…¨é€‰ Actionï¼Œæ‰¹é‡æ›´æ–°æ‰€æœ‰ items çš„ checked çŠ¶æ€
    const toggleAllItems = toggleAll$.pipe(
      $.flow.run(
        $.state.mutate((draft) => {
          const nextChecked = !draft.isAllChecked;

          draft.items.forEach((item) => {
            item.checked = nextChecked;
          });

          draft.isAllChecked = nextChecked;
        })
      )
    );

    yield* Effect.all([recalcRowTotals, recalcSummary, toggleAllItems]);
  })
);
```

## API Review

*   **ä¸ Core ä¸€è‡´**: é€šè¿‡ `Logix.ModuleShape` + Bound API `$` + `Flow.Api` è¡¨è¾¾è¡Œçº§è”åŠ¨ã€èšåˆä¸æ‰¹é‡æ›´æ–°ï¼Œç›´æ¥å¯¹åº” `logix-v3-core` ä¸­çš„è¿è¡Œæ—¶åŸè¯­ã€‚
*   **æ€§èƒ½å‹å¥½**: èšåˆé€»è¾‘é›†ä¸­åœ¨å•æ¡ `state.update` ä¸­å®Œæˆï¼Œé€šè¿‡ä¸€æ¬¡å†™å…¥æ›´æ–° summaryï¼Œé¿å…é‡å¤è®¡ç®—å’Œå¤šæ¬¡æ¸²æŸ“ã€‚
*   **åŠ¨ä½œæ˜¾å¼**: å…¨é€‰æ“ä½œé€šè¿‡ Typed Action `cart/toggleAll` è§¦å‘ï¼Œé…åˆ `flow.fromAction` è¿›è¡Œç›‘å¬ï¼Œä¾¿äºåœ¨ DevTools ä¸ Trace ä¸­ç»Ÿä¸€è§‚å¯Ÿæ¥æºã€‚
</file>

<file path="runtime-logix/core/examples/03-external-integration.md">
# Example: External Integration (v3 Standard Paradigm)

> **Scenario**: å®æ—¶è‚¡ç¥¨çœ‹æ¿
> **Features**: WebSocket æ¥å…¥ã€å¤–éƒ¨äº‹ä»¶å“åº”ã€èµ„æºç®¡ç†
> **Note**: æœ¬ç¤ºä¾‹æ˜¯ v3 ä¸­å¤„ç†å¤–éƒ¨äº‹ä»¶æºçš„ **é»„é‡‘æ ‡å‡†å®ç°**ã€‚å®ƒæ¼”ç¤ºäº†å¦‚ä½•å°†å¤–éƒ¨æµï¼ˆå¦‚ WebSocketï¼‰å°è£…ä¸º `Effect.Service`ï¼Œå¹¶é€šè¿‡ä¾èµ–æ³¨å…¥åœ¨ `Logic` ä¸­å®‰å…¨åœ°æ¶ˆè´¹ã€‚å½“å‰ PoC ä¸­ï¼Œå®é™…ä»£ç åº”åœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ã€‚

## 1. Schema Definition

```typescript
import { Schema, Context, Effect, Stream } from 'effect';
import { Store, Logic } from '~/logix-v3-core'; // æ¦‚å¿µæ€§è·¯å¾„

const StockStateSchema = Schema.Struct({
  symbol: Schema.String,
  price: Schema.Number,
  lastUpdate: Schema.Number,
  connectionStatus: Schema.Literal('connected', 'disconnected')
});

const StockActionSchema = Schema.Never;

type StockShape = Logix.ModuleShape<typeof StockStateSchema, typeof StockActionSchema>;
```

## 2. Service Definition (The v3 Way)

å°† WebSocket è¿æ¥å’Œäº‹ä»¶æµå°è£…ä¸ºä¸€ä¸ªç‹¬ç«‹ã€å¯æµ‹è¯•çš„æœåŠ¡ã€‚

```typescript
// a-websocket.service.ts

// å®šä¹‰æœåŠ¡æ¥å£
class WebSocketService extends Context.Tag("WebSocketService")<WebSocketService, {
  readonly status$: Stream.Stream<'connected' | 'disconnected'>;
  readonly price$: Stream.Stream<number>;
}>() {}

// æœåŠ¡çš„ Live å®ç° (Layer)
const WebSocketServiceLive = Layer.succeed(
  WebSocketService,
  {
    status$: Stream.fromIterable(['connected']),
    price$: Stream.periodic(1000).pipe(Stream.map(() => Math.random() * 100 + 100))
  }
);
```

## 3. Logic Implementation

`Logic` é€šè¿‡å…¶ç¯å¢ƒ `R` æ¥æ”¶ `WebSocketService`ï¼Œç„¶ååƒå¤„ç†å†…éƒ¨æµä¸€æ ·å¤„ç†å¤–éƒ¨æµã€‚

```typescript
// a-stock.logic.tsï¼›`$Stock` æ¦‚å¿µä¸Šè¡¨ç¤ºé’ˆå¯¹ StockShape + WebSocketService é¢„ç»‘å®šçš„ Bound APIã€‚

export const StockLogic: Logic.Of<StockShape, WebSocketService> =
  Effect.gen(function* (_) {
    const ws = yield* $Stock.services(WebSocketService);

    const statusLogic = ws.status$.pipe(
      $Stock.flow.run(status =>
        $Stock.state.mutate(draft => { draft.connectionStatus = status; })
      )
    );

    const priceLogic = ws.price$.pipe(
      $Stock.flow.run(price =>
        $Stock.state.mutate(draft => {
          draft.price = price;
          draft.lastUpdate = Date.now();
        })
      )
    );

    yield* Effect.all([statusLogic, priceLogic], { discard: true });
  })
);
```

## 4. Module / Live Instantiation

åœ¨åˆ›å»ºé¢†åŸŸ Module æ—¶ï¼Œéœ€è¦å°† `Logic` æ‰€ä¾èµ–çš„ `Layer` æä¾›ç»™è¿è¡Œæ—¶ã€‚

```typescript
// a-stock.module.ts

export const StockModule = Logix.Module('Stock', {
  state: StockStateSchema,
  actions: StockActionSchema,
});

export const StockLive = StockModule.live(
  { ...initialValues },
  StockLogic,
);

// åœ¨åº”ç”¨å…¥å£å¤„ï¼Œä¸ºè¿è¡Œæ—¶æä¾›æ‰€æœ‰ä¾èµ–çš„ Layer
const AppLayer = Layer.merge(WebSocketServiceLive, ...otherLayers);
// å®é™…è¿è¡Œæ–¹å¼å¯å‚è€ƒ runtime å®ç°æ–‡æ¡£ï¼ˆä¾‹å¦‚é€šè¿‡ ManagedRuntime å°† StockLive ä¸ AppLayer ç»„åˆåè¿è¡Œï¼‰
```

## 5. Design Rationale

- **Architectural Purity**: v3 èŒƒå¼å°†å¤–éƒ¨æºè§†ä¸ºæ ‡å‡†çš„ `Effect.Service`ã€‚è¿™ç¡®ä¿äº†æ‰€æœ‰é€»è¾‘ï¼Œæ— è®ºæ˜¯å“åº”å†…éƒ¨çŠ¶æ€è¿˜æ˜¯å¤–éƒ¨äº‹ä»¶ï¼Œéƒ½éµå¾ªç»Ÿä¸€çš„ä¾èµ–æ³¨å…¥å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†æ¨¡å‹ï¼Œä½¿å¾— `Logic` å•å…ƒä¿æŒçº¯ç²¹ï¼Œåªå…³æ³¨ä¸šåŠ¡è§„åˆ™ã€‚
- **Resource Safety**: å¤–éƒ¨è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚ WebSocket çš„è¿æ¥ã€è®¢é˜…å’Œæ–­å¼€ï¼‰å®Œå…¨ç”±å…¶ `Layer` å®ç°æ¥ç®¡ç†ã€‚`Logic` æ— éœ€å…³å¿ƒèµ„æºæ¸…ç†ï¼Œå½“ `Store` çš„ `Scope` å…³é—­æ—¶ï¼ŒEffect è¿è¡Œæ—¶ä¼šä¿è¯æ‰€æœ‰æµçš„ç»ˆç»“å’Œç›¸å…³èµ„æºçš„é‡Šæ”¾ã€‚
- **Testability**: é€šè¿‡å°†å¤–éƒ¨æºå°è£…ä¸ºæœåŠ¡ï¼Œå¯ä»¥åœ¨æµ‹è¯•ä¸­è½»æ˜“åœ°ç”¨ä¸€ä¸ª Mock `Layer` æ¥æ›¿æ¢å…¶çœŸå®å®ç°ã€‚è¿™ä½¿å¾— `Logic` çš„è¡Œä¸ºæµ‹è¯•å˜å¾—ç²¾ç¡®ã€å¯é ï¼Œä¸”ä¸ä¾èµ–ä»»ä½•çœŸå®çš„ç½‘ç»œæˆ–å¤–éƒ¨ç³»ç»Ÿã€‚
</file>

<file path="runtime-logix/core/examples/04-dynamic-logic.md">
# Example: Conditional Logic Execution (v3 Paradigm)

> **Status**: Informational  
> **Note**: This document clarifies the standard v3 approach for handling conditional or dynamic business logic.  
> **Implementation Note**: In the code snippetsï¼Œ`$` is assumed to be a Bound API on a given Shape/Env. In the current PoC, real code should obtain `$` via the corresponding `Module.logic(($)=>...)` or by explicitly receiving a `BoundApi<Sh,R>` parameter.

## Architectural Principle

The v3 Logix architecture is based on a **static, compositional model**. All logic is defined at the time of the `Store`'s creation. There is no runtime API for dynamically adding or removing logic rules from a running store.

## Standard Pattern for Conditional Logic

Conditional logic should be implemented *inside* a `Logic` unit using standard `Effect` control flow operators. The logic is always present, but its execution is conditional based on the current state.

### Example

If a specific validation rule should only apply to VIP users, this is expressed with an `Effect.when` or a simple `if` statement within the logic's `Effect`.

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Form` è¡¨ç¤ºé’ˆå¯¹ FormShape é¢„ç»‘å®šçš„ Bound APIï¼Œå®é™… PoC ä¸­é€šå¸¸ç”±å¯¹åº” Module æ³¨å…¥ã€‚
const conditionalValidationLogic: Logic.Of<FormShape> =
  Effect.gen(function* (_) {
    const amount$ = $.flow.fromState(s => s.amount);

    const validationEffect = Effect.gen(function* (_) {
      const { isVip, amount } = yield* $.state.read;

      // The logic is always active, but the effectful part only runs when the condition is met.
      if (isVip && amount < 100) {
        yield* $.state.mutate(draft => {
          draft.errors.amount = "VIP minimum order is 100";
        });
      }
    });

    yield* amount$.pipe($.flow.run(validationEffect));
  })
);
```

This approach ensures that all possible behaviors of a store are statically defined, predictable, and type-safe, aligning with the core principles of the v3 architecture.
</file>

<file path="runtime-logix/core/examples/05-matrix-basic.md">
# Matrix Examples: Basic & Async (v3 Standard Paradigm)

> **Focus**: å•å­—æ®µ/å¤šå­—æ®µè”åŠ¨ã€å¼‚æ­¥å‰¯ä½œç”¨
> **Note**: æœ¬æ–‡ç¤ºä¾‹å·²æ›´æ–°ä¸º v3 Effect-Native æ ‡å‡†èŒƒå¼ï¼Œç»Ÿä¸€ä½¿ç”¨ Bound API `$` + `Flow.Api`ã€‚

## S01: åŸºç¡€è”åŠ¨ (Sync Linkage)

**v3 æ ‡å‡†æ¨¡å¼**: ä½¿ç”¨ `flow.fromState` ç›‘å¬æºå­—æ®µï¼Œåœ¨ `flow.run` ä¸­é€šè¿‡ `state.mutate` æ›´æ–°ç›®æ ‡å­—æ®µã€‚

```typescript
export const S01_ResetProvinceOnCountryChange: Logic.Of<FormShape> =
  ({ flow, state }) =>
    Effect.gen(function* (_) {
      const country$ = flow.fromState((s) => s.country);

      yield* country$.pipe(
        flow.run(
          state.mutate((draft) => {
            draft.province = "";
          })
        )
      );
    })
);
```

## S02: å¼‚æ­¥å›å¡« (Async Fill)

**v3 æ ‡å‡†æ¨¡å¼**: ç›‘å¬ `zipCode` å˜åŒ–ï¼Œé€šè¿‡ `flow.runLatest` æ‰§è¡ŒåŒ…å« API è°ƒç”¨çš„ Effectï¼Œè‡ªåŠ¨å¤„ç†ç«æ€ã€‚

```typescript
export const S02_FillCityByZipCode: Logic.Of<FormShape, GeoService> =
  ({ flow, state }) =>
    Effect.gen(function* (_) {
      const zip$ = flow.fromState((s) => s.zipCode);

      const fillCityEffect = Effect.gen(function* (_) {
        const svc = yield* GeoService;
        const { zipCode } = yield* state.read;
        const city = yield* svc.fetchCity(zipCode);
        yield* state.mutate((draft) => { draft.city = city; });
      });

      yield* zip$.pipe(
        flow.filter((zip) => zip.length >= 5),
        flow.runLatest(fillCityEffect) // ä½¿ç”¨ runLatest ä¿è¯åªå¤„ç†æœ€æ–°çš„ zip code
      );
    })
);
```

## S03: é˜²æŠ–æœç´¢ (Debounced Search)

**v3 æ ‡å‡†æ¨¡å¼**: å…¸å‹çš„ `debounce` + `filter` + `runLatest` ç»„åˆã€‚

```typescript
export const S03_SearchWithDebounce: Logic.Of<SearchShape, SearchApi> =
  ({ flow, state }) =>
    Effect.gen(function* (_) {
      const keyword$ = flow.fromState((s) => s.keyword);

      const searchEffect = Effect.gen(function* (_) {
        const svc = yield* SearchApi;
        const { keyword } = yield* state.read;
        const results = yield* svc.search(keyword);
        yield* state.mutate((draft) => { draft.results = results; });
      });

      yield* keyword$.pipe(
        flow.debounce(500),
        flow.filter((keyword) => keyword.trim() !== ""),
        flow.runLatest(searchEffect)
      );
    })
);
```

## S04: è”åˆæ ¡éªŒ (Multi-Field Validation)

**v3 æ ‡å‡†æ¨¡å¼**: `flow.fromState` å¯ä»¥ç›‘å¬ä¸€ä¸ªè¿”å›å…ƒç»„ `[s.startDate, s.endDate]` çš„ selectorã€‚

```typescript
export const S04_ValidateDateRange: Logic.Of<FormShape> =
  ({ flow, state }) =>
    Effect.gen(function* (_) {
      const datePair$ = flow.fromState(
        (s) => [s.startDate, s.endDate] as const
      );

      const validationEffect = state.mutate((draft) => {
        if (draft.startDate && draft.endDate && draft.startDate > draft.endDate) {
          draft.errors.dateRange = "Start must be <= End";
        } else {
          delete draft.errors.dateRange;
        }
      });

      yield* datePair$.pipe(flow.run(validationEffect));
    })
);
```

## S05: å¤šå‚æŸ¥è¯¢ (Multi-Arg Query)

**v3 æ ‡å‡†æ¨¡å¼**: ä¸ S04 ç±»ä¼¼ï¼Œç›‘å¬å¤šä¸ªå‚æ•°çš„å…ƒç»„ï¼Œç„¶åè§¦å‘ä¸€ä¸ªåŒ…å« API è°ƒç”¨çš„ Effectã€‚

```typescript
export const S05_QueryByCategoryAndSort: Logic.Of<ProductShape, ProductApi> =
  ({ flow, state }) =>
    Effect.gen(function* (_) {
      const params$ = flow.fromState(
        (s) => [s.category, s.sort] as const
      );

      const queryEffect = Effect.gen(function* (_) {
        const svc = yield* ProductApi;
        const { category, sort } = yield* state.read;
        const list = yield* svc.query(category, sort);
        yield* state.mutate((draft) => { draft.list = list; });
      });

      yield* params$.pipe(
        flow.filter(([cat, sort]) => !!cat && !!sort),
        flow.debounce(300),
        flow.runLatest(queryEffect)
      );
    })
);
```
</file>

<file path="runtime-logix/core/examples/06-matrix-collection.md">
# Matrix Examples: Collection & Batch (v3 Standard Paradigm)

> **Focus**: æ•°ç»„æ“ä½œã€è¡Œçº§è”åŠ¨ã€èšåˆè®¡ç®—ã€æ‰¹é‡æ›´æ–°  
> **Note**: æœ¬æ–‡ç¤ºä¾‹å±•ç¤ºäº† v3 Effect-Native æ ‡å‡†èŒƒå¼ã€‚æ‰€æœ‰é›†åˆæ“ä½œéƒ½é€šè¿‡ç›‘å¬çˆ¶çº§é›†åˆï¼Œå¹¶ä½¿ç”¨ `state.mutate` è¿›è¡ŒåŸå­åŒ–æ›´æ–°ã€‚å½“å‰ PoC ä¸­ï¼Œå®é™…ä»£ç åº”åœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ã€‚

## S06 & S09: è¡Œçº§è”åŠ¨ä¸åˆ—è¡¨èšåˆ (Row Linkage & Aggregation)

**v3 æ ‡å‡†æ¨¡å¼**: ç›‘å¬æ•´ä¸ª `items` æ•°ç»„çš„å˜åŒ–ã€‚åœ¨ `flow.run` ä¸­ï¼Œä½¿ç”¨ä¸€æ¬¡ `state.mutate` åŒæ—¶å®Œæˆæ‰€æœ‰æ´¾ç”ŸçŠ¶æ€ï¼ˆè¡Œå†… `total` å’Œæ•´ä½“ `summary`ï¼‰çš„è®¡ç®—ï¼Œä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§å¹¶è·å¾—æœ€ä½³æ€§èƒ½ã€‚

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Cart` è¡¨ç¤ºé’ˆå¯¹ CartShape é¢„ç»‘å®šçš„ Bound APIï¼Œå®é™… PoC ä¸­é€šå¸¸ç”±å¯¹åº” Module æ³¨å…¥ã€‚
const aggregationLogic: Logic.Of<CartShape> =
  Effect.gen(function* (_) {
    const items$ = $Cart.flow.fromState(s => s.items);

    const calculationEffect = $Cart.state.mutate(draft => {
      let totalAmount = 0;
      // 1. è¡Œçº§è”åŠ¨ï¼šè®¡ç®—æ¯è¡Œçš„ total
      draft.items.forEach(item => {
        item.total = item.price * item.quantity;
        // 2. èšåˆè®¡ç®—ï¼šç´¯åŠ æ€»ä»·
        if (item.checked) {
          totalAmount += item.total;
        }
      });
      draft.summary.totalAmount = totalAmount;
    });

    yield* items$.pipe(
      $Cart.flow.debounce(50), // è½»å¾®é˜²æŠ–ä»¥åº”å¯¹è¿ç»­çš„è¡Œæ“ä½œ
      $Cart.flow.run(calculationEffect)
    );
  })
);
```

## S07: è¡Œçº§å¼‚æ­¥ (Row Async)

**v3 æ ‡å‡†æ¨¡å¼**: ç›‘å¬æ•´ä¸ª `items` æ•°ç»„ã€‚åœ¨ `flow.run` ä¸­ï¼Œéå†æ•°ç»„ï¼Œè¯†åˆ«å‡ºéœ€è¦æ‰§è¡Œå¼‚æ­¥æ“ä½œçš„é¡¹ï¼Œå¹¶ä½¿ç”¨ `Effect.all` å¹¶è¡Œå¤„ç†å®ƒä»¬ã€‚è¿™éœ€è¦å¼€å‘è€…è‡ªè¡Œç®¡ç†çŠ¶æ€ä»¥é¿å…é‡å¤è¯·æ±‚ã€‚

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$List` è¡¨ç¤ºé’ˆå¯¹ ProductListShape + ProductApi é¢„ç»‘å®šçš„ Bound APIã€‚
const asyncRowLogic: Logic.Of<ProductListShape, ProductApi> =
  Effect.gen(function* (_) {
    const items$ = $List.flow.fromState(s => s.items);

    const fetchDetailsEffect = Effect.gen(function* (_) {
      const api = yield* $List.services(ProductApi);
      const { items } = yield* $List.state.read;
      
      // ç­›é€‰å‡ºéœ€è¦åŠ è½½è¯¦æƒ…çš„è¡Œ
      const effects = items.map((item, index) => 
        item.productId && !item.detail
          ? api.fetchDetail(item.productId).pipe(
              Effect.flatMap(detail =>
                $List.state.mutate(draft => { draft.items[index].detail = detail; })
              )
            )
          : Effect.void
      );

      // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰åŠ è½½ä»»åŠ¡
      yield* Effect.all(effects, { discard: true, concurrency: 'unbounded' });
    });

    yield* items$.pipe($List.flow.runLatest(fetchDetailsEffect));
  })
);
```

## S08: å…¨é€‰/åé€‰ (Batch Update)

**v3 æ ‡å‡†æ¨¡å¼**: ç›‘å¬è§¦å‘å…¨é€‰çš„ `Action`ã€‚åœ¨ `flow.run` ä¸­æ‰§è¡Œä¸€æ¬¡ `state.mutate`ï¼Œå³å¯åŸå­åŒ–åœ°éå†å¹¶æ›´æ–°æ‰€æœ‰è¡Œï¼Œå®ç°æ‰¹é‡æ›´æ–°æ•ˆæœã€‚

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Cart` åŒæ ·è¡¨ç¤ºé’ˆå¯¹ CartShape é¢„ç»‘å®šçš„ Bound APIã€‚
const toggleAllLogic: Logic.Of<CartShape> =
  Effect.gen(function* (_) {
    const toggleAll$ = $Cart.flow.fromAction(a => a._tag === 'toggleAll');

    const toggleAllEffect = Effect.gen(function* (_) {
      const { isAllChecked } = yield* $Cart.state.read;
      const nextChecked = !isAllChecked;

      yield* $Cart.state.mutate(draft => {
        draft.isAllChecked = nextChecked;
        draft.items.forEach(item => {
          item.checked = nextChecked;
        });
      });
    });

    yield* toggleAll$.pipe($Cart.flow.run(toggleAllEffect));
  })
);
```
</file>

<file path="runtime-logix/core/examples/07-matrix-external.md">
# Matrix Examples: External & Lifecycle (v3 Standard Paradigm)

> **Focus**: å¤–éƒ¨æµé›†æˆã€é«˜é¢‘æ¨é€ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†  
> **Note**: æœ¬æ–‡ç¤ºä¾‹å·²æ›´æ–°ä¸º v3 Effect-Native æ ‡å‡†èŒƒå¼ã€‚æ‰€æœ‰å¤–éƒ¨äº‹ä»¶æºéƒ½åº”è¢«å°è£…ä¸º `Effect.Service` å¹¶é€šè¿‡ä¾èµ–æ³¨å…¥åœ¨ `Logic` ä¸­æ¶ˆè´¹ã€‚å½“å‰ PoC ä¸­ï¼Œå®é™…ä»£ç åº”åœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ã€‚

## S10: å®æ—¶æ¨é€ (Realtime Push)

**v3 æ ‡å‡†æ¨¡å¼**: å°† WebSocket å°è£…ä¸ºæœåŠ¡ï¼Œ`Logic` è®¢é˜…å…¶æš´éœ²çš„ `Stream`ã€‚

```typescript
// 1. å®šä¹‰æœåŠ¡æ¥å£
class PriceService extends Context.Tag("PriceService")<PriceService, {
  readonly price$: Stream.Stream<number>;
}>() {}

// 2. åœ¨ Logic ä¸­æ¶ˆè´¹ï¼ˆæ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Stock` è¡¨ç¤ºé’ˆå¯¹ StockShape + PriceService é¢„ç»‘å®šçš„ Bound APIï¼‰
const realTimeLogic: Logic.Of<StockShape, PriceService> =
  Effect.gen(function* (_) {
    const priceSvc = yield* $Stock.services(PriceService);

    // å°†å¤–éƒ¨ä»·æ ¼æµæ¥å…¥çŠ¶æ€æ›´æ–°
    yield* priceSvc.price$.pipe(
      $Stock.flow.run(price => 
        $Stock.state.mutate(draft => { draft.stock.price = price; })
      )
    );
  })
);
```

## S11: é«˜é¢‘æ¨é€ (High Frequency Push)

**v3 æ ‡å‡†æ¨¡å¼**: åœ¨ `Logic` æ¶ˆè´¹ `Stream` ä¹‹å‰ï¼Œä½¿ç”¨ `Stream` çš„åŸç”Ÿæ“ä½œç¬¦ï¼ˆå¦‚ `chunkN` æˆ– `debounce`) è¿›è¡Œç¼“å†²æˆ–é‡‡æ ·ï¼Œç„¶åé€šè¿‡ä¸€æ¬¡ `state.mutate` æ‰¹é‡æ›´æ–°ã€‚

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Data` è¡¨ç¤ºé’ˆå¯¹ DataShape + HighFrequencyService é¢„ç»‘å®šçš„ Bound APIã€‚
const highFrequencyLogic: Logic.Of<DataShape, HighFrequencyService> =
  Effect.gen(function* (_) {
    const hfSvc = yield* $Data.services(HighFrequencyService);

    yield* hfSvc.events$.pipe(
      // æ¯ 50 æ¯«ç§’æˆ–æ¯ 100 ä¸ªäº‹ä»¶ï¼Œå°†äº‹ä»¶æ‰“åŒ…æˆä¸€ä¸ªæ•°ç»„ (Chunk)
      Stream.chunkN(100),
      Stream.debounce('50 millis'),
      // å¯¹æ¯ä¸ªäº‹ä»¶åŒ…è¿›è¡Œæ‰¹é‡å¤„ç†
      $Data.flow.run(chunk => 
        $Data.state.mutate(draft => {
          chunk.forEach(event => {
            draft.data[event.id] = event.value;
          });
        })
      )
    );
  })
);
```

## S12: åˆå§‹åŒ–åŠ è½½ (Init Load)

**v3 æ ‡å‡†æ¨¡å¼**: åœ¨ Logic ç¨‹åºçš„ `Effect.gen` ä¸»ä½“ä¸­ç›´æ¥ç¼–å†™åˆå§‹åŒ–é€»è¾‘ã€‚è¿™ä¸ª Effect åªä¼šåœ¨ `Logic` é¦–æ¬¡å¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$User` è¡¨ç¤ºé’ˆå¯¹ UserShape + UserApi é¢„ç»‘å®šçš„ Bound APIã€‚
const initialLoadLogic: Logic.Of<UserShape, UserApi> =
  Effect.gen(function* (_) {
    const api = yield* $User.services(UserApi);
    const { userId } = yield* $User.state.read;

    // Logic åˆå§‹åŒ–æ—¶ç›´æ¥æ‰§è¡ŒåŠ è½½
    yield* $User.state.mutate(draft => { draft.meta.isLoading = true; });
    const data = yield* api.fetchUser(userId);
    yield* $User.state.mutate(draft => {
      draft.data = data;
      draft.meta.isLoading = false;
    });

    // ... æ­¤å¤„å¯ä»¥ç»§ç»­å®šä¹‰å…¶ä»–æµå¼ç›‘å¬é€»è¾‘
  })
);
```

## S13: é”€æ¯æ¸…ç† (Dispose)

**v3 æ ‡å‡†æ¨¡å¼**: å¼€å‘è€… **æ— éœ€æ‰‹åŠ¨æ¸…ç†**ã€‚æ‰€æœ‰åœ¨ `Logic` ä¸­å¯åŠ¨çš„æµ (`flow.run`) æˆ– `Effect` (`Effect.forkScoped`) éƒ½ä¼šè¢«ç»‘å®šåˆ° `Store` çš„ `Scope` ä¸Šã€‚å½“ `Store` è¢«é”€æ¯æ—¶ï¼Œ`Scope` ä¼šè¢«å…³é—­ï¼ŒEffect è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ä¸­æ–­æ‰€æœ‰ç›¸å…³çš„ Fibersï¼Œå¹¶æ‰§è¡Œæ‰€æœ‰æ³¨å†Œçš„ `finalizer`ï¼ˆä¾‹å¦‚æ–­å¼€ WebSocket è¿æ¥ã€æ¸…é™¤å®šæ—¶å™¨ç­‰ï¼‰ã€‚è¿™æ˜¯ Effect ç»“æ„åŒ–å¹¶å‘å¸¦æ¥çš„æ ¸å¿ƒä¼˜åŠ¿ä¹‹ä¸€ã€‚
</file>

<file path="runtime-logix/core/examples/08-matrix-flow.md">
# Matrix Examples: Flow Control (v3 Standard Paradigm)

> **Focus**: é”™è¯¯é‡è¯•ã€ç«æ€å–æ¶ˆã€é”™è¯¯å›é€€  
> **Note**: æœ¬æ–‡ç¤ºä¾‹å·²æ›´æ–°ä¸º v3 Effect-Native æ ‡å‡†èŒƒå¼ï¼Œä½¿ç”¨ `Flow` API å’Œ `Effect` ç»„åˆå­æ¥å£°æ˜å¼åœ°å¤„ç†å¤æ‚çš„å¼‚æ­¥æ§åˆ¶æµã€‚å½“å‰ PoC ä¸­ï¼Œå®é™…ä»£ç åº”åœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ã€‚

## S14: å¤±è´¥é‡è¯• (Retry)

**v3 æ ‡å‡†æ¨¡å¼**: åœ¨ä¼ é€’ç»™ `flow.run` çš„ `Effect` å†…éƒ¨ï¼Œä½¿ç”¨ `Effect.retry` ç»„åˆå­ã€‚

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Form` è¡¨ç¤ºé’ˆå¯¹ FormShape + UserApi é¢„ç»‘å®šçš„ Bound APIã€‚
const retryLogic: Logic.Of<FormShape, UserApi> =
  Effect.gen(function* (_) {
    const username$ = $.flow.fromState(s => s.username);

    const checkUsernameWithRetry = Effect.gen(function* (_) {
      const api = yield* $.services(UserApi);
      const { username } = yield* $.state.read;
      const result = yield* api.check(username).pipe(
        // Effect åŸç”Ÿçš„é‡è¯•èƒ½åŠ›
        Effect.retry({ times: 3, schedule: Schedule.exponential('100 millis') })
      );
      yield* $.state.mutate(draft => { draft.isValid = result; });
    });

    yield* username$.pipe($.flow.run(checkUsernameWithRetry));
  })
);
```

## S15: ç«æ€å–æ¶ˆ (SwitchMap)

**v3 æ ‡å‡†æ¨¡å¼**: ä½¿ç”¨ `flow.runLatest` ä»£æ›¿ `flow.run`ã€‚`runLatest` ä¼šè‡ªåŠ¨å–æ¶ˆå‰ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ Effectï¼Œç¡®ä¿åªæœ‰æœ€æ–°çš„æµäº‹ä»¶å¯¹åº”çš„é€»è¾‘åœ¨è¿è¡Œã€‚

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Search` è¡¨ç¤ºé’ˆå¯¹ SearchShape + SearchApi é¢„ç»‘å®šçš„ Bound APIã€‚
const switchMapLogic: Logic.Of<SearchShape, SearchApi> =
  Effect.gen(function* (_) {
    const keyword$ = $.flow.fromState(s => s.keyword);

    const searchEffect = Effect.gen(function* (_) {
      const api = yield* $.services(SearchApi);
      const { keyword } = yield* $.state.read;
      const result = yield* api.search(keyword);
      yield* $.state.mutate(draft => { draft.results = result; });
    });

    yield* keyword$.pipe(
      $.flow.debounce(300),
      // å…³é”®ï¼šä½¿ç”¨ runLatest å®ç° SwitchMap è¯­ä¹‰
      $.flow.runLatest(searchEffect)
    );
  })
);
```

## S16: é”™è¯¯å›é€€ (Error Fallback)

**v3 æ ‡å‡†æ¨¡å¼**: åœ¨ `Effect` å†…éƒ¨ä½¿ç”¨ `Effect.catchAll` æˆ– `Effect.try` æ¥å¤„ç†é”™è¯¯åˆ†æ”¯ã€‚

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Config` è¡¨ç¤ºé’ˆå¯¹ ConfigShape + ConfigApi é¢„ç»‘å®šçš„ Bound APIã€‚
const fallbackLogic: Logic.Of<ConfigShape, ConfigApi> =
  Effect.gen(function* (_) {
    const configId$ = $.flow.fromState(s => s.configId);

    const fetchEffect = Effect.gen(function* (_) {
      const api = yield* $.services(ConfigApi);
      const { configId } = yield* $.state.read;

      const fetchWithFallback = api.fetch(configId).pipe(
        // å¦‚æœ API è°ƒç”¨å¤±è´¥ï¼Œåˆ™å›é€€åˆ°é»˜è®¤å€¼
        Effect.catchAll(() => Effect.succeed(DEFAULT_CONFIG))
      );

      const config = yield* fetchWithFallback;
      yield* $.state.mutate(draft => { draft.config = config; });
    });

    yield* configId$.pipe($.flow.run(fetchEffect));
  })
);
```
</file>

<file path="runtime-logix/core/examples/09-matrix-advanced-data.md">
# Matrix Examples: Advanced Data & Circular Protection (v3 Standard Paradigm)

> **Focus**: æ·±å±‚åµŒå¥—ã€åŠ¨æ€å­—å…¸ã€å¾ªç¯ä¾èµ–é˜²æŠ¤  
> **Note**: æœ¬æ–‡ç¤ºä¾‹å±•ç¤ºäº† v3 Effect-Native æ ‡å‡†èŒƒå¼ã€‚v3 é€šè¿‡ç›‘å¬çˆ¶çº§é›†åˆæ¥å¤„ç†åŠ¨æ€æ•°æ®ï¼Œå¹¶é€šè¿‡ `flow.fromState` å†…ç½®çš„æ·±åº¦ç›¸ç­‰æ£€æŸ¥æ¥è‡ªåŠ¨å¤„ç†å¾ªç¯ä¾èµ–ã€‚å½“å‰ PoC ä¸­ï¼Œå®é™…ä»£ç åº”åœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ã€‚

## S17 & S18: æ·±å±‚åµŒå¥—ä¸åŠ¨æ€å­—å…¸ (Deep Nested & Dynamic Map)

**v3 æ ‡å‡†æ¨¡å¼**: ç›‘å¬åŒ…å«åŠ¨æ€æ•°æ®ï¼ˆæ•°ç»„æˆ–å­—å…¸ï¼‰çš„é¡¶å±‚çŠ¶æ€è·¯å¾„ã€‚åœ¨ `flow.run` ä¸­æ‰§è¡Œçš„ Effect è´Ÿè´£éå†é›†åˆï¼Œåº”ç”¨ä¸šåŠ¡é€»è¾‘ã€‚`state.mutate` å¯ä»¥å®‰å…¨ã€é«˜æ•ˆåœ°å¤„ç†æ·±å±‚åµŒå¥—æ›´æ–°ã€‚

```typescript
// åœºæ™¯ï¼šç›‘å¬ä¸€ä¸ªåŠ¨æ€å­—å…¸ itemsByIdï¼Œå½“ä»»æ„ä¸€é¡¹çš„ status å˜ä¸º 'done' æ—¶ï¼Œä¸ºå…¶æ·»åŠ  archived æ ‡è®°ã€‚
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Data` è¡¨ç¤ºé’ˆå¯¹ DataShape é¢„ç»‘å®šçš„ Bound APIã€‚
const dynamicMapLogic: Logic.Of<DataShape> =
  Effect.gen(function* (_) {
    // ç›‘å¬æ•´ä¸ª itemsById å¯¹è±¡
    const itemsById$ = $.flow.fromState(s => s.itemsById);

    const archiveEffect = $.state.mutate(draft => {
      Object.values(draft.itemsById).forEach(item => {
        if (item.status === 'done' && !item.archived) {
          item.archived = true;
        }
      });
    });

    yield* itemsById$.pipe($.flow.run(archiveEffect));
  })
);
```

## S19: å¾ªç¯ä¾èµ–é˜²æŠ¤ (Circular Protection)

**v3 æ ‡å‡†æ¨¡å¼**: `flow.fromState` é»˜è®¤ä½¿ç”¨æ·±åº¦ç›¸ç­‰ï¼ˆdeep equalï¼‰æ£€æŸ¥æ¥åˆ¤æ–­çŠ¶æ€æ˜¯å¦çœŸæ­£å‘ç”Ÿäº†å˜åŒ–ã€‚å¦‚æœä¸€ä¸ªæ›´æ–°æ“ä½œå¯¼è‡´çš„çŠ¶æ€ä¸å‰ä¸€ä¸ªçŠ¶æ€æ·±åº¦ç›¸ç­‰ï¼Œæµå°†ä¸ä¼šå‘å‡ºæ–°å€¼ï¼Œä»è€Œè‡ªåŠ¨åˆ‡æ–­å¾ªç¯ã€‚

```typescript
// åœºæ™¯ï¼šUSD <-> CNY åŒå‘æ±‡ç‡æ¢ç®—ï¼›`$Currency` è¡¨ç¤ºé’ˆå¯¹ CurrencyShape é¢„ç»‘å®šçš„ Bound APIã€‚
const currencyLogic: Logic.Of<CurrencyShape> =
  Effect.gen(function* (_) {
    const usd$ = $.flow.fromState(s => s.usd);
    const cny$ = $.flow.fromState(s => s.cny);

    // Rule 1: USD -> CNY
    const usdToCny = usd$.pipe(
      $.flow.run(
        $.state.mutate(draft => {
          draft.cny = draft.usd * 7; // å‡è®¾æ±‡ç‡ä¸º 7
        })
      )
    );

    // Rule 2: CNY -> USD
    const cnyToUsd = cny$.pipe(
      $.flow.run(
        $.state.mutate(draft => {
          draft.usd = draft.cny / 7;
        })
      )
    );

    // å½“ usdToCny æ›´æ–° cny æ—¶ï¼Œä¼šè§¦å‘ cny$ æµã€‚cnyToUsd ä¼šæ ¹æ®æ–°çš„ cny è®¡ç®—å‡ºä¸€ä¸ª usd å€¼ã€‚
    // è¿™ä¸ªæ–°è®¡ç®—å‡ºçš„ usd å€¼ä¸è§¦å‘ usdToCny çš„åŸå§‹ usd å€¼ç›¸åŒã€‚
    // å› æ­¤ï¼Œå½“ cnyToUsd å°è¯•æ›´æ–° usd æ—¶ï¼Œstate.mutate äº§ç”Ÿçš„æ–°çŠ¶æ€ä¸å½“å‰çŠ¶æ€æ·±åº¦ç›¸ç­‰ï¼Œ
    // è¿™å¯¼è‡´ usd$ æµä¸ä¼šå†æ¬¡è§¦å‘ï¼Œå¾ªç¯è¢«è‡ªåŠ¨ä¸­æ–­ã€‚

    yield* Effect.all([usdToCny, cnyToUsd], { discard: true });
  })
);
```
</file>

<file path="runtime-logix/core/examples/10-matrix-concurrency.md">
# Matrix Examples: Advanced Concurrency (v3 Standard Paradigm)

> **Focus**: Exhaust Map (æäº¤é˜²é‡), å¹¶è¡ŒæœåŠ¡è°ƒç”¨  
> **Note**: æœ¬æ–‡ç¤ºä¾‹å·²æ›´æ–°ä¸º v3 Effect-Native æ ‡å‡†èŒƒå¼ï¼Œä½¿ç”¨ `Flow.Api` å’Œ `Effect.all` æ¥å£°æ˜å¼åœ°ç®¡ç†å¹¶å‘ã€‚å½“å‰ PoC ä¸­ï¼Œå®é™…ä»£ç åº”åœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ã€‚

## S20: æäº¤é˜²é‡ (Submit Exhaust)

**v3 æ ‡å‡†æ¨¡å¼**: ç›‘å¬æäº¤ `Action`ï¼Œå¹¶ä½¿ç”¨ `flow.runExhaust` æ¥æ‰§è¡Œæäº¤ Effectã€‚`runExhaust` ä¼šåœ¨å‰ä¸€ä¸ª Effect å®Œæˆå‰ï¼Œè‡ªåŠ¨å¿½ç•¥æ‰€æœ‰æ–°çš„è§¦å‘ï¼Œä»è€Œå¤©ç„¶åœ°é˜²æ­¢äº†é‡å¤æäº¤ã€‚

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Form` è¡¨ç¤ºé’ˆå¯¹ FormShape + OrderApi é¢„ç»‘å®šçš„ Bound APIã€‚
const submitLogic: Logic.Of<FormShape, OrderApi> =
  Effect.gen(function* (_) {
    const submit$ = $.flow.fromAction(a => a._tag === 'submit');

    const submitEffect = Effect.gen(function* (_) {
      const api = yield* $Form.services(OrderApi);
      yield* $Form.state.mutate(draft => { draft.meta.isSubmitting = true; });

      // å°† API è°ƒç”¨å’Œåç»­çŠ¶æ€æ›´æ–°åŒ…è£…åœ¨ä¸€ä¸ªå¯ä¸­æ–­çš„ Effect ä¸­
      const result = yield* Effect.either(api.submit());

      if (result._tag === 'Left') {
        yield* $Form.state.mutate(draft => {
          draft.meta.isSubmitting = false;
          draft.meta.error = result.left.message;
        });
      } else {
        yield* $Form.state.mutate(draft => { draft.meta.isSubmitting = false; });
      }
    });

    // å…³é”®ï¼šä½¿ç”¨ runExhaustï¼Œåœ¨ submitEffect å®Œæˆå‰ï¼Œæ‰€æœ‰ submit$ çš„æ–°äº‹ä»¶éƒ½å°†è¢«å¿½ç•¥
    yield* submit$.pipe($.flow.runExhaust(submitEffect));
  })
);
```

## S21: å¤šæœåŠ¡å¹¶è¡Œ (Parallel Services)

**v3 æ ‡å‡†æ¨¡å¼**: åœ¨ä¸€ä¸ª `Effect` ä¸­ï¼Œä½¿ç”¨ `Effect.all` æ¥å¹¶è¡Œæ‰§è¡Œå¤šä¸ªç‹¬ç«‹çš„å¼‚æ­¥ä»»åŠ¡ã€‚é€šè¿‡åœ¨æ¯ä¸ªä»»åŠ¡å†…éƒ¨åˆ†åˆ«ä½¿ç”¨ `Effect.catchAll`ï¼Œå¯ä»¥å®ç°éƒ¨åˆ†æˆåŠŸã€éƒ¨åˆ†å¤±è´¥çš„å¥å£®é”™è¯¯å¤„ç†ã€‚

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Page` è¡¨ç¤ºé’ˆå¯¹ PageShape + (UserApi | ConfigApi) é¢„ç»‘å®šçš„ Bound APIã€‚
const parallelLoadLogic: Logic.Of<PageShape, UserApi | ConfigApi> =
  Effect.gen(function* (_) {
      const userApi = yield* $Page.services(UserApi);
      const configApi = yield* $Page.services(ConfigApi);
      const { userId } = yield* $Page.state.read;

      // Logic åˆå§‹åŒ–æ—¶ï¼Œå¹¶è¡ŒåŠ è½½ç”¨æˆ·å’Œé…ç½®
      yield* Effect.all(
        [
          // ç¬¬ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡ï¼šåŠ è½½ç”¨æˆ·
          userApi.fetch(userId).pipe(
            Effect.flatMap(user => $Page.state.mutate(draft => { draft.user = user; })),
            Effect.catchAll(error => $Page.state.mutate(draft => { draft.errors.user = error.message; }))
          ),
          // ç¬¬äºŒä¸ªå¹¶è¡Œä»»åŠ¡ï¼šåŠ è½½é…ç½®
          configApi.fetch().pipe(
            Effect.flatMap(config => $Page.state.mutate(draft => { draft.config = config; })),
            Effect.catchAll(error => $Page.state.mutate(draft => { draft.errors.config = error.message; }))
          )
        ],
        { discard: true, concurrency: 'unbounded' } // 'unbounded' å…è®¸æ‰€æœ‰ä»»åŠ¡å¹¶è¡Œ
      );
    })
);
```
</file>

<file path="runtime-logix/core/examples/11-matrix-system.md">
# Matrix Examples: System Capabilities (v3 Standard Paradigm)

> **Focus**: å¤šç§Ÿæˆ·éš”ç¦»ã€é”™è¯¯æµè·¯ç”±ã€æƒé™æ§åˆ¶  
> **Note**: æœ¬æ–‡ç¤ºä¾‹å·²æ›´æ–°ä¸º v3 Effect-Native æ ‡å‡†èŒƒå¼ï¼Œå±•ç¤ºäº†å¦‚ä½•åˆ©ç”¨ `Layer` å’Œ `Effect` çš„åŸç”Ÿèƒ½åŠ›æ¥å®ç°ç³»ç»Ÿçº§çš„æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚å½“å‰ PoC ä¸­ï¼Œå®é™…ä»£ç åº”åœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ã€‚

## S22: å¤šç§Ÿæˆ·éš”ç¦» (Multi-Tenant)

**v3 æ ‡å‡†æ¨¡å¼**: é€šè¿‡ `Layer` çš„ç»„åˆæ¥ä¸ºä¸åŒç§Ÿæˆ·æä¾›ä¸åŒçš„æœåŠ¡å®ç°ã€‚`Logic` ä»£ç æœ¬èº«ä¿æŒç§Ÿæˆ·æ— å…³ï¼Œåªä¾èµ–äºæœåŠ¡çš„æŠ½è±¡æ¥å£ (`Tag`)ã€‚

```typescript
// 1. å®šä¹‰æœåŠ¡æ¥å£
class UserApi extends Context.Tag("UserApi")<UserApi, {
  readonly fetch: (id: string) => Effect.Effect<User, Error>
}>() {}

// 2. ä¸ºä¸åŒç§Ÿæˆ·æä¾›ä¸åŒçš„å®ç° Layer
const TenantALayer = Layer.succeed(UserApi, { fetch: (id) => Effect.succeed({ id, name: `Tenant A User ${id}` }) });
const TenantBLayer = Layer.succeed(UserApi, { fetch: (id) => Effect.succeed({ id, name: `Tenant B User ${id}` }) });

// 3. Logic ä»£ç ä¿æŒä¸å˜ï¼Œåªä¾èµ– UserApi Tagï¼›`$User` æ¦‚å¿µä¸Šè¡¨ç¤ºé’ˆå¯¹ UserShape + UserApi é¢„ç»‘å®šçš„ Bound APIã€‚
const userLogic: Logic.Of<UserShape, UserApi> =
  Effect.gen(function* (_) {
    const api = yield* $User.services(UserApi);
    const { userId } = yield* $User.state.read;
    const user = yield* api.fetch(userId);
    yield* $User.state.mutate(draft => { draft.user = user; });
  })
);

// 4. åœ¨åº”ç”¨å…¥å£å¤„ï¼Œæ ¹æ®å½“å‰ç§Ÿæˆ·é€‰æ‹©å¹¶æä¾›å¯¹åº”çš„ Layer
const AppLayer = currentTenant === 'A' ? TenantALayer : TenantBLayer;
Effect.runFork(UserModule.live.pipe(Effect.provide(AppLayer)));
```

## S23: é”™è¯¯æµè·¯ç”± (Error Routing)

**v3 æ ‡å‡†æ¨¡å¼**: `Logic` ä¸­è¿”å›çš„ `Effect` çš„é”™è¯¯é€šé“ (`E`) ä¼šè¢« `Store` çš„è¿è¡Œæ—¶æ•è·ã€‚å¯ä»¥é€šè¿‡è®¢é˜… `Store` æš´éœ²çš„å…¨å±€é”™è¯¯æµæ¥æ„å»ºç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ã€‚

```typescript
// 1. Logic ä¸­å…è®¸å‡ºç°å¤±è´¥
const errorLogic: Logic.Of<Shape, Api> =
  Effect.gen(function* (_) {
    const api = yield* Api;
    // è¿™ä¸ª Effect å¯èƒ½ä¼šå¤±è´¥ï¼Œç±»å‹ä¸º Effect<void, ApiError, ...>
    yield* api.unreliableCall();
  })
);

// 2. åœ¨ Domain å¤–éƒ¨è®¢é˜…é”™è¯¯æµ (æ¦‚å¿µä»£ç )
const live = SomeDomain.live(initialState, errorLogic);

// runtime.errors$ æ˜¯ä¸€ä¸ª Stream<ApiError>
runtime.errors$.pipe(
  Stream.runForEach(error =>
    // åœ¨è¿™é‡Œå®ç°å…¨å±€é”™è¯¯ä¸ŠæŠ¥æˆ–å¼¹çª—æç¤º
    Effect.logError(`Global Error Caught: ${error.message}`)
  )
);
```

## S24: æƒé™æ§åˆ¶ (Permission Gating)

**v3 æ ‡å‡†æ¨¡å¼**: åœ¨ `Effect` å†…éƒ¨é€šè¿‡è°ƒç”¨æ³¨å…¥çš„ `AuthService` æ¥å®ç°è¿è¡Œæ—¶çš„æƒé™æ£€æŸ¥ï¼Œå¹¶ä½¿ç”¨ `Effect.if` æˆ– `$.match` æ¥æ‰§è¡Œç›¸åº”çš„é€»è¾‘åˆ†æ”¯ã€‚

```typescript
// 1. å®šä¹‰ AuthService
class AuthService extends Context.Tag("AuthService")<AuthService, {
  readonly canApprove: () => Effect.Effect<boolean>
}>() {}

// 2. åœ¨ Logic ä¸­ä½¿ç”¨ï¼›`$Approval` æ¦‚å¿µä¸Šè¡¨ç¤ºé’ˆå¯¹ ApprovalShape + (AuthService | ApprovalApi) é¢„ç»‘å®šçš„ Bound APIã€‚
const permissionLogic: Logic.Of<ApprovalShape, AuthService | ApprovalApi> =
  Effect.gen(function* (_) {
      const approve$ = $Approval.flow.fromAction(a => a._tag === 'approve');

      const approveEffect = Effect.gen(function* (_) {
        const auth = yield* $Approval.services(AuthService);
        const api = yield* $Approval.services(ApprovalApi);

        const hasPermission = yield* auth.canApprove();

        // ä½¿ç”¨ $.match è¿›è¡Œæƒé™æ£€æŸ¥
        yield* $Approval.match(hasPermission)
          .when(true, () =>
            $Approval.state.update(s => ({ ...s, status: 'approved' }))
          )
          .when(false, () =>
             $Approval.state.update(s => ({ ...s, status: 'rejected', reason: 'No Permission' }))
          )
          .exhaustive();
      });

      yield* approve$.pipe($Approval.flow.run(approveEffect));
    })
);
```
</file>

<file path="runtime-logix/core/examples/12-pattern-intent-priority.md">
# Pattern: Intent Priority & Conflict Resolution (v3 Standard Paradigm)

> **Scenario**: ä»·æ ¼è®¡ç®— (User Override vs Auto Calculation)  
> **Focus**: æ˜¾å¼çŠ¶æ€å»ºæ¨¡ã€é€»è¾‘å†²çªè§£å†³  
> **Note**: æœ¬æ–‡ç¤ºä¾‹å±•ç¤ºäº† v3 Effect-Native æ ‡å‡†èŒƒå¼ã€‚é€šè¿‡åœ¨çŠ¶æ€æ¨¡å‹ä¸­æ·»åŠ æ˜ç¡®çš„æ ‡å¿—ï¼ˆå¦‚ `isManualOverride`ï¼‰ï¼Œå¯ä»¥æ˜¾å¼åœ°ã€å¯é¢„æµ‹åœ°ç®¡ç†é€»è¾‘å†²çªã€‚å½“å‰ PoC ä¸­ï¼Œå®é™…ä»£ç åº”åœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ã€‚

## 1. The Challenge (ç—›ç‚¹)

å¤šä¸ªé€»è¾‘æºå¯èƒ½è¯•å›¾ä¿®æ”¹åŒä¸€ä¸ªå­—æ®µï¼Œå¯¼è‡´å†²çªï¼š
1.  **è‡ªåŠ¨è®¡ç®—**: `total` åº”æ ¹æ® `quantity * unitPrice` è‡ªåŠ¨æ›´æ–°ã€‚
2.  **ç”¨æˆ·è¦†ç›–**: ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹ `total`ï¼Œæ­¤æ—¶è‡ªåŠ¨è®¡ç®—åº”æš‚åœã€‚
3.  **ç³»ç»Ÿç­–ç•¥**: ç®¡ç†å‘˜åº”ç”¨â€œæœ€ä½é™ä»·â€ç­–ç•¥ï¼Œå¼ºåˆ¶è¦†ç›– `total`ã€‚

## 2. The Solution: Explicit State Modeling

v3 é€šè¿‡åœ¨ State Schema ä¸­æ·»åŠ é¢å¤–çš„å­—æ®µæ¥æ˜ç¡®åœ°è¿½è¸ªå’Œæ§åˆ¶é€»è¾‘çš„æ‰§è¡Œæƒã€‚

### 2.1 Schema Definition

åœ¨çŠ¶æ€ä¸­æ·»åŠ  `isTotalManual` æ ‡å¿—æ¥è®°å½• `total` å­—æ®µæ˜¯å¦å·²è¢«ç”¨æˆ·æ‰‹åŠ¨æ§åˆ¶ã€‚

```typescript
const OrderItemSchema = Schema.Struct({
  quantity: Schema.Number,
  unitPrice: Schema.Number,
  total: Schema.Number,
  // æ˜¾å¼æ ‡å¿—ï¼Œç”¨äºæ§åˆ¶é€»è¾‘ä¼˜å…ˆçº§
  isTotalManual: Schema.Boolean
});

const OrderItemActionSchema = Schema.Union(
  // ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹ total çš„ä¸“å± Action
  Schema.Struct({ _tag: Schema.Literal('setTotalManually'), payload: Schema.Number }),
  Schema.Struct({ _tag: Schema.Literal('resetTotalToAuto') })
);

type OrderItemShape = Logix.ModuleShape<typeof OrderItemSchema, typeof OrderItemActionSchema>;
```

### 2.2 Logic Implementation

æ¯ä¸ªé€»è¾‘æºéƒ½æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„ã€æœ‰æ˜ç¡®æ¡ä»¶çš„æµã€‚

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Item` è¡¨ç¤ºé’ˆå¯¹ OrderItemShape é¢„ç»‘å®šçš„ Bound APIã€‚
const priorityLogic: Logic.Of<OrderItemShape> =
  Effect.gen(function* (_) {

    // Rule 1: è‡ªåŠ¨è®¡ç®—
    const priceOrQty$ = $.flow.fromState(s => [s.quantity, s.unitPrice]);
    const autoCalculation = priceOrQty$.pipe(
      $.flow.run(
        Effect.gen(function* (_) {
          const current = yield* $.state.read;
          // å…³é”®ï¼šåªæœ‰åœ¨éæ‰‹åŠ¨æ¨¡å¼ä¸‹æ‰æ‰§è¡Œè‡ªåŠ¨è®¡ç®—
          if (!current.isTotalManual) {
            yield* $.state.mutate(draft => {
              draft.total = draft.quantity * draft.unitPrice;
            });
          }
        })
      )
    );

    // Rule 2: ç”¨æˆ·æ‰‹åŠ¨è¦†ç›–
    const manualSet$ = $.flow.fromAction(a => a._tag === 'setTotalManually');
    const userOverride = manualSet$.pipe(
      $.flow.run(action =>
        $.state.mutate(draft => {
          draft.total = action.payload;
          draft.isTotalManual = true; // å¤ºå–æ§åˆ¶æƒ
        })
      )
    );

    // Rule 3: ç³»ç»Ÿç­–ç•¥ (å¼ºåˆ¶çº¦æŸ)
    const total$ = $.flow.fromState(s => s.total);
    const systemPolicy = total$.pipe(
      $.flow.run(
        $.state.mutate(draft => {
          // æ— è®ºå¦‚ä½•ï¼Œæ€»ä»·ä¸èƒ½ä½äº 50
          if (draft.total < 50) {
            draft.total = 50;
          }
        })
      )
    );

    // Rule 4: é‡ç½®ä¸ºè‡ªåŠ¨è®¡ç®—
    const reset$ = $.flow.fromAction(a => a._tag === 'resetTotalToAuto');
    const resetToAuto = reset$.pipe(
      $.flow.run(
        $.state.mutate(draft => {
          draft.isTotalManual = false; // æ”¾å¼ƒæ§åˆ¶æƒ
          // ç«‹å³é‡æ–°è®¡ç®—ä¸€æ¬¡
          draft.total = draft.quantity * draft.unitPrice;
        })
      )
    );

    yield* Effect.all([autoCalculation, userOverride, systemPolicy, resetToAuto], { discard: true });
  })
);
```

## 3. Design Rationale

- **Explicit & Traceable**: é€»è¾‘çš„æ‰§è¡Œæ¡ä»¶ï¼ˆ`if (!isTotalManual)`ï¼‰æ˜¯ä»£ç çš„ä¸€éƒ¨åˆ†ï¼Œæ¸…æ™°å¯è§ï¼Œæ˜“äºè°ƒè¯•å’Œæ¨ç†ã€‚
- **State-Driven**: æ‰€æœ‰çš„è¡Œä¸ºéƒ½ç”±å½“å‰çš„çŠ¶æ€é©±åŠ¨ï¼Œç¬¦åˆçŠ¶æ€æœºçš„æ ¸å¿ƒæ€æƒ³ã€‚`isTotalManual` æ ‡å¿—æœ¬èº«å°±æ˜¯çŠ¶æ€çš„ä¸€éƒ¨åˆ†ã€‚
- **Robust**: è¿™ç§æ¨¡å¼çš„å¥å£®æ€§ç”±å¼€å‘è€…é€šè¿‡æ˜¾å¼çŠ¶æ€ç®¡ç†æ¥ä¿è¯ï¼Œä¸ä¾èµ–ä»»ä½•éšå¼çš„è¿è¡Œæ—¶è¡Œä¸ºã€‚
</file>

<file path="runtime-logix/core/examples/13-pattern-stream-orchestration.md">
# Pattern: Stream Orchestration & Flow Coordination (v3 Standard Paradigm)

> **Scenario**: ååŒä¿å­˜ (Auto Save vs Manual Save)  
> **Focus**: æµå¼ç¼–æ’ã€å¹¶å‘æ§åˆ¶ã€å£°æ˜å¼ç«æ€è§£å†³  
> **Note**: æœ¬æ–‡ç¤ºä¾‹å±•ç¤ºäº† v3 Effect-Native æ ‡å‡†èŒƒå¼ã€‚é€šè¿‡ç»„åˆ `flow.fromState` å’Œ `flow.fromAction`ï¼Œå¹¶ç»Ÿä¸€ä½¿ç”¨ `flow.runLatest`ï¼Œå¯ä»¥ä¼˜é›…åœ°ã€å£°æ˜å¼åœ°è§£å†³å¤šæºè§¦å‘åŒä¸€å‰¯ä½œç”¨çš„ç«æ€é—®é¢˜ã€‚å½“å‰ PoC ä¸­ï¼Œå®é™…ä»£ç åº”åœ¨å¯¹åº” Module ä¸Šé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ã€‚

## 1. The Challenge (ç—›ç‚¹)

åœ¨å¤æ‚è¡¨å•ä¸­ï¼Œâ€œè‡ªåŠ¨ä¿å­˜â€ä¸â€œæ‰‹åŠ¨ä¿å­˜â€çš„ååŒæ˜¯ä¸€ä¸ªç»å…¸éš¾é¢˜ï¼š
1.  **Auto Save**: å†…å®¹å˜åŒ–åï¼Œé˜²æŠ– 2 ç§’åè§¦å‘ã€‚
2.  **Manual Save**: ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ï¼Œç«‹å³è§¦å‘ã€‚
3.  **Coordination**: æ‰‹åŠ¨ä¿å­˜çš„ä¼˜å…ˆçº§æœ€é«˜ã€‚å½“æ‰‹åŠ¨ä¿å­˜è§¦å‘æ—¶ï¼Œä»»ä½•æ­£åœ¨è¿›è¡Œæˆ–ç­‰å¾…ä¸­çš„è‡ªåŠ¨ä¿å­˜éƒ½åº”è¢«å–æ¶ˆã€‚

## 2. The Solution: Unified Flow with `runLatest`

v3 èŒƒå¼é€šè¿‡å°†ä¸åŒçš„è§¦å‘æºï¼ˆè‡ªåŠ¨ä¿å­˜ã€æ‰‹åŠ¨ä¿å­˜ï¼‰æ±‡èšåˆ°åŒä¸€ä¸ª `runLatest` é€»è¾‘ä¸­æ¥è§£å†³æ­¤é—®é¢˜ã€‚`runLatest` ç¡®ä¿ä»»ä½•æ—¶å€™åªæœ‰ä¸€ä¸ªä¿å­˜ä»»åŠ¡åœ¨æ‰§è¡Œï¼Œæ–°ä»»åŠ¡ä¼šå–æ¶ˆæ—§ä»»åŠ¡ã€‚

### 2.1 Schema & Action Definition

```typescript
const EditorStateSchema = Schema.Struct({
  content: Schema.String,
  lastSavedAt: Schema.Number,
  isSaving: Schema.Boolean
});

const EditorActionSchema = Schema.Union(
  Schema.Struct({ _tag: Schema.Literal('manualSave') })
);

type EditorShape = Logix.ModuleShape<typeof EditorStateSchema, typeof EditorActionSchema>;
```

### 2.2 Logic Implementation

```typescript
// æ¦‚å¿µä¸Šï¼Œè¿™é‡Œçš„ `$Editor` è¡¨ç¤ºé’ˆå¯¹ EditorShape + EditorApi é¢„ç»‘å®šçš„ Bound APIã€‚
const saveLogic: Logic.Of<EditorShape, EditorApi> =
  Effect.gen(function* (_) {
    // 1. å®šä¹‰ç»Ÿä¸€çš„ä¿å­˜ Effect
    const saveEffect = (type: 'auto' | 'manual') =>
      Effect.gen(function* (_) {
        const api = yield* $Editor.services(EditorApi);
        const { content } = yield* $Editor.state.read;

        if (type === 'manual') {
          yield* $Editor.state.mutate(draft => { draft.isSaving = true; });
        }

        const result = yield* Effect.either(api.save(content));

        if (result._tag === 'Left') {
          if (type === 'manual') {
            yield* $Editor.state.mutate(draft => {
              draft.isSaving = false;
              // draft.error = ...
            });
          }
        } else {
          yield* $Editor.state.mutate(draft => {
            draft.isSaving = false;
            draft.lastSavedAt = Date.now();
          });
        }
      });

    // 2. å®šä¹‰è‡ªåŠ¨ä¿å­˜æµ
    const autoSave$ = $Editor.flow.fromState(s => s.content).pipe(
      $Editor.flow.debounce(2000),
      $Editor.flow.runLatest(saveEffect('auto'))
    );

    // 3. å®šä¹‰æ‰‹åŠ¨ä¿å­˜æµ
    const manualSave$ = $Editor.flow.fromAction(a => a._tag === 'manualSave').pipe(
      $Editor.flow.runLatest(saveEffect('manual'))
    );

    // 4. å¹¶è¡Œå¯åŠ¨ä¸¤ä¸ªæµ
    // å› ä¸ºå®ƒä»¬éƒ½ä½¿ç”¨ runLatestï¼ŒEffect è¿è¡Œæ—¶ä¼šè‡ªåŠ¨å¤„ç†å¹¶å‘ï¼š
    // ä»»ä½•ä¸€ä¸ªæµçš„æ–°äº‹ä»¶éƒ½ä¼šå–æ¶ˆå¦ä¸€ä¸ªæµæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ã€‚
    yield* Effect.all([autoSave$, manualSave$], { discard: true });
  })
);
```

## 3. Design Rationale

- **Declarative Concurrency**: `flow.runLatest` å£°æ˜å¼åœ°å®šä¹‰äº†â€œæœ€æ–°ä¼˜å…ˆâ€çš„å¹¶å‘ç­–ç•¥ã€‚å¼€å‘è€…æ— éœ€ç¼–å†™ä»»ä½•æ‰‹åŠ¨æ£€æŸ¥æˆ–å–æ¶ˆé€»è¾‘ï¼Œä»£ç æ„å›¾æ¸…æ™°ï¼Œè¡Œä¸ºå¯é¢„æµ‹ã€‚
- **Unified Logic**: å¤šä¸ªè§¦å‘æº (`fromState`, `fromAction`) éƒ½æ±‡èšåˆ°åŒä¸€ä¸ª `saveEffect` æ ¸å¿ƒé€»è¾‘ï¼Œæé«˜äº†ä»£ç çš„å†…èšæ€§å’Œå¤ç”¨æ€§ã€‚
- **Automatic Resource Management**: æ‰€æœ‰æµçš„ç”Ÿå‘½å‘¨æœŸï¼ˆåŒ…æ‹¬ `debounce` çš„å®šæ—¶å™¨ï¼‰éƒ½ç”± `Store` çš„ `Scope` è‡ªåŠ¨ç®¡ç†ï¼Œä»æ ¹æœ¬ä¸Šæœç»äº†å†…å­˜æ³„æ¼çš„é£é™©ã€‚
</file>

<file path="runtime-logix/core/00-manifesto.md">
# Logix Engine: æŒ‡å¯¼æ€æƒ³ä¸å®£è¨€

> **Status**: Definitive (v3 Final)
> **Date**: 2025-11-27

## 1. èƒŒæ™¯ä¸é•¿æœŸåˆ¤æ–­ (The Long View)

æˆ‘ä»¬æ­£å¤„äºè½¯ä»¶å·¥ç¨‹èŒƒå¼è½¬ç§»çš„å…³é”®èŠ‚ç‚¹ã€‚åŸºäºå¯¹æœªæ¥çš„é•¿æœŸåˆ¤æ–­ï¼Œæˆ‘ä»¬ç¡®ç«‹ä»¥ä¸‹åŸºæœ¬å‡è®¾ï¼š

1.  **AI æ™ºèƒ½çš„æŒ‡æ•°çº§å¢é•¿**: å¤§æ¨¡å‹ï¼ˆLLMï¼‰ç†è§£å¤æ‚æ„å›¾å’Œç”Ÿæˆä»£ç çš„èƒ½åŠ›å°†æŒç»­å¢å¼ºï¼Œè¿™ä¸å†æ˜¯ç“¶é¢ˆã€‚
2.  **ç“¶é¢ˆåœ¨äºâ€œç›®æ ‡ä»£ç â€çš„éæ ‡å‡†åŒ–**: ç›®å‰ AI è¾…åŠ©ç¼–ç¨‹çš„ç—›ç‚¹åœ¨äºï¼Œä¸šåŠ¡é€»è¾‘çš„å®ç°æ–¹å¼åƒäººåƒé¢ï¼ˆHooks ä¹±é£ã€çŠ¶æ€åˆ†æ•£ã€å‰¯ä½œç”¨éšæ™¦ï¼‰ã€‚è¿™ç§â€œéæ ‡å‡†åŒ–â€å¯¼è‡´ AI åªèƒ½æ¨¡ä»¿è¡¨è±¡ï¼Œéš¾ä»¥ç”Ÿæˆå¥å£®ã€å¯ç»´æŠ¤çš„å¤æ‚ä¸šåŠ¡é€»è¾‘ã€‚
3.  **å·¥å…·åŒ–ä¸å¹³å°åŒ–çš„å¿…ç„¶**: æœªæ¥çš„å¼€å‘æ¨¡å¼å¿…ç„¶æ˜¯â€œæ„å›¾ -> AI/å¹³å° -> æ ‡å‡†åŒ–è¿è¡Œæ—¶â€ã€‚æˆ‘ä»¬éœ€è¦å°½å¯èƒ½å°†ä¸šåŠ¡è§„èŒƒå›ºåŒ–ï¼Œäº¤ç»™æ¨¡å‹å’Œå¹³å°å»è‡ªåŠ¨åŒ–æ‰§è¡Œã€‚

## 2. æ ¸å¿ƒæ„¿æ™¯ (Core Vision)

**æ„å»ºä¸€å¥—â€œAI-Readyâ€çš„æ ‡å‡†åŒ–ä¸šåŠ¡é€»è¾‘å¼•æ“ (Logix Engine)ã€‚**

è¿™å¥—å†…æ ¸ä¸ä»…ä»…æ˜¯ä¸€ä¸ªçŠ¶æ€ç®¡ç†åº“ï¼Œæ›´æ˜¯ä¸€å¥—**ä¸šåŠ¡é€»è¾‘çš„æ ‡å‡†åŸè¯­ (Standard Primitives)**ã€‚å®ƒçš„ç›®æ ‡æ˜¯è®©ä»»ä½•éš¾åº¦çš„ä¸šåŠ¡éœ€æ±‚ï¼Œéƒ½æœ‰ä¸€å¥—**å”¯ä¸€çš„ã€æ ‡å‡†çš„ã€å£°æ˜å¼çš„**å†™æ³•ã€‚

### 2.1 æ¶ˆé™¤å†³ç­–æ¨¡ç³Šç‚¹ (Eliminating Ambiguity)

åœ¨ä¼ ç»Ÿå¼€å‘ä¸­ï¼Œå¼€å‘è€…é¢ä¸´æ— æ•°å¾®å°çš„å†³ç­–ï¼š
*   â€œè¿™ä¸ªè”åŠ¨æ˜¯å†™åœ¨ `onChange` é‡Œè¿˜æ˜¯ `useEffect` é‡Œï¼Ÿâ€
*   â€œè¿™ä¸ª API è¯·æ±‚æ€ä¹ˆé˜²æŠ–ï¼Ÿâ€
*   â€œè¿™ä¸ªçŠ¶æ€æ˜¯æ”¾åœ¨ Context é‡Œè¿˜æ˜¯ç»„ä»¶ State é‡Œï¼Ÿâ€

Logix å°†æ¶ˆé™¤è¿™äº›æ¨¡ç³Šç‚¹ã€‚é€šè¿‡æä¾›æ ‡å‡†åŒ–çš„ `logic` ç¼–æ’æœºåˆ¶ï¼Œæ‰€æœ‰çš„å‰¯ä½œç”¨ã€è”åŠ¨ã€çŠ¶æ€å˜æ›´éƒ½åªæœ‰ä¸€ç§å†™æ³•ã€‚**å½“å†™æ³•è¢«æ ‡å‡†åŒ–ï¼ŒAI å°±èƒ½ç²¾å‡†åœ°â€œå¡«ç©ºâ€ï¼Œè€Œä¸æ˜¯â€œçŒœæµ‹â€ã€‚**

### 2.2 AI å‹å¥½çš„åŒå‘æ˜ å°„ (AI-Friendly Bi-directional Mapping)

å› ä¸ºè¿è¡Œæ—¶æ˜¯é«˜åº¦ç»“æ„åŒ–å’Œå£°æ˜å¼çš„ï¼ˆåŸºäº Schema å’Œ Effect Streamï¼‰ï¼Œä»£ç æœ¬èº«å°±å˜æˆäº†æ„å›¾çš„ç›´æ¥æŠ•å½±ï¼š
*   **Intent -> Code**: AI å¯ä»¥è½»æ¾åœ°å°†è‡ªç„¶è¯­è¨€éœ€æ±‚è½¬åŒ–ä¸º Logix é…ç½®ï¼ˆSchema + Logic Rulesï¼‰ã€‚
*   **Code -> Intent**: å¹³å°å·¥å…·å¯ä»¥è½»æ¾åœ°è§£æ Logix ä»£ç ï¼Œåå‘è¿˜åŸå‡ºä¸šåŠ¡æµç¨‹å›¾æˆ–æ„å›¾çº¿ç¨¿ã€‚

è¿™ä½¿å¾— `Intent-Driven AI Coding` å¹³å°æˆä¸ºå¯èƒ½ã€‚

## 3. æˆ˜ç•¥å®šä½ (Strategic Positioning)

è¿™ä¸ª Logix å¼•æ“æ˜¯æ•´ä¸ªç”Ÿæ€ç³»ç»Ÿçš„**åŸºçŸ³ (Foundation)**ï¼š

*   **å‘ä¸‹**: å°è£… Effect-TS çš„å¼ºå¤§èƒ½åŠ›ï¼ˆå¹¶å‘ã€èµ„æºç®¡ç†ã€é”™è¯¯å¤„ç†ï¼‰ï¼Œå±è”½åº•å±‚å¤æ‚æ€§ã€‚
*   **å‘ä¸Š**: æ”¯æ’‘ `Form`ã€`Global State` ç­‰å…·ä½“é¢†åŸŸçš„åº”ç”¨ï¼Œä»¥åŠæœªæ¥çš„ `AI Coding Platform`ã€‚
*   **åœ¨å¹³å°è§†è§’ä¸‹**: ä½œä¸º `intent-driven-ai-coding` v3 æ¶æ„ä¸­çš„ä¸€ä¸ªå‰ç«¯ Runtime Targetï¼ˆ`logix-engine`ï¼‰ï¼Œä¸ Effect Flow Runtime ä¸€åŒæ‰¿æ¥ Logic Intent / Flow DSL çš„æ‰§è¡ŒèŒè´£ã€‚Intent/Flow/Runtime çš„æ¦‚å¿µæ¨¡å‹ä¸ Schema ä»¥ `docs/specs/intent-driven-ai-coding/v3`ï¼ˆå°¤å…¶æ˜¯ `02-intent-layers.md`ã€`03-assets-and-schemas.md` ä¸ `97-effect-runtime-and-flow-execution.md`ï¼‰ä¸ºäº‹å®æºï¼ŒLogix æ–‡æ¡£åªè¯´æ˜â€œå¦‚ä½•åœ¨å‰ç«¯è¿è¡Œæ—¶å®ç°è¿™äº›å¥‘çº¦â€ã€‚

## 4. å½“å‰æ‰¿è¯ºä¸çº¦æŸ (Commitments)

> è¿™äº›æ˜¯åç»­æ‰€æœ‰æŠ€æœ¯å†³ç­–çš„â€œç¡¬çº¦æŸâ€ï¼Œä¼˜å…ˆçº§é«˜äºå†å²ä»£ç å’ŒçŸ­æœŸæˆæœ¬ã€‚

1.  **v0 Form è§†ä¸º PoCï¼Œå¯ä»¥å®Œå…¨ä¸¢å¼ƒ**  
    ç°æœ‰ `packages/react/src/features/form` ä»…ä½œä¸ºæ—©æœŸéªŒè¯ï¼Œä¸å†ç»§ç»­æ¼”è¿›ï¼Œä¹Ÿä¸éœ€è¦å…¼å®¹æˆ–è¿ç§»ï¼›æ–°ä¸€ä»£ Form å¿…é¡»å»ºç«‹åœ¨ Logix Engine ä¹‹ä¸Šã€‚
2.  **ä» Logix èµ·æ­¥ï¼Œä¸è®¡é‡æ„æˆæœ¬**
    æœªæ¥å·¥ä½œé»˜è®¤ä» `@logix/core` v1 å¼€å§‹è®¾è®¡ï¼Œä¸å†ä»¥"ç°æœ‰å®ç°"ä¸ºçº¦æŸæ¡ä»¶ï¼›ä¼˜å…ˆä¿è¯æ¨¡å‹æ¸…æ™°ã€å¯æ¨ç†ã€å¯æ¼”è¿›ï¼Œè€Œä¸æ˜¯èŠ‚çœå®ç°æˆæœ¬ã€‚
3.  **ç¦æ­¢åœ¨ UI ä¸­ç¼–æ’ä¸šåŠ¡å‰¯ä½œç”¨**  
    ä¸šåŠ¡çº§è”åŠ¨ã€å¼‚æ­¥è°ƒç”¨ã€é˜²æŠ–/ç«æ€å¤„ç†ç­‰ï¼Œä¸€å¾‹é€šè¿‡ Logix çš„ `Logic` å£°æ˜ï¼Œä¸å…è®¸å†åœ¨ React/Vue ç»„ä»¶é‡Œç”¨ `useEffect/useMemo` ç¼–æ’ä¸šåŠ¡é€»è¾‘ï¼›UI å±‚åªè¯» Storeï¼Œåªæ´¾å‘æ ‡å‡†åŒ– Actionã€‚
4.  **å”¯ä¸€çš„çŠ¶æ€æœºæ¥æº**  
    Logix æ˜¯å”¯ä¸€çš„çŠ¶æ€ä¸é€»è¾‘è¿è¡Œæ—¶ï¼Œåç»­ä¸å¾—åœ¨ Form æˆ– React é€‚é…å±‚å†å‘æ˜ç¬¬äºŒå¥—çŠ¶æ€æœºæˆ–å‰¯ä½œç”¨ç³»ç»Ÿï¼ˆä¾‹å¦‚ç›´æ¥ä¾èµ– Zustand/è‡ªå†™ Hooks ç»´æŠ¤æ ¸å¿ƒä¸šåŠ¡çŠ¶æ€ï¼‰ã€‚
5.  **è¡¨å•åªæ˜¯ç¬¬ä¸€ä¸ªé¢†åŸŸéªŒè¯**
    æ–° Form åº“ï¼ˆ`@logix/form`ï¼‰æ˜ç¡®è¢«è§†ä¸º Logix çš„ä¸€ä¸ª Domain å®ä¾‹ï¼Œç”¨æ¥åå‘éªŒè¯ Logix API çš„åˆç†æ€§ï¼Œè€Œä¸æ˜¯ä¸ Logix å¹¶è¡Œæ¼”è¿›çš„å¦ä¸€å¥—æ–¹æ¡ˆã€‚

## 5. æ ¸å¿ƒåŸåˆ™ (Core Principles)

1.  **Effect-First**: æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘æœ¬è´¨ä¸Šéƒ½æ˜¯å‰¯ä½œç”¨ï¼ˆEffectï¼‰ã€‚æˆ‘ä»¬ä½¿ç”¨ Effect-TS ä½œä¸ºåº•å±‚çš„æ‰§è¡Œå¼•æ“ï¼Œç¡®ä¿é€»è¾‘çš„çº¯ç²¹æ€§å’Œå¯æµ‹è¯•æ€§ã€‚
2.  **Declarative Over Imperative**: ä¸šåŠ¡é€»è¾‘åº”è¯¥æ˜¯è¢«â€œå£°æ˜â€å‡ºæ¥çš„ï¼ˆé…ç½®è§„åˆ™ï¼‰ï¼Œè€Œä¸æ˜¯è¢«â€œç¼–å†™â€å‡ºæ¥çš„ï¼ˆè¿‡ç¨‹å¼ä»£ç ï¼‰ã€‚
3.  **Runtime Agnostic**: å†…æ ¸å¿…é¡»ä¸ UI æ¡†æ¶ï¼ˆReact/Vueï¼‰è§£è€¦ï¼Œå®ƒåªå…³æ³¨æ•°æ®æµå’Œé€»è¾‘ç¼–æ’ã€‚è¿™ä¿è¯äº†å®ƒèƒ½é€‚åº”æœªæ¥çš„ä»»ä½•æŠ€æœ¯æ ˆå˜åŒ–ã€‚

---

**æ€»ç»“**: æˆ‘ä»¬ä¸æ˜¯åœ¨é€ åˆä¸€ä¸ªè½®å­ï¼Œæˆ‘ä»¬æ˜¯åœ¨ä¸º AI æ—¶ä»£çš„è½¯ä»¶å·¥ç¨‹åˆ¶å®š**æ ‡å‡†**ã€‚ä¸€æ—¦è¿™ä¸ªå†…æ ¸å»ºæˆï¼Œä¸šåŠ¡å¼€å‘å°†ä¸å†æ˜¯å †ç Œä»£ç ï¼Œè€Œæ˜¯ç¼–æ’æ„å›¾ã€‚

## 6. v3 æœ€ç»ˆå½¢æ€çš„å…³é”®å†³ç­– (Final Design Decisions)

ä¸ºäº†è®© v3 æˆä¸º Logix Engine çš„å®Œæ•´ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯â€œé€šå¾€ v4 çš„è¿‡æ¸¡ç‰ˆâ€ï¼Œæœ¬èŠ‚æ˜ç¡®ä¸‰æ¡è¿è¡Œæ—¶å±‚é¢çš„è®¾è®¡å–èˆï¼Œè¿™äº›å–èˆåœ¨ v3 èµ·è§†ä¸º**å®šç¨¿å…±è¯†**ã€‚

### 6.1 è¿è¡Œæ—¶ç¯å¢ƒï¼šæ‰å¹³åˆå¹¶ï¼Œä¸åšå¼ºéš”ç¦»

- **å†³ç­–**ï¼š  
  v3 è¿è¡Œæ—¶é‡‡ç”¨ **Env æ‰å¹³åˆå¹¶ (Flat Environment)** ç­–ç•¥ï¼š  
  æ‰€æœ‰ Module çš„ `infra` / `providers` æ‰€äº§ç”Ÿçš„ Tag æœ€ç»ˆæ±‡èšåœ¨ä¸€ä¸ªç»Ÿä¸€çš„ Effect Context ä¸­ã€‚

- **ä¸åšçš„ç‰¹æ€§**ï¼š  
  ä¸æä¾›åŸºäº `exports` çš„è¿è¡Œæ—¶ Env è£å‰ªæœºåˆ¶ã€‚  
  `ModuleDef.exports` ä»…ç”¨äºç±»å‹ç³»ç»Ÿã€Lint ä¸å¹³å°é™æ€æ£€æŸ¥ï¼Œä¸å½±å“ Runtime è¡Œä¸ºã€‚

- **ç†ç”±**ï¼š  
  - Effect Context çš„è®¾è®¡æœ¬è´¨æ˜¯â€œå¯æ‰©å±•çš„æœåŠ¡æ± â€ï¼Œåœ¨å…¶ä¸Šå¼ºè¡Œæ„é€ å¤šçº§éš”ç¦»ä¼šæ˜¾è‘—å¢åŠ  Scope / Layer æŠ•å½±çš„å¤æ‚åº¦ï¼›  
  - å¼ºéš”ç¦»è®©è°ƒè¯•å˜å¾—å›°éš¾ï¼ˆå¼€å‘è€…éš¾ä»¥åŒºåˆ†â€œTag æœªæä¾›â€ä¸â€œè¢«éš”ç¦»é®è”½â€ï¼‰ï¼›  
  - çœŸæ­£çš„å°è£…ä¸æ²»ç†æ›´é€‚åˆé€šè¿‡ **Module æ‹“æ‰‘ + exports + å¹³å°æ£€æŸ¥** æ¥å®Œæˆï¼Œè€Œä¸æ˜¯ Runtime é­”æ³•ã€‚

### 6.2 ä¸­é—´ä»¶ä¸ AOPï¼šæ˜¾å¼ç»„åˆï¼Œä¸åšè‡ªåŠ¨æ³¨å…¥

- **å†³ç­–**ï¼š  
  v3 ä¸­æ‰€æœ‰ AOP èƒ½åŠ›ï¼ˆæ—¥å¿—ã€é‰´æƒã€å®¡è®¡ç­‰ï¼‰ä¸€å¾‹é€šè¿‡ **æ˜¾å¼ä»£ç ** è¡¨è¾¾ï¼š  
  - ä½¿ç”¨ `Logic.compose(...)` / `secure(effect, meta)` ç­‰æ¨¡å¼åœ¨ Logic å†…éƒ¨ç»„åˆä¸­é—´ä»¶ï¼›  
  - `ModuleDef.middlewares` ä»…ä½œä¸ºå¹³å°/å‡ºç å™¨çš„é…ç½®æ¥æºï¼ŒRuntime ä¸è¯»å–æ›´ä¸ä¼šè‡ªåŠ¨æ³¨å…¥ã€‚

- **ä¸åšçš„ç‰¹æ€§**ï¼š  
  ä¸åœ¨ Runtime å†…ç»´æŠ¤å…¨å±€ Middleware Registryï¼Œä¹Ÿä¸åœ¨ Logic æ„é€ è¿‡ç¨‹ä¸­æ ¹æ® Module é…ç½®â€œè‡ªåŠ¨å¥—ä¸Šâ€ä¸­é—´ä»¶ã€‚

- **ç†ç”±**ï¼š  
  - ä¿ç•™â€œä»£ç å³äº‹å®â€ï¼šä»»ä½•æ‹¦æˆª/æ¨ªåˆ‡è¡Œä¸ºéƒ½èƒ½åœ¨æºç ä¸­è¢«çœ‹è§ä¸ grep åˆ°ï¼›  
  - StackTrace æ¸…æ™°ï¼Œè°ƒè¯•æ—¶å¯ä»¥ç›´æ¥åœ¨ä¸­é—´ä»¶å‡½æ•°å†…éƒ¨æ‰“æ–­ç‚¹ï¼›  
  - å°†å¤æ‚åº¦ç•™åœ¨ Codegen / VSCode æ’ä»¶ç­‰å·¥å…·é“¾ä¾§ï¼Œè€Œä¸æ˜¯æ±¡æŸ“ Runtime å†…æ ¸ã€‚

### 6.3 æ¨¡å—åŠ è½½ï¼šé™æ€ Module æ ‘ï¼ŒLazy å½’å±é›†æˆ/éƒ¨ç½²å±‚

- **å†³ç­–**ï¼š  
  v3 çš„ Module ä½“ç³»ä»…æ”¯æŒ **é™æ€ ModuleDef æ ‘**ï¼š  
  - `imports` åªæ¥å—é™æ€çš„ `ModuleDef` å¼•ç”¨ï¼›  
  - ä¸å¼•å…¥ `() => Promise<ModuleDef>` æˆ– `Effect<ModuleDef>` å½¢å¼çš„ Runtime çº§ Lazy æ¨¡å—ã€‚

- **ä¸åšçš„ç‰¹æ€§**ï¼š  
  ä¸åœ¨ Runtime å±‚å®ç°â€œå¼‚æ­¥ Module åŠ è½½ / æŒ‰éœ€æ„å»º Layerâ€çš„æœºåˆ¶ã€‚

- **ç†ç”±**ï¼š  
  - æ¨¡å—æ‡’åŠ è½½æ›´é€‚åˆä½œä¸º **è·¯ç”±/å­åº”ç”¨/æ‰“åŒ…å·¥å…·** çš„èŒè´£ï¼ˆä¾‹å¦‚æŒ‰è·¯ç”±åˆ†åŒ…ã€å¤š AppRuntimeï¼‰ï¼›  
  - åœ¨ ModuleDef å†…æ··å…¥å¼‚æ­¥åŠ è½½ï¼Œä¼šå¼•å…¥å¤æ‚çš„â€œåŠåˆå§‹åŒ–â€çŠ¶æ€æœºï¼ˆåŠ è½½ä¸­ã€å¤±è´¥ã€é‡è¯•ï¼‰ï¼Œç ´å Runtime ç®€æ´æ€§ï¼›  
  - æ ¸å¿ƒæ¶æ„çš„ä¸»è¦ä»»åŠ¡æ˜¯å®šä¹‰æ¸…æ™°çš„ App / Module / Store æ‹“æ‰‘ä¸æ‰§è¡Œå¥‘çº¦ï¼Œè€Œä¸æ˜¯æ‰¿æ¥ bundler çº§åˆ«çš„ä¼˜åŒ–ã€‚

---

ä¸Šè¿°ä¸‰æ¡å†³ç­–å…±åŒå®šä¹‰äº† v3 çš„è¾¹ç•Œï¼š  
**Logix åœ¨ v3 ä¸­å°±æ˜¯â€œå®Œæ•´ä½“â€çš„ Engine**ï¼Œåç»­æ¼”è¿›ï¼ˆæ— è®ºæ˜¯å¹³å° UIã€å·¥å…·é“¾ï¼Œè¿˜æ˜¯å¤š Runtime ç»„åˆï¼‰éƒ½åº”åœ¨ä¿æŒè¿™äº›æ ¹æœ¬å–èˆä¸å˜çš„å‰æä¸‹å±•å¼€ï¼Œè€Œä¸æ˜¯å†å°è¯•ä» Runtime è¯­ä¹‰å±‚é¢â€œé‡å†™ä¸€ç‰ˆ v4â€ã€‚***
</file>

<file path="runtime-logix/core/01-architecture.md">
# æ¶æ„æ€»è§ˆ (Architecture Overview)

> **Status**: Definitive (v3 Effect-Native)
> **Date**: 2025-11-24
> **Audience**: åº”ç”¨/ä¸šåŠ¡å¼€å‘è€…ã€åº“ä½œè€…ä¸æ¶æ„å¸ˆçš„å…±åŒâ€œåœ°å›¾â€ï¼Œä»æ¦‚å¿µå±‚ä¿¯è§† Logix å¼•æ“ã€‚
> **Note**: æœ¬æ–‡åŸºäº v3 Effect-Native èŒƒå¼ï¼Œæè¿°äº†ç”± **Store / Logic / Flow / Control** å››å¤§è¿è¡Œæ—¶åŸè¯­æ„æˆçš„æ ¸å¿ƒæ¶æ„ã€‚`Pattern` ä½œä¸ºä¸€ç§ `(input) => Effect` çš„å‡½æ•°å°è£…é£æ ¼ï¼Œåœ¨å¹³å°å±‚è¢«è§†ä¸ºå¯å¤ç”¨çš„èµ„äº§ã€‚æ‰€æœ‰æœ¯è¯­å’Œç±»å‹å®šä¹‰ä»¥ `docs/specs/intent-driven-ai-coding/v3/effect-poc` ä¸­çš„ PoC ä¸ºæœ€æ–°äº‹å®æºã€‚

## 1. æ€»ä½“æ¶æ„åˆ†å±‚

Logix v3 é‡‡ç”¨ **Effect-Native** æ¶æ„ï¼Œæ„å»ºäº†ä¸€ä¸ªç”± **Store**, **Logic**, **Flow**, **Control** å››å¤§è¿è¡Œæ—¶åŸè¯­ç»„æˆçš„è‡ªæ´½ä¸šåŠ¡ä¸–ç•Œï¼›Pattern ä½œä¸ºèµ„äº§æ¦‚å¿µå­˜åœ¨äºå¹³å°å±‚ï¼Œç”¨äºåŒ…è£… pattern-style çš„ `(input) => Effect` é•¿é€»è¾‘ã€‚

```mermaid
graph TD
Store[Runtime (State,Action)] -->|Provides| Flow[Flow Sources]
    Store -->|Provides| StateApi[Logic.state/actions]

    Logic[User Logic (Effect)] -->|Consumes| StateApi
    Logic -->|Consumes| Flow
    Logic -->|Consumes| Control[Control Ops]
    Logic -->|Consumes| Services[Effect.Services & Config]

    Pattern[Pattern-style Logic (input => Effect)] -->|Consumes| Logic.Env (Store + Services)
    Pattern -->|Optional| PatternAsset[Pattern Asset (id/config)]
```

## 2. Logix æ ¸å¿ƒåŸè¯­ (Core Primitives)

### 2.1 å…ƒç´ å¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | Store (å®¹å™¨) | Logic (ç¨‹åº) | Flow (æµ) | Control (ç»“æ„) |
| :--- | :--- | :--- | :--- | :--- |
| **è¯­ä¹‰** | **World**<br>è¿è¡Œç¯å¢ƒ | **Behavior**<br>ä¸šåŠ¡è§„åˆ™ä¸å‰¯ä½œç”¨ | **Current**<br>è§¦å‘ä¸æ—¶é—´ | **Structure**<br>åˆ†æ”¯/é”™è¯¯/å¹¶å‘å½¢æ€ |
| **èƒ½åŠ›** | çŠ¶æ€æŒæœ‰<br>ä¾èµ–æ³¨å…¥<br>ç”Ÿå‘½å‘¨æœŸ | ä¿®æ”¹çŠ¶æ€<br>è°ƒç”¨æœåŠ¡<br>ç»„åˆ Flow/Control | è¿‡æ»¤/é˜²æŠ–<br>å¹¶å‘æ§åˆ¶<br>æ—¶åºç¼–æ’ | åˆ†æ”¯é€»è¾‘<br>é”™è¯¯è¾¹ç•Œ<br>å¹¶è¡Œèšåˆ |
| **å¹³å°æ”¯æ’‘** | **æ¶æ„è§†å›¾**<br>å±•ç¤ºåº”ç”¨ç»“æ„ | **è°ƒè¯•è§†å›¾**<br>å±•ç¤ºçŠ¶æ€/Env å˜æ›´ | **æµç¨‹è§†å›¾**<br>å±•ç¤ºé€»è¾‘è¿çº¿ | **ç»“æ„è§†å›¾**<br>å±•ç¤ºåˆ†æ”¯/é”™è¯¯åŸŸ/å¹¶å‘ç»“æ„ |
| **æœ¬è´¨** | é¢†åŸŸæ¨¡å—çš„è¿è¡Œæ—¶å®¹å™¨ + `Layer` | `Effect<A,E,R>`ï¼ˆçº¦å®š Env = `Logic.Env<Sh,R>`ï¼‰ | `Stream<T>` + `Flow.Api` | `Effect` ç»„åˆå™¨é›†åˆ (`Control.Api`) |

### 2.2 Pattern åœ¨æ¶æ„ä¸­çš„ä½ç½®

*   **æ²¡æœ‰ Store**: çŠ¶æ€æ— å¤„å®‰æ”¾ï¼Œç”Ÿå‘½å‘¨æœŸæ— æ³•ç®¡ç† (Memory Leak)ã€‚
*   **æ²¡æœ‰ Logic**: æ— æ³•å®‰å…¨åœ°ä¿®æ”¹çŠ¶æ€ï¼Œæ— æ³•è¿½è¸ªå› æœé“¾ã€‚
*   **æ²¡æœ‰ Flow**: æ— æ³•å¤„ç†å¤æ‚çš„å¹¶å‘ç«æ€ (Race Condition)ã€‚
*   **æ²¡æœ‰ Control**: æ— æ³•è¡¨è¾¾æ¸…æ™°çš„åˆ†æ”¯/é”™è¯¯/å¹¶å‘ç»“æ„ï¼Œè°ƒè¯•å’Œå›¾ç åŒæ­¥éƒ½å›°éš¾ã€‚

Pattern åˆ™ä½œä¸º**èµ„äº§çº§æ¦‚å¿µ**å­˜åœ¨ï¼šå½“æŸä¸ª pattern-style `(input) => Effect` åœ¨å¹³å°ä¾§è¢«èµ‹äºˆ id/version/configSchema ç­‰å…ƒä¿¡æ¯æ—¶ï¼Œå®ƒå°±æˆä¸ºå¯é…ç½®ã€å¯æ‹–æ‹½çš„ PatternAssetï¼›ä½†åœ¨ runtime-core ä¸­ï¼Œå®ƒå§‹ç»ˆåªæ˜¯æ™®é€šçš„ Effect å‡½æ•°ã€‚

### 2.3 æ ¸å¿ƒè¿è¡Œæœºåˆ¶ (Runtime Mechanism)

Logix v3 çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ç§åŸºäº Effect-TS `Context` / `Tag` çš„ã€Œä¸Šä¸‹æ–‡éšå½¢ä¼ æ€ã€ï¼Œ
ä½†åœ¨å½“å‰ PoC ä¸­ï¼Œè¿™ä¸€èƒ½åŠ›**é€šè¿‡ `Logix.Module` + `Module.logic(($)=>Effect.gen(...))` + Bound API `$` è½åœ°**ã€‚

- `Logix.Module('Id', { state, actions })` å®šä¹‰é¢†åŸŸæ¨¡å—çš„ Schema å½¢çŠ¶ï¼›
- `Module.logic(($)=>Effect.gen(...))` ä¸ºè¯¥æ¨¡å—æŒ‚è½½ Logic ç¨‹åºï¼Œå¹¶åœ¨å›è°ƒå‚æ•°ä¸­æ³¨å…¥é¢„ç»‘å®šçš„ Bound API `$`ï¼›
- `Module.live(initial, ...logics)` åœ¨å†…éƒ¨ä¼šåˆ›å»ºå¯¹åº”çš„è¿è¡Œæ—¶å®¹å™¨ï¼ˆModuleRuntimeï¼‰ï¼Œå¹¶åœ¨å…¶ Scope ä¸­å¯åŠ¨æ‰€æœ‰ Logic ç¨‹åºã€‚

æ•ˆæœæ˜¯ï¼š

- é€»è¾‘å¯ä»¥åœ¨ç‰©ç†ä¸Šæ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶ / æ¨¡å—ï¼Œä½†åœ¨å®ç°å±‚é€šè¿‡ `Module.logic(($)=>...)` æ˜¾å¼æŒ‚è½½åˆ°åŒä¸€ä¸ª Module ä¸Šï¼Œä»è€Œå…±äº«åŒä¸€æ£µ State ä¸åŒä¸€æ¡ actions$ / changes$ æµï¼›
- è‹¥å¤šä¸ªé€»è¾‘å…³æ³¨çš„æ˜¯å®Œå…¨ä¸åŒçš„é¢†åŸŸï¼ˆShape ä¸åŒï¼‰ï¼Œåˆ™æ¨èæ‹†æˆå¤šä¸ª Moduleï¼Œé€šè¿‡ L2 IntentRuleï¼ˆä¾‹å¦‚ `$.use(OtherModule)` + Fluent DSL å°†æº Module çš„ `changes / actions` æ˜ å°„ä¸ºç›®æ ‡ Module çš„ `dispatch`ï¼‰æˆ–åè°ƒ Pattern åœ¨ L2 å±‚è¿›è¡Œè·¨ Module åä½œã€‚

> è¯´æ˜ï¼šæ—©æœŸè‰æ¡ˆä¸­æ›¾æ„æƒ³è¿‡åŸºäº `Logic.RuntimeTag` çš„ Env-First Bound API å·¥å‚ï¼Œç”¨äºä» `Logic.Env<Sh,R>` ä¸­â€œéšå¼â€è·å– Runtime å¹¶æ„é€  `$`ã€‚è¯¥è®¾æƒ³ç›®å‰ä»…ä¿ç•™åœ¨ drafts ä¸­ï¼Œå½“å‰ PoC çš„è¿è¡Œæ—¶å¥‘çº¦ä¸€å¾‹ä»¥ `Module.logic(($)=>...)` ä¸ `BoundApi` ä¸ºå‡†ã€‚

## 3. ä»“åº“ç»“æ„è§„åˆ’

```text
packages/
  logix/                # æ ¸å¿ƒå¼•æ“
    src/
      store.ts          # çŠ¶æ€å®¹å™¨ä¸è¿è¡Œæ—¶èƒ½åŠ›å®šä¹‰ï¼ˆå†…éƒ¨å®ç°ç»†èŠ‚ï¼‰
      logic.ts          # Logic.Env / Logic.Of / Bound API $
      flow.ts           # Flow.Env / Flow.Api
      flow.ts           # Flow.Api
  form/                 # è¡¨å•é¢†åŸŸåŒ…
  react/                # React é€‚é…åŒ…
```
</file>

<file path="runtime-logix/core/02-module-and-logic-api.md">
# Logix.Module / Logic / Live / `$` API æ€»è§ˆ

> **Status**: v3.1 Canonical (Module-First)
> **Scope**: Logix Engine â€” Public API Surface (Concept & Type Level)
> **Audience**: ä»¥åº”ç”¨/ä¸šåŠ¡å¼€å‘è€…ä¸ºä¸»ï¼Œåº“ä½œè€…ä¸æ¶æ„å¸ˆåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å°è£…ã€‚

æœ¬ç¯‡ä½œä¸º v3.1 ä¹‹åçš„ **Module-First ç¼–ç¨‹æ¨¡å‹æ€»è§ˆä¸å•ä¸€äº‹å®æº**ï¼Œé›†ä¸­è¯´æ˜ï¼š

- å¦‚ä½•ä½¿ç”¨ `Logix.Module` å®šä¹‰é¢†åŸŸæ¨¡å—ï¼ˆModuleï¼Œçº¯å®šä¹‰ï¼Œä¸å«å®ä¾‹çŠ¶æ€ï¼‰ï¼›
- å¦‚ä½•åœ¨ Module ä¸Šé€šè¿‡ `Module.logic(($)=>Effect)` ç¼–å†™é€»è¾‘ç¨‹åºï¼›
- å¦‚ä½•ç”¨ `Module.live(initial, ...logics)` ç”Ÿæˆå¯æ³¨å…¥çš„è¿è¡Œæ—¶ Layerï¼›
- å¦‚ä½•ç”¨ `Module.make({ initial, logics })` ç”Ÿæˆå¯å¤ç”¨çš„ **ModuleImpl è“å›¾**ï¼Œå†é€šè¿‡ `withLayer/withLayers` ä¸ `Logix.provide(ModuleImpl)` æ‹¼è£…åˆ° AppRuntime ä¸­ï¼›
- Bound API `$` åœ¨ä¸šåŠ¡ä»£ç ä¸­çš„æ¨èç”¨æ³•ï¼ˆç‰¹åˆ«æ˜¯ `$.on*` äº‹ä»¶è®¢é˜…ï¼‰ã€‚

è¯¦ç»†è¡Œä¸ºè¯­ä¹‰ä»ä»¥ï¼š

- `core/03-logic-and-flow.md`ï¼ˆLogic / Flow / Control / Bound API `$`ï¼‰
- `core/05-runtime-implementation.md` ä¸ `impl/*`ï¼ˆè¿è¡Œæ—¶/Scope å®ç°ç»†èŠ‚ï¼Œä»…æ¶æ„å¸ˆ/å¼•æ“å®ç°è€…å…³æ³¨ï¼‰

ä¸ºå‡†ï¼Œæœ¬æ–‡ä»¶åªåš **ä¸šåŠ¡å‘ API è§†è§’çš„æ€»è§ˆä¸æ±‡æ€»**ã€‚

### 0.0 API åˆ†å±‚é€Ÿè§ˆ

| å±‚çº§ | é¢å‘è§’è‰² | ä¸»è¦å…¥å£ | è¯´æ˜ |
| :--- | :--- | :--- | :--- |
| åº”ç”¨/ä¸šåŠ¡å¼€å‘è€… | Feature/ä¸šåŠ¡å·¥ç¨‹å¸ˆ | `Logix.Module` / `Module.logic(($)=>...)` / `Module.live(...)` / Bound API `$`ï¼ˆ`$.state / $.actions / $.on* / $.use`ï¼‰ | æ—¥å¸¸å¼€å‘åªéœ€è¿™äº›å…¥å£å³å¯å®Œæˆç»å¤§éƒ¨åˆ†å·¥ä½œ |
| ç»„ä»¶ / é¡µé¢ä½œè€… | UI & äº¤äº’å·¥ç¨‹å¸ˆ | `Module.make({ initial, logics })` / `ModuleImpl.withLayer` / `Logix.provide(ModuleImpl)` / React `useModule(impl)` | æŠŠâ€œæ¨¡å— + åˆå§‹çŠ¶æ€ + é€»è¾‘ + ä¾èµ–æ³¨å…¥â€æ‰“åŒ…æˆå¯å¤ç”¨è“å›¾ï¼Œåœ¨ AppRuntime / React ä¸­å¤ç”¨ |
| åº“ä½œè€… / Pattern ä½œè€… | å¤ç”¨é€»è¾‘ã€é¢†åŸŸåº“ä½œè€… | `Flow.Api` / `Control.Api` / `Logic.of` / `$.flow.*` / Pattern çº¦å®š | ç”¨äºå°è£…å¯å¤ç”¨é•¿é€»è¾‘ã€é¢†åŸŸ Pattern ä¸ L3 Helper |
| æ¶æ„å¸ˆ / å¼•æ“å®ç°è€… | å¹³å°/Runtime å®ç° | è¿è¡Œæ—¶å®¹å™¨å®ç°ã€Module/Runtime ç»„åˆã€Scope ç®¡ç†ï¼ˆè§ `core/05-runtime-implementation.md`ã€`impl/*`ï¼‰ | è´Ÿè´£å†…éƒ¨è¿è¡Œæ—¶å®ç°ï¼Œä¸šåŠ¡ä»£ç ä¸ç›´æ¥ä¾èµ– |

---

## 0. å¿«é€Ÿæ€»è§ˆï¼ˆTrinity + `$`ï¼‰

- `Logix.Module(id, { state, actions })`
  - å®šä¹‰ã€Œé¢†åŸŸæ¨¡å—ã€ï¼Œåªè´Ÿè´£ **èº«ä»½ + å½¢çŠ¶**ï¼›
  - è‡ªèº«æ˜¯ä¸€ä¸ª Tagï¼Œå¯è¢« `$.use(Module)` æ¶ˆè´¹ï¼›
  - ä¸åŒ…å«ä»»ä½•è¿è¡Œæ—¶å®ä¾‹æˆ–çŠ¶æ€ã€‚
- `Module.logic(($) => Effect.gen(...))`
  - åœ¨è¯¥ Module ä¸Šç¼–å†™ä¸€æ®µ Logic ç¨‹åºï¼›
  - è¿”å›å€¼æ˜¯ä¸€ä¸ªå¯ç»„åˆçš„ Logic å•å…ƒï¼ˆLogic.Ofï¼‰ï¼Œå¯ä»¥åƒæ™®é€šå€¼ä¸€æ ·ä¼ é€’ä¸å¤ç”¨ã€‚
- `Module.live(initialState, ...logics)`
  - å°† Module å®šä¹‰ + åˆå§‹ State + ä¸€ç»„ Logic ç¨‹åºç»„åˆæˆä¸€ä¸ª Live Layerï¼›
  - æ¯æ¬¡è°ƒç”¨éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ Layerï¼Œå¯åœ¨ä¸åŒ Runtime/Scope ä¸‹å¤šæ¬¡æ³¨å…¥ï¼›
  - é€‚åˆâ€œä¸€æ¬¡æ€§æ‹¼è£… + ç«‹å³æ³¨å…¥â€çš„åœºæ™¯ï¼ˆå¦‚ CLI è„šæœ¬ã€å•æ¨¡å— PoCï¼‰ã€‚
- `Module.make({ initial, logics })`
  - åœ¨ `Module.live` ä¹‹ä¸Šï¼Œè¿›ä¸€æ­¥å°è£…å‡ºä¸€ä¸ª **ModuleImpl è“å›¾**ï¼š
    - è®°å½•è¯¥ Module çš„åˆå§‹ State ä¸ Logic é›†åˆï¼›
    - æš´éœ² `impl.layer`ï¼ˆ`Layer<ModuleRuntime, never, any>`ï¼‰å’Œ `impl.module`ï¼›
    - æ”¯æŒé€šè¿‡ `impl.withLayer(...)` / `impl.withLayers(...)` æ³¨å…¥é¢å¤– Envï¼ˆService / å¹³å°èƒ½åŠ›ç­‰ï¼‰ï¼›
  - å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š
    - React ä¸­é€šè¿‡ `useModule(impl)` ç›´æ¥æ¶ˆè´¹é…ç½®å¥½çš„æ¨¡å—å®ç°ï¼›
    - AppRuntime ä¸­ç”¨ `Logix.provide(impl)` æŠŠè¯¥å®ç°æŒ‚åˆ° `Logix.app` çš„ `modules` åˆ—è¡¨é‡Œã€‚
- `$`ï¼ˆBound APIï¼‰
  - ä¸šåŠ¡å¼€å‘å‡ ä¹åªéœ€è¦è®°ä½çš„å”¯ä¸€å…¥å£ï¼›
  - æä¾› `$.state / $.actions / $.flow / $.on* / $.use / $.lifecycle` ç­‰èƒ½åŠ›ï¼›
  - åŒæ—¶æ˜¯ IntentRule Parser çš„é™æ€é”šç‚¹ã€‚

---

## 1. `Logix.Module`ï¼šé¢†åŸŸæ¨¡å—å®šä¹‰

åœ¨ä»£ç å±‚ï¼Œä¸€ä¸ªé¢†åŸŸæ¨¡å—ç»Ÿä¸€ç”± `Logix.Module` è¡¨ç¤ºï¼š

```ts
import { Schema } from 'effect';
import { Logix } from '@logix/core';

export const CounterModule = Logix.Module('Counter', {
  state: Schema.Struct({
    count: Schema.Number,
  }),
  actions: {
    inc: Schema.Void,
    dec: Schema.Void,
  },
});
```

è¯­ä¹‰ï¼š

- `id: string`ï¼šé¢†åŸŸæ¨¡å—çš„å…¨å±€ Idï¼Œç”¨äº Universe/Galaxy æ‹“æ‰‘å’Œå¹³å°è¯†åˆ«ï¼›
- `state` / `actions`ï¼šEffect.Schema å½¢å¼çš„ State / Action å½¢çŠ¶ï¼›
- `CounterModule` æœ¬èº«åŒæ—¶æ˜¯ï¼š
  - Module å®šä¹‰ï¼ˆIntent è§†è§’ï¼šé¢†åŸŸèµ„äº§ï¼‰ï¼›
  - Runtime Tagï¼ˆå¯è¢« `$.use(CounterModule)` æ¶ˆè´¹ï¼‰ï¼›
  - Logic å…¥å£ï¼ˆ`CounterModule.logic` çš„å®¿ä¸»ï¼‰ï¼›
  - Live å·¥å‚ï¼ˆ`CounterModule.live` çš„å®¿ä¸»ï¼‰ã€‚

å¯¹åº”ç±»å‹å¯ä»¥åœ¨ `logix-v3-core.ts / Logix.Module` ä¸­æŸ¥çœ‹ã€‚

---

## 2. `ModuleLogic` ä¸ `Logic.Of`

ä¸ºäº†åœ¨ç±»å‹ä¸Šè¡¨è¾¾â€œåœ¨æŸä¸€ç±» Module ä¸Šè¿è¡Œçš„ä¸€æ®µé€»è¾‘ç¨‹åºâ€ï¼Œv3.1 çº¦å®šï¼ˆä»¥ `Logic.Of` ä¸ºä¸»ï¼‰ï¼š

```ts
import { Logic, Store, Logix } from '@logix/core';

export type ModuleLogic<Sh extends Logix.ModuleShape<any, any>, R = unknown, E = never> =
  Logic.Of<Sh, R, unknown, E>
```

å«ä¹‰ï¼š

- `Sh`ï¼šé€šè¿‡ Module å®šä¹‰æ¨å¯¼å‡ºçš„ `Logix.ModuleShape<stateSchema, actionSchema>`ï¼›
- `R`ï¼šLogic ä¾èµ–çš„é¢å¤–ç¯å¢ƒï¼ˆServicesï¼‰ï¼›
- `E`ï¼šLogic å¯èƒ½æŠ›å‡ºçš„é”™è¯¯ï¼ˆé€šå¸¸ä¸º neverï¼Œå†…éƒ¨æ¶ˆåŒ–ï¼‰ã€‚

> æ³¨ï¼šæ—©æœŸè‰æ¡ˆä¸­æ›¾è®¾æƒ³è¿‡â€œåŸºäº `Logic.Env<Sh,R>` + `Logic.RuntimeTag` çš„ Bound API å·¥å‚â€ï¼Œç”¨äºä»ç¯å¢ƒä¸­â€œéšå¼â€è·å– Runtime å¹¶æ„é€  `$`ã€‚è¯¥è®¾æƒ³ç›®å‰ä»…ä¿ç•™åœ¨ drafts ä¸­ï¼Œç”¨äºæ¢ç´¢ Env-First å½¢æ€çš„å¯èƒ½æ€§ã€‚  
> å½“å‰ PoC ä¸­ï¼ŒPattern / Namespace åœºæ™¯è¯·ç›´æ¥ä½¿ç”¨ `Logix.BoundApi.make(shape, runtime)` åœ¨å®ç°å±‚æ„é€  `$`ï¼Œä¸šåŠ¡ä»£ç æ¨èç»Ÿä¸€é€šè¿‡ `Module.logic(($)=>Effect.gen(...))` è¿”å› Logic å€¼ã€‚

---

## 3. `Module.logic(($)=>Effect)`ï¼šé€»è¾‘ç¨‹åºå…¥å£

### 3.1 åŸºæœ¬å½¢æ€

`Module.logic` æ˜¯â€œåœ¨è¯¥é¢†åŸŸä¸ŠæŒ‚è½½ä¸€æ®µ Logic ç¨‹åºâ€çš„å…¥å£ï¼š

```ts
export const CounterLogic = CounterModule.logic(($) =>
  Effect.gen(function* () {
    // Action â†’ State
    yield* $.onAction(
      (a): a is { _tag: 'inc' } => a._tag === 'inc',
    ).update((prev) => ({ ...prev, count: prev.count + 1 }));

    // State â†’ State
    yield* $.onState((s) => s.count).run(Effect.logInfo('Count changed'));
  }),
);
```

ç‰¹å¾ï¼š

- ç”± Module æ³¨å…¥ä¸€ä¸ª Bound API `$`ï¼ˆè§ç¬¬ 4 èŠ‚ï¼‰ï¼ŒEnv ç±»å‹è‡ªåŠ¨æ¨å¯¼ä¸º `Logic.Env<Sh,R>`ï¼›
- è¿”å›å€¼å°±æ˜¯ä¸€æ®µ Logic ç¨‹åºï¼ˆ`Logic.Of<Sh,R>`ï¼‰ï¼Œå¯ä»¥åœ¨ `Module.live` ä¸­æŒ‚è½½ï¼Œæˆ–ä½œä¸º Pattern/æ¨¡æ¿è¿”å›å€¼å¤ç”¨ï¼›
- ä¸€ä¸ª Module å¯ä»¥æœ‰å¤šæ®µ Logicï¼ˆå¤šæ¬¡ `.logic` è°ƒç”¨ï¼‰ï¼Œä½†é€šå¸¸çº¦å®šåœ¨ Module å®šä¹‰æ–‡ä»¶å¯¼å‡ºä¸€ä¸ªâ€œä¸»é€»è¾‘â€ï¼Œå…¶ä½™ä½œä¸º Pattern/æ’ä»¶é€»è¾‘ç»„åˆåˆ° `.live` ä¸­ã€‚

### 3.2 ç»„åˆå¤šä¸ª Logic ç¨‹åº

Module æœ¬èº«ä¸é™åˆ¶ Logic çš„ä¸ªæ•°ï¼Œ`Module.live` ä¼šå°†å®ƒä»¬ç»Ÿä¸€æŒ‚åœ¨è¯¥ Module å¯¹åº”çš„ `Logix.ModuleRuntime` ä¸Šï¼š

```ts
export const AuditLogic = CounterModule.logic($ => /* ... */);
export const MetricsLogic = CounterModule.logic($ => /* ... */);

export const CounterLive = CounterModule.live(
  { count: 0 },
  CounterLogic,   // ä¸»é€»è¾‘
  AuditLogic,     // å®¡è®¡æ’ä»¶
  MetricsLogic,   // ç›‘æ§æ’ä»¶
);
```

---

## 4. `Module.live(initial, ...logics)`ï¼šç”Ÿæˆ Live Layer

`Module.live` è´Ÿè´£æŠŠ Module å®šä¹‰ + åˆå§‹ State + ä¸€ç»„ Logic ç¨‹åºç»„åˆæˆå¯æ³¨å…¥çš„ Layerï¼š

```ts
export const CounterLive = CounterModule.live(
  { count: 0 },
  CounterLogic,
);
```

è¯­ä¹‰ï¼š

- å†…éƒ¨ä¼šåŸºäº Module çš„ `stateSchema` / `actionSchema` æ„é€ çŠ¶æ€å®¹å™¨ä¸ Action æµï¼Œå¹¶å¯åŠ¨æ‰€æœ‰æŒ‚è½½çš„ Logic ç¨‹åºï¼›
- åœ¨ä¸€ä¸ªè¿è¡Œæ—¶ Scope ä¸­å¯åŠ¨æ‰€æœ‰ä¼ å…¥çš„ Logic ç¨‹åºï¼ˆé€šè¿‡ `Effect.forkScoped` ç­‰ï¼‰ï¼Œå¹¶å°†ç›¸åº”çš„è¿è¡Œæ—¶å®ä¾‹æ³¨å…¥ `Logic.RuntimeTag`ï¼›
- å¯¹ React/åº”ç”¨ Shell è€Œè¨€ï¼Œåªéœ€æŠŠ `CounterLive` æä¾›ç»™ Runtimeï¼ˆå¦‚ `RuntimeProvider` / ç»Ÿä¸€çš„æ¨¡å— Hookï¼‰ï¼Œæ— éœ€å…³å¿ƒåº•å±‚å®ç°ç»†èŠ‚ã€‚
- `ModuleRuntime` çš„å…·ä½“å®ç°ä¸æ›¿æ¢ç­–ç•¥å±äºå¼•æ“å®ç°å±‚èƒ½åŠ›ï¼Œå¦‚éœ€è‡ªå®šä¹‰ Runtimeï¼Œè¯·å‚è€ƒ `core/05-runtime-implementation.md` ä¸­çš„ã€Œ1.3 æ‰©å±•ç‚¹ï¼šè‡ªå®šä¹‰ ModuleRuntime çš„è¾¹ç•Œã€çº¦å®šã€‚

---

## 5. Bound API `$`ï¼šä¸šåŠ¡ä½œè€…çš„å”¯ä¸€å…¥å£

Bound API `$` çš„å®Œæ•´è¯´æ˜è§ `core/03-logic-and-flow.md`ï¼Œè¿™é‡Œåªåšæ¦‚è§ˆã€‚

åœ¨ Logic ç¨‹åºå†…éƒ¨ï¼Œä¸šåŠ¡ä½œè€…åªéœ€è®°ä½ä¸€ä¸ªç¬¦å· `$`ã€‚å½“å‰ PoC ä¸­ï¼Œ`$` çš„**å”¯ä¸€æ­£å¼å…¥å£**æ˜¯ `Module.logic(($)=>Effect)`ï¼š

```ts
export const SomeLogic = SomeModule.logic(($) =>
  Effect.gen(function* () {
    // ...
  }),
);
```

> è¯´æ˜ï¼šæ–‡æ¡£ä¸ç¤ºä¾‹ä¸­è‹¥æåˆ°â€œé’ˆå¯¹æŸä¸ª Shape/Env é¢„ç»‘å®šçš„ `$`â€ï¼Œå‡è¡¨ç¤ºåœ¨ `Logic.Env<Sh,R>` ä¸Šé¢„ç»‘å®šåŒä¸€ç±» `BoundApi<Sh,R>` çš„ `$`ã€‚åœ¨å½“å‰å®ç°ä¸­ï¼Œè¯·å§‹ç»ˆé€šè¿‡ `Module.logic(($)=>...)` è·å– `$`ã€‚

ä»å¿ƒæ™ºæ¨¡å‹ä¸Šï¼Œå¯ä»¥æŠŠ `$` ç†è§£ä¸ºä¸€ä¸ªâ€œå®¿ä¸»å¯¹è±¡â€ï¼Œå†…éƒ¨å†æŒ‰ã€Œæ„ŸçŸ¥ / ç­–ç•¥ / è¡ŒåŠ¨ / åä½œ / ç»“æ„ / ç”Ÿå‘½å‘¨æœŸã€å…­ä¸ªå­åŸŸåˆ’åˆ†ï¼š

- æ„ŸçŸ¥ï¼ˆPerceptionï¼‰ï¼š`$.onState / $.onAction / $.on` â€”â€” Fluent Intent DSLï¼Œç”¨äºç›‘å¬å½“å‰ Module çš„ State / Action æˆ–ä»»æ„ Streamï¼›
- ç­–ç•¥ï¼ˆStrategyï¼‰ï¼š`$.flow.*` â€”â€” Flow APIï¼ŒåŒ…å« `fromAction / fromState / debounce / throttle / filter / run / runLatest / runExhaust` ç­‰ç®—å­ï¼Œç”¨æ¥æè¿°æ—¶é—´è½´ä¸å¹¶å‘è¯­ä¹‰ï¼›
- è¡ŒåŠ¨ï¼ˆActuationï¼‰ï¼š`$.state` / `$.actions` â€”â€” è¯»å†™å½“å‰ Store çŠ¶æ€ï¼ˆ`read / update / mutate / ref`ï¼‰ä¸æ´¾å‘å½“å‰ Store çš„ Actionï¼ˆ`dispatch / actions$`ï¼‰ï¼›selector çº§ Ref ä»éœ€ç»“åˆ `$.onState` / Flow æˆ–è‡ªå®šä¹‰å°è£…ï¼›
- åä½œï¼ˆCollaborationï¼‰ï¼š`$.use` â€”â€” ä¾èµ–æ³¨å…¥å…¥å£ï¼ˆ`$.use(ModuleOrService)`ï¼‰ï¼Œç”¨äºè®¿é—®å…¶ä»– Module çš„åªè¯»å¥æŸ„æˆ–å¤–éƒ¨ Serviceï¼›
- ç»“æ„ï¼ˆStructureï¼‰ï¼š`$.match` â€”â€” ç»“æ„åŒ–åˆ†æ”¯ä¸æ¨¡å¼åŒ¹é…ï¼ˆ`match / matchTag` ç­‰ï¼‰ï¼Œé…åˆ Effect åŸè¯­è¡¨è¾¾æ§åˆ¶ç»“æ„ï¼›
- ç”Ÿå‘½å‘¨æœŸï¼ˆLifecycleï¼‰ï¼š`$.lifecycle` â€”â€” ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆ`onInit / onDestroy` ç­‰ï¼‰ï¼Œä¸ Module Runtime çš„ Scope ç»‘å®šã€‚

### 5.1 ç”Ÿå‘½å‘¨æœŸ `$.lifecycle`

ç”¨äºå®šä¹‰ Module å¯åŠ¨ä¸é”€æ¯æ—¶çš„é’©å­é€»è¾‘ã€‚

- **`onInit` (Blocking)**: æ¨¡å—åˆå§‹åŒ–æ—¶æ‰§è¡Œã€‚**é»˜è®¤é˜»å¡**ï¼Œå³ `yield* onInit` å®Œæˆåï¼ŒRuntime æ‰ä¼šè¢«æ ‡è®°ä¸º Readyã€‚é€‚ç”¨äºåŠ è½½é…ç½®ã€è¿æ¥æ•°æ®åº“ç­‰å¿…é¡»çš„å‰ç½®æ“ä½œã€‚
- **`onDestroy`**: æ¨¡å—é”€æ¯ï¼ˆScope å…³é—­ï¼‰æ—¶æ‰§è¡Œã€‚ç”¨äºæ¸…ç†èµ„æºã€‚
- **`onError`**: æ¨¡å—å†…ä»»æ„ Logic Fiber å‘ç”Ÿæœªæ•è·é”™è¯¯ï¼ˆDefectï¼‰æ—¶è§¦å‘ã€‚
  - **æ—¶æœº**ï¼šé”™è¯¯ä¼ æ’­åˆ° Module Scope æ—¶ï¼Œåœ¨ Scope å…³é—­å‰è§¦å‘ã€‚
  - **ç”¨é€”**ï¼šä»…ç”¨äº**æœ€åçš„é”™è¯¯ä¸ŠæŠ¥ä¸æ—¥å¿—è®°å½•**ï¼ˆLast-breath reportingï¼‰ï¼Œä¸ç”¨äºé”™è¯¯æ¢å¤ï¼ˆæ¢å¤åº”åœ¨ Logic å†…éƒ¨å¤„ç†ï¼‰ã€‚
  - **æ³¨æ„**ï¼šè§¦å‘ `onError` æ„å‘³ç€ Module å³å°†å´©æºƒï¼ˆScope å…³é—­ï¼‰ã€‚

```ts
// ç¤ºä¾‹ï¼šçµæ´»ç»„åˆå¤šä¸ªç”Ÿå‘½å‘¨æœŸä¸åå°ä»»åŠ¡
const MyLogic = MyModule.logic(($) => Effect.gen(function*() {
  // 1. ç¬¬ä¸€æ­¥åˆå§‹åŒ– (é˜»å¡)
  yield* $.lifecycle.onInit(Effect.log("Init Step 1: Config"))

  // 2. å¯åŠ¨ç¬¬ä¸€ä¸ªåå°ä»»åŠ¡ (éé˜»å¡)
  yield* Effect.fork(
    Stream.tick("1 second").pipe(
      Stream.tap(() => Effect.log("Heartbeat 1")),
      Stream.runDrain
    )
  )

  // 3. ç¬¬äºŒæ­¥åˆå§‹åŒ– (é˜»å¡)
  // åªæœ‰ç­‰ Step 1 å®Œæˆåï¼Œæ‰ä¼šæ‰§è¡Œåˆ°è¿™é‡Œï¼ˆå¦‚æœ Step 1 å¤±è´¥ï¼Œè¿™é‡Œä¸ä¼šæ‰§è¡Œï¼‰
  yield* $.lifecycle.onInit(Effect.log("Init Step 2: DB"))

  // 4. å¯åŠ¨ç¬¬äºŒä¸ªåå°ä»»åŠ¡
  yield* Effect.fork(
    Stream.make(1, 2, 3).pipe(
      Stream.runForEach(n => Effect.log(`Processing ${n}`))
    )
  )
}))
```

> **æœºåˆ¶è¯´æ˜**ï¼š
> - `$.lifecycle.onInit` åªæ˜¯**æ³¨å†Œ**åˆå§‹åŒ–é€»è¾‘ã€‚
> - è¿è¡Œæ—¶ä¼šæ”¶é›†æ‰€æœ‰æ³¨å†Œçš„ `onInit` Effectï¼Œå¹¶åœ¨ Module å¯åŠ¨æ—¶æŒ‰**æ³¨å†Œé¡ºåº**ä¾æ¬¡æ‰§è¡Œï¼ˆä¸²è¡Œï¼‰ã€‚
> - `Effect.fork` çš„åå°ä»»åŠ¡ä¼šç«‹å³å¯åŠ¨ï¼Œä¸é˜»å¡åç»­çš„ `onInit` æ³¨å†Œï¼Œä¹Ÿä¸é˜»å¡ Module çš„ Ready çŠ¶æ€ã€‚

### 5.2 æœªæ¥æ¼”è¿› (Future Lifecycle Hooks)

ä»¥ä¸‹é’©å­å·²åœ¨è§„åˆ’ä¸­ï¼Œå°†åœ¨åç»­ç‰ˆæœ¬æ”¯æŒï¼š

- **`onSuspend` / `onResume`**:
  - é¢å‘ React `<Offscreen>` / KeepAlive æˆ–ç§»åŠ¨ç«¯åå°åœºæ™¯ï¼›
  - ç”¨äºåœ¨ UI ä¸å¯è§æ—¶æš‚åœé«˜é¢‘ä»»åŠ¡ï¼ˆå¦‚ Pollingï¼‰ï¼Œè€Œä¸é”€æ¯çŠ¶æ€ã€‚
- **`onReset`**:
  - é¢å‘ä¸šåŠ¡é€»è¾‘çš„â€œè½¯é‡ç½®â€ï¼ˆSoft Resetï¼‰ï¼›
  - æ ‡å‡†åŒ– `Logout` / `Clear` è¡Œä¸ºï¼Œé‡ç½®çŠ¶æ€ä½†ä¸é”€æ¯å®ä¾‹ã€‚

Bound API è®¾è®¡ç›®æ ‡ï¼š

- å¯¹ä¸šåŠ¡ä»£ç ï¼šåªéœ€è¦è®°ä½ `$`ï¼Œä¸ç›´æ¥æ¥è§¦ Store / Context / Layerï¼›
- å¯¹å¹³å° Parserï¼š`$` æ˜¯é™æ€é”šç‚¹ï¼Œ`$.on*().update/mutate/run*` é“¾æ˜¯ IntentRule çš„ IR å½¢æ€ï¼›
- å¯¹è¿è¡Œæ—¶ï¼š`$` åªæ˜¯ Env çš„ä¸€å±‚ç±»å‹/è¯­æ³•å°è£…ï¼Œæ‰€æœ‰è¯­ä¹‰éƒ½å¯æœºæ¢°åœ°ç¿»è¯‘ä¸º `Flow.Api` / `Control.Api` ç»„åˆã€‚

---

## 6. ä¸è¿è¡Œæ—¶å®¹å™¨çš„å…³ç³»

æ€»ç»“ä¸€ä¸‹ Module / Logic / Live / ModuleImpl ä¸è¿è¡Œæ—¶å®¹å™¨ä¹‹é—´çš„å…³ç³»ï¼š

- æ¦‚å¿µå±‚ï¼š
  - Module = é¢†åŸŸæ¨¡å—å®šä¹‰ï¼ˆä¸å«å®ä¾‹ï¼‰ï¼›
  - Logic = åœ¨è¯¥ Module ä¸Šè¿è¡Œçš„ä¸€æ®µé•¿é€»è¾‘ç¨‹åºï¼›
  - Live = Module çš„è¿è¡Œæ—¶ Layerï¼ˆä¸€æ¬¡æ€§ã€å³å¯æ³¨å…¥å³å¯ç”¨ï¼‰ï¼›
  - ModuleImpl = å¸¦åˆå§‹çŠ¶æ€ä¸é€»è¾‘çš„æ¨¡å—å®ç°è“å›¾ï¼Œå¯åœ¨ä¸åŒ AppRuntime / React Tree ä¸­å¤šæ¬¡å¤ç”¨ã€‚
- è¿è¡Œæ—¶å±‚ï¼š
  - æ¯ä¸ª Module.live / ModuleImpl.layer ä¼šæ„é€ ä¸€ä¸ªä¸è¯¥ Module ç»‘å®šçš„è¿è¡Œæ—¶å®ä¾‹ï¼›
  - æ‰€æœ‰æŒ‚åœ¨è¯¥ Module ä¸Šçš„ Logic ç¨‹åºè¿è¡Œåœ¨åŒä¸€ä¸ªè¿è¡Œæ—¶å®ä¾‹ä¸Šï¼ˆå…±äº« State / actions$ / changes$ï¼‰ï¼›
  - è·¨ Module åä½œé€šè¿‡ `$.use(OtherModule)` / `$.useRemote(OtherModule)` + Fluent DSL è¡¨è¾¾ï¼›
  - `Logix.app` è´Ÿè´£æŠŠè‹¥å¹² `ModuleRuntime` ä¸è¿›ç¨‹çº§ `processes` ç»„åˆæˆä¸€ä¸ª AppRuntimeï¼Œ`Logix.provide(ModuleImpl)` æ˜¯å…¶è£…é…è¯­æ³•ç³–ã€‚

å¯¹æ—¥å¸¸ä¸šåŠ¡å¼€å‘è€Œè¨€ï¼Œåªéœ€é€šè¿‡ Module / Logic / Live / ModuleImpl / `$` äº”ä¸ªæ¦‚å¿µè¿›è¡Œæ€è€ƒä¸ç¼–ç ã€‚
éœ€è¦æ·±å…¥è¿è¡Œæ—¶ç”Ÿå‘½å‘¨æœŸã€Scopeã€è°ƒè¯•ç­‰èƒ½åŠ›æ—¶ï¼Œå†å‚è€ƒ `core/05-runtime-implementation.md` ä¸ impl ç³»åˆ—æ–‡æ¡£ã€‚
</file>

<file path="runtime-logix/core/03-intent-alignment.md">
# æ„å›¾å¯¹é½ (Intent Alignment)

> **Status**: Draft
> **Date**: 2025-11-20

## 1. ç›®æ ‡

æœ¬ Logix å¼•æ“çš„è®¾è®¡åˆè¡·ä¹‹ä¸€ï¼Œæ˜¯ä½œä¸º `intent-driven-ai-coding` å¹³å°ä¸­çš„ä¸€ä¸ªå‰ç«¯ Runtime Targetï¼ˆ`logix-engine`ï¼‰ï¼Œæ‰¿è½½â€œè´´è¿‘ UI çš„è¡Œä¸ºä¸è”åŠ¨â€ã€‚è¿™æ„å‘³ç€ï¼š

- Logix ä¸é‡æ–°å®šä¹‰ Intent / Flow / Constraint çš„æ¨¡å‹ï¼Œç›¸å…³æ¦‚å¿µä¸ Schema ä»¥ `docs/specs/intent-driven-ai-coding/v3` ä¸ºäº‹å®æºï¼š  
  - ä¸‰ä½ä¸€ä½“ Intent æ¨¡å‹ï¼š`v3/02-intent-layers.md`ï¼›  
  - èµ„äº§ä¸ Schema æ˜ å°„ï¼š`v3/03-assets-and-schemas.md`ï¼›  
  - Runtime å®¶æ—ä¸ Flow æ‰§è¡Œï¼š`v3/97-effect-runtime-and-flow-execution.md`ã€‚  
- å¦‚éœ€å›é¡¾ v2 å…­å±‚æ¨¡å‹åŠå…¶ä¸ v3 çš„å·®å¼‚ï¼Œå¯å‚è€ƒ `v2/02-intent-layers.md` ä¸ `v2/99-history-and-comparison.md`ï¼Œä½†å®ƒä»¬ä¸å†ä½œä¸ºå½“å‰ Logix è®¾è®¡çš„äº‹å®æºã€‚  
Logix åªå®šä¹‰â€œè¿™äº› Intent å¦‚ä½•åœ¨å‰ç«¯è¿è¡Œæ—¶ä¸­è½åœ°â€ä¸º Module å®šä¹‰ï¼ˆState/Action Schemaï¼‰ã€ModuleRuntime é…ç½®ï¼ˆåˆå§‹çŠ¶æ€ç­‰ï¼‰ä¸ Logic è§„åˆ™ã€‚

## 2. Intent ä¸‰ç»´ä¸ Logix çš„å…³ç³»

å‚è€ƒ v3 æ–‡æ¡£ä¸­çš„ä¸‰ç»´ Intent æ¨¡å‹ï¼ˆUI / Logic / Domainï¼‰ï¼ŒLogix çš„è¦†ç›–èŒƒå›´å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š

| Intent ç»´åº¦ | Logix è§’è‰² | è¯´æ˜ |
| :--- | :--- | :--- |
| **UI Intent** | Inputs & State Consumer | UI Intent å†³å®šç•Œé¢ç»“æ„ä¸å¯äº¤äº’éƒ¨ä»¶ï¼ŒLogix é€šè¿‡ State/Actions/Inputs ä¸ºè¿™äº›ç»„ä»¶æä¾›æ•°æ®ä¸è¡Œä¸ºå…¥å£ï¼Œä½†ä¸å…³å¿ƒå…·ä½“å¸ƒå±€ç»†èŠ‚ã€‚ |
| **Logic Intent** | è¿è¡Œæ—¶ç›®æ ‡ä¹‹ä¸€ | å½“ `runtimeTarget = 'logix-engine'` æ—¶ï¼ŒLogic Intent ä¸­çš„ Flow DSL ä¼šè¢«ç¼–è¯‘ä¸º Logix çš„ Logic è§„åˆ™ï¼›å½“ç›®æ ‡ä¸ºå…¶ä»– Runtimeï¼ˆå¦‚ Effect Flow Runtimeï¼‰æ—¶ï¼ŒLogix åªè´Ÿè´£è§¦å‘/å±•ç¤ºç»“æœã€‚ |
| **Domain Intent** | Schema + Services | Domain Intent ä¸­çš„å®ä½“ä¸æœåŠ¡å¥‘çº¦æ˜ å°„ä¸º Logix Module çš„ `stateSchema` / `initialState` ä»¥åŠæ³¨å…¥ ModuleRuntime çš„ `services`ï¼Œå†³å®šçŠ¶æ€ç»“æ„ä¸å¯ç”¨æœåŠ¡ã€‚ |

åœ¨ v2 çš„å…­å±‚æ¨¡å‹ä¸­ï¼š

- Layout / View / Interaction Intent ç°åœ¨è¢«ç»Ÿä¸€çº³å…¥ UI / Logic ç»´åº¦ï¼ˆå‚è§ `v3/02-intent-layers.md` ä¸­çš„è¯´æ˜ï¼‰ï¼›  
- Code Structure Intent ä¸å†è¢«è§†ä¸º Intentï¼Œè€Œæ˜¯ç”± Pattern / æ¨¡æ¿å±‚è‡ªåŠ¨äº§å‡ºçš„å·¥ç¨‹ç»†èŠ‚ã€‚  
è¿™äº›å†å²æ¦‚å¿µå¦‚éœ€å›é¡¾ï¼Œå¯ä»¥ç”¨æ¥ç†è§£ Logix è¦†ç›–èŒƒå›´çš„ç”±æ¥ï¼Œä½†ä¸å†çº¦æŸå½“å‰ DSL ä¸ Schema è®¾è®¡ã€‚

Logix è§†è§’åªå…³å¿ƒï¼šæŸæ®µ Behavior & Flow Intent æ˜¯å¦é€‰æ‹©äº† `logix-engine` ä½œä¸º `runtimeTarget`ï¼Œä»¥åŠå“ªäº› Interaction / Data & State / Constraint ä¿¡æ¯éœ€è¦åœ¨å‰ç«¯è¿è¡Œæ—¶ä¸­è¢«è½å®ã€‚

## 3. `runtimeTarget = 'logix-engine'` æ—¶çš„æ˜ å°„

å½“ Behavior & Flow Intent æ˜ç¡®æ ‡è®°ä¸ºåœ¨ Logix ä¸Šæ‰§è¡Œæ—¶ï¼Œå¹³å°ç«¯çš„ç¼–è¯‘/å‡ºç è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š

1. **è§¦å‘æ¡ä»¶**ï¼ˆInteraction Intentï¼‰  
   - äº‹ä»¶ï¼ˆå¦‚ `button.click`ã€`field.change`ï¼‰åœ¨ UI å±‚é€šè¿‡æ ‡å‡†æ¨¡å¼æ˜ å°„ä¸ºï¼š  
     - å¯¹åº”å­—æ®µçš„ `set(path, value)`ï¼›  
     - æˆ–æŸä¸ªä¸šåŠ¡æ„å›¾çš„ `dispatch(action)`ï¼›  
     - æˆ–æ³¨å…¥åˆ° `inputs` æµï¼ˆå¦‚æœç´¢æ¡†è¾“å…¥æµï¼‰ã€‚

2. **è¡Œä¸ºæ­¥éª¤é“¾**ï¼ˆBehavior & Flow Intentï¼‰  
   - è¡Œä¸ºæ­¥éª¤ï¼ˆæ£€æŸ¥ã€è°ƒç”¨æœåŠ¡ã€æ›´æ–°çŠ¶æ€ã€å‘å‡ºä¿¡å·ç­‰ï¼‰è¢«ç¼–è¯‘ä¸º Logix çš„ Logic è§„åˆ™ï¼š  
     - å¯¹å­—æ®µå˜åŒ–æ•æ„Ÿçš„æ­¥éª¤ â†’ `flow.fromState(selector)`ï¼›  
     - å¯¹ Actions æ•æ„Ÿçš„æ­¥éª¤ â†’ `flow.fromAction(predicate)`ï¼›  
     - å¯¹å¤–éƒ¨æµæ•æ„Ÿçš„æ­¥éª¤ â†’ `flow` è§„åˆ™ã€‚

3. **çŠ¶æ€ç»“æ„**ï¼ˆData & State Intentï¼‰  
   - Data & State Intent å£°æ˜çš„å­—æ®µ/å®ä½“ Schema æ˜ å°„åˆ° Module å®šä¹‰ä¸åˆå§‹çŠ¶æ€ï¼š  
     - `stateSchema: Schema<S>` ä¸ `initialState: S`ï¼ˆå¯¹åº” `Logix.ModuleShape` ä¸ `Module.live(initial, ...)`ï¼‰ï¼›  
     - å¯¹åº”çš„é”™è¯¯/å…ƒä¿¡æ¯å­—æ®µï¼ˆå¦‚ `errors`, `touched`, `status`ï¼‰ç”± Form/åˆ—è¡¨ç­‰é¢†åŸŸåŒ…åœ¨ Logix ä¹‹ä¸Šæ‰©å±•ã€‚

4. **çº¦æŸä¸è´¨é‡**ï¼ˆConstraint & Quality Intentï¼‰  
   - éåŠŸèƒ½æ€§çº¦æŸï¼ˆé˜²æŠ–ã€èŠ‚æµã€å¹¶å‘ç­–ç•¥ã€é‡è¯•/è¶…æ—¶ç­‰ï¼‰è¢«ç¼–è¯‘ä¸º Logic è§„åˆ™ä¸Šçš„ options æˆ–ä¸­é—´ä»¶ï¼š  
     - å¦‚ `debounce: '500 millis'`, `concurrency: 'restart'` ç­‰ï¼›  
     - æ›´å¤æ‚çš„çº¦æŸï¼ˆå¦‚å®¡è®¡/åŸ‹ç‚¹ï¼‰å¯é€šè¿‡ Env/Services å±‚æˆ–ä¸“é—¨çš„ Logic è§„åˆ™å®ç°ã€‚

æœ€ç»ˆç»“æœæ˜¯åœ¨æŸä¸ª feature ä¸‹ç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ª Logix Module å®šä¹‰ + Logic é…ç½®ï¼ˆæˆ– JSON DSLï¼‰ï¼Œç”± UI é€šè¿‡ `@logix/react` é€‚é…å±‚æ¥å…¥ã€‚

## 4. ä¸ Effect Flow Runtime çš„è¾¹ç•Œ

Behavior & Flow Intent åœ¨å¹³å°å±‚å¯ä»¥é€‰æ‹©ä¸åŒçš„ Runtime Targetï¼š

- **Effect Flow Runtime**ï¼š  
  - è´Ÿè´£è·¨ç³»ç»Ÿã€å¼ºå®¡è®¡/é‡è¯•/å›æ”¾çš„é•¿æµç¨‹ï¼ˆå¦‚è®¢å•å¯¼å‡ºä»»åŠ¡ã€å®¡æ‰¹æµã€æ•°æ®åŒæ­¥ï¼‰ï¼›  
  - ä»¥ `.flow.ts` + Env/Layer çš„å½¢å¼åœ¨æœåŠ¡ç«¯è¿è¡Œã€‚

- **Logix Engine Runtime**ï¼š  
  - è´Ÿè´£â€œè´´è¿‘ UIâ€çš„è¡Œä¸ºï¼ˆå­—æ®µè”åŠ¨ã€è¡¨å•æ ¡éªŒã€åˆ—è¡¨åŠ è½½ä¸åˆ·æ–°ç­–ç•¥ã€è½»é‡æœ¬åœ°æµç¨‹ï¼‰ï¼›  
  - åœ¨éœ€è¦è·¨ç³»ç»Ÿæ—¶ï¼Œé€šè¿‡æœåŠ¡æ¥å£è°ƒç”¨å‰è€…æš´éœ²çš„ Flowã€‚

ä» Logix è§†è§’çœ‹å¾… Behavior & Flow Intentï¼š

- è‹¥ `runtimeTarget = 'effect-flow-runtime'`ï¼š  
  - Logix é…ç½®åªæ˜¯ç”Ÿæˆè°ƒç”¨å…¥å£ï¼ˆå¦‚ `services.FlowRunner.run(flowId, input)`ï¼‰ä¸çŠ¶æ€å›å¡«é€»è¾‘ï¼›  
  - è¡Œä¸ºæœ¬ä½“åœ¨ Flow Runtime ä¸­è¿è¡Œã€‚

- è‹¥ `runtimeTarget = 'logix-engine'`ï¼š  
  - Logix ç›´æ¥æ‰¿è½½æ­¥éª¤é“¾ï¼Œä»¥ä¸ŠèŠ‚æè¿°çš„æ–¹å¼ç”Ÿæˆ Logic è§„åˆ™ï¼›  
  - Flow Runtime åªåœ¨å¿…è¦æ—¶ä½œä¸ºè¢«è°ƒç”¨æ–¹å‡ºç°ã€‚

è¿™ç§åˆ†å·¥ä¿è¯äº†ï¼šIntent æ¨¡å‹ä¸ DSL åœ¨å¹³å°å±‚ä¿æŒç»Ÿä¸€ï¼Œè¿è¡Œæ—¶åˆ™ç”± Logix ä¸ Effect Flow Runtime æŒ‰å„è‡ªæ“…é•¿çš„èŒƒå›´ååŒæ‰¿è½½ã€‚

## 5. AI è§†è§’ä¸‹çš„ä½¿ç”¨æ–¹å¼

å¯¹äº LLM æ¥è¯´ï¼Œé‡è¦çš„æ˜¯ **â€œLogix åªæ˜¯ Runtime Family ä¹‹ä¸€â€** è¿™ä¸€è®¤çŸ¥ï¼š

- åœ¨ç”Ÿæˆ Behavior & Flow Intent / FlowDslV2 è‰ç¨¿æ—¶ï¼Œæ¨¡å‹éœ€è¦å…ˆåˆ¤æ–­è¡Œä¸ºæ›´é€‚åˆè½åœ¨ `logix-engine` è¿˜æ˜¯ `effect-flow-runtime`ï¼›  
- å½“ç›®æ ‡æ˜¯ Logix æ—¶ï¼Œè¾“å‡ºçš„é‡ç‚¹æ˜¯ï¼š  
  - å“ªäº› Interaction äº‹ä»¶ä¼šè§¦å‘ Logicï¼›  
  - éœ€è¦ç›‘æ§/æ›´æ–°å“ªäº› State è·¯å¾„ï¼›  
  - æœ‰å“ªäº›é˜²æŠ–/å¹¶å‘/é‡è¯•çº¦æŸï¼›  
  - éœ€è¦è°ƒç”¨å“ªäº›å‰ç«¯å¯ç”¨çš„æœåŠ¡ï¼ˆå¦‚æœ¬åœ°ç¼“å­˜ã€å‰ç«¯æ ¡éªŒåº“ã€Flow Runner å®¢æˆ·ç«¯ï¼‰ã€‚

Logix ç«¯çš„ JSON è§£é‡Šå™¨ä¸ Logic DSL ä»…æ˜¯â€œæ‰¿æ¥è¿™äº› Intent çš„ä¸€ç§è½åœ°å½¢å¼â€ï¼Œå…¶ Schema è®¾è®¡åº”ä»¥ v3 ä¸­çš„ Intent / Flow / Constraint æ¨¡å‹ä¸ºä¸Šæ¸¸ï¼ˆå‚è§ `v3/02-intent-layers.md`ã€`v3/03-assets-and-schemas.md` ä¸ `v3/97-effect-runtime-and-flow-execution.md`ï¼‰ï¼Œé¿å…å†å‡ºç°ç¬¬äºŒå¥—äº‹å®æºã€‚

## 6. v3 Intent â†” Logix API æ˜ å°„è¡¨

ä¸ºæ–¹ä¾¿åœ¨å®ç°ä¸å‡ºç æ—¶å¿«é€Ÿå®šä½ï¼Œä¸‹é¢ç»™å‡ºä¸€ä»½ä» v3 Intent æ¨¡å‹åˆ° Logix æ ¸å¿ƒ API çš„ç›´è§‚æ˜ å°„è¡¨ï¼ˆåªåˆ—å‡ºå¸¸ç”¨å­—æ®µï¼Œè¯¦ç»†è¯­ä¹‰ä»¥å„è‡ªè§„èŒƒä¸ºå‡†ï¼‰ï¼š

| v3 Intent / Schema å­—æ®µ | Logix å¯¹åº”ä½ç½® | å…¸å‹å†™æ³• / è¯´æ˜ |
| :--- | :--- | :--- |
| `IntentSpecV3.ui[*]`ï¼ˆUI Intent èŠ‚ç‚¹ï¼‰ | Module ä½¿ç”¨ä¾§ï¼ˆUI å±‚ï¼‰ | ç”±å¹³å°ç”Ÿæˆçš„ React ç»„ä»¶æ ‘ï¼Œé€šè¿‡ `@logix/react` è®¢é˜…æŸä¸ª ModuleRuntime çš„çŠ¶æ€ã€æ´¾å‘ Actionsï¼›Logix ä¸ç›´æ¥å»ºæ¨¡ UI èŠ‚ç‚¹ï¼Œåªæ¶ˆè´¹å…¶å‘å‡ºçš„äº‹ä»¶ã€‚ |
| `UIIntentNode.emits` / `UIImplConfig.emits` | `dispatch(action)` | UI äº‹ä»¶ï¼ˆå¦‚ `onClick: 'signal:submitOrder'`ï¼‰è¢«ç¼–è¯‘ä¸ºå‘å¯¹åº” ModuleRuntime æ´¾å‘æŸä¸ª Actionï¼Œä¾› `flow.fromAction` è§¦å‘ã€‚ |
| `DomainIntentNode` / `DomainImplConfig.fields` | `Logix.Module('Id', { state, actions })` / `Module.live(initial, ...)` | Domain å­—æ®µ Schema ç¼–è¯‘ä¸º `stateSchema: Schema.Schema<S>`ï¼ŒåŒæ—¶ç”Ÿæˆå¯¹åº”çš„ `initialState: S`ï¼Œå…±åŒå†³å®šæŸä¸ª Logix.Module çš„ State å½¢çŠ¶ä¸åˆå§‹å€¼ã€‚ |
| `DomainImplConfig.services` | ModuleRuntime Env + Logic ä¸­ `$.use / $.services` | Domain æœåŠ¡å¥‘çº¦æ˜ å°„ä¸º `Services` æ¥å£ä¸å…·ä½“å®ç°å¯¹è±¡ï¼Œé€šè¿‡ Layer æ³¨å…¥åˆ° ModuleRuntime çš„ç¯å¢ƒï¼Œåœ¨ Logic ä¸­é€šè¿‡ `$.use(ServiceTag)` æˆ– `services.Xxx` è°ƒç”¨ã€‚ |
| `LogicIntentNode.trigger` / `LogicImplConfig.trigger` | `flow.fromAction` / `flow.fromState` | `type: 'onSignal' | 'onLifecycle' | 'onSchedule'` ç­‰è§¦å‘å™¨è¢«ç¼–è¯‘ä¸ºå¯¹åº”çš„æµåˆ›å»ºå‡½æ•°ï¼›ä¾‹å¦‚ `signalId: 'submitOrder'` â†’ `flow.fromAction(a => a._tag === 'submitOrder')`ã€‚ |
| `LogicImplConfig.flow.nodes` / `edges`ï¼ˆFlow DSLï¼‰ | Logic / Flow API | Flow èŠ‚ç‚¹ï¼ˆ`service-call` / `update-state` / `dispatch` / `branch` ç­‰ï¼‰é€šè¿‡ Logic ç¨‹åºä¸­çš„ `Effect` å’Œ `flow` API è¿›è¡Œç»„åˆï¼›è°ƒç”¨æœåŠ¡ â†’ ç›´æ¥ `yield* services.Xxx` æˆ–åŒ…è£…ä¸º Patternï¼›æ›´æ–°çŠ¶æ€ â†’ é€šè¿‡ `state.update` / `state.mutate` å®ç°ï¼›å‘å°„ä¿¡å· â†’ é€šè¿‡ `dispatch` å®ç°ã€‚ |
| `LogicImplConfig.constraints`ï¼ˆ`concurrency` / `timeout` / `retry` / `transaction`ï¼‰ | è§„åˆ™ Options / ä¸­é—´ä»¶ | ç¼–è¯‘ä¸º Rule å±‚é¢çš„é€‰é¡¹ï¼ˆå¦‚é˜²æŠ–/å¹¶å‘ç­–ç•¥ï¼‰æˆ–å°è£…åœ¨æœåŠ¡è°ƒç”¨çš„ Effect ç»„åˆå­å†…ï¼ˆå¦‚ `Effect.timeoutFail`ã€`Effect.retry`ï¼‰ï¼Œç”± Logix Runtime åœ¨æ‰§è¡Œæ—¶ç»Ÿä¸€å¤„ç†ã€‚ |
| `LogicImplConfig.testCases` | `@logix/test` / Round-trip æµ‹è¯• | å¹³å°å¯å°†è¿™äº›ç”¨ä¾‹è½¬æ¢ä¸ºåŸºäº Logix ModuleRuntime çš„ Round-trip æµ‹è¯•ï¼ˆå‚è§ `runtime-logix/test` ç³»åˆ—æ–‡æ¡£ï¼‰ï¼Œé€šè¿‡æ³¨å…¥ Mock Servicesã€æ„é€ è¾“å…¥ã€æ–­è¨€ State/Signalsã€‚ |

åœ¨å®é™…å‡ºç é“¾è·¯ä¸­ï¼Œå¹³å°ä¼šå…ˆæ ¹æ® v3 Intent/Flow Schema ç”Ÿæˆä¸­é—´å±‚çš„ Flow DSL/JSONï¼ˆä¸ `v3/04-intent-to-code-example.md` ä¸€è‡´ï¼‰ï¼Œå†ç”± Logix ç¼–è¯‘å™¨å°†å…¶ä¸­ `runtimeTarget = 'logix-engine'` çš„éƒ¨åˆ†è½åœ°ä¸ºä¸Šè¿° Module å®šä¹‰ / ModuleRuntime é…ç½®ä¸ Logic è§„åˆ™ã€‚
</file>

<file path="runtime-logix/core/03-logic-and-flow.md">
# Logic & Flow (The Tools)

> **Status**: Definitive (v3 Effect-Native Â· Context is World)
> **Scope**: Logix Core Primitives
> **Audience**: åº”ç”¨/ä¸šåŠ¡å¼€å‘è€…ï¼ˆBound API `$` + Fluent DSL + Flow APIï¼‰ã€åº“ä½œè€…ï¼ˆFlow/Control/L3 Helperï¼‰ã€æ¶æ„å¸ˆï¼ˆEnv/Runtime ç»†èŠ‚ï¼‰ã€‚

æœ¬èŠ‚æè¿° Logix v3 ä¸­çš„ `Logic` / `Flow` / `Control` åŸè¯­ï¼Œä»¥åŠå›´ç»• **Universal Bound API (`$`)** çš„æœ€ç»ˆç¼–ç¨‹æ¨¡å‹ã€‚
ç±»å‹è‰æ¡ˆè§ `v3/effect-poc/shared/logix-v3-core.ts`ï¼Œæœ¬æ–‡ä»¶ç»™å‡ºæ¦‚å¿µè§†å›¾ï¼Œå®é™…ç­¾åä»¥ PoC ä¸ºå‡†ã€‚

## 1. Bound APIï¼šContext is World

åœ¨ v3 æœ€ç»ˆå½¢æ€ä¸­ï¼Œæˆ‘ä»¬ç¡®ç«‹ã€Œ**Context is World**ã€çš„å¿ƒæ™ºæ¨¡å‹ï¼š

- ä¸šåŠ¡ä½œè€…æ— éœ€æ˜¾å¼æ„ŸçŸ¥ Store Runtime / Env æ‹“æ‰‘ï¼Œåªéœ€é€šè¿‡ä¸€ä¸ªç»Ÿä¸€å…¥å£ `$` è®¿é—®æ‰€æœ‰èƒ½åŠ›ï¼›
- é¢†åŸŸæ¨¡å—é€šè¿‡ `Logix.Module` æä¾›ã€Œèº«ä»½ + å¥‘çº¦ + Runtime Tagã€ï¼ŒLogic åˆ™é€šè¿‡ `$` åœ¨å…¶ä¸Šä¸‹æ–‡ä¸­ç¼–æ’è¡Œä¸ºã€‚

æ ‡å‡† Logic æ–‡ä»¶å½¢æ€ç¤ºä¾‹ï¼ˆæ¦‚å¿µæ€§ä»£ç ï¼‰ï¼š

```ts
// features/counter/module.ts
export const Counter = Logix.Module('Counter', {
  state: CounterStateSchema,
  actions: CounterActionSchema,
});

// features/counter/logic.ts
export const CounterLogic = Counter.logic(($) =>
  Effect.gen(function* () {
    // 1. æœ¬åœ° State ç¼–æ’ï¼ˆå½“å‰ Moduleï¼‰
    yield* $.onState((s) => s.count)
      .debounce(300)
      .mutate((draft) => {
          draft.status = 'idle';
        });

    // 2. è·¨ Module åä½œ / Service è°ƒç”¨é€šè¿‡ $.use å®Œæˆ
    const $User = yield* $.use(UserModule);
    const api = yield* $.use(ApiService);

    // ...
  }),
);

// features/counter/live.ts
export const CounterLive = Counter.live(
  { count: 0, status: 'idle' },
  CounterLogic,
);
```

åœ¨è¿™ä¸€æ¨¡å¼ä¸‹ï¼š

- **ä¸šåŠ¡ä»£ç åªéœ€è¦è®°ä½ `$` è¿™ä¸€å…¥å£ç¬¦å·**ï¼š`$.state` / `$.actions` / `$.flow` / `$.use` / `$.on*` / `$.match`ï¼›
- Store/Logic/Env/Scope ç­‰è¿è¡Œæ—¶ç»†èŠ‚å¯¹ä¸šåŠ¡ä½œè€…é€æ˜ï¼Œç”±è¿è¡Œæ—¶å®ç°æ‰¿æ‹…å¤æ‚åº¦ã€‚

### 1.1 `$` ä½œä¸ºé™æ€é”šç‚¹ (Static Anchor)

ä¸ºäº†æ–¹ä¾¿å¹³å° Parser æ„å»º Logic Graphï¼Œéœ€è¦éµå®ˆä»¥ä¸‹çº¦å®šï¼š

- `$` å¿…é¡»æ˜¯ **Logic æ–‡ä»¶é¡¶å±‚ç»‘å®šçš„å¸¸é‡**ï¼ˆé€šå¸¸æ¥è‡ª `Module.logic(($) => ...)` çš„å‚æ•°ï¼‰ï¼›
- ä¸å…è®¸å¯¹ `$` é‡æ–°èµ‹å€¼ï¼›
- ä¸æ¨èå°† `$` ä½œä¸ºæ™®é€šå‡½æ•°å‚æ•°å±‚å±‚ä¼ é€’â€”â€”å°è£…æ¨èä½¿ç”¨ Pattern æˆ– `(input) => Effect` å½¢å¼ï¼›
- Parser åªå¯¹æ»¡è¶³ä¸Šè¿°æ¡ä»¶ã€ä¸”ä½¿ç”¨ **Fluent Intent API (`$.onState` / `$.onAction` / `$.on` + `.update/.mutate/.run*`)** çš„ä»£ç åšç»“æ„åŒ–è§£æï¼Œå…¶ä½™å†™æ³•ç»Ÿä¸€é™çº§ä¸º Gray/Black Boxã€‚

åœ¨ Bound API æ¨¡å¼ä¸‹ï¼š

- ä¸šåŠ¡ä»£ç ä¸»è¦é€šè¿‡ `$.*` è¿›è¡Œç¼–æ’ï¼›
- Intent å‘½åç©ºé—´ï¼ˆ`Intent.*`ï¼‰é€€å±… **IR / å¹³å°åè®®å±‚** ä½¿ç”¨ï¼Œä¸šåŠ¡ä»£ç ä¸å†ç›´æ¥ä¾èµ–ï¼›
- å†…æ ¸ä¸ Pattern å¯ä»¥ä½¿ç”¨ `Logic.RuntimeTag` / `Logix.ModuleTag<Sh>` ç­‰åº•å±‚è®¾æ–½ï¼Œä½†å¯¹ä¸šåŠ¡ Logic éšè—è¿™äº›ç»†èŠ‚ã€‚

> å¿ƒæ™ºæ¨¡å‹å›é¡¾ï¼šåœ¨ `$` å†…éƒ¨ï¼Œ`$.on*` æ‰¿æ‹…â€œæ„ŸçŸ¥ (Perception)â€ï¼Œ`$.flow.*` æ‰¿æ‹…â€œç­–ç•¥ (Strategyï¼Œæ—¶é—´è½´ä¸å¹¶å‘)â€ï¼Œ`$.state / $.actions` æ‰¿æ‹…â€œè¡ŒåŠ¨ (Actuation)â€â€”â€”ä¸‰è€…æ˜¯ä¸€æ¡é“¾è·¯çš„ä¸åŒå±‚é¢ï¼Œè€Œä¸æ˜¯ä¸‰å¥—å½¼æ­¤ç‹¬ç«‹çš„æ¦‚å¿µã€‚

## 2. Logic (The Program)

Logic æ˜¯ä¸€æ®µåœ¨ `Logic.Env<Sh,R>` ä¸Šè¿è¡Œçš„é•¿ç”Ÿå‘½å‘¨æœŸ Effect ç¨‹åºï¼š

```ts
type Env<Sh, R> = Logix.ModuleRuntime<Logix.StateOf<Sh>, Logix.ActionOf<Sh>> & R;
type Fx<Sh, R, A, E> = Effect.Effect<A, E, Env<Sh, R>>;
```

### 2.1 Logic ç¨‹åºï¼ˆv3 æ ‡å‡†èŒƒå¼ï¼‰

v3 å¯¹å¤–æ¨èçš„ Logic å½¢æ€æ˜¯ï¼šåœ¨ `Logic.Env<Sh,R>` ä¸Šè¿è¡Œçš„ä¸€æ®µ `Effect.gen` ç¨‹åºï¼Œ
é€šå¸¸é€šè¿‡ Module.logic æ³¨å…¥ Bound API `$`ï¼š

åœ¨æ¨èèŒƒå¼ä¸‹ï¼ŒLogic ä½œè€…é€šå¸¸é€šè¿‡ `Module.logic(($)=>Effect.gen(...))` ç›´æ¥åœ¨å›è°ƒä¸­ä½¿ç”¨æ³¨å…¥çš„ `$`ï¼›
å¯¹äº Pattern / Namespace ç­‰äºŒæ¬¡å°è£…åœºæ™¯ï¼Œå½“å‰ PoC å»ºè®®ç›´æ¥ä½¿ç”¨ `Logix.BoundApi.make(shape, runtime)` åœ¨å®ç°å±‚æ„é€  `$`ï¼Œå¹¶è®©è°ƒç”¨æ–¹æ˜¾å¼æ³¨å…¥ `$`ã€‚

### 2.2 Logic.Env ä¸ Logic.Of

ä¸ºäº†åœ¨ Patternã€Intent ç­‰åœºæ™¯ä¸­ç²¾ç¡®è¡¨è¾¾ä¸Šä¸‹æ–‡ä¾èµ–ï¼Œv3 å¼•å…¥äº† `Logic.Of` åˆ«åï¼š

```ts
export type Env<Sh extends Logix.ModuleShape<any, any>, R = never> =
  Logix.ModuleTag<Sh> | R;

export type Of<Sh extends Logix.ModuleShape<any, any>, R = never, A = void, E = never> =
  Effect.Effect<A, E, Env<Sh, R>>;
```

çº¦å®šï¼š

- æ‰€æœ‰ä¾èµ–å…·ä½“ Store çš„é•¿é€»è¾‘ï¼ˆåŒ…æ‹¬ Namespace Patternï¼‰éƒ½åº”ä½¿ç”¨ `Logic.Of<Sh,R>` è¡¨è¾¾å…¶ä¸Šä¸‹æ–‡ä¾èµ–ï¼›
- è¿™æ ·å¯ä»¥åœ¨â€œè·¨ Store å¤ç”¨ Patternâ€æ—¶ç”±ç±»å‹ç³»ç»Ÿå…œåº•ï¼Œé¿å…æŠŠé”™è¯¯çš„ Store Runtime æ³¨å…¥ç»™ Patternã€‚

è¦ç‚¹ï¼š

- Bound API çš„æ‰€æœ‰æ–¹æ³•éƒ½åœ¨ç±»å‹ä¸Šæ˜¾å¼ä¾èµ– `Logic.Env<Sh,R>`ï¼Œä¸ä¼šâ€œå·å·â€é€šè¿‡ Tag è·å– Runtimeï¼›
- `$.flow` çš„æ¥å£**ä¸¥æ ¼å¯¹é½** `Flow.Api<Sh,R>`ï¼ˆè§ä¸‹ä¸€èŠ‚ï¼‰ï¼Œåªæ˜¯é¢„å…ˆç»‘å®šäº†å½“å‰ Envï¼Œä¸šåŠ¡ä»£ç åœ¨ç»å¤§å¤šæ•°åœºæ™¯ä¸‹åº”ä¼˜å…ˆé€šè¿‡ Fluent DSL ä½¿ç”¨è¿™äº›èƒ½åŠ›ï¼›
- è·¨ Store åä½œåœºæ™¯ä¸­ï¼Œå¯ä»¥é€šè¿‡æ˜¾å¼ä¼ å…¥ `Logix.ModuleTag<OtherShape>` åˆ›å»ºå…¶ä»– Store çš„è®¿é—®å™¨ï¼Œä½†ä¸šåŠ¡å±‚æ¨èé€šè¿‡ `$.use(ModuleSpec)` + Fluent DSLï¼ˆ`$.on($Other.changes/...).run($SelfOrOther.dispatch)`ï¼‰è¡¨è¾¾ï¼›`Intent.Coordinate` ä»…åœ¨ IR å±‚ç”¨äºæ ‡æ³¨è¯­ä¹‰ã€‚

> è¯´æ˜ï¼šåœ¨ Fluent DSL ä¹‹ä¸Šï¼Œè¿è¡Œæ—¶å¯ä»¥é€‰æ‹©æ€§æä¾› `andThen` ä¹‹ç±»çš„ DX sugarï¼ˆä¾‹å¦‚ `$.onState(...).andThen(handler)`ï¼‰ï¼Œç”¨äºç®€åŒ–æ‰‹å†™ä¸šåŠ¡é€»è¾‘æˆ–ç»™ LLM ä½¿ç”¨ã€‚æ­¤ç±» API ä¸å±äº Fluent ç™½ç›’å­é›†ï¼Œå¹³å°é»˜è®¤å°†å…¶è§†ä¸º Gray/Black Boxï¼›å¦‚éœ€å‚ä¸ IR/å¯è§†åŒ–ï¼Œåº”å…ˆé€šè¿‡ codemod/Agent é™çº§ä¸ºè§„èŒƒçš„ `.update/.mutate/.run*` å½¢æ€ã€‚

## 3. Flow (The Time & Concurrency Layer)

Flow è´Ÿè´£å›´ç»•é¢†åŸŸæ¨¡å—çš„è¿è¡Œæ—¶å®¹å™¨æ„é€ æ—¶é—´è½´ä¸å¹¶å‘è¯­ä¹‰ï¼Œå…¶èŒè´£æ˜¯å›ç­”ï¼š
**â€œä»€ä¹ˆæ—¶å€™è§¦å‘ï¼Ÿä»¥ä½•ç§å¹¶å‘è¯­ä¹‰æ‰§è¡Œï¼Ÿâ€**

åœ¨ v3 ä¸­ï¼š

- ä¸šåŠ¡ä»£ç ä¼˜å…ˆä½¿ç”¨ **`$.onState` / `$.onAction` / `$.on + .update/.mutate/.run*`** è¿™å¥— Fluent DSLï¼›
- åº•å±‚åº“ / Pattern å†…éƒ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ `Flow.*` å‘½åç©ºé—´çº§ DSL ä¸ `Control.*` ç»„åˆï¼Œå°† ModuleRuntime æš´éœ²ä¸º Stream æºï¼›
- `$.flow.*` ä¸»è¦ä½œä¸º Bound API ä¸Šçš„é€ƒç”Ÿèˆ±å’Œé«˜çº§ç”¨æ³•å…¥å£ï¼Œä¸€èˆ¬ä¸šåŠ¡åœºæ™¯ä¸æ¨èç›´æ¥ä½¿ç”¨ï¼›å…¶æ¥å£ä¸ `Flow.Api` ä¸€è‡´ï¼Œåªæ˜¯é¢„ç»‘å®šäº†å½“å‰ Envã€‚

### 3.1 è§¦å‘æº (Triggers)

```ts
// ä» Action æµä¸­ç­›é€‰æŸä¸€ç±» Actionï¼ˆé€šå¸¸ä½¿ç”¨ç±»å‹å®ˆå«ï¼‰
$.flow.fromAction((a): a is SubmitAction => a._tag === "submit");

// ä» State çš„æŸä¸ª selector æ„é€ å˜åŒ–æµ
$.flow.fromState(s => s.form.keyword);
```

### 3.2 å˜æ¢ä¸è¿‡æ»¤ (Transformers)

```ts
$.flow.debounce(300);                     // é˜²æŠ–
$.flow.throttle(500);                     // èŠ‚æµ
$.flow.filter(keyword => keyword !== ""); // è¿‡æ»¤
```

è¿™äº›ç®—å­éƒ½æ˜¯ `Stream -> Stream` çš„å˜æ¢ï¼Œå¹³å°å¯ä»¥å°†å®ƒä»¬æ¸²æŸ“ä¸ºä¸­é—´å¤„ç†èŠ‚ç‚¹ï¼ˆè®¡æ—¶å™¨ã€æ¼æ–—ç­‰ï¼‰ã€‚

### 3.3 è¿è¡Œç­–ç•¥ (Runners)

```ts
// ä¸²è¡Œï¼šé»˜è®¤é€ä¸ªå¤„ç†äº‹ä»¶ï¼ˆå• watcher å†…é¡ºåºæ‰§è¡Œï¼‰
$.flow.run(effect);

// å¹¶è¡Œï¼šæ˜¾å¼æ— ç•Œå¹¶å‘ï¼Œé€‚ç”¨äºæ—¥å¿—/æ‰“ç‚¹ç­‰é«˜ååå‰¯ä½œç”¨
$.flow.runParallel(effect);

// æœ€æ–°ï¼šåè§¦å‘çš„ Effect ä¼šå–æ¶ˆä»åœ¨æ‰§è¡Œçš„æ—§ Effectï¼ˆå…¸å‹æœç´¢è”åŠ¨ï¼‰
$.flow.runLatest(effect);

// é˜»å¡ï¼šå½“å‰ Effect å°šæœªå®Œæˆæ—¶ç›´æ¥ä¸¢å¼ƒæ–°çš„è§¦å‘ï¼ˆé˜²é‡å¤æäº¤ï¼‰
$.flow.runExhaust(effect);

// ä¸²è¡Œï¼šæŒ‰è§¦å‘é¡ºåºæ’é˜Ÿï¼Œä¸€ä¸ªå®Œæˆåæ‰æ‰§è¡Œä¸‹ä¸€ä¸ªï¼ˆé»˜è®¤è¯­ä¹‰ï¼‰
$.flow.run(effect);
```

æ‰€æœ‰ `run*` çš„ç±»å‹å½¢æ€ç»Ÿä¸€ä¸ºï¼š

```ts
run*<A, E, R2>(
  eff: Effect.Effect<A, E, R2>,
): (stream: Stream.Stream<any>) => Effect.Effect<void, E, R2>;
```

å³ä¿ç•™ Effect çš„é”™è¯¯é€šé“ä¸ç¯å¢ƒç±»å‹ï¼Œåªæ”¹å˜å…¶ä¸ºâ€œæŒ‚åœ¨æŸä¸ªæµä¸Šçš„æ‰§è¡Œå™¨â€ã€‚

> å®ç°è¯´æ˜ï¼ˆä¸å½“å‰ PoC å¯¹é½ï¼‰
> - åœ¨æ¨èå®ç°ä¸­ï¼Œ`$.flow.run` ä½¿ç”¨ `Stream.runForEach` æ¶ˆè´¹æºæµï¼Œä¿è¯åŒä¸€æ¡ watcher å†…çš„ Effect ä¸²è¡Œæ‰§è¡Œï¼›
> - `$.flow.runParallel` ä½¿ç”¨ `Stream.mapEffect(..., { concurrency: "unbounded" })` + `Stream.runDrain` å®ç°æ˜¾å¼æ— ç•Œå¹¶å‘ï¼›
> - å…¶ä½™ `run*` å˜ä½“é€šè¿‡å†…éƒ¨çŠ¶æ€ï¼ˆå¦‚ latest/exhaust/queueï¼‰æ§åˆ¶åœ¨å• watcher å†…çš„å¹¶å‘è¯­ä¹‰ï¼›
> - Fluent APIï¼ˆ`$.onState / $.onAction / $.on`ï¼‰ä¸Šçš„ `.update/.mutate/.run*` åœ¨è¯­ä¹‰ä¸Šå¿…é¡»ç­‰ä»·äºâ€œå…ˆé€šè¿‡ `$.flow.from*` æ‹¿åˆ°æºæµï¼Œå†ä¸²ä¸Šç›¸åº”çš„ `Flow.run*` æˆ–ç›´æ¥è¿›è¡Œ `Stream.runForEach + state.update`â€ï¼Œ
> - **ä¸è¦æ±‚æœºæ¢°åœ°é€šè¿‡ Flow.Api ç»„åˆå®ç°**ï¼Œä½†è¦æ±‚é”™è¯¯è¯­ä¹‰ã€å¹¶å‘è¯­ä¹‰ä¸ä¸Šè¿° `Flow.run*` æè¿°ä¿æŒä¸€è‡´ï¼Œä¾¿äº Parser ä¸ DevTools åœ¨è¿™ä¸¤å±‚ä¹‹é—´å»ºç«‹ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚

## 4. Intent (L1/L2 IR Semantics)

åœ¨ Flow / Control ä¹‹ä¸Šï¼ŒLogix ä½¿ç”¨ **IntentRule IR** æ‰¿è½½é«˜é¢‘ä¸šåŠ¡è”åŠ¨æ¨¡å¼ï¼ˆL1/L2ï¼‰ï¼š
- ä¸šåŠ¡ä»£ç é€šè¿‡ Fluent DSLï¼ˆ`$.onState` / `$.onAction` / `$.on` + `$.state` / `StoreHandle.dispatch`ï¼‰è¡¨è¾¾è§„åˆ™ï¼›
- å¹³å° Parser å°†è¿™äº› Fluent é“¾è¿˜åŸä¸ºç»“æ„åŒ–çš„ IntentRuleï¼Œä¸å†éœ€è¦ç‹¬ç«‹çš„ `Intent.*` è¿è¡Œæ—¶å‘½åç©ºé—´ã€‚

> ä½¿ç”¨ä¼˜å…ˆçº§ï¼ˆä»£ç è§†è§’ï¼‰
> - **é¦–é€‰**ï¼š`$`ï¼ˆBound APIï¼ŒåŒ…æ‹¬ `$.state` / `$.actions` / `$.use` / `$.on*` / `$.match`ï¼‰ï¼›
> - åº“ / Pattern å†…éƒ¨ï¼š`Flow.*` / `Control.*`ï¼ˆL3 Libraryï¼‰é…åˆåº•å±‚ `Logix.ModuleRuntime`ï¼›
> - IR / å¹³å°åè®®ï¼š`IntentRule`ï¼ˆL1/L2 è§„åˆ™çš„ç»Ÿä¸€è¡¨ç¤ºï¼ŒåŒ…å« source/pipeline/sink/kind ç­‰å­—æ®µï¼‰ï¼Œä¸å†å•ç‹¬å®šä¹‰ `Intent.*` å‘½åç©ºé—´ã€‚

### 4.1 L1ï¼šå• Store å†…è”åŠ¨ï¼ˆIR è§†è§’ï¼‰

L1 IntentRule è´Ÿè´£æŠ½è±¡è¡¨è¾¾å• Store å†…éƒ¨çš„åŒæ­¥è”åŠ¨ï¼Œå…¶ä»£ç ä¾§æ¨èå†™æ³•æ˜¯ Fluent DSLï¼š

```ts
// å­—æ®µè”åŠ¨ï¼šState -> Stateï¼ˆä¸šåŠ¡å†™æ³•ï¼‰
yield* $.onState<MyShape>((s) => s.country)
  .mutate((draft) => {
    draft.province = ""
  })
```

æŠ½è±¡è¯­ä¹‰ä¸å˜ï¼š

- â€œç›‘å¬æŸä¸ª State è§†å›¾çš„å˜åŒ–ï¼Œå¹¶åœ¨æ¯æ¬¡å˜åŒ–æ—¶æ›´æ–°å½“å‰ Store çš„ Stateâ€ã€‚

### 4.2 L2ï¼šè·¨ Store åä½œï¼ˆCoordinate IntentRuleï¼‰

L2 IntentRuleï¼ˆCoordinateï¼‰ç”¨äºè¡¨è¾¾è·¨ Store çš„æ ‡å‡†åä½œæ¨¡å¼ï¼Œä¾‹å¦‚ Search â†’ Detailã€‚
ä»£ç ä¾§æ¨èå†™æ³•æ˜¯é€šè¿‡ `$.use` è·å–è¿œç«¯ StoreHandle + Fluent DSLï¼š

```ts
// ä¸šåŠ¡ä»£ç ï¼ˆFluent å†™æ³•ï¼‰
const $Search = yield* $.use(Search)
const $Detail = yield* $.use(Detail)

yield* $.on($Search.changes((s) => s.results))
  .filter((results) => results.length > 0)
  .run(
    Effect.gen(function* () {
      yield* $Detail.dispatch({ _tag: "detail/initialize", payload: /* ... */ })
    })
  )
```

åœ¨ IR ä¸­ï¼Œè¿™ä¸€è§„åˆ™ä¼šè¢«å½’çº³ä¸ºä¸€æ¡ L2 IntentRuleï¼Œ`source.context = SearchStoreId`ï¼Œ`sink.context = DetailStoreId`ï¼Œ`pipeline/sink.handler` åˆ†åˆ«åæ˜  filter ä¸ dispatch é€»è¾‘ã€‚

> çº¦å®š
> - v3 ä¸­ä¸å†å®šä¹‰å•ç‹¬çš„ `Intent` è¿è¡Œæ—¶å‘½åç©ºé—´ï¼›
> - ä¸šåŠ¡ä»£ç ä¸€å¾‹é€šè¿‡ Fluent DSLï¼ˆ`$.onState` / `$.onAction` / `$.on` + `.update/.mutate/.run*`ï¼‰è¡¨è¾¾è§„åˆ™ï¼Œç”± Parser è´Ÿè´£ç”Ÿæˆ/æ›´æ–°å¯¹åº”çš„ IntentRuleï¼›
> - å¹³å°/å·¥å…·åœ¨ IR å±‚åªæ“ä½œ `IntentRule` ç»“æ„ï¼Œè€Œä¸æ˜¯æŸä¸ª `Intent.*` APIã€‚

## 5. Control (The Structure Layer)

v3 **ä¸å†æä¾›** ä¸“é—¨çš„ `$.control` å‘½åç©ºé—´ã€‚
æˆ‘ä»¬è®¤ä¸º Effect åŸç”Ÿç®—å­ + `$.match` è¯­æ³•ç³–å·²ç»è¶³å¤Ÿè¡¨è¾¾æ‰€æœ‰ç»“æ„åŒ–é€»è¾‘ï¼Œå¹³å° Parser å°†ç›´æ¥è¯†åˆ«è¿™äº›åŸç”Ÿæ¨¡å¼ï¼š

### 5.1 åˆ†æ”¯ (Branching)

ä½¿ç”¨ `$.match` / `$.matchTag` (Fluent Match)ï¼š

```ts
yield* $.match(isValid)
  .when(true, () => doSomething)
  .tag("cancel", (a) => handleCancel(a))
  .exhaustive();
```

> **Best Practice**: ä¸ºäº†å……åˆ†åˆ©ç”¨ `$.matchTag` çš„ç±»å‹æ”¶çª„èƒ½åŠ›ï¼Œæ¨èå°† Action å®šä¹‰ä¸º **Tagged Union** (å³åŒ…å« `_tag` åˆ¤åˆ«å­—æ®µçš„è”åˆç±»å‹)ã€‚è¿™ä¸ä»…ç¬¦åˆ Effect ç”Ÿæ€æƒ¯ä¾‹ï¼Œä¹Ÿèƒ½è·å¾—æœ€ä½³çš„ IDE è¡¥å…¨ä½“éªŒã€‚

å¹³å°ä¼šå°†ä¸Šè¿° `$.match` é“¾å¼ç»“æ„è¯†åˆ«ä¸º **Switch/Case åˆ†æ”¯èŠ‚ç‚¹**ã€‚

### 5.2 é”™è¯¯è¾¹ç•Œ (Error Boundaries)

ç›´æ¥ä½¿ç”¨ `Effect.catch*` ç³»åˆ—ç®—å­ï¼š

```ts
yield* runApprovalFlow.pipe(
  Effect.catchTag("ApprovalError", (err) =>
    $.state.update(s => ({ ...s, error: err.message }))
  )
);
```

å¹³å°å°†è¯†åˆ« `Effect.catch*` ä¸º **Error Boundary èŠ‚ç‚¹**ã€‚

### 5.3 å¹¶å‘ (Concurrency)

ç›´æ¥ä½¿ç”¨ `Effect.all`ï¼š

```ts
yield* Effect.all([taskA, taskB], { concurrency: "unbounded" });
```

å¹³å°å°†è¯†åˆ« `Effect.all` ä¸º **Parallel Group èŠ‚ç‚¹**ã€‚

## 6. é•¿é€»è¾‘ä¸ Scopeï¼ˆç®€è¦çº¦å®šï¼‰

åœ¨ `Logic` ä¸­å¯åŠ¨é•¿é€»è¾‘æ—¶ï¼Œæ¨èæ˜¾å¼è€ƒè™‘å®ƒåº”å½“ä¸å“ªä¸€å±‚ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼š

- `forkScoped(longTask)`ï¼š
  - é€‚åˆä¸å½“å‰ Store / é¡µé¢åŒç”Ÿå‘½å‘¨æœŸçš„ UI é€»è¾‘ï¼ˆä¾‹å¦‚è½®è¯¢å½“å‰è§†å›¾ã€ç›‘å¬å½“å‰é¡µé¢çŠ¶æ€å˜åŒ–ï¼‰ï¼›
  - ä¾èµ– `Store` / é¡µé¢ Scopeï¼Œè¢«è§†ä¸ºâ€œå‰å°ä»»åŠ¡â€ï¼ŒStore Scope å…³é—­æ—¶è‡ªåŠ¨ç»ˆæ­¢ã€‚

- `fork(longTask)` æˆ–äº¤ç»™ä¸Šå±‚ Runtimeï¼š
  - é€‚åˆä¸å…·ä½“é¡µé¢è§£è€¦çš„åå°ä»»åŠ¡ï¼ˆä¾‹å¦‚å…¨å±€ Job è½®è¯¢ã€ç¼“å­˜åˆ·æ–°ï¼‰ï¼›
  - ä¾èµ–æ›´é«˜å±‚çš„ Runtime Scopeï¼Œä¸éšå•ä¸ª Store / é¡µé¢é”€æ¯è‡ªåŠ¨ç»“æŸã€‚

å®è·µä¸Šå»ºè®®ï¼š

- é¡µé¢ / ç»„ä»¶çº§ Storeï¼šLogic å†…é•¿é€»è¾‘é»˜è®¤ä½¿ç”¨ `forkScoped`ï¼Œé¿å…â€œé¡µé¢å…³é—­ä½†ä»»åŠ¡ä»ç„¶æŒæœ‰è¿‡æœŸçŠ¶æ€â€ï¼›
- å…¨å±€ Store æˆ–ä¸“é—¨çš„åå° Runtimeï¼šéœ€è¦é•¿æœŸè¿è¡Œçš„ä»»åŠ¡æ˜¾å¼ä½¿ç”¨ `fork` æˆ–åœ¨å•ç‹¬çš„åå° Scope ä¸­ç®¡ç†ã€‚

## 7. ä¸åŸç”Ÿ Effect çš„å…³ç³»

- å¯¹å¼€å‘è€…è€Œè¨€ï¼Œ`$.flow.*` åªæ˜¯å›´ç»• Effect / Stream å°è£…çš„ä¸€ç»„â€œè¯­ä¹‰åŒ–æ ‡å‡†ç®—å­â€ï¼Œç”¨æ¥æ‰¿è½½ï¼š
  - Trigger / æ—¶é—´ / å¹¶å‘ç­–ç•¥ï¼ˆFlowï¼‰ï¼›
  - åˆ†æ”¯ / é”™è¯¯è¾¹ç•Œ / å¹¶è¡Œç»“æ„ï¼ˆControlï¼‰ã€‚
- ä»»ä½•ç»†èŠ‚æ€§çš„é€»è¾‘ï¼ˆ`map / flatMap / zip / forEach / race` ç­‰ï¼‰ä»ç„¶é¼“åŠ±ç›´æ¥ä½¿ç”¨ `Effect.* / Stream.*`ï¼Œå¹³å°åœ¨é™æ€åˆ†ææ—¶ä¼šå°†è¿™éƒ¨åˆ†è§†ä¸º Gray/Black Boxã€‚
- å¯¹å¹³å°è€Œè¨€ï¼Œè¿™äº›ç®—å­æä¾›äº†ç¨³å®šçš„ AST é”šç‚¹ï¼Œå¯ä»¥åœ¨ä¸æ‰§è¡Œä»£ç çš„å‰æä¸‹æ„å»º Logic Graphã€‚

## 8. Fluent DSL çš„ Hard Constraintsï¼ˆParser ä¿éšœå­é›†ï¼‰

ä¸ºäº†ä¿è¯å¹³å°è§£æçš„é²æ£’æ€§ï¼Œv3 å¯¹ Fluent DSL åˆ¶å®šäº†æ˜ç¡®çš„â€œç™½ç›’å­é›†â€çº¦æŸï¼š

1.  **è§¦å‘ API åˆ†æ‹†**
    -   æœ¬åœ° Stateï¼šä½¿ç”¨ `$.onState(selector)`ï¼Œè¯­ä¹‰ç­‰ä»·äº `$.flow.fromState(selector)`ï¼›
    -   æœ¬åœ° Actionï¼šä½¿ç”¨ `$.onAction(predicate)`ï¼Œè¯­ä¹‰ç­‰ä»·äº `$.flow.fromAction(predicate)`ï¼›
    -   ä»»æ„ Streamï¼ˆå«è·¨ Storeï¼‰ï¼šä½¿ç”¨ `$.on(stream)`ï¼Œå…¸å‹ç”¨æ³•æ˜¯ `$.on($Other.changes(...))`ã€‚
    ç°åœ¨é€šè¿‡ `$.onState` / `$.onAction` / `$.on` ä¸‰ä¸ªç‹¬ç«‹APIæ˜ç¡®åŒºåˆ†ï¼ŒParser æ— éœ€æ¨æ–­å‚æ•°ç±»å‹ã€‚

2.  **StoreHandle èƒ½åŠ›è¾¹ç•Œ**
    -   `$.use(ModuleSpec)` è¿”å›çš„å¥æŸ„ä»…æš´éœ²ï¼š`read(selector?)` / `changes(selector)` / `dispatch(action)`ï¼›
    -   `mutate` / `update` ç­‰å†™æ¥å£åªå­˜åœ¨äº **å½“å‰ Store çš„ `$.state`** ä¸­ï¼›
    -   ä»»ä½•è·¨ Store ç›´æ¥å†™å…¥ä»–åº“ State çš„è¡Œä¸ºåœ¨ v3 ä¸­è¢«è§†ä¸ºè¿åè¿è¡Œæ—¶å¥‘çº¦ã€‚

3.  **ç™½ç›’æ¨¡å¼çš„ç»“æ„çº¦æŸ**
    -   Parser åªå¯¹å½¢å¦‚ `yield* $.onState(...).op1().op2().update/mutate/run*(...)` / `yield* $.onAction(...).op().update/mutate/run*(...)` / `yield* $.on(stream).op().run*(...)` çš„ **å•è¯­å¥ç›´æ¥è°ƒç”¨** æä¾›ç»“æ„åŒ–è§£æï¼›
    -   ä¸€æ—¦å°† Fluent é“¾æ‹†è§£ä¸ºä¸­é—´å˜é‡æˆ–é—­åŒ…åŒ…è£…ï¼ˆä¾‹å¦‚ `const flow = $.onState(...).op(); yield* flow.run(effect)`ï¼‰ï¼Œè¯¥æ®µä»£ç å³è¢«è§†ä¸º Raw Modeï¼ˆé»‘ç›’ï¼‰ã€‚

4.  **Intent.IR çš„ç”Ÿæˆè·¯å¾„**
    -   ç™½ç›’ Fluent è§„åˆ™ä¼šè¢«æ˜ å°„ä¸º IntentRule IRï¼ˆåŒ…æ‹¬ L1/L2 ç­‰è§„åˆ™å½¢æ€ï¼‰ï¼ŒIntent ä¸å†ä»¥å•ç‹¬å‘½åç©ºé—´å½¢å¼å‡ºç°ï¼›
    -   Raw Modeï¼ˆè£¸ `flow.pipe` / å¤æ‚ `Effect.gen`ï¼‰ä¸ä¼šå¼ºè¡Œè¿˜åŸä¸º IntentRuleï¼Œè€Œæ˜¯ä»¥ Code Block å½¢å¼å‡ºç°åœ¨ Logic Graph ä¸­ã€‚

ä¸Šè¿°çº¦æŸæ˜¯ v3 çš„â€œç¼–è¯‘æœŸå¥‘çº¦â€ï¼š
- ä¸šåŠ¡å±‚è‹¥éµå®ˆè¿™äº›å†™æ³•ï¼Œå¯ä»¥è·å¾—ç¨³å®šçš„ç±»å‹æ¨å¯¼ä¸å¹³å°å¯è§†åŒ–æ”¯æŒï¼›
- runtime-logix ä¸å¹³å°å®ç°åˆ™å¯ä»¥åœ¨è¿™äº› Hard Constraints åŸºç¡€ä¸Šç®€åŒ–å®ç°ï¼Œå¹¶åœ¨è¿åçº¦æŸæ—¶ç»™å‡ºæ¸…æ™°çš„è¯Šæ–­æç¤ºã€‚

## 9. ä» Module åˆ° IntentRuleï¼šä¸€æ¡æ ‡å‡†é“¾è·¯ï¼ˆä½“éªŒè§†è§’ï¼‰

ä¸ºäº†å¸®åŠ©ä½¿ç”¨è€…å¿«é€Ÿå»ºç«‹æ•´ä½“å¿ƒæ™ºï¼Œå¯ä»¥å°† Logix v3 çš„â€œä¸»é“¾è·¯â€ç†è§£ä¸ºï¼š

> **å®šä¹‰ Module â†’ ç¼–å†™ Logicï¼ˆ`Module.logic(($)=>...)` + Fluent DSLï¼‰â†’ åœ¨å…¶ä»– Logic ä¸­é€šè¿‡ `$.use(Module)` åä½œ â†’ å¹³å°ä» Fluent é“¾ç”Ÿæˆ IntentRuleã€‚**

ä¸€ä¸ªå…¸å‹çš„æœ€å°ç¤ºä¾‹ï¼š

```ts
// 1. å®šä¹‰é¢†åŸŸæ¨¡å—ï¼ˆModuleï¼‰
const CounterState = Schema.Struct({ count: Schema.Number });
const CounterAction = {
  inc: Schema.Void,
  dec: Schema.Void,
};

export const Counter = Logix.Module('Counter', {
  state: CounterState,
  actions: {
    inc: Schema.Void,
    dec: Schema.Void,
  },
});

// 2. åœ¨ Module ä¸Šç¼–å†™ Logicï¼ˆé€šè¿‡ Module.logic æ³¨å…¥ $ï¼‰
export const CounterLogic = Counter.logic(($) =>
  Effect.gen(function* () {
    // Action â†’ Stateï¼šåŸºäº Action æ›´æ–° count
    yield* $.onAction(
      (a): a is { _tag: 'inc' } => a._tag === 'inc',
    ).update((prev) => ({ ...prev, count: prev.count + 1 }));

    // State â†’ Stateï¼šåŸºäº count å˜åŒ–æ´¾ç”Ÿ hasPositiveï¼ˆç¤ºæ„ï¼‰
    yield* $.onState((s) => s.count).update((prev) => ({
      ...prev,
      hasPositive: prev.count > 0,
    }));
  }),
);

// 3. åœ¨å…¶ä»– Logic ä¸­é€šè¿‡ $.use(Counter) åä½œï¼ˆè·¨ Moduleï¼‰
export const SomeOtherLogic = OtherModule.logic(($) =>
  Effect.gen(function* () {
    const $Counter = yield* $.use(Counter); // é¢†åŸŸåªè¯»å¥æŸ„

    yield* $.on($Counter.changes((s) => s.count))
      .filter((count) => count > 10)
      .update((prev) => ({ ...prev, showCongrats: true }));
  }),
);
```

åœ¨è¿™ä¸€æ¨¡å¼ä¸‹ï¼š

- **Module** æ˜¯é¢†åŸŸä¸–ç•Œçš„â€œå®šä¹‰æ ¹â€ï¼šç»Ÿä¸€æ‰¿è½½ Id / Schema / Runtime Tag / Logic å…¥å£ï¼›
- æ‰€æœ‰ä¸šåŠ¡ Logic éƒ½é€šè¿‡ `Module.logic(($)=>Effect.gen(...))` æ³¨å…¥ `$`ï¼Œå½¢æˆç»Ÿä¸€çš„ç¼–ç¨‹ä½“éªŒï¼›
- è·¨ Module åä½œç»Ÿä¸€é€šè¿‡ `$.use(Module)` è·å–åªè¯»å¥æŸ„ï¼Œå†é…åˆ Fluent DSL è¡¨è¾¾è§„åˆ™ï¼›
- å¹³å°åªéœ€è¯†åˆ« `Module` + Fluent é“¾ï¼Œå³å¯æ¢å¤ L1 / L2 IntentRuleâ€”â€”å¼€å‘è€…ä¸éœ€è¦å…³å¿ƒ IntentRule ç»“æ„ç»†èŠ‚ï¼Œä¹Ÿä¸éœ€è¦æ“å¿ƒ Tag/Env çš„ç»†èŠ‚ã€‚
</file>

<file path="runtime-logix/core/04-logic-middleware.md">
# Logic Middleware & `Logic.secure`

> **Status**: v3.1 Canonical (Core Spec)
> **Scope**: Logic Middleware çš„æ ¸å¿ƒå®šä¹‰ã€`Logic.secure` API å¥‘çº¦ä¸å®‰å…¨æ¨¡å‹ã€‚

æœ¬ç¯‡å®šä¹‰äº† v3 è¿è¡Œæ—¶ä¸­ç”¨äºå¤„ç†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆCross-Cutting Concernsï¼Œå¦‚é‰´æƒã€æ—¥å¿—ã€åŸ‹ç‚¹ï¼‰çš„æ ‡å‡†æœºåˆ¶ã€‚

æ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š**Explicit Composition (æ˜¾å¼ç»„åˆ)** â€”â€” å®‰å…¨ä¸æ˜¯â€œè‡ªåŠ¨å‘ç”Ÿâ€çš„é­”æ³•ï¼Œè€Œæ˜¯é€šè¿‡ç±»å‹ç³»ç»Ÿå¼ºåˆ¶è¦æ±‚çš„æ˜¾å¼å¥‘çº¦ã€‚

---

## 1. æ ¸å¿ƒç±»å‹å®šä¹‰

### 1.1 `LogicMeta`

æè¿°ä¸€æ®µ Logic ç¨‹åºçš„å…ƒæ•°æ®ï¼Œä¾›ä¸­é—´ä»¶æ¶ˆè´¹ã€‚

```ts
export interface LogicMeta {
  readonly name: string      // é€»è¾‘åç§° (e.g. "submitOrder")
  readonly storeId?: string  // æ‰€å± Store ID
  readonly action?: unknown  // è§¦å‘è¯¥é€»è¾‘çš„ Action (å¦‚æœ‰)
  readonly tags?: string[]   // è‡ªå®šä¹‰æ ‡ç­¾ (e.g. ["audit", "auth"])
  readonly [key: string]: unknown // å…è®¸æ‰©å±•
}
```

### 1.2 `Logic.Middleware`

ä¸­é—´ä»¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **Endomorphism (è‡ªåŒæ€)**ï¼šå®ƒæ¥æ”¶ä¸€ä¸ª Effectï¼Œè¿”å›ä¸€ä¸ªç›¸åŒç±»å‹ç­¾åçš„ Effectã€‚
è¿™æ„å‘³ç€ä¸­é—´ä»¶**ä¸åº”æ”¹å˜**ä¸šåŠ¡é€»è¾‘çš„æˆåŠŸå€¼ (A) æˆ–é”™è¯¯ç±»å‹ (E)ï¼Œä¹Ÿä¸åº”å¼•å…¥ä¸šåŠ¡å±‚æœªçŸ¥çš„ç¯å¢ƒä¾èµ– (R)ã€‚

```ts
import { Effect } from "effect"

export type Middleware<Sh, R, A, E> = (
  effect: Effect.Effect<A, E, Logic.Env<Sh, R>>,
  meta: LogicMeta
) => Effect.Effect<A, E, Logic.Env<Sh, R>>
```

> **æ³¨æ„**ï¼šå¦‚æœä¸­é—´ä»¶éœ€è¦æ³¨å…¥é¢å¤–çš„æœåŠ¡ï¼ˆå¦‚ `AuditService`ï¼‰ï¼Œè¯¥æœåŠ¡å¿…é¡»åŒ…å«åœ¨ Logic çš„ç¯å¢ƒ `R` ä¸­ï¼Œæˆ–è€…ç”±ä¸­é—´ä»¶è‡ªè¡Œ `provide`ã€‚

---

## 2. å®‰å…¨æ¨¡å‹ï¼š`Logic.secure`

ä¸ºäº†é˜²æ­¢ä¸šåŠ¡é€»è¾‘â€œè£¸å¥”â€ï¼ˆå³å¿˜è®°æŒ‚è½½å¿…è¦çš„é‰´æƒæˆ–å®¡è®¡ä¸­é—´ä»¶ï¼‰ï¼Œv3 å¼•å…¥äº† **Branded Type** æœºåˆ¶ã€‚

### 2.1 `Logic.Secured` (Branded Type)

`Logic.Secured` æ˜¯ä¸€ä¸ªå¸¦æœ‰ç‰¹æ®Šæ ‡è®°çš„ Effect ç±»å‹ã€‚åªæœ‰é€šè¿‡ `Logic.secure` åŒ…è£…è¿‡çš„ Effect æ‰èƒ½è·å¾—æ­¤æ ‡è®°ã€‚

```ts
declare const Secured: unique symbol

export type Secured<Sh, R, A, E> =
  Effect.Effect<A, E, Logic.Env<Sh, R>> & { readonly [Secured]: true }
```

### 2.2 `Logic.secure` API

è¿™æ˜¯è·å– `Logic.Secured` çš„**å”¯ä¸€åˆæ³•å…¥å£**ã€‚

```ts
export namespace Logic {
  export function secure<Sh, R, A, E>(
    effect: Effect.Effect<A, E, Logic.Env<Sh, R>>,
    meta: LogicMeta,
    ...middlewares: Middleware<Sh, R, A, E>[]
  ): Secured<Sh, R, A, E> {
    // 1. ç»„åˆæ‰€æœ‰ä¸­é—´ä»¶ (æ´‹è‘±æ¨¡å‹ï¼šmiddlewares[0] åœ¨æœ€å¤–å±‚)
    const composed = middlewares.reduceRight(
      (acc, mw) => mw(acc, meta),
      effect
    )

    // 2. æ ‡è®°ä¸º Secured
    return composed as Secured<Sh, R, A, E>
  }
}
```

### 2.3 è¿è¡Œæ—¶å¼ºåˆ¶

`$.flow.run` ç­‰è¿è¡Œæ—¶ API çš„ç­¾åè¢«è®¾è®¡ä¸º**åªæ¥å— `Logic.Secured`**ï¼š

```ts
interface FlowApi<Sh, R> {
  // ç¼–è¯‘é”™è¯¯ï¼šç±»å‹ 'Effect<...>' ç¼ºå°‘å±æ€§ '[Secured]'
  run<A, E>(eff: Logic.Secured<Sh, R, A, E>): Effect.Effect<void, never, Logic.Env<Sh, R>>
}
```

è¿™æ„å‘³ç€ï¼š**ä½ æ— æ³•è¿è¡Œä¸€ä¸ªæ²¡æœ‰è¢« `Logic.secure` æ˜¾å¼å£°æ˜è¿‡çš„ Logicã€‚**

---

## 3. ä½¿ç”¨ç¤ºä¾‹

```ts
// 1. å®šä¹‰ä¸­é—´ä»¶
const WithLogging: Logic.Middleware<any, any, any, any> = (next, meta) =>
  Effect.log(`[${meta.name}] Start`).pipe(
    Effect.zipRight(next),
    Effect.zipLeft(Effect.log(`[${meta.name}] End`))
  )

const WithAuth: Logic.Middleware<any, any, any, any> = (next, meta) =>
  // å‡è®¾ AuthService åœ¨ç¯å¢ƒ R ä¸­
  AuthService.check(meta.tags).pipe(
    Effect.zipRight(next)
  )

// 2. ä¸šåŠ¡é€»è¾‘
const deleteUser = Effect.gen(function*() {
  // ... æ ¸å¿ƒä¸šåŠ¡ ...
})

// 3. å®‰å…¨ç»„è£…
yield* $.flow.fromAction("delete").pipe(
  $.flow.run(
    // å¿…é¡»è°ƒç”¨ Logic.secureï¼Œå¦åˆ™ç¼–è¯‘æŠ¥é”™
    Logic.secure(
      deleteUser,
      { name: "deleteUser", tags: ["admin"] },
      WithAuth,    // å…ˆé‰´æƒ
      WithLogging  // åæ—¥å¿—
    )
  )
)
```

## 4. ä¸ºä»€ä¹ˆä¸è‡ªåŠ¨æ³¨å…¥ï¼Ÿ

v3 é€‰æ‹© **Explicit Composition** è€Œéè‡ªåŠ¨æ³¨å…¥ï¼ˆå¦‚ AOP æ¡†æ¶å¸¸è§çš„ `Module.use(Middleware)`ï¼‰ï¼ŒåŸå› å¦‚ä¸‹ï¼š

1.  **ç±»å‹å®‰å…¨**ï¼šè‡ªåŠ¨æ³¨å…¥å¾€å¾€ä¾èµ– `any` æˆ–å¤æ‚çš„ç±»å‹ä½“æ“ï¼Œéš¾ä»¥æ¨å¯¼ä¸­é—´ä»¶å¯¹ R/E çš„å½±å“ã€‚
2.  **å¯è¯»æ€§**ï¼šåœ¨ä»£ç  review æ—¶ï¼Œèƒ½æ˜ç¡®çœ‹åˆ°ä¸€æ®µé€»è¾‘ç»è¿‡äº†å“ªäº›å¤„ç†ã€‚
3.  **ç²’åº¦æ§åˆ¶**ï¼šä¸åŒçš„ Logic å¯èƒ½éœ€è¦ä¸åŒçš„ä¸­é—´ä»¶ç»„åˆï¼ˆä¾‹å¦‚ `login` ä¸éœ€è¦ `AuthGuard`ï¼Œä½† `deleteUser` éœ€è¦ï¼‰ã€‚
4.  **Codegen å‹å¥½**ï¼šå¹³å°å¯ä»¥é€šè¿‡é™æ€åˆ†æç”Ÿæˆ `Logic.secure` ä»£ç ï¼Œæ—¢ä¿ç•™äº†çµæ´»æ€§ï¼Œåˆå¯ä»¥é€šè¿‡å·¥å…·ä¿è¯è§„èŒƒæ€§ã€‚
</file>

<file path="runtime-logix/core/04-pattern.md">
# Pattern (Pattern-Style Logic & Assets)

> **Status**: Definitive (v3 Effect-Native)
> **Date**: 2025-11-26
> **Scope**: Logix Asset System (Platform View)
> **Audience**: åº“ä½œè€… / Pattern ä½œè€… / å¹³å°è§£æå™¨å®ç°è€…ï¼›æ™®é€šä¸šåŠ¡å¼€å‘è€…é€šå¸¸åªâ€œä½¿ç”¨â€å·²ç»å‘å¸ƒçš„ Patternã€‚

æœ¬èŠ‚ä»â€œå¹³å°èµ„äº§â€çš„è§†è§’æè¿° Pattern çš„è§’è‰²ã€‚
åœ¨ v3 è¿è¡Œæ—¶å®ç°ä¸­ï¼ŒLogix å†…æ ¸åªæœ‰ **Store / Logic / Flow / Control** ç­‰åŸè¯­ï¼Œ
Pattern æ˜¯å›´ç»•è¿™äº›åŸè¯­æ„å»ºçš„å¯å¤ç”¨é•¿é€»è¾‘å°è£… + èµ„äº§åŒ…è£…çº¦å®šã€‚

## 1. å½¢æ€ä¸å®šä¹‰ï¼ˆRuntime è§†è§’ï¼‰

v3 å°† Pattern ä¸¥æ ¼åŒºåˆ†ä¸ºä¸¤ç§å½¢æ€ï¼š

| å½¢æ€     | å®šä¹‰æ–¹å¼               | ä¾èµ–æ³¨å…¥           | é€‚ç”¨åœºæ™¯                    |
| :------- | :--------------------- | :----------------- | :-------------------------- |
| Functional | `runXxx(input)`      | æ˜¾å¼å‚æ•° + `Effect.service` | å·¥å…·å‹ï¼šçº¯è®¡ç®—ã€HTTP è¯·æ±‚ç­‰ |
| Namespace | `Xxx.run(config)`     | éšå¼ç¯å¢ƒï¼ˆ`Logic.Env`ï¼‰     | å¯„ç”Ÿå‹ï¼šä¾èµ– Store çŠ¶æ€/ç”Ÿå‘½å‘¨æœŸ |

### 1.1 Functional Pattern

Functional Pattern æ˜¯å®Œå…¨ä¸ Store è§£è€¦çš„ `(input) => Effect` å‡½æ•°ï¼Œ
é€šå¸¸é€šè¿‡ Service / Config è·å–ä¾èµ–ï¼Œç”¨äºè·¨åœºæ™¯å¤ç”¨ï¼š

```ts
export interface BulkOperationConfig {
  operation: string;
  emptyMessage?: string;
}

export const runBulkOperation = (config: BulkOperationConfig) =>
  Effect.gen(function* (_) {
    const selection   = yield* SelectionService;
    const bulk        = yield* BulkOperationService;
    const notification = yield* NotificationService;

    const ids = yield* selection.getSelectedIds();

    if (ids.length === 0) {
      yield* notification.info(config.emptyMessage ?? "è¯·å…ˆé€‰æ‹©è®°å½•");
      return 0;
    }

    yield* bulk.applyToMany({ ids, operation: config.operation });
    return ids.length;
  });
```

ç‰¹ç‚¹ï¼š

- å…¥å£ç±»å‹ç»Ÿä¸€ä¸º `(config: C) => Effect<A, E, R>`ï¼›
- ä¸ä¾èµ–å…·ä½“ Store å½¢çŠ¶ï¼Œå¯ä»¥åœ¨å¤šä¸ª Store / Runtime ä¸­å¤ç”¨ï¼›
- å¸¸ç”¨äºæŠ½è±¡ HTTP è°ƒç”¨ã€é€šçŸ¥é€»è¾‘ã€æ‰¹é‡æ“ä½œç­‰â€œå·¥å…·å‹â€æ¨¡å¼ã€‚

### 1.2 Namespace Patternï¼ˆæ ‡å‡†èŒƒå¼ï¼‰

Namespace Pattern ç”¨äºè¡¨è¾¾ä¾èµ– Store çŠ¶æ€æˆ–ç”Ÿå‘½å‘¨æœŸçš„â€œå¯„ç”Ÿå‹â€é€»è¾‘ã€‚
å®ƒå¿…é¡»è¿”å› `Logic.Of<Sh,R>`ï¼Œä»¥å£°æ˜å…¶å¯¹ `Logix.ModuleRuntime` çš„ä¸Šä¸‹æ–‡ä¾èµ–ï¼š

```ts
export interface AutoSaveConfig<Sh extends Logix.ModuleShape<any, any>, V, R = never> {
  selector: (s: Logix.StateOf<Sh>) => V;
  saveEffect: (value: V) => Effect.Effect<void, any, R>;
  interval?: number;
}

export namespace AutoSave {
  // æŸ¯é‡ŒåŒ–ç­¾åï¼šConfig => Logic.Of
  export const run = <Sh extends Logix.ModuleShape<any, any>, R = never, V = any>(
    config: AutoSaveConfig<Sh, V, R>,
  ): Logic.Of<Sh, R, void, never> =>
    Effect.gen(function* (_) {
      // é€šè¿‡ Logic.RuntimeTag éšå¼è·å–å½“å‰æ¨¡å—çš„è¿è¡Œæ—¶å®ä¾‹
      const runtime = yield* Logic.RuntimeTag;
      const changes$ = runtime.changes$(config.selector);
      const interval = config.interval ?? 1000;

      yield* changes$.pipe(
        Stream.debounce(`${interval} millis`),
        Stream.runForEach(value => config.saveEffect(value)),
      );
    });
}
```

ç‰¹ç‚¹ï¼š

- å…¥å£ä¸º `run(config)`ï¼Œè¿”å›å€¼ç±»å‹ä¸º `Logic.Of<Sh,R>`ï¼›
- é€šè¿‡ `Logic.RuntimeTag` â€œå€Ÿç”¨â€å½“å‰æ¨¡å—çš„è¿è¡Œæ—¶èƒ½åŠ›ï¼ˆå¦‚ `changes$ / ref / getState`ï¼‰ï¼›
- é€‚åˆè¡¨è¾¾è‡ªåŠ¨ä¿å­˜ã€ä¹è§‚æ›´æ–°ã€é•¿ä»»åŠ¡è¿›åº¦åŒæ­¥ç­‰â€œçŠ¶æ€æ„ŸçŸ¥å‹ Patternâ€ã€‚

> çº¦å®š
> - Namespace Pattern ä¸ç›´æ¥å¯¼å‡º `Logic.Api`ï¼Œè€Œæ˜¯ä¾èµ– `Logic.Env<Sh,R>`ï¼›
> - ä¸šåŠ¡ Logic é€šè¿‡ `yield* AutoSave.run({ ... })` ä½¿ç”¨ Patternï¼Œè€Œä¸æ˜¯æŠŠ `state` / `flow` æ˜¾å¼ä¼ å…¥ã€‚

## 2. å¹³å°è§£æå¥‘çº¦ï¼ˆParser Contractï¼‰

åœ¨å…¨åŒå·¥å¼•æ“ä¸­ï¼ŒPattern è¢«è§†ä¸º **Gray Boxï¼ˆç°ç›’ï¼‰** èµ„äº§ï¼š

- **è°ƒç”¨å±‚ï¼ˆWhite Boxï¼‰**ï¼š
  - Parser è¯†åˆ« `yield* AutoSave.run(config)` / `runBulkOperation(config)` è¿™ç±»è°ƒç”¨ï¼›
  - æå– `config` å‚æ•°ï¼ˆæˆ–å…¶ Schemaï¼‰ï¼Œåœ¨ç”»å¸ƒä¸Šæ¸²æŸ“ä¸ºä¸€ä¸ªå‘½åçš„ Effect Block èŠ‚ç‚¹ã€‚

- **å®ç°å±‚ï¼ˆGray Boxï¼‰**ï¼š
  - Parser ä¸æ·±å…¥è§£æ Pattern å†…éƒ¨çš„ `Effect.gen` å®ç°ï¼›
  - Pattern å†…éƒ¨å¯ä»¥è‡ªç”±ä½¿ç”¨ä»»æ„ `Effect` / `Stream` ç»„åˆä¸ Service è°ƒç”¨ã€‚

è¿™ä¸€å¥‘çº¦ä¿è¯ï¼š

- Pattern å¼€å‘è€…æ‹¥æœ‰è¶³å¤Ÿçš„å®ç°è‡ªç”±åº¦ï¼›
- å¹³å°ä»ç„¶å¯ä»¥åœ¨ Logic å›¾ä¸Šä»¥â€œå‘½åç§¯æœ¨â€çš„æ–¹å¼å‘ˆç° Pattern ä½¿ç”¨æƒ…å†µã€‚

## 3. çŠ¶æ€å€Ÿç”¨ï¼ˆState Borrowingï¼‰

æŒ‰ v3 çº¦å®šï¼ŒPattern ä¸ç›´æ¥æŒæœ‰çŠ¶æ€ï¼Œè€Œæ˜¯é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼â€œå€Ÿç”¨â€ï¼š

- **Namespace Pattern**ï¼šé€šè¿‡ `Logic.RuntimeTag` è·å–å½“å‰æ¨¡å—çš„è¿è¡Œæ—¶å®ä¾‹ï¼Œå†ä½¿ç”¨ `changes$ / ref / getState` ç­‰èƒ½åŠ›ï¼›
- **Functional Pattern**ï¼šé€šè¿‡æ˜¾å¼æ³¨å…¥çš„ `SubscriptionRef` / å€¼å‚æ•°æ“ä½œçŠ¶æ€ã€‚

ç¤ºä¾‹ï¼š

```ts
// Namespace Pattern ä¸­å€Ÿç”¨å½“å‰ Store çš„å˜åŒ–æµ
const runtime  = yield* Logic.RuntimeTag;
const changes$ = runtime.changes$(config.selector);

// Functional Pattern ä¸­é€šè¿‡ Ref å€Ÿç”¨å±€éƒ¨çŠ¶æ€
export interface PaginationInput {
  pageRef: SubscriptionRef.SubscriptionRef<number>;
}

export const runPaginationEffect = (input: PaginationInput) =>
  Effect.gen(function* (_) {
    yield* SubscriptionRef.update(input.pageRef, p => p + 1);
  });
```

å¹³å°åœ¨èµ„äº§å±‚åªå…³å¿ƒ Pattern çš„ **é…ç½®å¥‘çº¦ï¼ˆConfig / è¾“å…¥å‚æ•°ï¼‰**ï¼Œ
è€Œè¿è¡Œæ—¶åªå…³å¿ƒ Pattern çš„è¿”å› Effect å¦‚ä½•æ‰§è¡Œã€‚

## 4. Pattern åœ¨å›¾ç ä¸­çš„è§’è‰²

åœ¨å›¾ç åŒæ­¥è§†è§’ä¸‹ï¼š

- Functional / Namespace Pattern å¯¹åº” `effect-block` èŠ‚ç‚¹ï¼ˆå‚è§ `03-assets-and-schemas.md` çš„ `LogicNode`ï¼‰ï¼›
- `$.flow.run*` / `Effect.catch*` ç­‰è°ƒç”¨å¯¹åº”éª¨æ¶èŠ‚ç‚¹ï¼›
- å¹³å°å¯ä»¥æ ¹æ® Pattern èµ„äº§çš„ `id` / `configSchema` å°†æŸäº› Effect Block æ¸²æŸ“ä¸ºâ€œå‘½åç§¯æœ¨â€ï¼ˆpalette ä¸­çš„ Patternï¼‰ï¼Œä½†è¿™ä¸æ”¹å˜è¿è¡Œæ—¶è¡Œä¸ºã€‚

æ€»ç»“ï¼š

- è¿è¡Œæ—¶æ ¸å¿ƒåªçŸ¥é“ `Effect` ä¸ `Store / Logic / Flow / Control`ï¼›
- Pattern æ˜¯å›´ç»•è¿™äº› Effect å‡½æ•°çš„å†™æ³•æƒ¯ä¾‹ä¸èµ„äº§åŒ…è£…åè®®ï¼›
- å¹³å°å¯é€‰æ‹©æ€§åœ°å°†æŸäº› Pattern æ³¨å†Œä¸ºèµ„äº§ï¼Œç”¨äºå¯è§†åŒ–ã€å¤ç”¨ä¸é…ç½®åŒ–ï¼Œè€Œæ— éœ€ runtime æä¾›ç‰¹æ®Šæ”¯æŒã€‚
</file>

<file path="runtime-logix/core/05-runtime-implementation.md">
# å®ç°æ¶æ„ (Implementation Architecture)

> **Status**: Definitive (v3 Effect-Native)
> **Date**: 2025-11-27
> **Layer**: Core Engine Implementation

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† Logix æ ¸å¿ƒå¼•æ“çš„å†…éƒ¨å®ç°æ¶æ„ã€‚å®ƒè§£é‡Šäº†ï¼š

- é€šè¿‡ä¸€ä¸ªæ¨èå®ç°è‰å›¾ï¼Œè¯´æ˜ `ModuleRuntime.make` å¦‚ä½•å°† `State`ã€`Action` çš„ Layer ä¸ä¸€ç»„ Logic ç¨‹åºç»„è£…æˆä¸€ä¸ªå¯è¿è¡Œçš„çŠ¶æ€æœºï¼›
- `Logix.app` å¦‚ä½•å°†å¤šä¸ª Module ç»„è£…æˆä¸€ä¸ª AppRuntimeï¼›
- Scope ç®¡ç†ä¸èµ„æºé‡Šæ”¾æœºåˆ¶ã€‚ React é›†æˆçš„ç»„åˆæ ¹ã€‚

æ‰€æœ‰ API å’Œç±»å‹å®šä¹‰ä»¥ `docs/specs/intent-driven-ai-coding/v3/effect-poc` ä¸­çš„ PoC ä¸ºæœ€æ–°äº‹å®æºã€‚

## 1. æ ¸å¿ƒç»„ä»¶ (Core Components)

Logix å¼•æ“æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **Effect Layer Runtime**ã€‚

1.  **State Layer**: æä¾› `Ref<State>` æœåŠ¡ã€‚
2.  **Action Layer**: æä¾› `Hub<Action>` æœåŠ¡ã€‚
3.  **Logic ç¨‹åº**: æ¶ˆè´¹ State å’Œ Actionï¼Œè¿è¡Œ Long-running Fibersï¼ˆå³ä¸€ç»„åœ¨ `Logic.Env` ä¸Šè¿è¡Œçš„é•¿ç”Ÿå‘½å‘¨æœŸ Effect ç¨‹åºï¼‰ã€‚

## 2. ç»„è£…æµç¨‹ (Assembly Process)

å½“è°ƒç”¨ `Logix.Module("Id", { state, actions }).live(initialState, ...logicPrograms)` æ—¶ï¼Œå†…éƒ¨å¤§è‡´ç­‰ä»·äºï¼š

1.  **Layer Composition**: ä½¿ç”¨ `Layer.merge` å°† State Layer å’Œ Action Layer åˆå¹¶ä¸ºä¸€ä¸ª `StoreLayer`ï¼ŒLogic ç¨‹åºåˆ™åœ¨è¯¥ Runtime ä¸Šå¯åŠ¨å¹¶æ‰˜ç®¡ç”Ÿå‘½å‘¨æœŸï¼ˆè€Œä¸æ˜¯ä½œä¸º Layer å†æ¬¡åˆå¹¶ï¼‰ã€‚
2.  **Runtime Creation**: ä½¿ç”¨ `Layer.toRuntime` åˆ›å»ºä¸€ä¸ªåŸºäºé¢†åŸŸæ¨¡å—è¿è¡Œæ—¶å®ä¾‹çš„ Effect Runtimeã€‚
3.  **Scope Management**: åˆ›å»ºä¸€ä¸ªæ ¹ Scopeï¼Œç”¨äºç®¡ç†è¯¥ Module å¯¹åº” Store çš„ç”Ÿå‘½å‘¨æœŸã€‚

## 3. é€»è¾‘çš„æ‰§è¡Œç¯å¢ƒ (Logic Execution Environment)

åœ¨ v3 èŒƒå¼ä¸­ï¼Œä¸å­˜åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ `LogicDSLTag`ã€‚`Logic` æœ¬èº«å°±æ˜¯ä¸€ä¸ª `Effect` ç¨‹åºï¼Œå®ƒè¿è¡Œåœ¨ä¸€ä¸ªç”±æ¨¡å—è¿è¡Œæ—¶å’Œå¤–éƒ¨æ³¨å…¥æœåŠ¡ï¼ˆ`R`ï¼‰å…±åŒæ„æˆçš„ `Logic.Env` ç¯å¢ƒä¸­ã€‚

å½“ `Store` è¿è¡Œæ—¶ï¼Œå®ƒä¼šæ„å»ºè¿™ä¸ª `Env`ï¼Œå¹¶æä¾›ç»™æ‰€æœ‰åŸºäº Bound API `$` å®šä¹‰çš„ Logic ç¨‹åºï¼ˆä¾‹å¦‚ `Domain.logic(($)=>Effect.gen(...))`ï¼‰ã€‚`Logic.Api`ï¼ˆå³ `state`, `flow`, `control` ç­‰ï¼‰æ­£æ˜¯å¯¹è¿™ä¸ª `Env` ä¸­èƒ½åŠ›çš„å°è£…ï¼Œå®ƒåœ¨ `Store` å†…éƒ¨å®ç°ï¼Œå¹¶ä¼ é€’ç»™ä¸šåŠ¡é€»è¾‘ï¼Œä»è€Œè¿æ¥äº†æŠ½è±¡é€»è¾‘ä¸çœŸå®çš„è¿è¡Œæ—¶ã€‚

## 4. å¹¶å‘ä¸æµ (Concurrency & Streams)

åœ¨ v3 æ¶æ„ä¸­ï¼ŒFlow æœ¬è´¨ä¸Šæ˜¯ **Effect Stream**ã€‚

*   `Flow.from(trigger)` åˆ›å»ºä¸€ä¸ª Streamï¼›
*   `Flow.run(effect)` ä½¿ç”¨ `Stream.runForEach` æ¶ˆè´¹è¿™ä¸ª Streamï¼ˆå• watcher å†…ä¸²è¡Œæ‰§è¡Œï¼‰ï¼›
*   `Flow.runParallel(effect)` ä½¿ç”¨ `Stream.mapEffect(..., { concurrency: "unbounded" })` + `Stream.runDrain` å®ç°æ˜¾å¼æ— ç•Œå¹¶å‘ï¼›
*   å…¶å®ƒå¹¶å‘æ§åˆ¶ï¼ˆLatest/Exhaust/Sequenceï¼‰é€šè¿‡ `Stream.flatMap`ã€å†…éƒ¨ Ref ç­‰æ–¹å¼åœ¨å• watcher å†…çº¦æŸå¹¶å‘è¡Œä¸ºã€‚

## 5. èµ„æºæ¸…ç† (Resource Disposal)

å½“ Store è¢«é”€æ¯æ—¶ï¼Œæ ¹ Scope è¢«å…³é—­ã€‚Effect Runtime è‡ªåŠ¨ï¼š

1.  å–æ¶ˆæ‰€æœ‰ Logic Fiberã€‚
2.  å…³é—­ Action Hubã€‚
3.  é‡Šæ”¾æ‰€æœ‰èµ„æºã€‚

## 6. AppRuntime å®ç° (Logix.app)

`Logix.app` æ˜¯åº”ç”¨çº§è¿è¡Œæ—¶çš„æ„å»ºå·¥å‚ã€‚å®ƒè´Ÿè´£å°†â€œå›¾çº¸â€ï¼ˆé…ç½®ï¼‰è½¬æ¢ä¸ºâ€œæ–½å·¥â€ï¼ˆLayer + Runtimeï¼‰ï¼Œæä¾›ç»Ÿä¸€çš„ **Composition Root**ã€‚

### 6.1 é…ç½®ä¸è¿”å›å€¼ (Config & AppDefinition)

åœ¨ç±»å‹å±‚é¢ï¼Œæˆ‘ä»¬å°† App å®šä¹‰çº¦æŸä¸ºä¸€ç»„ç»“æ„åŒ–é…ç½®ï¼š

```ts
// App é…ç½®ï¼šç”¨äºâ€œç”»å›¾çº¸â€ï¼Œä¸ç›´æ¥åŒ…å« Runtime ç»†èŠ‚
export interface LogixAppConfig<R> {
  /**
   * åŸºç¡€ç¯å¢ƒ Layerï¼š
   * - Http / Router / Config / Logger / Platform ç­‰å…¨å±€æœåŠ¡ï¼›
   * - è¦æ±‚ç¬¬ä¸‰ä¸ªæ³›å‹ä¸º neverï¼Œè¡¨ç¤ºå·²é—­åˆä¾èµ–ï¼›
   * - æ¨èåœ¨è¿›å…¥ Logix.app ä¹‹å‰å°±æ”¶æ•›é”™è¯¯é€šé“ï¼Œä½¿è¿™é‡Œçš„ E=neverã€‚
   */
  readonly layer: Layer.Layer<R, never, never>

  /**
   * å…¨å±€æ¨¡å—ï¼š
   * - æ¯ä¸ªæ¨¡å—å¯¹åº”ä¸€æ£µå…¨å±€ Storeï¼›
   * - Module å®šä¹‰ä¸ Runtime çš„ S/A å¿…é¡»åœ¨ç±»å‹ä¸ŠåŒ¹é…ã€‚
   */
  readonly modules: ReadonlyArray<AppModuleEntry>

  /**
   * AppModuleEntryï¼šç”± Logix.provide ç”Ÿæˆçš„æ¨¡å—æ¡ç›®ã€‚
   *
   * è¯´æ˜ï¼š
   * - moduleï¼šModule å®šä¹‰å¯¹è±¡ï¼ˆæ—¢æ˜¯ Tagï¼Œåˆæºå¸¦ Shape ä¿¡æ¯ä¸å·¥å‚èƒ½åŠ›ï¼‰ï¼›
   * - layerï¼šè¯¥ Module å¯¹åº”çš„ Runtime Layerï¼Œé€šå¸¸ç”± Module.live(initial, ...logics) è¿”å›ã€‚
   *
   * åœ¨å®é™…å®ç°ä¸­ï¼ŒLogix.provide ä¼šè´Ÿè´£å°† â€œModule + Runtime/Layerâ€ é…å¯¹ä¸º AppModuleEntryã€‚
   */
  interface AppModuleEntry {
    readonly module: Logix.ModuleInstance<any, any>
    readonly layer: Layer.Layer<any, any, any>
  }

  /**
   * è¿›ç¨‹ / å®ˆæŠ¤åç¨‹ (Processes)ï¼š
   * - ä¸€ç»„é•¿ç”Ÿå‘½å‘¨æœŸçš„ Effectï¼ˆå…¸å‹ä¸º Coordinator æˆ–åå°ç›‘å¬ä»»åŠ¡ï¼‰ï¼›
   * - è¿è¡Œåœ¨ App ç¯å¢ƒä¸Šï¼Œé€šå¸¸ä½¿ç”¨ yield* Tag è®¿é—® Store / Serviceï¼›
   * - è®¾è®¡ä¸Šç”¨äºâ€œå¸¸é©»é€»è¾‘â€ï¼Œè€Œéä¸€æ¬¡æ€§åˆå§‹åŒ–è„šæœ¬ã€‚
   */
  readonly processes: ReadonlyArray<Effect.Effect<void, any, any>>

  /**
   * å…¨å±€é”™è¯¯å¤„ç†ï¼š
   * - å½“ App Runtime å†…ä»»æ„ Fiber (Module Logic æˆ– Process) å‘ç”Ÿæœªæ•è· Defect æ—¶è§¦å‘ï¼›
   * - ä»…ç”¨äºä¸ŠæŠ¥ (Last-breath reporting)ï¼Œæ— æ³•é˜»æ­¢ App å´©æºƒã€‚
   */
  readonly onError?: (cause: import('effect').Cause.Cause<unknown>) => Effect.Effect<void>
}

// AppDefinitionï¼šåœ¨é…ç½®åŸºç¡€ä¸Šè¡¥å…… Layer ä¸ Runtime ä¿¡æ¯
export interface AppDefinition<R> {
  readonly definition: LogixAppConfig<R>
  readonly layer: Layer.Layer<R, never, never>
  readonly makeRuntime: () => Effect.ManagedRuntime<R, never>
}
```

> è¯´æ˜
> - `modules` ç”± `Logix.provide(Module, Module.live(...))` æˆ–ç­‰ä»· Layer ç»„åˆè€Œæˆï¼Œå¹³å°å¯ä»¥é™æ€è§£æâ€œå“ªäº›æ¨¡å—è¢«æ³¨å…¥åˆ° App ä¸­â€ï¼›
> - `processes` ä¸­çš„ Effect ä»£è¡¨â€œé•¿ç”Ÿå‘½å‘¨æœŸé€»è¾‘â€ï¼Œä¾‹å¦‚è·¨ Store åè°ƒçš„ Coordinatorï¼Œæˆ–æŒç»­ç›‘å¬ç¯å¢ƒå˜åŒ–çš„åå°ä»»åŠ¡ã€‚

### 6.2 æ„å»ºé€»è¾‘ (from Blueprint to Layer)

`Logix.app` çš„å®ç°æœ¬è´¨ä¸Šæ˜¯ä¸€æ¬¡æœ‰åºçš„ Layer ç»„åˆè¿‡ç¨‹ï¼š

```ts
function app<R>(config: LogixAppConfig<R>): AppDefinition<R> {
  const moduleLayers = config.modules.map((entry) => entry.layer)
  const envLayer = moduleLayers.length > 0
    ? Layer.mergeAll(config.layer, ...moduleLayers)
    : config.layer

  const finalLayer = Layer.scopedContext(
    Effect.gen(function* () {
      const scope = yield* Scope.make()
      const env = yield* Layer.buildWithScope(envLayer, scope)
      yield* Effect.addFinalizer(() => Scope.close(scope, Exit.void))

      yield* Effect.forEach(config.processes, (process) =>
        Effect.forkScoped(Effect.provide(process, env))
      )

      return env
    })
  )

  return {
    definition: config,
    layer: finalLayer,
    makeRuntime: () => Effect.ManagedRuntime.make(finalLayer),
  }
}
```

## 1. æ ¸å¿ƒç»„è£…å·¥å‚ï¼š`ModuleRuntime.make`ï¼ˆæ¨èå®ç°è‰å›¾ï¼‰

`ModuleRuntime.make` æ˜¯ Logix å¼•æ“çš„â€œå¿ƒè„â€ã€‚å®ƒè´Ÿè´£å°†é™æ€çš„ Schemaã€Logic å’Œåˆå§‹çŠ¶æ€â€œæ´»åŒ–â€ä¸ºä¸€ä¸ªè¿è¡Œæ—¶çš„ `Logix.ModuleRuntime` å®ä¾‹ã€‚

> **è§„èŒƒå±‚è¯´æ˜**
> - æœ¬èŠ‚ç»™å‡ºçš„ `ModuleRuntime.make` ç­¾åæ˜¯ä¸€ç§ **æ¨èçš„å®ç°è‰å›¾**ï¼Œæ–¹ä¾¿è§£é‡Šæ ‡å‡†å®ç°å¯ä»¥å¦‚ä½•æ‹†åˆ† State / Actions / Logicï¼›
> - **ä¸æ˜¯å”¯ä¸€åˆæ³•çš„æ„é€ å…¥å£**ï¼šå®ç°æ–¹å¯ä»¥é€‰æ‹©å…¶å®ƒå·¥å‚å½¢æ€ï¼ˆä¾‹å¦‚ `make(initialState)`ï¼‰ï¼Œåªè¦æœ€ç»ˆå¾—åˆ°çš„ `ModuleRuntime<S, A>` æ»¡è¶³ 1.3 å°èŠ‚æ‰€å®šä¹‰çš„æ¥å£ä¸è¯­ä¹‰ä¸å˜å¼ï¼Œå³è§†ä¸ºè§„èŒƒåˆè§„ã€‚

### 1.1 è¾“å…¥ä¸è¾“å‡º

```ts
function ModuleRuntime.make<Sh extends Logix.ModuleShape<any, any>>(
  initial: Logix.StateOf<Sh>,
  options?: {
    readonly createState?: Effect.Effect<SubscriptionRef<Logix.StateOf<Sh>>>
    readonly createActionHub?: Effect.Effect<PubSub<Logix.ActionOf<Sh>>>
    readonly logics?: ReadonlyArray<Logic.Of<Sh, any, any, any>>
    readonly tag?: Logix.ModuleTag<Sh>
  }
): Effect<ModuleRuntime<Logix.StateOf<Sh>, Logix.ActionOf<Sh>>>
```

> ä¸šåŠ¡ä¾§åœ¨å¤šæ•°åœºæ™¯ä¸‹åªéœ€è¦æä¾› `initial`ï¼›`createState` / `createActionHub` åˆ™ç”¨äºè‡ªå®šä¹‰çŠ¶æ€æ¥æºï¼ˆä¾‹å¦‚æ¥è‡ªå…¶å®ƒ Layer æˆ–è¿œç¨‹ Storeï¼‰ï¼Œå…¶ Effect å¾€å¾€ç”± `Layer.buildWithScope(...)` å¾—åˆ°ã€‚  
> å› æ­¤ï¼Œ`ModuleRuntime.make` åŒæ—¶è¦†ç›–äº†â€œç›´æ¥ä¼ åˆå§‹å€¼â€ä¸â€œæ˜¾å¼ç»™å‡º state/action Layerâ€ä¸¤æ¡è·¯å¾„ã€‚

### 1.2 å†…éƒ¨æµç¨‹

å½“ `ModuleRuntime.make` è¢«è°ƒç”¨æ—¶ï¼ˆé€šå¸¸æ˜¯åœ¨ `Effect.scoped` ä¸Šä¸‹æ–‡ä¸­ï¼‰ï¼Œå®ƒä¼šæŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

1.  **State åˆå§‹åŒ–**ï¼šè‹¥æä¾›äº† `createState`ï¼ˆä¾‹å¦‚é€šè¿‡ `Layer.buildWithScope` ä»è‡ªå®šä¹‰ Store è·å¾—ï¼‰ï¼Œåˆ™ç›´æ¥å¤ç”¨ï¼›å¦åˆ™æ ¹æ® `initial` åˆ›å»ºé»˜è®¤çš„ `SubscriptionRef`ã€‚
2.  **Action é€šé“å»ºç«‹**ï¼šåŒç†ï¼Œ`createActionHub` å¯ä»¥è®©è°ƒç”¨æ–¹æ³¨å…¥å·²æœ‰çš„ Action é€šé“ï¼Œé»˜è®¤å®ç°ä¸º `PubSub.unbounded()`ã€‚
3.  **Runtime æ„é€ **ï¼šç»„è£… `getState`ã€`dispatch`ã€`actions$` ç­‰ APIï¼Œå½¢æˆ `Logix.ModuleRuntime` å¯¹è±¡ã€‚
4.  **Logic å¯åŠ¨**ï¼š
    - å°† `Logix.ModuleRuntime` æ³¨å…¥ç»™æ‰€æœ‰ä¼ å…¥çš„ `logicLayers`ï¼›
    - å¹¶å‘å¯åŠ¨è¿™äº› Logic Effectï¼ˆ`Effect.forkScoped`ï¼‰ï¼›
    - ä»»ä½• Logic çš„å¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ª Scope çš„å…³é—­ï¼ˆFail Fastï¼‰ã€‚

### 1.3 æ‰©å±•ç‚¹ï¼šè‡ªå®šä¹‰ `ModuleRuntime` çš„è¾¹ç•Œ

ä»æ¶æ„ä¸Šçœ‹ï¼Œ`ModuleRuntime<S, A>` æ˜¯ Logix è¿è¡Œæ—¶çš„æ ¸å¿ƒæ¥å£ï¼Œ**å…è®¸è¢«æ›¿æ¢/è‡ªå®šä¹‰ï¼Œä½†åªé¢å‘å¼•æ“å®ç°è€…ä¸é€‚é…å™¨ä½œè€…**ï¼š

- è¯­ä¹‰ä¸å˜å¼ï¼ˆä»»ä½•è‡ªå®šä¹‰å®ç°éƒ½å¿…é¡»æ»¡è¶³ï¼‰ï¼š
  - `getState` / `setState`ï¼šåæ˜ ä¸€æ£µå•ä¸€ã€ä¸¥æ ¼ä¸€è‡´çš„ State æ ‘ï¼›`setState` ä¹‹ååç»­çš„ `getState` / `changes` å¿…é¡»èƒ½è§‚æµ‹åˆ°æ–°å€¼ï¼›
  - `dispatch` ä¸ `actions$`ï¼šæ‰€æœ‰é€šè¿‡ `dispatch` æ´¾å‘çš„ Action å¿…é¡»æŒ‰é¡ºåºå‡ºç°åœ¨ `actions$` æµä¸­ï¼Œä¸å…è®¸é™é»˜ä¸¢å¤±æˆ–è·¨å®ä¾‹/è·¨æ¨¡å—ä¸²å°ï¼›
  - `changes(selector)`ï¼šæ˜¯åŸºäº State è§†å›¾çš„å˜åŒ–æµï¼Œè¯­ä¹‰ç­‰ä»·äºâ€œ`stateRef.changes` + `distinctUntilChanged(selector)`â€ï¼Œä¸èƒ½æ··å…¥æ— å…³äº‹ä»¶ï¼›
  - `ref()`ï¼šæä¾›å¯¹å½“å‰ State çš„ `SubscriptionRef` è§†å›¾ï¼š
    - `ref()` è¿”å›æ•´æ£µ State çš„å¯è¯»å†™ SubscriptionRefï¼›
    - `ref(selector)` åœ¨å½“å‰ PoC ä¸­è¿”å›ä¸€ä¸ª**åªè¯»æ´¾ç”Ÿè§†å›¾**ï¼ˆåŸºäº selector ä»æ•´æ£µ State æ´¾ç”Ÿå€¼ï¼Œå†™å…¥ä¼šå¯¼è‡´è¿è¡Œæ—¶ `die`ï¼‰ï¼Œä¸»è¦ä¾›å¼•æ“å†…éƒ¨ä¸é«˜çº§ Pattern ä½¿ç”¨ï¼›ä¸šåŠ¡ä»£ç ä»æ¨èä¼˜å…ˆé€šè¿‡ `$.onState` / `$.flow` è®¢é˜…å˜åŒ–ï¼Œæˆ–åœ¨å¿…è¦æ—¶åœ¨è°ƒç”¨æ–¹è‡ªè¡Œå°è£…æ›´è¯­ä¹‰åŒ–çš„ Refã€‚
- å…¸å‹åˆæ³•ç”¨ä¾‹ï¼š
  - ä¸ºâ€œè¿œç¨‹ Store / æ—¢æœ‰çŠ¶æ€æœºâ€ï¼ˆä¾‹å¦‚åç«¯æ¨é€çš„åªè¯» Storeã€Redux/Zustand ç­‰ï¼‰åŒ…è£…ä¸€ä¸ª `ModuleRuntime`ï¼Œè®© Logix é€»è¾‘å¯ä»¥åœ¨å®ƒä¹‹ä¸Šè¿è¡Œï¼›
  - åœ¨æµ‹è¯•ç¯å¢ƒä¸­å®ç°å¸¦æ—¶é—´æ—…è¡Œ / å½•åˆ¶èƒ½åŠ›çš„ `ModuleRuntime`ï¼Œç”¨äºè°ƒè¯•ä¸å›æ”¾ï¼›
  - ä¸ºç‰¹æ®Šå¹³å°å®ç°â€œæ‡’åŠ è½½ / åˆ†ç‰‡æŒä¹…åŒ–â€ç­‰é«˜çº§ç‰¹æ€§ï¼Œä½†å¯¹ Logic / Flow ä¿æŒå®Œå…¨é€æ˜ã€‚
- æ˜ç¡®**ä¸æ¨è**çš„ç”¨æ³•ï¼š
  - åœ¨ä¸šåŠ¡æ¨¡å—å†…éƒ¨ä¸ºæ¯ä¸ª Module è‡ªè¡Œé€ ä¸€å¥—â€œç‰¹ç«‹ç‹¬è¡Œâ€çš„ Runtimeï¼›è¿™ä¼šç ´åå¹³å°ç»Ÿä¸€çš„è°ƒè¯•/è§‚æµ‹èƒ½åŠ›ï¼Œä¹Ÿä¼šè®© Intent/Flow å½•åˆ¶éš¾ä»¥å¤ç”¨ã€‚

å› æ­¤ï¼Œæ—¥å¸¸ä¸šåŠ¡å¼€å‘åº”ç»Ÿä¸€é€šè¿‡ `Logix.Module` + `Module.logic` + `Module.live` ä½¿ç”¨å¼•æ“æä¾›çš„æ ‡å‡† `ModuleRuntime` å®ç°ï¼›åªæœ‰åœ¨å®ç°é€‚é…å±‚ / å¹³å°æ‰©å±•æ—¶ï¼Œæ‰åœ¨æœ¬æ–‡ä»¶çº¦æŸä¸‹è‡ªå®šä¹‰ `ModuleRuntime` å¹¶é€šè¿‡ `Logix.app` / `Logix.provide` æ³¨å…¥ã€‚

> æ¢å¥è¯è¯´ï¼š  
> - **ç¡¬çº¦æŸ** åªè½åœ¨ `ModuleRuntime<S, A>` æ¥å£ä¸ä¸Šè¿°è¯­ä¹‰ä¸å˜å¼ä¸Šï¼›  
> - `ModuleRuntime.make` / Adapter / Layer ç»„åˆç­‰éƒ½å±äº **å¯é€‰çš„æ„é€ è·¯å¾„**ï¼Œå®ç°æ–¹å¯æ ¹æ®å·¥ç¨‹éœ€è¦è‡ªç”±é€‰æ‹©æˆ–å°è£…ã€‚

---

## 2. `Logix.app`ï¼šåº”ç”¨çº§ç»„è£…

å¦‚æœè¯´ `ModuleRuntime.make` æ˜¯å•ä¸ªå™¨å®˜çš„åˆ¶é€ è€…ï¼Œé‚£ä¹ˆ `Logix.app` å°±æ˜¯ç»„è£…æ•´ä¸ªäººä½“çš„åŒ»ç”Ÿã€‚

### 2.1 èŒè´£

- **Flattening**ï¼šå°†æ‰€æœ‰æ¨¡å—çš„ä¾èµ–ï¼ˆImportsï¼‰å’Œè‡ªèº«ï¼ˆProvidersï¼‰æ‹å¹³åˆ°åŒä¸€å±‚ Layerã€‚
- **Scope Root**ï¼šåˆ›å»ºåº”ç”¨çš„æ ¹ Scopeï¼Œç®¡ç†æ‰€æœ‰å…¨å±€ Service å’Œ Global Store çš„ç”Ÿå‘½å‘¨æœŸã€‚
- **Entry Point**ï¼šæä¾› `run` æ–¹æ³•ï¼Œä½œä¸º React `RuntimeProvider` çš„è¾“å…¥ã€‚

### 2.2 å®ç°è‰å›¾

```ts
function Logix.app(def: AppDefinition) {
  // 1. æ‹å¹³ä¾èµ–
  const layer = flattenLayers(def.imports, def.providers)

  // 2. æ„é€  Runtime
  const runtime = ManagedRuntime.make(layer)

  return runtime
}
```

> **æ³¨æ„**ï¼š`Logix.app` å¹¶ä¸ç›´æ¥è°ƒç”¨ `ModuleRuntime.make`ï¼Œè€Œæ˜¯é€šè¿‡ç»„åˆ `Module.live` è¿”å›çš„ Layer æ¥é—´æ¥è§¦å‘å®ƒã€‚

---

## 3. Scope ç®¡ç†ä¸èµ„æºé‡Šæ”¾

Logix v3 ä¸¥æ ¼éµå¾ª Effect çš„ Scope æœºåˆ¶ï¼š

- **Global Store**ï¼š
  - ç”Ÿå‘½å‘¨æœŸç»‘å®šåœ¨ `Logix.app` åˆ›å»ºçš„æ ¹ Scope ä¸Šã€‚
  - App å…³é—­æ—¶ï¼Œæ ¹ Scope å…³é—­ï¼Œè§¦å‘æ‰€æœ‰ Global Store çš„ `onDestroy`ã€‚

- **Local Store**ï¼š
  - ç”Ÿå‘½å‘¨æœŸç»‘å®šåœ¨ React ç»„ä»¶åˆ›å»ºçš„ä¸´æ—¶ Scope ä¸Šï¼ˆé€šè¿‡ `useLocalStore`ï¼‰ã€‚
  - ç»„ä»¶å¸è½½æ—¶ï¼Œä¸´æ—¶ Scope å…³é—­ï¼Œè§¦å‘ Local Store çš„ `onDestroy`ã€‚

è¿™ç§æœºåˆ¶ä¿è¯äº†æ— è®ºæ˜¯å…¨å±€è¿˜æ˜¯å±€éƒ¨çŠ¶æ€ï¼Œå…¶èµ„æºï¼ˆå¦‚ WebSocket è¿æ¥ã€å®šæ—¶å™¨ï¼‰éƒ½èƒ½è¢«ç²¾ç¡®ã€è‡ªåŠ¨åœ°é‡Šæ”¾ã€‚æˆåŠŸåˆå§‹åŒ–åï¼Œ`processes` ä¸­çš„è¿›ç¨‹æ‰ä¼šå¯åŠ¨ï¼›
   - è‹¥æŸä¸ªæ¨¡å—åˆå§‹åŒ–å¤±è´¥ï¼Œ`processes` å°†ä¸ä¼šè¢«æ‰§è¡Œï¼ŒAppRuntime çš„æ„å»ºä¼šä»¥é”™è¯¯å‘Šç»ˆã€‚
2. **ç”Ÿå‘½å‘¨æœŸç»‘å®š**ï¼š
   - `finalLayer` é€šå¸¸ä½œä¸ºåº”ç”¨æ ¹èŠ‚ç‚¹çš„ Runtime å…¥å£ï¼š
     - React åœºæ™¯ï¼šç”± `RuntimeProvider app={AppDefinition}` æŒæœ‰å…¶ Scopeï¼›
     - Node / CLI åœºæ™¯ï¼šé€šè¿‡ `makeRuntime()` åˆ›å»ºçš„ Runtime æŒæœ‰å…¶ Scopeã€‚

> æ³¨æ„
> ä¸Šè¿°ä»£ç ä¸ºæ¦‚å¿µæ€§ä¼ªä»£ç ï¼Œç”¨äºæè¿° Layer ç»„åˆä¸ Scope å…³ç³»ï¼›
> çœŸæ­£å®ç°æ—¶éœ€ä»¥æœ¬åœ° `effect` ç‰ˆæœ¬çš„ API ä¸ºå‡†ï¼ˆåŒ…æ‹¬ `ManagedRuntime` çš„å¯¼å…¥è·¯å¾„ä¸ç­¾åï¼‰ã€‚

### 6.3 ä¾èµ–é¡ºåºä¸ç”Ÿå‘½å‘¨æœŸ (Dependency & Lifetime)

`Logix.app` åœ¨è¯­ä¹‰ä¸Šéµå¾ªå¦‚ä¸‹é¡ºåºï¼š

1. **ä¾èµ–åˆå§‹åŒ–é¡ºåº**ï¼š`layer` â†’ `modules` â†’ `processes`ã€‚
   - åªæœ‰åœ¨æ‰€æœ‰åŸºç¡€è®¾æ–½ä¸ Store éƒ½æˆåŠŸåˆå§‹åŒ–åï¼Œ`processes` ä¸­çš„è¿›ç¨‹æ‰ä¼šå¯åŠ¨ï¼›
   - è‹¥æŸä¸ªæ¨¡å—åˆå§‹åŒ–å¤±è´¥ï¼Œ`processes` å°†ä¸ä¼šè¢«æ‰§è¡Œï¼ŒAppRuntime çš„æ„å»ºä¼šä»¥é”™è¯¯å‘Šç»ˆã€‚
2. **ç”Ÿå‘½å‘¨æœŸç»‘å®š**ï¼š
   - `finalLayer` é€šå¸¸ä½œä¸ºåº”ç”¨æ ¹èŠ‚ç‚¹çš„ Runtime å…¥å£ï¼š
     - React åœºæ™¯ï¼šç”± `RuntimeProvider app={AppDefinition}` æŒæœ‰å…¶ Scopeï¼›
     - Node / CLI åœºæ™¯ï¼šé€šè¿‡ `makeRuntime()` åˆ›å»ºçš„ Runtime æŒæœ‰å…¶ Scopeã€‚
   - å½“åº”ç”¨å¸è½½æˆ–è¿›ç¨‹é€€å‡ºæ—¶ï¼š
     - `processes` ä¸­é€šè¿‡ `forkScoped` å¯åŠ¨çš„æ‰€æœ‰è¿›ç¨‹ä¼šè‡ªåŠ¨æ”¶åˆ°ä¸­æ–­ä¿¡å·å¹¶ä¼˜é›…é€€å‡ºï¼›
     - æ‰€æœ‰æŒ‚åœ¨ App æ ¹ Scope ä¸‹çš„ Store / Service èµ„æºå‡ä¼šè¢«é‡Šæ”¾ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒLogix åœ¨ä¿æŒ Effect-Native è¿è¡Œæ—¶ç‰¹æ€§çš„åŒæ—¶ï¼Œä¸ºå¹³å°ä¸ React/Form å±‚æä¾›äº†ä¸€ä¸ªç¨³å®šçš„ **App çº§ç»„åˆå¥‘çº¦**ï¼š
å¾®è§‚å±‚ä½¿ç”¨ `Logix.Module` / Bound API `$` ç»„ç»‡è¡Œä¸ºï¼Œå®è§‚å±‚ä½¿ç”¨ `Logix.app` ç»„ç»‡æ¨¡å—ä¸è·¨æ¨¡å—åä½œã€‚

### 6.4 å·²çŸ¥å±€é™ä¸å–èˆ (Known Trade-offs)

å½“å‰çš„ `Logix.app` è®¾è®¡åœ¨å¹³å°å¯è§£ææ€§ä¸å·¥ç¨‹çµæ´»æ€§ä¹‹é—´åšäº†ä¸€äº›æœ‰æ„è¯†çš„å–èˆï¼š

- **è¿›ç¨‹è¯­ä¹‰**ï¼š
  - `processes` ä¸“é—¨ç”¨äºæè¿°â€œé•¿ç”Ÿå‘½å‘¨æœŸçš„å®ˆæŠ¤è¿›ç¨‹ / åè°ƒé€»è¾‘â€ï¼Œä¾‹å¦‚ `SearchDetailCoordinator`ï¼›
  - ä¸€æ¬¡æ€§åˆå§‹åŒ–è„šæœ¬ï¼ˆå¦‚ç®€å•çš„æ—¥å¿—æ‰“å°ã€ä¸€æ¬¡æ€§çš„é…ç½®è¯»å–ï¼‰å»ºè®®æ”¾åœ¨ Infra æ„å»ºå±‚æˆ–å…·ä½“ Store/Logic ä¸­ï¼Œè€Œé `processes`ã€‚
- **Bundle ä½“ç§¯**ï¼š
  - ç”±äº `Logix.app` æ˜¯é™æ€è“å›¾ï¼Œ`modules` ä¸­å¼•ç”¨çš„æ‰€æœ‰ Store å®ç°ä¼šè¢«æ‰“å…¥ä¸» Bundleï¼›
  - å¯¹äºéå¸¸å¤§çš„å‰ç«¯åº”ç”¨ï¼Œè¿™ä¼šå¢åŠ é¦–å±ä½“ç§¯ï¼Œä½†æ¢æ¥çš„æ˜¯å¹³å°åœ¨â€œé™æ€æ¨¡å¼â€ä¸‹å³å¯å®Œæ•´åˆ†æåº”ç”¨æ‹“æ‰‘ã€‚
- **Layer é»‘ç›’**ï¼š
  - `layer` å­—æ®µä»ç„¶æ˜¯ä¸€ä¸ªä»»æ„çš„ `Layer.Layer<R, any, never>`ï¼Œå¹³å°ä¸ä¼šå°è¯•è§£æå…¶ä¸­çš„æœåŠ¡ç»†èŠ‚ï¼›
  - è¿™æ ·å¯ä»¥ä¿ç•™ Effect-Native çš„å®Œå…¨è¡¨è¾¾åŠ›ï¼ŒåŒæ—¶å°†æ‹“æ‰‘è§£æçš„èŒƒå›´èšç„¦åœ¨ `modules` / `processes` è¿™ä¸¤ç±»ç»“æ„åŒ–èµ„äº§ä¸Šã€‚
</file>

<file path="runtime-logix/core/06-platform-integration.md">
# Platform Integration (å¹³å°é›†æˆä¸æ²»ç†)

> **Status**: Draft
> **Context**: æœ¬æ–‡æ¡£ä» Logix è§†è§’è¯´æ˜ï¼šåœ¨ `intent-driven-ai-coding` v3 æ¶æ„ä¸‹ï¼ŒLogix ä½œä¸º `logix-engine` Runtime Targetï¼Œå¦‚ä½•æ¶ˆè´¹ Intent/Flow/Constraint å¥‘çº¦å¹¶æ¥å…¥å¹³å°çš„æ²»ç†èƒ½åŠ›ã€‚

## 1. æ€»ä½“å®šä½

åœ¨å¹³å°æ•´ä½“æ¶æ„ä¸­ï¼š

- **Intent (æ„å›¾)**ï¼šäº§å“ä¸å¼€å‘è€…åœ¨ v3 æ¨¡å‹ä¸‹è¡¨è¾¾çš„ UI / Logic / Domain ç­‰ä¿¡æ¯ï¼›
- **Platform (å¹³å°)**ï¼šè´Ÿè´£ Intent çš„æ ¡éªŒã€Logic ç¼–è¯‘ã€å‡ºç ä¸æ²»ç†ï¼›
- **Runtimes (è¿è¡Œæ—¶å®¶æ—)**ï¼šæ‰¿æ¥ Logic Intent çš„å…·ä½“æ‰§è¡Œåç«¯ï¼Œå…¶ä¸­ä¹‹ä¸€å°±æ˜¯æœ¬æ–‡ä»¶æè¿°çš„ Logix Engine Runtimeã€‚

## 2. Intent å±‚æ˜ å°„ï¼ˆLogix è§†è§’ï¼‰

### 2.1 Domain Intent -> Logix Schema / Module

å¹³å°å®šä¹‰çš„ Domain Intentï¼ˆå®ä½“/å­—æ®µ/æ ¡éªŒç­‰ï¼‰ç›´æ¥æ˜ å°„ä¸º Logix Module çš„ Schema ä¸åˆå§‹å€¼ï¼š

- **Entity / Field Schema**ï¼šæ˜ å°„ä¸º `Schema.Struct`ã€`Schema.Union` ç­‰ï¼Œç»„æˆ Module çš„ `stateSchema`ï¼ˆå¯¹åº” `Logix.ModuleShape`ï¼‰ï¼›
- **State Source**ï¼š
  - `local`: æ˜ å°„ä¸º ModuleRuntime å†…éƒ¨çŠ¶æ€å­—æ®µï¼›
  - `external`ï¼ˆå¦‚ React Queryã€WebSocketï¼‰ï¼šé€šè¿‡ `inputs` ä¸ `Flow.from` è§„åˆ™æ¥å…¥ã€‚

### 2.2 Logic Intent -> Logix Logicï¼ˆä»… `logix-engine`ï¼‰

å½“ Logic Intent çš„ `runtimeTarget = 'logix-engine'` æ—¶ï¼š

- **Trigger**ï¼š`LogicIntent.trigger` â†’ æ˜ å°„ä¸º Interaction/State äº‹ä»¶ï¼š
  - å­—æ®µå˜åŒ–ï¼š`Flow.from(store.change(selector))`ï¼›
  - åŠ¨ä½œï¼š`Flow.from(store.action(type))`ï¼›

- **Steps**ï¼š`LogicIntent.graph` â†’ æ˜ å°„ä¸º Logic Handler ä¸­çš„ Effect æ­¥éª¤åºåˆ—ï¼š
  - `callService`ï¼š`yield* services.ServiceName.method(...)`ï¼›
  - `branch`ï¼š`$.match` (Switch/Case)ï¼›
  - `runPattern`ï¼š`Flow.run(Pattern(config))`ã€‚

### 2.3 UI Intent -> Inputs & Actions

UI æ„å›¾ä¸­çš„â€œç”¨æˆ·è¡Œä¸ºâ€åœ¨ UI å±‚è¢«æ ‡å‡†åŒ–ä¸º Logix å¯æ¶ˆè´¹çš„äº‹ä»¶ï¼š

- **å­—æ®µè¾“å…¥**ï¼šæ˜ å°„ä¸º `state.mutate(draft => draft.path = value)`ï¼Œè§¦å‘ç›¸åº”çš„ `change` è§„åˆ™ï¼›
- **æŒ‰é’®ç‚¹å‡»ç­‰åŠ¨ä½œ**ï¼šæ˜ å°„ä¸º `dispatch(action)`ï¼›

### 2.4 Constraints -> Rule Options / ä¸­é—´ä»¶

å¹³å°å®šä¹‰çš„éåŠŸèƒ½æ€§çº¦æŸæ˜ å°„ä¸ºï¼š

- **Rule Options**ï¼š
  - æ€§èƒ½ï¼š`Flow.debounce`, `Flow.throttle`ï¼›
  - å¹¶å‘ï¼š`concurrency: 'switch' | 'exhaust' | 'queue'` ç­‰ï¼›

## 3. é™æ€åˆ†æä¸ç«æ€æ²»ç†ï¼ˆLogix ä»£ç è§†è§’ï¼‰

è™½ç„¶ Logix åœ¨è¿è¡Œæ—¶å†…ç½®äº† Loop Protectionï¼Œä½†å¹³å°ä¾§ä»åº”åŸºäº Logix Logic åšé™æ€åˆ†æï¼Œä»¥æå‰å‘ç°é—®é¢˜ã€‚

### 3.1 ä¾èµ–å›¾æ„å»ºï¼ˆDependency Graphï¼‰

å¹³å°è§£æ Logix Logicï¼Œæ„å»º Path çº§ä¾èµ–æœ‰å‘å›¾ï¼š

- **Nodes**ï¼šState Pathï¼ˆå¦‚ `user.name`ã€`items.*.price`ï¼‰æˆ– Action/Input æ ‡è¯†ï¼›
- **Edges**ï¼šè§„åˆ™ä¾èµ–å…³ç³»ï¼ˆå¦‚ `Flow.from('a').pipe(run(Logic.set('b')))` å½¢æˆ `A -> B`ï¼‰ã€‚

### 3.2 æ²»ç†ç­–ç•¥

| é£é™©æ¨¡å¼ | æ£€æµ‹é€»è¾‘ | å¹³å°è¡Œä¸º |
| :--- | :--- | :--- |
| **ç›´æ¥å¾ªç¯** | Graph Cycle (A -> B -> A) | **Error**ï¼šé˜»æ­¢ä»£ç ç”Ÿæˆæˆ–è¿è¡Œï¼Œè¦æ±‚äººå·¥ä»‹å…¥ã€‚ |
| **å¤šæºå†™å…¥** | å¤šæ¡è§„åˆ™å†™å…¥åŒä¸€è·¯å¾„ (A -> C, B -> C) | **Warning**ï¼šæç¤ºç«æ€é£é™©ï¼Œå»ºè®®åˆå¹¶é€»è¾‘ã€‚ |

## 4. IntentRuleï¼šç»Ÿä¸€çš„è§„åˆ™ IR

ä¸ºäº†åœ¨å¹³å°ä¾§ç»Ÿä¸€æè¿°å„ç±»è”åŠ¨è§„åˆ™ï¼ˆæ— è®ºæ˜¯ç”±å¼€å‘è€…æ‰‹å†™ Intent APIï¼Œè¿˜æ˜¯ç”±ç”»å¸ƒ/DSL ç”Ÿæˆï¼‰ï¼Œæœ¬æ¶æ„å¼•å…¥ `IntentRule` ä½œä¸ºä¸­é—´è¡¨ç¤ºï¼ˆIRï¼‰ï¼š

```ts
interface IntentRule {
  source: {
    context: "self" | string;        // self æˆ–æŸä¸ª Module/Service æ ‡è¯†
    type: "state" | "action";        // ç›‘å¬ State è§†å›¾è¿˜æ˜¯ Action
    selector: string;                // AST å¼•ç”¨æˆ–åºåˆ—åŒ–è¡¨è¾¾å¼
  };
  pipeline: Array<{
    op: "debounce" | "throttle" | "filter" | "switchMap" | "exhaustMap" | "custom";
    args: ReadonlyArray<unknown>;
  }>;
  sink: {
    context: "self" | string;        // self æˆ–æŸä¸ªç›®æ ‡ Module/Service
    type: "mutate" | "dispatch" | "service";
    handler: string;                 // AST å¼•ç”¨æˆ–åºåˆ—åŒ–è¡¨è¾¾å¼
  };
}
```

æ˜ å°„å…³ç³»ç¤ºæ„ï¼ˆä»¥ Fluent DSL ä¸ºæºï¼‰ï¼š

- L1 è§„åˆ™ï¼ˆå• Module å†…è”åŠ¨ï¼‰ï¼š
  - ä»£ç ï¼š`$.onState / $.onAction + $.state.update/mutate`ï¼›
  - IRï¼š`source.context = "self"`ï¼Œ`type = "state" | "action"`ï¼›`pipeline = []`ï¼›`sink.context = "self"`ï¼Œ`type = "mutate"`ã€‚
- L2 è§„åˆ™ï¼ˆè·¨ Module åä½œï¼‰ï¼š
  - ä»£ç ï¼š`$.use(SourceModule/TargetModule) + Fluent DSLï¼ˆæº Module çš„ changes/actions â†’ ç›®æ ‡ Module çš„ dispatchï¼‰`ï¼›
  - IRï¼š`source.context = <SourceModuleId>`ï¼Œ`sink.context = <TargetModuleId>`ï¼›`pipeline = []`ï¼›`sink.type = "dispatch"`ã€‚
- æ›´å¤æ‚çš„å¼‚æ­¥/å¹¶å‘è§„åˆ™ï¼š
  - ä»£ç ï¼šåœ¨ Fluent é“¾ä¸­å åŠ  debounce/filter/switch* ç­‰ç®—å­ï¼›
  - IRï¼šå¯¹åº”åœ¨ `pipeline` ä¸­å¡«å…… `{ op, args }`ï¼Œå…¶ä½™å­—æ®µä¸ä¸Šé¢ä¸€è‡´ã€‚

å¹³å° Parser çš„èŒè´£æ˜¯ï¼š

1. ä» TS ä»£ç ä¸­è§£æ Intent API / Flow ç»„åˆï¼Œå°½å¯èƒ½è¿˜åŸä¸º `IntentRule`ï¼›
2. å¯¹äºè¯†åˆ«ä¸äº†çš„å¤æ‚ Flow/Streamï¼Œé€€åŒ–ä¸º Gray/Black Box èŠ‚ç‚¹ï¼Œä»…ä¿ç•™ minimal ä¿¡æ¯ï¼›
3. åœ¨ç”»å¸ƒ/DSL ç¼–è¾‘è§„åˆ™æ—¶ï¼Œç›´æ¥æ“ä½œ `IntentRule` ç»“æ„ï¼Œå†é€šè¿‡ Generator ç”Ÿæˆæ ‡å‡†åŒ–çš„ Fluent ä»£ç è°ƒç”¨ã€‚

è¿™ä½¿å¾—ï¼š**ä»£ç å†™æ³•å¯ä»¥å¤šæ ·ï¼Œä½†å›¾æ¨¡å‹ä¸å¹³å°åè®®åªæœ‰ä¸€ä¸ªï¼šIntentRuleã€‚**

### 4.1 å¯è§£æå­é›† (Parsable Subset)

ä¸ºäº†å®ç°æœ‰æ•ˆçš„ Full-Duplexï¼ˆIntent â†” Codeï¼‰ï¼ŒLogix è¿è¡Œæ—¶ä»£ç ä¸­åªæœ‰ä¸€éƒ¨åˆ†æ¨¡å¼ä¼šè¢«å¹³å°è§£æä¸ºç»“æ„åŒ–çš„ `IntentRule` æˆ– Logic Graph èŠ‚ç‚¹ï¼Œå…¶ä½™è§†ä¸º Gray/Black Boxã€‚

**Sourceï¼ˆè§¦å‘æºï¼‰**ï¼š

- `flow.fromAction(guard)`ï¼š
  - `guard` åº”ä¸ºç±»å‹å®ˆå«æˆ– `_tag` æ£€æŸ¥çš„ç®€å•å‡½æ•°ï¼Œä¾‹å¦‚ `a => a._tag === 'submit'`ï¼›
  - Parser å°†å…¶è¯†åˆ«ä¸º `source.type = "action"`ï¼Œ`selector = 'submit'`ã€‚
- `flow.fromState(selector)`ï¼š
  - `selector` åº”ä¸ºç®€å•å±æ€§è®¿é—®ï¼ˆ`s => s.country`ã€`s => s.keyword`ï¼‰ï¼›
  - Parser å°†å…¶è¯†åˆ«ä¸º `source.type = "state"`ï¼Œ`selector = 'country'` / `'keyword'`ã€‚
åœ¨æ—©æœŸ PoC ä¸­ï¼ŒL1/L2 è§„åˆ™æ›¾é€šè¿‡ `Intent.andUpdateOnChanges / Intent.andUpdateOnAction` ç­‰ API è¡¨è¾¾ï¼›åœ¨ v3 æœ€ç»ˆå½¢æ€ä¸­ï¼Œè¿™äº›è¯­ä¹‰å…¨éƒ¨å½’å…¥ `IntentRule` IRï¼Œé€šè¿‡ Fluent DSL æ˜ å°„è€Œæ¥ï¼š
  - ç›´æ¥æ˜ å°„ä¸º L1 è§„åˆ™ï¼š`source.context = "self"`ï¼Œ`sink.context = "self"`ï¼Œ`pipeline = []`ã€‚

**Pipelineï¼ˆç®¡é“ç®—å­ï¼‰**ï¼š

- ä»…è¯†åˆ«ä»¥ä¸‹æ ‡å‡† Flow ç®—å­ä½œä¸º pipelineï¼š
  - `flow.debounce(ms)` â†’ `op = "debounce", args = [ms]`ï¼›
  - `flow.throttle(ms)` â†’ `op = "throttle", args = [ms]`ï¼›
  - `flow.filter(predicate)` â†’ `op = "filter"`ï¼ˆpredicate ä»¥ AST å½¢å¼è®°å½•ï¼‰ï¼›
- `flow.run / flow.runLatest / flow.runExhaust` â†’ å¹¶å‘ç­–ç•¥å…ƒä¿¡æ¯ï¼ˆå¦‚å­˜åœ¨ `"sequence"` æ¨¡å¼ï¼Œè½åœ°æ—¶è§†ä¸º `run`ï¼‰ã€‚
- å…¶å®ƒ Stream/Effect ç»„åˆï¼ˆä¾‹å¦‚ `Stream.groupedWithin`ã€è‡ªå®šä¹‰ operatorï¼‰ä¸€å¾‹ä½œä¸º Gray Box å¤„ç†ï¼Œä¸å°è¯•æ‹†è§£ã€‚

**Sinkï¼ˆç»ˆç‚¹ï¼‰**ï¼š

- `state.update / state.mutate`ï¼š
  - è§†ä¸º `sink.type = "mutate"`ï¼Œ`context = "self"`ï¼›
  - handler è¡¨è¾¾å¼ä»¥ AST/å¼•ç”¨å½¢å¼è®°å½•ï¼Œä¾›åç»­å¯è§†åŒ–æˆ–å±€éƒ¨ç¼–è¾‘ã€‚
- `actions.dispatch(action)`ï¼š
  - è§†ä¸º `sink.type = "dispatch"`ï¼Œ`context = "self"` æˆ–ç›®æ ‡ Moduleï¼›
- Pattern / Logic è°ƒç”¨ï¼š
  - `runXxxPattern(config)` æˆ– `makeXxxLogicPattern(config)` / `XxxLogicFromPattern` çš„è°ƒç”¨è§†ä¸º `sink.type = "pattern"`ï¼Œ`handler` è®°å½• Pattern id ä¸ configã€‚

**Control ç»“æ„ï¼ˆç»“æ„åŒ–èŠ‚ç‚¹ï¼‰**ï¼š

- ä»…å¯¹ `$.match` (Branch) / `Effect.catch*` (Error) / `Effect.all` (Parallel) åšç»“æ„åŒ–è§£æï¼š
  - branch â†’ æ¡ä»¶èŠ‚ç‚¹ + then/else å­å›¾ï¼›
  - tryCatch â†’ é”™è¯¯åŸŸèŠ‚ç‚¹ï¼Œcatch åˆ†æ”¯ä¸ä¸»åˆ†æ”¯åˆ†å¼€ï¼›
  - parallel â†’ å¹¶è¡Œåˆ†å‰/æ±‡åˆèŠ‚ç‚¹ã€‚

è¶…å‡ºä¸Šè¿°å­é›†çš„ä»£ç ï¼ˆä¾‹å¦‚ä»»æ„ `Effect.flatMap` é“¾ã€å¤æ‚ Stream ç»„åˆï¼‰ä¸ä¼šè¢«å¼ºåˆ¶è§£æä¸º IntentRuleï¼Œåªä½œä¸º Gray/Black Box èŠ‚ç‚¹å­˜åœ¨ï¼Œæ–¹ä¾¿å¹³å°åœ¨ä¿è¯æ­£ç¡®çš„å‰æä¸‹é€æ­¥æ‰©å¤§å¯è§£æèŒƒå›´ã€‚

## 5. å¯è§‚æµ‹æ€§ä¸ Intent Trace é›†æˆ

Logix é»˜è®¤é›†æˆ Effect Tracing ä¸ç»“æ„åŒ–è°ƒè¯•äº‹ä»¶ï¼ˆè¯¦è§ `09-debugging.md`ï¼‰ï¼Œå¹³å° DevTools å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šæä¾›ï¼š

1. **Timeline View**
   - å±•ç¤º State å˜æ›´æ—¶é—´è½´ï¼›
   - æ¯æ¡å˜æ›´å…³è”è§¦å‘è§„åˆ™ã€æº Path/Action/Inputã€Constraint ä¿¡æ¯ç­‰ã€‚

2. **Causal Graph View**
   - å¯è§†åŒ–å±•ç¤ºå½“å‰å˜æ›´çš„å› æœé“¾ï¼ˆState/Action/Input ä¹‹é—´çš„ä¼ æ’­ï¼‰ï¼›
   - ä¸é™æ€ä¾èµ–å›¾ç»“åˆï¼Œç”¨äºåˆ†æå¤æ‚è”åŠ¨ã€‚
</file>

<file path="runtime-logix/core/07-react-integration.md">
# React é›†æˆæŒ‡å— (React Integration Guide)

> **Status**: Definitive (v3 Effect-Native)
> **Date**: 2025-11-27
> **Layer**: Adapter Layer
> **Audience**: React åº”ç”¨å¼€å‘è€…ä¸ Adapter ä½œè€…ï¼›ä¸æ¶‰åŠå¼•æ“å†…éƒ¨å®ç°ç»†èŠ‚ã€‚

æœ¬æ–‡æ¡£æè¿°äº†å¦‚ä½•å°† Logix å¼•æ“ä¸ React UI æ¡†æ¶æ— ç¼é›†æˆã€‚æ ¸å¿ƒç›®æ ‡æ˜¯å®ç° **UI is Dumb** çš„è®¾è®¡ç†å¿µï¼Œè®© React ä¸“æ³¨äºæ¸²æŸ“ï¼Œè€Œå°†æ‰€æœ‰çŠ¶æ€ç®¡ç†å’Œä¸šåŠ¡é€»è¾‘å§”æ‰˜ç»™ Logixã€‚

> **è§„èŒƒåˆ†çº§æç¤º**
> - æœ¬æ–‡ä¸­çš„è¦æ±‚å¯ä»¥åˆ†ä¸ºä¸‰å±‚ï¼š
>   - **Level 1ï¼ˆè¡Œä¸ºçº¦æŸï¼‰**ï¼šå¿…é¡»æ»¡è¶³çš„è¿è¡Œæ—¶è¯­ä¹‰ï¼Œä¾‹å¦‚â€œé¿å…çŠ¶æ€æ’•è£‚ (tearing)â€â€œRuntime å¼•ç”¨ç¨³å®šâ€ç­‰ï¼›
>   - **Level 2ï¼ˆæ¨è API å½¢çŠ¶ï¼‰**ï¼šä¾‹å¦‚ `useModule(handle, selector, equalityFn?)` çš„å…·ä½“ç­¾åï¼Œå…è®¸åœ¨ä¸ç ´å Level 1 çš„å‰æä¸‹åšå°å¹…è°ƒæ•´ï¼›
>   - **Level 3ï¼ˆé•¿æœŸèƒ½åŠ›ï¼‰**ï¼šå¦‚æ›´ä¸°å¯Œçš„è°ƒè¯•/æ€§èƒ½ç‰¹æ€§ï¼Œå¯ä½œä¸º v3.x æ¼”è¿›ç›®æ ‡ï¼Œè€Œéå½“å‰å¿…é¡»ä¸€æ¬¡æ€§å®ç°çš„éƒ¨åˆ†ã€‚
> - å®ç° `@logix/react` æ—¶ï¼Œåº”ä¼˜å…ˆä¿è¯ Level 1ï¼Œå†åœ¨è¿­ä»£ä¸­é€æ­¥å¯¹é½ Level 2 / Level 3ã€‚

## 1. æ ¸å¿ƒ API: Store Hooks

React é€‚é…å±‚å›´ç»•ä¸‰ç±» Hooks æš´éœ²èƒ½åŠ›ï¼š

- `useModule(handle)`ï¼šè·å–å¯¹åº” Module çš„ `ModuleRuntime`ï¼ˆ**Stable, ä¸è®¢é˜…çŠ¶æ€æ›´æ–°**ï¼‰ï¼›
  - æ”¯æŒ `ModuleInstance`ï¼ˆå…¨å±€å…±äº«ï¼‰ã€`ModuleImpl`ï¼ˆå±€éƒ¨å®ç°ï¼‰æˆ– `ModuleRuntime`ï¼ˆç›´æ¥å¤ç”¨ï¼‰ã€‚
- `useModule(handle, selector, equalityFn?)`ï¼š**[æ¨è]** ç›´æ¥è®¢é˜…çŠ¶æ€ï¼Œå†…éƒ¨åŸºäº `useSyncExternalStore`ï¼Œå¯ä¼ å…¥è‡ªå®šä¹‰ `equalityFn`ï¼›
- `useSelector(handle | runtime, selector, equalityFn?)`ï¼šåœ¨å·²æœ‰ Runtime æˆ– Module Tag ä¸Šåšç»†ç²’åº¦è®¢é˜…ï¼›
- `useDispatch(handle | runtime)`ï¼šè·å–ç¨³å®šçš„ `dispatch` å‡½æ•°ï¼Œè‡ªåŠ¨å¤ç”¨å½“å‰ React Runtimeã€‚

è¿™ä¸‰è€…æ„æˆè¿æ¥ React ä¸ Logix é¢†åŸŸæ¨¡å—çš„åŸºç¡€æ¡¥æ¢ã€‚

### 1.1 ModuleImpl: æ¨èçš„æ¨¡å—å®ç°å•å…ƒ

ä¸ºäº†ç®€åŒ– React ä¾§çš„æ¨¡å—æ¶ˆè´¹ï¼ŒLogix v3 å¼•å…¥äº† `ModuleImpl` æ¦‚å¿µï¼šå°† Module è“å›¾ã€åˆå§‹çŠ¶æ€ã€Logic åˆ—è¡¨å’Œä¾èµ–ç¯å¢ƒæ‰“åŒ…ä¸ºä¸€ä¸ªâ€œå®ç°å•å…ƒâ€ã€‚

**å®šä¹‰ ModuleImpl**:

```typescript
// 1. å®šä¹‰ Module (Shape + Logic Factory)
export const RegionModule = Logix.Module("RegionModule", { state, actions })
export const RegionLogic = RegionModule.logic<RegionService>(/* ... */)

// 2. æ„é€  Impl (ç»‘å®š Initial + Logic)
export const RegionImpl = RegionModule.make({
  initial: { province: null, city: null, isLoading: false },
  logics: [RegionLogic]
})
```

**åœ¨ React ä¸­æ¶ˆè´¹**:

```tsx
function RegionPage() {
  // è‡ªåŠ¨å¤„ç† Scopeã€Layer æ„å»ºå’Œä¾èµ–æ³¨å…¥
  const region = useModule(RegionImpl)

  const province = useSelector(region, s => s.province)
  // ...
}
```

ç›¸æ¯”æ—§çš„ `useLocalModule(factory)`ï¼Œ`ModuleImpl` æ¨¡å¼è®© UI ä»£ç æ›´å¹²å‡€ï¼Œä¸”ç±»å‹æ¨å¯¼æ›´å®Œæ•´ã€‚

```typescript
import { useModule, useDispatch } from '@logix/react';
import { shallow } from '@logix/react'; // æˆ– import { shallow } from 'zustand/shallow'
import { MyModuleLive } from './module'; // Module.live å¯¼å‡ºçš„ Live Layer å¥æŸ„

function MyComponent() {
  // 1. [æ¨è] ç›´æ¥è®¢é˜…çŠ¶æ€ (Unified API)
  const count = useModule(MyModuleLive, s => s.count);

  // 2. ä½¿ç”¨ shallow æ¯”è¾ƒ (æ”¯æŒè¿”å›å¯¹è±¡)
  const { name, age } = useModule(MyModuleLive, s => ({
    name: s.user.name,
    age: s.user.age
  }), shallow);

  // 2. è·å– Runtime (ç”¨äº dispatch æˆ–ä¼ é€’ç»™å­ç»„ä»¶)
  const runtime = useModule(MyModuleLive);
  const dispatch = useDispatch(runtime);

  return (
    <button onClick={() => dispatch({ _tag: 'increment' })}>
      Count: {count}
    </button>
  );
}

> å…³äºåœ¨ Logic å†…éƒ¨æŒ‚ watcherï¼ˆ`Effect.all + run` / `Effect.forkScoped` / `runFork`ï¼‰ä»¥åŠå®ƒä»¬ä¸ Scope / ç”Ÿå‘½å‘¨æœŸçš„å…³ç³»ï¼Œå¯ä»¥åœ¨äº§å“æ–‡æ¡£ä¸­å‚é˜…ã€ŠWatcher æ¨¡å¼ä¸ç”Ÿå‘½å‘¨æœŸã€‹ä¸€èŠ‚ï¼›React åœºæ™¯ä¸‹çš„è¡Œä¸ºä¸æ ¸å¿ƒå¼•æ“ä¿æŒä¸€è‡´ã€‚
```

## 2. çŠ¶æ€è®¢é˜… (State Subscription)

### 2.1 ç»†ç²’åº¦è®¢é˜…ä¸ Memoization

ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼ŒLogix æä¾›äº†ä¸¤ç§å¤„ç† Computed State çš„æ–¹å¼ï¼š

#### æ–¹å¼ Aï¼šä½¿ç”¨ `equalityFn` (Shallow Compare)

ç±»ä¼¼ Zustandï¼Œä½ å¯ä»¥ä¼ å…¥ä¸€ä¸ªæ¯”è¾ƒå‡½æ•°ï¼ˆå¦‚ `shallow`ï¼‰æ¥å…è®¸ Selector è¿”å›æ–°å¯¹è±¡ï¼Œåªè¦å†…å®¹æ²¡å˜å°±ä¸é‡æ¸²æŸ“ã€‚

```typescript
import { shallow } from '@logix/react';

// âœ… Safe: è™½ç„¶æ¯æ¬¡è¿”å›æ–°å¯¹è±¡ï¼Œä½† shallow æ¯”è¾ƒä¼šå‘ç°å†…å®¹æ²¡å˜ï¼Œä¸ä¼šé‡æ¸²æŸ“
const userView = useSelector(runtime, s => ({
  name: s.name,
  role: s.role
}), shallow);
```

#### æ–¹å¼ Bï¼šä½¿ç”¨ Memoized Selector (Reselect / Proxy-Memoize)

å¯¹äºå¤æ‚çš„æ´¾ç”Ÿè®¡ç®—ï¼ˆå¦‚è¿‡æ»¤åˆ—è¡¨ï¼‰ï¼Œå»ºè®®ä½¿ç”¨ `reselect` æˆ– `proxy-memoize` åˆ›å»ºä¸€ä¸ªç¨³å®šçš„ Selectorã€‚

```typescript
import { createSelector } from 'reselect';

// å®šä¹‰ memoized selector (åœ¨ç»„ä»¶å¤–)
const selectActiveUsers = createSelector(
  [(s: State) => s.users, (s: State) => s.filter],
  (users, filter) => users.filter(u => u.name.includes(filter))
);

function UserList() {
  const runtime = useModule(UserModule);
  // âœ… Safe: åªæœ‰å½“ users æˆ– filter å˜åŒ–æ—¶ï¼ŒselectActiveUsers æ‰ä¼šé‡æ–°è®¡ç®—å¹¶è¿”å›æ–°å¼•ç”¨
  const activeUsers = useSelector(runtime, selectActiveUsers);
  return ...
}
```

> **æ€§èƒ½æœ€ä½³å®è·µ**ï¼š
> 1. **Selector è¿”å›åŸå­å€¼**ï¼šå°½é‡è®© Selector è¿”å› string/number/boolean ç­‰åŸºæœ¬ç±»å‹ã€‚
> 2. **Stable Runtime**ï¼š`useModule(handle)` è·å–çš„ runtime å¼•ç”¨æ°¸è¿œä¸å˜ï¼Œå¯æ”¾å¿ƒä½œä¸º Props ä¼ é€’ç»™å­ç»„ä»¶ï¼Œä¸ä¼šè§¦å‘ `React.memo` å¤±æ•ˆã€‚
> 3. **Logic ç‹¬ç«‹çº¿ç¨‹**ï¼šLogix çš„ä¸šåŠ¡é€»è¾‘åœ¨ Effect Runtime ä¸­è¿è¡Œï¼Œä¸ä¼šé˜»å¡ React æ¸²æŸ“çº¿ç¨‹ï¼ˆMain Threadï¼‰ï¼Œåªæœ‰æœ€ç»ˆçŠ¶æ€å˜æ›´æ‰ä¼šé€šçŸ¥ UIã€‚

> å®ç°çº¦æŸï¼ˆAdapter å±‚ï¼‰ï¼š
> - **Level 2ï¼ˆæ¨è API å½¢çŠ¶ï¼‰**ï¼š`useSelector` / `useModule(handle, selector)` ç­¾åå»ºè®®ä¸º `(handle | runtime, selector, equalityFn?)`ï¼Œé»˜è®¤ `equalityFn` ä¸º `Object.is`ï¼›
> - **Level 1ï¼ˆè¡Œä¸ºçº¦æŸï¼‰**ï¼šè®¢é˜…å¿…é¡»é€šè¿‡ `useSyncExternalStore` æˆ–ç­‰ä»·æœºåˆ¶å®ç°ï¼ŒReact Adapter è´Ÿè´£å°è£… selector / equality è¡Œä¸ºï¼Œä¸šåŠ¡ä¾§æ— éœ€æ¥è§¦åº•å±‚è®¢é˜…å®ç°ï¼›
> - React Runtime Adapter åœ¨è¿è¡Œ Effect å‰éœ€è‡ªåŠ¨è¡¥é½æ‰€æœ‰ Layer/Contextï¼Œä¿è¯ selector/dispatch ä¸ App Runtime ç›¸åŒçš„ä¾èµ–è§†å›¾ã€‚

## 3. æ„å›¾æ´¾å‘ (Intent Dispatch)

### 3.1 `dispatch` å‡½æ•°

`useDispatch` è¿”å›çš„ `dispatch` å‡½æ•°ç”¨äºå‘ Module å‘é€ Actionã€‚å®ƒæ˜¯ç±»å‹å®‰å…¨çš„ï¼Œä¼šè‡ªåŠ¨æ¨å¯¼ `ActionSchema` ä¸­å®šä¹‰çš„ Action ç±»å‹ã€‚

```typescript
const moduleRuntime = useModule(myModule);
const dispatch = useDispatch(moduleRuntime);
dispatch({ _tag: 'updateUser', payload: { name: 'Alice' } });
```

> UI Intent ç»‘å®šçº¦å®šï¼š
> - UI å±‚æ‰€æœ‰ä¸šåŠ¡äº‹ä»¶æœ€ç»ˆåº”æ˜ å°„åˆ°å·²æœ‰çš„ Action æˆ– IntentRule/Flow Anchorï¼›
> - React Adapter å±‚åªæä¾› `dispatch` è¿™ä¸ªç¨³å®šé”šç‚¹ï¼Œä¸æ„ŸçŸ¥ UI Schema æˆ–ç»„ä»¶æ ‘ç»“æ„ã€‚

## 3.2 æ´¾ç”ŸçŠ¶æ€ä¸ç¬æ€ UI çŠ¶æ€

åœ¨è®¾è®¡ React å±‚çš„çŠ¶æ€ä½¿ç”¨æ–¹å¼æ—¶ï¼Œéœ€è¦åŒºåˆ†ä¸‰ç±»æ•°æ®ï¼š

- **Persistent Derivedï¼ˆæŒä¹…æ´¾ç”ŸçŠ¶æ€ï¼‰**ï¼š
  - ä¸šåŠ¡ä¸Šæœ‰è¯­ä¹‰ã€éœ€è¦å‚ä¸å›æ”¾/å®¡è®¡çš„æ´¾ç”Ÿæ•°æ®ï¼ˆå¦‚ `orderTotal`ã€`hasOverdue`ï¼‰ï¼›
  - åº”é€šè¿‡ Logic è§„åˆ™ï¼ˆBound API `$` + Fluent DSL / Flowï¼‰è½åœ¨ Module State ä¸­ï¼Œç”± Logix ç®¡ç†ã€‚
- **Transient Derivedï¼ˆè§†å›¾æ´¾ç”ŸçŠ¶æ€ï¼‰**ï¼š
  - ä»…ç”¨äºè§†å›¾å‘ˆç°ï¼Œä¸éœ€è¦æŒä¹…åŒ–æˆ–è·¨é€»è¾‘å¤ç”¨ï¼ˆå¦‚æ ¼å¼åŒ–æ–‡æ¡ˆã€å±€éƒ¨æ˜¾éšï¼‰ï¼›
  - æ¨èåœ¨ React æ¸²æŸ“æ—¶é€šè¿‡ `useSelector` è®¡ç®—ï¼Œä¿æŒ Module State ç²¾ç®€ã€‚
- **Ephemeral UI Stateï¼ˆç¬æ€ UI çŠ¶æ€ï¼‰**ï¼š
  - å®Œå…¨å±äº UI è¡¨ç°å±‚ï¼Œå¦‚ hover çŠ¶æ€ã€æŸä¸ªæŠ˜å é¡¹æ˜¯å¦å±•å¼€ã€ä¸´æ—¶è¾“å…¥æ¡†å†…å®¹ç­‰ï¼›
  - æ¨èä¿ç•™åœ¨ React æœ¬åœ° state æˆ– UI Intent ä¸­ä»¥ `$local` æºè¡¨è¾¾ï¼Œä¸åº”é•¿æœŸå†™å…¥ Module Stateã€‚

90: å®è·µä¸Šï¼š

- â€œéœ€è¦å›æ”¾å’Œå®¡è®¡â€çš„çŠ¶æ€ä¸€å¾‹è¿›å…¥ Logixï¼›
- â€œåªæ˜¯ä¸ºäº†è¿™ä¸€å±å¥½çœ‹/å¥½ç”¨â€çš„çŠ¶æ€å°½é‡é€šè¿‡ `useSelector` æˆ–æœ¬åœ° state è§£å†³ï¼›
- React Adapter ä¸æ–°å¢çŠ¶æ€æ¦‚å¿µï¼Œåªæä¾›è®¿é—®é¢†åŸŸæ¨¡å—è¿è¡Œæ—¶çš„ Hook ä¸è®¢é˜…æ¡¥æ¥ã€‚

## 4. ä¾èµ–æ³¨å…¥ä¸è¿è¡Œæ—¶å…¥å£ (Dependency Injection & Entry)

Logix é€šè¿‡ `RuntimeProvider` ç»„ä»¶åœ¨ React æ ‘ä¸­æ³¨å…¥ Effect è¿è¡Œæ—¶ç¯å¢ƒã€‚æ ¸å¿ƒèƒ½åŠ›ï¼š

- `app={Logix.app(...)}`ï¼šæ„å»ºæ–°çš„ App Runtime å¹¶æ‰˜ç®¡å…¶ Scopeï¼Œè‡ªåŠ¨æ³¨å…¥ `ReactPlatformLayer`ï¼›
- `layer={Layer}`ï¼šåœ¨çˆ¶ Runtime åŸºç¡€ä¸Šè¿½åŠ å±€éƒ¨ Layerï¼Œæ‰€æœ‰ `useModule`/`useSelector` å°†è‡ªåŠ¨ `provide` è¯¥ Layer è¾“å‡ºï¼›
- `runtime={ManagedRuntime}`ï¼ˆæˆ– legacy `value`ï¼‰ï¼šç›´æ¥å¤ç”¨å¤–éƒ¨æ„é€ çš„ Runtimeï¼ˆå¸¸ç”¨äºæµ‹è¯•ï¼‰ã€‚

v3 æ¨èä»¥ `Logix.app` å®šä¹‰çš„åº”ç”¨è“å›¾ä½œä¸ºå…¨åº”ç”¨çš„ç»„åˆæ ¹ï¼Œå±€éƒ¨å¢å¼ºå†é€šè¿‡ `layer` å åŠ ã€‚

### 4.1 æ¨èæ¨¡å¼ï¼šApp è“å›¾æ³¨å…¥ (App Blueprint)

æœ€ä½³å®è·µæ˜¯ä½¿ç”¨ `Logix.app` å®šä¹‰çš„åº”ç”¨è“å›¾ï¼Œå¹¶é€šè¿‡ `app` å±æ€§ä¼ å…¥ã€‚è¿™æ˜¯å…¨åº”ç”¨çš„ **Composition Root**ã€‚

```tsx
// src/App.tsx
import { RuntimeProvider } from '@logix/react';
import { CRMApp } from './app'; // ç”± Logix.app å®šä¹‰

function App() {
  return (
    // è‡ªåŠ¨æ„å»º AppRuntimeï¼Œå¯åŠ¨å…¨å±€æœåŠ¡å’Œ Coordinators
    <RuntimeProvider app={CRMApp}>
      <Router />
    </RuntimeProvider>
  );
}
```

åœ¨è¿™ä¸€æ¨¡å¼ä¸‹ï¼š

- `CRMApp` å†…éƒ¨ä¼šé€šè¿‡ `Logix.app` èšåˆ `infra`ï¼ˆHttp / Router / Config ç­‰ï¼‰ä¸ `modules`ï¼ˆå…¨å±€ Moduleï¼‰ï¼Œå¹¶åœ¨æ ¹ Scope ä¸Šå¯åŠ¨ `processes` ä¸­å®šä¹‰çš„é•¿ç”Ÿå‘½å‘¨æœŸè¿›ç¨‹ï¼ˆä¾‹å¦‚ Coordinatorï¼‰ï¼›
- `RuntimeProvider` è´Ÿè´£åœ¨ React åº”ç”¨ç”Ÿå‘½å‘¨æœŸå†…æŒæœ‰è¯¥ Runtime çš„ Scopeï¼Œå½“åº”ç”¨å¸è½½æ—¶è‡ªåŠ¨è§¦å‘èµ„æºé‡Šæ”¾ã€‚

> React ç«¯é»˜è®¤ä¼šæ³¨å…¥ `ReactPlatformLayer`ï¼Œå°† Page Visibilityã€Tab Suspend/Resume ç­‰ä¿¡å·æ˜ å°„åˆ° `Logic.Platform`ï¼Œæ¨¡å—é€»è¾‘å¯ä»¥é€šè¿‡ `yield* Logic.Platform` è®¢é˜…è¿™äº›äº‹ä»¶ã€‚

### 4.2 å…¼å®¹æ¨¡å¼ï¼šLayer æ³¨å…¥ (Layer Injection)

å¯¹äºå±€éƒ¨ç¯å¢ƒå¢å¼ºï¼ˆå¦‚ Page å±‚æ³¨å…¥å±€éƒ¨ Moduleï¼‰ï¼Œæˆ–è€…ç®€å•çš„æµ‹è¯•åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨ `layer` å±æ€§ï¼š

```tsx
// src/pages/OrderPage.tsx
import { RuntimeProvider, useLocalModule } from '@logix/react';
import { Layer } from 'effect';

function OrderPage({ userId }: { userId: string }) {
  const pageRuntime = useLocalModule(() => makeOrderPageModule(userId), [userId]);
  const PageLayer = Layer.succeed(OrderPageModuleTag, pageRuntime);

  return (
    <RuntimeProvider layer={PageLayer}>
      <SubComponent />
    </RuntimeProvider>
  );
}
```

> è¯´æ˜
> - `RuntimeProvider app={...}` ç”¨äºæä¾›å…¨å±€ AppRuntimeï¼Œæ˜¯åº”ç”¨çš„å•ä¸€ç»„åˆæ ¹ï¼›
> - `RuntimeProvider layer={...}` ç”¨äºåœ¨æŸä¸ªå­æ ‘ä¸‹å¢å¼ºç¯å¢ƒï¼ˆä¾‹å¦‚æ³¨å…¥é¡µé¢çº§ Module æˆ–å±€éƒ¨æœåŠ¡ï¼‰ï¼Œå†…éƒ¨ä¼šåœ¨å·²æœ‰ Runtime ç¯å¢ƒä¹‹ä¸Šåˆå¹¶ä¼ å…¥çš„ Layerã€‚

## 5. ç”Ÿå‘½å‘¨æœŸç»‘å®š (Lifecycle Binding)

åœ¨ React é€‚é…å±‚ï¼Œ`useModule` ä¸ `useLocalModule` ä½“ç°äº†ä¸¤ç§ä¸åŒçš„â€œå½’å±å…³ç³»â€ï¼š

### 5.1 å…¨å±€ Module (Global Module)

åœ¨ `Logix.app` çš„ `modules` ä¸­æ³¨å†Œçš„ Module æ˜¯å…¨å±€çš„ï¼š

```ts
// app.ts
export const CRMApp = Logix.app({
  // æ³¨å…¥ React å¹³å°èƒ½åŠ› (onSuspend/onResume ç­‰)
  layer: Layer.mergeAll(AppInfraLayer, ReactPlatformLayer),
  modules: [
    Logix.provide(GlobalModuleTag, GlobalModuleRuntime),
    // ...
  ],
  processes: [/* Coordinators / é•¿ç”Ÿå‘½å‘¨æœŸè¿›ç¨‹ */],
});
```

å­ç»„ä»¶é€šè¿‡ `useModule(GlobalModuleTag)` æ¶ˆè´¹ï¼Œä¸éœ€è¦ç®¡ç†å…¶ç”Ÿå‘½å‘¨æœŸï¼›Module çš„ Scope ç»‘å®šåˆ° AppRuntimeï¼Œç”±æœ€å¤–å±‚çš„ `RuntimeProvider app={CRMApp}` ç®¡ç†ã€‚

### 5.2 å±€éƒ¨ Module (Local Module)

å¯¹äºé¡µé¢çº§æˆ–ç»„ä»¶çº§çŠ¶æ€ï¼Œä½¿ç”¨ `useLocalModule` åœ¨å½“å‰ç»„ä»¶ä¸‹åˆ›å»ºå¹¶æŒæœ‰ Moduleï¼š

```ts
import { useLocalModule } from '@logix/react';

function UserForm({ userId }: { userId: string }) {
  // factory éœ€è¿”å› Effect<ModuleRuntime>ï¼›deps æ§åˆ¶å¤ç”¨/é‡å»º
  const moduleRuntime = useLocalModule(() => makeUserFormModule(userId), [userId]);
  const values = useSelector(moduleRuntime, s => s.values);
  const dispatch = useDispatch(moduleRuntime);

  // ...
}
```

`useLocalModule` ä¹Ÿæ”¯æŒç›´æ¥ä¼ å…¥ `ModuleInstance` + é…ç½®ï¼š

```ts
const editor = useLocalModule(EditorModule, {
  initial: { content: "" },
  logics: [EditorLogic],
  deps: [docId]
});
```

> `deps` å†³å®šä½•æ—¶é‡æ–°åˆ›å»ºå±€éƒ¨ Moduleï¼ˆç±»ä¼¼ React `useMemo` è¯­ä¹‰ï¼‰ï¼›é»˜è®¤ä¸ä¼šå› ä¸º `initial` æˆ– `logics` å¼•ç”¨å˜åŒ–è‡ªåŠ¨é‡å»ºï¼Œéœ€è¦è°ƒç”¨æ–¹æ˜¾å¼ä¼ å…¥ã€‚

è¿™é‡Œ `UserForm` ç»„ä»¶æ˜¯è¿™æ£µ Module çš„â€œå®¿ä¸»â€ï¼ŒModule çš„ Scope ä¸ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼š
ç»„ä»¶å¸è½½æ—¶ï¼Œå¯¹åº” Module Scope ä¼šè¢«å…³é—­ï¼Œæ‰€æœ‰æŒ‚åœ¨å…¶ä¸Šçš„ `forkScoped` é•¿é€»è¾‘ä¼šè¢«å®‰å…¨ä¸­æ–­ã€‚

> çº¦å®šï¼š
> - ç»„ä»¶å†…è¯»å– State ä¸æ´¾å‘ Action æ¨èç»Ÿä¸€é€šè¿‡ `useModule(Impl)` è·å– Runtime åå†æ“ä½œï¼›
> - `useLocalModule` ä½œä¸ºåº•å±‚ API ä»è¢«ä¿ç•™ï¼Œç”¨äºéœ€è¦è‡ªå®šä¹‰ factory çš„é«˜çº§åœºæ™¯ã€‚
> - ç»„ä»¶å¤–çš„ä¸šåŠ¡é€»è¾‘ / Pattern å¯ä»¥ç›´æ¥ä½¿ç”¨ `module.dispatch` / `module.getState`ã€‚
</file>

<file path="runtime-logix/core/08-usage-guidelines.md">
# ä½¿ç”¨æŒ‡å—ä¸æœ€ä½³å®è·µ (Usage Guidelines & Best Practices)

> **Status**: Draft (v3 Effect-Native)
> **Date**: 2025-11-24
> **Layer**: Application Layer
> **Audience**: åº”ç”¨/ä¸šåŠ¡å¼€å‘è€…çš„æ—¥å¸¸ä½¿ç”¨æŒ‡å—ï¼›åº“ä½œè€…ä¸æ¶æ„å¸ˆå¯åœ¨æ­¤åŸºç¡€ä¸Šåˆ¶å®šå›¢é˜Ÿè§„èŒƒã€‚

æœ¬æ–‡æ¡£æ—¨åœ¨æŒ‡å¯¼å¼€å‘è€…å¦‚ä½•æ­£ç¡®ã€ä¼˜é›…åœ°ä½¿ç”¨ Logix æ„å»ºåº”ç”¨ã€‚æ ¸å¿ƒåœ¨äºæ‹¥æŠ± **Layer (å±‚)** ä¸ **Stream (æµ)** çš„ç»„åˆå“²å­¦ã€‚

## 1. æ ¸å¿ƒåŸåˆ™ (Core Principles)

### 1.1 Composition over Configuration (ç»„åˆä¼˜äºé…ç½®)
*   **åŸåˆ™**: ä¸è¦è¯•å›¾åœ¨ä¸€ä¸ªå·¨å¤§çš„é…ç½®å¯¹è±¡ä¸­å®šä¹‰æ‰€æœ‰ä¸œè¥¿ã€‚å°† Logic æ‹†åˆ†ä¸ºå¤šä¸ªå°çš„ Logic ç¨‹åºï¼ˆLogic å•å…ƒï¼‰ï¼Œç„¶åç»„åˆå®ƒä»¬å¹¶æŒ‚è½½åˆ°å¯¹åº”çš„ Module ä¸Šã€‚
*   **æ¨¡å¼**: `Module.live(initialState, AuthLogic, UserLogic, FormLogic)`ã€‚

### 1.2 Streams are First-Class (æµæ˜¯ä¸€ç­‰å…¬æ°‘)
*   **åŸåˆ™**: æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘æœ¬è´¨ä¸Šéƒ½æ˜¯å¯¹äº‹ä»¶æµçš„å˜æ¢ã€‚ä½¿ç”¨ `source.pipe(...)` æ¥è¡¨è¾¾è¿™ç§å˜æ¢ã€‚
*   **æ¨¡å¼**: `Trigger -> Transform -> Effect`ã€‚

## 2. æœ€ä½³å®è·µæ¨¡å¼ (Patterns)

### 2.1 æ•°æ®åŠ è½½ (Data Fetching)

**æ¨èæ¨¡å¼**: ä½¿ç”¨ `flow.run` æŒ‚è½½å¼‚æ­¥ Effectã€‚

```ts
const refresh$ = flow.fromAction(
  (a): a is { _tag: "refresh" } => a._tag === "refresh",
);

yield* refresh$.pipe(
  flow.run(
    Effect.gen(function* (_) {
      yield* state.update(prev => ({ ...prev, loading: true }));
      // ... fetch data
      yield* state.update(prev => ({ ...prev, loading: false }));
    }),
  ),
);
```

### 2.2 å¤æ‚è”åŠ¨ (Complex Linkage)

**æ¨èæ¨¡å¼**: ç»„åˆå¤šä¸ª Stream ç®—å­ã€‚

```ts
const keyword$ = flow.fromState(s => s.search);

yield* keyword$.pipe(
  flow.debounce(300),
  flow.filter(q => q.length > 2),
  flow.runLatest(
    Effect.gen(function* (_) {
      // è§¦å‘æœç´¢é€»è¾‘ï¼Œä¾‹å¦‚æ´¾å‘å¦ä¸€ä¸ª Action æˆ–ç›´æ¥è°ƒç”¨ Service
      yield* actions.dispatch({ _tag: "search/trigger" });
    }),
  ),
);
```

### 2.3 Intent åŸè¯­é€‰æ‹© (L1 / L2 / L3)

Logix åœ¨ Intent å±‚æä¾›äº†ä¸‰æ¡£â€œå“åº”å¼æ„å›¾â€è¡¨è¾¾ï¼Œä»£ç ä¾§ä»¥ Fluent DSL ä¸ºä¸»ã€IR å±‚ç»Ÿä¸€ç”¨ `IntentRule` æ ‡å‡†åŒ–è¡¨ç¤ºï¼Œå»ºè®®ä¼˜å…ˆæŒ‰å±‚çº§é€‰æ‹©ï¼š

| å±‚çº§ | åœºæ™¯ | ä»£ç æ¨èåŸè¯­ | IR æ˜ å°„ | è¯´æ˜ |
| --- | --- | --- | --- | --- |
| L1ï¼šå• Store å†…åŒæ­¥è”åŠ¨ | ç›‘å¬æŸä¸ª State è§†å›¾å˜åŒ–ï¼Œå¹¶ç»´æŠ¤æ´¾ç”Ÿå­—æ®µ | `$.onState(selector).update/mutate(...)` | L1 IntentRuleï¼ˆself.state â†’ self.mutateï¼‰ | ä¾‹å¦‚ `results` å˜åŒ–æ—¶è‡ªåŠ¨ç»´æŠ¤ `hasResults`ã€`summary` ç­‰ |
| L1ï¼šå• Store å†…åŒæ­¥è”åŠ¨ | ç›‘å¬æŸä¸€ç±» Action å¹¶é‡æ’å½“å‰ Store State | `$.onAction(predicate).update/mutate(...)` | L1 IntentRuleï¼ˆself.action â†’ self.mutateï¼‰ | ä¾‹å¦‚è¡¨å• `change/reset`ã€Tab åˆ‡æ¢ã€æ˜¾å¼ reset ç­‰ç¦»æ•£äº‹ä»¶ |
| L2ï¼šè·¨ Module åä½œ | A.Module çš„ State/Action é©±åŠ¨ B.Module çš„ Action | `$.use(AModule/BModule) + Fluent DSLï¼ˆ$A.changes/â€¦ â†’ $B.dispatchï¼‰` | L2 IntentRuleï¼ˆA.state/A.action â†’ B.dispatchï¼‰ | ä¾‹å¦‚ SearchModule â†’ DetailModuleã€GlobalLayoutModule.logout â†’ å„ Module reset |
| L2/L3ï¼šå¤æ‚å¼‚æ­¥æµä¸å‰¯ä½œç”¨ | ç›‘å¬ Action/State è§¦å‘å¤æ‚é•¿é€»è¾‘ï¼ˆè°ƒç”¨å¤šä¸ª Serviceã€å¸¦é”™è¯¯è¾¹ç•Œï¼‰ | Fluent DSL æˆ– `flow.run*` + `$.match` / `Effect.*` | `Intent.react`ï¼ˆé¢„ç•™ï¼‰æˆ–è‡ªå®šä¹‰èŠ‚ç‚¹ | ä¾‹å¦‚æäº¤æµç¨‹ã€å®¡æ‰¹æµã€Job è¿è¡Œï¼Œé€šå¸¸å°è£…ä¸º `(input) => Effect` çš„ Pattern |
| L3ï¼šæåº¦å®šåˆ¶åŒ–æµå¤„ç† | éœ€è¦ç²¾ç»†æ§åˆ¶ Stream ç»“æ„ï¼ˆbufferã€groupByã€ä½å±‚ Stream ç»„åˆï¼‰ | ç›´æ¥ä½¿ç”¨ `Stream.*` / `Effect.*` | æ— ï¼ˆGray/Black Boxï¼‰ | å¹³å°è§†ä¸º Gray/Black Boxï¼Œé€‚åˆé«˜åº¦è‡ªå®šä¹‰åœºæ™¯ |

å…¶ä¸­ï¼š

- L1 å¯¹åº”æ—¥å¸¸ 80% çš„ç®€å•è”åŠ¨åœºæ™¯ï¼Œæ¨èé»˜è®¤ä½¿ç”¨ Fluent DSLï¼›
- L2 ç”¨äºæ˜¾å¼è¡¨è¾¾è·¨ Module åä½œå…³ç³»ï¼Œä»£ç ä¾§é€šè¿‡ `$.use + $.on*`ï¼ŒIR å±‚è½åˆ° L2 IntentRuleï¼Œä¾¿äºå¹³å°åœ¨å›¾ä¸Šå‘ˆç°æ¨¡å—ä¾èµ–ï¼›
- L3 ä»…åœ¨ Fluent/Intent åŸè¯­æ— æ³•è¦†ç›–æ—¶ä½œä¸ºé€ƒé€¸å£ä½¿ç”¨ã€‚

## 3. é€»è¾‘æ‹†åˆ† (Logic Splitting)

åœ¨ v3 æ¶æ„ä¸­ï¼Œé€»è¾‘æ‹†åˆ†å˜å¾—æå…¶ç®€å•ï¼šåªéœ€å®šä¹‰å¤šä¸ª Logic ç¨‹åºï¼ˆå¤šä¸ª `Module.logic(...)` æˆ– Pattern äº§å‡ºçš„ Logicï¼‰ï¼Œç„¶åå°†å®ƒä»¬æŒ‚è½½åˆ°åŒä¸€ä¸ª Module ä¸Šã€‚

```typescript
// features/auth/logic.ts
export const AuthLogic = AuthModule.logic($ => /* ... */);

// features/user/logic.ts
export const UserLogic = UserModule.logic($ => /* ... */);

// live.ts
export const AuthLive = AuthModule.live(initialAuthState, AuthLogic);
export const UserLive = UserModule.live(initialUserState, UserLogic);
```

## 4. Module è®¾è®¡ä¸å¤šå®ä¾‹ (Module Design & Multi-Instance)

ä¸ºäº†è®©é¢†åŸŸæ¨¡å—çœŸæ­£æˆä¸ºâ€œå¯ç‹¬ç«‹æ¼”è¿› / å¤ç”¨çš„é€»è¾‘å•å…ƒâ€ï¼Œæ¨èéµå¾ªä»¥ä¸‹çº¦å®šï¼š

- Module æ¨¡å—å¯¼å‡ºçš„æ˜¯ **å¥‘çº¦ä¸ Layer å·¥å‚**ï¼Œè€Œä¸æ˜¯å¼ºè¡Œå•ä¾‹ï¼š
  - å¯¼å‡º `Module` å®šä¹‰ï¼ˆ`Logix.Module('Id', { state, actions })`ï¼‰ï¼›
  - å¯¼å‡ºä¸€ä¸ª `makeXxxLive(env)` å·¥å‚å‡½æ•°ï¼Œå†…éƒ¨è°ƒç”¨ `Module.live(initial, ...logics)`ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨æ¨¡å—é¡¶å±‚åˆ›å»ºå•ä¾‹ Layerã€‚
- å®¿ä¸»å†³å®šæ˜¯å•ä¾‹è¿˜æ˜¯å¤šå®ä¾‹ï¼š
  - App Shell å¯ä»¥é€‰æ‹©åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨å·¥å‚ä¸€æ¬¡ï¼Œå¾—åˆ°å…¨å±€ Live Layerï¼›
  - é¡µé¢ / å¼¹æ¡†å¯ä»¥é€šè¿‡ `useLocalStore(() => makeXxxLive(props), deps)` åˆ›å»ºé¡µé¢çº§å®ä¾‹ã€‚
- è¯¦ç»†çš„å¤šå®ä¾‹æ¨¡å¼ï¼ˆå·¥å‚æ¨¡å¼ vs ä½œç”¨åŸŸæ¨¡å¼ï¼‰å¯¹æ¯”ä¸æœ€ä½³å®è·µï¼Œè¯·å‚è€ƒ **[10-pattern-multi-instance.md](./10-pattern-multi-instance.md)**ã€‚
- è·¨ Module åä½œé€šè¿‡ Intent å±‚è¡¨è¾¾ï¼š
  - ä½¿ç”¨ Fluent DSL + IntentRuleï¼ˆLink / Logic åä½œåŸè¯­ï¼‰ï¼Œæè¿°"ModuleA çŠ¶æ€ / Action å˜åŒ–å¦‚ä½•é©±åŠ¨ ModuleB"ï¼›
  - é¿å…åœ¨æŸä¸ª Module å†…éƒ¨ç›´æ¥è¯»å– / ä¿®æ”¹å¦ä¸€ä¸ª Module çš„å†…éƒ¨çŠ¶æ€å®ç°ç»†èŠ‚ã€‚

## 5. è°ƒè¯•æŒ‡å—

ç”±äºä¸€åˆ‡çš† Effectï¼Œä½ å¯ä»¥ä½¿ç”¨ Effect ç”Ÿæ€çš„æ‰€æœ‰è°ƒè¯•å·¥å…·ã€‚

*   **Effect Tracer**: æŸ¥çœ‹å®Œæ•´çš„æ‰§è¡Œé“¾è·¯ã€‚
*   **Logix DevTools**: æŸ¥çœ‹ Action å’Œ State çš„å˜åŒ–ã€‚
</file>

<file path="runtime-logix/core/09-debugging.md">
# è°ƒè¯•åŠŸèƒ½ (Debugging Features)

> **Status**: Draft (v3 Effect-Native)
> **Date**: 2025-11-24
> **Layer**: Tooling Layer

Logix æä¾›äº†å¼ºå¤§çš„è°ƒè¯•èƒ½åŠ›ï¼Œæ—¨åœ¨è®©é€»è¾‘æ‰§è¡Œè¿‡ç¨‹é€æ˜åŒ–ã€å¯è§†åŒ–ã€‚æ ¸å¿ƒæ˜¯åŸºäº **Action Trace** çš„å…¨é“¾è·¯è¿½è¸ªç³»ç»Ÿã€‚

## 1. DevTools æ¶æ„

Logix DevTools æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ Chrome æ‰©å±•æˆ– React ç»„ä»¶ï¼Œé€šè¿‡ `DevToolsBridge` ä¸ Logix å¼•æ“é€šä¿¡ã€‚v3.1 èµ·ï¼Œæ ¸å¿ƒè¿è¡Œæ—¶å†…ç½® `DebugSink` Tagï¼Œå¯ç”±ä»»æ„ Layer æä¾›å®ç°ä»¥æ¶ˆè´¹è°ƒè¯•äº‹ä»¶ï¼ˆé»˜è®¤ Noopï¼‰ã€‚

### 1.0 DebugSink æ¥å£

```ts
export type DebugEvent =
  | { type: "module:init"; moduleId?: string }
  | { type: "module:destroy"; moduleId?: string }
  | { type: "action:dispatch"; moduleId?: string; action: unknown }
  | { type: "state:update"; moduleId?: string; state: unknown }
  | { type: "lifecycle:error"; moduleId?: string; cause: unknown }

export interface DebugSink {
  record(event: DebugEvent): Effect<void>
}

export const DebugSinkTag = Context.GenericTag<DebugSink>("@logix/DebugSink")
```

å¼•æ“é»˜è®¤æä¾› `NoopDebugSinkLayer`ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `ConsoleDebugLayer` åœ¨å¼€å‘æ¨¡å¼ä¸‹ç›´æ¥è¾“å‡ºäº‹ä»¶ã€‚ModuleRuntime ä¼šåœ¨ `onInit` / `onDestroy`ã€Action æ´¾å‘ã€çŠ¶æ€æ›´æ–°ä»¥åŠ lifecycle é”™è¯¯æ—¶è‡ªåŠ¨å¹¿æ’­äº‹ä»¶ã€‚

### 1.1 é€šä¿¡åè®®

å¼•æ“ä¼šå¹¿æ’­ä»¥ä¸‹äº‹ä»¶ï¼š

*   `INIT`: Store åˆ›å»ºã€‚
*   `ACTION`: Action è¢«æ´¾å‘ã€‚
*   `STATE_CHANGE`: State å‘ç”Ÿå˜åŒ–ã€‚
*   `FLOW_TRIGGER`: Flow è¢«è§¦å‘ã€‚
*   `EFFECT_START` / `EFFECT_END`: å‰¯ä½œç”¨æ‰§è¡Œèµ·æ­¢ã€‚

## 2. æ ¸å¿ƒè§†å›¾

### 2.1 Timeline (æ—¶é—´è½´)

å±•ç¤ºåº”ç”¨è¿è¡Œçš„æ—¶é—´çº¿ã€‚æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ª Action æˆ– State Changeã€‚

### 2.2 State Tree (çŠ¶æ€æ ‘)

å®æ—¶å±•ç¤ºå½“å‰çš„ State ç»“æ„ã€‚

### 2.3 Logic Flow (é€»è¾‘æµ)

è¿™æ˜¯ Logix ç‰¹æœ‰çš„è§†å›¾ã€‚å®ƒå±•ç¤ºäº† Action æ˜¯å¦‚ä½•ä¸€æ­¥æ­¥è§¦å‘ Flowï¼Œè¿›è€Œäº§ç”Ÿ Effect çš„ã€‚

## 3. è¿½è¸ªç³»ç»Ÿ (Tracing System)

### 3.1 Trace ID

æ¯ä¸ªå¤–éƒ¨è§¦å‘ï¼ˆç”¨æˆ·ç‚¹å‡»ã€WebSocket æ¶ˆæ¯ï¼‰éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ `TraceID`ã€‚è¿™ä¸ª ID ä¼šéšç€é€»è¾‘é“¾è·¯ä¼ é€’ã€‚

```text
[Trace: abc-123] User Clicked Button
  -> Dispatch Action: SUBMIT
  -> Trigger Flow: SubmitForm
  -> Effect: Set Loading = true
  -> Effect: Call API
  -> Effect: Dispatch Action: SUBMIT_SUCCESS
    -> Trigger Flow: ShowToast
```

### 3.2 å› æœå›¾ (Causality Graph)

åŸºäº Trace IDï¼ŒDevTools å¯ä»¥æ„å»ºå‡ºâ€œå› æœå›¾â€ï¼Œæ¸…æ™°åœ°å±•ç¤ºâ€œè°è§¦å‘äº†è°â€ã€‚
</file>

<file path="runtime-logix/core/10-pattern-multi-instance.md">
# Pattern: Module Multi-Instance Strategy

> **Status**: Draft (v3)
> **Context**: å¤„ç† Dashboard Widgetã€åˆ—è¡¨é¡¹ã€å¤šçª—å£ç­‰éœ€è¦â€œåŒä¸€é€»è¾‘ã€å¤šä»½æ•°æ®â€çš„åœºæ™¯ã€‚

åœ¨ Logix ä½“ç³»ä¸­ï¼Œå½“ä¸šåŠ¡éœ€è¦â€œåŒä¸€ä¸ª Module é€»è¾‘åœ¨åŒä¸€é¡µé¢å­˜åœ¨å¤šä¸ªç‹¬ç«‹å‰¯æœ¬â€æ—¶ï¼ˆä¾‹å¦‚ä¸¤ä¸ªç‹¬ç«‹çš„è®¡æ•°å™¨ã€å¤šä¸ªèŠå¤©çª—å£ï¼‰ï¼Œä¸»è¦æœ‰ä¸¤ç§å®ç°è·¯å¾„ï¼š

1.  **å·¥å‚æ¨¡å¼ (Factory Pattern)**ï¼šæ˜¾å¼åˆ›å»ºä¸åŒçš„ Module å®ä¾‹ï¼ˆä¸åŒçš„ Tagï¼‰ã€‚
2.  **ä½œç”¨åŸŸæ¨¡å¼ (Scope Pattern)**ï¼šå¤ç”¨åŒä¸€ä¸ª Module Tagï¼Œä½†åœ¨ä¸åŒçš„ Effect Scope ä¸­æä¾›ä¸åŒçš„ Runtimeã€‚

**ç»“è®ºå…ˆè¡Œ**ï¼šåœ¨ Logix v3 ä¸­ï¼Œ**å·¥å‚æ¨¡å¼** æ˜¯é¦–é€‰çš„æœ€ä½³å®è·µã€‚

---

## 1. æ–¹æ¡ˆä¸€ï¼šå·¥å‚æ¨¡å¼ (The Factory Pattern) [æ¨è]

### 1.1 æ ¸å¿ƒåŸç†
åˆ©ç”¨ `Logix.Module` æœ¬èº«å°±æ˜¯ Tag æ„é€ å™¨çš„ç‰¹æ€§ã€‚æ¯æ¬¡è°ƒç”¨å·¥å‚å‡½æ•°ï¼Œéƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„ `Context.Tag`ï¼ˆå³ä¸€ä¸ªæ–°çš„ Module å®ä¾‹ï¼‰ã€‚è¿™åœ¨ Logix æ¶æ„ä¸­æ˜¯åŸç”Ÿæ”¯æŒçš„ï¼Œå› ä¸º Module å®šä¹‰ä¸å®ä¾‹èº«ä»½æ˜¯ç»‘å®šçš„ã€‚

### 1.2 å®ç°èŒƒå¼

**ç¬¬ä¸€æ­¥ï¼šå®šä¹‰å½¢çŠ¶ä¸é€»è¾‘æ¨¡æ¿ (Definition)**
ä¸è¦ç›´æ¥åˆ›å»º Module å®ä¾‹ï¼Œè€Œæ˜¯å…ˆå®šä¹‰ Shape å’Œ Logic Templateã€‚

```typescript
// features/counter/definition.ts
import { Logix, Schema } from '@logix/core'

// 1. å®šä¹‰å½¢çŠ¶ (Shape)
export const CounterState = Schema.Struct({ count: Schema.Number })
export const CounterActions = { inc: Schema.Void, dec: Schema.Void }

// è¾…åŠ©ç±»å‹
export type CounterShape = Logix.Shape<typeof CounterState, typeof CounterActions>

// 2. å®šä¹‰é€šç”¨é€»è¾‘ (Logic Template)
// æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œæ¥æ”¶ç»‘å®šçš„ apiï¼Œä¸ä¾èµ–å…·ä½“çš„ Runtime å®ä¾‹
export const CounterLogic = (api: Logix.BoundApi<CounterShape>) =>
  Effect.gen(function*() {
    yield* api.onAction('inc').update((_, s) => ({ count: s.count + 1 }))
    yield* api.onAction('dec').update((_, s) => ({ count: s.count - 1 }))
  })
```

**ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå·¥å‚å‡½æ•° (Factory)**

```typescript
// features/counter/factory.ts
import { Logix } from '@logix/core'
import { CounterState, CounterActions, CounterLogic } from './definition'

// å·¥å‚å‡½æ•°ï¼šæ¥æ”¶å”¯ä¸€ IDï¼Œè¿”å›ä¸€ä¸ªå…¨æ–°çš„ Module å®ä¾‹
export const createCounter = (id: string) => {
  // å…³é”®ï¼šLogix.Module å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ GenericTag(`@logix/Module/${id}`)
  // è¿™ä¸ª Tag æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œä»£è¡¨äº†è¿™ä¸ªç‰¹å®šçš„è®¡æ•°å™¨å®ä¾‹
  const module = Logix.Module(id, {
    state: CounterState,
    actions: CounterActions
  })

  // æŒ‚è½½é€»è¾‘
  // è¿™é‡Œçš„ Logic ä¼šè¿è¡Œåœ¨è¿™ä¸ªç‰¹å®šçš„ module å®ä¾‹ä¸Šä¸‹æ–‡ä¸­
  module.logic(CounterLogic)

  return module
}
```

**ç¬¬ä¸‰æ­¥ï¼šæ¶ˆè´¹ä¸åä½œ (Consumption)**

```typescript
// åœ¨ App ç»„è£…å±‚
const CounterA = createCounter('counter-user-1')
const CounterB = createCounter('counter-user-2')

// å®ƒä»¬æ‹¥æœ‰å®Œå…¨éš”ç¦»çš„çŠ¶æ€å’Œ Action é€šé“
// åœ¨ Link æˆ–å…¶ä»– Logic ä¸­ï¼Œå¯ä»¥æ˜¾å¼åŒºåˆ†å®ƒä»¬
$.use(CounterA).read(s => s.count) // è¯» A
$.use(CounterB).read(s => s.count) // è¯» B
```

### 1.3 ä¼˜åŠ¿
*   **å¿ƒæ™ºæ¨¡å‹ç»Ÿä¸€**ï¼šä¸å•ä¾‹æ¨¡å¼çš„ä»£ç ç»“æ„å‡ ä¹ä¸€è‡´ï¼Œåªæ˜¯åŠ äº†ä¸ªå‡½æ•°åŒ…è£…ã€‚
*   **æ˜¾å¼ä¾èµ–**ï¼šåœ¨è·¨æ¨¡å—åä½œï¼ˆLinkï¼‰æ—¶ï¼Œ`CounterA` å’Œ `CounterB` æ˜¯ä¸åŒçš„ Tokenï¼Œä¸ä¼šå‘ç”Ÿâ€œæˆ‘æƒ³æ“ä½œ A å´è¯¯æ“ä½œäº† Bâ€çš„æƒ…å†µã€‚
*   **æ¶æ„åŒæ„**ï¼šç¬¦åˆ Effect çš„ä¾èµ–æ³¨å…¥æ¨¡å‹ï¼Œæ¯ä¸ªå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ Serviceã€‚

---

## 2. æ–¹æ¡ˆäºŒï¼šä½œç”¨åŸŸæ¨¡å¼ (Scope Pattern) [è°¨æ…ä½¿ç”¨]

### 2.1 æ ¸å¿ƒåŸç†
ä½¿ç”¨åŒä¸€ä¸ª Tagï¼Œä½†åœ¨ React ç»„ä»¶æ ‘çš„ä¸åŒåˆ†æ”¯ï¼ˆScopeï¼‰ä¸Š provide ä¸åŒçš„ Runtime å®ä¾‹ã€‚è¿™ç±»ä¼¼ React Context çš„ Shadowing æœºåˆ¶ã€‚

### 2.2 é€‚ç”¨åœºæ™¯ä¸å±€é™
*   **é€‚ç”¨**ï¼šçº¯ UI åˆ—è¡¨æ¸²æŸ“ï¼ˆå¦‚ `state.items.map` ç”Ÿæˆçš„å­é¡¹ï¼‰ï¼Œä¸”å­é¡¹é€»è¾‘**å®Œå…¨å°é—­**ï¼Œä¸éœ€è¦è¢«å¤–éƒ¨ï¼ˆå¦‚å…¨å±€ Linkï¼‰ä¸»åŠ¨æ“æ§ã€‚
*   **å±€é™**ï¼š
    *   **ç¯å¢ƒéš”ç¦»é£é™©**ï¼šå¦‚æœä½¿ç”¨ `useLocalModule` åˆ›å»ºå±€éƒ¨ Runtimeï¼Œå®ƒå¯èƒ½æ— æ³•ç»§æ‰¿ä¸Šå±‚çš„å…¨å±€æœåŠ¡ï¼ˆå¦‚ Logger, Networkï¼‰ï¼Œé™¤éæ‰‹åŠ¨é€ä¼  Layerã€‚
    *   **è·¨æ¨¡å—åä½œå›°éš¾**ï¼šå¤–éƒ¨çš„ Link é€»è¾‘é€šå¸¸ä¾èµ– Tag æ¥æŸ¥æ‰¾ Moduleã€‚å¦‚æœæ‰€æœ‰å®ä¾‹å…±ç”¨ä¸€ä¸ª Tagï¼ŒLink æ— æ³•åŒºåˆ†å®ƒä»¬ï¼Œä¹Ÿæ— æ³•æŒ‡å®šæ“ä½œæŸä¸€ä¸ªç‰¹å®šå®ä¾‹ã€‚

### 2.3 å®ç°ç¤ºæ„ (React)

```tsx
// 1. å®šä¹‰é€šç”¨ Token
export const TodoItemModule = Logix.Module('TodoItem', { ... })

// 2. åœ¨ç»„ä»¶ä¸­éš”ç¦» Scope
export const TodoList = () => {
  return (
    <div>
      {ids.map(id => (
        // å‡è®¾æœ‰ä¸€ä¸ªæ”¯æŒ Scope Fork çš„ Provider
        <ModuleScope key={id} module={TodoItemModule} initial={{ id }}>
          <TodoItemView />
        </ModuleScope>
      ))}
    </div>
  )
}

// 3. å­ç»„ä»¶æ¶ˆè´¹
// æ‹¿åˆ°çš„æ˜¯æœ€è¿‘ Scope æä¾›çš„å®ä¾‹
const { state } = useModule(TodoItemModule)
```

---

## 3. é€‰å‹å¯¹æ¯”ä¸å»ºè®®

| ç‰¹æ€§ | æ–¹æ¡ˆä¸€ï¼šå·¥å‚æ¨¡å¼ (Factory) | æ–¹æ¡ˆäºŒï¼šä½œç”¨åŸŸæ¨¡å¼ (Scope) |
| :--- | :--- | :--- |
| **å®ä¾‹æ ‡è¯†** | **æ˜¾å¼ä¸åŒ** (CounterA !== CounterB) | **éšå¼è¦†ç›–** (Tag ç›¸åŒï¼ŒContext ä¸åŒ) |
| **è·¨æ¨¡å—è®¿é—®** | **å®¹æ˜“**ã€‚Link å¯ä»¥åŒæ—¶å¼•å…¥ A å’Œ B è¿›è¡Œäº¤äº’ã€‚ | **å›°éš¾**ã€‚å¤–éƒ¨æ— æ³•é€šè¿‡ Tag å®šä½ç‰¹å®šå®ä¾‹ã€‚ |
| **ç”Ÿå‘½å‘¨æœŸ** | é€šå¸¸éš App å¯åŠ¨ï¼Œæˆ–æ‰‹åŠ¨æ§åˆ¶ Scopeã€‚ | éš React ç»„ä»¶æŒ‚è½½/å¸è½½è‡ªåŠ¨ç®¡ç†ã€‚ |
| **è°ƒè¯•ä½“éªŒ** | æ¸…æ™°ã€‚DevTools èƒ½çœ‹åˆ° ID ä¸åŒçš„ Storeã€‚ | ç¨ä¹±ã€‚DevTools ä¼šçœ‹åˆ°å¤šä¸ªåŒå Storeï¼Œéœ€é å±‚çº§åŒºåˆ†ã€‚ |
| **æ¨èåœºæ™¯** | **Dashboard Widgetã€åˆ†å±å¯¹æ¯”ã€ç‹¬ç«‹ä¸šåŠ¡å®ä½“** | **çº¯ UI é€»è¾‘å°è£…ã€é€’å½’ç»„ä»¶** |


### æœ€ä½³å®è·µå»ºè®®

**ä¼˜å…ˆé‡‡ç”¨æ–¹æ¡ˆä¸€ï¼ˆå·¥å‚æ¨¡å¼ï¼‰ã€‚**

å®ƒæä¾›äº†æ›´æ¸…æ™°çš„æ¶æ„è¾¹ç•Œå’Œç±»å‹å®‰å…¨ã€‚å³ä½¿æ˜¯åŠ¨æ€åˆ—è¡¨åœºæ™¯ï¼Œå¦‚æœåˆ—è¡¨é¡¹æœ‰å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚éœ€è¦è¢«å¤–éƒ¨è§¦å‘æ›´æ–°ã€éœ€è¦ä¸å…¶ä»–æ¨¡å—è”åŠ¨ï¼‰ï¼Œä¹Ÿå»ºè®®åœ¨çˆ¶çº§é€šè¿‡å·¥å‚åˆ›å»ºå¥½ä¸€ç»„ Module å®ä¾‹ï¼Œå†åˆ†å‘ç»™å­ç»„ä»¶ã€‚

---

## 4. åœºæ™¯å®æˆ˜ï¼šåŠ¨æ€åˆ—è¡¨ (Dynamic List)

åœ¨â€œåˆ—è¡¨æ¸²æŸ“â€åœºæ™¯ä¸‹ï¼ˆä¾‹å¦‚ Todo Listï¼‰ï¼Œå¦‚æœæ¯ä¸ª Item éƒ½éœ€è¦ç‹¬ç«‹çš„ Module å®ä¾‹ï¼ˆå·¥å‚æ¨¡å¼ï¼‰ï¼Œæ¨èé‡‡ç”¨ **çˆ¶ç»„ä»¶ç®¡ç†å®ä¾‹ç”Ÿå‘½å‘¨æœŸ** çš„æ–¹å¼ã€‚

### 4.1 æ ¸å¿ƒæ€è·¯

1.  **çˆ¶ç»„ä»¶ (Container)**ï¼šè´Ÿè´£ç»´æŠ¤ ID åˆ—è¡¨ï¼Œå¹¶ä½¿ç”¨ `useMemo` æˆ– `Map` ç¼“å­˜ Module å®ä¾‹ã€‚
2.  **å­ç»„ä»¶ (Item)**ï¼šåªè´Ÿè´£æ¥æ”¶ Module å®ä¾‹å¹¶æ¶ˆè´¹ã€‚

### 4.2 ä»£ç å®ç°

**Item ç»„ä»¶ (TodoItem.tsx)**

```tsx
import { useLocalModule, useSelector, useDispatch } from '@logix/react'
import { TodoItemModule } from './definition'

export const TodoItem = ({ id }: { id: string }) => {
  const runtime = useLocalModule(() => makeTodoItemModule(id), [id])
  const view = useSelector(runtime, (s) => ({ title: s.title, completed: s.completed }))
  const dispatch = useDispatch(runtime)

  return (
    <div className={view.completed ? 'done' : ''}>
      <span>{view.title}</span>
      <button onClick={() => dispatch({ _tag: 'toggle' })}>Toggle</button>
    </div>
  )
}
```

**List ç»„ä»¶ (TodoList.tsx)**

```tsx
import React, { useMemo } from 'react'
import { createTodoItem } from './factory'
import { TodoItem } from './TodoItem'

```tsx
import React from 'react'
import { useModuleList } from '@logix/react'
import { createTodoItem } from './factory'
import { TodoItem } from './TodoItem'

export const TodoList = ({ todos }: { todos: Array<{ id: string, title: string }> }) => {
  // ä½¿ç”¨å°è£…å¥½çš„ Hookï¼Œä»£ç å˜å¾—éå¸¸ç®€æ´
  const itemModules = useModuleList(
    todos,
    (t) => t.id,
    (id) => createTodoItem(id)
  )

  return (
    <div>
      {itemModules.map(mod => (
        <TodoItem key={mod.id} module={mod} />
      ))}
    </div>
  )
}
```

### 4.3 è¿›é˜¶æŠ€å·§ï¼šRegistry Pattern

å¦‚æœå¤–éƒ¨ï¼ˆå¦‚å…¨å±€ Linkï¼‰ä¹Ÿéœ€è¦è®¿é—®è¿™äº›åŠ¨æ€åˆ›å»ºçš„ Item Moduleï¼Œå¯ä»¥åœ¨ Factory å±‚å¼•å…¥ä¸€ä¸ªå…¨å±€/æ¨¡å—çº§ Registryï¼š

```typescript
// features/todo/registry.ts
const registry = new Map<string, TodoModuleInstance>()

export const getOrCreateTodoModule = (id: string) => {
  if (!registry.has(id)) {
    registry.set(id, createTodoModule(id))
  }
  return registry.get(id)!
}
```

è¿™æ ·ï¼Œæ— è®ºæ˜¯ React ç»„ä»¶è¿˜æ˜¯ Logix Linkï¼Œåªè¦æ‹¿åˆ° IDï¼Œå°±èƒ½è·å¾—åŒä¸€ä¸ª Module å®ä¾‹ï¼Œå®ç°è·¨å±‚çº§åä½œã€‚
</file>

<file path="runtime-logix/core/integration-guide.md">
# é›†æˆæŒ‡å— (Integration Guide)

> **Status**: Draft (v3 Effect-Native)
> **Date**: 2025-11-24
> **Layer**: Integration Layer

æœ¬æ–‡æ¡£æä¾›äº†å°† Logix é›†æˆåˆ°ç°æœ‰é¡¹ç›®ä¸­çš„è¯¦ç»†æ­¥éª¤å’Œç­–ç•¥ã€‚

## 1. å®‰è£… (Installation)

```bash
npm install @logix/core @logix/react effect
```

## 2. åŸºç¡€è®¾ç½® (Basic Setup)

### 2.1 é…ç½® Runtime Provider

åœ¨åº”ç”¨çš„æ ¹ç»„ä»¶ä¸­åŒ…è£¹ `RuntimeProvider`ã€‚

```tsx
// src/App.tsx
import { RuntimeProvider } from '@logix/react';
import { Logix } from '@logix/core';
import { Layer } from 'effect';

const CRMApp = Logix.app({
  layer: Layer.mergeAll(AppInfraLayer, ReactPlatformLayer),
  modules: [
    Logix.provide(UserModule, UserModule.live({ info: null }, UserModuleLogic))
  ],
  processes: [/* Coordinators */],
});

export function App() {
  return (
    <RuntimeProvider app={CRMApp}>
      <Router />
    </RuntimeProvider>
  );
}
```

### 2.2 åˆ›å»ºç¬¬ä¸€ä¸ª Module

```typescript
// src/features/counter/module.ts
import { Logix } from '@logix/core';
import { Schema, Effect } from 'effect';

const CounterModule = Logix.Module('Counter', {
  state: Schema.Struct({ count: Schema.Number }),
  actions: {
    inc: Schema.Void,
  },
});

export const CounterLogic = CounterModule.logic(($) =>
  Effect.gen(function* () {
    const inc$ = $.flow.fromAction((a): a is { _tag: 'inc' } => a._tag === 'inc');
    yield* inc$.pipe(
      $.flow.run(
        $.state.mutate((draft) => {
          draft.count += 1;
        }),
      ),
    );
  }),
);

export const counterLive = CounterModule.live(
  { count: 0 },
  CounterLogic,
);
```

### 2.3 åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```tsx
// src/features/counter/Counter.tsx
import { useModule, useSelector, useDispatch } from '@logix/react';
import { counterLive } from './store';

export function Counter() {
  const runtime = useModule(counterLive);
  const count = useSelector(runtime, (s) => s.count);
  const dispatch = useDispatch(runtime);

  return <button onClick={() => dispatch({ _tag: 'inc' })}>{count}</button>;
}
```

## 3. è¿ç§»ç­–ç•¥ (Migration Strategy)

### 3.1 ä» Redux è¿ç§»

Logix çš„è®¾è®¡æ·±å— Redux å¯å‘ï¼Œè¿ç§»è·¯å¾„ç›¸å¯¹å¹³æ»‘ã€‚

1.  **Schema**: å°† Redux State / Action ç±»å‹æ•´ç†ä¸ºæ˜¾å¼çš„ `effect/Schema`ï¼›
2.  **Module**: ä½¿ç”¨ `Logix.Module` å®šä¹‰é¢†åŸŸæ¨¡å—ï¼Œå°† Schema æŒ‚åˆ° `state / actions` ä¸Šï¼›
3.  **Reducers & Thunks/Sagas**: å°† Reducer / å¼‚æ­¥é€»è¾‘æ‹†åˆ†ä¸º `Module.logic(($)=>Effect.gen(...))` ä¸­çš„ Fluent é“¾ï¼ˆ`$.onState / $.onAction / $.on + .update/.mutate/.run*`ï¼‰ï¼Œé…åˆ `Effect`/`Flow` è¡¨è¾¾å¹¶å‘è¯­ä¹‰ã€‚

### 3.2 ä» Zustand è¿ç§»

1.  **State**: æ˜¾å¼å®šä¹‰ Schemaã€‚
2.  **Actions**: å°† `set` å‡½æ•°è°ƒç”¨è½¬æ¢ä¸º Action Dispatchã€‚
3.  **Logic**: å°† Store ä¸­çš„æ–¹æ³•æå–ä¸º Flowã€‚

## 4. ä¸ç°æœ‰åº“é›†æˆ

### 4.1 React Query

Logix å¯ä»¥ä¸ React Query å…±å­˜ã€‚å»ºè®®å°† React Query ä½œä¸º Server State ç®¡ç†å™¨ï¼Œè€Œ Logix è´Ÿè´£ Client State å’Œå¤æ‚äº¤äº’é€»è¾‘ã€‚

*   **æ¨¡å¼**: åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ `useQuery` è·å–æ•°æ®ï¼Œé€šè¿‡ `useEffect` å°†æ•°æ®åŒæ­¥åˆ°æŸä¸ª Logix Module çŠ¶æ€ (å¦‚æœéœ€è¦ Logix å¤„ç†è”åŠ¨)ã€‚
*   **æœªæ¥**: Logix è®¡åˆ’æ¨å‡º `@logix/query` æ’ä»¶ï¼Œç›´æ¥åœ¨ Logic å±‚é›†æˆæ•°æ®è·å–èƒ½åŠ›ã€‚

### 4.2 React Hook Form

å¯¹äºç®€å•è¡¨å•ï¼ŒReact Hook Form è¶³å¤Ÿå¥½ç”¨ã€‚å¯¹äºå¤æ‚è”åŠ¨è¡¨å•ï¼Œå»ºè®®ä½¿ç”¨ `@logix/form`ã€‚

*   **é›†æˆ**: å¯ä»¥é€šè¿‡ `useEffect` ç›‘å¬ React Hook Form çš„ `watch`ï¼Œå°†å˜æ›´åŒæ­¥åˆ° Logix Module çŠ¶æ€ã€‚

## 5. å¸¸è§é™·é˜± (Pitfalls)

1.  **è¿‡åº¦è®¾è®¡**: ä¸è¦ä¸ºæ¯ä¸€ä¸ªç®€å•çš„ `useState` éƒ½åˆ›å»ºä¸€ä¸ª Logix Moduleã€‚Logix é€‚ç”¨äºæœ‰å¤æ‚äº¤äº’é€»è¾‘æˆ–è·¨ç»„ä»¶çŠ¶æ€å…±äº«çš„åœºæ™¯ã€‚
2.  **Schema æ»¥ç”¨**: å°½é‡ä¿æŒ Schema æ‰å¹³ã€‚æ·±å±‚åµŒå¥—çš„ Schema ä¼šå¯¼è‡´ Selector ç¼–å†™å›°éš¾ä¸”æ€§èƒ½ä¸‹é™ã€‚
3.  **å¿½è§† Effect**: ä¸è¦è¯•å›¾ç»•è¿‡ Effect ç›´æ¥æ“ä½œ DOM æˆ–è°ƒç”¨ APIã€‚è¿™ä¼šç ´å Logix çš„å¯æµ‹è¯•æ€§å’Œå¯è§‚æµ‹æ€§ã€‚
</file>

<file path="runtime-logix/core/README.md">
# Logix Core

> **The Intent-Driven State Engine**

Logix Core æ˜¯ Logix å¹³å°çš„è¿è¡Œæ—¶å¿ƒè„ã€‚å®ƒæ˜¯ä¸€ä¸ªåŸºäº **Effect-TS** æ„å»ºçš„ã€é«˜æ€§èƒ½ã€å¯ç»„åˆã€å…¨åŒå·¥çš„çŠ¶æ€ç®¡ç†å¼•æ“ã€‚

## æ ¸å¿ƒç‰¹æ€§

*   **Effect-Native**: å…¨é¢æ‹¥æŠ± State/Action Layer å’Œ Streamï¼Œæä¾›æè‡´çš„ç»„åˆèƒ½åŠ›ã€‚
*   **Intent-Driven**: ä¸¥æ ¼åŒºåˆ† Data (State) ä¸ Intent (Action)ã€‚
*   **Full-Duplex**: æ”¯æŒä»£ç ä¸å¯è§†åŒ–å›¾çš„æ— æŸåŒæ­¥ã€‚
*   **Modular**: æ”¯æŒé€»è¾‘æ‹†åˆ†ä¸ Pattern å¤ç”¨ã€‚

## å¿«é€Ÿå¼€å§‹ï¼ˆModule-Firstï¼‰

```ts
import { Logix } from '@logix/core';
import { Schema, Effect } from 'effect';

// 1. å®šä¹‰é¢†åŸŸ Moduleï¼ˆçº¯å®šä¹‰ï¼Œä¸å«å®ä¾‹ï¼‰
export const CounterModule = Logix.Module('Counter', {
  state: Schema.Struct({ count: Schema.Number }),
  actions: {
    inc: Schema.Void,
  },
});

// 2. åœ¨è¯¥ Module ä¸Šç¼–å†™ Logic ç¨‹åºï¼ˆä½¿ç”¨ Bound API `$`ï¼‰
export const CounterLogic = CounterModule.logic(($) =>
  Effect.gen(function* () {
    yield* $.onAction('inc')
      .mutate((draft) => {
        draft.count += 1;
      });
  }),
);

// 3. ç”Ÿæˆ Live Layerï¼ˆåˆå§‹ State + ä¸€ç»„ Logic ç¨‹åºï¼‰
export const CounterLive = CounterModule.live(
  { count: 0 },
  CounterLogic,
);

// 4. ä½¿ç”¨ï¼šåœ¨ Runtime/React Shell ä¸­æ³¨å…¥ CounterLive
```

## æ–‡æ¡£ç´¢å¼•

*   [æ¶æ„æ€»è§ˆ](01-architecture.md)
*   [Module / Logic / Live / `$` æ€»è§ˆ](02-module-and-logic-api.md)
*   [Logic & Flow (å·¥å…·)](03-logic-and-flow.md)ï¼šLogic / Flow / Control / Bound API `$` è¯¦è§£
*   [Logic Middleware](./04-logic-middleware.md)ï¼šLogic Middleware ä¸ `Logic.secure` å®‰å…¨æœºåˆ¶
*   [Pattern (èµ„äº§)](04-pattern.md)
*   [å®ç°æ¶æ„](05-runtime-implementation.md)ï¼šRuntime å†…éƒ¨å®ç°æ¶æ„ï¼ˆModuleRuntime / Store / Scope / Layerï¼‰
*   [å¹³å°é›†æˆ](06-platform-integration.md)
*   [React é›†æˆ](07-react-integration.md)
*   [ä½¿ç”¨æŒ‡å—](08-usage-guidelines.md)
*   [è°ƒè¯•åŠŸèƒ½](09-debugging.md)
</file>

<file path="runtime-logix/form/poc/demo/address-form.component.demo.tsx">
import React from "react"

import { FormReact, AddressForm, AddressFormModule } from "../src"

export interface AddressFormPageProps {
  readonly onSubmit: (values: AddressForm.Values) => void
}

// å•æ–‡ä»¶ demoï¼šæ¼”ç¤ºæ•°ç»„å­—æ®µ + useFieldArray çš„ä½¿ç”¨æ–¹å¼ã€‚
export const AddressFormPage: React.FC<AddressFormPageProps> = (props) => {
  const controller = FormReact.useForm<AddressForm.Values>(AddressFormModule)

  const country = FormReact.useField<AddressForm.Values, string>(
    controller,
    "defaultCountry",
  )

  const addresses = FormReact.useFieldArray<AddressForm.Values, AddressForm.AddressLine>(
    controller,
    "addresses",
  )

  const handleSubmit = (event: React.FormEvent) => {
    event.preventDefault()
    props.onSubmit(controller.getState().values)
  }

  return (
    <form onSubmit={handleSubmit}>
      <input
        value={country.value}
        onChange={(e) =>
          country.onChange({ target: { value: e.target.value } })
        }
      />

      {addresses.fields.map((item, index) => (
        <div key={item.id}>
          <input
            value={item.label}
            onChange={(e) =>
              addresses.replace(
                addresses.fields.map((field, i) =>
                  i === index ? { ...field, label: e.target.value } : field,
                ),
              )
            }
          />
          <button
            type="button"
            onClick={() => addresses.remove(index)}
          >
            åˆ é™¤
          </button>
        </div>
      ))}

      <button
        type="button"
        onClick={() =>
          addresses.append({
            id: String(Date.now()),
            label: "",
            detail: "",
          })
        }
      >
        æ–°å¢åœ°å€
      </button>

      <button type="submit">æäº¤</button>
    </form>
  )
}
</file>

<file path="runtime-logix/form/poc/demo/global-search.component.demo.tsx">
import React from "react"

import { FormReact, GlobalSearchForm, GlobalSearchFormModule } from "../src"

export interface GlobalSearchBarProps {
  readonly onSearch: (values: GlobalSearchForm.Values) => void
}

// å•æ–‡ä»¶ demoï¼šå¤´éƒ¨æœç´¢æ å†…éƒ¨ç›´æ¥ä½¿ç”¨ Form APIã€‚
export const GlobalSearchBar: React.FC<GlobalSearchBarProps> = (props) => {
  const controller = FormReact.useForm<GlobalSearchForm.Values>(GlobalSearchFormModule)

  const keyword = FormReact.useField<GlobalSearchForm.Values, string>(
    controller,
    "keyword",
  )
  const status = FormReact.useField<
    GlobalSearchForm.Values,
    GlobalSearchForm.StatusFilter
  >(controller, "status")

  const handleSubmit = (event: React.FormEvent) => {
    event.preventDefault()
    props.onSearch(controller.getState().values)
  }

  return (
    <form onSubmit={handleSubmit}>
      <input
        placeholder="å…³é”®å­—"
        value={keyword.value}
        onChange={(e) =>
          keyword.onChange({ target: { value: e.target.value } })
        }
      />

      <select
        value={status.value}
        onChange={(e) =>
          status.onChange({ target: { value: e.target.value } })
        }
      >
        <option value="all">å…¨éƒ¨</option>
        <option value="active">è¿›è¡Œä¸­</option>
        <option value="archived">å·²å½’æ¡£</option>
      </select>

      <button type="submit">æœç´¢</button>
    </form>
  )
}
</file>

<file path="runtime-logix/form/poc/demo/README.md">
# Form PoC Demo åœºæ™¯

> ç›®å½•ç”¨äºæ”¾ç½®å›´ç»• `@intent-flow/logix-form-poc` çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œä»…ä½œä¸ºæ–‡æ¡£ demoï¼Œä¸ä½œä¸ºæ­£å¼è¿è¡Œæ—¶ä»£ç ã€‚

## 1. UserProfile è¡¨å•ç¤ºæ„

```ts
import { FormCore } from "../src/domain"
import { FormReact } from "../src/react-hooks"
import { UserProfileFormModule, UserProfileForm } from "../src/user-profile"

// ä»…ç¤ºæ„ï¼šå®é™…å®ç°ç”±ä¸šåŠ¡ä¾§æä¾›
function useUserProfileForm() {
  // åŸºç¡€æ¨¡å¼ï¼šåŸºäºæŸä¸ª Module å®ä¾‹åˆ›å»ºæ§åˆ¶å™¨
  const controller = FormReact.useForm<UserProfileForm.Values>(UserProfileFormModule)

  const username = FormReact.useField<UserProfileForm.Values, string>(
    controller,
    "username",
  )

  const email = FormReact.useField<UserProfileForm.Values, string>(
    controller,
    "email",
  )

  return {
    controller,
    fields: { username, email },
  }
}
```

## 2. AddressForm + æ•°ç»„å­—æ®µç¤ºæ„

```ts
import { AddressFormModule, AddressForm } from "../src/address-form"
import { FormReact } from "../src/react-hooks"

function useAddressForm() {
  const controller = FormReact.useForm<AddressForm.Values>(AddressFormModule)

  const country = FormReact.useField<AddressForm.Values, string>(
    controller,
    "defaultCountry",
  )

  const addresses = FormReact.useFieldArray<AddressForm.Values, AddressForm.AddressLine>(
    controller,
    "addresses",
  )

  return { controller, country, addresses }
}
```

## 3. GlobalSearch è¡¨å• + AppRuntime ç¤ºæ„

```ts
import { GlobalSearchFormModule, GlobalSearchForm } from "../src/global-search"
import { FormReact } from "../src/react-hooks"
import type { AppRuntime } from "../src/app-runtime"

// è¿è¡Œæ—¶ä¾§ä»…æŠŠ GlobalSearchFormModule å½“ä½œæ™®é€š Module æ³¨å…¥
declare const runtime: AppRuntime.Runtime

function useGlobalSearch() {
  const controller = FormReact.useForm<GlobalSearchForm.Values>(GlobalSearchFormModule)
  const keyword = FormReact.useField<GlobalSearchForm.Values, string>(controller, "keyword")
  const status = FormReact.useField<GlobalSearchForm.Values, GlobalSearchForm.StatusFilter>(
    controller,
    "status",
  )

  return { controller, keyword, status }
}
```

> ä¸Šè¿° demo ä»…ä½œä¸ºã€Œç±»å‹ä¸ç”¨æ³•ã€çš„å‚è€ƒï¼Œä¸æ‰¿è¯ºåœ¨æœªå®ç° `useForm/useField` ç­‰å‡½æ•°æ—¶å¯ä»¥ç›´æ¥è¿è¡Œã€‚åç»­å¯ä»¥æŒ‰éœ€æŠŠè¿™é‡Œçš„ç¤ºæ„é€æ­¥æ›¿æ¢ä¸ºçœŸå®å®ç°ã€‚
</file>

<file path="runtime-logix/form/poc/demo/user-profile.component.demo.tsx">
import React from "react"

import { FormReact, UserProfileForm, UserProfileFormModule } from "../src"

export interface UserProfilePageProps {
  readonly onSubmit: (values: UserProfileForm.Values) => void
}

// å•æ–‡ä»¶ demoï¼šç»„ä»¶å†…ç›´æ¥ä½¿ç”¨ Form APIï¼Œä¸²èµ·å®Œæ•´è¡¨å•æµç¨‹ã€‚
export const UserProfilePage: React.FC<UserProfilePageProps> = (props) => {
  const controller = FormReact.useForm<UserProfileForm.Values>(UserProfileFormModule)

  const username = FormReact.useField<UserProfileForm.Values, string>(
    controller,
    "username",
  )
  const email = FormReact.useField<UserProfileForm.Values, string>(
    controller,
    "email",
  )
  const phone = FormReact.useField<UserProfileForm.Values, string>(
    controller,
    "phone",
  )

  const handleSubmit = (event: React.FormEvent) => {
    event.preventDefault()
    props.onSubmit(controller.getState().values)
  }

  return (
    <form onSubmit={handleSubmit}>
      <input
        value={username.value}
        onChange={(e) =>
          username.onChange({ target: { value: e.target.value } })
        }
        onBlur={() => username.onBlur()}
      />

      <input
        value={email.value}
        onChange={(e) =>
          email.onChange({ target: { value: e.target.value } })
        }
        onBlur={() => email.onBlur()}
      />

      <input
        value={phone.value}
        onChange={(e) =>
          phone.onChange({ target: { value: e.target.value } })
        }
      />

      <button type="submit">æäº¤</button>
    </form>
  )
}
</file>

<file path="runtime-logix/form/poc/src/address-form.ts">
import type * as LogixCore from "@logix/core"
import type { Schema } from "effect/Schema"

import type { FormCore } from "./domain"

// åœ°å€è®¾ç½®è¡¨å•ï¼šæ¼”ç¤ºæ•°ç»„å­—æ®µä¸ array/* Action çš„ç±»å‹ä½¿ç”¨ã€‚

export namespace AddressForm {
  export interface AddressLine {
    id: string
    label: string
    detail: string
  }

  export interface Values {
    defaultCountry: string
    addresses: AddressLine[]
  }

  export type State = FormCore.FormState<Values>

  export interface ActionMap extends Record<string, FormCore.AnySchema> {
    "field/change": Schema<{ path: string; value: unknown }>
    "field/blur": Schema<{ path: string }>
    "field/focus": Schema<{ path: string }>
    "array/append": Schema<{ path: string; value: unknown }>
    "array/remove": Schema<{ path: string; index: number }>
    "form/submit": Schema<{ trigger?: string }>
  }

  export type Shape = FormCore.FormShape<Values, ActionMap>

  export type ModuleInstance = LogixCore.Logix.ModuleInstance<"AddressForm", Shape>
}

export declare const AddressFormModule: AddressForm.ModuleInstance
</file>

<file path="runtime-logix/form/poc/src/app-runtime.ts">
import type { Layer } from "effect/Layer"
import type { ManagedRuntime } from "effect/ManagedRuntime"

import type { UserProfileForm } from "./user-profile"
import type { AddressForm } from "./address-form"
import type { GlobalSearchForm } from "./global-search"

// AppRuntime ä¾§åªå…³å¿ƒã€Œæ¨¡å—é›†åˆã€ï¼Œä¸å…³å¿ƒè¿™äº›æ¨¡å—æ˜¯ä¸æ˜¯ Formã€‚

export namespace AppRuntime {
  export type Modules =
    | UserProfileForm.ModuleInstance
    | AddressForm.ModuleInstance
    | GlobalSearchForm.ModuleInstance

  export type ModulesLayer = Layer<Modules, never, never>

  export type Runtime<R = never> = ManagedRuntime<R, never>
}
</file>

<file path="runtime-logix/form/poc/src/domain.ts">
import { Schema } from "effect"
import type * as LogixCore from "@logix/core"

// åŸºç¡€ Form ç±»å‹å‡ºå£ï¼ˆåº“çº§åˆ«ï¼‰ã€‚
// ä»…åŒ…å«æ¥å£ä¸ç±»å‹åˆ«åï¼Œä¸åŒ…å«ä»»ä½•å…·ä½“å®ç°ã€‚

export namespace FormCore {
  export interface FormIssue {
    code: string
    message: string
    severity: "error" | "warning" | "info"
    path: string
  }

  export interface FieldState {
    touched: boolean
    dirty: boolean
    validating: boolean
    focused: boolean
    issues: FormIssue[]
  }

  export interface UIState {
    fields: Record<string, FieldState>
    meta: {
      isValid: boolean
      isSubmitting: boolean
      isValidating: boolean
      isDirty: boolean
      submitCount: number
      allIssues: FormIssue[]
    }
  }

  export interface FormState<TValues> {
    values: TValues
    ui: UIState
    config?: FormConfig<TValues>
  }

  export type ValidationMode = "onChange" | "onBlur" | "onSubmit" | "all"

  export interface FormConfig<TValues> {
    readonly initialValues: TValues
    readonly schema?: Schema.Schema<TValues, any, any>
    readonly mode?: ValidationMode
    readonly reValidateMode?: ValidationMode
    readonly debounceMs?: number
  }

  export type FormAction =
    | { _tag: "field/change"; payload: { path: string; value: unknown } }
    | { _tag: "field/blur"; payload: { path: string } }
    | { _tag: "field/focus"; payload: { path: string } }
    | { _tag: "array/append"; payload: { path: string; value: unknown } }
    | { _tag: "array/prepend"; payload: { path: string; value: unknown } }
    | { _tag: "array/remove"; payload: { path: string; index: number } }
    | {
        _tag: "array/swap"
        payload: { path: string; indexA: number; indexB: number }
      }
    | {
        _tag: "array/move"
        payload: { path: string; from: number; to: number }
      }
    | { _tag: "form/submit"; payload?: { trigger?: string } }
    | { _tag: "form/reset"; payload?: { values?: unknown } }
    | { _tag: "form/validate"; payload?: { paths?: string[] } }
    | { _tag: "form/setValues"; payload: { values: unknown } }

  export type AnySchema = Schema.Schema<any, any, any>

  export type SchemaOf<T> = Schema.Schema<T, any, any>

  export type FormShape<
    TValues,
    TActionMap extends Record<string, AnySchema>
  > = LogixCore.Logix.Shape<SchemaOf<FormState<TValues>>, TActionMap>
}
</file>

<file path="runtime-logix/form/poc/src/global-search.ts">
import type * as LogixCore from "@logix/core"
import type { Schema } from "effect/Schema"

import type { FormCore } from "./domain"

// å…¨å±€æœç´¢æ è¡¨å•ï¼šæŒ‚åœ¨ AppRuntime ä¸Šçš„è½»é‡è¡¨å•ã€‚

export namespace GlobalSearchForm {
  export type StatusFilter = "all" | "active" | "archived"

  export interface Values {
    keyword: string
    status: StatusFilter
  }

  export type State = FormCore.FormState<Values>

  export interface ActionMap extends Record<string, FormCore.AnySchema> {
    "field/change": Schema<{ path: string; value: unknown }>
    "field/blur": Schema<{ path: string }>
    "form/submit": Schema<{ trigger?: string }>
  }

  export type Shape = FormCore.FormShape<Values, ActionMap>

  export type ModuleInstance = LogixCore.Logix.ModuleInstance<"GlobalSearchForm", Shape>
}

export declare const GlobalSearchFormModule: GlobalSearchForm.ModuleInstance
</file>

<file path="runtime-logix/form/poc/src/index.ts">
export * from "./domain"
export * from "./user-profile"
export * from "./address-form"
export * from "./global-search"
export * from "./app-runtime"
export * from "./react-hooks"
</file>

<file path="runtime-logix/form/poc/src/react-hooks.ts">
import type { FormCore } from "./domain"

// React å±‚åªåšï¼šModuleRuntime çš„æŠ•å½± + DOM äº‹ä»¶é€‚é…ã€‚
// è¿™é‡Œä»…å£°æ˜ Hook ç±»å‹ï¼Œä¸æä¾›å®ç°ã€‚

export namespace FormReact {
  export interface FormController<TValues> {
    readonly getState: () => FormCore.FormState<TValues>
    readonly dispatch: (action: FormCore.FormAction) => void
  }

  export interface ChangeEventLike {
    readonly target: { readonly value: unknown }
  }

  export interface UseFieldReturn<TValue> {
    value: TValue
    isTouched: boolean
    isDirty: boolean
    isValidating: boolean
    error?: string
    issues: FormCore.FormIssue[]
    onChange: (value: TValue | ChangeEventLike) => void
    onBlur: () => void
    onFocus: () => void
  }

  export interface UseFieldArrayReturn<TItem> {
    fields: Array<{ id: string } & TItem>
    append: (value: TItem) => void
    prepend: (value: TItem) => void
    remove: (index: number) => void
    swap: (indexA: number, indexB: number) => void
    move: (from: number, to: number) => void
    replace: (values: TItem[]) => void
  }

  export declare function useForm<TValues>(
    module: unknown
  ): FormController<TValues>

  export declare function useField<TValues, TValue>(
    controller: FormController<TValues>,
    path: string
  ): UseFieldReturn<TValue>

  export declare function useFieldArray<TValues, TItem>(
    controller: FormController<TValues>,
    path: string
  ): UseFieldArrayReturn<TItem>
}
</file>

<file path="runtime-logix/form/poc/src/user-profile.ts">
import type * as LogixCore from "@logix/core"
import type { Effect } from "effect/Effect"
import type { Schema } from "effect/Schema"

import type { FormCore } from "./domain"

// ç”¨æˆ·èµ„æ–™è¡¨å•ï¼šä»…ç±»å‹ä¸æ¨¡å—å£°æ˜ï¼Œä¸å«å®ç°ã€‚

export namespace UserProfileForm {
  export interface Values {
    username: string
    email: string
    phone: string
    country: string
    city: string
    marketingOptIn: boolean
  }

  export interface Services {
    readonly checkUsername: (username: string) => Effect<boolean, never, never>
  }

  export type State = FormCore.FormState<Values>

  export interface ActionMap extends Record<string, FormCore.AnySchema> {
    "field/change": Schema<{ path: string; value: unknown }>
    "field/blur": Schema<{ path: string }>
    "field/focus": Schema<{ path: string }>
    "form/submit": Schema<{ trigger?: string }>
  }

  export type Shape = FormCore.FormShape<Values, ActionMap>

  export type ModuleInstance = LogixCore.Logix.ModuleInstance<"UserProfileForm", Shape>
}

export declare const UserProfileFormModule: UserProfileForm.ModuleInstance
</file>

<file path="runtime-logix/form/poc/package.json">
{
  "name": "@intent-flow/logix-form-poc",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "typecheck": "tsc -p tsconfig.json"
  },
  "dependencies": {
    "@logix/core": "workspace:*",
    "effect": "^3.19.6"
  },
  "devDependencies": {
    "typescript": "5.8.2",
    "react": "^18.3.1",
    "@types/react": "^18.3.12"
  }
}
</file>

<file path="runtime-logix/form/poc/README.md">
# Logix Form PoC Package

> ä»…ç”¨äº `docs/specs/runtime-logix/form` ç›¸å…³è§„èŒƒçš„ PoCï¼›ä¸ä½œä¸ºæ­£å¼è¿è¡Œæ—¶ä»£ç ã€‚

ç›®æ ‡ï¼š

- æ¨¡æ‹Ÿä¸€ä¸ªçœŸå®çš„ B2B ç®¡ç†åå°é¡¹ç›®ï¼›
- ç”¨ TypeScript ç±»å‹å’Œ demo ç»“æ„éªŒè¯ Form è§„åˆ’åœ¨ logix ä½“ç³»ä¸­çš„è½ç‚¹ï¼›
â€“ åªå†™ç±»å‹å’Œç­¾åï¼ˆ`declare` / `namespace` / `interface` ç­‰ï¼‰ï¼Œä¸å†™å…·ä½“å®ç°é€»è¾‘ã€‚

å¯ä»¥é€šè¿‡ï¼š

```bash
pnpm --filter @intent-flow/logix-form-poc typecheck
```

æ¥éªŒè¯ç±»å‹æ˜¯å¦è‡ªæ´½ã€‚
</file>

<file path="runtime-logix/form/poc/tsconfig.json">
{
  "extends": "../../../../../tsconfig.json",
  "compilerOptions": {
    "lib": ["ES2020", "DOM"],
    "noEmit": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "jsx": "react-jsx"
  },
  "include": ["src/**/*.ts", "demo/**/*.ts", "demo/**/*.tsx"]
}
</file>

<file path="runtime-logix/form/01-domain-model.md">
# çŠ¶æ€ä¸åŠ¨ä½œæ¨¡å‹ (Form State & Actions)

> **Status**: Definitive (v3.0, aligned with logix-core)
> **Layer**: Form Core

æœ¬æ–‡æ¡£åªåšä¸€ä»¶äº‹ï¼šåœ¨ `logix-core` çš„ `ModuleShape` ä¹‹ä¸Šï¼Œç»™è¡¨å•åº“å®šä¹‰ä¸€ä»½æ ‡å‡†åŒ–çš„ State/Action å½¢çŠ¶ï¼ˆFormShapeï¼‰ï¼Œä½œä¸ºæ‰€æœ‰ Form æ¨¡å—çš„å…¬å…±å¥‘çº¦ã€‚

## 1. çŠ¶æ€æ¶æ„ (State Architecture)

### 1.1 Data State (The Truth)

ä»…å­˜å‚¨çº¯å‡€çš„ã€å¯åºåˆ—åŒ–çš„ä¸šåŠ¡æ•°æ®ï¼Œæ”¯æŒ Time-Travel å’ŒæŒä¹…åŒ–ã€‚

```typescript
type DataState<T> = T;
```

### 1.2 UI State (The Machinery)

å­˜å‚¨æ‰€æœ‰ç¬æ€äº¤äº’çŠ¶æ€ï¼Œä¸“é—¨ä¸ºè¡¨å• UI æœåŠ¡ã€‚

```typescript
// æ ‡å‡†åŒ–é—®é¢˜æ¨¡å‹
export interface FormIssue {
  code: string;       // é”™è¯¯ç  (e.g., "required", "min_length")
  message: string;    // é”™è¯¯æ¶ˆæ¯
  severity: "error" | "warning" | "info";
  path: string;       // è§¦å‘è·¯å¾„ï¼ˆæ‰å¹³ Pathï¼‰
}

export interface FieldState {
  touched: boolean;
  dirty: boolean;
  validating: boolean;
  focused: boolean;
  issues: FormIssue[];
}

export interface UIState {
  // å­—æ®µå…ƒæ•°æ® (Key ä¸ºæ‰å¹³åŒ– Path)
  fields: Record<string, FieldState>;

  // å…¨å±€å…ƒæ•°æ®ï¼ˆå…¨éƒ¨å¯ä»¥ç”± values + fields æ´¾ç”Ÿï¼Œä½†è¿™é‡Œæ ‡å‡†åŒ–ä¸€ä»½å½¢çŠ¶ï¼‰
  meta: {
    isValid: boolean;
    isSubmitting: boolean;
    isValidating: boolean;
    isDirty: boolean;
    submitCount: number;
    allIssues: FormIssue[]; 
  };
}
```

### 1.3 Unified Form State

```typescript
export interface FormState<T> {
  values: T;
  ui: UIState;
}
```

Form æ¨¡å—çš„ `stateSchema` åº”è¯¥ä»¥ `FormState<T>` ä¸ºåŸºç¡€ï¼Œé€šè¿‡ `effect/Schema` è¿›è¡Œå»ºæ¨¡ã€‚

## 2. Action å½¢çŠ¶ (Action Shape)

logix-core å·²ç»çº¦å®šäº† Action ä½¿ç”¨ `_tag` + `payload` çš„ Union æ¨¡å¼ï¼ŒForm ç›´æ¥æ²¿ç”¨è¿™ä¸€çº¦å®šã€‚

```typescript
export type FormAction =
  // --- Field Interactions ---
  | { _tag: "field/change"; payload: { path: string; value: unknown } }
  | { _tag: "field/blur"; payload: { path: string } }
  | { _tag: "field/focus"; payload: { path: string } }

  // --- Array Operations (First-Class Citizens) ---
  | { _tag: "array/append"; payload: { path: string; value: unknown } }
  | { _tag: "array/prepend"; payload: { path: string; value: unknown } }
  | { _tag: "array/remove"; payload: { path: string; index: number } }
  | {
      _tag: "array/swap";
      payload: { path: string; indexA: number; indexB: number };
    }
  | {
      _tag: "array/move";
      payload: { path: string; from: number; to: number };
    }

  // --- Form Lifecycle ---
  | { _tag: "form/submit"; payload?: { trigger?: string } }
  | { _tag: "form/reset"; payload?: { values?: unknown } }
  | { _tag: "form/validate"; payload?: { paths?: string[] } }
  | { _tag: "form/setValues"; payload: { values: unknown } };
```

æ‰€æœ‰ Form Logic éƒ½åº”åŸºäº `FormAction` è¿›è¡Œ `fromAction(a => a._tag === "â€¦")` çš„ç­›é€‰ï¼Œä¸å†æ··ç”¨ `type`/`kind` ç­‰å­—æ®µåã€‚
</file>

<file path="runtime-logix/form/02-logic-preset.md">
# è¡¨å•é¢„ç½®é€»è¾‘ (Form Logic Presets)

> **Status**: Draft (Thin Layer on logix-core)  
> **Layer**: Form Domain  
> **Note**: æ‰€æœ‰ç¤ºä¾‹éƒ½åŸºäº v3 Effect-Native èŒƒå¼ï¼ˆ`Logix.Module` + Bound API `$` + `Flow`ï¼‰ï¼Œåªæä¾›ã€Œæ¨èå†™æ³•ã€ï¼Œä¸å†å®šä¹‰æ–°çš„ DSLã€‚å½“å‰ PoC ä¸­ï¼Œè¯·åœ¨å®ç°é‡Œé€šè¿‡ `Module.logic(($)=>...)` æˆ–æ˜¾å¼æ¥æ”¶ `BoundApi<Sh,R>` çš„æ–¹å¼è·å– `$`ã€‚

æœ¬èŠ‚ç›®æ ‡ï¼šç»™ Form æä¾›ä¸€ç»„**å¯é€‰**çš„é¢„ç½® Logicï¼Œåšåˆ°ã€Œä¸ç”¨æ—¶ 0 æˆæœ¬ï¼Œç”¨æ—¶æœ‰æ ‡å‡†ç­”æ¡ˆã€ã€‚

## 1. é…ç½®å¥‘çº¦ (Configuration Contract, è½»é‡ç‰ˆ)

```typescript
export type ValidationMode = "onChange" | "onBlur" | "onSubmit" | "all";

export interface FormConfig<TValues> {
  readonly initialValues: TValues;
  readonly schema?: Schema.Schema<TValues>;
  readonly mode?: ValidationMode;           // é»˜è®¤: "onChange"
  readonly reValidateMode?: ValidationMode; // é»˜è®¤: "onChange"
  readonly debounceMs?: number;             // é»˜è®¤: 200
}
```

FormConfig å¯ä»¥ï¼š

- ä½œä¸º `FormState<T>` çš„ä¸€éƒ¨åˆ†æŒ‚åœ¨ `state.config` ä¸Šï¼›æˆ–
- ä½œä¸º Module live æ—¶é¢å¤–æ³¨å…¥çš„ Serviceï¼ˆä¾‹å¦‚ `FormConfigTag`ï¼‰ï¼›

ä¸¤ç§æ–¹å¼å®ç°ä¸Šä»»é€‰ä¸€ç§ï¼Œè§„èŒƒå±‚ä¸å¼ºåˆ¶ï¼Œä½†ç¤ºä¾‹ç»Ÿä¸€å‡è®¾ `state.config` å­˜åœ¨ã€‚

## 2. æ ¸å¿ƒé€»è¾‘ç¤ºä¾‹ (åŸºäº Bound API `$`)

ä¸‹é¢ç¤ºä¾‹éƒ½å‡å®šå­˜åœ¨ Bound API `$Form`ï¼Œé€šå¸¸ç”±å¯¹åº”çš„ `FormModule.logic(($Form)=>...)` æ³¨å…¥ï¼š

```typescript
type FormShape<T> = Logix.Shape<
  Schema.Schema<FormState<T>>,
  {
    "field/change": Schema.Schema<{ path: string; value: unknown }>;
    "field/blur": Schema.Schema<{ path: string }>;
    "field/focus": Schema.Schema<{ path: string }>;
    "array/append": Schema.Schema<{ path: string; value: unknown }>;
    // ... å…¶ä»– Action è§ 01-domain-model.md
  }
>;
```

### 2.1 è„æ£€æŸ¥ (Dirty Check)

ç›‘å¬ `values` çš„å˜åŒ–ï¼Œä¸ `config.initialValues` è¿›è¡Œæ·±æ¯”è¾ƒï¼Œæ›´æ–° `ui.meta.isDirty`ã€‚

```typescript
const dirtyCheckLogic: Logic.Of<FormShape<any>> = Effect.gen(function* () {
  const values$ = $Form.flow.fromState((s) => s.values);

  yield* values$.pipe(
    $Form.flow.run((values) =>
      $Form.state.mutate((draft) => {
        const initial = draft.config?.initialValues ?? draft.values;
        draft.ui.meta.isDirty = !deepEqual(values, initial);
      }),
    ),
  );
});
```

### 2.2 æ™ºèƒ½æ ¡éªŒç­–ç•¥ (Smart Validation Strategy, æ”¶ç´§ç‰ˆ)

å°†å­—æ®µå˜æ›´ / å¤±ç„¦ / æäº¤ç»Ÿä¸€æ”¶æŸä¸ºæ ¡éªŒå…¥å£ï¼Œå¤ç”¨ `Flow.runLatest` å¤„ç†å¼‚æ­¥ç«æ€ã€‚

ä»…ä¿ç•™å…³é”®æ„å›¾ï¼Œçœç•¥å®ç°ç»†èŠ‚ï¼š

```typescript
class FormValidatorService extends Context.Tag(
  "FormValidatorService",
)<FormValidatorService, {
  readonly validateField: (
    path: string,
    values: unknown,
  ) => Effect.Effect<FormIssue[] | null>;
  readonly validateAll: (
    values: unknown,
  ) => Effect.Effect<Record<string, FormIssue[]>>;
}> {}

const smartValidationLogic: Logic.Of<
  FormShape<any>,
  FormValidatorService
> = Effect.gen(function* () {
  const validator = yield* $Form.services(FormValidatorService);

  const change$ = $Form.flow.fromAction(
    (a): a is Extract<FormAction, { _tag: "field/change" }> =>
      a._tag === "field/change",
  );
  const blur$ = $Form.flow.fromAction(
    (a): a is Extract<FormAction, { _tag: "field/blur" }> =>
      a._tag === "field/blur",
  );
  const submit$ = $Form.flow.fromAction(
    (a): a is Extract<FormAction, { _tag: "form/submit" }> =>
      a._tag === "form/submit",
  );

  const validateOne = (action: { payload: { path: string } }) =>
    Effect.gen(function* () {
      const state = yield* $Form.state.read;
      const issues = yield* validator.validateField(
        action.payload.path,
        state.values,
      );
      yield* $Form.state.mutate((draft) => {
        const list = issues ?? [];
        draft.ui.fields[action.payload.path] ??= {
          touched: false,
          dirty: false,
          validating: false,
          focused: false,
          issues: [],
        };
        draft.ui.fields[action.payload.path]!.issues = list;
      });
    });

  const validateAll = Effect.gen(function* () {
    const state = yield* $Form.state.read;
    const all = yield* validator.validateAll(state.values);
    yield* $Form.state.mutate((draft) => {
      draft.ui.meta.allIssues = [];
      for (const [path, list] of Object.entries(all)) {
        draft.ui.fields[path] ??= {
          touched: false,
          dirty: false,
          validating: false,
          focused: false,
          issues: [],
        };
        draft.ui.fields[path]!.issues = list;
        draft.ui.meta.allIssues.push(...list);
      }
      draft.ui.meta.isValid = draft.ui.meta.allIssues.length === 0;
    });
  });

  const changeValidation$ = change$.pipe(
    $Form.flow.debounce(200),
    $Form.flow.runLatest(validateOne),
  );
  const blurValidation$ = blur$.pipe($Form.flow.run(validateOne));
  const submitValidation$ = submit$.pipe($Form.flow.run(validateAll));

  yield* Effect.all(
    [changeValidation$, blurValidation$, submitValidation$],
    { discard: true },
  );
});
```

### 2.3 æ•°ç»„æ“ä½œé€»è¾‘ (Array Logic)

æ•°ç»„æ“ä½œé€šè¿‡ä¸“ç”¨ Action é©±åŠ¨ï¼Œé€»è¾‘å±‚åªåšã€Œæ‰¾åˆ°æ•°ç»„ + åº”ç”¨æ“ä½œã€ï¼Œå¹¶é¡ºä¾¿æ›´æ–° `isDirty`ã€‚

```typescript
const arrayLogic: Logic.Of<FormShape<any>> = Effect.gen(function* () {
  const arrayAction$ = $Form.flow.fromAction((a) =>
    a._tag.startsWith("array/"),
  );

  yield* arrayAction$.pipe(
    $Form.flow.run((action) =>
      $Form.state.mutate((draft) => {
        const { path } = (action as any).payload as { path: string };
        const arr = get(draft.values as any, path);
        if (!Array.isArray(arr)) return;

        switch (action._tag) {
          case "array/append":
            arr.push((action as any).payload.value);
            break;
          case "array/prepend":
            arr.unshift((action as any).payload.value);
            break;
          case "array/remove":
            arr.splice((action as any).payload.index, 1);
            break;
          case "array/swap": {
            const { indexA, indexB } = (action as any).payload;
            [arr[indexA], arr[indexB]] = [arr[indexB], arr[indexA]];
            break;
          }
          case "array/move": {
            const { from, to } = (action as any).payload;
            const [item] = arr.splice(from, 1);
            arr.splice(to, 0, item);
            break;
          }
        }

        draft.ui.meta.isDirty = true;
      }),
    ),
  );
});
```

ä»¥ä¸Šé€»è¾‘éƒ½åªæ˜¯ã€Œæ¨èå®ç°ã€ï¼ŒçœŸæ­£è½åœ°æ—¶å¯ä»¥æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©æ€§æŒ‚è½½åˆ° Form Module çš„ `live(...logics)` ä¸­ã€‚
</file>

<file path="runtime-logix/form/03-react-api.md">
# React API è®¾è®¡ (React API Specification)

> **Status**: Draft (focus on DOM/focus integration)  
> **Layer**: React Bindings

React å±‚åªåšä¸€ä»¶äº‹ï¼šæŠŠ `ModuleRuntime<FormState<T>, FormAction>` æŠ•å½±æˆç»„ä»¶å¯ç”¨çš„ Hook è¿”å›å€¼ï¼Œå¹¶å¤„ç† DOM äº‹ä»¶ç»†èŠ‚ã€‚

## 1. `useForm`ï¼ˆå…¥å£ Hookï¼‰

è½»é‡åŒ…è£… ModuleRuntime / ModuleInstanceï¼Œç»Ÿä¸€è¿”å› Form æ§åˆ¶å™¨ã€‚

```typescript
export interface FormController<TValues> {
  readonly runtime: Logix.ModuleRuntime<FormState<TValues>, FormAction>;
  readonly getState: () => FormState<TValues>;
  readonly dispatch: (action: FormAction) => void;
}
```

å…·ä½“ `useForm` å½¢çŠ¶å¯ä»¥æ ¹æ® `logix-react` çš„æœ€ç»ˆ API ç»†åŒ–ï¼Œè¿™é‡Œä¸å¼ºè¡Œå®šæ­»ç»†èŠ‚ã€‚

## 2. `useField` (The Workhorse)

`useField` è´Ÿè´£å°†å¤æ‚çš„ FormState æŠ•å½±ä¸ºç®€å•çš„ UI Propsï¼Œå¹¶å¤„ç† `onChange/onBlur/onFocus` åˆ° FormAction çš„æ˜ å°„ã€‚

```typescript
export interface UseFieldReturn<T> {
  value: T;
  isTouched: boolean;
  isDirty: boolean;
  isValidating: boolean;
  error?: string;
  issues: FormIssue[];
  onChange: (value: T | React.ChangeEvent<any>) => void;
  onBlur: () => void;
  onFocus: () => void;
}
```

æ¨èå®ç°æ€è·¯ï¼š

- ä½¿ç”¨ `useSelector(runtime, s => {...})` åšç»†ç²’åº¦è®¢é˜…ï¼›
- é”™è¯¯æŠ•å½±ï¼šä» `fieldState.issues` ä¸­å–ç¬¬ä¸€æ¡ `severity === "error"` çš„ message ä½œä¸º `error`ï¼›
- äº‹ä»¶é€‚é…ï¼š`onChange` æ¥å—å€¼æˆ– `ChangeEvent`ï¼Œç»Ÿä¸€å°è£…æˆ `_tag: "field/change"`ï¼›`onBlur`/`onFocus` åˆ™æ´¾å‘å¯¹åº” Actionã€‚

## 3. `useFieldArray` (The List Manager)

å®Œå…¨å¯¹é½ Domain å±‚çš„ Array Actionsï¼Œä¸é¢å¤–å¼•å…¥çŠ¶æ€ã€‚

```typescript
export interface UseFieldArrayReturn<TItem> {
  fields: Array<{ id: string } & TItem>;
  append: (value: TItem) => void;
  prepend: (value: TItem) => void;
  remove: (index: number) => void;
  swap: (indexA: number, indexB: number) => void;
  move: (from: number, to: number) => void;
  replace: (values: TItem[]) => void;
}
```

`fields` çš„ `id` ç”± Hook å†…éƒ¨ç»´æŠ¤ï¼ˆä¾‹å¦‚ `useId` + æœ¬åœ° Refï¼‰ï¼Œåªç”¨äº React `key`ï¼Œä¸å†™å› `values`ã€‚

## 4. è¿ç§»æŒ‡å— (Migration from PoC)

- ç»Ÿä¸€ä¾èµ– logix-core çš„ `ModuleRuntime`/`ModuleShape`ï¼Œä¸å†è‡ªå»º Store ç±»å‹ã€‚
- è¡¨å•é”™è¯¯ç»Ÿä¸€æ¥æºäº `ui.fields[path].issues` ä¸ `ui.meta.allIssues`ï¼ŒReact å±‚ä¸å†ç»´æŠ¤å¹³è¡Œçš„ `errors` çŠ¶æ€ã€‚
- æ‰€æœ‰å‰¯ä½œç”¨ï¼ˆå¼‚æ­¥æ ¡éªŒã€é˜²æŠ–ã€ç«æ€ï¼‰æ”¾åœ¨ Logic é¢„ç½®ä¸­ï¼ŒReact Hook åªåšè®¢é˜… + DOM äº‹ä»¶é€‚é…ã€‚
</file>

<file path="runtime-logix/form/04-real-world-poc.md">
# å®æˆ˜ PoC é¡¹ç›®éª¨æ¶ (Real-World Form PoC)

> **Status**: Draft  
> **Goal**: ç”¨ä¸€ä¸ªæ¥è¿‘çœŸå® B2B ç®¡ç†åå°çš„è™šæ‹Ÿé¡¹ç›®ï¼Œæ¼”ç¤º Form åœ¨ logix ä½“ç³»ä¸­çš„è½ç‚¹ä¸è¾¹ç•Œï¼Œåªå†™ç±»å‹ä¸ Demoï¼Œä¸ç»™å‡ºå…·ä½“å®ç°ã€‚

æœ¬èŠ‚é€šè¿‡ä¸€ä¸ªã€Œè¿è¥ç®¡ç†åå°ã€PoCï¼Œä¸²èµ·ï¼š

- é¢†åŸŸ Form æ¨¡å—ï¼ˆUserProfileForm / AddressForm / GlobalSearchFormï¼‰ï¼›
- Form Domainï¼ˆFormState / FormAction / FormConfigï¼‰ï¼›
- logix-core Module / Logicï¼›
- React å±‚ `useForm` / `useField`ï¼›

æ‰€æœ‰ä»£ç ç¤ºä¾‹éƒ½åªåŒ…å« **ç±»å‹ã€ç­¾åä¸å‘½åçº¦å®š**ï¼Œä¸åŒ…å«å…·ä½“å®ç°ã€‚

---

## 1. å‡æƒ³é¡¹ç›®ç»“æ„ (Monorepo Layout)

```text
apps/
  admin-portal/
    src/
      app/
        logixRuntime.ts        # AppRuntime ç»„è£…ï¼ˆä»…ç±»å‹ç¤ºæ„ï¼‰
      features/
        user/
          UserProfileForm.tsx  # ç”¨æˆ·èµ„æ–™è¡¨å•
        settings/
          AddressForm.tsx      # åœ°å€è®¾ç½®è¡¨å•
        search/
          GlobalSearchBar.tsx  # å…¨å±€æœç´¢æ è¡¨å•

packages/
  logix-core/                  # ç°æœ‰ logix å¼•æ“
  form/                        # Form Domain + React Hooksï¼ˆæœ¬è§„èŒƒçš„å®ç°è½ç‚¹ï¼‰
```

ä¸‹é¢ä»£ç ç‰‡æ®µé‡Œåªå‡ºç° `declare` / `interface` / `type` / `namespace` ç­‰å£°æ˜ï¼Œä¸ç»™å‡ºå®é™…é€»è¾‘ã€‚

---

## 2. Form Domainï¼šç»Ÿä¸€ç±»å‹å‡ºå£

çº¦å®šåœ¨ `packages/form/src/domain` ä¸‹æä¾›ç»Ÿä¸€çš„ç±»å‹å‡ºå£ï¼Œä¾›ä¸šåŠ¡é¡¹ç›®ç›´æ¥ä½¿ç”¨ã€‚

```ts
// packages/form/src/domain/index.d.ts

import type { Schema } from "effect/Schema";
import type * as Logix from "@logix/core"; // æ¦‚å¿µæ€§è·¯å¾„ï¼Œç”¨äºè¯´æ˜ä¾èµ–

export interface FormIssue {
  code: string;
  message: string;
  severity: "error" | "warning" | "info";
  path: string;
}

export interface FieldState {
  touched: boolean;
  dirty: boolean;
  validating: boolean;
  focused: boolean;
  issues: FormIssue[];
}

export interface UIState {
  fields: Record<string, FieldState>;
  meta: {
    isValid: boolean;
    isSubmitting: boolean;
    isValidating: boolean;
    isDirty: boolean;
    submitCount: number;
    allIssues: FormIssue[];
  };
}

export interface FormState<TValues> {
  values: TValues;
  ui: UIState;
  // å¯é€‰ï¼šé…ç½®/åˆå§‹å¿«ç…§ç­‰
  config?: FormConfig<TValues>;
}

export type ValidationMode = "onChange" | "onBlur" | "onSubmit" | "all";

export interface FormConfig<TValues> {
  readonly initialValues: TValues;
  readonly schema?: Schema<TValues>;
  readonly mode?: ValidationMode;
  readonly reValidateMode?: ValidationMode;
  readonly debounceMs?: number;
}

export type FormAction =
  | { _tag: "field/change"; payload: { path: string; value: unknown } }
  | { _tag: "field/blur"; payload: { path: string } }
  | { _tag: "field/focus"; payload: { path: string } }
  | { _tag: "array/append"; payload: { path: string; value: unknown } }
  | { _tag: "array/prepend"; payload: { path: string; value: unknown } }
  | { _tag: "array/remove"; payload: { path: string; index: number } }
  | {
      _tag: "array/swap";
      payload: { path: string; indexA: number; indexB: number };
    }
  | {
      _tag: "array/move";
      payload: { path: string; from: number; to: number };
    }
  | { _tag: "form/submit"; payload?: { trigger?: string } }
  | { _tag: "form/reset"; payload?: { values?: unknown } }
  | { _tag: "form/validate"; payload?: { paths?: string[] } }
  | { _tag: "form/setValues"; payload: { values: unknown } };

export type FormShape<TValues, TActionMap extends Record<string, Schema<any>>> =
  Logix.Shape<
    Schema<FormState<TValues>>,
    TActionMap
  >;
```

---

## 3. é¢†åŸŸæ¨¡å—ï¼šç”¨æˆ·èµ„æ–™è¡¨å• (UserProfileForm)

æ¨¡æ‹Ÿä¸€ä¸ªå…¸å‹çš„ã€Œç”¨æˆ·èµ„æ–™ã€è¡¨å•ï¼šç”¨æˆ·åã€é‚®ç®±ã€æ‰‹æœºã€å›½å®¶/çœå¸‚ã€‚

```ts
// apps/admin-portal/src/features/user/user-profile.form.d.ts

import type { Schema } from "effect/Schema";
import type * as Logix from "@logix/core";
import type {
  FormState,
  FormAction,
  FormShape,
} from "@logix/form/domain";

export namespace UserProfileDomain {
  export interface Values {
    username: string;
    email: string;
    phone: string;
    country: string;
    city: string;
    marketingOptIn: boolean;
  }

  export interface Services {
    // ç¤ºä¾‹ï¼šæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦é‡å
    readonly checkUsername: (
      username: string,
    ) => Effect.Effect<boolean>;
  }

  export type State = FormState<Values>;

  export interface ActionMap {
    "field/change": Schema<{ path: string; value: unknown }>;
    "field/blur": Schema<{ path: string }>;
    "field/focus": Schema<{ path: string }>;
    "form/submit": Schema<{ trigger?: string }>;
  }

  export type Shape = FormShape<Values, ActionMap>;

  export type ModuleInstance = Logix.ModuleInstance<"UserProfileForm", Shape>;
}

// ä»…å£°æ˜ï¼šå®é™…å®ç°ç”± packages/form æä¾›å·¥å‚å‡½æ•°ç”Ÿæˆ
export declare const UserProfileFormModule: UserProfileDomain.ModuleInstance;
```

Logic ä¸ Live åœ¨ PoC ä¸­ä¹Ÿåªç»™å‡ºã€Œç±»å‹ä½ã€ï¼š

```ts
// apps/admin-portal/src/features/user/user-profile.logic.d.ts

import type { Logic } from "@logix/core";
import type { UserProfileDomain } from "./user-profile.form";

export declare namespace UserProfileLogic {
  // ç›‘å¬ country å˜åŒ–ï¼Œé‡ç½® cityï¼ˆç¤ºæ„ï¼‰
  export type CountryCityLink = Logic.Of<UserProfileDomain.Shape>;

  // å¼‚æ­¥æ ¡éªŒç”¨æˆ·åæ˜¯å¦é‡å¤ï¼ˆç¤ºæ„ï¼‰
  export type UsernameValidation = Logic.Of<
    UserProfileDomain.Shape,
    UserProfileDomain.Services
  >;
}
```

---

## 4. é¢†åŸŸæ¨¡å—ï¼šåœ°å€è®¾ç½®è¡¨å• (AddressForm)

ç¤ºæ„ä¸€ä¸ªå¸¦æ•°ç»„å­—æ®µçš„åœ°å€è¡¨å•ï¼Œæ¼”ç¤º `array/*` Action çš„ç±»å‹ä½¿ç”¨ã€‚

```ts
// apps/admin-portal/src/features/settings/address.form.d.ts

import type { Schema } from "effect/Schema";
import type * as Logix from "@logix/core";
import type { FormState, FormAction, FormShape } from "@logix/form/domain";

export namespace AddressDomain {
  export interface AddressLine {
    id: string;
    label: string;
    detail: string;
  }

  export interface Values {
    defaultCountry: string;
    addresses: AddressLine[];
  }

  export type State = FormState<Values>;

  export interface ActionMap {
    "field/change": Schema<{ path: string; value: unknown }>;
    "field/blur": Schema<{ path: string }>;
    "field/focus": Schema<{ path: string }>;
    "array/append": Schema<{ path: string; value: unknown }>;
    "array/remove": Schema<{ path: string; index: number }>;
    "form/submit": Schema<{ trigger?: string }>;
  }

  export type Shape = FormShape<Values, ActionMap>;

  export type ModuleInstance = Logix.ModuleInstance<"AddressForm", Shape>;
}

export declare const AddressFormModule: AddressDomain.ModuleInstance;
```

---

## 5. å…¨å±€æ¨¡å—ï¼šæœç´¢æ è¡¨å• (GlobalSearchForm)

ç¤ºæ„ä¸€ä¸ªæŒ‚åœ¨ AppRuntime ä¸Šçš„å…¨å±€æœç´¢æ è¡¨å•ï¼Œåªæš´éœ²å°‘é‡å­—æ®µã€‚

```ts
// apps/admin-portal/src/features/search/global-search.form.d.ts

import type { Schema } from "effect/Schema";
import type * as Logix from "@logix/core";
import type { FormState, FormShape } from "@logix/form/domain";

export namespace GlobalSearchDomain {
  export interface Values {
    keyword: string;
    status: "all" | "active" | "archived";
  }

  export type State = FormState<Values>;

  export interface ActionMap {
    "field/change": Schema<{ path: string; value: unknown }>;
    "field/blur": Schema<{ path: string }>;
    "form/submit": Schema<{ trigger?: string }>;
  }

  export type Shape = FormShape<Values, ActionMap>;

  export type ModuleInstance = Logix.ModuleInstance<"GlobalSearchForm", Shape>;
}

export declare const GlobalSearchFormModule: GlobalSearchDomain.ModuleInstance;
```

AppRuntime ä¾§åªéœ€è¦çŸ¥é“ã€Œè¿™æ˜¯ä¸€ä¸ªæ¨¡å—ã€ï¼Œä¸ç”¨å…³å¿ƒå®ƒæ˜¯ Formï¼š

```ts
// apps/admin-portal/src/app/logixRuntime.d.ts

import type { Layer } from "effect/Layer";
import type { ManagedRuntime } from "effect/ManagedRuntime";

import type { UserProfileDomain } from "../features/user/user-profile.form";
import type { AddressDomain } from "../features/settings/address.form";
import type { GlobalSearchDomain } from "../features/search/global-search.form";

export declare namespace AppRuntime {
  export type Modules =
    | UserProfileDomain.ModuleInstance
    | AddressDomain.ModuleInstance
    | GlobalSearchDomain.ModuleInstance;

  export type LayerOfModules = Layer<Modules, never, never>;

  export type Runtime = ManagedRuntime<never>;
}
```

---

## 6. React å±‚ï¼šHooks ç±»å‹ç¤ºæ„

åœ¨ `packages/form/src/react` ä¸­æä¾›å¯¹ Form Module çš„æ ‡å‡† Hooks ç±»å‹ã€‚

```ts
// packages/form/src/react/hooks.d.ts

import type * as React from "react";
import type * as Logix from "@logix/core";
import type {
  FormState,
  FormAction,
  FormIssue,
} from "@logix/form/domain";

export interface FormController<TValues> {
  readonly runtime: Logix.ModuleRuntime<FormState<TValues>, FormAction>;
  readonly getState: () => FormState<TValues>;
  readonly dispatch: (action: FormAction) => void;
}

export interface UseFieldReturn<TValue> {
  value: TValue;
  isTouched: boolean;
  isDirty: boolean;
  isValidating: boolean;
  error?: string;
  issues: FormIssue[];
  onChange: (value: TValue | React.ChangeEvent<any>) => void;
  onBlur: () => void;
  onFocus: () => void;
}

export interface UseFieldArrayReturn<TItem> {
  fields: Array<{ id: string } & TItem>;
  append: (value: TItem) => void;
  prepend: (value: TItem) => void;
  remove: (index: number) => void;
  swap: (indexA: number, indexB: number) => void;
  move: (from: number, to: number) => void;
  replace: (values: TItem[]) => void;
}

export declare function useForm<TValues>(
  module: Logix.ModuleInstance<string, any>,
): FormController<TValues>;

export declare function useField<TValues, TPath extends string, TValue>(
  controller: FormController<TValues>,
  path: TPath,
): UseFieldReturn<TValue>;

export declare function useFieldArray<TValues, TPath extends string, TItem>(
  controller: FormController<TValues>,
  path: TPath,
): UseFieldArrayReturn<TItem>;
```

ä¸šåŠ¡ä¾§ä½¿ç”¨æ–¹å¼ç¤ºæ„ï¼ˆåªå†™ç­¾åï¼‰ï¼š

```ts
// apps/admin-portal/src/features/user/UserProfileForm.tsx.d.ts

import type * as React from "react";
import type { UserProfileDomain } from "./user-profile.form";
import type {
  FormController,
  UseFieldReturn,
} from "@logix/form/react/hooks";

export interface UserProfileFormProps {
  readonly userId: string;
}

export declare function useUserProfileForm(
  props: UserProfileFormProps,
): {
  controller: FormController<UserProfileDomain.Values>;
  fields: {
    username: UseFieldReturn<string>;
    email: UseFieldReturn<string>;
    phone: UseFieldReturn<string>;
    country: UseFieldReturn<string>;
    city: UseFieldReturn<string>;
  };
};

export declare const UserProfileForm: React.FC<UserProfileFormProps>;
```

---

## 7. å°ç»“ï¼šPoC å¯¹é½çš„çº¦æŸç‚¹

- Form åœ¨é¡¹ç›®ä¸­çš„èº«ä»½æ˜¯ï¼š`Logix.Module<FormShape>` çš„ä¸€ä¸ªå…·ä½“å®ä¾‹é›†åˆï¼ˆUserProfile / Address / GlobalSearchï¼‰ï¼Œåœ¨ Type å±‚ç»Ÿä¸€çº¦æŸä¸º `FormState<T>` + `FormAction`ã€‚
- æ‰€æœ‰ã€ŒçœŸå®é¡¹ç›®ã€ç›¸å…³çš„ç›®å½•/å‘½åï¼ˆapps/admin-portalã€features/user ç­‰ï¼‰åªæ˜¯ç¤ºæ„ï¼Œç”¨æ¥éªŒè¯ Form è§„åˆ’åœ¨å®é™…ä»“åº“ä¸­çš„è½ç‚¹å’Œè¾¹ç•Œã€‚
- React å±‚åªä¾èµ– `FormController` + `useField`/`useFieldArray` ç±»å‹ï¼Œè¡¨å•è¡Œä¸ºæœ¬èº«ç”± logix-core + Form Logic Presets å†³å®šã€‚  

å®ç°è½åœ°æ—¶ï¼Œå¯ä»¥ä»¥æœ¬æ–‡ä»¶ä¸ºè“æœ¬ï¼ŒæŠŠ `*.d.ts` ä¸­çš„å£°æ˜é€æ­¥æ›¿æ¢ä¸ºå…·ä½“å®ç°ã€‚
</file>

<file path="runtime-logix/form/README.md">
# Form Engine Specification

> **Status**: Draft (to be aligned with current logix-core)
> **Layer**: Form Core Adapter (Thin Wrapper)

æœ¬æ–‡æ¡£åœ¨ v3 logix-core èƒ½åŠ›ä¹‹ä¸Šï¼Œæ”¶ç´§è¡¨å•å¼•æ“çš„å®šä½ï¼š**Form ä¸æ˜¯å¦ä¸€å¥—å¼•æ“ï¼Œè€Œæ˜¯å›´ç»• Logix.Module çš„è½»é‡çŠ¶æ€å°è£… + React ç»‘å®š**ã€‚

## 1. è®¾è®¡ç«‹åœº

- **Logix ä¼˜å…ˆ**ï¼šçŠ¶æ€ç®¡ç†ã€å¼‚æ­¥æµç¨‹ã€Schema/Effect èƒ½åŠ›å…¨éƒ¨ç”± `logix-core` æä¾›ï¼ŒForm å±‚ä¸å†è‡ªå»ºå¹¶è¡Œçš„ DSL æˆ–è¿è¡Œæ—¶ã€‚
- **è–„æ ¸å¿ƒå±‚**ï¼šForm Core åªåšä¸¤ä»¶äº‹ï¼š
  - çº¦å®šä¸€ä»½é€šç”¨çš„è¡¨å•çŠ¶æ€å½¢çŠ¶ï¼ˆDual-Storeï¼š`values` + `ui`ï¼‰ï¼›
  - æä¾›å°‘é‡å¯é€‰çš„ Logic é¢„ç½®ï¼ˆè„æ£€æŸ¥ã€æ ¡éªŒç­–ç•¥ã€æ•°ç»„æ“ä½œï¼‰ï¼Œåœ¨å½“å‰ PoC ä¸­åŸºäº `Logix.Module` + `Module.logic(($)=>...)` + `Flow` å®ç°ã€‚
- **React ä¸“æ³¨ DOM**ï¼šReact é€‚é…å±‚åªå…³å¿ƒ DOM/Foucs ç­‰å‰ç«¯ç»†èŠ‚ï¼ˆ`onFocus`/`onBlur`ã€äº‹ä»¶å¯¹è±¡é€‚é…ã€ç»†ç²’åº¦è®¢é˜…ï¼‰ï¼Œä¸å¹²é¢„é€»è¾‘ä¸çŠ¶æ€æ¨¡å‹ã€‚

æ¢å¥è¯è¯´ï¼š**Form = Logix.Module<FormShape> +ï¼ˆå¯é€‰ï¼‰FormLogicPresets + React Hooks**ã€‚

## 2. æ¶æ„åˆ†å±‚ (Architecture Layers)

```mermaid
graph TD
    React[React Layer (Hooks)] -->|useForm/useField| FormCore[Form Core (Shape + Presets)]
    FormCore -->|Module.live + Module.logic(($)=>...)| Logix[logix-core Runtime]
    Logix -->|State/Action/Flow| React
```

- **Layer 0: logix-core**ï¼šé€šç”¨çŠ¶æ€æœºï¼ˆModuleShape / ModuleRuntime / Logic / Flowï¼‰ã€‚
- **Layer 1: Form Core**ï¼šæ ‡å‡†åŒ– FormShapeï¼ˆ`FormState<T>`/`FormAction`ï¼‰ä¸ä¸€ç»„æ¨è Logic Presetï¼ˆå¯é€‰ï¼‰ã€‚
- **Layer 2: React Bindings**ï¼š`useForm` / `useField` / `useFieldArray` ç­‰ Hooksï¼Œå°† FormShape æŠ•å½±ä¸ºç»„ä»¶å‹å¥½çš„ propsã€‚

## 3. æ–‡æ¡£ç´¢å¼•

- [01-domain-model.md](./01-domain-model.md): å®šä¹‰è¡¨å•çš„çŠ¶æ€å½¢çŠ¶ï¼ˆFormShapeï¼‰ä¸ Action åè®®ï¼Œä¸¥æ ¼å¯¹é½ `_tag`/`payload` çº¦å®šã€‚
- [02-logic-preset.md](./02-logic-preset.md): åœ¨ Bound API `$`ï¼ˆç”± `Module.logic(($)=>...)` æ³¨å…¥ï¼‰ + `Flow` ä¸Šå®ç°çš„ä¸€ç»„è½»é‡é¢„ç½®é€»è¾‘ï¼ˆå¯é€‰æŒ‚è½½ï¼‰ã€‚
- [03-react-api.md](./03-react-api.md): åŸºäº ModuleRuntime çš„ React Hooks API è®¾è®¡ï¼Œä¸“æ³¨è®¢é˜…ä¸ DOM äº‹ä»¶é€‚é…ã€‚
 - [04-real-world-poc.md](./04-real-world-poc.md): æ¨¡æ‹ŸçœŸå® B2B ç®¡ç†åå°çš„ PoC é¡¹ç›®éª¨æ¶ï¼Œåªå†™ç±»å‹ä¸ demoï¼Œä¸å«å…·ä½“å®ç°ã€‚

## 4. ç”Ÿå‘½å‘¨æœŸä¸ AppRuntime å…³ç³»ï¼ˆæ”¶ç´§ç‰ˆï¼‰

Form åªåœ¨ã€Œæ˜¯å¦æ³¨å†Œä¸º AppRuntime æ¨¡å—ã€è¿™ä¸€ä¸ªç»´åº¦å’Œå…¶ä»–æ¨¡å—åŒºåˆ†ï¼š

- **å±€éƒ¨è¡¨å• (Local Form)**ï¼šåœ¨ç»„ä»¶å†…é€šè¿‡ `ModuleRuntime.make` æˆ– `FormModule.live` + React Hook åˆ›å»ºï¼Œç”Ÿå‘½å‘¨æœŸéšç»„ä»¶ï¼›ä¸å¼ºåˆ¶æ¥å…¥ AppRuntimeã€‚
- **å…¨å±€è¡¨å• (Global Form)**ï¼šå°† `FormModule.live(...)` ä½œä¸º Layer æ³¨å†Œè¿› AppRuntimeï¼Œä¸å…¶ä»–é¢†åŸŸæ¨¡å—ä¸€è§†åŒä»ï¼›æ‰€æœ‰è·¨æ¨¡å—åä½œä»é€šè¿‡ `Logix.Link`/Logic å®ç°ã€‚

æœ¬è§„èŒƒåç»­çš„æ‰€æœ‰ç¤ºä¾‹ï¼Œéƒ½è§† Form ä¸ºã€Œæ™®é€š Logix æ¨¡å—çš„ä¸€ä¸ªä¸“ç”¨ Shapeã€ï¼Œä¸å†å¼•å…¥é¢å¤–çš„ Engine/Runtime æ¦‚å¿µã€‚
</file>

<file path="runtime-logix/impl/app-runtime-and-modules.md">
# AppRuntime & ModuleDef å®ç°è‰å›¾

> **Status**: Draft (v3 Final Â· Implementation Planning)
> **Scope**: `Logix.app` / `Logix.module` / `ModuleDef` åœ¨è¿è¡Œæ—¶å±‚çš„å…·ä½“ç»„åˆæ–¹å¼ä¸å·²çŸ¥å–èˆã€‚

æœ¬è¯´æ˜æ–‡æ¡£ä» **Effect/Layer/Scope** å®ç°è§†è§’ï¼Œå±•å¼€ `ModuleDef` / `Logix.module` / `Logix.app` çš„å…·ä½“ç»„åˆæ–¹å¼ã€‚
ç›®æ ‡æ˜¯ï¼š

- è®©åç»­å®ç°è€…åœ¨è½ä»£ç æ—¶æœ‰æ¸…æ™°çš„â€œæ‹¼ Layer ä¸ Scopeâ€çš„è§„åˆ™å¯ä¾ï¼›
- æå‰æš´éœ² v3 ç‰ˆæœ¬çš„ä¸€äº›åˆ»æ„å–èˆï¼ˆä¾‹å¦‚ Env æ‰å¹³åˆå¹¶ã€ä¸åšå¼ºéš”ç¦»ï¼‰ï¼Œé¿å…åç»­è¯¯ä»¥ä¸ºæ˜¯â€œæ¼å®ç°â€ï¼›
- ä¸ºæœªæ¥ v4 çš„ Env è£å‰ª / Lazy æ¨¡å—åŠ è½½é¢„ç•™æ€è€ƒç©ºé—´ã€‚

## 1. æ ¸å¿ƒç±»å‹å›é¡¾

æ¥è‡ª `architecture-app-runtime.md` çš„æ ¸å¿ƒå®šä¹‰ï¼ˆç•¥å»éå…³é”®å­—æ®µï¼‰ï¼š

```ts
export interface ModuleDef<R> {
  readonly id: string
  readonly infra?: Layer.Layer<R, any, never>
  readonly imports?: ReadonlyArray<ModuleDef<any>>
  readonly providers?: ReadonlyArray<Provider<any>>

  /**
   * ä¸šåŠ¡ç¼–æ’ (Links):
   * - è¿æ¥å¤šä¸ª Domain çš„èƒ¶æ°´é€»è¾‘ (Effect);
   * - å¹³å°ä¼šåœ¨æ¶æ„å›¾ä¸Šå°†å…¶æ¸²æŸ“ä¸ºè¿æ¥çº¿æˆ–ç‹¬ç«‹èŠ‚ç‚¹;
   * - è¿è¡Œæ—¶ä¸ processes ä¸€è§†åŒä»ã€‚
   */
  readonly links?: ReadonlyArray<Effect.Effect<void, any, R>>

  /**
   * åŸºç¡€è®¾æ–½è¿›ç¨‹ (Processes):
   * - åå°å®ˆæŠ¤è¿›ç¨‹ (Daemon)ã€æ—¥å¿—ä¸ŠæŠ¥ã€å¿ƒè·³æ£€æµ‹ç­‰;
   * - å¹³å°é€šå¸¸å°†å…¶æŠ˜å æˆ–éšè—ï¼Œè§†ä¸ºæ¨¡å—å†…éƒ¨ç»†èŠ‚ã€‚
   */
  readonly processes?: ReadonlyArray<Effect.Effect<void, any, R>>

  readonly middlewares?: ReadonlyArray<Logic.Middleware<R>>
  readonly exports?: ReadonlyArray<Context.Tag<any, any>>
}

export interface Provider<S> {
  readonly tag: Context.Tag<S, S>
  readonly value: S // é€šå¸¸æ˜¯æŸä¸ªé¢†åŸŸæ¨¡å—çš„è¿è¡Œæ—¶å®ä¾‹æˆ– Service å®ç°
}
```

- **ModuleDef<R>**ï¼šä¸€ä¸ªæ¨¡å—çš„â€œå›¾çº¸â€ï¼ŒR è¡¨ç¤ºè¯¥æ¨¡å—æœŸæœ›ä»å¤–ç•Œè·å¾—çš„ç¯å¢ƒï¼ˆEnvï¼‰ç±»å‹ï¼›
- **infra**ï¼šè¯¥æ¨¡å—å†…éƒ¨ä½¿ç”¨çš„åŸºç¡€è®¾æ–½ Layerï¼Œå¯¹å¤–ä¸è¦æ±‚å¯è§£æï¼›
- **imports**ï¼šä¾èµ–çš„å…¶ä»–æ¨¡å—ï¼ˆModuleï¼‰ï¼›
- **providers**ï¼šæœ¬æ¨¡å—æä¾›çš„æœåŠ¡ï¼ˆå«é¢†åŸŸæ¨¡å—çš„è¿è¡Œæ—¶å®ä¾‹ï¼‰ï¼›
- **links**ï¼šæ ¸å¿ƒä¸šåŠ¡ç¼–æ’é€»è¾‘ï¼ˆå°†å†›ï¼‰ï¼Œç”¨äºè·¨ Domain åä½œï¼›
- **processes**ï¼šåŸºç¡€è®¾æ–½å®ˆæŠ¤è¿›ç¨‹ï¼ˆæ‚å½¹ï¼‰ï¼Œéšæ¨¡å—å¯åŠ¨ï¼›
- **exports**ï¼šå¯¹å¤–å…¬å¼€çš„ Tag åˆ—è¡¨ï¼Œå¹³å°ç”¨æ¥åšä¾èµ–æ£€æŸ¥ä¸æ‹“æ‰‘å±•ç¤ºï¼›v3 Runtime æš‚ä¸åšå¼ºéš”ç¦»ã€‚

`Logix.app` æ˜¯ `ModuleDef` çš„ç‰¹ä¾‹ï¼ˆæ—  `exports` è¦æ±‚ï¼Œä¸”é¢å¤–æä¾› `makeRuntime`ï¼‰ã€‚

## 2. flatten ç›®æ ‡ï¼šä» ModuleDef åˆ° { layer, processes }

è¿è¡Œæ—¶çš„ç›®æ ‡æ˜¯ï¼šç»™å®šä¸€æ£µæ¨¡å—æ ‘ï¼ˆApp è§†ä¸ºæ ¹ ModuleDefï¼‰ï¼Œç”Ÿæˆä¸€ä»½å¯æ³¨å…¥çš„ Layerï¼ˆåŒ…å«æ‰€æœ‰ Provider/Infraï¼‰ã€ä»¥åŠåœ¨è¯¥ Layer æ‰€å± Scope ä¸‹è¿è¡Œçš„ processesã€‚

å¯¹äº Appï¼š

```ts
interface AppDefinition<R> {
  definition: ModuleDef<R>
  layer: Layer.Layer<R, any, never>
  makeRuntime: () => Effect.ManagedRuntime<R>
}
```

v3 ç‰ˆæœ¬çš„å…³é”®ç‰¹æ€§ï¼š

- Env é‡‡ç”¨ **æ‰å¹³åˆå¹¶**ï¼šæ‰€æœ‰ imports / providers çš„ Tag éƒ½ä¼šå‡ºç°åœ¨åŒä¸€ä¸ª `Context` ç¯å¢ƒä¸­ï¼›
- **Tag å†²çªå¼ºæ ¡éªŒ**ï¼šæ„å»ºè¿‡ç¨‹ä¸­å¿…é¡»æ£€æŸ¥ Tag Key å†²çªï¼Œå‘ç°å†²çªç«‹å³æŠ¥é”™ï¼Œ**ç¦æ­¢é™é»˜è¦†ç›–**ï¼›
- `exports` ä»…ç”¨äº **ç±»å‹/å¹³å°æ£€æŸ¥**ï¼Œä¸åš Env å¼ºéš”ç¦»ï¼›
- `links` å’Œ `processes` åœ¨è¿è¡Œæ—¶åˆå¹¶ï¼Œä½†åœ¨å…ƒæ•°æ®ä¸Šä¸¥æ ¼åŒºåˆ†ï¼Œä»¥ä¾¿é”™è¯¯å¤„ç†ä¸å¯è§†åŒ–ã€‚

## 3. flatten ç®—æ³•ä¸é˜²å‘†å®ç°

ä¸ºäº†ä¿è¯å®ç°çš„å¥å£®æ€§ï¼Œv3 è¦æ±‚ `buildModule` å¿…é¡»åŒ…å«ä»¥ä¸‹é€»è¾‘ï¼š

### 3.1 Tag å†²çªæ£€æµ‹ (Hard Constraint)

åœ¨åˆå¹¶ Layer ä¹‹å‰ï¼Œå¿…é¡»ç»´æŠ¤ä¸€ä¸ª `TagIndex` å¹¶è¿›è¡Œå†²çªæ£€æŸ¥ï¼š

```ts
type TagKey = string

interface TagInfo {
  readonly key: TagKey
  readonly tag: Context.Tag<any, any>
  readonly ownerModuleId: string
  readonly source: "provider" | "export" | "infra"
}

// å¿…é¡»æŠ›å‡ºçš„é”™è¯¯ç±»å‹
interface TagCollisionError {
  readonly _tag: "TagCollisionError"
  readonly key: TagKey
  readonly conflicts: ReadonlyArray<TagInfo>
}
```

**å®ç°çº¦æŸ**ï¼š
1. é€’å½’æ”¶é›†æ‰€æœ‰å­æ¨¡å—çš„ Tag ä¿¡æ¯ï¼›
2. è‹¥å‘ç°åŒä¸€ä¸ª Key å¯¹åº”äº†ä¸åŒçš„ Tag å®ä¾‹ï¼ˆå¼•ç”¨ä¸ç›¸ç­‰ï¼‰ï¼Œ**å¿…é¡»**æ„é€  `TagCollisionError` å¹¶ fail æ‰æ„å»ºè¿‡ç¨‹ï¼›
3. **ç»å¯¹ç¦æ­¢**ä¾èµ– `Layer.mergeAll` çš„é¡ºåºè¿›è¡Œé™é»˜è¦†ç›–ã€‚

### 3.2 Flatten é¡ºåºçº¦å®š

è™½ç„¶æœ‰å†²çªæ£€æµ‹å…œåº•ï¼Œä½†ä¸ºäº†è¡Œä¸ºçš„å¯é¢„æµ‹æ€§ï¼Œflatten é¡ºåºå›ºå®šä¸ºï¼š

> **`imports` -> `infra` -> `providers`**

å³ï¼š
1. å…ˆåŠ è½½ä¾èµ–æ¨¡å—ï¼›
2. å†åŠ è½½æœ¬æ¨¡å—çš„åŸºç¡€è®¾æ–½ï¼›
3. æœ€ååŠ è½½æœ¬æ¨¡å—æä¾›çš„æœåŠ¡ã€‚

### 3.3 Link vs Process çš„è¿è¡Œæ—¶éš”ç¦»

è™½ç„¶å®ƒä»¬éƒ½æ˜¯ Effectï¼Œä½†åœ¨è¿è¡Œæ—¶å¿…é¡»åŒ…è£…ä¸º `ProcessDef` ä»¥åŒºåˆ†è¯­ä¹‰ï¼š

```ts
function buildModule<R>(def: ModuleDef<R>): BuiltModule<R> {
  // ... (Layer æ„å»ºé€»è¾‘åŒä¸Šï¼Œéœ€åŠ å…¥ Tag å†²çªæ£€æŸ¥) ...

  // åŒºåˆ† Link ä¸ Process
  // links è§†ä¸ºä¸šåŠ¡ç¼–æ’ï¼ˆæ¥è¿‘ processï¼‰ï¼Œåœ¨ v3 ä¸­æš‚ä¸ processes åˆå¹¶å¯¹å¾…

  const processes = (def.processes ?? []).map(eff => ({
    id: generateId("process"),
    kind: "process" as const,
    effect: eff,
    ownerModuleId: def.id
  }))

  const allEffects = [...links, ...processes]

  // ...
}
```

**é”™è¯¯å¤„ç†**ï¼šAppRuntime é€šè¿‡ `config.onError` é›†ä¸­å¤„ç†è¿›ç¨‹å¤±è´¥ï¼›é»˜è®¤å®ç°è®°å½•é”™è¯¯å¹¶å…è®¸ Scope ç»§ç»­è¿è¡Œï¼Œå¹³å°å¯æ ¹æ®ä¸šåŠ¡éœ€è¦é‡å¯/é™çº§ã€‚

**Dev-time æ–­è¨€å»ºè®®**ï¼š
- å»ºè®®åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼ˆ`NODE_ENV !== "production"`ï¼‰å¢åŠ å®ˆå«ï¼š
  - è‹¥ `Process` åœ¨çŸ­æ—¶é—´å†…ï¼ˆå¦‚ 1sï¼‰æ­£å¸¸ç»“æŸï¼ˆSuccessï¼‰ï¼Œæ‰“å° Warningï¼šâ€œProcess é¢„æœŸæ˜¯é•¿é©»å®ˆæŠ¤è¿›ç¨‹ï¼Œè¯·ç¡®è®¤æ˜¯å¦è¯¯ç”¨äº† Process æ‰¿è½½ä¸€æ¬¡æ€§é€»è¾‘â€ï¼›
  - è‹¥ `Link` é•¿æ—¶é—´é˜»å¡ä¸”ä¸ä¾èµ–ä»»ä½• Serviceï¼Œæç¤ºå¯èƒ½è¯¯ç”¨äº† Linkã€‚

## 4. exportsï¼šå°è£…è¾¹ç•Œçš„å®ç°ç­–ç•¥

### 4.1 v3 ç­–ç•¥ï¼šç±»å‹ & å¹³å°ä¸ºä¸»

åœ¨ v3ï¼š

- `exports` çš„ä¸»è¦èŒè´£æ˜¯ï¼š
  - **ç±»å‹çº¦æŸ**ï¼šModuleDef ç±»å‹ä¸­ï¼Œåªæœ‰ `exports` ä¸­å£°æ˜çš„ Tag è¢«è§†ä¸ºå¯¹å¤–å¯å¼•ç”¨ï¼›
  - **å¹³å°æ£€æŸ¥**ï¼šUniverse View ä¸ä¾èµ–æ£€æŸ¥å·¥å…·åœ¨å‘ç°â€œæ¨¡å— A ä½¿ç”¨äº†æ¨¡å— B æœª exports çš„ Tagâ€æ—¶ï¼Œç»™å‡ºé”™è¯¯æˆ–å¼ºçƒˆè­¦å‘Šã€‚
- Runtime å±‚é¢çš„ Env æš‚æ—¶ä¸åšè£å‰ªï¼š
  - è¿™æ ·æ‰€æœ‰ Tag åœ¨å¼€å‘/è°ƒè¯•æ—¶éƒ½å¯ä»¥é€šè¿‡ `Effect.service` æ‹¿åˆ°ï¼Œé™ä½å®ç°å¤æ‚åº¦ï¼›
  - ä¹Ÿä¾¿äºåœ¨ PoC é˜¶æ®µæ¢ç´¢æ›´å¤šæ¨¡å¼ï¼Œè€Œä¸è¢«â€œEnv å¼ºéš”ç¦»â€æŒ¡è·¯ã€‚

### 4.2 v4 æ–¹å‘ï¼šEnv è£å‰ªä¸ Scoped Layerï¼ˆä»…è§„åˆ’ï¼Œä¸åœ¨ v3 å®ç°ï¼‰

è‹¥æœªæ¥éœ€è¦æ›´å¼ºå°è£…ï¼Œå¯ä»¥è€ƒè™‘ï¼š

- åœ¨ `buildModule` ä¸­å¼•å…¥ â€œæŠ•å½± Layerâ€ï¼š
  - å†…éƒ¨æ„å»ºå®Œæ•´ envLayerï¼›
  - å¯¹å¤–ä»…æš´éœ² `exports` ä¸­çš„ Tagï¼ˆä¾‹å¦‚é€šè¿‡åŒ…è£… Runtimeã€é™åˆ¶å¯ç”¨ Tag é›†åˆï¼‰ã€‚
- æˆ–è€…é€šè¿‡ **å¤šçº§ Scope** æ¨¡æ‹Ÿæ¨¡å—è¾¹ç•Œï¼š
  - æ¯ä¸ª Module æ‹¥æœ‰ç‹¬ç«‹ Scope ä¸ Envï¼›
  - å­ Module åªç»§æ‰¿çˆ¶ Module çš„ `exports` ç¯å¢ƒï¼Œè€Œéå…¨éƒ¨ Tagã€‚

ä»¥ä¸Šæ–¹æ¡ˆéƒ½æ¶‰åŠè¾ƒå¤§çš„å®ç°ï¼è°ƒè¯•æˆæœ¬ï¼Œv3 æš‚ä¸è½åœ°ï¼Œä»…ä½œä¸ºè§„åˆ’å¤‡å¿˜ã€‚

## 5. å·²çŸ¥å–èˆä¸éšæ‚£

### 5.1 Env æ‰å¹³åŒ–å¸¦æ¥çš„éšæ‚£

- **ä¼˜åŠ¿**ï¼šå®ç°ç®€å•ã€è°ƒè¯•æ–¹ä¾¿ã€PoC é˜¶æ®µçµæ´»ï¼›
- **éšæ‚£**ï¼š
  - æ¨¡å—å†…éƒ¨ Tag å¯ä»¥è¢«â€œè¶Šç•Œä½¿ç”¨â€ï¼Œå¦‚æœä¸ä¾èµ–å¹³å°æ£€æŸ¥ï¼Œå¾ˆéš¾åœ¨ TypeScript å±‚å®Œå…¨é˜»æ­¢ï¼›
  - æŸäº›é”™è¯¯ï¼ˆæ¯”å¦‚ Tag åå†²çªï¼‰ä¼šåœ¨è¿è¡Œæ—¶æ‰æš´éœ²ã€‚

ç¼“è§£ç­–ç•¥ï¼š

- **Tag å†²çªå¼ºæ ¡éªŒ**ï¼ˆè§ 3.1ï¼‰ï¼›
- ä¸¥æ ¼ä¾èµ– `exports` + å¹³å°æ£€æŸ¥ + Lint è§„åˆ™ï¼Œé¿å…è·¨æ¨¡å—éšæ„å¼•ç”¨ Tagï¼›
- åœ¨ Runtime æ—¥å¿—ä¸­å¢åŠ æ¨¡å—è¾¹ç•Œç›¸å…³çš„è¯Šæ–­ä¿¡æ¯ï¼Œæ–¹ä¾¿æ’æŸ¥ã€‚

#### 5.1.1 Tag å†²çªé£é™©ï¼ˆå‘½åçº¦å®šï¼‰

ç”±äº v3 é‡‡ç”¨ Env æ‰å¹³åˆå¹¶ï¼Œ**ä¸åŒæ¨¡å—æä¾›çš„ Tag ä¼šå…±äº«åŒä¸€ä¸ª Context å‘½åç©ºé—´**ã€‚

å»ºè®®çº¦å®šï¼š

- æ‰€æœ‰ Tag çš„ keyï¼ˆ`Context.Tag("...")` ä¸­çš„å­—ç¬¦ä¸²ï¼‰åº”ä¿æŒå…¨å±€å”¯ä¸€ï¼Œæ¨èåŒ…å«æ¨¡å—å‰ç¼€ï¼Œä¾‹å¦‚ï¼š
  - `"Order/OrderApi"`ã€`"User/UserStore"`ã€`"Global/Layout"`ï¼›
- å¯é€šè¿‡ Lint/å†…éƒ¨æ£€æŸ¥è„šæœ¬å¯¹ Tag key åšé‡å¤æ‰«æï¼Œæå‰å‘ç°æ½œåœ¨å†²çªã€‚

### 5.2 Link vs Process çš„è¯­ä¹‰åŒºåˆ†

v3 å¼•å…¥äº† `links` å­—æ®µï¼Œç”¨äºåŒºåˆ†â€œä¸šåŠ¡ç¼–æ’â€ä¸â€œåŸºç¡€è®¾æ–½â€ï¼š

- **Link (èƒ¶æ°´)**ï¼š
  - å±äºæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œè´Ÿè´£è¿æ¥å¤šä¸ª Domainï¼ˆå¦‚æœç´¢è”åŠ¨è¯¦æƒ…ï¼‰ï¼›
  - å¹³å°ä¼šåœ¨æ¶æ„å›¾ä¸­å°†å…¶æ¸²æŸ“ä¸ºé‡è¦èŠ‚ç‚¹ï¼›
  - æ¨èä½¿ç”¨ `Link.make("Name", ...)` åˆ›å»ºï¼Œä»¥ä¾¿å¹³å°è¯†åˆ«åç§°ã€‚
- **Process (æ‚å½¹)**ï¼š
  - å±äºåŸºç¡€è®¾æ–½ï¼Œè´Ÿè´£åå°ç»´æŠ¤ï¼ˆå¦‚æ—¥å¿—ã€å¿ƒè·³ï¼‰ï¼›
  - å¹³å°é€šå¸¸å°†å…¶æŠ˜å æˆ–éšè—ã€‚

è™½ç„¶ Runtime å¯¹å®ƒä»¬ä¸€è§†åŒä»ï¼Œä½†åœ¨ä»£ç ç»„ç»‡å’Œå¯è§†åŒ–ä¸Šï¼Œè¿™ç§åŒºåˆ†è‡³å…³é‡è¦ã€‚

### 5.2.1 Infra Error é€šé“çš„æ±‡èš

`ModuleDef.infra` çš„ Layer å…è®¸ `E = any`ï¼Œè¿™æ„å‘³ç€ï¼š

- å•ä¸ªæ¨¡å—çš„ infra éƒ¨åˆ†å¯èƒ½åœ¨æ„å»ºæ—¶å¤±è´¥ï¼ˆä¾‹å¦‚ Config è¯»å–å¤±è´¥ã€å¤–éƒ¨æœåŠ¡åˆå§‹åŒ–å¤±è´¥ï¼‰ï¼›
- å¤šä¸ªæ¨¡å— flatten åï¼ŒApp æ ¹ Layer çš„ Error é€šé“å®è´¨ä¸Šæ˜¯â€œæ‰€æœ‰å­æ¨¡å— Infra Error ç±»å‹çš„è”åˆâ€ã€‚

å®ç°ä¸ä½¿ç”¨å»ºè®®ï¼š

- åœ¨ `Logix.app(...).makeRuntime()` çš„è°ƒç”¨ä¾§ï¼Œæ˜ç¡®å¤„ç† App å¯åŠ¨å¤±è´¥çš„åœºæ™¯ï¼š
  - ä¾‹å¦‚åœ¨ CLI/Node åœºæ™¯ä¸­ log é”™è¯¯å¹¶é€€å‡ºï¼›
  - åœ¨å‰ç«¯åœºæ™¯ä¸­å±•ç¤ºâ€œåº”ç”¨å¯åŠ¨å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜â€ä¹‹ç±»çš„é™çº§ UIã€‚
- åœ¨ runtime å®ç°ä¸­ï¼Œä¿æŒ infra Layer çš„ Error é€šé“ä¸è¢«é»˜é»˜åæ‰ï¼›è®©è°ƒç”¨è€…æœ‰æœºä¼šåœ¨é¡¶å±‚çœ‹åˆ°å¹¶å¤„ç†è¿™äº›é”™è¯¯ã€‚

### 5.3 middlewares çš„ Runtime æ¥å…¥

- v3 ç‰ˆæœ¬ä¸­ï¼Œ`ModuleDef.middlewares` ä¸»è¦ä¸º **å¹³å°ä¸ä»£ç ç”Ÿæˆå™¨** æœåŠ¡ï¼š
  - å¹³å°å¯ä»¥æ ¹æ®æ¨¡å—é…ç½®ç”Ÿæˆæˆ–æ£€æŸ¥ `Logic.compose(Logging, AuthGuard, ...)` è¿™ç±»ç»„åˆè°ƒç”¨ï¼›
  - Runtime æš‚ä¸è‡ªåŠ¨ä» ModuleDef å°†ä¸­é—´ä»¶æ³¨å…¥åˆ° Logic æ‰§è¡Œè·¯å¾„ä¸­ã€‚
- è‹¥åç»­å¸Œæœ› Runtime è‡ªåŠ¨æ³¨å…¥ Module çº§ä¸­é—´ä»¶ï¼Œå¯ä»¥è€ƒè™‘ï¼š
  - å®šä¹‰ä¸€ä¸ª `LogicMiddlewareRegistry` Serviceï¼Œé€šè¿‡ Tag æä¾›ï¼›
  - åœ¨ `buildModule` æ—¶æ ¹æ® ModuleDef æ„é€ è¯¥ Registryï¼›
  - åœ¨ Logic æ„é€ çš„å®ç°ä¸­ä» Registry è¯»å–å½“å‰ Store/Module å¯¹åº”çš„ä¸­é—´ä»¶å¹¶å¥—ç”¨ã€‚

æ­¤æ–¹æ¡ˆè¾ƒé‡ï¼Œä¸”ä¼šç»™é€»è¾‘æ‰§è¡Œé“¾å¼•å…¥éšå¼ä¾èµ–ï¼Œv3 æš‚ä¸è½åœ°ï¼Œä»…ä½œä¸º v4 å¤‡é€‰æ–¹å‘è®°å½•ã€‚

---

**ç»“è®º**ï¼š
v3 çš„ `Logix.app` / `Logix.module` åœ¨å®ç°ä¸Šä»¥â€œé€’å½’ flatten åˆ°ä¸€ä¸ªå¤§ Layer + processes åˆ—è¡¨â€ä¸ºä¸»ï¼ŒEnv æ‰å¹³ã€exports åªç”¨äºç±»å‹ä¸å¹³å°æ£€æŸ¥ã€‚
å¼•å…¥ `links` å­—æ®µå®ç°äº†â€œä¸šåŠ¡ç¼–æ’â€ä¸â€œåŸºç¡€è®¾æ–½â€çš„è¯­ä¹‰åˆ†ç¦»ï¼Œä¸º Universe View æä¾›äº†å…³é”®çš„æ‹“æ‰‘ä¿¡æ¯ã€‚è¿™ä¸ºåç»­æ¼”è¿›ï¼ˆEnv è£å‰ªã€Lazy æ¨¡å—ã€è‡ªåŠ¨ Middleware æ³¨å…¥ï¼‰é¢„ç•™äº†ç©ºé—´ï¼ŒåŒæ—¶ä¿è¯å½“å‰å®ç°ç®€å•å¯æ§ã€è°ƒè¯•æˆæœ¬ä½ã€‚
***
</file>

<file path="runtime-logix/impl/logic-middleware-and-aop.md">
# Logic Middleware & AOP å®ç°è‰å›¾

> **Status**: Draft (v3 Final Â· Implementation Planning)
> **Scope**: Logic Middlewareï¼ˆæ—¥å¿—/é‰´æƒ/åŸ‹ç‚¹ç­‰æ¨ªåˆ‡å…³æ³¨ï¼‰åœ¨ v3 ä¸­çš„æ¨èå®ç°æ–¹å¼ä¸é™åˆ¶ã€‚

æœ¬è¯´æ˜æ–‡æ¡£ä»è¿è¡Œæ—¶å®ç°è§†è§’ï¼Œæ•´ç† v3 ç‰ˆæœ¬ä¸‹ Logic Middleware / AOP çš„è½åœ°æ–¹å¼ã€‚
æ ¸å¿ƒå–å‘ï¼š

- ä¿æŒ **Effectâ€‘Native**ï¼šä¸­é—´ä»¶æœ¬è´¨æ˜¯ `(Effect) => Effect` çš„ç»„åˆï¼Œä¸å¼•å…¥ Decorator æˆ–è¿è¡Œæ—¶åå°„ï¼›
- åŒºåˆ† **è®¾è®¡æ—¶ï¼ˆDesignâ€‘timeï¼‰** ä¸ **è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰** çš„èŒè´£ï¼š
  - v3 æ›´å€¾å‘äºé€šè¿‡å¹³å°/ç”Ÿæˆå™¨åœ¨ä»£ç ä¸­æ˜¾å¼æ’å…¥ Middleware è°ƒç”¨ï¼›
  - Runtime æ ¸å¿ƒä¸åšå¤æ‚çš„â€œè‡ªåŠ¨æ³¨å…¥â€ï¼Œé¿å…éšå¼è€¦åˆï¼›
- ä¸º v4 å¯èƒ½çš„â€œè¿è¡Œæ—¶ Middleware Registryâ€ç•™å‡ºæ€è€ƒç©ºé—´ï¼Œä½†ä¸åœ¨ v3 å®ç°ã€‚

## 1. ç±»å‹å›é¡¾ï¼šLogicMeta / Middleware

åœ¨ core è§„èŒƒä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ï¼š

```ts
export interface LogicMeta {
  readonly name: string      // é€»è¾‘åç§° (e.g. "submitOrder")
  readonly storeId?: string  // æ‰€å± Store ID
  readonly action?: unknown  // è§¦å‘è¯¥é€»è¾‘çš„ Action (å¦‚æœ‰)
  readonly tags?: string[]   // è‡ªå®šä¹‰æ ‡ç­¾ (e.g. ["audit", "auth"])
}

// åŸºç¡€ Middleware å®šä¹‰
export type Middleware<R = never> = (
  effect: Effect.Effect<any, any, any>,
  meta: LogicMeta
) => Effect.Effect<any, any, any>;
```

> å®ç°å¤‡æ³¨
> - æ­£å¼å®ç°ä¸­ï¼ŒMiddleware æ›´æ¨èä½¿ç”¨ `Logic.Of<Sh, R, A, E>` ç­‰åˆ«åï¼Œä»¥ä¿ç•™åŸå§‹ A/E/R ç±»å‹ä¿¡æ¯ï¼›
> - æ ¸å¿ƒè¯­ä¹‰ä¸å˜ï¼šMiddleware æ˜¯å›´ç»• Logic Effect çš„é«˜é˜¶ç»„åˆå™¨ã€‚

## 2. v3 æ¨èä½¿ç”¨æ¨¡å¼ï¼šExplicit Composition (Hard Constraint)

ä¸ºäº†é˜²æ­¢å¼€å‘è€…å¿˜è®°åŒ…è£¹å¿…è¦çš„ä¸­é—´ä»¶ï¼ˆå¦‚é‰´æƒï¼‰ï¼Œv3 å¼•å…¥ **Branded Type + Lint** åŒé‡ä¿é™©æœºåˆ¶ã€‚

### 2.1 å“ç‰Œç±»å‹ä¸å®‰å…¨å…¥å£

åœ¨ Runtime ç±»å‹å®šä¹‰ä¸­å¼•å…¥ `Logic.Secured`ï¼š

```ts
declare const Secured: unique symbol

// åªæœ‰ç»è¿‡ Logic.secure å¤„ç†çš„ Effect æ‰æœ‰æ­¤æ ‡è®°
export type Secured<Sh, R, A, E> =
  Of<Sh, R, A, E> & { readonly [Secured]: true }

export namespace Logic {
  // å”¯ä¸€åˆæ³•çš„â€œåŠ å›ºâ€å…¥å£
  export function secure<Sh, R, A, E>(
    eff: Of<Sh, R, A, E>,
    meta: LogicMeta,
    ...middlewares: ReadonlyArray<Middleware<Sh, R, A, E>>
  ): Secured<Sh, R, A, E> {
    const composed = compose(...middlewares)(eff, meta)
    return composed as Secured<Sh, R, A, E>
  }
}
```

ä¿®æ”¹ `$Module.flow.run` ç­¾åï¼Œå¼ºåˆ¶è¦æ±‚ `Logic.Secured`ï¼š

```ts
interface FlowApi<Sh, R> {
  // åªæ¥å— Logic.Securedï¼Œè£¸ Effect ä¼šæŠ¥é”™
  run<A, E>(eff: Logic.Secured<Sh, R, A, E>): Of<Sh, R, void, never>
}
```

### 2.2 ESLint è§„åˆ™å…œåº•

å³ä½¿ç±»å‹ç³»ç»Ÿè¢« `as any` ç»•è¿‡ï¼ŒCI/CD å¿…é¡»åŒ…å«ä¸€æ¡ ESLint è§„åˆ™ï¼ˆå¦‚ `runtime-logix/require-secure-middleware`ï¼‰ï¼š

- **è§„åˆ™é€»è¾‘**ï¼šæ‰«ææ‰€æœ‰ `$X.flow.run(...)` è°ƒç”¨ï¼›
- **è¦æ±‚**ï¼šå‚æ•°å¿…é¡»æ˜¯ `Logic.secure(...)` è°ƒç”¨è¡¨è¾¾å¼ï¼›
- **ä¾‹å¤–**ï¼šä»…å…è®¸å¸¦æœ‰ `// logic:allow-raw` æ³¨é‡Šçš„ä»£ç ï¼ˆç”¨äº PoC æˆ–ç‰¹æ®Šåº•å±‚é€»è¾‘ï¼‰ã€‚

### 2.3 ç¤ºä¾‹ä»£ç 

```ts
const Logging: Logic.Middleware<Env> = /* ... */
const AuthGuard: Logic.Middleware<Env> = /* ... */

export const AdminLogic: Logic.Of<UserShape, Env> = Effect.gen(function* () {
  // ...
  const deleteEffect = /* ... */

  yield* delete$.pipe(
    $User.flow.run(
      // å¿…é¡»ä½¿ç”¨ Logic.secure åŒ…è£¹ï¼Œå¦åˆ™ç¼–è¯‘æŠ¥é”™ + Lint æŠ¥é”™
      Logic.secure(deleteEffect, {
          name: 'deleteUser',
          storeId: 'UserStore',
          tags: ['audit', 'auth'],
        },
        Logging,
        AuthGuard
      ),
    ),
  )
})
```

## 3. Logic.compose ä¸ç±»å‹ä¿æŒ

ä¸ºäº†ä¿è¯ä¸­é—´ä»¶ä¸ç ´åä¸šåŠ¡é€»è¾‘çš„ç±»å‹å¥‘çº¦ï¼ˆR/Eï¼‰ï¼Œ`Logic.compose` å¿…é¡»ä¸¥æ ¼ç±»å‹åŒ–ã€‚

### 3.1 FxMiddleware å®šä¹‰

åªå…è®¸å¯¹åŒä¸€ä¸ª `Fx<Sh, R, A, E>` åšè‡ªåŒæ€è½¬æ¢ï¼ˆEndomorphismï¼‰ï¼š

```ts
export type FxMiddleware<Sh, R, A, E> =
  (eff: Fx<Sh, R, A, E>, meta: LogicMeta) => Fx<Sh, R, A, E>
```

### 3.2 ä¸¥æ ¼ç»„åˆå™¨

```ts
export namespace Logic {
  export function compose<Sh, R, A, E>(
    ...mws: ReadonlyArray<FxMiddleware<Sh, R, A, E>>
  ): FxMiddleware<Sh, R, A, E> {
    return (eff, meta) =>
      mws.reduceRight((acc, mw) => mw(acc, meta), eff)
  }
}
```

**é˜²å‘†æ•ˆæœ**ï¼š
- å¦‚æœæŸä¸ªä¸­é—´ä»¶è¯•å›¾å¼•å…¥é¢å¤–çš„ Env ä¾èµ–ï¼ˆä¸åœ¨ R ä¸­ï¼‰ï¼Œæˆ–è€…æŠ›å‡ºæœªå£°æ˜çš„ Errorï¼ˆä¸åœ¨ E ä¸­ï¼‰ï¼ŒTS ç¼–è¯‘å™¨ä¼šç›´æ¥æŠ¥é”™ï¼›
- ç¡®å®éœ€è¦æ”¹å˜ R/E çš„â€œè¾¹ç•Œä¸­é—´ä»¶â€ï¼ˆå¦‚é”™è¯¯è½¬æ¢å±‚ï¼‰ï¼Œå¿…é¡»ä½¿ç”¨å¦ä¸€å¥— `AdvancedMiddleware` æ¥å£ï¼Œä¸”åªèƒ½åœ¨ Runtime è¾¹ç•Œä½¿ç”¨ï¼Œä¸èƒ½æ··å…¥æ™®é€šä¸šåŠ¡é“¾ã€‚

## 4. ModuleDef.middlewares çš„è§’è‰²

åœ¨ v3 è®¾è®¡ä¸­ï¼Œ`ModuleDef.middlewares` **ä¸»è¦æœåŠ¡äºå¹³å°ä¸ä»£ç ç”Ÿæˆå™¨**ï¼ŒRuntime ä¸è‡ªåŠ¨ä½¿ç”¨å®ƒã€‚

ä½¿ç”¨æ–¹å¼ï¼ˆè®¾è®¡æ—¶ï¼‰ï¼š

- å¹³å° UI / é…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä¸ºæŸä¸ªæ¨¡å—å‹¾é€‰â€œå¯ç”¨æ—¥å¿— / å¯ç”¨é‰´æƒâ€ï¼›
- å‡ºç å™¨è¯»å– `middlewares` åˆ—è¡¨ï¼Œåœ¨ç”Ÿæˆ Logic ä»£ç æ—¶è‡ªåŠ¨æ’å…¥ `Logic.secure(..., [Logging, AuthGuard])`ã€‚

Runtime ä¸åšï¼š

- ä¸ä¼šåœ¨ Logic æ„é€ è¿‡ç¨‹ä¸­è‡ªåŠ¨è¯»å– ModuleDef.middlewaresï¼›
- ä¸ä¼šæœ‰å…¨å±€ Middleware Registry è‡ªåŠ¨åˆ†å‘ä¸­é—´ä»¶ã€‚

## 5. Codegen vs Runtimeï¼šå¤±åŒæ­¥é£é™©ä¸é˜²æŠ¤

ç”±äº v3 ä¾èµ– Codegen æ˜¾å¼æ’å…¥ä¸­é—´ä»¶ï¼Œæœ€å¤§çš„é£é™©æ˜¯ **Codegen ç»“æœä¸ ModuleDef é…ç½®ä¸ä¸€è‡´**ã€‚

### 5.1 é£é™©åœºæ™¯
- å¼€å‘è€…ä¿®æ”¹äº† `ModuleDef.middlewares`ï¼ˆå¦‚åŠ äº† Authï¼‰ï¼Œä½†å¿˜è®°è¿è¡Œ Codegenï¼Œå¯¼è‡´ç”Ÿæˆçš„ Logic ä»£ç é‡Œæ²¡æœ‰ AuthGuardï¼›
- å¼€å‘è€…æ‰‹åŠ¨ä¿®æ”¹äº† Logic ä»£ç ï¼Œåˆ æ‰äº† `Logic.secure` é‡Œçš„ AuthGuardã€‚

### 5.2 é˜²æŠ¤ç­–ç•¥ (Foolproof)

1. **CI å¼ºåˆ¶æ£€æŸ¥**ï¼š
   - CI æµç¨‹ä¸­å¿…é¡»åŒ…å« `pnpm codegen --check` æ­¥éª¤ï¼›
   - è¯¥æ­¥éª¤ä¼šæ ¹æ®å½“å‰çš„ ModuleDef é‡æ–°ç”Ÿæˆå†…å­˜ä¸­çš„ä»£ç ï¼Œå¹¶ä¸ç£ç›˜ä¸Šçš„æ–‡ä»¶æ¯”å¯¹ï¼›
   - è‹¥æœ‰å·®å¼‚ï¼ˆè¯´æ˜é…ç½®æ”¹äº†æ²¡ç”Ÿæˆï¼Œæˆ–æ‰‹æ”¹äº†ç”Ÿæˆä»£ç ï¼‰ï¼ŒCI ç›´æ¥å¤±è´¥ã€‚

2. **å¹³å°ä¾§æç¤º**ï¼š
   - å¹³å° UI åœ¨ä¿å­˜ ModuleDef æ—¶ï¼Œåº”è‡ªåŠ¨è§¦å‘æœ¬åœ° Codegenï¼›
   - è‹¥æ£€æµ‹åˆ°æœ¬åœ°æœ‰æœªæäº¤çš„ Codegen å˜æ›´ï¼ŒUI åº”é«˜äº®æç¤ºâ€œä»£ç ä¸é…ç½®ä¸åŒæ­¥â€ã€‚

3. **Runtime è¾…åŠ©æ£€æŸ¥ (Optional)**ï¼š
   - åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼ŒRuntime å¯ä»¥è¯»å– `ModuleDef.middlewares`ï¼Œå¹¶å°è¯•æ£€æŸ¥ LogicMeta ä¸­çš„ tags æ˜¯å¦åŒ…å«äº†é¢„æœŸçš„ä¸­é—´ä»¶æ ‡è®°ï¼ˆå¦‚æœä¸­é—´ä»¶ä¼šåœ¨ meta ä¸Šæ‰“æ ‡çš„è¯ï¼‰ï¼›
   - è‹¥å‘ç°ä¸ä¸€è‡´ï¼Œæ‰“å° Warningã€‚

## 6. å¹³å°ä¸ Runtime çš„èŒè´£è¾¹ç•Œ

æ€»ç»“ v3 å¯¹ Middleware/AOP çš„åˆ†å·¥ï¼š

- **Runtime**ï¼š
  - æä¾› `Logic.Meta`ã€`Middleware`ã€`Logic.secure` ç­‰åŸºç¡€æ‹¼è£…å·¥å…·ï¼›
  - **ä¸**ä¸»åŠ¨è§£æ ModuleDef.middlewaresï¼Œ**ä¸**è‡ªåŠ¨æ³¨å…¥ã€‚

- **å¹³å° / ç”Ÿæˆå™¨**ï¼š
  - è´Ÿè´£è¯»å– ModuleDef.middlewares ä¸ä»£ç ä¸­çš„ Middleware å®šä¹‰ï¼›
  - åœ¨ç”Ÿæˆ Logic ä»£ç æ—¶æ’å…¥ `Logic.secure(...)` æ˜¾å¼è°ƒç”¨ï¼›
  - è´Ÿè´£ CI/CD é˜¶æ®µçš„ä¸€è‡´æ€§æ£€æŸ¥ã€‚

è¿™ç§åˆ†å·¥æ—¢ä¿ç•™äº† Effectâ€‘Native çš„è¿è¡Œæ—¶ç®€å•æ€§ï¼Œåˆä¿è¯äº†å¹³å°å±‚è¶³å¤Ÿçš„è¡¨è¾¾åŠ›ä¸é…ç½®åŒ–ç©ºé—´ï¼ŒåŒæ—¶é€šè¿‡ Branded Type å’Œ CI Check å°å µäº†äººä¸ºç–æ¼çš„é£é™©ã€‚
</file>

<file path="runtime-logix/impl/module-lifecycle-and-scope.md">
# Module Runtime Lifecycle & Scope å®ç°è‰å›¾

> **Status**: Draft (v3 Final Â· Implementation Planning)
> **Scope**: `ModuleRuntimeConfig.lifecycle` åœ¨è¿è¡Œæ—¶ä¸­å¦‚ä½•ç»‘å®šåˆ° Effect Scopeï¼Œå®ç° Local / Global Module çš„ onInit/onDestroy è¯­ä¹‰ã€‚

æœ¬è¯´æ˜æ–‡æ¡£èšç„¦äº v3 ä¸­ Module ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆ`onInit` / `onDestroy`ï¼‰çš„è¿è¡Œæ—¶å®ç°æ–¹å¼ï¼Œå°¤å…¶æ˜¯å®ƒä»¬ä¸ Effect Scope çš„å…³ç³»ã€‚

ç›®æ ‡ï¼š

- æ˜ç¡® Local Moduleï¼ˆ`useLocalModule`ï¼‰ä¸ Global Moduleï¼ˆApp modules ä¸­çš„ Moduleï¼‰åœ¨ç”Ÿå‘½å‘¨æœŸä¸Šçš„å·®å¼‚ä¸å…±æ€§ï¼›
- ç»™å‡º `ModuleRuntime.make` / Module Runner çš„ä¼ªä»£ç ï¼Œè¯´æ˜ä½•æ—¶è§¦å‘ onInitã€å¦‚ä½•æ³¨å†Œ onDestroyï¼›
- æå‰æŒ‡å‡ºé”™è¯¯å¤„ç†ä¸å¹¶å‘ç›¸å…³çš„æ³¨æ„ç‚¹ã€‚

> **Note**: `ModuleRuntime.make` ä¸ `ModuleRuntimeConfig` æ˜¯ Runtime å†…éƒ¨çš„åº•å±‚åŸè¯­ã€‚åœ¨ä¸šåŠ¡å±‚ï¼Œå®ƒä»¬è¢«å°è£…åœ¨ `Logix.Module` + `Module.live` ä¹‹ä¸‹ã€‚æœ¬æ–‡æ¡£ä¸»è¦ä¾›å¼•æ“å¼€å‘è€…å‚è€ƒã€‚

## 1. ModuleRuntimeConfig.lifecycle å›é¡¾

æ ¸å¿ƒé…ç½®å¦‚ä¸‹ï¼š

```ts
export interface ModuleRuntimeConfig<S, A, R = never> {
  initial: S
  logic: Effect.Effect<any, any, any>[]

  lifecycle?: {
    // Module å®ä¾‹åˆ›å»ºå¹¶æŒ‚è½½åˆ° Scope åç«‹å³æ‰§è¡Œ
    // è‹¥ Logic ä¸­å®šä¹‰äº†å¤šä¸ª onInitï¼Œæ­¤å¤„ä¸ºå®ƒä»¬çš„ä¸²è¡Œç»„åˆ
    onInit?: Effect.Effect<void, never, R>

    // Module æ‰€åœ¨ Scope å…³é—­å‰æ‰§è¡Œ (è‡ªåŠ¨æ³¨å†Œä¸º finalizer)
    onDestroy?: Effect.Effect<void, never, R>
  }
}
```

å…³é”®çº¦æŸï¼š

- `onInit` / `onDestroy` çš„é”™è¯¯é€šé“ä¸º `never`ï¼š
  - æ„å‘³ç€ï¼šé’©å­å†…éƒ¨å¿…é¡»è‡ªè¡Œå¤„ç†é”™è¯¯ï¼ˆä¾‹å¦‚ log + å¿½ç•¥ï¼‰ï¼Œä¸èƒ½è®©é”™è¯¯å†’æ³¡ç ´åæ•´ä¸ª Scopeï¼›
  - è‹¥æœªæ¥å‘ç°ç¡®æœ‰éœ€è¦ï¼Œå¯ä»¥æ”¾å®½ä¸º `E = any`ï¼Œå¹¶åœ¨ Runner ä¾§æ•è·æ—¥å¿—åå¿½ç•¥ã€‚

## 2. Runtime è§†è§’çš„ Module Runner

ä¸ºäº†ä¿è¯ `E=never` çš„çº¦æŸåœ¨è¿è¡Œæ—¶çœŸæ­£è½åœ°ï¼ŒRunner å¿…é¡»å¯¹ lifecycle hook è¿›è¡Œå®‰å…¨åŒ…è£…ã€‚

### 2.1 å®‰å…¨åŒ…è£…å™¨ (Foolproof Wrapper)

```ts
function safeLifecycleEffect<R>(
  id: string,
  hook: Effect.Effect<void, unknown, R> | undefined,
): Effect.Effect<void, never, R> {
  if (!hook) return Effect.unit

  return hook.pipe(
    Effect.matchCauseEffect({
      onSuccess: () => Effect.unit,
      onFailure: (cause) =>
        Effect.logError("Module lifecycle failed", { id, cause }).pipe(
          Effect.asUnit,
        ),
    }),
  )
}
```

### 2.2 Runner å®ç°ä¼ªä»£ç 

```ts
function ModuleRuntime.make<Sh extends Logix.ModuleShape<any, any>, R>(
  config: ModuleRuntimeConfig<Logix.StateOf<Sh>, Logix.ActionOf<Sh>, R>,
): Effect.Effect<ModuleRuntime<Logix.StateOf<Sh>, Logix.ActionOf<Sh>>, never, R> {
  const { initial, logic, lifecycle } = config

  return Effect.gen(function* () {
    // 1. æ„é€  Logic ç¨‹åºçš„ç»„åˆ
    const logicProgram = Effect.all(logic, { concurrency: "unbounded" as const })

    // 2. åœ¨ scoped ç¯å¢ƒä¸­å¯åŠ¨ Logic + æ³¨å†Œ finalizer
    const runtime = yield* Effect.scoped(
      Effect.gen(function* () {
        // 3.1 åˆ›å»º ModuleRuntimeï¼ˆå†…éƒ¨ä¼šä½¿ç”¨ stateLayer / actionLayer / logicProgramï¼‰
        const moduleRuntime = yield* buildModuleRuntime(stateLayer, actionLayer, logicProgram)

        // 3.2 æ³¨å†Œ onDestroy ä½œä¸º Scope finalizer (ä½¿ç”¨ safe wrapper)
        if (lifecycle?.onDestroy) {
          yield* Scope.addFinalizer(
            safeLifecycleEffect("module-destroy", lifecycle.onDestroy)
          )
        }

        // 3.3 è¿è¡Œ onInit (ä½¿ç”¨ safe wrapper)
        if (lifecycle?.onInit) {
          yield* safeLifecycleEffect("module-init", lifecycle.onInit)
        }

        return moduleRuntime
      }),
    )

    return runtime
  })
}
```

> **æ ¸å¿ƒåŸåˆ™**ï¼šå³ä½¿ä¸šåŠ¡ç«¯è¯¯å†™äº†æœ‰é”™è¯¯é€šé“çš„ Hookï¼ŒRunner ä¹Ÿä¼šåæ‰å¹¶è®°å½•åˆ°æ—¥å¿—ï¼›è¿™ç±»å†™æ³•è§†ä¸º bugï¼Œä½†ä¸ä¼šå½±å“å…¶å®ƒ Module / Scopeã€‚

## 3. é”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼šStatus Pattern

ç”±äº `onInit` ä¸èƒ½æŠ›é”™ï¼Œæ¨èä½¿ç”¨ **Status Pattern** å°†é”™è¯¯å†…åŒ–ä¸ºé¢†åŸŸçŠ¶æ€ï¼š

```ts
type Status = "idle" | "initializing" | "ready" | "error"

const onInit = Effect.gen(function* () {
  yield* $.state.update(s => ({ ...s, status: "initializing" }))

  // å°è¯•æ‰§è¡Œå¯èƒ½å¤±è´¥çš„æ“ä½œ
  const result = yield* Effect.tryPromise(fetchConfig).pipe(
    Effect.either
  )

  if (result._tag === "Left") {
    // å¤±è´¥ï¼šå†™å…¥é”™è¯¯çŠ¶æ€ï¼Œä¸æŠ›é”™
    yield* $.state.update(s => ({
      ...s,
      status: "error",
      error: result.left
    }))
  } else {
    // æˆåŠŸ
    yield* $.state.update(s => ({
      ...s,
      status: "ready",
      config: result.right
    }))
  }
})
```

## 4. Local Module ä¸ React Strict Mode

### 4.1 Strict Mode ä¸‹çš„ç”Ÿå‘½å‘¨æœŸæŒ‘æˆ˜

React 18 Strict Mode ä¼šåœ¨å¼€å‘ç¯å¢ƒä¸‹æ‰§è¡Œ `Mount -> Unmount -> Mount` åºåˆ—ã€‚
è¿™æ„å‘³ç€ `useLocalModule` ä¼šç»å†ï¼š
1. `Scope 1` åˆ›å»º -> `onInit`
2. `Scope 1` å…³é—­ -> `onDestroy`
3. `Scope 2` åˆ›å»º -> `onInit`

### 4.2 å¹‚ç­‰æ€§è¦æ±‚

ä¸šåŠ¡ä»£ç å¿…é¡»ä¿è¯ `onInit` æ˜¯**é€»è¾‘å¹‚ç­‰**çš„ï¼Œæˆ–è€…èƒ½å®¹å¿å¤šæ¬¡æ‰§è¡Œã€‚
æ¨èåœ¨ `onInit` å¼€å¤´æ£€æŸ¥çŠ¶æ€ï¼š

```ts
const onInit = Effect.gen(function* () {
  const status = yield* $.state.read(s => s.status)
  // å¦‚æœå·²ç»æ˜¯ ready/initializingï¼Œè¯´æ˜å¯èƒ½æ˜¯çƒ­é‡è½½æˆ–é‡å¤æŒ‚è½½ï¼ˆè§†å…·ä½“ Module æŒä¹…åŒ–ç­–ç•¥è€Œå®šï¼‰
  // å¯¹äº Local Moduleï¼Œé€šå¸¸æ¯æ¬¡éƒ½æ˜¯æ–°å®ä¾‹ï¼ŒçŠ¶æ€é‡ç½®ï¼Œæ‰€ä»¥ä¸»è¦é â€œä¸å‰¯ä½œç”¨å¤–éƒ¨ç³»ç»Ÿâ€æ¥ä¿è¯å®‰å…¨ã€‚
  if (status !== "idle") return

  // ...
})
```

### 4.3 `useLocalModule` å®ç°èŒƒå¼ï¼ˆé˜² Scope æ³„æ¼ & å†…å­˜è†¨èƒ€ï¼‰

å¯¹è¿˜ä¸ç†Ÿæ‚‰ Effect-ts çš„å¼€å‘è€…ï¼Œå¯ä»¥æŠŠ `useLocalModule` æƒ³è±¡æˆï¼š

> â€œå¸®ä½ åœ¨ç»„ä»¶ä¸‹é¢å¼€ä¸€å—å°ç©ºé—´ï¼ŒæŠŠ ModuleRuntime æ”¾è¿›å»ï¼Œç”¨å®Œå°±æ•´ä½“å…³æ‰è¿™å—ç©ºé—´ã€‚â€

æ ¸å¿ƒè¦ç‚¹ï¼š

- **Scope æ˜¯â€œèµ„æºåŒ…è£¹å±‚â€**ï¼š  
  - åœ¨ Effect é‡Œï¼Œ`Scope` å¯ä»¥ç†è§£ä¸ºâ€œä¸€å—æŒ‚èµ„æºçš„æŒ‚è½½ç‚¹â€ï¼›  
  - æŸæ£µ ModuleRuntimeã€å®ƒçš„ watcher Fiberã€å†…éƒ¨ç”¨åˆ°çš„ PubSub/SubscriptionRefï¼Œéƒ½ä¼šæŒ‚åœ¨æŸä¸ª Scope ä¸Šã€‚  
- **Context ä¸æ˜¯å…¨å±€å•ä¾‹**ï¼š  
  - `Layer.buildWithScope(layer, scope)` ä¼šæ„é€ ä¸€ä»½â€œåªåœ¨è¿™ä¸ª Scope ä¸­æœ‰æ•ˆâ€çš„ Contextï¼ˆEnvï¼‰ï¼›  
  - è¿™ä»½ Context éš Scope ç”Ÿå‘½å‘¨æœŸå­˜åœ¨ï¼ŒScope å…³æ‰åï¼Œè¿™ä»½ Env ä¹Ÿå°±éšä¹‹å¤±æ•ˆï¼Œä¸ä¼šæŒ‚åœ¨ä»€ä¹ˆå…¨å±€é™æ€å˜é‡ä¸Šã€‚

React ä¾§çš„ `useLocalModule` å¿…é¡»ä¿è¯ï¼š

1. æ¯æ¬¡è°ƒç”¨åªåˆ›å»º **ä¸€æ£µæ´»çš„ Scope + ModuleRuntime**ï¼›  
2. ç»„ä»¶å¸è½½æˆ–ä¾èµ–å˜æ›´æ—¶ï¼Œä¸€å®šä¼šè°ƒç”¨ `Scope.close` å…³é—­è¿™æ£µ Scopeã€‚

ä¼ªä»£ç ç¤ºæ„ï¼š

```ts
function useLocalModule(factory, deps) {
  const [module, setModule] = useState(null)
  const scopeRef = useRef<Scope | null>(null)
  const runtime = useRuntime() // App çº§ ManagedRuntime

  useEffect(() => {
    // 1. æ¸…ç†æ—§ Scopeï¼ˆå¦‚æœæœ‰ï¼‰â€”â€”é˜²å¾¡æ€§ï¼Œé¿å…æ—§å®ä¾‹æ‚¬æŒ‚
    if (scopeRef.current) {
      runtime.runSync(Scope.close(scopeRef.current, Exit.unit))
      scopeRef.current = null
    }

    // 2. åˆ›å»ºæ–° Scope å¹¶å¯åŠ¨ ModuleRuntime
    const fiber = runtime.runFork(
      Effect.gen(function* () {
        const scope = yield* Scope.make()
        scopeRef.current = scope

        // åœ¨ scope å†…æ„é€  ModuleRuntimeï¼ˆè§¦å‘ onInitï¼‰
        const moduleRuntime = yield* Effect.scoped(factory()).pipe(
          Scope.extend(scope),
        )

        setModule(moduleRuntime)
      }),
    )

    // 3. Cleanupï¼šç»„ä»¶å¸è½½æˆ– deps å˜æ›´æ—¶ï¼Œå…³é—­ Scopeï¼ˆè§¦å‘ onDestroyï¼‰
    return () => {
      if (scopeRef.current) {
        runtime.runFork(Scope.close(scopeRef.current, Exit.unit))
        scopeRef.current = null
      }
      // åŒæ—¶ä¹Ÿä¸­æ–­å¯åŠ¨ Fiberï¼ˆå¦‚æœä»åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼‰
      fiber.interruptAsFork("react-unmount")
    }
  }, deps)

  return module
}
```

**å¯¹â€œå†…å­˜ä¼šä¸ä¼šä¸€ç›´æ¶¨â€çš„ç›´è§‚è§£è¯»ï¼š**

- æ¯ä¸ª `useLocalModule` è°ƒç”¨éƒ½ä¼šå¯¹åº”ä¸€æ£µ Scopeï¼ŒScope é‡ŒæŒ‚ç€è¿™ä¸€æ£µ ModuleRuntime å’Œå®ƒç›¸å…³çš„èµ„æºï¼›  
- å½“ç»„ä»¶å¸è½½æ—¶ï¼Œæˆ‘ä»¬æ˜¾å¼è°ƒç”¨ `Scope.close`ï¼š  
  - Effect Runtime ä¼šè´Ÿè´£è§¦å‘æ‰€æœ‰ finalizerï¼ˆåŒ…æ‹¬ `ModuleRuntime` çš„ `onDestroy`ï¼‰ï¼›  
  - æŠŠæŒ‚åœ¨è¿™ä¸ª Scope ä¸Šçš„ Context/èµ„æºä»è¿è¡Œæ—¶å›¾ä¸­ç§»é™¤ï¼›  
  - React ä¸å†æŒæœ‰é‚£æ£µ `ModuleRuntime` çš„å¼•ç”¨ï¼Œå‰©ä¸‹äº¤ç»™ JS GC å›æ”¶ã€‚  
- åªè¦éµå®ˆâ€œæ¯ä¸ªç»„ä»¶å¯¹åº”çš„ Scope æœ€ç»ˆä¸€å®šä¼šè¢«å…³é—­â€è¿™ä¸€ç‚¹ï¼Œå°±ä¸ä¼šå‡ºç°â€œç”¨ä¹…äº†å±€éƒ¨ Module å†…å­˜ä¸€ç›´è†¨èƒ€â€çš„æƒ…å†µã€‚

æ€»ç»“è¿™ä¸€èŠ‚çš„å…³é”®ä¸å˜é‡ï¼š

- ä»»æ„æ—¶åˆ»ï¼Œä¸€ä¸ª `useLocalModule` å®ä¾‹æœ€å¤šæŒæœ‰ä¸€ä¸ªæ´»è·ƒçš„ `Scope`ï¼›  
- React cleanup å¿…å®šè°ƒç”¨ `Scope.close`ï¼Œä»è€Œè§¦å‘ `onDestroy` finalizer å’Œèµ„æºé‡Šæ”¾ï¼›  
- å³ä½¿åœ¨ Strict Mode ä¸‹çš„â€œMount â†’ Unmount â†’ Mountâ€åºåˆ—ä¸­ï¼Œä¹‹å‰çš„ Scope ä¹Ÿä¼šè¢«å®Œæ•´å…³é—­ï¼Œä¸ä¼šç•™ä¸‹æ‚¬æŒ‚çš„ ModuleRuntimeã€‚

## 5. Global Module çš„ç”Ÿå‘½å‘¨æœŸï¼ˆAppRuntime è·¯å¾„ï¼‰

Global Module çš„ Scope ç”± **AppRuntime æ ¹ Scope** ç®¡ç†ã€‚æœ¬èŠ‚ç»“åˆ `Logix.app` çš„å®ç°ï¼Œè¯´æ˜å…¨å±€æ¨¡å—å¦‚ä½•æŒ‚è½½ä¸é”€æ¯ã€‚

### 5.1 AppRuntime ä¸ AppDefinition

åœ¨ runtime å±‚ï¼Œ`Logix.app` çš„å®šä¹‰é›†ä¸­åœ¨ `AppRuntime.ts` ä¸­ï¼š

```ts
// App æ¨¡å—æ¡ç›®ï¼šç”± Logix.provide ç”Ÿæˆ
export interface AppModuleEntry {
  readonly module: ModuleInstance<any, AnyModuleShape>
  readonly layer: Layer.Layer<any, any, any>
}

export interface LogixAppConfig<R> {
  readonly layer: Layer.Layer<R, never, never>                // App çº§åŸºç¡€ Env
  readonly modules: ReadonlyArray<AppModuleEntry>             // å…¨å±€æ¨¡å—åˆ—è¡¨
  readonly processes: ReadonlyArray<Effect.Effect<void, any, any>> // é•¿ç”Ÿå‘½å‘¨æœŸè¿›ç¨‹
  readonly onError?: (
    cause: import("effect").Cause.Cause<unknown>
  ) => Effect.Effect<void>
}

export interface AppDefinition<R> {
  readonly definition: LogixAppConfig<R>
  readonly layer: Layer.Layer<R, never, never>                // èšåˆåçš„ App Layer
  readonly makeRuntime: () => ManagedRuntime.ManagedRuntime<R, never>
}
```

`makeApp` çš„æ ¸å¿ƒé€»è¾‘ç®€åŒ–åå¦‚ä¸‹ï¼š

```ts
export const makeApp = <R>(config: LogixAppConfig<R>): AppDefinition<R> => {
  // 1. æ ¡éªŒæ¨¡å— ID å”¯ä¸€æ€§
  const seenIds = new Set<string>()
  for (const entry of config.modules) {
    const id = String(entry.module.id)
    if (seenIds.has(id)) {
      throw new Error(`Duplicate Module ID: ${id}`)
    }
    seenIds.add(id)
  }

  // 2. èšåˆæ‰€æœ‰æ¨¡å— Layer
  const moduleLayers = config.modules.map((entry) => entry.layer)
  const envLayer = moduleLayers.length > 0
    ? Layer.mergeAll(config.layer, ...moduleLayers)
    : config.layer

  // 3. ä¸º App æ„é€ ä¸€ä¸ªã€Œæ ¹ Scope + Envã€
  const finalLayer = Layer.unwrapScoped(
    Effect.gen(function* () {
      const scope = yield* Effect.scope
      const env = yield* Layer.buildWithScope(envLayer, scope)

      // 4. åœ¨åŒä¸€ Scope ä¸‹å¯åŠ¨æ‰€æœ‰ Processï¼ˆåè°ƒå™¨ç­‰é•¿æœŸä»»åŠ¡ï¼‰
      yield* Effect.forEach(config.processes, (process) =>
        Effect.forkScoped(
          Effect.provide(
            config.onError
              ? Effect.catchAllCause(process, config.onError)
              : process,
            env
          )
        )
      )

      // 5. è¿”å›å¸¦ Env çš„ Layerï¼šåç»­ runtime å¤ç”¨è¿™ä»½ Context
      return Layer.succeedContext(env)
    })
  ) as Layer.Layer<R, never, never>

  return {
    definition: config,
    layer: finalLayer,
    makeRuntime: () => ManagedRuntime.make(finalLayer),
  }
}
```

**å…³é”®ç‚¹ï¼š**

- æ‰€æœ‰ `modules[].layer`ï¼ˆé€šå¸¸æ˜¯ `ModuleImpl.layer` æˆ– `Module.live(...)` è¿”å›å€¼ï¼‰ä¼šä¸ App çº§åŸºç¡€ `layer` ä¸€èµ·æ„æˆä¸€ä¸ªå¤§çš„ Layerï¼ŒæŒ‚åœ¨ **åŒä¸€æ£µ App Scope** ä¸‹ï¼›  
- è¿™ä¸ª App Scope ç”± `ManagedRuntime.make(finalLayer)` æŒæœ‰ï¼šå½“ AppRuntime è¢« `dispose()` æ—¶ï¼Œè¿™æ£µ Scope è¢«å…³é—­ï¼Œæ‰€æœ‰å…¨å±€ ModuleRuntime å’Œ Process ç»Ÿä¸€é”€æ¯ã€‚

### 5.2 Logix.provide ä¸ ModuleImpl

ä¸ºäº†æ–¹ä¾¿æŠŠæ¨¡å—æŒ‚åˆ° App ä¸Šï¼Œ`Logix.provide` æä¾›äº†ä¸¤ç§è°ƒç”¨æ–¹å¼ï¼š

```ts
// 1. æ˜¾å¼æŒ‡å®š Module + Layer/Runtimeï¼ˆé€‚åˆé«˜çº§ç”¨æ³•ï¼‰
Logix.provide(
  SomeModule,
  SomeModule.live(initial, ...logics) // æˆ–å·²ç»æ„é€ å¥½çš„ ModuleRuntime
)

// 2. ç›´æ¥ä¼  ModuleImplï¼ˆæ¨èï¼‰
const Impl = SomeModule.make({ initial, logics: [...] })
Logix.provide(Impl) // ç­‰ä»·äº provide(Impl.module, Impl.layer)
```

åœ¨ AppConfig ä¸­ï¼Œå¸¸è§å†™æ³•æ˜¯ï¼š

```ts
const CounterImpl = CounterModule.make({ initial, logics: [CounterLogic] })

const app = Logix.app({
  layer: AppInfraLayer,
  modules: [CounterImpl], // ç›´æ¥ä¼  ModuleImpl
  processes: [],
})
```

è¿è¡Œæ—¶ï¼Œè¿™ä¼šè¢«å½’ä¸€åŒ–ä¸ºä¸€ç»„ `AppModuleEntry`ï¼Œå…¶ `layer` ç”± `makeApp` èšåˆåˆ° App çº§ Env ä¸­ã€‚

### 5.3 React é›†æˆï¼š`RuntimeProvider app={...}` + `useModule(Tag)`

åœ¨ React ä¾§ï¼Œå…¸å‹ç”¨æ³•æ˜¯ï¼š

```tsx
const app = Logix.app({
  layer: AppInfraLayer,
  modules: [CounterImpl],
  processes: [],
})

function Root() {
  return (
    <RuntimeProvider app={app}>
      <App />
    </RuntimeProvider>
  )
}

function CounterView() {
  const runtime = useModule(CounterImpl.module) // ModuleInstance / Tag
  const count = useSelector(CounterImpl.module, (s) => s.count)
  const dispatch = useDispatch(runtime)
  // ...
}
```

å½“å‰å®ç°ä¸­ï¼š

- `RuntimeProvider app={app}` ä¼šåœ¨å†…éƒ¨åˆ›å»ºä¸€æ¬¡ `app.makeRuntime()`ï¼Œå¹¶å°†å…¶ä½œä¸ºæ•´ä¸ª React æ ‘çš„ AppRuntimeï¼›  
- `useModule(Tag)` ä½¿ç”¨è¯¥ AppRuntime è¿è¡Œ Tag Effectï¼š  
  - æœ¬è´¨æ˜¯ `ManagedRuntime.runSync(Tag)`ï¼Œä» App çº§ Env ä¸­å–å‡ºå¯¹åº”çš„ `ModuleRuntime` å®ä¾‹ï¼›  
  - æ‰€æœ‰ä½¿ç”¨åŒä¸€ä¸ª Tag çš„ç»„ä»¶å…±äº«è¿™æ£µ ModuleRuntimeï¼ˆã€Œå…¨å±€æ¨¡å—ã€è¯­ä¹‰ï¼‰ã€‚  
- å½“å®¿ä¸»æ˜¾å¼è°ƒç”¨ `AppRuntime.dispose()`ï¼ˆå½“å‰ PoC ä¸­é€šå¸¸åœ¨åº”ç”¨å¸è½½æ—¶å¤„ç†ï¼‰æ—¶ï¼ŒApp Scope è¢«å…³é—­ï¼š  
  - æ‰€æœ‰é€šè¿‡ `modules[].layer` åˆ›å»ºçš„ ModuleRuntime ä¼šç»Ÿä¸€è§¦å‘ `onDestroy`ï¼›  
  - æ‰€æœ‰é€šè¿‡ `processes` å¯åŠ¨çš„åè°ƒå™¨/é•¿æœŸä»»åŠ¡ä¹Ÿä¼šä¸€èµ·ç»ˆæ­¢ã€‚

### 5.4 Global vs Local çš„å¯¹æ¯”è§†è§’

- Global Moduleï¼ˆé€šè¿‡ `Logix.app` æŒ‚è½½ï¼‰ï¼š  
  - ModuleRuntime çš„ Scope æŒ‚åœ¨ AppRuntime æ ¹ Scope ä¸Šï¼›  
  - `useModule(Tag)` åªèƒ½çœ‹åˆ°è¿™æ£µå…¨å±€å®ä¾‹ï¼›  
  - é€‚åˆ Authã€å…¨å±€é…ç½®ã€è·¨é¡µé¢å…±äº«çš„ Domain æ¨¡å—ã€‚

- Local Moduleï¼ˆé€šè¿‡ `ModuleImpl + useModule(Impl)` æŒ‚è½½ï¼‰ï¼š  
  - ModuleRuntime çš„ Scope æŒ‚åœ¨ç»„ä»¶è‡ªå·±çš„å±€éƒ¨ Scope ä¸Šï¼ˆè§ä¸Šä¸€èŠ‚ï¼‰ï¼›  
  - æ¯æ¬¡ `useModule(Impl)` è°ƒç”¨éƒ½ä¼šåˆ›å»ºä¸€æ£µæ–°çš„ ModuleRuntimeï¼Œéšç»„ä»¶å¸è½½é”€æ¯ï¼›  
  - é€‚åˆé¡µé¢/ç»„ä»¶å±€éƒ¨çŠ¶æ€ï¼Œä¸éœ€è¦æ³¨å†Œåˆ° App å±‚ã€‚

è¿™ä¸¤ç§æ¨¡å¼åœ¨å®ç°å±‚å…±ç”¨åŒä¸€å¥— `ModuleRuntime.make` / Layer æœºåˆ¶ï¼Œåªæ˜¯ **Scope çš„æŒ‚è½½ç‚¹ä¸åŒ**ï¼š
- Global Moduleï¼šæŒ‚åœ¨ AppRuntime Scopeï¼›
- Local Moduleï¼šæŒ‚åœ¨ React ç»„ä»¶å±€éƒ¨ Scopeã€‚

## 6. å±€éƒ¨ ModuleImpl + React `useModule` è·¯å¾„ï¼ˆå½“å‰å®ç°ï¼‰

è¿™ä¸€èŠ‚è¯´æ˜ã€Œä¸æ³¨å†Œåˆ° Logix.appï¼Œåªåœ¨å±€éƒ¨ä½¿ç”¨ ModuleImplã€æ—¶ï¼ŒModuleRuntime æ˜¯å¦‚ä½•è¢«ç®¡ç†çš„ã€‚

### 6.1 ä» Module åˆ° ModuleImpl Layer

ä»¥ä¸€ä¸ªç®€å• Module ä¸ºä¾‹ï¼š

```ts
const CounterModule = Logix.Module("LocalCounter", {
  state: Schema.Struct({ count: Schema.Number }),
  actions: {
    increment: Schema.Void,
    decrement: Schema.Void,
  },
})

const CounterLogic = CounterModule.logic(($) =>
  Effect.gen(function* () {
    yield* $.onAction("increment").runFork(
      $.state.mutate((s) => { s.count += 1 }),
    )
    yield* $.onAction("decrement").runFork(
      $.state.mutate((s) => { s.count -= 1 }),
    )
  }),
)

const CounterImpl = CounterModule.make({
  initial: { count: 0 },
  logics: [CounterLogic],
})
```

`Module.make` ä¼šç”Ÿæˆï¼š

- `CounterImpl.module`ï¼šModule Tagï¼ˆ`ModuleInstance<"LocalCounter", Shape>`ï¼‰ï¼Œç”¨äºä» Context ä¸­å–å‡º `ModuleRuntime`ï¼›
- `CounterImpl.layer`ï¼š`Layer.scoped(tag, ModuleRuntime.make(initial, { tag, logics, moduleId }))`ã€‚

å¯ä»¥æŠŠ `Module` / `ModuleImpl` çš„å†…éƒ¨å®ç°ç²—ç•¥æƒ³è±¡æˆè¿™æ ·ï¼ˆæ¦‚å¿µæ€§ä¼ªä»£ç ï¼‰ï¼š

```ts
function Module(id, def) {
  const shape = /* æ ¹æ® def.state / def.actions æ„é€  Shape */

  // 1. ä¸ºè¿™ä¸ª Module å®šä¹‰ä¸€ä¸ª Tagï¼š
  //    - æ—¢æ˜¯ Context.Tagï¼ˆEffect é‡Œçš„â€œé”®â€ï¼‰ï¼›
  //    - ä¹Ÿæ˜¯ ModuleInstance æœ¬èº«ã€‚
  const tag = Context.GenericTag<
    any,
    ModuleRuntime<StateOf<typeof shape>, ActionOf<typeof shape>>
  >(`@logix/Module/${id}`)

  const moduleInstance = Object.assign(tag, {
    _kind: "Module",
    id,
    shape,

    // 2. logicï¼šåœ¨å½“å‰ ModuleRuntime ä¸Šè¿è¡Œçš„ä¸€æ®µç¨‹åºï¼ˆBoundApi å°è£…ç»†èŠ‚ï¼‰
    logic: (build) =>
      Effect.gen(function* () {
        const runtime = yield* tag
        const $ = BoundApi.make(shape, runtime)
        return yield* build($)
      }),

    // 3. liveï¼šç»™å®š initial + logicsï¼Œè¿”å›ä¸€ä¸ªä¼šåœ¨ Scope ä¸ŠæŒ‚è½½ ModuleRuntime çš„ Layer
    live: (initial, ...logics) =>
      Layer.scoped(
        tag,
        ModuleRuntime.make(initial, {
          tag,
          logics,
          moduleId: id,
        }),
      ),

    // 4. makeï¼šåŸºäº live æ„é€  ModuleImplï¼ˆè“å›¾ + Layerï¼‰
    make: (config) => {
      const baseLayer = moduleInstance.live(
        config.initial,
        ...(config.logics ?? []),
      )

      return {
        _tag: "ModuleImpl",
        module: moduleInstance,
        layer: baseLayer,
        // withLayer/withLayers åªæ˜¯å¯¹ layer çš„è¿›ä¸€æ­¥åŒ…è£…ï¼Œè¿™é‡Œç•¥ã€‚
      } satisfies ModuleImpl<any, any, any>
    },
  })

  return moduleInstance
}
```

ä»è¿™ä¸ªè§’åº¦çœ‹ï¼Œ`.module` å’Œ `.layer` æ˜¯å¦‚ä½•å…³è”èµ·æ¥çš„å°±å¾ˆæ¸…æ¥šäº†ï¼š

- `.module`ï¼šå°±æ˜¯é‚£ä¸ª Context.Tagï¼Œæœ¬èº«ä¹Ÿæ˜¯ ModuleInstanceï¼›  
- `.layer`ï¼šå†…éƒ¨ä½¿ç”¨ `.module` ä½œä¸º Tagï¼ŒæŠŠ `ModuleRuntime.make(...)` çš„ç»“æœæŒ‚åˆ°æŸä¸ª Scope çš„ Context ä¸Šï¼›  
- å½“ä½ è°ƒç”¨ `Layer.buildWithScope(Impl.layer, scope)` æ—¶ï¼ŒTag å’Œ runtime çš„æ˜ å°„æ‰çœŸæ­£å†™å…¥äº† Envï¼›  
- éšå `Context.get(env, Impl.module)` åªæ˜¯åˆ©ç”¨è¿™æ¡æ˜ å°„æŠŠ runtime è¯»å‡ºæ¥ã€‚

åªè¦åœ¨æŸä¸ª Scope å†…æ‰§è¡Œï¼š

```ts
const env = yield* Layer.buildWithScope(CounterImpl.layer, scope)
const runtime = Context.get(env, CounterImpl.module) // ModuleRuntime
```

å°±ä¼šåœ¨ `scope` ä¸‹ï¼š

- åˆ›å»ºä¸€æ£µ `ModuleRuntime` å®ä¾‹ï¼›
- æŠŠå®ƒæ³¨å†Œåˆ° Contextï¼ˆTagï¼‰é‡Œï¼›
- æŒ‰ `logics` å¯åŠ¨æ‰€æœ‰ watcherï¼ˆ`run*` / `runFork` ç­‰ï¼‰ã€‚

### 6.2 React å±€éƒ¨æ¨¡å¼ï¼š`useModule(Impl)` å¦‚ä½•æ‰˜ç®¡ Scope

åœ¨ React é›†æˆå±‚ï¼Œ`useModule` å¯¹ ModuleImpl çš„é‡è½½å½¢æ€æ˜¯ï¼š

```ts
// @logix/react
useModule(handle: ModuleImpl): ModuleRuntime
```

å†…éƒ¨å®ç°ç®€åŒ–åç›¸å½“äºï¼š

```ts
function useModule(impl: ModuleImpl) {
  return useLocalModule(
    () =>
      Effect.gen(function* () {
        const scope = yield* Scope.make()
        const env = yield* Layer.buildWithScope(impl.layer, scope)
        const runtime = Context.get(env, impl.module)
        // æ³¨æ„ï¼šscope çš„å…³é—­ç”± useLocalModule ç»Ÿä¸€æ‰˜ç®¡
        return runtime
      }),
    [impl],
  )
}
```

è€Œ `useLocalModule(factory, deps)` çš„èŒè´£æ˜¯ï¼š

1. é€šè¿‡ `useRuntime()` æ‹¿åˆ°å½“å‰ App/é¡µé¢çº§ `ManagedRuntime`ï¼ˆ`RuntimeProvider` æä¾›ï¼‰ï¼›  
2. åœ¨ `useMemo` é‡Œï¼š
   - `const scope = runtime.runSync(Scope.make())` åˆ›å»ºä¸€ä¸ªå±€éƒ¨ Scopeï¼›
   - `const moduleRuntime = runtime.runSync(factory(scope))` æ„é€  ModuleRuntimeï¼ˆ`Layer.buildWithScope + Context.get`ï¼‰ï¼›
   - è¿”å› `{ scope, moduleRuntime }`ï¼›
3. åœ¨ `useEffect` cleanup é‡Œï¼š
   - ç»„ä»¶å¸è½½æˆ– `deps` å˜æ›´æ—¶ï¼Œè°ƒç”¨ `runtime.runFork(Scope.close(scope, Exit.void))`ï¼›
   - è§¦å‘è¯¥ Scope ä¸‹çš„ `ModuleRuntime` finalizer å’Œæ‰€æœ‰ `forkScoped` watcher çš„ä¸­æ–­ã€‚

**è¿™å°±å½¢æˆäº†ä¸€ä¸ªæ¸…æ™°çš„ç”Ÿå‘½å‘¨æœŸé“¾æ¡ï¼š**

- æ¯æ¬¡ `useModule(Impl)` è°ƒç”¨éƒ½ä¼šåˆ›å»ºä¸€æ£µç‹¬ç«‹çš„ `Scope + ModuleRuntime` å®ä¾‹ï¼ŒæŒ‚åœ¨å½“å‰ React ç»„ä»¶ä¹‹ä¸‹ï¼›
- å½“ç»„ä»¶å¸è½½æ—¶ï¼Œé€šè¿‡ `Scope.close` ç»Ÿä¸€é”€æ¯è¿™æ£µ Scopeï¼ŒåŒ…æ‹¬ï¼š  
  - `ModuleRuntime` è‡ªèº«ï¼ˆ`module:destroy` + `lifecycle.onDestroy`ï¼‰ï¼›  
  - æ‰€æœ‰ `runFork` / `runParallelFork` ç­‰æŒ‚å‡ºçš„ watcher Fiberã€‚

### 6.3 ä¸ Logix.app çš„å…³ç³»

- **å±€éƒ¨ ModuleImpl æ¨¡å¼**ï¼š  
  - å®Œå…¨ä¸éœ€è¦å°† ModuleImpl æ³¨å†Œåˆ° `Logix.app({ modules })`ï¼›  
  - çŠ¶æ€éšç»„ä»¶ç”Ÿå‘½å‘¨æœŸåˆ›å»º/é”€æ¯ï¼Œéå¸¸é€‚åˆ B ç«¯ã€Œæ¯é¡µä¸€ä¸ªå±€éƒ¨æ¨¡å—ã€çš„åœºæ™¯ã€‚

- **å…¨å±€ Module æ¨¡å¼**ï¼š  
  - ModuleImpl å¯ä»¥ä½œä¸º `Logix.app` çš„æ¨¡å—æ¡ç›®ï¼š`modules: [CounterImpl]`ï¼›  
  - æ­¤æ—¶ ModuleRuntime çš„ Scope æŒ‚åœ¨ AppRuntime ä¸Šï¼Œ`useModule(Tag)` åªèƒ½è¯»å–è¿™æ£µâ€œå…¨å±€å®ä¾‹â€ï¼Œä¸å†ç”± `useLocalModule` é¢å¤–åˆ›å»º Scopeã€‚

è¿™ä¸¤æ¡è·¯å¾„åœ¨å®ç°å±‚å®Œå…¨å…±å­˜ï¼š  
æ ¸å¿ƒåŒºåˆ«åªæ˜¯ **Scope çš„æŒ‚è½½ç‚¹**â€”â€”å±€éƒ¨ ModuleImpl æŒ‚åœ¨ç»„ä»¶è‡ªå·±çš„ Scope ä¸Šï¼Œå…¨å±€ Module æŒ‚åœ¨ AppRuntime çš„æ ¹ Scope ä¸Šã€‚

## 7. æ€»ç»“

é€šè¿‡ **Safe Wrapper**ã€**Status Pattern** å’Œ **Strict Scope Management**ï¼Œv3 è¿è¡Œæ—¶å¯ä»¥ä¿è¯ï¼š
1. `onInit/onDestroy` é‡Œçš„é”™è¯¯æ°¸è¿œä¸ä¼šç‚¸æ‰ Scopeï¼›
2. React ç»„ä»¶çš„é¢‘ç¹æŒ‚è½½/å¸è½½ä¸ä¼šå¯¼è‡´èµ„æºæ³„æ¼ï¼›
3. å¼€å‘ä½“éªŒï¼ˆStrict Modeï¼‰ä¸ç”Ÿäº§è¡Œä¸ºä¸€è‡´ä¸”å®‰å…¨ã€‚
</file>

<file path="runtime-logix/impl/package-structure.md">
# Logix v3.0 Package Structure

This document defines the physical file structure for the Logix v3 implementation.

## 1. packages/logix-core

The platform-agnostic core engine. Zero dependencies on React or DOM.

```
packages/logix-core/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                # Public API Barrel (Logix.*, Logic.*)
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                    # Public API Definitions
â”‚   â”‚   â”œâ”€â”€ Logix.ts            # Logix Namespace (Module, app, provide)
â”‚   â”‚   â”œâ”€â”€ Logic.ts            # Logic Namespace (Of, Env)
â”‚   â”‚   â””â”€â”€ BoundApi.ts         # The `$` Interface Definition
â”‚   â”‚
â”‚   â”œâ”€â”€ dsl/                    # Fluent DSL Implementation
â”‚   â”‚   â”œâ”€â”€ LogicBuilder.ts     # Implementation of Module.logic(...)
â”‚   â”‚   â”œâ”€â”€ FlowBuilder.ts      # Implementation of $.onAction(...).then(...)
â”‚   â”‚   â””â”€â”€ MatchBuilder.ts     # Implementation of $.match(...)
â”‚   â”‚
â”‚   â”œâ”€â”€ runtime/                # Runtime Execution Engine
â”‚   â”‚   â”œâ”€â”€ AppRuntime.ts       # Logix.app() -> Runtime Instance
â”‚   â”‚   â”œâ”€â”€ ModuleRuntime.ts    # Logix.Module() -> Runtime Instance
â”‚   â”‚   â”œâ”€â”€ ScopeManager.ts     # Effect Scope & Lifecycle Management
â”‚   â”‚   â””â”€â”€ Registry.ts         # Global Module Registry
â”‚   â”‚
â”‚   â”œâ”€â”€ platform/               # Platform Abstraction Layer
â”‚   â”‚   â”œâ”€â”€ Platform.ts         # Platform Interface & Tag
â”‚   â”‚   â””â”€â”€ NoopPlatform.ts     # Default "No-op" implementation (Core only ships this)
â”‚   â”‚
â”‚   â””â”€â”€ internal/               # Internal Utilities (Not Exported)
â”‚       â”œâ”€â”€ errors.ts           # Error Types
â”‚       â””â”€â”€ utils.ts            # Common Helpers
â”‚
â”œâ”€â”€ test/                       # Unit Tests
â”‚   â”œâ”€â”€ dsl/                    # Implementation of Flow.Api / BoundApi.flow
â”‚   â”œâ”€â”€ runtime/
â”‚   â””â”€â”€ scenarios/              # Integration Scenarios
â”‚
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ tsup.config.ts      # Build Configuration
```

## 2. packages/logix-react

The React adapter. Depends on `logix-core` and `react`.

```
packages/logix-react/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                # Public Exports (hooks, provider)
â”‚   â”‚
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ RuntimeProvider.tsx # <RuntimeProvider value={app}>
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useModule.ts        # Main hook: const { state, actions } = useModule(Tag)
â”‚   â”‚   â”œâ”€â”€ useLocalModule.ts   # Local hook: useLocalModule(() => Logix.Module(...))
â”‚   â”‚   â”œâ”€â”€ useSelector.ts      # Fine-grained selection
â”‚   â”‚   â””â”€â”€ useDispatch.ts      # Action dispatch only
â”‚   â”‚
â”‚   â”œâ”€â”€ platform/
â”‚   â”‚   â””â”€â”€ ReactPlatform.ts    # React Implementation of Platform Interface
â”‚   â”‚                           # (Implements onSuspend, onResume via React APIs)
â”‚   â”‚
â”‚   â””â”€â”€ internal/
â”‚       â””â”€â”€ ReactContext.ts     # React.createContext() definition
â”‚
â”œâ”€â”€ test/
â”‚   â””â”€â”€ hooks/                  # React Hook Testing Library tests
â”‚
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ tsup.config.ts      # Build Configuration
```

## 3. packages/logix-test

The testing utilities package. Depends on `logix-core` and `effect`.

```
packages/logix-test/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                # Public API
â”‚   â”œâ”€â”€ runtime/                # TestRuntime
â”‚   â”œâ”€â”€ api/                    # renderLogic, Scenario
â”‚   â””â”€â”€ utils/                  # Matchers
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ tsup.config.ts
```

## 4. Key Implementation Details

- **Build Toolchain**: Use `tsup` for bundling.
  - Output formats: `esm` (default), `cjs` (for legacy compat).
  - Dts: Enabled (`dts: true`) to generate type definitions.
  - Clean: Enabled (`clean: true`).
- **Circular Dependenciesï¼ˆç›®æ ‡çŠ¶æ€ï¼‰**ï¼š
  - **ç›®æ ‡**ï¼š`api/` åªå®šä¹‰ç±»å‹å’Œè–„å·¥å‚æ¥å£ï¼Œä¸ç›´æ¥ä¾èµ–å…·ä½“å®ç°ï¼ˆ`dsl/` æˆ– `runtime/`ï¼‰ï¼›
  - `dsl/` å’Œ `runtime/` ä¾èµ– `api/`ï¼›
  - `dsl/` å’Œ `runtime/` ä¹‹é—´å¯ä»¥äº’ç›¸åä½œï¼Œä½† `api/` ä¿æŒå°½å¯èƒ½â€œæ— å®ç°ä¾èµ–â€çš„å¥‘çº¦è§’è‰²ã€‚
  - **å½“å‰ PoC ç°çŠ¶**ï¼šv3 PoC é˜¶æ®µï¼Œå‡ºäºå®ç°ç®€å•æ€§ï¼Œ`api/` ä¸­çš„éƒ¨åˆ†å…¥å£ï¼ˆä¾‹å¦‚ `Logix.Module` / `Logix.app` / Bound API `$` å·¥å‚ï¼‰ç›´æ¥å¼•ç”¨äº† `runtime/` ä¸ `dsl/`ã€‚è¿™åœ¨çŸ­æœŸå†…æ˜¯è¢«å…è®¸çš„å·¥ç¨‹æŠ˜ä¸­ï¼Œåç»­åœ¨éœ€è¦ DevTools / å¤š Runtime é€‚é…æ—¶ï¼Œå†åˆ†é˜¶æ®µä¸‹æ²‰å®ç°ä»£ç åˆ° `runtime/` / `dsl/` å¹¶æ¢å¤â€œçº¯å¥‘çº¦â€å½¢æ€ã€‚
- **Barrel Files**: Each directory (`api`, `dsl`, `runtime`) should have an `index.ts` to control visibility.
- **Effect Integration**: All `runtime/` code is heavily Effect-native. `dsl/` code constructs Effect descriptions but doesn't run them.

## 5. Dependency Graph

```mermaid
graph TD
    subgraph "packages/logix-core"
        API[api/ (Types & Interfaces)]
        DSL[dsl/ (Builders)]
        Runtime[runtime/ (Execution)]
        Platform[platform/ (Interface)]

        DSL --> API
        Runtime --> API
        Runtime --> Platform
        DSL -.-> Runtime
    end

    subgraph "packages/logix-react"
        ReactHooks[hooks/]
        ReactPlatform[platform/ (React Impl)]

        ReactHooks --> API
        ReactPlatform --> Platform
        ReactHooks --> Runtime
    end
```

## 6. Package Scope (v3.0 vs Future)

| Package | Status | Description |
| :--- | :--- | :--- |
| `logix-core` | **v3.0** | The pure logic engine. Includes `NoopPlatform` only. |
| `logix-react` | **v3.0** | React adapter. Includes `ReactPlatform`. |
| `logix-test` | **Planned** | Testing utilities for Unit/Integration tests. |
| `logix-node` | *Future* | Node.js adapter (CLI/Server). |
| `logix-devtools` | *Future* | Chrome Extension bridge & UI. |
</file>

<file path="runtime-logix/impl/README.md">
# runtime-logix Â· å®ç°å¤‡å¿˜å½• (Implementation Notes)

> **Status**: Draft (v3 Final Â· Implementation Planning)
> **Scope**: è¿è¡Œæ—¶å®ç°å±‚çš„è¡¥å……è¯´æ˜ä¸æŠ€æœ¯å¤‡å¿˜ï¼Œä¸ä½œä¸ºå¯¹å¤– API å¥‘çº¦ï¼Œä»…æœåŠ¡äºåç»­è½åœ°ä¸æ¼”è¿›ã€‚

æœ¬ç›®å½•ç”¨äºæ²‰æ·€ **Logix Engine è¿è¡Œæ—¶ä¾§** çš„å®ç°ç»†èŠ‚ã€æŠ€æœ¯å†³ç­–ä¸æ½œåœ¨é£é™©åˆ†æã€‚
æ ¸å¿ƒç›®æ ‡ï¼š

- æŠŠã€Œæ¶æ„è§„èŒƒã€èƒŒåçš„ **å…·ä½“å®ç°æ€è·¯** å†™æ¸…æ¥šï¼Œé¿å…åç»­å¼€å‘æ—¶å„è‡ªæ£æµ‹å¯¼è‡´è·‘åï¼›
- åœ¨è¿›å…¥å®ç°é˜¶æ®µå‰ï¼Œæå‰æš´éœ²ã€Œéš¾ç‚¹ / éšæ‚£ / å–èˆã€ï¼Œå½¢æˆå¯å®¡é˜…çš„æŠ€æœ¯å†³ç­–è®°å½•ï¼›
- ä¸ºæœªæ¥ v4 ç­‰ç‰ˆæœ¬çš„æ¼”è¿›é¢„ç•™ç©ºé—´ï¼ˆå¦‚ Env å¼ºéš”ç¦»ã€Lazy æ¨¡å—åŠ è½½ç­‰ï¼‰ï¼Œä½†ä¸ç»‘æ­»å½“å‰å®ç°ã€‚

## ä½¿ç”¨æ–¹å¼

- å½“æˆ‘ä»¬åœ¨è®¨è®º **App/Module/Store æ¨¡å—ä½“ç³»ã€Logic Middlewareã€Store ç”Ÿå‘½å‘¨æœŸã€è°ƒè¯•/è¯Šæ–­æœºåˆ¶** ç­‰ã€Œæ¶æ„çº§ã€èƒ½åŠ›æ—¶ï¼Œ**åŠ¡å¿…åŒæ­¥åœ¨æœ¬ç›®å½•ä¸‹è¡¥ä¸€ä»½å®ç°å¤‡å¿˜**ï¼š
  - æè¿°é¢„æœŸçš„ Effect/Layer/Scope ç»„åˆæ–¹å¼ï¼›
  - æ ‡å‡ºå¯èƒ½çš„å‘ï¼ˆæ€§èƒ½ã€å¯è§‚æµ‹æ€§ã€é”™è¯¯è¯­ä¹‰ã€ä¸å¹³å°è§£æçš„è€¦åˆç‚¹ç­‰ï¼‰ï¼›
  - è‹¥æœ‰å¤šç§å®ç°è·¯å¾„ï¼Œæ˜ç¡®å½“å‰â€œé¦–é€‰æ–¹æ¡ˆâ€ä¸å¤‡é€‰æ–¹æ¡ˆã€‚
- æœ¬ç›®å½•ä¸­çš„æ–‡æ¡£å¯ä»¥æ¯” core/ ä¸‹çš„è§„èŒƒ **æ›´ç»†ã€æ›´åå·¥ç¨‹å®ç°**ï¼Œä½†ä¸€æ—¦å‘ç°ä¸æ ¸å¿ƒè§„èŒƒå†²çªï¼Œåº”å…ˆä¿® core/ è§„èŒƒï¼Œå†ä¿®è¿™é‡Œã€‚

## è§„åˆ’ä¸­çš„å­æ–‡æ¡£

å»ºè®®æŒ‰èƒ½åŠ›é¢†åŸŸæ‹†åˆ†å®ç°å¤‡å¿˜ï¼š

- `app-runtime-and-modules.md`
  è®°å½• `Logix.app` / `Logix.module` / `ModuleDef` çš„ flatten è§„åˆ™ã€`imports/providers/processes/exports` çš„å±•å¼€é¡ºåºï¼Œä»¥åŠ v3 ä½¿ç”¨ Env æ‰å¹³åˆå¹¶çš„å…·ä½“å®ç°æ–¹æ¡ˆï¼›åˆ†ææœªæ¥ Env è£å‰ª / Lazy æ¨¡å—åŠ è½½çš„å¯èƒ½è·¯å¾„ä¸é£é™©ã€‚

- `logic-middleware-and-aop.md`
  è®°å½• Logic Middleware (`Logic.Meta` / `Middleware` / ç»„åˆä¸æ³¨å…¥æ–¹å¼) çš„å®ç°è‰å›¾ï¼šå¦‚ä½•åœ¨ Logic æ„é€ å‘¨æœŸå†…æŒ‚è½½ Module/App çº§ `middlewares`ï¼Œå¦‚ä½•ä¿è¯ A/E/R æ³›å‹ä¸è¢«ç ´åï¼Œä»¥åŠå¹³å°å¦‚ä½•å¯é è¯†åˆ«å¯è§£æå­é›†ã€‚

- `module-lifecycle-and-scope.md`
  è®°å½• Store ç”Ÿå‘½å‘¨æœŸé’©å­ (`lifecycle.onInit/onDestroy`) ä¸ Effect Scope çš„ç»‘å®šå…³ç³»ï¼šLocal Store vs Global Store çš„ Scope ç®¡ç†ã€finalizer çš„æ³¨å†Œæ—¶æœºä¸é”™è¯¯å¤„ç†ç­–ç•¥ã€‚

> æ³¨ï¼šä»¥ä¸Šæ–‡ä»¶åä»…ä¸ºå»ºè®®ï¼Œå¯æ ¹æ®å®é™…å®ç°æ‹†åˆ†/åˆå¹¶ã€‚å…³é”®æ˜¯åšåˆ°ï¼š**æ¯ä¸€å—å¤æ‚èƒ½åŠ›ï¼Œåœ¨è§„èŒƒç¡®å®šåï¼Œéƒ½æœ‰ä¸€ä»½å¯¹åº”çš„å®ç°è¯´æ˜æ–‡æ¡£å¯æŸ¥**ã€‚

## Universal Bound API / Module çš„å®ç°ç¡¬çº¦æŸï¼ˆv3 Finalï¼‰

ä»¥ä¸‹å†…å®¹æ˜¯å¯¹ `core/02-module-and-logic-api.md` ä¸ `core/03-logic-and-flow.md` ä¸­æœ€ç»ˆæ¶æ„çš„ **å®ç°ä¾§è¡¥å……**ï¼Œä¸€æ—¦å¼€å§‹å†™è¿è¡Œæ—¶ä»£ç ï¼Œåº”è§†ä¸ºç¡¬æ€§çº¦æŸï¼š

1. **Module å½¢æ€ä¸å“ç‰ŒåŒ–**
   - `Logix.Module` å¿…é¡»æ˜¯ä¸€ä¸ªã€Œç±»å‹ + Tag + Factoryã€çš„ç»Ÿä¸€æŠ½è±¡ï¼š
     - æä¾› Module Idï¼ˆå­—ç¬¦ä¸²ï¼‰ã€State/Action Schemaã€Shape ç±»å‹ï¼›
     - æš´éœ²ä¸€ä¸ªå¯æ³¨å…¥ Env çš„ `.logic(($) => Effect)` å·¥å‚ï¼›
     - åŒæ—¶å……å½“ `Context.Tag`ï¼Œç”¨äº Env/Layer æä¾›å’Œ `$.use` çš„å‚æ•°ã€‚
   - å»ºè®®åœ¨ç±»å‹å±‚ä¸º Module åŠ å“ç‰Œæ ‡è®°ï¼Œä¾‹å¦‚ï¼š
     - `interface ModuleMarker<Shape> { readonly _kind: "Module"; readonly _shape: Shape }`ï¼›
     - `Logix.Module(...)` è¿”å›çš„å¯¹è±¡éœ€å®ç°è¯¥æ¥å£ï¼ˆæ—¢æ˜¯ Tagï¼Œåˆæºå¸¦ Shape ä¿¡æ¯ä¸å·¥å‚èƒ½åŠ›ï¼‰ã€‚
   - `$.use` çš„å®ç° **åªèƒ½** è¯†åˆ«ä¸¤ç±»å‚æ•°ï¼šå®ç°äº† ModuleMarker çš„ Module å®šä¹‰ï¼Œä»¥åŠæ™®é€š Service Tagï¼›ä¸å¾—æ¥å—æ‰‹å†™ `Context.GenericTag` ä½œä¸º Moduleã€‚

2. **StoreHandle ä¸ Runtime çš„è§£è€¦**
   - å¯¹å¤–æš´éœ²çš„ StoreHandle ç±»å‹å¿…é¡»æ˜¯ Runtime çš„ã€Œåªè¯»æŠ•å½±ã€ï¼Œèƒ½åŠ›å›ºå®šä¸ºï¼š
     - `read(selector?)`ï¼šä»å½“å‰ State æ‹¿åˆ°ä¸€ä¸ªå¿«ç…§å€¼ï¼ˆé Streamï¼‰ï¼›
     - `changes(selector)`ï¼šè¿”å›å¯¹åº” selector çš„ `Stream`ï¼›
     - `dispatch(action)`ï¼šå‘è¯¥ Store æ´¾å‘ Actionã€‚
   - StoreHandle **ä¸å¾—** ç›´æ¥æš´éœ² `mutate` / `update` æˆ–ä»»ä½•å¯ä»¥è·¨ Store å†™å…¥ State çš„æ–¹æ³•ï¼›
   - å†…éƒ¨å®ç°å¯ä»¥é€šè¿‡å°è£…åº•å±‚è¿è¡Œæ—¶å®¹å™¨ï¼Œä½†ç±»å‹ä¸Šè¦ç¡®ä¿æœªæ¥æ–°å¢ Runtime èƒ½åŠ›ä¸ä¼šè‡ªåŠ¨â€œæ¸—é€â€åˆ° Handle æ¥å£ã€‚

3. **`$.use` çš„è¿è¡Œæ—¶è¯­ä¹‰**
   - `$.use(Module)`ï¼š
     - åœ¨ç±»å‹ä¸Šè¿”å› StoreHandle<Shape>ï¼ˆå³æŸä¸ª ModuleRuntime çš„åªè¯»è§†å›¾ï¼‰ï¼›
     - åœ¨è¿è¡Œæ—¶ï¼Œé€šè¿‡å½“å‰ Logic Env ä¸­çš„ `Logix.ModuleTag` æˆ–å…¶ä»–æ³¨å†Œè¡¨æŸ¥æ‰¾å¯¹åº” Runtimeï¼Œå†åŒ…è£…æˆ Handleï¼›
     - éœ€è¦ä¿è¯åœ¨æœªæä¾›å¯¹åº” ModuleRuntime æ—¶ç»™å‡º**æ˜¾å¼é”™è¯¯**ï¼ˆè€Œä¸æ˜¯é™é»˜è¿”å› dummyï¼‰ã€‚
   - `$.use(ServiceTag)`ï¼š
     - åªæ˜¯ `Effect.service(tag)` çš„è¯­æ³•ç³–ï¼›
     - å»ºè®®åœ¨å®ç°ä¸Šä»é€šè¿‡ Tag æœºåˆ¶è·å–ä¾èµ–ï¼Œä»¥é¿å…å‡ºç°â€œæ—è·¯æ³¨å…¥â€ã€‚

4. **Fluent DSLï¼ˆ`$.onState` / `$.onAction` / `$.on`ï¼‰ä¸ Flow çš„ç¿»è¯‘å…³ç³»**
   - æ‰€æœ‰ Fluent API å¿…é¡»åœ¨è¿è¡Œæ—¶è¢«æœºæ¢°åœ°ç¿»è¯‘ä¸ºå·²æœ‰ `Flow.Api` ç»„åˆï¼Œè€Œä¸æ˜¯å¼•å…¥ç¬¬äºŒå¥—æ‰§è¡Œè¯­ä¹‰ï¼š
     - `$.onState(selector)` â†’ `$.flow.fromState(selector)`ï¼›
     - `$.onAction(predicate)` â†’ `$.flow.fromAction(predicate)`ï¼›
     - `$.on(stream)` â†’ åŸæ ·ä½¿ç”¨ä¼ å…¥çš„ Streamï¼›
     - `update/mutate/run*(effect)` â†’ ç­‰ä»·äº `source.pipe(...ops, $.flow.run* (effect))`ã€‚
   - å¹¶å‘ç­–ç•¥æ˜ å°„è¡¨åº”åœ¨å®ç°ä¸­å›ºå®šä¸‹æ¥ï¼Œä¾‹å¦‚ï¼š
     - `mode: "parallel"` â†’ `runParallel`ï¼›
     - `"latest"` â†’ `runLatest`ï¼›
     - `"exhaust"` â†’ `runExhaust`ï¼›
     - `"sequence"` â†’ `run`ï¼ˆé˜Ÿåˆ—è¯­ä¹‰ä¸é»˜è®¤ `run` ä¸€è‡´ï¼‰ã€‚
   - ä»»ä½•æ–°å¢ Fluent APIï¼ˆä¾‹å¦‚ `whenEffect` æˆ– `whenInterval`ï¼‰éƒ½å¿…é¡»ä»¥åŒæ ·çš„æ–¹å¼å¯é€†æ˜ å°„åˆ° Flow/Effect åŸè¯­ã€‚

5. **ç™½ç›’/é»‘ç›’è¾¹ç•Œåœ¨ runtime å±‚çš„é…åˆ**
   - å³ä¾¿ Parser åªå¯¹ç™½ç›’ Fluent é“¾ç»™å‡ºç»“æ„åŒ–è¯­ä¹‰ï¼Œruntime å®ç°ä¹Ÿåº”ä¿è¯ï¼š
     - Fluent ä¸é Fluent è·¯å¾„åœ¨é”™è¯¯è¯­ä¹‰ä¸èµ„æºç®¡ç†ä¸Šå®Œå…¨ä¸€è‡´ï¼ˆåŒæ ·çš„ Scope / åŒæ ·çš„å–æ¶ˆè¡Œä¸ºï¼‰ï¼›
     - Raw Modeï¼ˆç›´æ¥ä½¿ç”¨ `Flow.*` æˆ– `Stream.pipe`ï¼‰ä¸ä¼šç»•å¼€å¹¶å‘æ§åˆ¶ / Lifecycle çº¦æŸã€‚
   - å»ºè®®åœ¨å®ç°ä¸­ä¸º Fluent è·¯å¾„ç•™å‡º Hookï¼ˆä¾‹å¦‚è®°å½•é“¾è·¯å…ƒä¿¡æ¯ï¼‰ï¼Œä¾¿äºåç»­åœ¨è°ƒè¯•/è¿½è¸ªè§†å›¾ä¸­å±•ç¤ºæ›´å‹å¥½çš„ä¿¡æ¯ã€‚

6. **å¤šå®ä¾‹ Module ä¸ Runtime çš„å…³ç³»ï¼ˆç•™ç™½ä½†éœ€è®°å½•ï¼‰**
   - ç›®å‰æ–‡æ¡£é»˜è®¤â€œä¸€ç±» Module å®šä¹‰å¯¹åº”ä¸€ç±»é¢†åŸŸæ¨¡å—çš„ Runtime å®ä¾‹â€ï¼Œä½†å®é™…å®ç°å¯èƒ½éœ€è¦æ”¯æŒå¤šå®ä¾‹ï¼ˆä¾‹å¦‚å¤š Tab Cartï¼‰ï¼›
   - å»ºè®®åœ¨å®ç°è®¾è®¡ä¸­é¢„ç•™ï¼š
     - Module ä½œä¸ºã€Œç±»å‹ä¸ Factoryã€ï¼›
     - å®é™…å®ä¾‹æ ‡è¯†ï¼ˆå¦‚ key / scopeIdï¼‰ç”±ä¸Šå±‚ Runtime æˆ– React Adapter ç®¡ç†ã€‚
   - ä¸€æ—¦ç¡®å®šå¤šå®ä¾‹æ–¹æ¡ˆï¼Œåº”åœ¨æœ¬ç›®å½•å•ç‹¬è¡¥ä¸€ä»½ `module-and-multi-instance.md`ï¼Œå¹¶åŒæ­¥æ›´æ–° `core/02-module-and-logic-api.md`ã€‚

ä»¥ä¸Šæ¡ç›®å¦‚æœåœ¨å®ç°ä¸­å‡ºç°åå·®ï¼ˆä¾‹å¦‚ `$.use` æ”¯æŒç¬¬ä¸‰ç±» Tagã€StoreHandle æ–°å¢å†™æ¥å£ï¼‰ï¼Œ**å¿…é¡»ä¼˜å…ˆå›åˆ°æœ¬æ–‡ä»¶ä¸ core è§„èŒƒä¸­è¿›è¡Œè®¨è®ºä¸ä¿®è®¢**ï¼Œå†è¿›å…¥ä»£ç å˜æ›´ã€‚è¿™æ ·å¯ä»¥ä¿è¯ v3 çš„å®é™…è¿è¡Œæ—¶ä»£ç å§‹ç»ˆå›´ç»•ã€ŒContext is World + Universal $ã€çš„åˆè¡·æ¼”è¿›ã€‚

---

## ModuleImpl / withLayer / Logix.provide(ModuleImpl) çš„å®ç°è¦ç‚¹

> å¯¹åº”è§„èŒƒï¼š`core/02-module-and-logic-api.md` ä¸­çš„ ModuleImpl è“å›¾èƒ½åŠ›ã€‚

åœ¨å®ç°å±‚ï¼ŒModuleImpl ç›¸å…³èƒ½åŠ›çš„ç¡¬çº¦æŸä¸å½“å‰åšæ³•ï¼š

1. **Module.make â†’ ModuleImpl çš„æ„é€ è·¯å¾„**
   - `Logix.Module(id, def)` åœ¨å†…éƒ¨å§”æ‰˜ç»™ `ModuleFactory.Module` åˆ›å»ºï¼š
     - å…ˆæ ¹æ® Schema æ¨å¯¼å‡º `ModuleShape`ï¼›
     - å®šä¹‰ `ModuleInstance.logic`ï¼šä»å½“å‰ `Context` ä¸­å–å‡º ModuleRuntimeï¼Œå¹¶åŸºäºå®ƒæ„é€  Bound API `$`ï¼›
     - å®šä¹‰ `ModuleInstance.live(initial, ...logics)`ï¼šè°ƒç”¨ `ModuleRuntime.make(initial, { tag, logics, moduleId })`ï¼ŒæŒ‚è½½æ‰€æœ‰ Logicã€‚
   - `ModuleInstance.make({ initial, logics })` åˆ™åœ¨ `live` ä¹‹ä¸Šï¼Œç”Ÿæˆä¸€ä¸ªï¼š
     - `module`: åŸå§‹ `ModuleInstance`ï¼›
     - `layer`: ç¬¬ä¸€ç‰ˆ `Layer<ModuleRuntime, never, any>`ï¼›
     - `withLayer` / `withLayers`ï¼šç”¨äºåœ¨è¯¥ Layer ä¸Šå åŠ é¢å¤– Env çš„è½»é‡å·¥å‚ã€‚

2. **ModuleRuntime.make ä¸ Logic Env**
   - `ModuleRuntime.make<S, A, R>(initial, { tag, logics, moduleId })` çš„ç­¾åçº¦å®šï¼š
     - è¿”å›ï¼š`Effect<ModuleRuntime<S, A>, never, Scope.Scope | R>`ï¼›
     - å…¶ä¸­ `R` è¡¨ç¤º Logic é¢å¤–ä¾èµ–çš„ Envï¼ˆæœåŠ¡ã€å¹³å°èƒ½åŠ›ç­‰ï¼‰ï¼Œä¸æ··å…¥ `unknown`ï¼›
     - é€šè¿‡ `Effect.provideService(logic, tag, runtime)` + `LifecycleContext` æŠŠ Runtime ä¸ç”Ÿå‘½å‘¨æœŸèƒ½åŠ›æ³¨å…¥åˆ°æ¯ä¸ª Logicï¼›
     - é€»è¾‘ Fiber è¿è¡Œæ—¶çš„ Env = `Scope.Scope + R + ModuleRuntimeTag + LifecycleContext`ã€‚
   - è¿™ä¿è¯äº†ï¼š
     - ä»ç±»å‹ä¸Šå¯ä»¥æ¨å¯¼å‡º Logic ä¾èµ–çš„ Envï¼›
     - è¿è¡Œæ—¶åªéœ€å…³æ³¨ Scope ä¸ ModuleRuntimeï¼ŒEnv ç”±å¤–éƒ¨ Layer æ³¨å…¥ã€‚

3. **ModuleImpl.withLayer / withLayers çš„ Env æ³¨å…¥è¯­ä¹‰**
   - ç›®æ ‡ï¼šåœ¨ä¸ç ´å ModuleRuntime æ„é€ æ–¹å¼çš„å‰æä¸‹ï¼Œä¸ºç‰¹å®š ModuleImpl æ³¨å…¥å±€éƒ¨ Envï¼ˆService / å¹³å°ï¼‰ï¼Œå¹¶å¯¹ Logic ç”Ÿæ•ˆã€‚
   - å½“å‰å®ç°çš„ç­–ç•¥ï¼ˆè§ `runtime/ModuleFactory.ts`ï¼‰ï¼š
     - `makeImplWithLayer(layer)` æŒæœ‰å½“å‰â€œå·²æ³¨å…¥ Envâ€çš„ ModuleRuntime Layerï¼›
     - `withLayer(extra)`ï¼š
       - å…ˆå¯¹ `layer` è¿›è¡Œä¸€æ¬¡ `Layer.provide(extra)`ï¼ŒæŠŠ `extra` ä¸­çš„æœåŠ¡å–‚ç»™ ModuleRuntime æ„é€ é€»è¾‘ï¼ˆè®© Logic å†…çš„ `yield* ServiceTag` èƒ½æ‹¿åˆ°å®ç°ï¼‰ï¼›
       - å†ç”¨ `Layer.mergeAll(provided, extra)` æŠŠ `extra` æœ¬èº«ä¹ŸæŒ‚åˆ°æœ€ç»ˆ Context ä¸­ï¼Œä¾¿äºå¤–éƒ¨ `Context.get(context, ServiceTag)` è¯»å–ï¼›
       - è¿”å›ä¸€ä¸ªæ–°çš„ ModuleImplï¼Œ`layer` æŒ‡å‘åˆå¹¶åçš„ Layerã€‚
     - `withLayers(...extras)` åªæ˜¯å¯¹åˆå§‹ Impl è¿ç»­è°ƒç”¨ `withLayer` çš„è¯­æ³•ç³–ï¼Œä»¥ä¿è¯è¡Œä¸ºä¸€è‡´ã€‚
   - è¿™ç§å®ç°ç‰ºç‰²äº†ä¸€éƒ¨åˆ† Env æ³›å‹çš„ç²¾ç¡®æ€§ï¼ˆModuleImpl çš„ `REnv` æ”¶æ•›ä¸º `any`ï¼‰ï¼Œä½†æ¢æ¥äº†ï¼š
     - æ›´ç®€å•å¯é çš„è¿è¡Œæ—¶è¯­ä¹‰ï¼ˆæ‰€æœ‰ Env æ³¨å…¥éƒ½é€šè¿‡ Layer ç»„åˆå®Œæˆï¼‰ï¼›
     - è¾ƒå¥½çš„ React é€‚é…ä½“éªŒï¼ˆ`useModule(impl)` åªéœ€å…³å¿ƒæœ€ç»ˆ layerï¼Œä¸éœ€è¦é‡æ–°æ‹¼ Envï¼‰ã€‚

4. **Logix.provide(ModuleImpl) åœ¨ AppRuntime ä¸­çš„è§’è‰²**
   - `Logix.app({ modules })` åœ¨å®ç°ä¸Šåªæ¥æ”¶ `AppModuleEntry`ï¼š
     - `module`: ModuleInstanceï¼ˆTag + Shape ä¿¡æ¯ï¼‰ï¼›
     - `layer`: å¯¹åº”çš„ ModuleRuntime Layerã€‚
   - `Logix.provide(impl: ModuleImpl)` æ˜¯ä¸€å±‚è¯­æ³•ç³–ï¼š
     - æ‹†å‡º `impl.module` ä¸ `impl.layer`ï¼›
     - è°ƒç”¨ `AppRuntime.provide(module, layer)`ï¼Œç”Ÿæˆ `AppModuleEntry`ã€‚
   - è¿™æ ·å¯ä»¥ä¿è¯ï¼š
     - AppRuntime çš„æ ¸å¿ƒå®ç°ä¸éœ€è¦çŸ¥é“ ModuleImpl çš„å­˜åœ¨ï¼Œåªå…³å¿ƒâ€œä¸€ä¸ª Module + ä¸€æ£µ Layerâ€ï¼›
     - æœªæ¥è‹¥æœ‰å…¶ä»–å½¢å¼çš„â€œæ¨¡å—å®ç°è“å›¾â€ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åŒæ ·çš„ `provide` å…¥å£æ¥å…¥ã€‚

5. **æµ‹è¯•å…œåº•ä¸çº¦æŸ**
   - `packages/logix-core/test/ModuleImpl.test.ts` ä¸­çš„ä¸¤ä¸ªç”¨ä¾‹è§†ä¸º ModuleImpl è·¯å¾„çš„â€œæœ€å°å®Œå¤‡å›å½’é›†â€ï¼š
     - `withLayer` èƒ½è®© Logic å†…çš„ `yield* ServiceTag` æ­£å¸¸æ‹¿åˆ°å®ç°ï¼Œå¹¶é©±åŠ¨çŠ¶æ€æ›´æ–°ï¼›
     - `Logix.provide(ModuleImpl)` ä¸ `Logix.app` ç»„åˆåï¼Œ`Consumer` æ¨¡å—çš„é€»è¾‘åœ¨ AppRuntime ç¯å¢ƒä¸‹åŒæ ·èƒ½æ‹¿åˆ° Service å¹¶æ­£å¸¸å·¥ä½œã€‚
   - ä¸€æ—¦å¯¹ ModuleImpl / withLayer / provide çš„å®ç°åšæ”¹åŠ¨ï¼Œå¿…é¡»ä¿è¯è¿™ä¸¤æ¡æµ‹è¯•ä¿æŒç»¿ç¯ï¼Œå¦åˆ™è§†ä¸ºç ´åäº† ModuleImpl çš„åŸºæœ¬å¥‘çº¦ã€‚
</file>

<file path="runtime-logix/impl/test-package.md">
# @logix/test Specification

> [!NOTE]
> This specification defines the `@logix/test` package, designed to provide "Pure Effect Testing" utilities for Logix v3. It rejects imperative Jest-style APIs in favor of an Effect-native approach.

## 1. Overview

`@logix/test` provides a specialized runtime and fluent testing API for Logix modules. It treats tests as `Effect` programs, allowing developers to control time, mock services, and assert states using standard Effect patterns.

## 2. Package Structure

```
packages/logix-test/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                # Public API (defineTest, runTest, Scenario)
â”‚   â”‚
â”‚   â”œâ”€â”€ runtime/
â”‚   â”‚   â””â”€â”€ TestRuntime.ts      # Specialized Runtime with TestClock/TestServices
â”‚   â”‚
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ defineTest.ts       # Core testing API
â”‚   â”‚   â””â”€â”€ Scenario.ts         # Builder for integration tests
â”‚   â”‚
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ assertions.ts       # Effect-based assertions
â”‚
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ tsup.config.ts
```

## 3. Core APIs

### 3.1 `TestProgram` & `runTest`

The recommended entrypoint. `TestProgram.make` builds a test scenario from a
declarative config, and `runTest` executes the resulting Effect.

- `TestProgram.make(config)`: Defines a test scenario (single or multi-module).
- `scenario.run((api) => Effect)`: Provides a `TestApi` for dispatch / assertions.
- `runTest(effect)`: Executes the test Effect.
  - Returns `Promise<ExecutionResult>` containing traces and logs (useful for platform debugging).

```typescript
import { TestProgram, runTest } from "@logix/test"

const scenario = TestProgram.make({
  main: {
    module: CounterModule,
    initial: { count: 0 },
    logics: [CounterLogic],
  },
  modules: [
    {
      module: AuthModule,
      initial: { loggedIn: false },
      logics: [AuthLogic],
    },
  ],
  layers: [
    LinkLayer, // e.g. Logix.Link(User, Auth)
  ],
})

const testEffect = scenario.run(($) =>
  Effect.gen(function* () {
    yield* $.dispatch({ _tag: "increment", payload: undefined })
    yield* $.assert.state((s) => s.count === 1)
  })
)

const result = await runTest(testEffect)
console.log(result.trace)
```

> [!NOTE]
> `defineTest` ä»ç„¶ä¿ç•™ä½œä¸ºåº•å±‚ APIï¼Œé€‚ç”¨äºç®€å•å•æ¨¡å—åœºæ™¯æˆ–éœ€è¦ç›´æ¥æ§åˆ¶ Layer æ³¨å…¥çš„æƒ…å†µã€‚

### 3.2 Test API Capabilities

The `api` object provided in `defineTest` exposes the following capabilities:

```typescript
interface TestApi<State, Actions> {
  // Dispatch an action to the module under test
  dispatch(action: Action): Effect<void>

  // Assertions (auto-retrying)
  assert: {
    // Assert state matches a predicate
    state(predicate: (s: State) => boolean): Effect<void>

    // Assert a specific signal was emitted
    signal(type: string, payload?: unknown): Effect<void>

    // Assert a service method was called n times
    serviceCalls(tag: Context.Tag<any, any>, times: number): Effect<void>
  }
}
```

### 3.3 `TestRuntime`

Internally used by `runTest` to provide a `TestContext` where:
- `Clock` is replaced by `TestClock`.
- `Random` is deterministic.
- Services can be mocked via Layers.

## 4. Dependencies

- `logix-core`: The runtime being tested.
- `effect`: For `TestContext`, `TestClock`, `Layer`, etc.
- **No hard dependency on Vitest/Jest**. Adapters can be added in separate packages (e.g., `@logix/test-vitest`) or just used as runners.

## 5. Key Features

- **Pure Effect**: Tests are just Effects. Compose them, retry them, race them.
- **Time Travel**: Native integration with `TestClock`.
- **Auto-Retry Assertions**: `api.assert.state` retries until the condition is met or times out, handling async state updates naturally.
- **Platform Ready**:
  - **Full DI Support**: Inject any Effect Layer (Database, Network, FS) to mock backend environments.
  - **Execution Tracing**: `runTest` returns structured logs and traces, enabling "n8n-style" visual debugging and AI analysis.
</file>

<file path="runtime-logix/impl/v3-scope-lock.md">
# Logix v3.0 Implementation Scope Lock

> **Status**: LOCKED
> **Date**: 2025-11-29
> **Purpose**: To define the explicit boundary for the v3.0 implementation, preventing scope creep and ensuring a focused delivery of the core engine.

## 1. Feature Scope (Must vs. Defer)

| Feature Category | **Must Have (v3.0)** | **Deferred (v3.x / v4)** |
| :--- | :--- | :--- |
| **Core Logic** | - Single Module Reactivity (L1)<br>- Cross-Module Collaboration (`$.use`)<br>- Async Effects & Flows<br>- External Sources (WebSocket/Timer) | - Wildcard Listeners (`items.*.field`)<br>- Dynamic Rule Injection<br>- Multi-Tenant Isolation |
| **Concurrency** | - `run` (Sequential)<br>- `takeLatest` / `takeExhaust` | - Complex Backpressure Strategies<br>- Fine-grained Fiber Supervision |
| **Lifecycle** | - `onInit` (Blocking)<br>- `onDestroy` (Cleanup)<br>- `onSuspend` / `onResume` (Platform) | - Hot State Migration (HMR with data preservation is "Best Effort") |
| **Data** | - Schema-driven State/Action<br>- Immutable Updates | - JSON AST Dual Representation<br>- CRDT / Collaborative Editing |
| **Draft/Session** | - **None** (Use Local Modules instead) | - Transactional Draft API (`start/commit`)<br>- STM (Software Transactional Memory) |

## 2. Public API Surface (Whitelist)

Only the following APIs are considered "Public" for application developers. All others are internal implementation details.

### Application Developer (The "User")
- **Definition**: `Logix.Module`, `Logix.app`, `Logix.provide`
- **Logic API**: `Module.logic`, `Module.live`
- **Bound API (`$`)**:
    - `$.state`, `$.actions`
    - `$.onAction`, `$.onState`, `$.on`
    - `$.use` (Dependency Injection)
    - `$.lifecycle` (`onInit`, `onDestroy`, `onSuspend`, `onResume`)
- **React Integration**: `useModule`, `useLocalModule`, `useSelector`, `useDispatch`, `RuntimeProvider`

### Library/Platform Author (The "Extender")
- **Types**: `Logix.ModuleRuntime`, `Logic.Of`, `Logic.Env`
- **Interfaces**: `Platform` (Service Interface)
- **Effect**: `Layer`, `Context.Tag`, `Effect`, `Schema`

## 3. Runtime Strategy

### HMR (Hot Module Replacement)
- **Strategy**: **Safe Restart**.
- **Behavior**: When code changes, dispose the old Scope (triggering `onDestroy`) and re-initialize the new Scope.
- **State**: Attempt to preserve State if the Schema is compatible; otherwise reset to initial state. No complex migration logic in v3.0.

### Code <-> Graph
- **Strategy**: **One-Way Visualization**.
- **Behavior**: The engine can emit a static graph of the Logic (based on `$.on` declarations) for debugging.
- **Constraint**: No "Visual Programming" (Graph -> Code) in v3.0.

## 4. Usage Guidelines (Soft Constraints)

These are not enforced by the compiler but are critical for maintainability.

1.  **Single Writer Principle**: A state field should ideally be updated by a single logic flow or reducer pattern. Avoid scattered updates.
2.  **Cross-Module Read-Only**: Never mutate another module's state directly. Always use `dispatch` or `$.use(Other).read()`.
3.  **UI is Dumb**: UI components should not contain business logic. They should only `dispatch` intents and `read` state.
</file>

<file path="runtime-logix/react/README.md">
---
title: React Adapter Â· Runtime Integration
status: draft
version: 2025-12-03
---

# React Adapter Â· `@logix/react` è§„èŒƒæ€»è§ˆ

> ä½œç”¨ï¼šä½œä¸º `@logix/react` çš„è§„èŒƒæ€§è¯´æ˜ï¼Œä¸²è” RuntimeProviderã€æ ¸å¿ƒ Hooks ä¸ React 18 å¹¶å‘æ¨¡å‹ä¹‹é—´çš„å¥‘çº¦ã€‚  
> è¯»è€…ï¼šä½¿ç”¨ Logix ç¼–å†™ React å‰ç«¯çš„ä¸šåŠ¡å·¥ç¨‹å¸ˆã€è¿è¡Œæ—¶å®ç°è€…ä¸å¹³å°é›†æˆæ–¹ã€‚

æœ¬èŠ‚ä»¥å½“å‰ `@logix/react` å®ç°ä¸ºäº‹å®æºï¼Œçº¦å®š React é€‚é…å±‚çš„å®šä½ä¸ API å½¢æ€ï¼Œå¹¶æŒ‡å‘æ›´è¯¦ç»†çš„ä¸“é¢˜è‰æ¡ˆï¼ˆè§ `docs/specs/drafts/topics/react-adapter`ï¼‰ã€‚

## 1. å®šä½ä¸èŒè´£è¾¹ç•Œ

- **å®šä½**ï¼š`@logix/react` æ˜¯ Logix Runtime çš„ React é€‚é…å±‚ï¼Œå¯¹æ ‡ `react-redux` / `mobx-react`ã€‚
- **æ ¸å¿ƒèŒè´£**ï¼š
  - ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šåœ¨ React ç»„ä»¶æ ‘ç”Ÿå‘½å‘¨æœŸå†…åˆ›å»ºã€å¤ç”¨å’Œé”€æ¯ Logix Runtime / ModuleRuntimeï¼›
  - è®¢é˜…æ¨¡å‹ï¼šåŸºäº `useSyncExternalStore` æä¾›æ’•è£‚å®‰å…¨çš„çŠ¶æ€è®¢é˜…ï¼›
  - äº‹ä»¶æ¡¥æ¥ï¼šå°† React äº‹ä»¶æ¡¥æ¥åˆ° Logix Action/Flowï¼›
  - ä¾èµ–æ³¨å…¥ï¼šé€šè¿‡ Context åœ¨ç»„ä»¶æ ‘é¡¶éƒ¨æ³¨å…¥ Layer/Runtimeã€‚
- **éèŒè´£**ï¼š
  - ä¸æ‰¿è½½ä¸šåŠ¡é¢†åŸŸé€»è¾‘ï¼ˆå¦‚è¡¨å•/åˆ—è¡¨ï¼‰ï¼›è¿™äº›åº”ç”± `@logix/form`ã€åœºæ™¯åŒ…æˆ–ä¸šåŠ¡ä»£ç å®ç°ï¼›
  - ä¸å®šä¹‰ UI Intent / Skeleton åè®®ï¼Œè¿™éƒ¨åˆ†ç•™ç»™å¹³å°/Studio ä¸ UI å±‚è§„èŒƒã€‚

## 2. RuntimeProvider ä¸ Runtime æ³¨å…¥

`RuntimeProvider` æ˜¯ React é€‚é…å±‚çš„å…¥å£ç»„ä»¶ï¼Œè´Ÿè´£ä¸ºå­æ ‘æä¾›ä¸€ä¸ªå¸¦ä¸Šä¸‹æ–‡çš„ `ManagedRuntime`ï¼š

- Props çº¦å®šï¼š
  - `app?: Logix.AppDefinition<R>`ï¼šä½¿ç”¨ `Logix.app` å®šä¹‰çš„åº”ç”¨ï¼ŒProvider ä¼šåœ¨å†…éƒ¨é€šè¿‡ `app.makeRuntime()` æ„å»ºæ ¹ Runtimeï¼›
  - `runtime?: ManagedRuntime<never, any>`ï¼šå¤ç”¨å¤–éƒ¨åˆ›å»ºçš„ Runtimeï¼ˆæµ‹è¯•æˆ–é›†æˆåœºæ™¯å¸¸ç”¨ï¼‰ï¼›
  - `layer?: Layer<any, any, any>`ï¼šåœ¨çˆ¶ Runtime çš„åŸºç¡€ä¸Šé™„åŠ ä¸€å±‚å±€éƒ¨æœåŠ¡ï¼ˆé¡µé¢/ç»„ä»¶çº§ DIï¼‰ã€‚
- è¿è¡Œæ¨¡å¼ï¼š
  - è‹¥æä¾› `app`ï¼Œåˆ™æŒ‰åº”ç”¨çº§ Runtime æ¨¡å¼è¿è¡Œï¼ˆç”Ÿå‘½å‘¨æœŸç»‘å®šåˆ°æ•´ä¸ªå‰ç«¯åº”ç”¨ï¼‰ï¼›
  - è‹¥æä¾› `runtime`ï¼Œåˆ™ç›´æ¥å¤ç”¨è¯¥ Runtimeï¼›
  - å¦åˆ™ä»ä¸Šå±‚ `RuntimeProvider` ç»§æ‰¿ï¼ˆåµŒå¥— Provider åœºæ™¯ï¼‰ã€‚
- Layer ç»‘å®šï¼š
  - å¯¹äºä¼ å…¥çš„ `layer`ï¼Œ`RuntimeProvider` ä¼šåœ¨å†…éƒ¨åˆ›å»ºä¸€ä¸ª `Scope`ï¼Œé€šè¿‡ `Layer.buildWithScope` æ„å»º Contextï¼Œå¹¶åœ¨ç»„ä»¶å¸è½½æ—¶å…³é—­ Scopeï¼›
  - å¤šä¸ª Provider å¯ä»¥å åŠ å„è‡ªçš„ Layerï¼Œå½¢æˆã€Œå…¨å±€ Runtime + å±€éƒ¨æ³¨å…¥ã€çš„åˆ†å±‚ç»“æ„ã€‚

æ‰€æœ‰å­ç»„ä»¶å‡é€šè¿‡ React Context è®¿é—®ä¸€ä¸ªã€Œå¸¦ Context é€‚é…çš„ Runtimeã€ï¼Œè¯¥ Runtime åœ¨æ¯æ¬¡ `run*` æ—¶è‡ªåŠ¨æ³¨å…¥èšåˆ Contextï¼Œä¿è¯ React å­æ ‘å†…çš„ Effect è°ƒç”¨éƒ½èƒ½è·å¾—æ­£ç¡®çš„æœåŠ¡ä¾èµ–ã€‚

## 3. æ ¸å¿ƒ Hooks å¥‘çº¦

### 3.1 `useModule`

`useModule` æ˜¯è¿æ¥ React ä¸ Logix Module çš„åŸºç¡€ Hookï¼Œè´Ÿè´£åœ¨ç»„ä»¶ä¸­è·å¾— ModuleRuntime æˆ–è®¢é˜…å…¶ Stateï¼š

- æ”¯æŒä¸‰ç±»å¥æŸ„ï¼š
  - `ModuleInstance`ï¼š`Logix.Module("Id", Shape)` çš„å®ä¾‹ Tagï¼›
  - `ModuleImpl`ï¼šåŒ…å« `layer` + `module` çš„å®ç°ä½“ï¼ˆé€šå¸¸ç”± `Logix.provide` è¿”å›ï¼‰ï¼›
  - `ModuleRuntime`ï¼šå·²å­˜åœ¨çš„è¿è¡Œæ—¶å®ä¾‹ã€‚
- è°ƒç”¨å½¢æ€ï¼š
  - `useModule(ModuleInstance | ModuleRuntime)`ï¼šè¿”å›ç¨³å®šçš„ `ModuleRuntime` å¼•ç”¨ï¼›
  - `useModule(handle, selector, equalityFn?)`ï¼šåœ¨å†…éƒ¨é€šè¿‡ `useSelector` è®¢é˜…çŠ¶æ€ã€‚
- ModuleImpl åœºæ™¯ï¼š
  - å¯¹äº `ModuleImpl`ï¼Œ`useModule` ä¼šé€šè¿‡ `useLocalModule` åœ¨ç»„ä»¶ Scope å†…åˆ›å»ºä¸€æ£µå±€éƒ¨ ModuleRuntime æ ‘ï¼›
  - è¯¥å±€éƒ¨ Runtime çš„èµ„æºç”±å†…éƒ¨ Scope æ‰˜ç®¡ï¼Œç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨å…³é—­ã€‚

### 3.2 `useSelector`

`useSelector` æä¾›æ’•è£‚å®‰å…¨çš„çŠ¶æ€è®¢é˜…èƒ½åŠ›ï¼š

- åŸºäº `useSyncExternalStoreWithSelector` å®ç°ï¼Œç­¾åä¸ºï¼š
  - `useSelector(handle, selector, equalityFn?)`ï¼›
  - `handle` å¯ä»¥æ˜¯ ModuleRuntime æˆ– ModuleInstance Tagï¼›
  - `selector` ä»¥å®Œæ•´ State ä¸ºè¾“å…¥ï¼Œè¿”å›ä»»æ„æ´¾ç”Ÿå€¼ï¼›
  - `equalityFn` é»˜è®¤ä½¿ç”¨ `Object.is`ï¼Œå¯è‡ªå®šä¹‰ã€‚
- å†…éƒ¨é€šè¿‡ï¼š
  - ä½¿ç”¨ Runtime çš„ `runFork(Stream.runForEach(moduleRuntime.changes(...)))` æ³¨å†Œè®¢é˜…ï¼›
  - ä½¿ç”¨ `runSync(moduleRuntime.getState)` ä½œä¸º `getSnapshot`ã€‚

### 3.3 `useDispatch`

`useDispatch` è´Ÿè´£ä» React ç¯å¢ƒä¸­æ´¾å‘ Logix Actionï¼š

- ç­¾åï¼š`useDispatch(handle)`ï¼Œå…¶ä¸­ `handle` ä¸º ModuleInstance æˆ– ModuleRuntimeï¼›
- å†…éƒ¨è¡Œä¸ºï¼š
  - é€šè¿‡ `useRuntime` è·å–å½“å‰é€‚é…åçš„ Runtimeï¼›
  - é€šè¿‡ `useModuleRuntime(handle)` è·å–ç›®æ ‡ ModuleRuntimeï¼›
  - è¿”å›çš„å›è°ƒåœ¨è°ƒç”¨æ—¶æ‰§è¡Œ `runtime.runFork(moduleRuntime.dispatch(action))`ã€‚

### 3.4 å±€éƒ¨ä¸åˆ—è¡¨åœºæ™¯

å½“å‰å®ç°è¿˜æä¾›ä»¥ä¸‹ Hookï¼Œç”¨äºæ›´å¤æ‚åœºæ™¯ï¼š

- `useLocalModule(factory, deps)`ï¼šåœ¨ç»„ä»¶çº§ Scope å†…åˆ›å»º ModuleRuntimeï¼Œé€‚åˆè¡¨å•/å‘å¯¼ç­‰å±€éƒ¨çŠ¶æ€ï¼›
- `useLayerModule`ï¼šåœ¨é™„åŠ  Layer çš„ä¸Šä¸‹æ–‡ä¸­åˆ›å»ºæ¨¡å—ï¼ˆå®éªŒæ€§è´¨ï¼‰ï¼›
- `useModuleList`ï¼šè®¢é˜…å¹¶ç®¡ç†ä¸€ç»„æ¨¡å—å®ä¾‹åˆ—è¡¨ï¼ˆå…¸å‹å¤šè¡Œåœºæ™¯ï¼‰ã€‚

è¿™äº› Hook çš„å…·ä½“è¡Œä¸ºåœ¨å®ç°ä¸­å·²ç»å›ºå®šï¼Œåç»­å¦‚éœ€è°ƒæ•´ï¼Œåº”å…ˆæ›´æ–°æœ¬è§„èŒƒå†ä¿®æ”¹ä»£ç ã€‚

## 4. React 18 å¹¶å‘ä¸é«˜çº§ç‰¹æ€§ï¼ˆè§„åˆ’ï¼‰

å½“å‰ `@logix/react` å·²ç»ï¼š

- åŸºäº `useSyncExternalStore` ä¿è¯åŸºæœ¬çš„æ’•è£‚å®‰å…¨ï¼›
- åœ¨ `useModule` / `useLocalModule` ä¸­é€šè¿‡ Scope + Context ç®¡ç†èµ„æºã€‚

ä»åœ¨è§„åˆ’ä¸­çš„èƒ½åŠ›åŒ…æ‹¬ï¼š

- Suspense é›†æˆï¼šä¸ºå¼‚æ­¥ State æä¾›æŒ‚èµ·/å›é€€ç­–ç•¥ï¼ˆå‚è§ `docs/specs/drafts/topics/react-adapter/03-concurrent-rendering.md` è‰æ¡ˆï¼‰ï¼›  
- æ›´ç³»ç»Ÿçš„ Concurrent æ¨¡å¼æµ‹è¯•çŸ©é˜µï¼šéªŒè¯å¤š RuntimeProvider / å¤š Store åœºæ™¯ä¸‹çš„è¡Œä¸ºï¼›  
- SSR ä¸æµ‹è¯•å‹å¥½æ€§ï¼šåœ¨æ—  DOM ç¯å¢ƒä¸‹æ¨¡æ‹Ÿ RuntimeProvider è¡Œä¸ºï¼Œæ–¹ä¾¿å•å…ƒæµ‹è¯•ä¸æœåŠ¡ç«¯æ¸²æŸ“ã€‚

ä¸Šè¿°é«˜çº§èƒ½åŠ›åœ¨å®˜æ–¹å®ç°å®Œæˆå‰ï¼Œå‡ä»¥è‰æ¡ˆæ–‡æ¡£ä¸ºå‡†ï¼Œä¸è§†ä¸ºç¨³å®š API å¥‘çº¦ã€‚

## 5. ç¤ºä¾‹ä¸ç”¨æˆ·æ–‡æ¡£

- è¿è¡Œæ—¶ä»£ç ç¤ºä¾‹ï¼š
  - `examples/logix-react`ï¼šå±•ç¤º Global Runtimeã€Logix.app Counterã€Local Module ç­‰å…¸å‹é›†æˆæ–¹å¼ã€‚
- ç”¨æˆ·å‘å¯¼æ–‡æ¡£ï¼š
  - apps/docs ä¸­çš„ã€ŒLogix + React é›†æˆã€æŒ‡å—ï¼ˆè§ `apps/docs/content/docs/guide/...`ï¼‰ï¼Œä»ä¸šåŠ¡å·¥ç¨‹å¸ˆè§†è§’è®²è§£å¦‚ä½•ä½¿ç”¨ RuntimeProvider ä¸æ ¸å¿ƒ Hooksã€‚

åç»­åœ¨æ‰©å±• React Adapter èƒ½åŠ›æ—¶ï¼Œåº”éµå¾ªä»¥ä¸‹æµç¨‹ï¼š

1. åœ¨ `docs/specs/drafts/topics/react-adapter` ä¸­ä»¥è‰æ¡ˆå½¢å¼æ¼”åŒ–è®¾è®¡ï¼›  
2. å¾…è®¾è®¡ç¨³å®šåï¼Œå…ˆæ›´æ–°æœ¬è§„èŒƒæ–‡ä»¶å’Œ `implementation-status.md`ï¼›  
3. æœ€ååœ¨ `@logix/react` ä¸­å®ç°ï¼Œå¹¶é€šè¿‡ `examples/logix-react` ä¸ apps/docs æ•™ç¨‹éªŒè¯ DXã€‚
</file>

<file path="runtime-logix/test/01-test-kit-design.md">
# Logix Test Kit Design (@logix/test)

> **Status**: Draft
> **Purpose**: ä¸º Logic Intent æä¾›ç¯å¢ƒæ— å…³çš„ã€å¯æ—¶é—´æ—…è¡Œçš„ã€å¿«ç…§å‹å¥½çš„æµ‹è¯•åŸºç¡€è®¾æ–½ã€‚

## 1. è®¾è®¡å“²å­¦ï¼šPure Effect Testing

æˆ‘ä»¬æ‹’ç»åœ¨ Effect ç”Ÿæ€ä¸­å¼•å…¥ Jest é£æ ¼çš„å‘½ä»¤å¼ APIã€‚æµ‹è¯•ä»£ç å¿…é¡»ä¸ä¸šåŠ¡ä»£ç ä¿æŒ**åŒæ„**ï¼Œå³æµ‹è¯•æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª `Effect` ç¨‹åºã€‚

*   **ä¸€è‡´æ€§**ï¼šä½¿ç”¨ `Effect.gen` ç¼–å†™æµ‹è¯•åœºæ™¯ã€‚
*   **ç»„åˆæ€§**ï¼šæµ‹è¯•æ­¥éª¤å¯ä»¥åƒç§¯æœ¨ä¸€æ ·ç»„åˆï¼ˆå¦‚ `Effect.repeat`, `Effect.race`ï¼‰ã€‚
*   **ç±»å‹å®‰å…¨**ï¼šå¤ç”¨ Logix Core çš„æ³›å‹å®šä¹‰ï¼Œå®ç°ç«¯åˆ°ç«¯çš„ç±»å‹æ¨å¯¼ã€‚

## 2. API è®¾è®¡

### 2.1 `TestProgram` + `runTest`

æ¨èå…¥å£ï¼šé€šè¿‡å£°æ˜å¼é…ç½®æ„å»ºæµ‹è¯•åœºæ™¯ï¼Œå†ä»¥ Effect å½¢å¼è¿è¡Œã€‚

```typescript
import { TestProgram, runTest } from '@logix/test';

const scenario = TestProgram.make({
  main: {
    module: CounterModule,
    initial: { count: 0 },
    logics: [CounterLogic],
  },
  modules: [
    {
      module: AuthModule,
      initial: { loggedIn: false },
      logics: [AuthLogic],
    },
  ],
  layers: [
    LinkLayer,
  ],
});

const myTest = scenario.run((api) => Effect.gen(function*() {
  // 1. Action: è§¦å‘ä¿¡å· (å¤ç”¨ Core è¯­ä¹‰)
  yield* api.dispatch({ _tag: 'submit', payload: { id: 1 } });

  // 2. Assertion: çŠ¶æ€æ–­è¨€ (Effect)
  yield* api.assert.state(s => s.count === 100);

  // 3. Assertion: ä¿¡å·æ–­è¨€
  yield* api.assert.signal('toast', { msg: 'Success' });
}));

// æ‰§è¡Œæµ‹è¯•ï¼Œè¿”å› ExecutionResultï¼ˆåŒ…å« Traceï¼‰
const result = await runTest(myTest);
```

## 3. é«˜çº§èƒ½åŠ›

### 3.1 æ¨¡ç³Šæµ‹è¯• (Fuzzing)

ç”±äºæµ‹è¯•æ˜¯ Effectï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾ç»“åˆ `@effect/schema/Arbitrary` ç”Ÿæˆéšæœºè¾“å…¥è¿›è¡Œæ¨¡ç³Šæµ‹è¯•ã€‚

```typescript
import * as Arb from '@effect/schema/Arbitrary';
import * as fc from 'fast-check';

const fuzzTest = scenario.run((api) => Effect.gen(function*() {
  const input = yield* Arb.make(InputSchema);
    yield* api.dispatch({ _tag: 'submit', payload: input });
  yield* api.assert.state(s => s.isValid);
}));
```

### 3.2 å¹¶å‘æµ‹è¯•

æ¨¡æ‹Ÿç«æ€æ¡ä»¶ã€‚

```typescript
const raceTest = scenario.run((api) => Effect.gen(function*() {
  // æ¨¡æ‹Ÿå¿«é€Ÿç‚¹å‡»ä¸¤æ¬¡
    yield* Effect.all([
    api.dispatch({ _tag: 'submit', payload: { id: 1 } }),
    api.dispatch({ _tag: 'submit', payload: { id: 2 } })
  ], { concurrency: 'unbounded' });
  
  // æ–­è¨€åªå‘ç”Ÿäº†ä¸€æ¬¡ API è°ƒç”¨
  yield* api.assert.serviceCalls(MyServiceTag, 1);
}));
```

## 4. AI è‡ªæ„ˆæ”¯æŒ

`runTest` åœ¨å¤±è´¥æ—¶ä¼šæŠ›å‡ºç»“æ„åŒ–çš„ `ExecutionDump`ï¼ŒåŒ…å«å®Œæ•´çš„ Trace å’Œ State å˜æ›´è®°å½•ï¼Œä¾› AI åˆ†æã€‚
</file>

<file path="runtime-logix/test/02-round-trip-testing.md">
# Round-trip Testing Strategy (å…¨åŒå·¥é—­ç¯æµ‹è¯•)

> **Status**: Draft
> **Purpose**: ç¡®ä¿ Intent ä¸ Code ä¹‹é—´çš„è½¬æ¢æ˜¯æ— æŸã€ç¨³å®šä¸”é²æ£’çš„ã€‚è¿™æ˜¯å…¨åŒå·¥å¼•æ“çš„ç”Ÿå‘½çº¿ã€‚

## 1. æ ¸å¿ƒç†å¿µï¼šProperty-Based Testing

ç”±äº Intent çš„ç»„åˆç©ºé—´æ˜¯æ— é™çš„ï¼Œæˆ‘ä»¬ä¸èƒ½ä»…ä¾èµ–æ‰‹å†™çš„ç”¨ä¾‹ã€‚æˆ‘ä»¬å°†é‡‡ç”¨ **Property-Based Testing (PBT)** æ–¹æ³•ï¼Œéšæœºç”Ÿæˆåˆæ³•çš„ Intent ç»“æ„ï¼ŒéªŒè¯å…¶åœ¨è½¬æ¢é“¾è·¯ä¸­çš„ä¸å˜æ€§ (Invariants)ã€‚

## 2. æµ‹è¯•é“¾è·¯ (Test Pipelines)

### 2.1 The Identity Pipeline (Intent ä¸€è‡´æ€§)

éªŒè¯ç”Ÿæˆå™¨å’Œè§£æå™¨çš„äº’é€†æ€§ã€‚

```mermaid
graph LR
    I1[Intent A] -->|Generate| C[Code]
    C -->|Parse| I2[Intent B]
    I1 == I2? --> Result{Pass/Fail}
```

*   **Invariant**: `DeepEqual(Intent A, Intent B)`
*   **Coverage**: è¦†ç›–æ‰€æœ‰èŠ‚ç‚¹ç±»å‹ (ServiceCall, Branch, Loop, Parallel) åŠå…¶åµŒå¥—ç»„åˆã€‚

### 2.2 The Stability Pipeline (Code ç¨³å®šæ€§)

éªŒè¯è§£æå™¨å’Œç”Ÿæˆå™¨ä¸ä¼šå¼•å…¥æ— æ„ä¹‰çš„ä»£ç å˜åŠ¨ï¼ˆå¦‚æ ¼å¼æŠ–åŠ¨ï¼‰ã€‚

```mermaid
graph LR
    C1[Code A] -->|Parse| I[Intent]
    I -->|Generate| C2[Code B]
    C1 == C2? --> Result{Pass/Fail}
```

*   **Invariant**: `AST_Equal(Code A, Code B)` (å¿½ç•¥ç©ºç™½ã€æ³¨é‡Šå·®å¼‚)

### 2.3 The Resilience Pipeline (æŠ—å¹²æ‰°èƒ½åŠ›)

éªŒè¯ Parser åœ¨é¢å¯¹äººå·¥ä¿®æ”¹æ—¶çš„é²æ£’æ€§ã€‚

1.  **Mutation**: å¯¹ç”Ÿæˆçš„ä»£ç è¿›è¡Œéšæœºå˜å¼‚ï¼ˆä¿®æ”¹å‚æ•°ã€æ’å…¥è¯­å¥ã€é‡å‘½åå˜é‡ï¼‰ã€‚
2.  **Parse**: è§£æå˜å¼‚åçš„ä»£ç ã€‚
3.  **Assertion**:
    *   **Soft Mutation** (æ”¹å‚æ•°): èŠ‚ç‚¹åº”æ ‡è®°ä¸º `Dirty` ä½†ä¿æŒç»“æ„ã€‚
    *   **Hard Mutation** (æ”¹ç»“æ„): èŠ‚ç‚¹åº”æ ‡è®°ä¸º `Ejected` (Gray Box)ã€‚
    *   **Global**: å›¾ç»“æ„ä¸åº”å´©å¡Œï¼Œæœªä¿®æ”¹çš„èŠ‚ç‚¹åº”ä¿æŒåŸæ ·ã€‚

## 3. å®ç°å·¥å…·

*   **Generator**: `@effect/schema/Arbitrary` ç”¨äºç”Ÿæˆéšæœº Intentã€‚
*   **Mutator**: `ts-morph` ç”¨äºå¯¹ä»£ç è¿›è¡Œç»“æ„åŒ–å˜å¼‚ã€‚
*   **Runner**: `fast-check` ç”¨äºé©±åŠ¨ PBT æµç¨‹ã€‚

## 4. CI é›†æˆ

Round-trip æµ‹è¯•å±äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚å»ºè®®åœ¨ CI ä¸­é…ç½®ä¸º **Nightly Build** æˆ–åœ¨æ ¸å¿ƒå¼•æ“å˜æ›´æ—¶è§¦å‘ï¼Œè¿è¡Œæ•°ä¸‡æ¬¡è¿­ä»£ä»¥æ¢ç´¢è¾¹ç•Œæƒ…å†µã€‚
</file>

<file path="runtime-logix/README.md">
# Logix Engine Specs Â· å¯¼èˆªä¸åˆ†å±‚

æœ¬ç›®å½•æ±‡æ€» **Logix Engine** ç›¸å…³çš„å…¨éƒ¨è§„æ ¼æ–‡æ¡£ï¼Œæ—¢åŒ…å«ã€Œå¼•æ“è®¾è®¡ä¸å¥‘çº¦ã€ï¼Œä¹ŸåŒ…å«ã€ŒReact/Form é€‚é…å±‚ã€ä¸ã€Œé¢å‘ä½¿ç”¨è€…çš„æŒ‡å—ã€ã€‚

## é¢å‘è°

- æ¶æ„/å¹³å°è§„åˆ’è€…
å…³æ³¨ Logix åœ¨ intent-driven å¹³å°ä¸­çš„å®šä½ã€ä¸ Effect Flow Runtime çš„å…³ç³»ä»¥åŠä¸ Intent æ¨¡å‹çš„æ˜ å°„ã€‚
æ¨èä» `core/00-manifesto.md`ã€`core/01-architecture.md`ã€`core/03-intent-alignment.md`ã€`core/04-platform-integration.md` å¼€å§‹é˜…è¯»ï¼›
  Intent/Flow/Runtime å®¶æ—ä¸ Linking/Replay çš„ä¸Šæ¸¸è§„èŒƒè§ï¼š
  - `docs/specs/intent-driven-ai-coding/README.md`ï¼ˆå¹³å°è“å›¾ä¸ç‰ˆæœ¬ç´¢å¼•ï¼Œç¡®ç«‹ v3 ä¸ºäº‹å®æºï¼‰ï¼›
  - `docs/specs/intent-driven-ai-coding/v3/01-overview.md`ï¼ˆä¸‰ä½ä¸€ä½“æ¨¡å‹ä¸æ•´ä½“å®šä½ï¼‰ï¼›
  - `docs/specs/intent-driven-ai-coding/v3/02-intent-layers.md`ï¼ˆUI/Logic/Domain ä¸‰ç»´æ„å›¾æ¨¡å‹ï¼‰ï¼›
  - `docs/specs/intent-driven-ai-coding/v3/03-assets-and-schemas.md`ï¼ˆIntent/Pattern/Flow/Schema èµ„äº§æ˜ å°„ï¼‰ï¼›
  - `docs/specs/intent-driven-ai-coding/v3/04-intent-to-code-example.md`ï¼ˆIntent â†’ Flow/Logix ç«¯åˆ°ç«¯ç¤ºä¾‹ï¼‰ï¼›
  - `docs/specs/intent-driven-ai-coding/v3/97-effect-runtime-and-flow-execution.md`ï¼ˆRuntime å®¶æ—ä¸ Flow æ‰§è¡Œï¼‰ã€‚

- Logix å®ç°è€… / è¿è¡Œæ—¶ç»´æŠ¤è€…
  å…³æ³¨ Module/Store/Logic API å¥‘çº¦ã€å†…éƒ¨å®ç°æ¶æ„ã€è°ƒè¯•ä¸å¯è§‚æµ‹æ€§ã€‚
  ä»¥ `core/01-architecture.md`ã€`core/02-module-and-logic-api.md`ã€`core/03-logic-and-flow.md`ã€`core/05-runtime-implementation.md`ã€`core/08-usage-guidelines.md`ã€`core/09-debugging.md` ä¸ºä¸»è½´ã€‚

- ä¸šåŠ¡å·¥ç¨‹å¸ˆ / å¹³å°é›†æˆæ–¹
  éœ€è¦åœ¨çœŸå®ä¸šåŠ¡ä¸­ä½¿ç”¨ Logix ä¸å…¶ React/Form é€‚é…å±‚å†™ä»£ç ã€‚
  ä»¥ `guide/` ä¸‹æ–‡æ¡£ä¸ºå…¥å£ï¼Œå¯¹åº”çš„æ ¸å¿ƒå¥‘çº¦å’Œç¤ºä¾‹åœ¨ `core/examples/` ä»¥åŠ `react/`ã€`form/` ä¸­æŸ¥æ‰¾ã€‚

## ä¸€æ¡é»„é‡‘é“¾è·¯ï¼ˆModule â†’ Logic â†’ Fluent â†’ IntentRuleï¼‰

ä» Runtime è§†è§’çœ‹ï¼ŒLogix v3 å›´ç»•ä¸€æ¡æ ‡å‡†é“¾è·¯è®¾è®¡ï¼š

> **Module â†’ Module.logic(($) => ...) â†’ $.use(Module) â†’ Fluent DSL (`$.onState` / `$.onAction` / `$.on` + `.update/.mutate/.run*`) â†’ IntentRule**

ç®€è¦è¯´æ˜ï¼š

- åœ¨å®šä¹‰å±‚ï¼Œç”¨ `Logix.Module('Id', { state, actions })` å®šä¹‰é¢†åŸŸ Moduleï¼Œå®ƒåŒæ—¶æ‰¿æ‹… Id / Schema / Tag ä¸‰ç§è§’è‰²ï¼›
- åœ¨é€»è¾‘å±‚ï¼Œé€šè¿‡ `Module.logic(($)=>Effect.gen(...))` ç¼–å†™ Logicï¼Œ`$` æ˜¯ç»‘å®šäº†å½“å‰ ModuleRuntime + ä¸šåŠ¡æœåŠ¡ Env çš„ Bound APIï¼›
- åœ¨åä½œå±‚ï¼Œé€šè¿‡ `$.use(Module)` è·å–å…¶ä»–é¢†åŸŸæ¨¡å—çš„åªè¯»å¥æŸ„ï¼Œç”¨ Fluent DSLï¼ˆ`$.onState / $.onAction / $.on(stream)` + `$.state/dispatch`ï¼‰è¡¨è¾¾å• Module å†…ä¸è·¨ Module çš„è”åŠ¨ï¼›
- åœ¨å¹³å°å±‚ï¼Œè¿™äº› Fluent é“¾è¢«è§£æä¸º `IntentRule` IRï¼Œç”¨äº Universe/Galaxy è§†å›¾ä¸å›¾ç åŒå‘åŒæ­¥ã€‚

è¯¦ç»†è§„èŒƒå¯åœ¨ä»¥ä¸‹æ–‡æ¡£ä¸­æŸ¥é˜…ï¼š

- `core/02-module-and-logic-api.md`ï¼šModule / Logic / Live / `$` API æ€»è§ˆä¸ Module-first ç¼–ç¨‹æ¨¡å‹ï¼›
- `core/03-logic-and-flow.md`ï¼šBound API `$`ã€Logic / Flow / Control ä¸å®Œæ•´é“¾è·¯ç¤ºä¾‹ï¼›
- `core/06-platform-integration.md`ï¼šIntentRule IR ä¸å¹³å°é›†æˆï¼›
- `docs/specs/intent-driven-ai-coding/v3/03-module-assets.md`ï¼šModule èµ„äº§ä¸ä»£ç å±‚ Module å®šä¹‰çš„æ˜ å°„ã€‚

## ç›®å½•ç»“æ„æ¦‚è§ˆ

- `core/`
  - Logix è¿è¡Œæ—¶æœ¬èº«çš„è®¾è®¡ä¸å®ç°ï¼šå®£è¨€ã€æ¶æ„ã€API å¥‘çº¦ã€å¹³å°é›†æˆã€å®ç°æ¶æ„ã€ä½¿ç”¨è§„èŒƒã€åœºæ™¯ä¸ç¤ºä¾‹ç­‰ã€‚
  - å®˜æ–¹å…¥å£æ–‡æ¡£ï¼š`core/README.md`ï¼ˆèšåˆå„å­æ–‡æ¡£çš„æ¨èé˜…è¯»è·¯å¾„ä¸åˆ†ç»„ï¼‰ã€‚

- `guide/`
  - é¢å‘ã€Œä½¿ç”¨ Logix å†™ä¸šåŠ¡ã€çš„ä¸€çº¿å·¥ç¨‹å¸ˆä¸å¹³å°é›†æˆæ–¹çš„ç”¨æˆ·æ‰‹å†Œã€‚
  - è¦†ç›–ä»ã€Œæˆ‘åœ¨æ¶æ„é‡Œå¤„äºä»€ä¹ˆä½ç½®ï¼Ÿã€åˆ°ã€Œå¦‚ä½•å†™ç¬¬ä¸€ä¸ªè¡¨å•/åˆ—è¡¨ã€ã€ã€Œå¸¸è§åœºæ™¯é…æ–¹ã€ç­‰å†…å®¹ã€‚

- `react/`
  - `@logix/react` é€‚é…å±‚çš„è§„èŒƒï¼šç”Ÿå‘½å‘¨æœŸç®¡ç†ã€è®¢é˜…æ¨¡å‹ã€Context æ³¨å…¥ã€å¹¶å‘æ¸²æŸ“ä¸ Suspense ç­‰ã€‚
  - è¯¦ç»† API è¯´æ˜è§ `react/README.md` åŠå…¶å­æ–‡æ¡£ã€‚

- `form/`
  - `@logix/form` ä½œä¸ºé¢†åŸŸå±‚å®¢æˆ·ç«¯çš„è§„æ ¼ï¼šè¡¨å•çŠ¶æ€æ¨¡å‹ã€äº‹ä»¶åè®®ä¸åŸºäº React çš„é¢†åŸŸ Hooksã€‚
  - è¯¦ç»†è®¾è®¡è§ `form/README.md` åŠå…¶å­æ–‡æ¡£ã€‚

- `test/`
  - `@logix/test` æµ‹è¯•å·¥å…·åŒ…ï¼šæä¾› `TestRuntime`ã€`TestProgram` ä¸ `runTest` ç­‰åŸºç¡€æµ‹è¯• APIã€‚å½“å‰å®ç°å·²è¦†ç›– Logic åœºæ™¯ç¼–æ’ä¸çŠ¶æ€æ–­è¨€ï¼Œé«˜çº§èƒ½åŠ›ï¼ˆå¦‚åŸºäº Trace çš„æ–­è¨€ DSLã€ExecutionDump ç­‰ï¼‰ä»åœ¨æ¼”è¿›ä¸­ï¼Œè®¾è®¡è§ `test/01-test-kit-design.md`ã€‚

- `impl/`
  - è¿è¡Œæ—¶å®ç°å¤‡å¿˜å½•ä¸æŠ€æœ¯è‰å›¾ï¼šå›´ç»• `Logix.app` / `Logix.module` / ModuleDefã€Logic Middlewareã€Store ç”Ÿå‘½å‘¨æœŸç­‰å¤æ‚èƒ½åŠ›çš„å…·ä½“å®ç°æ€è·¯ä¸é£é™©è¯„ä¼°ã€‚
  - é¢å‘ runtime å®ç°è€…ä½¿ç”¨ï¼Œä¸ä½œä¸ºå¯¹å¤– API å¥‘çº¦ï¼›å…³é”®å†³ç­–ä¸€æ—¦ç¨³å®šï¼Œä¼šåŒæ­¥å›å†™åˆ° `core/` è§„æ ¼æ–‡æ¡£ã€‚

> è®¨è®º Logix èƒ½åŠ›ä¸æ–¹æ¡ˆæ—¶ï¼Œè¯·ä¼˜å…ˆå‚è€ƒ `core/` ä¸‹çš„æ–‡æ¡£ï¼›React/Form ç›¸å…³å†…å®¹åˆ†åˆ«æ²‰æ·€åœ¨ `react/` / `form/` ä¸­ï¼Œä½¿ç”¨ç¤ºä¾‹ä¸å·¥ä½œæµåˆ™é›†ä¸­åœ¨ `guide/` ä¸‹ï¼Œé¿å…ä¸å¼•æ“è®¾è®¡æ··æ·†ã€‚
</file>

<file path="README.md">
# Logix Specifications

> **Status**: Living Documentation
> **Context**: `v3/ai-native`

æœ¬æ–‡æ¡£æ˜¯ Logix è§„èŒƒä½“ç³»çš„æ€»ç´¢å¼•ã€‚

## 1. Core Specifications (The Truth)

ç¡®å®šæ€§é«˜ã€å·²è¿›å…¥å®æ–½é˜¶æ®µçš„æ ¸å¿ƒè§„èŒƒã€‚

- **[Intent-Driven AI Coding](./intent-driven-ai-coding/v3/README.md)**
  - å¹³å°ä¸»çº¿ï¼šUI/Logic/Domain ä¸‰ä½ä¸€ä½“ + Flow/Logix è®¾è®¡ä¸è¿è¡Œæ—¶å¥‘çº¦ã€‚
- **[Runtime Logix](./runtime-logix/README.md)**
  - è¿è¡Œæ—¶ä¸»çº¿ï¼šLogix Engine, Behavior & Flow Intent çš„ç»Ÿä¸€å‰ç«¯è¿è¡Œæ—¶ PoCã€‚

## 2. Drafts & Topics (The Lab)

æ­£åœ¨å­µåŒ–ã€æ¢è®¨æˆ–ä½œä¸ºç‰¹å®šä¸»é¢˜å‚è€ƒçš„è‰ç¨¿æ–‡æ¡£ã€‚

- **[Drafts Index](./drafts/README.md)**
  - åŒ…å«æŒ‰ä¸»é¢˜åˆ†ç±»çš„è‰ç¨¿ (`topics/`) å’ŒæŒ‰æˆç†Ÿåº¦åˆ†çº§çš„è‰ç¨¿ (`L1~L9`)ã€‚

---

## Directory Structure

```
docs/specs/
â”œâ”€â”€ intent-driven-ai-coding/  # Platform Specs (v3)
â”œâ”€â”€ runtime-logix/            # Runtime Specs
â””â”€â”€ drafts/                   # Drafts & Topics
    â”œâ”€â”€ topics/               # Consolidated Topics (AI UI, Core API...)
    â””â”€â”€ L1~L9/                # Tiered Drafts
```
</file>

</files>
