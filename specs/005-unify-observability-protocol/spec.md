# Feature Specification: 统一观测协议与聚合引擎（平台协议层优先）

**Feature Branch**: `005-unify-observability-protocol`  
**Created**: 2025-12-13  
**Status**: Draft  
**Input**: User description: "统一组件/插件/平台协议层的观测协议与聚合引擎（Playground 可选验证）"

## Assumptions

- “Sandbox/Alignment Lab/Playground”当前仅作为实验性验证路径：用于验证浏览器环境（含 Worker）中可运行与可观测；其存在与形态不作为平台功能承诺。
- 第一阶段必须同时覆盖两种宿主：应用内嵌开发面板（组件形态）与浏览器扩展面板（独立窗口）；两者复用同一套观测协议与聚合引擎，保证核心结论一致。
- 本能力主要服务于开发与测试场景；在生产环境中默认以“最小开销”模式运行或关闭高成本观测。
- “时间旅行/回放”只作用于可回放的运行时状态；不承诺回滚外部副作用（网络、存储、第三方系统）。
- 观测负载策略可配置（抽样、摘要、按需细节）；对已记录字段默认保留原始值（不脱敏、不做风险提示）。
- 平台会逐步引入需求侧锚点（例如「场景（Scenario）/步骤（Step）」），用于把运行证据映射回需求意图；是否在某个前端 Playground 中展示不影响本特性的成立。

## Out of Scope

- 不以覆盖所有第三方依赖与所有 UI 框架为目标；重点保证“可运行、可观测、可验证”的主路径体验。
- 不在本特性中一次性完成 AI 自动评分/自动修复闭环；本特性只输出结构化证据与对齐所需的基础数据。
- 不承诺交付“完整 Playground 产品”；如存在实验性 Playground，其职责是消费协议并验证平台能力，而非成为事实源。
- 不考虑敏感数据保护与合规要求；证据包默认保留原始数据且不做风险提示。

## Dependencies

- 运行环境能够产生基础观测信号（至少包含错误、关键事件、执行轨迹或等价证据），否则无法支撑一致视图与对齐。
- 运行环境能够为同一运行会话提供权威的事件顺序信息（主排序键），否则无法保证跨宿主导出/导入后的顺序稳定复现。
- 平台能够提供场景/步骤等需求侧锚点信息（或等价结构），以便把运行证据映射回需求侧结构。
- 浏览器扩展在目标浏览器安全模型允许的范围内与当前页面建立连接；若受限，需要提供可用的降级体验。

## Clarifications

### Session 2025-12-13

- Q: 证据包的默认敏感数据策略是什么？ → A: 默认保留原始数据，不做脱敏，也不提示风险。
- Q: 证据包/协议的版本不匹配策略是什么？ → A: 版本标记 + 尽力兼容；无法理解的部分降级展示并明确提示缺失。
- Q: 证据包的默认粒度是什么？ → A: 默认只包含单次运行（一个 runId）。
- Q: 观测事件的稳定身份与时间信息由谁生成？ → A: 由运行环境生成。
- Q: 同一 runId 内事件排序语义是什么？ → A: 由运行环境生成全局单调递增序号（seq）作为主排序键；时间戳仅作展示/辅助。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 同一份观测数据在不同宿主可一致消费（Priority: P1）

作为开发者/平台维护者，我希望同一份运行的观测证据可以在不同宿主中被一致消费（不依赖某一种 UI 形态），并获得一致的核心观察结果，例如：

- 平台/工具侧的 Devtools 视图（例如独立窗口、浏览器扩展或其他形态）；
- 应用内嵌的开发面板（组件形态）；
- 实验性前端 Playground（可选，用于验证浏览器/Worker 运行）。

我也希望能把一次运行的观测记录导出为“证据包”，并在另一种宿主里导入查看，以便协作、复现与审核。

**Why this priority**: 这是多端共用协议/聚合层的核心价值来源。没有一致性与可携带性，Devtools 会持续分裂，平台的验证与回归证据也难以沉淀与复用。

**Independent Test**: 对同一段业务逻辑（同一运行会话），在任一宿主产出一份观测证据包；在另一宿主导入后，仍能得到相同的事件时间线、关键计数与诊断结论。

**Acceptance Scenarios**:

1. **Given** 一个可运行的示例场景且观测能力已启用，**When** 用户在应用内嵌面板中查看并导出本次运行的观测证据包，**Then** 证据包包含完整的运行标识、事件序列、关键指标与错误/诊断信息，并可被保存与分享。
2. **Given** 一份由应用内嵌面板导出的观测证据包，**When** 用户在浏览器扩展面板中导入并打开同一套视图，**Then** 该视图展示的关键计数与事件顺序与导出时一致，且不会出现无法解释的缺失/重复。

---

### User Story 2 - 平台可将需求锚点映射到运行证据（Scenario/Step 覆盖）（Priority: P2）

作为 PM/开发者/审核者，我希望平台能把需求侧锚点（例如场景/步骤）映射到运行证据，以便做验证与回归：

- 可以看到该场景各步骤（Step）的命中情况（covered/pending）；
- 当某个步骤未命中或结果异常时，可以从该步骤直接追溯到对应的证据（例如关键事件、日志、执行轨迹、状态快照）。

**Why this priority**: 平台的北极星是“可验证的意图落地”。如果无法把需求锚点与运行证据对齐，平台在验证与回归层面会缺少可复用的证据结构。

**Independent Test**: 选择一个典型场景（例如省市区联动），在任一浏览器运行入口产出一份证据包后，即可基于该证据包计算 Step 覆盖，并能在某个查看器中定位每个 Step 的关联证据（查看器可以是实验性 Playground 或其他工具视图）。

**Acceptance Scenarios**:

1. **Given** 一个包含多个步骤的场景定义，**When** 用户完成一次运行并产出观测证据包，**Then** 每个步骤都能被标记为 covered 或 pending，且这些标记与本次运行实际发出的 UI 意图信号一致。
2. **Given** 某个步骤被标记为 pending 或出现错误，**When** 用户在某个查看器中点击该步骤查看详情，**Then** 查看器能展示该步骤相关的证据摘要，并允许进一步查看对应事件/轨迹/日志片段以辅助定位原因。

---

### User Story 3 - 浏览器扩展提供独立窗口与更低干扰的观测体验（Priority: P1）

作为注重性能与真实性的开发者，我希望将 Devtools 面板移出被测页面的主 UI 区域，以便：

- 在多屏或分屏场景中独立查看 Devtools；
- 降低 Devtools UI 渲染对被测页面主线程的干扰，从而提升“渲染压力/概览指标”的可信度。

**Why this priority**: 组件形态开发便利但可能影响被测页面。独立窗口能力可以把“观察者效应”控制在更可接受范围内，是追求卓越观测体验的重要一环。

**Independent Test**: 在同一个示例应用中打开插件形态面板；插件形态能够独立展示页面运行会话的观测视图并提供独立窗口体验；若应用同时提供内嵌面板，则两者展示的关键结论一致。

**Acceptance Scenarios**:

1. **Given** 用户已打开一个启用观测的页面，**When** 用户打开浏览器扩展的 Devtools 面板，**Then** 面板可以连接到当前页面的运行会话并展示实时更新的关键视图（时间线、概览、错误/诊断）。
2. **Given** 运行会话处于高频事件场景，**When** 用户在插件形态面板中进行筛选、切换视图、查看详情，**Then** 面板保持可用与响应，且被测页面的交互体验没有出现明显劣化。

---

### Edge Cases

- 高事件密度导致观测数据过载：系统应在不崩溃的前提下保留关键证据，并明确提示丢弃/降级情况。
- 单条事件携带的大对象过大（例如完整状态快照/大 payload）：系统应默认使用摘要或按需获取，避免拖慢被测页面。
- 事件 payload 无法跨宿主持久化/传输（例如函数、循环引用、不可结构化克隆对象）：系统应提供可预测的降级表示，并保证核心计数与事件顺序仍可复现。
- 不同宿主/版本之间的协议不兼容：系统应明确提示版本不匹配并提供可操作的降级路径。
- 多来源并发事件导致时间戳不稳定：系统应仍能基于主排序键给出可复现的全序，避免导入后顺序漂移。
- 运行会话中断、断线重连或运行容器被终止（例如 Worker 被终止）：系统应给出清晰状态，保证导出/导入/重连行为可预测。
- 用户触发“控制命令”（清空、暂停、回放等）但运行环境不支持：系统应返回明确反馈且不影响其他观测能力。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须定义并维护一套跨宿主一致的观测数据模型，覆盖：运行标识、事件序列、执行轨迹、UI 意图信号、错误与诊断、状态快照（可选）。
- **FR-002**: 系统必须在观测信号产生处为每条观测事件生成稳定的身份、时间信息与同一 runId 内全局单调递增的主排序键（例如 seq），以支持跨窗口/跨进程传输后的排序、去重与重放；查看器不得自行“补造”这些信息导致同一事件在不同宿主中不一致。
- **FR-003**: 系统必须提供“可导出/可导入”的运行证据包能力，用于分享、复现与审核；证据包默认只包含单次运行（一个 runId）；导入后必须能够还原核心视图与关键指标。
- **FR-004**: 系统必须支持在不同宿主中以一致方式呈现核心 Devtools 视图集合：运行对象列表、事件时间线、概览指标、错误/诊断视图、详情查看（事件/轨迹/状态）。
- **FR-005**: 系统必须支持将需求锚点（例如场景/步骤）与运行证据关联，并支持基于观测证据包计算覆盖情况；查看器应支持从锚点追溯到关联证据。
- **FR-006**: 系统必须支持可配置的观测负载策略（例如降级、抽样、摘要、按需细节），并确保该策略的效果对用户可见且可解释。
- **FR-007**: 系统必须支持基础的观测控制命令（至少包含清空/暂停/恢复），并在不同宿主中保持行为一致；当某宿主不支持时必须返回明确反馈。
- **FR-008**: 当运行环境支持状态回放时，系统应允许用户触发“回放到历史点/回到最新”的调试操作，并明确告知其边界（仅状态，不回滚外部副作用）。
- **FR-009**: 系统必须在证据包与实时事件流中携带协议版本；当接收端无法完全理解数据时，必须尽力兼容并以降级方式展示不支持部分，同时明确提示缺失，且不得崩溃。
- **FR-010**: 系统必须默认保留原始数据并提供无提示的导出/导入体验；不得强制脱敏或弹出风险提示。
- **FR-011**: 系统必须提供宿主无关的聚合引擎：输入观测事件流或证据包，输出用于核心视图的聚合快照；同一输入必须在组件形态与插件形态中得到一致输出。

### Key Entities *(include if feature involves data)*

- **观测事件（Observation Event）**：一次可观测的事实记录，包含类型、主排序键（例如 seq）、时间、关联对象（运行/模块/实例/场景步骤）、以及可选的证据摘要。
- **运行会话/证据包（Session / Evidence Package）**：对一次或多次运行的可分享记录，包含会话标识、版本信息、事件集合、关键指标摘要与必要的状态快照。
- **场景与步骤（Scenario / Step）**：需求侧的验证锚点，用于表达用户故事中的关键节点，并与 UI 意图信号和观测证据关联。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在典型开发环境下开启 Devtools 后，被测页面的关键交互延迟增幅不超过 10%，且 Devtools 面板的常用操作（切换视图/筛选/展开详情）在 200ms 内可见结果。
- **SC-002**: 对同一份运行证据包，在应用内嵌面板与浏览器扩展面板中展示的核心计数（事件总数、关键分类计数、步骤命中数）一致，且事件顺序（基于主排序键）可稳定复现。
- **SC-003**: 支持至少 10,000 条观测事件的运行证据包导出与导入；导入后 5 秒内可进行筛选与查看详情。
- **SC-004**: 对一个包含 ≥3 个步骤的示例场景，一次运行产出证据包后能明确显示每个步骤的 covered/pending，并能在 3 次点击以内定位到某个 pending/失败步骤的主要证据来源（轨迹/日志/诊断之一）。
