# Feature Specification: Trait 运行时性能上限提升（极致优化）

**Feature Branch**: `006-optimize-traits`
**Created**: 2025-12-13
**Status**: Draft
**Input**: User description: "把能想到的优化做到极致，trait 决定了以蓝图意图为核心的体系的性能上限"

## Assumptions

- “Trait”指：由基础状态字段派生/联动出校验、汇总、默认值、联动字段等的声明式规则集合；Trait 是蓝图意图落地到运行时的核心机制之一。
- 本特性以“高频用户输入 + 多字段联动/校验/汇总”的典型 ToB 表单场景为主基准，不以一次性覆盖所有场景为目标。
- 性能优化必须以语义正确为前提：在相同输入与相同 Trait 定义下，最终对外可观察的状态结果一致且可解释。
- 允许为追求性能与语义一致性进行大规模重构；不要求向后兼容历史实现细节。

## Out of Scope

- 不新增新的业务能力（例如新增一种 Trait 类型或全新 DSL）；本特性聚焦于让既有 Trait 能力“更快、更稳、更可观测”。
- 不承诺把任何长耗时/外部 IO 的业务流程塞进 Trait；Trait 仍以短窗口、可收敛的派生为主。
- 不以“某个具体 UI 框架/渲染器的优化”为目标；只关注运行时 trait/事务语义与其可观测结果。

## Dependencies

- 需要真实复杂表单基准场景（可重复、可对比），用于验证真实交互体验与派生正确性。
- 需要可调合成压力基准场景（可重复、可对比），用于规模回归与对比（例如规模提升 10 倍：规则规模与数据规模同时提升，使单次输入触发的依赖边数约 10 倍）。
- 需要可观测信号来验证优化是否真实生效（例如：事务边界、派生触发与耗时、以及与用户交互关联的摘要）。

## Clarifications

### Session 2025-12-13

- Q: Operation Window 的权威边界是什么？ → A: Operation Window = 一次 action 派发（一次业务动作/dispatch）。
- Q: 多条 Trait 同时写回同一目标字段如何处理？ → A: 视为配置错误：阻止本次收敛/提交，并输出明确诊断。
- Q: 派生发生错误/超预算时的失败与降级策略是什么？ → A: 分级策略：配置错误（冲突/循环）硬失败；运行时错误/超预算软降级（提交基础变更，派生冻结），并输出诊断。
- Q: 验收与回归的基准场景选择是什么？ → A: 同时要求“真实复杂表单基准场景”与“可调合成压力基准场景”；前者验证真实体验，后者用于规模回归。
- Q: “等价”判定标准是什么？ → A: 以“对外可观察的值相同”为等价（用户可见无差异）。
- Q: “超预算”阈值默认是多少？ → A: 默认阈值 200ms（超过即触发软降级）。
- Q: 可调合成压力基准中的“规模提升 10 倍”放大哪个维度？ → A: 组合 10x：规则规模与数据规模同时提升，目标是“单次输入触发的依赖边数”约 10 倍。
- Q: “单次提交=1”是否允许无变化时为 0 次？ → A: 允许 0 或 1：若最终对外可观察状态等价则 0 次，否则 1 次。
- Q: 诊断信号默认保留多长时间？ → A: 默认保留 60s 历史，用于排查偶发抖动/长尾。
- Q: 诊断等级默认用哪一档？ → A: 默认高可观测（以开发/调试场景为主）。

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 高频交互仍然流畅且结果稳定 (Priority: P1)

作为业务开发者，我希望在复杂表单中持续输入/修改时：

- 输入不丢字符、页面保持可用；
- 由 Trait 驱动的联动字段、校验提示与汇总信息在可接受时间内稳定更新；
- 同一段交互的表现可重复（不会时快时慢、或出现偶发“抖动”）。

**Why this priority**: 这是“蓝图意图可用于真实业务”的底线体验；如果高频输入场景不稳，Trait 的上层体系无从谈起。

**Independent Test**: 在基准复杂表单场景中，进行持续 60 秒的输入/修改操作；能观察到交互持续可用、派生结果稳定，并满足 Success Criteria 的响应指标。

**Acceptance Scenarios**:

1. **Given** 一个包含多字段联动、校验与汇总的复杂表单场景，**When** 用户在单个输入框中连续输入 60 秒（包含快速输入与删除），**Then** 输入不丢失且 UI 始终可交互，同时相关派生字段在可接受时间内更新到正确值。
2. **Given** 同一复杂表单场景与相同的输入序列，**When** 重复执行两次，**Then** 两次得到的最终状态结果一致，且性能表现没有显著劣化或偶发抖动。
3. **Given** 某条派生规则在本次操作窗口内发生运行时错误或成本超出预期，**When** 用户继续触发输入驱动操作，**Then** 基础字段变更仍可被正常提交且交互保持可用，而派生字段保持上一次稳定结果，并出现明确诊断提示说明本次发生了软降级。

---

### User Story 2 - 单次用户操作的派生应收敛为一次可观察状态提交 (Priority: P1)

作为运行时/平台开发者，我希望一次用户操作（一次 action 派发）在状态层面表现为“单次可观察的最终提交”：

- 所有由该操作引起的 Trait 派生、联动与校验更新能够在同一操作窗口内收敛；
- 订阅者（UI、观察器、调试面板）只需要处理一次最终状态提交，而不是被多次中间提交“切碎”。

**Why this priority**: 多次中间提交会放大渲染与派生开销，并显著降低调试可读性；它是“性能上限”与“可解释性上限”的共同瓶颈。

**Independent Test**: 在真实复杂表单基准场景中触发一次用户操作，验证该操作窗口内对外可观察的状态提交次数不超过 1 次，并且派生字段已完成收敛且正确。

**Acceptance Scenarios**:

1. **Given** 一个启用了多条 Trait 的模块实例，**When** 用户触发一次字段修改操作，**Then** 所有关联的联动/校验/汇总结果在一次可观察的最终状态提交后达到一致且正确的最终状态。
2. **Given** 一个包含多条联动链（A 影响 B，B 影响 C）的场景，**When** 用户只修改 A，**Then** B 与 C 的最终值在同一操作窗口内收敛完成，并且不会出现“多次提交逐步逼近最终值”的现象。

---

### User Story 3 - 派生触发必须精准且可解释 (Priority: P2)

作为业务开发者与运行时维护者，我希望 Trait 的派生触发具备“最小必要性”与“可解释性”：

- 只有当依赖字段发生变化时，相关 Trait 才会执行；
- 当派生结果与当前值等价时，不应产生新的状态提交或噪音事件；
- 当出现循环依赖、不收敛或高开销派生时，系统能给出清晰、可定位、可行动的提示。

**Why this priority**: “无效重算”与“无意义写回”会在规模扩大时指数级放大成本；而缺乏解释会使团队只能靠猜测调参，无法建立可持续的性能工程闭环。

**Independent Test**: 在真实复杂表单基准场景中只修改一个与部分 Trait 无关的字段，验证无关 Trait 不会被触发；再构造一个循环依赖/不收敛示例，验证系统能给出明确提示且不会导致卡死。

**Acceptance Scenarios**:

1. **Given** 一个包含多条 Trait 的场景，且其中一部分 Trait 与字段 X 无依赖关系，**When** 用户只修改字段 X，**Then** 与 X 无关的 Trait 不会执行，且不会产生额外的状态提交噪音。
2. **Given** 一个存在循环依赖或无法收敛的 Trait 组合，**When** 触发相关输入，**Then** 系统不会卡死或无限更新，并提供明确提示说明问题与影响范围。
3. **Given** 一个存在多条 Trait 同时写回同一目标字段的场景，**When** 触发相关输入，**Then** 系统阻止本次操作窗口产生新的状态提交，并给出明确诊断说明冲突目标字段与涉及规则范围。

---

### Edge Cases

- Trait 存在循环依赖、振荡或无法收敛：视为配置错误，阻止本次收敛/提交，并输出明确诊断，且不得造成持续卡顿。
- 多条 Trait 同时写回同一目标字段：视为配置错误，阻止本次收敛/提交，并输出明确诊断（至少包含目标字段与涉及规则范围）。
- 大状态/大列表场景：系统应确保派生开销主要与“依赖规模”相关，而不是与整个状态大小线性绑定。
- 极端高频输入（持续输入、粘贴、撤销/重做）：系统应避免积压导致的长尾卡顿，并保证最终状态正确。
- 派生函数发生错误或成本超出预期：系统应采用软降级策略，仍提交基础字段变更、派生字段保持上一次稳定结果，并提供可定位的错误/超预算诊断提示。

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系统必须将 Trait 视为“可声明依赖”的派生规则，并基于依赖关系最小化触发范围：只有依赖发生变化的 Trait 才允许执行。
- **FR-002**: 系统必须避免“无意义写回”：当某个 Trait 的派生结果与目标字段现值等价（以对外可观察的值相同为准）时，系统不得产生新的对外可观察状态提交。
- **FR-003**: 系统必须保证单次用户操作窗口内的派生更新可收敛，并对外产生 0 或 1 次最终状态提交：若最终对外可观察状态与操作前等价则 0 次，否则 1 次（除非该操作被显式拆分为多个独立操作）。
- **FR-004**: 系统必须保证派生传播具有确定性：在同一输入序列下，最终状态一致且可重复复现。
- **FR-005**: 系统必须支持联动链的拓扑传播，确保“上游变化 → 下游派生”最终收敛到稳定状态，而不是依赖运气或执行时序。
- **FR-006**: 系统必须检测并处理循环依赖、不收敛或振荡：不得无限更新；必须给出可理解的诊断信息，至少包含：涉及的字段范围、涉及的规则集合（可读标识/标签）、以及本次操作窗口是否被中止或降级。
- **FR-014**: 系统必须检测同一 Operation Window 内多条 Trait 试图写回同一目标字段的冲突，并视为配置错误：本次 Operation Window 不得产生新的对外可观察状态提交，同时必须输出明确诊断信息（至少包含冲突目标字段与涉及规则集合的可读标识）。
- **FR-007**: 系统必须在不引入额外业务负担的前提下，提供“派生成本的可解释信号”，至少能回答：本次操作窗口触发了哪些规则、哪些规则被跳过（因为结果等价：对外可观察的值相同）、以及最耗时的前 3 条规则是谁（可读标识）及其耗时等级。
- **FR-008**: 系统必须保证状态订阅者不会观察到“半成品状态”：在正常路径下，任何对外可观察的状态提交都应是本次操作窗口内的最终收敛结果；在软降级路径下，允许派生字段保持上一次稳定结果，但必须以诊断信号明确标记本次软降级并说明影响范围。
- **FR-009**: 系统必须在派生过程中发生错误或成本超出预期时保持可预测行为：必须采用软降级策略，仍提交基础字段变更并保持交互可用；同时输出可定位的错误/超预算诊断信息。
- **FR-010**: 系统必须允许在“低开销诊断”和“高可观测诊断”两档（或以上）的诊断等级间切换，并明确每一档至少提供的信号范围与其开销边界；默认使用高可观测诊断（以开发/调试场景为主）。
- **FR-011**: 系统必须提供可验证的性能基线与回归方式：至少同时包含“真实复杂表单基准场景”与“可调合成压力基准场景”的说明与复现步骤，使得团队可以在同一版本上重复测得 Success Criteria 的指标，并在后续变更中快速发现性能退化。
- **FR-012**: 系统必须在大状态/大列表规模下保持可扩展性：在可调合成压力基准场景中，对一个“只改动局部字段”的输入，当规模提升 10 倍（规则规模与数据规模同时提升，使单次输入触发的依赖边数约 10 倍）时，该输入的 95% 响应时间不应劣化超过 2 倍。
- **FR-013**: 当派生无法在合理时间内收敛或超出预期成本（默认阈值 200ms）时，系统必须优先保证交互可用：及时终止/降级本次派生，并以诊断信号提示原因与影响范围。
- **FR-015**: 系统必须采用分级失败与降级策略：配置错误（例如冲突写回、循环依赖）必须硬失败并阻止本次收敛/提交；运行时错误或成本超出预期必须软降级（提交基础字段变更、派生字段冻结在上一次稳定结果），并输出明确诊断。

### Key Entities _(include if feature involves data)_

- **Trait Rule**: 一条派生/联动/校验/汇总规则，包含目标字段与其依赖字段集合。
- **Dependency Graph**: Trait 规则间的依赖关系图，用于确定最小触发范围与传播顺序。
- **Operation Window**: 一次 action 派发对应的“收敛窗口”，用于界定本次操作的派生与最终提交边界。
- **Transaction (Observable Commit)**: 对外可观察的一次最终状态提交，订阅者以此为单位接收状态更新。
- **Base Fields**: 在一次 Operation Window 中由用户输入或业务动作直接写入的字段，不由 Trait 规则维护。
- **Derived Fields**: 由 Trait 规则维护/写回的字段，用于联动、校验、汇总等派生信息。
- **Diagnostic Signal**: 用于解释派生成本与异常（循环/不收敛/高开销/错误）的可见信号与摘要。
- **Diagnostic Retention Window**: 诊断信号在本地默认保留的历史时长，用于排查偶发抖动与长尾（默认 60s）。
- **Benchmark Scenario**: 一组用于验收与回归的基准交互与规模参数，至少包含真实复杂表单与可调合成压力两类。

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 在基准复杂表单场景中，单次用户操作（一次 action 派发）对应的对外可观察状态提交次数为 0 或 1：若最终对外可观察状态与操作前等价则 0 次，否则 1 次。
- **SC-002**: 在基准复杂表单场景中，连续输入 60 秒过程中，丢字符率 = 0，且交互始终可用（无“需要等待数秒才能继续输入”的卡顿）。
- **SC-003**: 在基准复杂表单场景中，95% 的输入驱动操作（对应一次 action 派发）在 100ms 内完成“相关派生字段更新到最终稳定结果”的可见反馈。
- **SC-004**: 在至少一个“只改动局部字段”的场景中，与该字段无依赖关系的 Trait 触发次数 = 0（以诊断信号或等价可验证方式衡量）。
- **SC-005**: 在构造的循环依赖/不收敛场景中，系统不会无限更新或卡死，并阻止本次操作窗口产生新的状态提交，同时在 1 秒内给出明确的诊断提示（包含问题范围与建议动作）。
- **SC-006**: 在可调合成压力基准场景中，当规模提升 10 倍（规则规模与数据规模同时提升，使单次输入触发的依赖边数约 10 倍）时，局部字段输入的 95% 响应时间劣化不超过 2 倍。
- **SC-007**: 在基准场景的任意一次用户操作窗口中，诊断信号能够明确给出：触发规则数、跳过规则数、以及前 3 条高成本规则（可读标识）与其耗时等级。
- **SC-008**: 在构造的派生运行时错误或成本超出预期（默认阈值 200ms）场景中，系统仍保持交互可用并可提交基础字段变更，同时在 1 秒内给出软降级诊断提示说明派生字段已冻结。
