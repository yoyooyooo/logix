# Feature Specification: 015 Devtools Converge Performance Pane

**Feature Branch**: `015-devtools-converge-performance`  
**Created**: 2025-12-17  
**Status**: Draft  
**Input**: User description: "为 converge 提供类似浏览器性能面板的深挖视图：多行时间轴 + Audits（可操作建议）+ 可复制代码片段（Provider override 优先）"

## Assumptions

- 本特性是 Devtools 侧能力，服务对象是运行时集成者/业务开发者/性能排障者。
- 所有“事实输入”来自可序列化证据事件；Devtools 不读取运行时内部状态，也不做“猜测补全”。
- 同一份证据在不同宿主形态（内嵌面板/浏览器扩展/离线导入）中应得出一致结论（排序、计数、审计命中）。

## Out of Scope

- 不改变 converge 的运行时算法与证据字段定义（由 converge 特性本身负责）。
- 不定义新的通用观测协议外壳/聚合底座（由观测协议特性负责）。
- 不要求替代全局通用时间轴；本特性只交付 converge 的“深挖入口”。
- MVP 不强制要求浏览器扩展形态的实时一致性验证；扩展接入属于后续阶段。
- Audits 不输出结构性改造建议（例如拆模块/重构依赖图）；仅提供“局部止血”可复制代码片段。

## Clarifications

### Session 2025-12-17

- Q: MVP 需要保证“结论一致”的宿主形态是哪两类？ → A: 内嵌 Devtools 面板（live）+ 离线导入证据包
- Q: Audits 的“建议 + 代码片段”默认输出几档？ → A: 两档：Provider 范围覆盖（优先）+ 模块级覆盖（兜底）
- Q: 证据包缺少“全局排序键”时，Timeline 的排序策略是什么？ → A: 使用“实例内单调序号”保证确定性排序；时间戳仅用于展示

## Dependencies

- 统一观测协议与聚合底座（支持 live 与离线证据包导入；提供稳定排序与窗口聚合）。
- 运行时调试事件 SSoT（事件锚点、分档语义、Slim 与可序列化约束）。
- converge 证据事件（包含：请求策略、实际执行策略、原因、预算、耗时、配置来源、影响面统计、缓存/代际信号等）。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 快速定位 converge 回归并给出“下一步行动” (Priority: P1)

作为性能排障者，我希望在 Devtools 里选中一个模块实例/时间窗口后，能看到 converge 相关事务的时间轴与关键原因，并直接拿到“下一步怎么做”的建议与可复制代码片段，以便快速止血与纳入回归防线。

**Why this priority**: 没有“能指导行动”的深挖入口，证据再全也会退化为人工对照与补丁化。

**Independent Test**: 通过导入一份包含 converge 证据的证据包，选择一个时间窗口，能稳定得到：时间轴（含分段）+ 至少一条可执行建议 + 可复制代码片段。

**Acceptance Scenarios**:

1. **Given** 一份包含 converge 证据的证据包，**When** 用户筛选到某模块实例并框选时间窗口，**Then** 面板展示该窗口内 converge 事务的多行时间轴，并能对每笔事务展示关键标签（执行路径、原因、配置来源）。
2. **Given** 某些事务出现明显异常信号（例如频繁回退/频繁失效/预算止损），**When** 用户查看该窗口的审计结果，**Then** 面板输出稳定的审计条目（含 ID、解释、下一步建议）以及可复制代码片段（优先 Provider 范围覆盖，其次模块级覆盖）。

---

### User Story 2 - 证据不足时也不误导（优雅降级） (Priority: P2)

作为调试者，我希望在证据不完整（例如仅保留最小档位）的情况下，面板仍能展示“能展示的事实”，并明确提示缺失字段带来的能力限制，而不是输出误导性的结论。

**Why this priority**: 诊断分档是常态；误导性的建议会比没有建议更糟糕。

**Independent Test**: 用一份“字段裁剪后的证据包”打开面板，验证不崩溃、不白屏，且所有缺失能力都以明确提示呈现。

**Acceptance Scenarios**:

1. **Given** converge 证据缺失部分字段（例如热点细节或更细粒度 trace），**When** 用户打开 converge pane，**Then** 时间轴与概要仍可用，并以“证据不足”方式展示缺失原因与影响范围。

---

### User Story 3 - 不同宿主形态结论一致 (Priority: P3)

作为平台集成者，我希望同一份证据在不同宿主形态（内嵌面板、离线导入）中看到的排序、计数与审计命中一致，以便团队协作复现与审核。

**Why this priority**: 不一致会直接破坏信任，导致证据链不可交接。

**Independent Test**: 将同一份证据包在内嵌面板与离线导入两种形态中打开，对比 converge pane 的关键结果一致。

**Acceptance Scenarios**:

1. **Given** 同一份证据包，**When** 分别在内嵌面板与离线导入两种形态中打开 converge pane，**Then** converge 事务数量、排序、审计命中结果一致（允许 UI 呈现差异，但结论一致）。

---

### Edge Cases

- 证据包存在未知版本/未知字段：必须忽略未知部分并明确提示“部分能力不可用”，不得崩溃。
- 证据排序键缺失或不连续：必须按既定排序语义处理，并对“不可完全保证排序”的情况给出提示。
- converge 证据完全不存在：面板提供空态说明与引导（如何开启/导入证据）。
- 证据量很大导致渲染压力：必须有可预测的降级路径（例如降低刷新频率/仅渲染可见窗口），并对用户可见。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 提供 converge 专用的性能深挖入口：多行时间轴展示 converge 相关事务，并可按模块实例进行分组与过滤。
- **FR-002**: 系统 MUST 对每笔 converge 事务展示“决策阶段”与“执行阶段”的耗时分段，并展示该事务的关键标签：实际执行路径、原因、配置来源。
- **FR-003**: 系统 MUST 提供可序列化的 Audits 输出：每条 audit 必须包含稳定 ID、问题解释、下一步建议与所需证据前置条件（证据不足则明确降级）。
- **FR-004**: 系统 MUST 为 Audits 提供“可复制代码片段”，默认只输出两档“局部止血”：Provider 范围覆盖（优先）+ 模块级覆盖（兜底）；并明确覆盖优先级与影响范围。
- **FR-005**: 系统 MUST 支持离线证据包导入后的同等能力（时间轴、审计、建议），并保证同一输入在不同宿主形态下结论一致。

### Non-Functional Requirements (Performance & Diagnosability)

- **NFR-001**: 系统 MUST 明确降级语义：证据缺字段时不得输出误导结论；所有审计与建议必须能解释其证据依据。
- **NFR-002**: 系统 MUST 在常规规模证据包下保证交互流畅（例如筛选/选择/缩放在 200ms 内可见结果）；在高密度/大包场景下必须进入可预测的性能保护模式且对用户可见。
- **NFR-003**: 系统 MUST 不引入第二套真相源：面板展示与 Audits 的唯一输入来自可序列化证据事件与聚合快照。
- **NFR-004**: 系统 MUST 使用确定性排序：当全局排序键不可用时，必须退回到“实例内单调序号”的稳定排序；时间戳仅用于展示，不得作为唯一权威排序键。

### Key Entities *(include if feature involves data)*

- **Converge Transaction**: 一笔与 converge 相关的事务记录，包含决策/执行耗时、执行路径、原因、配置来源与影响面统计。
- **Converge Audit Finding**: 一条可序列化的审计结果（稳定 ID、解释、建议、证据要求、严重性）。
- **Action Snippet**: 一段可复制的配置代码片段，用于局部止血或回收覆盖（明确作用域与优先级）。
- **Evidence Package**: 一份可导入/可分享的运行证据包，用于复现与审核。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户能在导入一份含 converge 证据的证据包后，于 2 分钟内完成“定位问题事务窗口 + 获得至少 1 条可执行建议 + 复制代码片段”的闭环。
- **SC-002**: 在证据不完整时，面板不崩溃、不白屏，并能明确指出缺失字段导致的能力降级范围（审计条目以“证据不足”降级而不是误导）。
- **SC-003**: 同一份证据包在两种宿主形态下的关键结论一致：事务数量、排序、审计命中一致（允许 UI 呈现差异）。
- **SC-004**: 常用交互（筛选/选择/缩放）在常规规模证据包下 200ms 内可见结果；大包场景进入可预测降级模式且对用户可见。
