# Feature Specification: Form API 收敛与 DX 提升

**Feature Branch**: `[028-form-api-dx]`  
**Created**: 2025-12-23  
**Status**: Draft  
**Input**: User description: "Form API 收敛、开发体验提升，并治理表单包内部的超大文件与可维护性问题。"

## Assumptions

- 不保证向后兼容：允许一次性破坏式调整公共接口；但必须提供迁移说明并同步更新一方示例与文档。
- 目标用户是“表单作者（业务开发者/LLM）”与“表单包维护者”；本需求的价值以开发体验、可维护性与可诊断性为主。
- 新的“推荐写法”必须可完全降解到统一最小表示（声明 + 可回放证据），不引入第二套事实源。

## Out of Scope

- 不引入新的“异步校验范式”：异步需求仍应通过既有的外部资源/数据机制表达，而不是在一次交互的同步窗口内执行外部请求/耗时不确定的工作。
- 不把本需求扩展为“重写运行时事务系统”；本需求聚焦于表单领域包的公共接口与内部可维护性治理。
- 不尝试保留旧写法的兼容层；采用迁移说明替代兼容层。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 用更少概念完成复杂表单 (Priority: P1)

作为表单作者，我可以只用“少量独立概念”定义复杂表单：业务值、派生联动、校验规则、动态列表规则；无需理解底层扩展结构的嵌套细节也能写对，并且错误树与列表行稳定对齐。

**Why this priority**: 这是 DX 提升的核心；如果没有这个，后续迁移与内部重构价值都无法体现。

**Independent Test**: 用一个复杂表单示例覆盖：联动字段、条件必填、动态列表（行级/跨行/空列表）与提交校验；验证错误呈现与状态视图一致。

**Acceptance Scenarios**:

1. **Given** 用户邮箱为空，**When** 用户触发提交校验，**Then** 邮箱字段出现可读错误信息，且“可提交”状态为否。
2. **Given** 用户将首选渠道切换为电话且手机号为空，**When** 用户对手机号字段完成一次交互（例如离开输入框或提交），**Then** 手机号字段出现“条件必填”错误；**When** 填入有效手机号后再次交互，**Then** 错误被清理。
3. **Given** 订单行列表存在一行数量≤0 或价格<0，**When** 用户提交或触发对应的列表校验，**Then** 对应行的字段错误落在该行而不是其他行。
4. **Given** 用户删除列表所有行导致列表为空，**When** 用户提交，**Then** 列表出现“至少一行”的列表级错误；**When** 新增一行后再次提交，**Then** 该列表级错误被清理。
5. **Given** 用户修改姓名/邮箱，**When** 值发生变化，**Then** 派生联动字段自动更新且无需手写“写回逻辑”，并且不会写入校验错误分支。
6. **Given** 两个互相关联字段的组合不满足约束（例如两次密码不一致），**When** 用户提交或触发相关校验，**Then** 表单在该字段组/对象层级展示一条“跨字段”的可读错误信息；且该对象下其它字段的错误呈现不被覆盖或丢失。

---

### User Story 2 - 可迁移与可传播的推荐写法 (Priority: P2)

作为团队使用者，我可以在不依赖向后兼容的前提下，获得一套清晰的迁移说明与统一推荐写法：示例、文档与新写法保持一致；底层能力仍可用，但不再迫使普通使用者理解嵌套结构。

**Why this priority**: 破坏式变更若缺少迁移与示例，会导致认知碎片化与 adoption 失败。

**Independent Test**: 选取若干代表性示例（简单字段、复杂联动、动态列表、异步资源/外部数据），全部升级到推荐写法并可演示同等行为；文档不再展示旧写法为默认路径。

**Acceptance Scenarios**:

1. **Given** 仓库内所有一方表单示例与文档，**When** 迁移完成，**Then** 默认教程与示例不再要求读者理解底层扩展结构/列表结构的嵌套细节即可完成表单定义。
2. **Given** 旧写法仍可用于高级扩展，**When** 用户查阅文档，**Then** 能明确区分“推荐路径”与“高级/底层扩展路径”，并说明何时需要后者。
3. **Given** 一份迁移说明，**When** 使用者按步骤迁移一个旧示例，**Then** 能在不引入行为变化的情况下完成迁移，并能解释差异原因（概念对齐）。

---

### User Story 3 - 内部实现可维护、可拆分、可测试 (Priority: P3)

作为表单包维护者，我可以在不牺牲性能与诊断能力的前提下，拆分超大文件、按职责归位核心逻辑；新增一种规则/列表能力时，改动范围更小、更可预测。

**Why this priority**: 只有内部可维护，才能持续演进规则 DSL、性能优化与诊断协议，而不是把复杂度堆在单文件里。

**Independent Test**: 通过代码组织与测试覆盖验证：职责拆分完成、公共行为仍被测试保护、关键诊断事件仍可观测。

**Acceptance Scenarios**:

1. **Given** 当前表单包核心实现存在超大文件，**When** 重构完成，**Then** 核心逻辑按职责拆分为多个模块，单文件规模显著下降（见 FR-009）。
2. **Given** 新增/调整一种规则能力，**When** 维护者实现变更，**Then** 能在小范围模块内完成并有对应测试兜底。

### Edge Cases

- 动态列表缺少稳定行标识时发生“整段替换列表值”：系统如何保持错误不乱跳，以及如何提供可解释的降级提示。
- 嵌套列表（数组中包含数组）与跨层依赖：规则表达是否仍然清晰且可验证。
- 规则函数抛异常：系统应保证错误树不会出现半成品状态，且诊断信号可解释。
- 同一字段同时存在手动错误、规则错误、模型校验错误：优先级与合并策略是否一致且确定。
- 大列表（例如 100+ 行）下的交互：是否能通过“触发策略/依赖声明”避免每次输入全量扫描。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统 MUST 提供一套“收敛后的表单定义入口”，默认只需要少量独立概念即可完成表单定义（业务值、派生联动、校验规则、动态列表规则）；推荐路径不要求用户理解底层扩展结构的细节。
- **FR-002**: 系统 MUST 提供“校验规则入口”，支持常见规则类型（必填、长度、数值、正则、自定义规则）与条件规则，并要求依赖显式声明以支撑增量校验与可解释链路。
- **FR-003**: 系统 MUST 支持动态列表的两类校验：行级校验（只针对某一行）与列表级/跨行校验（可一次扫描多行）；错误必须稳定落在对应行/列表位置，避免因增删改造成错位。
- **FR-004**: 系统 MUST 提供“显式声明列表语义”的方式（行标识 + 行规则 + 列表规则），且推荐写法不得依赖“通过嵌套对象形状自动推断语义”的隐式规则。
- **FR-005**: 系统 MUST 维持单一、确定性的错误树契约，并提供一致的错误优先级规则（手动错误 > 规则错误 > 模型校验错误），且同一字段多错误合并策略必须确定（可预测、可解释）。
- **FR-006**: 系统 MUST 保证派生联动与校验规则的边界清晰：派生联动默认只允许写回业务值与交互态，不允许写入错误分支或表单元信息，避免出现第二套事实源。
- **FR-007**: 系统 MUST 提供迁移说明，并同步更新一方示例与文档到“推荐写法”；文档必须明确区分推荐路径与高级扩展路径。
- **FR-008**: 系统 MUST 保留高级扩展能力（直接使用底层扩展结构），但该能力必须被定位为“高级/底层入口”，不应成为默认写法，也不应破坏推荐路径的简洁性。
- **FR-009**: 系统 MUST 将表单包内部实现按职责拆分，显著降低单文件规模与耦合度；任意单文件的目标上限为 400 行（不含空行与仅导出声明的汇总文件），并形成清晰的模块边界说明。
- **FR-010**: 系统 MUST 提供覆盖关键行为的自动化测试，至少包含：规则触发策略、跨字段依赖、列表行/列表级校验、错误优先级、派生联动边界与异常保护。

### Non-Functional Requirements (Performance & Diagnosability)

- **NFR-001**: 系统 MUST 为关键交互路径定义可复现的性能基线与预算，并在实现前记录基线：字段值变化、字段失焦、列表增删/重排、提交校验。实现后这些路径“至少 95% 的交互完成时间”与内存开销不得超过基线预算（预算阈值见 SC-005）。
- **NFR-002**: 系统 MUST 提供结构化诊断信号，至少覆盖：本次触发了哪些规则（含被跳过的原因）、列表行标识是否降级、模型校验错误如何映射到字段；且诊断在关闭时必须接近零成本。
- **NFR-003**: 系统 MUST 在诊断与回放中使用确定性标识（实例/事务/操作序列），并保证动态列表的行标识具有可解释的稳定性策略与降级提示。
- **NFR-004**: 系统 MUST 强制同步提交边界：规则与派生联动不得在一次交互的同步提交窗口内执行外部请求/异步工作；若需要异步校验/资源，必须以可追踪的外部资源机制表达。
- **NFR-005**: 若本需求引入新的默认策略或改变性能边界，项目 MUST 更新用户文档，给出稳定心智模型（≤5 个关键词）、粗略成本模型与“优化阶梯”（默认 → 观察 → 收窄写入 → 稳定行标识 → 调整触发策略/分片 → 拆分表单）。
- **NFR-006**: 若本需求引入内部协议或跨模块协作点，系统 MUST 将其封装为可注入契约并支持按实例替换（可 mock），同时支持导出 slim、可序列化的证据/IR 以便在受控环境复现实验。

### Key Entities *(include if feature involves data)*

- **表单定义**：用于描述业务值、派生联动、校验规则、动态列表语义与高级扩展入口。
- **校验规则**：一组可组合的规则声明，包含触发策略、依赖声明与确定性的错误产物。
- **动态列表语义**：行标识策略、行级校验与列表级校验的组合，用于保证错误树与行稳定对齐。
- **错误树契约**：手动/规则/模型校验错误的统一结构与优先级/合并规则。
- **迁移说明**：从旧写法到新推荐写法的映射、注意事项与常见坑的解释。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 表单作者可以在不接触底层扩展结构嵌套细节的情况下完成一个“复杂表单示例”（联动 + 条件必填 + 动态列表行/列表级校验），并通过所有 P1 验收场景。
- **SC-002**: 推荐路径的表单定义配置项数量稳定收敛（顶层概念不超过 4 类），且无需在业务侧手动拼装错误树路径或列表 rows 映射。
- **SC-003**: 一方示例与文档全部迁移到推荐写法；默认阅读路径中不再把高级扩展入口作为入门写法展示。
- **SC-004**: 表单包内部实现完成职责拆分：任意单文件不超过 400 行（按 FR-009 口径），并具备可阅读的模块边界说明。
- **SC-005**: 关键交互路径性能不回退：在代表性场景中，至少 95% 的交互完成时间不超过基线 +5%，内存开销不超过基线 +10%（字段输入、失焦、列表增删/重排、提交校验分别度量）。
- **SC-006**: 开发者工具可以解释“为什么出现/消失某个错误”与“为什么某行错误发生错位/降级”，并能给出可追踪的因果链路（规则触发、依赖、写回范围、行标识策略）。
