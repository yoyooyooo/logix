# Contract: I18n（外部实例注入 + 快照订阅 + ready 两档语义）

**Branch**: `029-i18n-root-resolve`

## 1. 目标与非目标

### 1.1 目标

- 宿主可注入一个“符合最小形状（I18nDriver）的外部国际化实例”（可异步初始化/加载语言包；i18next 风格实例可直接作为注入值）。
- UI/业务代码与 Module Logic 共享同一个实例（DX 接近既有 i18n 习惯）。
- Logix 侧提供最小可订阅快照（language/ready/seq）与两档翻译语义（等待/不等待）。
- Logix 侧同时提供 I18n Service（Tag/Layer 注入）与 I18nModule（Root 单例模块）两种形态：同一 Runtime Tree 内共享同一外部实例；变化信号以 I18n Service 的快照为单一事实源；语言切换请求以 I18n Service 为主入口（I18nModule 仅转发）。
- 推荐 message token 作为可回放形态，最终字符串在展示边界生成。

### 1.2 非目标

- 不把完整资源包/词条写入可回放 state 或诊断事件。
- 不引入进程级全局兜底作为正确性语义（多 Tree 时必须隔离）。
- 不在 `@logixjs/i18n` 内引入对特定国际化引擎的强依赖（例如不强依赖 i18next）；由宿主按需安装并以 I18nDriver 最小形状注入。

## 2. 注入契约（per Runtime Tree）

### 2.1 宿主需要提供什么

- 在创建 runtime tree 时，宿主必须把 i18n 能力注入到该 tree 的 root provider（Layer/Env）。
- 注入值必须可被替换与可 mock（用于测试多 Tree 隔离与失败路径）。

#### 2.1.1 I18nDriver（最小形状，IoC/DI 入口）

宿主注入值必须至少满足以下最小形状（i18next 风格；其他引擎可实现同等接口）：

```ts
type I18nDriver = {
  readonly language: string
  readonly isInitialized?: boolean
  readonly t: (key: string, options?: unknown) => string
  readonly changeLanguage: (language: string) => Promise<unknown> | unknown
  readonly on: (event: "initialized" | "languageChanged", handler: (...args: any[]) => void) => unknown
  readonly off: (event: "initialized" | "languageChanged", handler: (...args: any[]) => void) => unknown
}
```

### 2.2 运行时需要保证什么

- Module Logic 通过 root 入口获取 i18n：`yield* $.root.resolve(I18nTag)`；
- 获取到的 i18n 服务必须与宿主注入的外部实例一致（同引用），避免双实例漂移；
- 多 Tree 并存时，各 Tree 必须拿到各自注入的 i18n 服务，禁止跨 Tree 串用。

### 2.3 I18nModule（Root 单例模块，可选形态）

- 运行时可提供 I18nModule 作为 Root 单例模块（用于语法糖/控制面承载），但不得存放完整资源包/词条数据。
- I18nModule 不得另起“语言/就绪事实源”：其任何订阅/变化能力必须复用 I18n Service 的 I18nSnapshot/changes。
- 由于 strict 默认语义，`$.use(I18nModule)` 仍然依赖 imports；若调用方需要绕过局部 scope 明确取全局单例，应使用 root 解析语义（`$.root.resolve(...)` / `Root.resolve(...)`）。

## 3. 快照与订阅（language/ready/seq）

### 3.1 I18nSnapshot（最小字段）

`I18nSnapshot` 必须至少包含：

- 当前语言 `language: string`
- 初始化状态 `init: "pending" | "ready" | "failed"`
- 单调递增序列 `seq: number`

### 3.2 订阅语义

- 语言切换或 init 状态变化时，必须触发快照变化（`seq` +1）。
- 快照必须 Slim 且可序列化，可进入诊断事件（禁止携带实例/函数/大型对象图）。

## 4. 翻译语义（等待/不等待）

### 4.1 不等待（默认推荐）

当 i18n 未就绪时，翻译必须立即返回“可展示回退结果”（优先 `defaultValue`，否则 key），不得阻塞业务流程。

### 4.2 等待就绪（少数场景）

当调用方选择等待模式：

- 若后续变为就绪：返回最终翻译结果；
- 若初始化失败：必须进入可预测降级（优先 `defaultValue`，否则 key），不得无限等待。
- 默认等待上限为 5 秒（支持调用方覆盖）；超过上限必须进入可预测降级（优先 `defaultValue`，否则 key）。
- `defaultValue` 推荐沿用 i18next 的语义承载回退文案。

> 约束：事务窗口禁止 IO；等待就绪属于 Effect 流程边界，不得在同步事务闭包内触发。

### 4.3 请求切换语言（可选）

- 运行时应提供从 Logix 侧发起“请求切换语言”的能力，并以 I18n Service 为主入口。
- 切换请求可能触发外部实例的异步加载：实现必须通过 I18nSnapshot 反映 `init` 状态变化，并在变化时递增 `seq`。
- I18nModule 如提供切换能力，只能转发到 I18n Service，不得绕过 Tree 隔离与变化事实源。

## 5. message token 与渲染边界

### 5.1 产生 token（推荐）

- i18n 服务应提供构造 token 的纯函数（canonicalize 是 MUST；预算校验建议先 soft，后续可升级 hard；避免把不可序列化 token 写入 state）。
- token 结构与预算见 `contracts/message-token.md`。

### 5.2 渲染 token（展示边界）

- UI 可继续使用既有的 i18n 订阅机制（例如 i18next-react），在 re-render 时将 token 翻译为最终字符串；
- 或使用 `I18nSnapshot` 订阅作为触发器：语言变化时 re-render，再翻译 token。

## 6. 行为约束（可测试）

1. **共享一致性**：同一 tree 内，UI 与 Logic 对同一 key 的翻译结果一致。
2. **多 Tree 隔离**：不同 tree 注入不同实例时，互不影响（跨 Tree 污染率 0%）。
3. **ready 两档**：未就绪时不等待立即回退；等待模式在就绪后得到最终结果，失败不无限等待。
