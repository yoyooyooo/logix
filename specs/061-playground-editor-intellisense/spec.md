# Feature Specification: Playground 编辑器智能提示（Logix 全量补全）

**Feature Branch**: `061-playground-editor-intellisense`  
**Created**: 2025-12-29  
**Status**: Draft  
**Input**: User discussion: "examples/logix-sandbox-mvp 的 /playground 路由，编辑器升级为具备完整智能补全能力的编辑器，并且对 Logix 能力尽可能做到可补全/可诊断。"

## Context

`examples/logix-sandbox-mvp` 当前在多个页面存在“代码编辑入口”，但编辑体验仍是基础的文本输入：缺少智能补全、类型诊断、跳转与悬浮信息，导致写 Logix 相关代码时需要频繁查文档、容易拼写/签名错误、反馈回路慢。

本特性目标是在不改变现有示例应用主流程（编辑 → 运行 → 查看输出/诊断）的前提下，把“代码编辑”能力升级到接近本地 IDE 的可用水平。

## Scope

- **In Scope**：示例应用中的“代码编辑入口”（至少包含 `/playground`，并覆盖同类入口，如 `/ir`）。
- **Out of Scope**：多文件工程管理（新建文件/目录、跨文件重构）、远程语言服务器（需要常驻后端进程）、与业务仓库真实依赖图的完全一致性（以示例项目可用为准）、非 Logix 程序代码编辑的其它文本输入（例如 Step Intent Script）。

## Assumptions

- 目标用户是使用示例应用进行探索与验证的开发者（以提升“写对/写快”为核心价值）。
- Playground 用户代码默认以 TypeScript/TSX 进行表达；类型感知能力与验收口径按此语言语义评估。
- 编辑器提供的智能提示能力以“示例项目范围内可用”为验收边界：以示例项目内置示例代码与允许/推荐依赖集合为准，不承诺覆盖任意外部业务仓库或任意远程依赖的全部类型形态。
- 即使“类型感知能力”不可用，也不应阻断示例应用的基础编辑与运行闭环（允许降级可用）。

## Clarifications

### Session 2025-12-29

- AUTO: Q: 本特性覆盖哪些“代码编辑入口”？ → A: 仅覆盖示例应用中的 Logix 程序代码编辑入口：`/playground` 与 `/ir`；其它非代码编辑文本（如 Step Intent Script）不在范围内。
- AUTO: Q: Playground 中用户代码的语言假设是什么？ → A: 默认以 TypeScript/TSX 编写；非 TypeScript 内容可编辑但不承诺类型感知能力。
- AUTO: Q: “示例项目范围内可用”的类型感知覆盖边界是什么？ → A: 以示例项目内置示例代码与允许/推荐依赖集合为准，至少覆盖 Effect 运行时库、Logix Core、Sandbox、React 适配层与 Form 能力包，以及这些依赖类型解析所需的前置类型依赖。
- AUTO: Q: NFR-001 中“可接受时间”具体门槛是多少？ → A: ≤ 500ms 可输入；冷启动首次进入 ≤ 3s 类型感知就绪。
- AUTO: Q: “资源使用不出现无界增长”如何验收？ → A: 在 warm-up 后重复 20 次路由切换与编辑，浏览器内存/性能面板中的 JS heap 不应呈现持续单调增长（允许短期波动）。
- AUTO: Q: TS 编译项 lib 是否包含 DOM？ → A: 默认不包含 DOM（以 WebWorker 语义为准），避免误导用户使用 DOM API 且减少补全污染。
- AUTO: Q: 是否支持 Prettier/自动格式化？ → A: 支持基础格式化（Monaco/TS 语言服务），不引入 Prettier。

### Session 2025-12-30

- AUTO: Q: Playground 代码若导入了不在“允许/推荐依赖集合”中的包，编辑器侧的类型感知口径是什么？ → A: 不承诺类型感知；允许出现“无法解析模块/类型”的诊断，但不阻断基础编辑与运行闭环（可降级继续运行），也不将其视为本特性失败。
- AUTO: Q: 是否要求对 `@logixjs/core-ng` 等“下一代内核”专用 API 做类型感知？ → A: 不要求；本特性仅保证 `@logixjs/core` 及示例工程允许/推荐依赖集合的类型感知能力。

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 编写 Logix 程序时具备完整智能提示与类型诊断 (Priority: P1)

作为使用 Playground 的开发者，我希望在编辑器里编写 Logix 程序时，能获得尽可能完整的智能补全、参数提示、悬浮类型信息、跳转与实时诊断，从而更快写对代码、减少试错与查阅成本。

**Why this priority**: 这是本特性的核心价值；没有“可补全/可诊断”，Playground 只是在浏览器里写代码，无法支撑快速探索与沉淀写法。

**Independent Test**: 打开 `/playground`，基于默认示例（或一段最小 Logix 程序）完成一次“新增 action + 在 logic 中调用 + 观察类型反馈”的编辑闭环：不需要运行代码也能在编辑阶段发现拼写/签名/类型错误。

**Acceptance Scenarios**:

1. **Given** 用户进入 `/playground` 且编辑器已就绪，**When** 用户输入 Logix 的核心对象/能力名（例如模块定义、运行入口、逻辑构造等）并触发补全，**Then** 补全列表与参数提示必须可用，且能显著减少拼写错误。
2. **Given** 用户在模块定义中声明了若干 action 与 state 字段，**When** 用户在逻辑编写处使用“绑定接口”（例如访问 actions/state 相关能力）并触发补全，**Then** 补全结果必须与已声明的 action/state 保持一致（键名与形状可被类型系统识别）。
3. **Given** 用户在代码中引入一个明显的类型错误（例如把不兼容的值赋给字段、调用 action 时参数不符合声明），**When** 用户停止输入等待诊断，**Then** 编辑器必须展示可定位的错误诊断（可指向行列/范围），并能通过悬浮信息解释原因。

---

### User Story 2 - 对 Playground 允许使用的依赖具备一致的类型感知能力 (Priority: P2)

作为使用 Playground 的开发者，我希望对示例项目中“允许在 Playground 代码里使用的依赖”拥有一致、可用的类型感知能力，避免出现“能运行但编辑器全红/缺失类型信息”的割裂体验。

**Why this priority**: 真实编写时不会只写 Logix 核心；缺失依赖类型会让补全与诊断的可靠性大幅下降。

**Independent Test**: 在 `/playground` 与 `/ir` 中分别打开一段包含常用依赖导入的示例代码：编辑器不应出现“无法解析模块/类型”的基础性错误，并能对关键类型提供悬浮信息。

**Acceptance Scenarios**:

1. **Given** Playground 代码中导入并使用了示例项目中常见的依赖，**When** 用户触发补全/悬浮/跳转，**Then** 编辑器必须能提供可用的类型信息（至少覆盖导入的符号、常用方法与核心类型）。
2. **Given** 用户写了一个不存在的导入符号或明显错误的导入路径，**When** 编辑器进行静态诊断，**Then** 必须产生可定位的错误诊断（而不是静默失败或只在运行时报错）。

---

### User Story 3 - 编辑体验稳定、可控，并在失败时可诊断 (Priority: P3)

作为示例应用维护者，我希望编辑器升级后仍保持交互稳定：不会因为类型系统初始化、路由切换或大文本而卡死；当“类型感知能力”不可用时，也能给出清晰的可诊断反馈与降级行为。

**Why this priority**: 编辑器升级通常引入额外资源与 worker；缺乏可诊断性会让“卡顿/补全失效”变成不可控问题。

**Independent Test**: 连续切换 `/playground` 与 `/ir` 并编辑大文本；观察编辑器仍可输入、补全可恢复；若出现失败状态，界面应能提示原因与可执行的恢复建议。

**Acceptance Scenarios**:

1. **Given** 用户多次进入/离开代码编辑页面，**When** 用户重复切换路由并持续编辑，**Then** 编辑器必须保持可用（无持续性卡死），并且资源使用应稳定（不应无限增长）。
2. **Given** 类型感知初始化失败或部分依赖类型缺失，**When** 用户尝试触发补全或查看诊断，**Then** 系统必须给出明确提示（失败原因/恢复建议），并允许用户继续进行基础编辑与运行（降级可用）。

---

### Edge Cases

- 冷启动首次进入编辑页：补全/诊断尚未就绪时如何提示进度与状态？
- 大文本（例如 5,000+ 行）下的输入响应与补全触发是否仍可接受？
- 快速连续路由切换导致 worker/资源尚未完全释放时，是否会出现补全失效或明显卡顿？
- 用户输入包含语法不完整片段（半截代码）时，诊断与补全是否仍可提供“尽力而为”的反馈？

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 系统 MUST 在至少一个代码编辑入口（`/playground`）提供完整的代码智能能力：智能补全、参数提示、悬浮信息、跳转与实时诊断。
- **FR-002**: 系统 MUST 覆盖同类代码编辑入口（例如 `/ir`），保证不同页面的代码编辑体验一致（同一套能力与同一套失败/降级口径）。
- **FR-003**: 系统 MUST 对 Logix 相关核心概念提供类型感知：模块定义、逻辑编写、运行入口等常见写法在编辑时应能获得可用的补全与诊断。
- **FR-004**: 系统 MUST 对 Playground 允许/推荐使用的核心依赖提供类型感知能力，至少覆盖 Effect 运行时库、Logix Core、Sandbox、React 适配层与 Form 能力包（以及其类型解析所需的前置类型依赖），避免出现“编辑器无法解析模块/类型”的基础错误阻断用户。
- **FR-005**: 系统 MUST 在用户引入类型错误或导入错误时，提供可定位的诊断信息（至少包含可定位范围与可读的原因摘要）。
- **FR-006**: 系统 MUST 支持在“外部状态变更”导致代码被替换/重置的场景下保持编辑体验（例如保留合理的光标/滚动/撤销体验，且内容同步可预期）。
- **FR-007**: 系统 MUST 提供明确的“类型感知状态”：就绪/加载中/失败（含原因与恢复建议），避免用户无法判断“是没触发、还是坏了”。
- **FR-008**: 系统 MUST 以 Sandbox 运行环境语义为准提供 TypeScript 编译语义：默认不包含 DOM lib（WebWorker 语义），避免误导与补全污染。
- **FR-009**: 系统 MUST 提供基础自动格式化能力（format document/selection），最小实现基于 Monaco 内置 TypeScript 格式化能力（不引入 Prettier）。

### Non-Functional Requirements (Performance & Diagnosability)

- **NFR-001**: 代码编辑入口在页面切换后 MUST 在 ≤ 500ms 内进入“可输入”状态，并在冷启动首次进入时 ≤ 3s 内进入“类型感知就绪”状态（补全/诊断可用，验收可重复验证）。
- **NFR-002**: 在常见输入节奏下（持续键入、频繁触发补全/悬浮），编辑器 MUST 保持响应稳定；禁止出现持续性卡死或不可恢复的补全失效。
- **NFR-003**: 系统 MUST 提供可诊断信号：当类型感知失败/降级时，必须能定位到失败原因（例如缺失依赖类型/初始化失败/资源加载失败）并给出建议。
- **NFR-004**: 失败时 MUST 可降级：即使类型感知不可用，基础编辑与运行流程仍可继续，避免“编辑器失败导致 Playground 不可用”。

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 在 `/playground` 上完成一次“新增 action + 在逻辑中调用 + 修复一次类型错误”的编辑闭环，全程不需要离开页面查阅外部文档即可完成（通过验收脚本/录屏可复现）。
- **SC-002**: 针对一组固定的示例片段（至少覆盖模块定义/逻辑编写/运行入口/常见依赖导入；以 `specs/061-playground-editor-intellisense/quickstart.md` 的验收步骤为准），编辑器的补全与悬浮信息在关键位置可用率达到 100%（人工验收逐项勾选）。
- **SC-003**: 对于“明显的导入错误/类型错误”，编辑器能在 1 秒内给出可定位诊断（在同一环境下可重复验证）。
- **SC-004**: 连续 20 次在 `/playground` 与 `/ir` 间切换并编辑，编辑器仍可输入且补全可恢复；资源使用不出现无界增长：在 warm-up 后观察浏览器内存/性能面板，JS heap 不呈现持续单调增长（允许短期波动）。
- **SC-005**: 当类型感知进入失败/降级模式时，用户能在界面上获取明确的失败原因与恢复建议，并可继续运行示例程序（人工验收）。
