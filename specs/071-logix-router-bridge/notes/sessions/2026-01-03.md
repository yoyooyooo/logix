# Session: 2026-01-03

## Intent

- 深度调研并对比 `react-router-dom` 与 TanStack Router（仓库：`TanStack/router`；包：`@tanstack/react-router`）的核心 API（读取 location/params、订阅变化、发起导航）。
- 产出：为 `Router.Tag` 设定通用归一化 Service 形状（对外不暴露 `RouterAdapter` 概念），并对齐注入心智 `Router.layer(Router.ReactRouter.*(...))`。

## Evidence (to be filled)

- React Router：
  - `Params` 的值域是 `string | undefined`（缺失用 `undefined` 表达）：
    - `https://raw.githubusercontent.com/remix-run/react-router/main/packages/react-router/lib/router/utils.ts`

    ```ts
    export type Params<Key extends string = string> = {
      readonly [key in Key]: string | undefined;
    };
    ```

  - `AgnosticRouteMatch` / `AgnosticDataRouteMatch`：每个 match 都带 `params` / `pathname` / `pathnameBase` / `route`（Data Router 的 route 具备 `id`）：
    - `https://raw.githubusercontent.com/remix-run/react-router/main/packages/react-router/lib/router/utils.ts`

    ```ts
    export interface AgnosticRouteMatch<...> {
      params: Params<ParamKey>;
      pathname: string;
      pathnameBase: string;
      route: RouteObjectType;
    }
    export interface AgnosticDataRouteMatch
      extends AgnosticRouteMatch<string, AgnosticDataRouteObject> {}
    ```

  - `matchRouteBranch` 在构造 matches 时用同一个 `matchedParams` 累积合并并赋给每个 match：因此 leaf match 的 `params` 等价于“全量聚合 params”（适合直接作为 `RouteSnapshot.params` 的来源）：
    - `https://raw.githubusercontent.com/remix-run/react-router/main/packages/react-router/lib/router/utils.ts`

    ```ts
    let matchedParams = {};
    Object.assign(matchedParams, match.params);
    matches.push({ params: matchedParams as Params<ParamKey>, ... });
    ```

  - `RouterState` 语义：导航期间“多数字段保持旧 location”，pending 目标在 `state.navigation.location`（仅 loading/submitting 时有值）：
    - `https://raw.githubusercontent.com/remix-run/react-router/main/packages/react-router/lib/router/router.ts`

    ```ts
    // During a navigation, all states reflect the "old" location unless otherwise noted.
    export interface RouterState {
      location: Location;
      matches: AgnosticDataRouteMatch[];
      navigation: Navigation;
    }
    export type NavigationStates = {
      Idle: { state: "idle"; location: undefined; ... };
      Loading: { state: "loading"; location: Location; ... };
      Submitting: { state: "submitting"; location: Location; ... };
    };
    ```

  - 订阅与导航：
    - `router.subscribe(fn)` 会收到 `(state, opts)`（opts 包含 `flushSync`/`deletedFetchers` 等，router bridge 可忽略）；
    - `router.navigate(to: number)` 支持 history delta（`-1` 即 back）；`router.navigate(to, { replace?, state?, ... })` 支持 replace/push 与 state：
    - `https://raw.githubusercontent.com/remix-run/react-router/main/packages/react-router/lib/router/router.ts`

    ```ts
    export interface RouterSubscriber {
      (state: RouterState, opts: { flushSync: boolean; ... }): void;
    }
    navigate(to: number): Promise<void>;
    navigate(to: To | null, opts?: RouterNavigateOptions): Promise<void>;
    ```

  - `Location`/`Path` 的 `search/hash` 约定：分别以 `?`/`#` 开头或为空字符串（与本 spec 的 `RouteSnapshot.search/hash` 一致）：
    - `https://raw.githubusercontent.com/remix-run/react-router/main/packages/react-router/lib/router/history.ts`
- TanStack Router：
  - `RouterState` 明确区分：
    - `location`：latest parsed（可能未 resolved）
    - `resolvedLocation`：resolved & loaded（更适合作为对外一致快照）
    - `https://raw.githubusercontent.com/TanStack/router/038d0dc8a32efd0be185feda32854e36f5b81848/docs/router/framework/react/api/router/RouterStateType.md`

  - `ParsedLocation` 同时提供 `pathname/searchStr/hash`（可直接映射到 `RouteSnapshot` 的最小字段）：
    - `https://raw.githubusercontent.com/TanStack/router/038d0dc8a32efd0be185feda32854e36f5b81848/docs/router/framework/react/api/router/ParsedLocationType.md`
    - （语义补证据：`searchStr` 含 `?` 前缀，`hash` 含 `#` 前缀）`https://raw.githubusercontent.com/TanStack/router/038d0dc8a32efd0be185feda32854e36f5b81848/packages/router-core/src/location.ts`

  - `RouteMatch` 含 `routeId`、`pathname`、`params`、`search` 等：
    - `https://raw.githubusercontent.com/TanStack/router/038d0dc8a32efd0be185feda32854e36f5b81848/docs/router/framework/react/api/router/RouteMatchType.md`

  - `router.state` 始终最新但 **不 reactive**；订阅通过事件化接口 `router.subscribe('onResolved', ...)`：
    - `https://raw.githubusercontent.com/TanStack/router/038d0dc8a32efd0be185feda32854e36f5b81848/docs/router/framework/react/api/router/RouterType.md`
    - `https://raw.githubusercontent.com/TanStack/router/038d0dc8a32efd0be185feda32854e36f5b81848/docs/router/framework/react/api/router/RouterEventsType.md`

  - `navigate(options)`：支持 `replace?: boolean` 等（可映射到 `push/replace` intent）：
    - `https://raw.githubusercontent.com/TanStack/router/038d0dc8a32efd0be185feda32854e36f5b81848/docs/router/framework/react/api/router/NavigateOptionsType.md`

  - `back` 语义：TanStack Router 暴露 `router.history.back()`（并提供 `useCanGoBack` 作为 UI 层判断能力）：
    - `https://raw.githubusercontent.com/TanStack/router/038d0dc8a32efd0be185feda32854e36f5b81848/docs/router/framework/react/api/router/useCanGoBack.md`

## Draft Comparison (to be refined)

- 共同点：
  - 都有 “router 对象 + state snapshot + navigate + subscribe” 的低层 API（绕开 React hooks 也能驱动）。
  - 都存在 “pending/transitioning” 的中间态，但表达方式不同。
- 关键差异（初稿）：
  - TanStack 明确区分 `location` 与 `resolvedLocation`；React Router 用 `navigation.location` 表达 pending，而 `state.location` 多数情况下保持“已提交”。
  - subscribe 机制：React Router `subscribe(fn)`；TanStack `subscribe(eventName, fn)`（更事件化）。

## Working Hypothesis

- `Router.Tag` 对外只暴露“一致快照”（建议：React Router 用 `state.location`；TanStack 用 `state.resolvedLocation`），避免 pending 中间态外泄导致不一致。
- `changes` 以“快照变化”作为粒度，至少保证 `pathname/search/hash/params` 自洽。
