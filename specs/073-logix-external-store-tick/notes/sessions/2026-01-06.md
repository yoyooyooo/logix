# 2026-01-06 session（实现收尾/根因修复记录）

## Intent

- 记录 tickSeq=0 根因与修复点；收敛 Phase 4/5 的入口；准备推进 perf evidence + workspace gates + docs 收尾。

## What Changed（索引）

- `packages/logix-core/src/internal/runtime/AppRuntime.ts`：Env 组装顺序调整（baseEnv → moduleEnv → merge）。
- `packages/logix-react/src/internal/store/RuntimeExternalStore.ts`：RuntimeStore 单订阅 facade。
- `packages/logix-react/src/internal/hooks/useSelector.ts`：按 topic facade（module-topic/selector-topic）订阅。
- `packages/logix-core/src/internal/runtime/core/{RuntimeStore,TickScheduler,DeclarativeLinkIR,DeclarativeLinkRuntime}.ts`
- Tests：
  - `packages/logix-core/test/internal/runtime/{DeclarativeLinkIR.boundary,ModuleAsSource.tick,ModuleAsSource.recognizability}.test.ts`
  - `packages/logix-react/test/browser/perf-boundaries/runtime-store-no-tearing.test.tsx`

## Findings

- Root cause（tickSeq 不推进）不是“Tag 注入失败”，而是 Env 捕获语义：module layer 初始化阶段会 fork 长生命周期 fiber（txnQueue/logics）；如果此时 TickScheduler/RuntimeStore 不在 Env 中，这些 fiber 会永久缺失服务（`Effect.serviceOption` 永远 None），从而 RuntimeStore 的 pending 信号不可见、tick 不会推进。
- 修复策略：AppRuntime assembly 分两段：
  - 先 build `baseLayer` 得到 `baseEnv`（必须含 TickScheduler/RuntimeStore 等 runtime services）；
  - 再在 `baseEnv` 下 build 所有 module layers 得到 `moduleEnv`；
  - 最终 `Context.merge(baseEnv,moduleEnv)` 作为 runtime Env，并在该 Env 上完成 RootContext.ready + start processes。

## Errors (Failure Traces)

- 症状：browser 语义测试中 `runtimeStore.getTickSeq()` 长期为 0；`waitForTickAdvance` 超时。
- 反例：即便手动在外层 `Effect.provideService(TickSchedulerTag, ...)`，模块内部 fiber 仍不可见（因为它们在更早时刻已捕获 Env）。

## Next Actions

- 跑通 browser 测试与 perf collect/diff，并把 baseline numbers 回写 `specs/073-logix-external-store-tick/plan.md#Perf Evidence Plan`。
- 跑 workspace gates：`pnpm typecheck` / `pnpm lint` / `pnpm test:turbo`。
- 补齐 docs 与 runtime SSoT（logix-react 订阅桥接入口已从 per-module store 切到 runtime facade）。

## 补充：RootContext Env 合并策略（React Provider.layer 覆盖）

- 现象：`RuntimeProvider.layer` 对 EnvTag 的覆盖在“逻辑 run-phase fiber”内不可见（测试用例期望可见）。
- 原因：`runModuleLogics` 之前会在 fork run-phase 时 `Effect.provide(rootEnv)`，把 RootContext 的 app-level Env 直接覆盖到逻辑 fiber，导致 Provider overlay 的 Context 被抹掉。
- 修复：改为 `mergedEnv = Context.merge(rootEnv, currentEnv)`（current 覆盖 root），既保留 “rootEnv 完整装配避免早捕获缺服务” 的不变量，又允许 React Provider / useRuntime 局部 Layer 覆盖生效。

## Docs / SSoT 补齐（T002/T003/T004）

- Runtime SSoT entry points：
  - `.codex/skills/project-guide/references/runtime-logix/logix-react/README.md`：更新 Provider/Hooks/订阅桥接路径（指向 RuntimeExternalStore）。
  - `.codex/skills/project-guide/references/runtime-logix/logix-core/api/README.md`：补齐 ExternalStore/StateTrait 的代码落点。
  - `.codex/skills/project-guide/references/runtime-logix/logix-core/concepts/02-long-chain-tour.md`：修正 React deep dive 路径。
- 用户文档（apps/docs）：
  - `apps/docs/content/docs/guide/recipes/external-store.md` + `apps/docs/content/docs/guide/recipes/meta.json`
  - `apps/docs/content/docs/api/core/external-store.md` + `apps/docs/content/docs/api/core/meta.json`

## Perf Evidence（T051）

- Baseline 语义：策略 A/B（同一代码下通过 `VITE_LOGIX_PERF_RUNTIME_STORE_ADAPTER` 切换 perModule vs runtimeStore）
- 证据文件：
  - Before（adapter=perModule）：`specs/073-logix-external-store-tick/perf/browser.before.1d0b0a28-dirty.darwin-arm64.logix-browser-perf-matrix-v1.default.adapter=perModule.json`
  - After（adapter=runtimeStore）：`specs/073-logix-external-store-tick/perf/browser.after.1d0b0a28-dirty.darwin-arm64.logix-browser-perf-matrix-v1.default.adapter=runtimeStore.json`
  - Diff：`specs/073-logix-external-store-tick/perf/diff.browser.adapter=perModule__runtimeStore.1d0b0a28-dirty.darwin-arm64.logix-browser-perf-matrix-v1.default.json`
- 关键指标（watchers=256）：
  - `timePerTickMs.p95`：
    - perModule：off=2.00ms / full=1.90ms
    - runtimeStore：off=1.80ms / full=1.60ms
- Diff 结论：`meta.comparability.comparable=true` 且 `summary.regressions==0`（仅有 `git.dirty.*` warnings）
- 回写：
  - `specs/073-logix-external-store-tick/perf/README.md`
  - `specs/073-logix-external-store-tick/plan.md#Perf Evidence Plan`

## Next Actions（Updated）

- 回勾 `specs/073-logix-external-store-tick/tasks.md` 未勾选项（主要是 Phase 4/5/6 的收尾任务）。
- 跑一次 `pnpm typecheck:test` 作为最终复验。
