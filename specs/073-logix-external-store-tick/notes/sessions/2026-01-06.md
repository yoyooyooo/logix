# 2026-01-06 session（实现收尾/根因修复记录）

## Intent

- 记录 tickSeq=0 根因与修复点；收敛 Phase 4/5 的入口；准备推进 perf evidence + workspace gates + docs 收尾。

## What Changed（索引）

- `packages/logix-core/src/internal/runtime/AppRuntime.ts`：Env 组装顺序调整（baseEnv → moduleEnv → merge）。
- `packages/logix-react/src/internal/store/RuntimeExternalStore.ts`：RuntimeStore 单订阅 facade。
- `packages/logix-react/src/internal/hooks/useSelector.ts`：按 topic facade（module-topic/selector-topic）订阅。
- `packages/logix-core/src/internal/runtime/core/{RuntimeStore,TickScheduler,DeclarativeLinkIR,DeclarativeLinkRuntime}.ts`
- Tests：
  - `packages/logix-core/test/internal/runtime/{DeclarativeLinkIR.boundary,ModuleAsSource.tick,ModuleAsSource.recognizability}.test.ts`
  - `packages/logix-react/test/browser/perf-boundaries/runtime-store-no-tearing.test.tsx`

## Findings

- Root cause（tickSeq 不推进）不是“Tag 注入失败”，而是 Env 捕获语义：module layer 初始化阶段会 fork 长生命周期 fiber（txnQueue/logics）；如果此时 TickScheduler/RuntimeStore 不在 Env 中，这些 fiber 会永久缺失服务（`Effect.serviceOption` 永远 None），从而 RuntimeStore 的 pending 信号不可见、tick 不会推进。
- 修复策略：AppRuntime assembly 分两段：
  - 先 build `baseLayer` 得到 `baseEnv`（必须含 TickScheduler/RuntimeStore 等 runtime services）；
  - 再在 `baseEnv` 下 build 所有 module layers 得到 `moduleEnv`；
  - 最终 `Context.merge(baseEnv,moduleEnv)` 作为 runtime Env，并在该 Env 上完成 RootContext.ready + start processes。

## Errors (Failure Traces)

- 症状：browser 语义测试中 `runtimeStore.getTickSeq()` 长期为 0；`waitForTickAdvance` 超时。
- 反例：即便手动在外层 `Effect.provideService(TickSchedulerTag, ...)`，模块内部 fiber 仍不可见（因为它们在更早时刻已捕获 Env）。

## Next Actions

- 跑通 browser 测试与 perf collect/diff，并把 baseline numbers 回写 `specs/073-logix-external-store-tick/plan.md#Perf Evidence Plan`。
- 跑 workspace gates：`pnpm typecheck` / `pnpm lint` / `pnpm test:turbo`。
- 补齐 docs 与 runtime SSoT（logix-react 订阅桥接入口已从 per-module store 切到 runtime facade）。

## 补充：RootContext Env 合并策略（React Provider.layer 覆盖）

- 现象：`RuntimeProvider.layer` 对 EnvTag 的覆盖在“逻辑 run-phase fiber”内不可见（测试用例期望可见）。
- 原因：`runModuleLogics` 之前会在 fork run-phase 时 `Effect.provide(rootEnv)`，把 RootContext 的 app-level Env 直接覆盖到逻辑 fiber，导致 Provider overlay 的 Context 被抹掉。
- 修复：改为 `mergedEnv = Context.merge(rootEnv, currentEnv)`（current 覆盖 root），既保留 “rootEnv 完整装配避免早捕获缺服务” 的不变量，又允许 React Provider / useRuntime 局部 Layer 覆盖生效。

## Docs / SSoT 补齐（T002/T003/T004）

- Runtime SSoT entry points：
  - `docs/ssot/runtime/logix-react/README.md`：更新 Provider/Hooks/订阅桥接路径（指向 RuntimeExternalStore）。
  - `docs/ssot/runtime/logix-core/api/README.md`：补齐 ExternalStore/StateTrait 的代码落点。
  - `docs/ssot/runtime/logix-core/concepts/02-long-chain-tour.md`：修正 React deep dive 路径。
- 用户文档（apps/docs）：
  - `apps/docs/content/docs/guide/recipes/external-store.md` + `apps/docs/content/docs/guide/recipes/meta.json`
  - `apps/docs/content/docs/api/core/external-store.md` + `apps/docs/content/docs/api/core/meta.json`

## Perf Evidence（T051）

- Baseline 语义：策略 A/B（同一代码下通过 `VITE_LOGIX_PERF_RUNTIME_STORE_ADAPTER` 切换 perModule vs runtimeStore）
- 证据文件：
  - Before（adapter=perModule）：`specs/073-logix-external-store-tick/perf/browser.before.1d0b0a28-dirty.darwin-arm64.logix-browser-perf-matrix-v1.default.adapter=perModule.json`
  - After（adapter=runtimeStore）：`specs/073-logix-external-store-tick/perf/browser.after.1d0b0a28-dirty.darwin-arm64.logix-browser-perf-matrix-v1.default.adapter=runtimeStore.json`
  - Diff：`specs/073-logix-external-store-tick/perf/diff.browser.adapter=perModule__runtimeStore.1d0b0a28-dirty.darwin-arm64.logix-browser-perf-matrix-v1.default.json`
- 关键指标（watchers=256）：
  - `timePerTickMs.p95`：
    - perModule：off=2.00ms / full=1.90ms
    - runtimeStore：off=1.80ms / full=1.60ms
- Diff 结论：`meta.comparability.comparable=true` 且 `summary.regressions==0`（仅有 `git.dirty.*` warnings）
- 回写：
  - `specs/073-logix-external-store-tick/perf/README.md`
  - `specs/073-logix-external-store-tick/plan.md#Perf Evidence Plan`

## Next Actions（Updated）

- 回勾 `specs/073-logix-external-store-tick/tasks.md` 未勾选项（主要是 Phase 4/5/6 的收尾任务）。
- 跑一次 `pnpm typecheck:test` 作为最终复验。

## Perf Toolchain Upgrade（让 diff 更“真实/可比”）

- 目标：让 PerfDiff 更容易解释（metric-level deltas）、让 click→paint 更接近“commit 后至少一帧”、并补齐 headless chromium 的 browser.version（否则 env drift 难判断）。
- 改动（落点）：
  - `.codex/skills/logix-perf-evidence/scripts/diff.ts`：新增 `metricDeltas`（按 suite+metric 输出 median/p95 的 delta 与 top 变化点）；修正 `unit=count` 证据聚合（避免跨点位相加导致误解）。
  - `.codex/skills/logix-perf-evidence/assets/schemas/perf-diff.schema.json`：补齐 `metricDeltas` schema。
  - `packages/logix-react/test/browser/perf-boundaries/diagnostics-overhead.test.tsx`：click→paint 额外等待 `requestAnimationFrame`（commit→paint 近似）；diagRuns 上限提升到 10。
  - `packages/logix-react/test/browser/perf-boundaries/protocol.ts`：从 `navigator.userAgent` 推导 `meta.env.browser.version`；兼容 `HeadlessChrome/...`。
- 交付策略（避免污染并行 worktree）：从 `main` 拉出 `073-perf` 分支做工具链升级与验证，确认无误后分别 cherry-pick 到 `main` 与 `073`。

## Perf CI 分层（让 quick 真正 quick）

- 背景：`converge-steps.test.tsx` 是全量矩阵（357 点 × runs × SAMPLE_BATCH），在 CI 上很难保持“quick”。把它继续作为 PR 默认门禁，会逼迫用无限加样本/加点位来“追抖动”，最终成本失控。
- 调整：
  - `logix-perf (quick)`：改为 PR 默认跑 **少点位 smoke**（`runtime-store-no-tearing` + `external-store-ingest` + `diagnostics-overhead`，profile=`smoke`），用于回答“主干道 baseline 是否回归”。
  - `logix-perf (sweep)`：把 `converge-steps` 迁到手动触发，用于出现 tail-only 线索时进一步定位参数空间与复现实验。

## Perf Evidence（clean commit / 可比性更强）

- 说明：旧 evidence 的 `git.dirty=true` 且 `browser.version=(unknown)`，不利于 comparability；当前已用 clean worktree 重新 collect/diff，且 browser.version 已补齐。
- 证据文件（adapter A/B）：
  - Before（adapter=perModule）：`specs/073-logix-external-store-tick/perf/browser.before.d8756502.darwin-arm64.logix-browser-perf-matrix-v1.default.adapter=perModule.json`
  - After（adapter=runtimeStore）：`specs/073-logix-external-store-tick/perf/browser.after.d8756502.darwin-arm64.logix-browser-perf-matrix-v1.default.adapter=runtimeStore.json`
  - Diff：`specs/073-logix-external-store-tick/perf/diff.browser.adapter=perModule__runtimeStore.d8756502.darwin-arm64.logix-browser-perf-matrix-v1.default.json`
- 关键指标（watchers=256）：
  - `runtimeStore.noTearing.tickNotify`：`timePerTickMs.p95` off 2.10→1.90（-0.20ms），full 2.00→1.80（-0.20ms）
  - `diagnostics.overhead.e2e`：click→paint（含 commit→nextFrame 近似）变化幅度小且方向不一，暂不作为硬门禁（详见 `specs/073-logix-external-store-tick/perf/README.md`）

---

## Phase 7（Post-Acceptance Fixes）

### FR-001：externalStore 熔断诊断

- 改动：`packages/logix-core/src/internal/state-trait/external-store.ts`
  - `getSnapshot()` 抛错时熔断（保持既有“停止后续写回”语义），并补齐 `external_store::snapshot_threw` 诊断事件（Slim、可序列化；diagnostics=off 近零成本）。
- 测试：`packages/logix-core/test/internal/StateTrait/StateTrait.ExternalStoreTrait.Runtime.test.ts`
  - 扩展用例：断言熔断时会产生上述诊断事件（ring buffer sink）。

### FR-011：nonUrgent lane → commit priority=low

- 改动：
  - `packages/logix-core/src/internal/state-trait/external-store.ts`：trait 安装写回事务 origin 注入 `details.stateCommit.priority`（nonUrgent→low）。
  - `packages/logix-core/src/internal/runtime/core/ModuleRuntime.transaction.ts`：`runWithStateTransaction` 读取 origin.details 并初始化 `txnCurrent.priority`（low/normal）。
- 测试：`packages/logix-core/test/internal/StateTrait/StateTrait.ExternalStoreTrait.Runtime.test.ts`
  - 新增用例：`priority: nonUrgent externalStore writeback maps to low commit priority`。

### NFR-001 / NFR-008：ingest perf + retained heap gate

- 新增 perf suite（matrix v1）：`externalStore.ingest.tickNotify`（metric=`timePerIngestMs`，watchers=256，diagnosticsLevel=off/full）。
- 新增 browser perf boundary + heap gate：
  - `packages/logix-react/test/browser/perf-boundaries/external-store-ingest.test.tsx`
  - 运行前提：chromium 启动注入 `--js-flags=--expose-gc` + `--enable-precise-memory-info`（见 `packages/logix-react/vitest.config.ts`）。
  - gate：`retainedHeapDeltaBytesAfterGc`（selector-topic churn 后 `MAX_DELTA_BYTES=10MB`）。
- 证据落盘：
  - r1：`specs/073-logix-external-store-tick/perf/browser.r1.fe1257bb.darwin-arm64.logix-browser-perf-matrix-v1.default.suite=externalStore.ingest.tickNotify.json`
    - `timePerIngestMs.p95` off=1.70ms / full=1.80ms
  - r2：`specs/073-logix-external-store-tick/perf/browser.r2.fe1257bb.darwin-arm64.logix-browser-perf-matrix-v1.default.suite=externalStore.ingest.tickNotify.json`
    - `timePerIngestMs.p95` off=1.90ms / full=1.90ms
  - diff：`specs/073-logix-external-store-tick/perf/diff.browser.suite=externalStore.ingest.tickNotify.r1__r2.fe1257bb.darwin-arm64.logix-browser-perf-matrix-v1.default.json`
    - `meta.comparability.comparable=true`（warnings=[]），`summary.regressions==0`

### Gates（workspace）

- 已跑：`pnpm typecheck` / `pnpm lint` / `pnpm test:turbo`

### Acceptance 状态（更新）

- 目标：把上次验收的 4 个 PARTIAL（FR-001/FR-011/NFR-001/NFR-008）补齐为 PASS。
- 结果：预期应达成 coded points 全 PASS（详细矩阵见本次对话的 acceptance 输出）。
