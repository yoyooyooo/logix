{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://intent-flow.local/specs/081/anchor-index.schema.json",
  "title": "AnchorIndex@v1",
  "type": "object",
  "additionalProperties": false,
  "required": ["schemaVersion", "kind", "repoRoot", "entries", "rawMode", "summary"],
  "properties": {
    "schemaVersion": { "type": "integer", "const": 1 },
    "kind": { "type": "string", "const": "AnchorIndex" },
    "repoRoot": { "type": "string", "minLength": 1 },
    "entries": {
      "type": "array",
      "items": { "$ref": "#/$defs/AnchorEntry" }
    },
    "rawMode": {
      "type": "array",
      "items": { "$ref": "#/$defs/RawModeEntry" }
    },
    "summary": { "$ref": "#/$defs/AnchorIndexSummary" }
  },
  "$defs": {
    "Pos": {
      "type": "object",
      "additionalProperties": false,
      "required": ["line", "column", "offset"],
      "properties": {
        "line": { "type": "integer", "minimum": 1 },
        "column": { "type": "integer", "minimum": 1 },
        "offset": { "type": "integer", "minimum": 0 }
      }
    },
    "Span": {
      "type": "object",
      "additionalProperties": false,
      "required": ["start", "end"],
      "properties": {
        "start": { "$ref": "#/$defs/Pos" },
        "end": { "$ref": "#/$defs/Pos" }
      }
    },
    "TagSymbol": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "declFile": { "type": "string", "minLength": 1 },
        "declSpan": { "$ref": "#/$defs/Span" }
      }
    },
    "MissingField": {
      "type": "object",
      "additionalProperties": false,
      "required": ["field", "insertSpan"],
      "properties": {
        "field": { "type": "string", "minLength": 1 },
        "insertSpan": { "$ref": "#/$defs/Span" }
      }
    },
    "Missing": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "services": { "$ref": "#/$defs/MissingField" },
        "devSource": { "$ref": "#/$defs/MissingField" }
      }
    },
    "AnchorEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["entryKey", "kind", "file", "span"],
      "properties": {
        "entryKey": { "type": "string", "minLength": 1 },
        "kind": {
          "type": "string",
          "enum": ["ModuleDef", "LogicDef", "ServiceUse", "AutofillTarget"]
        },
        "file": { "type": "string", "minLength": 1 },
        "span": { "$ref": "#/$defs/Span" },
        "reasonCodes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "moduleIdLiteral": { "type": "string", "minLength": 1 },
        "serviceIdLiteral": { "type": "string", "minLength": 1 },
        "tagSymbol": { "$ref": "#/$defs/TagSymbol" },
        "missing": { "$ref": "#/$defs/Missing" }
      }
    },
    "RawModeEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["file", "span", "reasonCodes"],
      "properties": {
        "file": { "type": "string", "minLength": 1 },
        "span": { "$ref": "#/$defs/Span" },
        "reasonCodes": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1 }
        }
      }
    },
    "AnchorIndexSummary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "filesScanned",
        "entriesTotal",
        "rawModeTotal",
        "modulesTotal",
        "serviceUsesTotal",
        "autofillTargetsTotal"
      ],
      "properties": {
        "filesScanned": { "type": "integer", "minimum": 0 },
        "entriesTotal": { "type": "integer", "minimum": 0 },
        "rawModeTotal": { "type": "integer", "minimum": 0 },
        "modulesTotal": { "type": "integer", "minimum": 0 },
        "serviceUsesTotal": { "type": "integer", "minimum": 0 },
        "autofillTargetsTotal": { "type": "integer", "minimum": 0 }
      }
    }
  }
}
