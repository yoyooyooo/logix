{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://intent-flow.local/specs/081/anchor-index.schema.json",
  "title": "AnchorIndex@v1",
  "type": "object",
  "additionalProperties": false,
  "required": ["schemaVersion", "kind", "repoRoot", "entries", "rawMode", "summary"],
  "properties": {
    "schemaVersion": { "type": "integer", "const": 1 },
    "kind": { "type": "string", "const": "AnchorIndex" },
    "repoRoot": { "type": "string", "minLength": 1 },
    "entries": {
      "type": "array",
      "items": { "$ref": "#/$defs/AnchorEntry" }
    },
    "rawMode": {
      "type": "array",
      "items": { "$ref": "#/$defs/RawModeEntry" }
    },
    "summary": { "$ref": "#/$defs/AnchorIndexSummary" }
  },
  "$defs": {
    "Pos": {
      "type": "object",
      "additionalProperties": false,
      "required": ["line", "column", "offset"],
      "properties": {
        "line": { "type": "integer", "minimum": 1 },
        "column": { "type": "integer", "minimum": 1 },
        "offset": { "type": "integer", "minimum": 0 }
      }
    },
    "Span": {
      "type": "object",
      "additionalProperties": false,
      "required": ["start", "end"],
      "properties": {
        "start": { "$ref": "#/$defs/Pos" },
        "end": { "$ref": "#/$defs/Pos" }
      }
    },
    "TagSymbol": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "declFile": { "type": "string", "minLength": 1 },
        "declSpan": { "$ref": "#/$defs/Span" }
      }
    },
    "MissingField": {
      "type": "object",
      "additionalProperties": false,
      "required": ["field", "insertSpan"],
      "properties": {
        "field": { "type": "string", "minLength": 1 },
        "insertSpan": { "$ref": "#/$defs/Span" }
      }
    },
    "Missing": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "services": { "$ref": "#/$defs/MissingField" },
        "devSource": { "$ref": "#/$defs/MissingField" },
        "workflowStepKey": { "$ref": "#/$defs/MissingField" }
      }
    },
    "EntryBase": {
      "type": "object",
      "additionalProperties": false,
      "required": ["entryKey", "kind", "file", "span"],
      "properties": {
        "entryKey": { "type": "string", "minLength": 1 },
        "kind": { "type": "string", "minLength": 1 },
        "file": { "type": "string", "minLength": 1 },
        "span": { "$ref": "#/$defs/Span" },
        "reasonCodes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        }
      }
    },
    "ModuleDefEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["entryKey", "kind", "file", "span", "moduleIdLiteral"],
      "properties": {
        "entryKey": { "type": "string", "minLength": 1 },
        "kind": { "type": "string", "const": "ModuleDef" },
        "file": { "type": "string", "minLength": 1 },
        "span": { "$ref": "#/$defs/Span" },
        "reasonCodes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "moduleIdLiteral": { "type": "string", "minLength": 1 }
      }
    },
    "LogicDefEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["entryKey", "kind", "file", "span"],
      "properties": {
        "entryKey": { "type": "string", "minLength": 1 },
        "kind": { "type": "string", "const": "LogicDef" },
        "file": { "type": "string", "minLength": 1 },
        "span": { "$ref": "#/$defs/Span" },
        "reasonCodes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "moduleIdLiteral": { "type": "string", "minLength": 1 }
      }
    },
    "ServiceUseEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["entryKey", "kind", "file", "span", "tagSymbol"],
      "properties": {
        "entryKey": { "type": "string", "minLength": 1 },
        "kind": { "type": "string", "const": "ServiceUse" },
        "file": { "type": "string", "minLength": 1 },
        "span": { "$ref": "#/$defs/Span" },
        "reasonCodes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "moduleIdLiteral": { "type": "string", "minLength": 1 },
        "tagSymbol": { "$ref": "#/$defs/TagSymbol" },
        "serviceIdLiteral": { "type": "string", "minLength": 1 }
      }
    },
    "WorkflowDefEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["entryKey", "kind", "file", "span", "workflowLocalIdLiteral"],
      "properties": {
        "entryKey": { "type": "string", "minLength": 1 },
        "kind": { "type": "string", "const": "WorkflowDef" },
        "file": { "type": "string", "minLength": 1 },
        "span": { "$ref": "#/$defs/Span" },
        "reasonCodes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "moduleIdLiteral": { "type": "string", "minLength": 1 },
        "workflowLocalIdLiteral": { "type": "string", "minLength": 1 }
      }
    },
    "WorkflowCallUseEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["entryKey", "kind", "file", "span", "workflowLocalIdLiteral", "serviceIdLiteral"],
      "properties": {
        "entryKey": { "type": "string", "minLength": 1 },
        "kind": { "type": "string", "const": "WorkflowCallUse" },
        "file": { "type": "string", "minLength": 1 },
        "span": { "$ref": "#/$defs/Span" },
        "reasonCodes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "moduleIdLiteral": { "type": "string", "minLength": 1 },
        "workflowLocalIdLiteral": { "type": "string", "minLength": 1 },
        "serviceIdLiteral": { "type": "string", "minLength": 1 }
      }
    },
    "AutofillTargetModule": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "moduleIdLiteral"],
      "properties": {
        "kind": { "type": "string", "const": "module" },
        "moduleIdLiteral": { "type": "string", "minLength": 1 }
      }
    },
    "AutofillTargetWorkflow": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "workflowLocalIdLiteral"],
      "properties": {
        "kind": { "type": "string", "const": "workflow" },
        "workflowLocalIdLiteral": { "type": "string", "minLength": 1 }
      }
    },
    "AutofillTargetRef": {
      "oneOf": [{ "$ref": "#/$defs/AutofillTargetModule" }, { "$ref": "#/$defs/AutofillTargetWorkflow" }]
    },
    "AutofillTargetEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["entryKey", "kind", "file", "span", "target", "missing"],
      "properties": {
        "entryKey": { "type": "string", "minLength": 1 },
        "kind": { "type": "string", "const": "AutofillTarget" },
        "file": { "type": "string", "minLength": 1 },
        "span": { "$ref": "#/$defs/Span" },
        "reasonCodes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "target": { "$ref": "#/$defs/AutofillTargetRef" },
        "missing": { "$ref": "#/$defs/Missing" }
      }
    },
    "AnchorEntry": {
      "oneOf": [
        { "$ref": "#/$defs/ModuleDefEntry" },
        { "$ref": "#/$defs/LogicDefEntry" },
        { "$ref": "#/$defs/ServiceUseEntry" },
        { "$ref": "#/$defs/WorkflowDefEntry" },
        { "$ref": "#/$defs/WorkflowCallUseEntry" },
        { "$ref": "#/$defs/AutofillTargetEntry" }
      ]
    },
    "RawModeEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["file", "span", "reasonCodes"],
      "properties": {
        "file": { "type": "string", "minLength": 1 },
        "span": { "$ref": "#/$defs/Span" },
        "reasonCodes": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1 }
        }
      }
    },
    "AnchorIndexSummary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "filesScanned",
        "entriesTotal",
        "rawModeTotal",
        "modulesTotal",
        "serviceUsesTotal",
        "autofillTargetsTotal",
        "workflowsTotal",
        "workflowCallUsesTotal"
      ],
      "properties": {
        "filesScanned": { "type": "integer", "minimum": 0 },
        "entriesTotal": { "type": "integer", "minimum": 0 },
        "rawModeTotal": { "type": "integer", "minimum": 0 },
        "modulesTotal": { "type": "integer", "minimum": 0 },
        "serviceUsesTotal": { "type": "integer", "minimum": 0 },
        "autofillTargetsTotal": { "type": "integer", "minimum": 0 },
        "workflowsTotal": { "type": "integer", "minimum": 0 },
        "workflowCallUsesTotal": { "type": "integer", "minimum": 0 }
      }
    }
  }
}
